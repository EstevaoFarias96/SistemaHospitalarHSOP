<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Pacientes em Observação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    body {
      background-color: #f5f8fc;
    }
    h3, .section-title {
      color: #004085;
      font-weight: bold;
    }
    .table thead th {
      background-color: #cfe2ff;
    }
    .table-danger-custom {
      background-color: #f8d7da !important;
    }
    
    /* Estilos para o modal de conduta */
    .modal-lg {
      max-width: 800px;
    }
    
    .modal-header.bg-primary {
      background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
      border-bottom: none;
    }
    
    .modal-content {
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    
    .card {
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    
    .card-header {
      border-bottom: 1px solid #e9ecef;
      border-radius: 8px 8px 0 0 !important;
    }
    
    .form-select-lg {
      font-size: 1.1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 2px solid #dee2e6;
      transition: all 0.3s ease;
    }
    
    .form-select-lg:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .form-control {
      border-radius: 8px;
      border: 2px solid #dee2e6;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
      border: none;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
      transform: translateY(-2px);
    }
    
    .alert {
      border-radius: 8px;
      border: none;
      font-weight: 500;
    }
    
    .badge {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
    }
    
    .fw-bold {
      font-weight: 600 !important;
    }
    
    .text-primary {
      color: #0d6efd !important;
      font-weight: 500;
    }
    
    /* Animações para o leito selection */
    #leitoSelection {
      transition: all 0.3s ease;
    }
    
    /* Estilo para opções do select de leito */
    .form-select option.text-success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .form-select option.text-warning {
      background-color: #fff3cd;
      color: #856404;
    }
    
    /* Hover effects */
    .card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      transition: box-shadow 0.3s ease;
    }
    
    /* Loading spinner */
    .fa-spin {
      animation: fa-spin 1s infinite linear;
    }
    
    @keyframes fa-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .modal-lg {
        max-width: 95%;
        margin: 1rem auto;
      }
      
      .card-body .row {
        flex-direction: column;
      }
      
      .card-body .row .col-md-4,
      .card-body .row .col-md-8 {
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>  <div class="container mt-5 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Pacientes em Observação</h3>
      {% if session.get('cargo', '').lower() == 'enfermeiro' %}
        <a href="/enfermeiro" class="btn btn-secondary">Voltar ao Painel</a>
      {% else %}
        <a href="/medico" class="btn btn-secondary">Voltar ao Painel</a>
      {% endif %}
    </div>

    <!-- Seção 1: Pacientes em Observação -->
    <h4 class="section-title">Pacientes em Observação</h4>
    <table class="table table-hover table-bordered bg-white">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Horário de Observação</th>
          <th>Médico Responsável</th>
          <th>Atendimento ID</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaObservacao"></tbody>
    </table>

    <!-- Seção 2: Pacientes que Necessitam Conduta -->
    <h4 class="section-title">Pacientes Necessita Conduta</h4>
    <table class="table table-hover table-bordered bg-white">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Horário de Observação</th>
          <th>Médico Responsável</th>
          <th>Atendimento ID</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaConduta"></tbody>
    </table>  </div>

  <!-- Modal Definir Conduta -->
  <div class="modal fade" id="modalDefinirConduta" tabindex="-1" aria-labelledby="modalDefinirCondutaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalDefinirCondutaLabel">
            <i class="fas fa-user-md me-2"></i>Definir Conduta Médica
          </h5>
          <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Informações do Paciente -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="fas fa-user me-2"></i>Informações do Paciente
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <strong>Paciente:</strong> <span id="nomePacienteConduta" class="text-primary"></span>
                </div>
                <div class="col-md-4">
                  <strong>Atendimento:</strong> <span id="atendimentoIdConduta" class="badge bg-secondary"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Seleção de Conduta -->
          <div class="mb-4">
            <label for="condutaSelect" class="form-label fw-bold">
              <i class="fas fa-clipboard-list me-2"></i>Selecione a conduta:
            </label>
            <select class="form-select form-select-lg" id="condutaSelect" required onchange="toggleLeitoSelection()">
              <option value="">Selecione uma opção</option>
              <option value="Alta" data-color="success">
                <i class="fas fa-home"></i> Alta
              </option>
              <option value="Transferido" data-color="warning">
                <i class="fas fa-exchange-alt"></i> Transferido
              </option>
              <option value="A pedido" data-color="info">
                <i class="fas fa-hand-paper"></i> A pedido
              </option>
              <option value="Óbito" data-color="dark">
                <i class="fas fa-cross"></i> Óbito
              </option>
              <option value="Internar" data-color="primary">
                <i class="fas fa-bed"></i> Internar
              </option>
            </select>
          </div>

          <!-- Seleção de Leito (aparece apenas quando Internar é selecionado) -->
          <div id="leitoSelection" class="mb-4" style="display: none;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Internação:</strong> Selecione o leito onde o paciente será internado.
            </div>
            <label for="leitoSelect" class="form-label fw-bold">
              <i class="fas fa-bed me-2"></i>Selecione o leito:
            </label>
            <select class="form-select" id="leitoSelect">
              <option value="">Carregando leitos...</option>
            </select>
            <div class="mt-2">
              <small class="text-muted">
                <i class="fas fa-lightbulb me-1"></i>
                Apenas leitos disponíveis são exibidos
              </small>
            </div>
          </div>

          <!-- Evolução Médica Final -->
          <div class="mb-3">
            <label for="observacaoConduta" class="form-label fw-bold">
              <i class="fas fa-notes-medical me-2"></i>Evolução Médica Final:
            </label>
            <textarea class="form-control" id="observacaoConduta" rows="4" 
                      placeholder="Descreva a evolução médica final do paciente..."></textarea>
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>
              Esta evolução será registrada automaticamente no prontuário do paciente.
            </div>
          </div>

          <!-- Indicadores Visuais de Conduta -->
          <div id="condutaIndicator" class="alert d-none" role="alert">
            <div class="d-flex align-items-center">
              <i id="condutaIcon" class="fas fa-info-circle me-2"></i>
              <span id="condutaDescription"></span>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button type="button" class="btn btn-primary" onclick="salvarConduta()">
            <i class="fas fa-save me-2"></i>Salvar Conduta
          </button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script><script>
    $(document).ready(function () {
      $.getJSON('/api/lista-observacao/', function (data) {
        const pacientes = data.pacientes || [];
        const agora = new Date();

        const htmlObservacao = [];
        const htmlConduta = [];        // Verificar o cargo do usuário para determinar o link correto
        const cargoUsuario = "{{ session.get('cargo', '').lower() }}";
        
        pacientes.forEach(p => {
          const horario = p.horario_observacao ? new Date(p.horario_observacao) : null;
          const diffHoras = horario ? ((agora - horario) / 1000 / 3600) : 0;
            // Definir o link baseado no cargo do usuário
          let urlFichaPaciente;
          if (cargoUsuario === 'enfermeiro') {
            urlFichaPaciente = `/observacao/evolucao-paciente-enfermeiro/${p.atendimento_id}`;
          } else {
            urlFichaPaciente = `/observacao/evolucao-paciente-medico/${p.atendimento_id}`;
          }

          // Definir se deve mostrar o botão "Definir Conduta" (apenas para médicos)
          const botaoConduta = cargoUsuario === 'medico' || cargoUsuario === 'multi' ? 
            `<button class="btn btn-sm btn-success ms-2" onclick="definirConduta('${p.atendimento_id}', '${p.nome}')">Definir Conduta</button>` : 
            '';

          const linha = `
            <tr>
              <td>${p.nome}</td>
              <td>${horario ? horario.toLocaleString() : '---'}</td>
              <td>${p.medico_nome || '---'}</td>
              <td>${p.atendimento_id}</td>
              <td>
                <a href="${urlFichaPaciente}" class="btn btn-sm btn-info">Ficha Paciente</a>
                ${botaoConduta}
              </td>
            </tr>
          `;          const linhaAlerta = `
            <tr class="table-danger-custom">
              <td>${p.nome}</td>
              <td>${horario ? horario.toLocaleString() : '---'}</td>
              <td>${p.medico_nome || '---'}</td>
              <td>${p.atendimento_id}</td>
              <td>
                <a href="${urlFichaPaciente}" class="btn btn-sm btn-info">Ficha Paciente</a>
                ${botaoConduta}
              </td>
            </tr>
          `;

          if (horario && diffHoras > 24) {
            htmlConduta.push(linhaAlerta);
          } else {
            htmlObservacao.push(linha);
          }
        });        $('#tabelaObservacao').html(htmlObservacao.join('') || '<tr><td colspan="5" class="text-center text-muted">Nenhum paciente em observação.</td></tr>');
        $('#tabelaConduta').html(htmlConduta.join('') || '<tr><td colspan="5" class="text-center text-muted">Nenhum paciente aguardando conduta há mais de 24h.</td></tr>');
      });
    });    // Função para abrir modal de definir conduta
    function definirConduta(atendimentoId, nomePaciente) {
      $('#nomePacienteConduta').text(nomePaciente);
      $('#atendimentoIdConduta').text(atendimentoId);
      $('#condutaSelect').val('');
      $('#observacaoConduta').val('');
      $('#leitoSelect').val('');
      $('#leitoSelection').hide();
      $('#condutaIndicator').addClass('d-none');
      
      // Carregar leitos disponíveis
      carregarLeitos();
      
      $('#modalDefinirConduta').modal('show');
    }

    // Função para carregar leitos disponíveis
    function carregarLeitos() {
      $.getJSON('/api/leitos/opcoes')
        .done(function(data) {
          const leitoSelect = $('#leitoSelect');
          leitoSelect.empty();
          leitoSelect.append('<option value="">Selecione um leito</option>');
          
          data.forEach(function(leito) {
            const statusClass = leito.status === 'Disponível' ? 'text-success' : 'text-warning';
            const statusIcon = leito.status === 'Disponível' ? '✓' : '⚠';
            
            // Só adicionar leitos disponíveis
            if (leito.status === 'Disponível') {
              leitoSelect.append(`
                <option value="${leito.nome}" class="${statusClass}">
                  ${statusIcon} ${leito.nome} - ${leito.status}
                </option>
              `);
            }
          });
        })
        .fail(function() {
          $('#leitoSelect').html('<option value="">Erro ao carregar leitos</option>');
        });
    }

    // Função para mostrar/ocultar seleção de leito
    function toggleLeitoSelection() {
      const conduta = $('#condutaSelect').val();
      const leitoDiv = $('#leitoSelection');
      const indicator = $('#condutaIndicator');
      const icon = $('#condutaIcon');
      const description = $('#condutaDescription');
      
      if (conduta === 'Internar') {
        leitoDiv.slideDown();
        indicator.removeClass('d-none alert-info alert-success alert-warning alert-danger')
                 .addClass('alert-primary');
        icon.removeClass().addClass('fas fa-bed');
        description.text('Paciente será internado. Selecione o leito apropriado.');
      } else {
        leitoDiv.slideUp();
        $('#leitoSelect').val('');
        
        // Mostrar indicador baseado na conduta
        if (conduta) {
          indicator.removeClass('d-none alert-info alert-success alert-warning alert-danger alert-primary');
          
          switch(conduta) {
            case 'Alta':
              indicator.addClass('alert-success');
              icon.removeClass().addClass('fas fa-home');
              description.text('Paciente receberá alta hospitalar.');
              break;
            case 'Transferido':
              indicator.addClass('alert-warning');
              icon.removeClass().addClass('fas fa-exchange-alt');
              description.text('Paciente será transferido para outra unidade.');
              break;
            case 'A pedido':
              indicator.addClass('alert-info');
              icon.removeClass().addClass('fas fa-hand-paper');
              description.text('Alta a pedido do paciente ou responsável.');
              break;
            case 'Óbito':
              indicator.addClass('alert-danger');
              icon.removeClass().addClass('fas fa-cross');
              description.text('Registrar óbito do paciente.');
              break;
          }
        } else {
          indicator.addClass('d-none');
        }
      }
    }

    // Função para salvar conduta
    function salvarConduta() {
      const atendimentoId = $('#atendimentoIdConduta').text();
      const conduta = $('#condutaSelect').val();
      const observacao = $('#observacaoConduta').val();
      const leito = $('#leitoSelect').val();

      if (!conduta) {
        showAlert('Por favor, selecione uma conduta.', 'warning');
        return;
      }

      // Validar leito se conduta for Internar
      if (conduta === 'Internar' && !leito) {
        showAlert('Por favor, selecione um leito para internação.', 'warning');
        return;
      }

      // Confirmar ação com mais detalhes
      let confirmMessage = `Confirma a conduta "${conduta}" para este paciente?`;
      if (conduta === 'Internar' && leito) {
        confirmMessage += `\n\nLeito selecionado: ${leito}`;
      }

      if (!confirm(confirmMessage)) {
        return;
      }

      // Preparar dados para envio
      const dados = {
        atendimento_id: atendimentoId,
        conduta: conduta,
        observacao: observacao
      };

      // Adicionar leito se for internação
      if (conduta === 'Internar') {
        dados.leito = leito;
      }

      // Desabilitar botão durante o envio
      const btnSalvar = $('.modal-footer .btn-primary');
      btnSalvar.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Salvando...');

      // Enviar requisição
      $.ajax({
        url: '/api/definir-conduta',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dados),
        success: function(response) {
          showAlert('Conduta definida com sucesso!', 'success');
          $('#modalDefinirConduta').modal('hide');
          
          // Recarregar a página após um breve delay
          setTimeout(function() {
            location.reload();
          }, 1500);
        },
        error: function(xhr, status, error) {
          let errorMessage = 'Erro ao definir conduta.';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMessage = xhr.responseJSON.message;
          }
          showAlert(errorMessage, 'error');
        },
        complete: function() {
          // Reabilitar botão
          btnSalvar.prop('disabled', false).html('<i class="fas fa-save me-2"></i>Salvar Conduta');
        }
      });
    }

    // Função para mostrar alertas mais elegantes
    function showAlert(message, type) {
      const alertClass = type === 'success' ? 'alert-success' : 
                        type === 'warning' ? 'alert-warning' : 
                        'alert-danger';
      
      const alertIcon = type === 'success' ? 'fa-check-circle' : 
                       type === 'warning' ? 'fa-exclamation-triangle' : 
                       'fa-times-circle';
      
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="fas ${alertIcon} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      // Remover alertas anteriores
      $('.alert').remove();
      
      // Adicionar novo alerta no topo da página
      $('body').prepend(alertHtml);
      
      // Remover automaticamente após 5 segundos
      setTimeout(function() {
        $('.alert').fadeOut();
      }, 5000);
    }
  </script>
</body>
</html>
