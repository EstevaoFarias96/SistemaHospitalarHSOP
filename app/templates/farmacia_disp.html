<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispensa√ß√µes - Farm√°cia</title>

  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background: #f5f5f7;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', 'SF Pro Text', Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== HEADER HORIZONTAL MODERNO ===== */
    .top-header {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 30px;
      max-width: 1800px;
      margin: 0 auto;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-brand i {
      font-size: 1.8rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-brand .brand-text h1 {
      margin: 0;
      font-size: 1.3rem;
      color: #2c3e50;
      font-weight: 600;
      line-height: 1.2;
    }

    .header-brand .brand-text small {
      font-size: 0.8rem;
      color: #7f8c8d;
      font-weight: 400;
    }

    .header-nav {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .header-nav .btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.85rem;
      transition: all 0.2s;
      border: none;
    }

    .header-nav .btn-outline-primary {
      border: 1px solid #667eea;
      color: #667eea;
    }

    .header-nav .btn-outline-primary:hover {
      background: #667eea;
      color: white;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-left: 12px;
      border-left: 1px solid #ecf0f1;
      position: relative;
    }

    .user-info {
      text-align: right;
    }

    .user-info .user-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2c3e50;
      margin: 0;
    }

    .user-info .user-role {
      font-size: 0.75rem;
      color: #7f8c8d;
    }

    .user-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .user-avatar:hover {
      transform: scale(1.05);
    }

    .user-dropdown {
      display: none;
      position: absolute;
      top: 55px;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      min-width: 180px;
      z-index: 1001;
      overflow: hidden;
      border: 1px solid #ecf0f1;
    }

    .user-dropdown.show {
      display: block;
      animation: fadeInDown 0.2s;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-dropdown a, .user-dropdown span {
      display: block;
      padding: 10px 16px;
      color: #2c3e50;
      text-decoration: none;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .user-dropdown a:hover {
      background: #f8f9fa;
    }

    .user-dropdown span {
      font-weight: 600;
      border-bottom: 1px solid #ecf0f1;
    }

    .main-content {
      padding: 20px 30px;
      max-width: 1800px;
      margin: 0 auto;
    }

    .hidden {
      display: none;
    }

    /* ===== CARDS ESTILO APPLE - MINIMALISTA E ELEGANTE ===== */
    .dispensation-card {
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.02);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 0;
      border: 0.5px solid rgba(0,0,0,0.06);
      overflow: hidden;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      height: 100%;
    }

    .dispensation-card:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 8px 16px rgba(0,0,0,0.08), 0 12px 32px rgba(0,0,0,0.04);
      border-color: rgba(102, 126, 234, 0.2);
    }

    .dispensation-card .card-header {
      padding: 8px 10px;
      border-bottom: 0.5px solid rgba(0,0,0,0.06);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .dispensation-card .card-header h6 {
      font-size: 0.8rem;
      margin-bottom: 1px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .dispensation-card .card-header small {
      font-size: 0.65rem;
      opacity: 0.7;
      font-weight: 400;
    }

    .dispensation-card .card-body {
      padding: 8px 10px;
      font-size: 0.75rem;
      line-height: 1.4;
    }

    .dispensation-card .card-body .mb-2 {
      margin-bottom: 4px !important;
    }

    .dispensation-card .card-body strong {
      font-size: 0.7rem;
      color: #86868b;
      font-weight: 600;
      letter-spacing: -0.2px;
      display: block;
      margin-bottom: 1px;
    }

    .dispensation-card .card-body > div {
      color: #1d1d1f;
      font-size: 0.75rem;
    }

    .dispensation-card .btn-sm {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 6px;
    }

    /* Gap utility para Bootstrap 4 */
    .gap-1 {
      gap: 0.25rem;
    }

    .prescription-actions {
      margin-top: 8px;
    }

    /* Badges estilo Apple */
    .badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
      letter-spacing: -0.2px;
      border: none;
    }

    .status-pending, .badge-warning {
      background: rgba(255, 149, 0, 0.1);
      color: #ff9500;
    }

    .status-approved, .badge-info {
      background: rgba(0, 122, 255, 0.1);
      color: #007aff;
    }

    .status-dispensed, .badge-success {
      background: rgba(52, 199, 89, 0.1);
      color: #34c759;
    }

    .status-cancelled, .badge-danger {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
    }

    .badge-light {
      background: rgba(0,0,0,0.05);
      color: #1d1d1f;
    }

    /* ===== ESTAT√çSTICAS ESTILO APPLE ===== */
    .stats-card {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 18px;
      padding: 20px;
      border: 0.5px solid rgba(0,0,0,0.04);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      height: 100%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    }

    .stats-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border-color: rgba(0,122,255,0.15);
    }

    .stats-card .card-body {
      padding: 0;
    }

    .stats-card h5 {
      font-size: 0.7rem;
      color: #86868b;
      margin-bottom: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stats-card h3 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: #1d1d1f;
      letter-spacing: -1px;
    }

    .stats-card small {
      font-size: 0.75rem;
      color: #86868b;
      font-weight: 400;
    }

    .stats-card i {
      opacity: 0.15;
      font-size: 2.5rem;
    }

    /* ===== FILTROS ESTILO APPLE ===== */
    .filter-section {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 18px 20px;
      margin-bottom: 20px;
      border: 0.5px solid rgba(0,0,0,0.06);
      box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    }

    .filter-section label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #86868b;
      margin-bottom: 6px;
      letter-spacing: -0.2px;
    }

    .filter-section .form-control {
      font-size: 0.85rem;
      border-radius: 10px;
      border: 0.5px solid rgba(0,0,0,0.1);
      padding: 8px 12px;
      background: rgba(255,255,255,0.8);
      transition: all 0.2s;
    }

    .filter-section .form-control:focus {
      border-color: #007aff;
      box-shadow: 0 0 0 4px rgba(0,122,255,0.1);
      outline: none;
    }

    .filter-section .btn {
      font-size: 0.8rem;
      border-radius: 10px;
    }

    /* ===== BOT√ïES ESTILO APPLE ===== */
    .prescription-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .prescription-actions .btn, .btn-sm {
      font-size: 0.75rem;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      letter-spacing: -0.3px;
      border: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-outline-primary, .btn-outline-danger, .btn-outline-info, .btn-outline-secondary {
      background: transparent;
      border: 1px solid rgba(0,0,0,0.1);
      color: #1d1d1f;
    }

    .btn-outline-danger {
      border-color: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
    }

    .btn-outline-info {
      border-color: rgba(0, 122, 255, 0.2);
      color: #007aff;
    }

    .btn-primary, .btn-info {
      background: #007aff;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .btn-danger {
      background: #ff3b30;
      color: white;
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
    }

    .btn-success {
      background: #34c759;
      color: white;
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
    }

    .btn:hover {
      transform: scale(1.03);
      opacity: 0.9;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-dispense {
      background: #34c759;
      color: white;
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Estilos espec√≠ficos para prescri√ß√µes do fluxo */
    .fluxo-card {
      border-left: 4px solid #17a2b8;
    }

    .fluxo-card .card-header {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }

    /* UI MELHORADA - Auto-complete e busca r√°pida */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: none;
    }

    .autocomplete-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .autocomplete-item:hover {
      background: #f8f9fa;
    }

    .autocomplete-item.active {
      background: #e9ecef;
    }

    .autocomplete-item .med-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 3px;
    }

    .autocomplete-item .med-info {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .autocomplete-item .med-stock {
      float: right;
      font-weight: 600;
      color: #28a745;
    }

    .autocomplete-item .med-stock.low {
      color: #ffc107;
    }

    .autocomplete-item .med-stock.out {
      color: #dc3545;
    }

    /* Bot√£o de a√ß√£o r√°pida */
    .btn-quick-dispense {
      position: relative;
      overflow: hidden;
    }

    .btn-quick-dispense::after {
      content: '‚ö°';
      margin-left: 5px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Badge de quantidade */
    .qty-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #007bff;
      color: white;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 5px;
    }

    /* Indicador de processamento */
    .processing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .processing-overlay.show {
      display: flex;
    }

    .processing-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .processing-content .spinner {
      font-size: 3rem;
      color: #007bff;
      margin-bottom: 15px;
    }

    /* Modal otimizado */
    .modal-quick {
      transition: all 0.2s;
    }

    .quick-add-item {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .quick-add-item.added {
      border-color: #28a745;
      border-style: solid;
      background: #d4edda;
    }

    .quick-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .quick-input-group input {
      flex: 1;
      min-width: 0;
    }

    .quick-input-group .btn {
      flex-shrink: 0;
    }

    /* Atalhos de teclado */
    .keyboard-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 0.85rem;
      z-index: 1000;
      display: none;
    }

    .keyboard-hint.show {
      display: block;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .kbd {
      background: #fff;
      color: #333;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 0.9em;
      border: 1px solid #ccc;
    }

    /* ===== MODAL ELEGANTE ===== */
    .modal-content {
      border-radius: 16px;
      border: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    .modal-header {
      border-bottom: 1px solid #e1e8ed;
      padding: 20px 24px;
      border-radius: 16px 16px 0 0;
    }

    .modal-header .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
    }

    .modal-header .close {
      padding: 0;
      margin: 0;
      color: white;
      opacity: 0.9;
      font-size: 1.5rem;
      text-shadow: none;
    }

    .modal-header .close:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 24px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .modal-body .card {
      border-radius: 10px;
      border: 1px solid #e1e8ed;
      margin-bottom: 16px;
    }

    .modal-body .card-header {
      background: #f8f9fa;
      border-bottom: 1px solid #e1e8ed;
      padding: 12px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #2c3e50;
    }

    .modal-body .card-body {
      padding: 16px;
      font-size: 0.85rem;
    }

    .modal-footer {
      border-top: 1px solid #e1e8ed;
      padding: 16px 24px;
      border-radius: 0 0 16px 16px;
      background: #f8f9fa;
    }

    .modal-footer .btn {
      padding: 10px 24px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
    }

    /* Tabela principal de prescri√ß√µes */
    #prescriptions-table table {
      font-size: 0.85rem;
    }

    #prescriptions-table thead th {
      font-size: 0.75rem;
      font-weight: 600;
      color: #1d1d1f;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      padding: 12px 10px;
      background: #f5f5f7;
      border-bottom: 2px solid #e1e8ed;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #prescriptions-table tbody td {
      padding: 10px;
      vertical-align: middle;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      font-size: 0.8rem;
    }

    #prescriptions-table tbody tr:hover {
      background: rgba(0,122,255,0.03);
      transition: all 0.2s ease;
    }

    #prescriptions-table .tipo-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 600;
      text-align: center;
    }

    #prescriptions-table .tipo-emergencia {
      background: rgba(255,59,48,0.1);
      color: #ff3b30;
      border: 1px solid rgba(255,59,48,0.2);
    }

    #prescriptions-table .tipo-fluxo {
      background: rgba(0,122,255,0.1);
      color: #007aff;
      border: 1px solid rgba(0,122,255,0.2);
    }

    #prescriptions-table .medicamentos-preview {
      max-height: 60px;
      overflow-y: auto;
      font-size: 0.75rem;
      line-height: 1.4;
      color: #5a6c7d;
    }

    /* Tabela no modal */
    .modal-body table {
      font-size: 0.85rem;
    }

    .modal-body table th {
      font-size: 0.8rem;
      font-weight: 600;
      color: #5a6c7d;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      padding: 10px;
    }

    .modal-body table td {
      padding: 10px;
      vertical-align: middle;
    }

    /* Form controls no modal */
    .modal-body .form-control, .modal-body .form-control-sm {
      border-radius: 6px;
      border: 1px solid #e1e8ed;
      font-size: 0.85rem;
    }

    .modal-body .form-control:focus, .modal-body .form-control-sm:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Bot√£o de Emerg√™ncia - Discreto */
    .btn-emergency {
      background: #9CA3AF;
      color: white;
      border: 1px solid #D1D5DB;
      font-weight: 400;
      font-size: 0.75rem;
      padding: 6px 12px;
      border-radius: 6px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      opacity: 0.6;
    }

    .btn-emergency:hover {
      background: #DC2626;
      border-color: #991B1B;
      opacity: 1;
      color: white;
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
    }

    .btn-emergency i {
      font-size: 0.7rem;
    }

    /* Controles de Setor */
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      padding: 8px 14px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .control-group:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      border-color: rgba(102, 126, 234, 0.3);
    }

    .control-group.setor-ativo {
      border-color: #667eea;
      background: linear-gradient(135deg, #F0F9FF, white);
    }

    .control-label {
      font-size: 13px;
      font-weight: 600;
      color: #4A5568;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .control-label i {
      color: #667eea;
      font-size: 14px;
    }

    .control-select {
      border: 2px solid #E2E8F0;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 500;
      color: #4A5568;
      background: white;
      transition: all 0.3s ease;
      min-width: 180px;
    }

    .control-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .setor-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      animation: pulse-setor 2s infinite;
    }

    @keyframes pulse-setor {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    .setor-indicator i {
      color: white;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .header-content {
        padding: 10px 15px;
      }

      .header-brand .brand-text h1 {
        font-size: 1.1rem;
      }

      .header-nav .btn {
        padding: 5px 10px;
        font-size: 0.8rem;
      }

      .user-info {
        display: none;
      }

      .main-content {
        padding: 15px;
      }

      .prescription-actions {
        flex-direction: column;
      }

      .prescription-actions .btn {
        width: 100%;
      }

      .stats-card h3 {
        font-size: 1.5rem;
      }

      .control-group {
        width: 100%;
        flex-direction: row;
      }

      .control-select {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Header Horizontal -->
  <div class="top-header">
    <div class="header-content">
      <div class="header-brand">
        <i class="fas fa-pills"></i>
        <div class="brand-text">
          <h1>Farm√°cia - Dispensa√ß√µes</h1>
          <small id="dataHoraAtual">Carregando...</small>
        </div>
      </div>

      <div class="header-nav">
        <a href="/farmacia" class="btn btn-outline-primary btn-sm">
          <i class="fas fa-home mr-1"></i>Painel
        </a>
        <a href="/farmacia/estoque" class="btn btn-outline-primary btn-sm">
          <i class="fas fa-boxes mr-1"></i>Estoque
        </a>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.location.reload()">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>

      <div class="header-user">
        <div class="user-info">
          <div class="user-name" id="userNameDisplay">Farm√°cia</div>
          <div class="user-role">Funcion√°rio</div>
        </div>
        <div class="user-avatar" id="userMenuButton">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <span id="userNameDisplay2">Funcion√°rio</span>
          <a href="#" id="changePasswordOption">Mudar a senha</a>
          <a href="/logout">Sair</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">

        <!-- Cards de Estat√≠sticas -->
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="card-title mb-0">Pendentes</h5>
                    <h3 class="mb-0" id="stats-pendentes">--</h3>
                    <small>Prescri√ß√µes</small>
                  </div>
                  <div class="text-right">
                    <i class="fas fa-clock fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="card-title mb-0">Aprovadas</h5>
                    <h3 class="mb-0" id="stats-aprovadas">--</h3>
                    <small>Para dispensa√ß√£o</small>
                  </div>
                  <div class="text-right">
                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="card-title mb-0">Dispensadas</h5>
                    <h3 class="mb-0" id="stats-dispensadas">--</h3>
                    <small>Hoje</small>
                  </div>
                  <div class="text-right">
                    <i class="fas fa-hand-holding-medical fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="card-title mb-0">Rejeitadas</h5>
                    <h3 class="mb-0" id="stats-rejeitadas">--</h3>
                    <small>Esta semana</small>
                  </div>
                  <div class="text-right">
                    <i class="fas fa-times-circle fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Controles de Setor e Emerg√™ncia -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex flex-wrap align-items-center gap-3" style="gap: 12px;">
              <!-- Grupo de Setor M√©dico -->
              <div class="control-group" id="groupSetorFarmacia">
                <div class="control-label">
                  <i class="fas fa-map-marker-alt"></i>
                  <span>Setor:</span>
                </div>
                <select id="setorFarmacia" class="control-select">
                  <option value="">Selecionar setor...</option>
                  <option value="Farm√°cia Central">üè• Farm√°cia Central</option>
                  <option value="Farm√°cia Sat√©lite 1">üíä Farm√°cia Sat√©lite 1</option>
                  <option value="Farm√°cia Sat√©lite 2">üíä Farm√°cia Sat√©lite 2</option>
                  <option value="Farmacia Clinica">‚öïÔ∏è Farm√°cia Cl√≠nica</option>
                </select>
              </div>

              <!-- Indicador de Setor Ativo -->
              <div id="setorIndicatorFarmacia" class="setor-indicator" style="display: none;">
                <i class="fas fa-map-marker-alt"></i>
                <span id="setorAtualTextoFarmacia"></span>
              </div>

              <!-- Espa√ßador -->
              <div style="flex-grow: 1;"></div>

              <!-- Bot√£o de Emerg√™ncia -->
              <button id="btnEmergenciaAprovar" class="btn btn-emergency" title="Fun√ß√£o de emerg√™ncia - Usar apenas em casos cr√≠ticos">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Emerg√™ncia
              </button>
            </div>
          </div>
        </div>

        <!-- Filtros e Busca -->
        <div class="filter-section">
          <div class="row align-items-end">
            <div class="col-md-3 mb-3">
              <label class="font-weight-bold">Buscar Paciente</label>
              <input type="text" class="form-control" id="filtro-paciente" placeholder="Nome do paciente">
            </div>
            <div class="col-md-2 mb-3">
              <label class="font-weight-bold">Status</label>
              <select class="form-control" id="filtro-status">
                <option value="">Todos</option>
                <option value="pending">Pendente</option>
                <option value="approved">Aprovada</option>
                <option value="dispensed">Dispensada</option>
                <option value="cancelled">Cancelada</option>
              </select>
            </div>
            <div class="col-md-2 mb-3">
              <label class="font-weight-bold">M√©dico</label>
              <select class="form-control" id="filtro-medico">
                <option value="">Todos</option>
                <option value="1">Dr. Jo√£o Silva</option>
                <option value="2">Dra. Maria Santos</option>
                <option value="3">Dr. Pedro Costa</option>
              </select>
            </div>
            <div class="col-md-2 mb-3">
              <label class="font-weight-bold">Per√≠odo</label>
              <select class="form-control" id="filtro-periodo">
                <option value="hoje">Hoje</option>
                <option value="semana">Esta semana</option>
                <option value="mes">Este m√™s</option>
                <option value="todos">Todos</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <button class="btn btn-primary btn-block" id="btn-filtrar">
                <i class="fas fa-search mr-1"></i>Filtrar
              </button>
            </div>
          </div>
        </div>

        <!-- Lista de Prescri√ß√µes -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">
                    <i class="fas fa-prescription mr-2 text-primary"></i>Prescri√ß√µes
                    <span class="badge badge-primary ml-2" id="total-prescricoes">0</span>
                  </h5>
                </div>
              </div>
              <div class="card-body p-0">

                <!-- Visualiza√ß√£o em Tabela -->
                <div id="prescriptions-table">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="thead-light">
                        <tr>
                          <th width="5%">Tipo</th>
                          <th width="20%">Paciente</th>
                          <th width="15%">M√©dico</th>
                          <th width="10%">Data/Hora</th>
                          <th width="10%">Atendimento</th>
                          <th width="25%">Medicamentos</th>
                          <th width="10%">Status</th>
                          <th width="5%">A√ß√µes</th>
                        </tr>
                      </thead>
                      <tbody id="tabela-prescricoes">
                        <tr>
                          <td colspan="8" class="text-center text-muted py-5">
                            <i class="fas fa-table fa-2x mb-2"></i><br/>
                            Selecione a visualiza√ß√£o em tabela para ver os dados.
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fecha Main Content -->
  </div>

  <!-- Modal de Detalhes da Prescri√ß√£o -->
  <div class="modal fade" id="modalPrescricaoDetalhes" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-prescription mr-2"></i>Detalhes da Prescri√ß√£o
          </h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Informa√ß√µes do Paciente -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="fas fa-user mr-2"></i>Informa√ß√µes do Paciente
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <strong>Nome:</strong> <span id="detalhe-paciente-nome">Jo√£o Silva</span><br>
                  <strong>Idade:</strong> <span id="detalhe-paciente-idade">35 anos</span><br>
                  <strong>CPF:</strong> <span id="detalhe-paciente-cpf">123.456.789-00</span>
                </div>
                <div class="col-md-6">
                  <strong>Telefone:</strong> <span id="detalhe-paciente-telefone">(11) 99999-9999</span><br>
                  <strong>Endere√ßo:</strong> <span id="detalhe-paciente-endereco">Rua Exemplo, 123</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Informa√ß√µes da Prescri√ß√£o -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="fas fa-stethoscope mr-2"></i>Informa√ß√µes da Prescri√ß√£o
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <strong>M√©dico:</strong> <span id="detalhe-medico-nome">Dr. Jo√£o Silva</span><br>
                  <strong>CRM:</strong> <span id="detalhe-medico-crm">123456-SP</span><br>
                  <strong>Data:</strong> <span id="detalhe-data">15/12/2024</span>
                </div>
                <div class="col-md-6">
                  <strong>N√∫mero da Prescri√ß√£o:</strong> <span id="detalhe-numero">PR-2024-001</span><br>
                  <strong>Status:</strong> <span id="detalhe-status" class="badge badge-warning">Pendente</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Medicamentos Prescritos -->
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="fas fa-pills mr-2"></i>Medicamentos Prescritos
              </h6>
            </div>
            <div class="card-body">
              <div id="medicamentos-prescritos">
                <!-- Medicamentos ser√£o inseridos aqui -->
                <div class="medicamento-item">
                  <div class="row align-items-center">
                    <div class="col-md-4">
                      <strong>Dipirona 500mg</strong><br>
                      <small class="text-muted">Comprimido</small>
                    </div>
                    <div class="col-md-2">
                      <span class="badge badge-info">8x ao dia</span>
                    </div>
                    <div class="col-md-2">
                      <span class="badge badge-success">Dispon√≠vel</span>
                    </div>
                    <div class="col-md-2">
                      <small>Quantidade: 30</small>
                    </div>
                    <div class="col-md-2">
                      <button class="btn btn-success btn-sm">
                        <i class="fas fa-check mr-1"></i>Dispensar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i>Fechar
          </button>
          <button type="button" class="btn btn-success" id="btn-dispensar-tudo">
            <i class="fas fa-hand-holding-medical mr-1"></i>Dispensar Tudo
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Mudar Senha -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Mudar a senha</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="form-group">
              <label for="senhaAtual">Senha Atual</label>
              <input type="password" class="form-control" id="senhaAtual" name="senhaAtual" required>
            </div>
            <div class="form-group">
              <label for="novaSenha">Nova Senha</label>
              <input type="password" class="form-control" id="novaSenha" name="novaSenha" required>
            </div>
            <div class="form-group">
              <label for="confirmarNovaSenha">Confirmar Nova Senha</label>
              <input type="password" class="form-control" id="confirmarNovaSenha" name="confirmarNovaSenha" required>
            </div>
            <button type="submit" class="btn btn-primary">Alterar Senha</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o de Dispensa√ß√£o do Fluxo -->
  <div class="modal fade" id="modalConfirmacaoFluxo" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">
            <i class="fas fa-check-circle mr-2"></i>Confirmar Dispensa√ß√£o - Fluxo
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Informa√ß√µes da Prescri√ß√£o -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="fas fa-prescription mr-2"></i>Informa√ß√µes da Prescri√ß√£o
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <strong>Paciente:</strong> <span id="fluxo-paciente-nome">Jo√£o Silva</span><br>
                  <strong>CPF:</strong> <span id="fluxo-paciente-cpf">123.456.789-00</span><br>
                  <strong>Data:</strong> <span id="fluxo-data">15/12/2024</span>
                </div>
                <div class="col-md-6">
                  <strong>M√©dico:</strong> <span id="fluxo-medico-nome">Dr. Jo√£o Silva</span><br>
                  <strong>Medicamento:</strong> <span id="fluxo-medicamento-nome">Dipirona 500mg</span><br>
                  <strong>Quantidade Solicitada:</strong> <span id="fluxo-quantidade-solicitada">10</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Busca de Medicamento -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="fas fa-search mr-2"></i>Selecionar Medicamento do Estoque
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-9">
                  <label class="font-weight-bold">Buscar Medicamento: <small class="text-muted">(digite para buscar automaticamente)</small></label>
                  <div class="autocomplete-container">
                    <input type="text" class="form-control" id="busca-medicamento-fluxo" placeholder="Digite o nome do medicamento..." autocomplete="off">
                    <div class="autocomplete-results" id="autocomplete-results"></div>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="font-weight-bold">&nbsp;</label>
                  <button class="btn btn-success btn-block" id="btn-adicionar-rapido">
                    <i class="fas fa-plus-circle mr-1"></i>Adicionar R√°pido
                  </button>
                </div>
              </div>

              <div id="resultado-busca-medicamento" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle mr-2"></i>
                  <span id="texto-resultado-busca">Buscando medicamentos...</span>
                </div>
                <div id="lista-medicamentos-fluxo" class="mt-3">
                  <!-- Medicamentos encontrados ser√£o inseridos aqui -->
                </div>
              </div>
            </div>
          </div>

      <!-- Medicamentos Selecionados (M√∫ltiplos) -->
      <div class="card" id="card-medicamentos-selecionados" style="display: none;">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="fas fa-check mr-2"></i>Medicamentos Selecionados
          </h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-bordered mb-0">
              <thead class="thead-light">
                <tr>
                  <th style="min-width: 220px;">Medicamento</th>
                  <th>Estoque</th>
                  <th>Unid.</th>
                  <th style="width: 140px;">Quantidade</th>
                  <th style="width: 150px;">Status</th>
                  <th style="min-width: 220px;">Observa√ß√µes</th>
                  <th style="width: 60px;">Remover</th>
                </tr>
              </thead>
              <tbody id="tabela-itens-selecionados">
                <tr class="sem-itens">
                  <td colspan="7" class="text-center text-muted py-3">
                    Nenhum medicamento adicionado. Busque e clique em "Adicionar".
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted">Solicitado: <span id="info-quantidade-solicitada">-</span></small>
            <small class="text-muted">Itens selecionados: <span id="contador-itens-selecionados">0</span></small>
          </div>
        </div>
      </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i>Cancelar
          </button>
          <button type="button" class="btn btn-success" id="btn-confirmar-dispensacao-fluxo" disabled>
            <i class="fas fa-check mr-1"></i>Confirmar Dispensa√ß√£o
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de Processamento -->
  <div class="processing-overlay" id="processingOverlay">
    <div class="processing-content">
      <div class="spinner">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
      <h5 id="processingMessage">Processando dispensa√ß√£o...</h5>
      <p class="text-muted mb-0" id="processingDetail">Aguarde um momento</p>
    </div>
  </div>

  <!-- Hint de Atalhos de Teclado -->
  <div class="keyboard-hint" id="keyboardHint">
    <strong>Atalhos:</strong><br>
    <span class="kbd">Ctrl</span> + <span class="kbd">F</span> - Buscar medicamento<br>
    <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> - Confirmar dispensa√ß√£o<br>
    <span class="kbd">Esc</span> - Fechar modal<br>
    <span class="kbd">?</span> - Mostrar/ocultar atalhos
  </div>

  <!-- jQuery e Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    $(document).ready(function() {
      // Carregar nome do funcion√°rio
      $.getJSON('/api/farmacia/nome', function(data) {
        if(data.nome) {
          $('#userNameDisplay').text(data.nome);
          $('#userNameDisplay2').text(data.nome);
        }
      }).fail(function() {
        $('#userNameDisplay').text('Funcion√°rio da Farm√°cia');
        $('#userNameDisplay2').text('Funcion√°rio');
      });

      // Atualizar data e hora
      atualizarDataHora();
      setInterval(atualizarDataHora, 60000);

      // Carregar prescri√ß√µes pendentes do fluxo e emerg√™ncia
      carregarTodasPrescricoes();

      // Carregar estat√≠sticas
      carregarEstatisticas();

      // Configurar atalhos de teclado
      configurarAtalhosTeclado();

      // Configurar auto-complete
      configurarAutoComplete();

      // Configurar controle de setor
      configurarControleSetor();

      // Configurar bot√£o de emerg√™ncia
      configurarBotaoEmergencia();
    });


    // Fun√ß√£o para carregar estat√≠sticas
    function carregarEstatisticas() {
      $.ajax({
        url: '/api/dispensacoes/estatisticas',
        method: 'GET',
        success: function(response) {
          if (response.success) {
            $('#stats-pendentes').text(response.pendentes || 0);
            $('#stats-aprovadas').text(response.dispensadas || 0);
            $('#stats-dispensadas').text(response.dispensadas || 0);
            $('#stats-rejeitadas').text(response.rejeitadas || 0);
            $('#total-prescricoes').text(response.pendentes || 0);
          }
        },
        error: function() {
          $('#stats-pendentes').text('--');
          $('#stats-aprovadas').text('--');
          $('#stats-dispensadas').text('--');
          $('#stats-rejeitadas').text('--');
        }
      });
    }

    // Fun√ß√£o para atualizar estat√≠sticas com prescri√ß√µes do fluxo
    function atualizarEstatisticasComFluxo(totalFluxo, totalEmergencia) {
      const total = totalFluxo + (totalEmergencia || 0);
      $('#total-prescricoes').text(total);
      $('#stats-pendentes').text(total);
      // Recarregar estat√≠sticas completas
      carregarEstatisticas();
    }

    // Fun√ß√£o para carregar todas as prescri√ß√µes (fluxo + emerg√™ncia)
    function carregarTodasPrescricoes() {
      console.log('>>> Iniciando carregamento de prescri√ß√µes...');

      // Mostrar loading na tabela
      $('#tabela-prescricoes').html(`
        <tr>
          <td colspan="8" class="text-center py-5">
            <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i><br/>
            <p class="text-muted">Carregando prescri√ß√µes...</p>
          </td>
        </tr>
      `);

      // Carregar prescri√ß√µes do fluxo e emerg√™ncia em paralelo
      Promise.all([
        $.ajax({url: '/api/dispensacoes/fluxo-pendentes', method: 'GET'}),
        $.ajax({url: '/api/dispensacoes/emergencia-pendentes', method: 'GET'})
      ])
      .then(function(results) {
        const fluxoResponse = results[0];
        const emergenciaResponse = results[1];

        console.log('Dados recebidos do servidor:');
        console.log('- Fluxo:', fluxoResponse);
        console.log('- Emerg√™ncia:', emergenciaResponse);

        const prescricoesFluxo = (fluxoResponse.success) ? fluxoResponse.data : [];
        const prescricoesEmergencia = (emergenciaResponse.success) ? emergenciaResponse.data : [];

        console.log(`Total prescri√ß√µes: ${prescricoesFluxo.length} fluxo + ${prescricoesEmergencia.length} emerg√™ncia`);

        exibirTodasPrescricoes(prescricoesFluxo, prescricoesEmergencia);
        atualizarEstatisticasComFluxo(prescricoesFluxo.length, prescricoesEmergencia.length);
      })
      .catch(function(error) {
        console.error('Erro ao carregar prescri√ß√µes:', error);
        $('#tabela-prescricoes').html(`
          <tr>
            <td colspan="8" class="text-center text-danger py-5">
              <i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br/>
              <strong>Erro ao carregar prescri√ß√µes</strong>
            </td>
          </tr>
        `);
        atualizarEstatisticasComFluxo(0, 0);
      });
    }

    // Fun√ß√£o para exibir todas as prescri√ß√µes em tabela
    function exibirTodasPrescricoes(prescricoesFluxo, prescricoesEmergencia) {
      const tbody = $('#tabela-prescricoes');

      if (prescricoesFluxo.length === 0 && prescricoesEmergencia.length === 0) {
        tbody.html(`
          <tr>
            <td colspan="8" class="text-center text-muted py-5">
              <i class="fas fa-clipboard-check fa-2x mb-2"></i><br/>
              <strong>Nenhuma prescri√ß√£o pendente</strong><br/>
              <small>Todas as prescri√ß√µes foram processadas.</small>
            </td>
          </tr>
        `);
        $('#total-prescricoes').text('0');
        return;
      }

      tbody.empty();

      // Exibir prescri√ß√µes de emerg√™ncia primeiro
      prescricoesEmergencia.forEach(function(prescricao) {
        const row = criarLinhaEmergencia(prescricao);
        tbody.append(row);
      });

      // Exibir prescri√ß√µes do fluxo
      prescricoesFluxo.forEach(function(prescricao) {
        const row = criarLinhaFluxo(prescricao);
        tbody.append(row);
      });

      $('#total-prescricoes').text(prescricoesFluxo.length + prescricoesEmergencia.length);
    }

    // Fun√ß√£o para carregar prescri√ß√µes pendentes do fluxo_disp
    function carregarPrescricoesFluxo() {
      // Mostrar loading no container principal
      $('#prescriptions-cards').html(`
        <div class="text-center py-5">
          <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
          <p class="text-muted">Carregando prescri√ß√µes pendentes...</p>
        </div>
      `);

      $.ajax({
        url: '/api/dispensacoes/fluxo-pendentes',
        method: 'GET',
        success: function(response) {
          if (response.success) {
            exibirPrescricoesFluxo(response.data);
            atualizarEstatisticasComFluxo(response.total);
          } else {
            $('#prescriptions-cards').html(`
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Erro ao carregar prescri√ß√µes: ${response.message}
              </div>
            `);
            atualizarEstatisticasComFluxo(0);
          }
        },
        error: function(xhr) {
          console.error('Erro ao carregar prescri√ß√µes do fluxo:', xhr);
          $('#prescriptions-cards').html(`
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              Erro ao carregar prescri√ß√µes do fluxo. C√≥digo: ${xhr.status}
            </div>
          `);
          atualizarEstatisticasComFluxo(0);
        }
      });
    }

    // Fun√ß√£o para exibir prescri√ß√µes do fluxo
    function exibirPrescricoesFluxo(prescricoes) {
      const container = $('#prescriptions-cards');

      if (prescricoes.length === 0) {
        container.html(`
          <div class="empty-state">
            <i class="fas fa-clipboard-check"></i>
            <h5>Nenhuma prescri√ß√£o pendente</h5>
            <p>Todas as prescri√ß√µes do fluxo foram processadas.</p>
          </div>
        `);
        return;
      }

      container.empty();

      prescricoes.forEach(function(prescricao) {
        const card = criarCardPrescricaoFluxo(prescricao);
        container.append(card);
      });
    }

    // Fun√ß√£o para criar linha de tabela - Emerg√™ncia
    function criarLinhaEmergencia(prescricao) {
      const dataHora = prescricao.horario_prescricao ? new Date(prescricao.horario_prescricao) : new Date();
      const dataFormatada = dataHora.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
      const horaFormatada = dataHora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});

      const medicamentosTexto = prescricao.medicamentos_texto || 'Nenhum medicamento prescrito';
      const medicamentosPreview = medicamentosTexto.length > 100 ?
        medicamentosTexto.substring(0, 100) + '...' : medicamentosTexto;

      const medicoNome = prescricao.medico.nome || 'N/A';

      return `
        <tr data-prescricao-id="${prescricao.id}" data-tipo="emergencia">
          <td>
            <span class="tipo-badge tipo-emergencia">EMG</span>
          </td>
          <td>
            <strong>${prescricao.paciente.nome}</strong>
          </td>
          <td>${medicoNome}</td>
          <td>
            <small>${dataFormatada}<br/>${horaFormatada}</small>
          </td>
          <td>
            <span class="badge badge-light">${prescricao.atendimento_id}</span>
          </td>
          <td>
            <div class="medicamentos-preview">${medicamentosPreview}</div>
          </td>
          <td>
            <span class="badge badge-warning">Pendente</span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-info btn-sm btn-ver-detalhes-emergencia" data-prescricao-id="${prescricao.id}" title="Ver detalhes">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-danger btn-sm btn-processar-emergencia" data-prescricao-id="${prescricao.id}" title="Processar">
                <i class="fas fa-check"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }

    // Fun√ß√£o para criar linha de tabela - Fluxo
    function criarLinhaFluxo(prescricao) {
      const dataFormatada = new Date(prescricao.data).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
      const horaFormatada = prescricao.hora ? prescricao.hora.substring(0, 5) : 'N/A';

      const medicoNome = prescricao.medico.nome || 'N/A';
      const medicamentoInfo = `${prescricao.medicamento} (${prescricao.quantidade})`;

      let statusBadge = '';
      if (prescricao.status === 'Dispensado') {
        statusBadge = '<span class="badge badge-success">Dispensado</span>';
      } else if (prescricao.status === 'Parcial') {
        statusBadge = '<span class="badge badge-warning">Parcial</span>';
      } else if (prescricao.status === 'Cancelado') {
        statusBadge = '<span class="badge badge-danger">Cancelado</span>';
      } else {
        statusBadge = '<span class="badge badge-secondary">Pendente</span>';
      }

      const botoesAcao = prescricao.status === 'Pendente' ? `
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-info btn-sm btn-ver-detalhes-fluxo" data-prescricao-id="${prescricao.id}" title="Ver detalhes">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-info btn-sm btn-processar-fluxo" data-prescricao-id="${prescricao.id}" title="Processar">
            <i class="fas fa-check"></i>
          </button>
        </div>
      ` : `
        <button class="btn btn-sm btn-secondary" disabled title="J√° processado">
          <i class="fas fa-check-circle"></i>
        </button>
      `;

      return `
        <tr data-prescricao-id="${prescricao.id}" data-tipo="fluxo">
          <td>
            <span class="tipo-badge tipo-fluxo">FLX</span>
          </td>
          <td>
            <strong>${prescricao.paciente.nome}</strong>
          </td>
          <td>${medicoNome}</td>
          <td>
            <small>${dataFormatada}<br/>${horaFormatada}</small>
          </td>
          <td>
            <span class="badge badge-light">${prescricao.atendimento_id || '-'}</span>
          </td>
          <td>
            <div class="medicamentos-preview">${medicamentoInfo}</div>
          </td>
          <td>${statusBadge}</td>
          <td>${botoesAcao}</td>
        </tr>
      `;
    }

    // Fun√ß√£o removida - n√£o h√° mais sidebar

    // Fun√ß√£o removida - n√£o √© mais necess√°ria pois o setor est√° apenas na p√°gina principal

    // Fun√ß√£o para mostrar toast notifications
    function showToast(message, type = 'info', title = 'Notifica√ß√£o') {
      // Criar toast se n√£o existir
      if (!$('#toast-container').length) {
        $('body').append(`
          <div id="toast-container" class="toast-container position-fixed" style="top: 20px; right: 20px; z-index: 1060;">
            <div id="toast-notification" class="toast" role="alert">
              <div class="toast-header">
                <i class="fas fa-info-circle mr-2" id="toast-icon"></i>
                <strong class="mr-auto" id="toast-title">Notifica√ß√£o</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">
                  <span>&times;</span>
                </button>
              </div>
              <div class="toast-body" id="toast-message"></div>
            </div>
          </div>
        `);
      }

      const toast = $('#toast-notification');
      const icon = $('#toast-icon');
      const titleEl = $('#toast-title');
      const messageEl = $('#toast-message');

      // Remove classes anteriores
      toast.removeClass('bg-success bg-danger bg-warning bg-info');
      icon.removeClass('fa-check-circle fa-exclamation-triangle fa-info-circle fa-times-circle');

      // Adiciona classe e √≠cone baseado no tipo
      switch(type) {
        case 'success':
          toast.addClass('bg-success');
          icon.addClass('fa-check-circle text-white');
          break;
        case 'error':
          toast.addClass('bg-danger');
          icon.addClass('fa-times-circle text-white');
          break;
        case 'warning':
          toast.addClass('bg-warning');
          icon.addClass('fa-exclamation-triangle text-dark');
          break;
        case 'info':
        default:
          toast.addClass('bg-info');
          icon.addClass('fa-info-circle text-white');
          break;
      }

      titleEl.text(title);
      messageEl.text(message);

      toast.toast({ delay: 5000, autohide: true });
      toast.toast('show');
    }

    // Fun√ß√£o para atualizar data e hora
    function atualizarDataHora() {
      const agora = new Date();
      const opcoes = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      const dataHoraFormatada = agora.toLocaleDateString('pt-BR', opcoes);
      $('#dataHoraAtual').text(dataHoraFormatada);
    }

    // Menu do usu√°rio - Atualizado para novo header
    $('#userMenuButton').click(function(e) {
      e.stopPropagation();
      $('#userDropdown').toggleClass('show');
    });

    $(document).click(function(event) {
      if(!$(event.target).closest('.header-user').length) {
        $('#userDropdown').removeClass('show');
      }
    });

    $('#changePasswordOption').click(function(e) {
      e.preventDefault();
      $('#userDropdown').removeClass('show');
      $('#changePasswordModal').modal('show');
    });

    $('#changePasswordForm').submit(function(e) {
      e.preventDefault();
      const senhaAtual = $('#senhaAtual').val();
      const novaSenha = $('#novaSenha').val();
      const confirmarNovaSenha = $('#confirmarNovaSenha').val();

      if(novaSenha !== confirmarNovaSenha) {
        alert('A nova senha e a confirma√ß√£o n√£o conferem.');
        return;
      }

      if (!senhaAtual.trim() || !novaSenha.trim()) {
        alert('Por favor, preencha todos os campos.');
        return;
      }

      fetch('/api/farmacia/mudar-senha', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          senha_atual: senhaAtual,
          nova_senha: novaSenha
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Resposta n√£o √© JSON v√°lido');
        }

        return response.json();
      })
      .then(data => {
        if(data.success) {
          alert('Senha alterada com sucesso.');
          $('#changePasswordModal').modal('hide');
          $('#changePasswordForm')[0].reset();
        } else {
          alert('Erro: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Erro:', error);

        if (error.message.includes('JSON')) {
          alert('Erro: Sess√£o expirada. Por favor, fa√ßa login novamente.');
          window.location.href = '/logout';
        } else {
          alert('Erro ao alterar a senha: ' + error.message);
        }
      });
    });

    // Fun√ß√µes placeholder
    function abrirRelatorios() {
      alert('Funcionalidade de relat√≥rios ser√° implementada.');
    }

    function abrirConfiguracoes() {
      alert('Funcionalidade de configura√ß√µes ser√° implementada.');
    }

    // Fun√ß√£o para atualizar data e hora
    function atualizarDataHora() {
      const agora = new Date();
      const opcoes = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      const dataHoraFormatada = agora.toLocaleDateString('pt-BR', opcoes);
      $('#dataHoraAtual').text(dataHoraFormatada);
    }

    // ========== FUN√á√ïES PARA MODAL DE CONFIRMA√á√ÉO DO FLUXO ==========

    let prescricaoAtualFluxo = null;
    let medicamentoSelecionadoFluxo = null; // legado (um √∫nico)
    let itensSelecionadosFluxo = []; // novo: m√∫ltiplos itens

    // Event listener para bot√£o de processar fluxo
    $(document).on('click', '.btn-processar-fluxo', function() {
      const prescricaoId = $(this).data('prescricao-id');
      abrirModalConfirmacaoFluxo(prescricaoId);
    });

    // Event listener para bot√£o de ver detalhes do fluxo
    $(document).on('click', '.btn-ver-detalhes-fluxo', function() {
      const prescricaoId = $(this).data('prescricao-id');
      // Aqui poderia abrir um modal com detalhes completos
      showToast('Funcionalidade de detalhes ser√° implementada.', 'info');
    });

    // ========== FUN√á√ïES PARA PRESCRI√á√ïES DE EMERG√äNCIA ==========

    let prescricaoAtualEmergencia = null;

    // Event listener para bot√£o de processar emerg√™ncia
    $(document).on('click', '.btn-processar-emergencia', function() {
      const prescricaoId = $(this).data('prescricao-id');
      abrirModalConfirmacaoEmergencia(prescricaoId);
    });

    // Event listener para bot√£o de ver detalhes de emerg√™ncia
    $(document).on('click', '.btn-ver-detalhes-emergencia', function() {
      const prescricaoId = $(this).data('prescricao-id');
      // Aqui poderia abrir um modal com detalhes completos
      showToast('Visualizando detalhes da prescri√ß√£o de emerg√™ncia...', 'info');
    });

    // Fun√ß√£o para abrir modal de confirma√ß√£o para prescri√ß√£o de emerg√™ncia
    function abrirModalConfirmacaoEmergencia(prescricaoId) {
      // Verificar se o setor foi selecionado
      const setorSelecionado = $('#setorFarmacia').val();
      if (!setorSelecionado) {
        showToast('‚ö†Ô∏è Selecione o setor na p√°gina principal antes de processar a prescri√ß√£o!', 'warning');
        $('#setorFarmacia').focus();
        return;
      }

      // Buscar dados da prescri√ß√£o
      $.ajax({
        url: '/api/dispensacoes/emergencia-pendentes',
        method: 'GET',
        success: function(response) {
          if (response.success) {
            const prescricao = response.data.find(p => p.id === prescricaoId);
            if (prescricao) {
              prescricaoAtualEmergencia = prescricao;
              preencherModalConfirmacaoEmergencia(prescricao);
              $('#modalConfirmacaoFluxo').modal('show');
            } else {
              showToast('Prescri√ß√£o n√£o encontrada.', 'error');
            }
          } else {
            showToast('Erro ao carregar prescri√ß√£o.', 'error');
          }
        },
        error: function(xhr) {
          console.error('Erro ao buscar prescri√ß√£o:', xhr);
          showToast('Erro ao carregar prescri√ß√£o.', 'error');
        }
      });
    }

    // Fun√ß√£o para preencher modal com dados da prescri√ß√£o de emerg√™ncia
    function preencherModalConfirmacaoEmergencia(prescricao) {
      // Resetar estado do modal
      medicamentoSelecionadoFluxo = null;
      $('#card-medicamentos-selecionados').hide();
      $('#resultado-busca-medicamento').hide();
      $('#btn-confirmar-dispensacao-fluxo').prop('disabled', true);
      $('#busca-medicamento-fluxo').val('');
      itensSelecionadosFluxo = [];
      renderizarItensSelecionados();

      // Preencher informa√ß√µes da prescri√ß√£o
      $('#fluxo-paciente-nome').text(prescricao.paciente.nome);
      $('#fluxo-paciente-cpf').text(prescricao.paciente.cpf || 'N/A');
      $('#fluxo-medico-nome').text(prescricao.medico.nome || 'N/A');
      $('#fluxo-quantidade-solicitada').text('Conforme prescri√ß√£o');

      const dataHora = prescricao.horario_prescricao ? new Date(prescricao.horario_prescricao) : new Date();
      const dataFormatada = dataHora.toLocaleDateString('pt-BR');
      $('#fluxo-data').text(dataFormatada);

      // Alterar t√≠tulo do modal para indicar que √© emerg√™ncia
      $('#modalConfirmacaoFluxo .modal-title').html('<i class="fas fa-ambulance mr-2"></i>Confirmar Dispensa√ß√£o - Emerg√™ncia');
      $('#modalConfirmacaoFluxo .modal-header').removeClass('bg-info').addClass('bg-danger');

      // Exibir medicamentos da prescri√ß√£o de emerg√™ncia
      const medicamentosTexto = prescricao.medicamentos_texto || 'Nenhum medicamento prescrito';

      $('#fluxo-medicamento-nome').html(`
        <div style="white-space: pre-line; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #dc3545;">
          ${medicamentosTexto}
        </div>
        <small class="text-muted mt-2 d-block">Busque e adicione os medicamentos dispon√≠veis no estoque abaixo.</small>
      `);
    }

    // Fun√ß√£o para abrir modal de confirma√ß√£o
    function abrirModalConfirmacaoFluxo(prescricaoId) {
      // Verificar se o setor foi selecionado
      const setorSelecionado = $('#setorFarmacia').val();
      if (!setorSelecionado) {
        showToast('‚ö†Ô∏è Selecione o setor na p√°gina principal antes de processar a prescri√ß√£o!', 'warning');
        $('#setorFarmacia').focus();
        return;
      }

      // Buscar dados da prescri√ß√£o
      $.ajax({
        url: '/api/dispensacoes/fluxo-pendentes',
        method: 'GET',
        success: function(response) {
          if (response.success) {
            const prescricao = response.data.find(p => p.id === prescricaoId);
            if (prescricao) {
              prescricaoAtualFluxo = prescricao;
              preencherModalConfirmacaoFluxo(prescricao);
              $('#modalConfirmacaoFluxo').modal('show');
            } else {
              showToast('Prescri√ß√£o n√£o encontrada.', 'error');
            }
          } else {
            showToast('Erro ao carregar prescri√ß√£o.', 'error');
          }
        },
        error: function(xhr) {
          console.error('Erro ao buscar prescri√ß√£o:', xhr);
          showToast('Erro ao carregar prescri√ß√£o.', 'error');
        }
      });
    }

    // Fun√ß√£o para preencher modal com dados da prescri√ß√£o
    function preencherModalConfirmacaoFluxo(prescricao) {
      // Resetar estado do modal
      medicamentoSelecionadoFluxo = null;
      $('#card-medicamentos-selecionados').hide();
      $('#resultado-busca-medicamento').hide();
      $('#btn-confirmar-dispensacao-fluxo').prop('disabled', true);
      $('#busca-medicamento-fluxo').val('');
      itensSelecionadosFluxo = [];
      renderizarItensSelecionados();

      // Resetar t√≠tulo do modal para fluxo (caso tenha sido alterado pela emerg√™ncia)
      $('#modalConfirmacaoFluxo .modal-title').html('<i class="fas fa-check-circle mr-2"></i>Confirmar Dispensa√ß√£o - Fluxo');
      $('#modalConfirmacaoFluxo .modal-header').removeClass('bg-danger').addClass('bg-info');

      // Preencher informa√ß√µes da prescri√ß√£o
      $('#fluxo-paciente-nome').text(prescricao.paciente.nome);
      $('#fluxo-paciente-cpf').text(prescricao.paciente.cpf || 'N/A');
      $('#fluxo-medico-nome').text(prescricao.medico.nome || 'N/A');
      $('#fluxo-medicamento-nome').text(prescricao.medicamento);
      $('#fluxo-quantidade-solicitada').text(prescricao.quantidade);

      const dataFormatada = new Date(prescricao.data).toLocaleDateString('pt-BR');
      $('#fluxo-data').text(dataFormatada);
    }

    // Event listener para busca de medicamentos
    $('#btn-buscar-medicamento-fluxo').on('click', function() {
      buscarMedicamentosFluxo();
    });

    // Permitir busca ao pressionar Enter
    $('#busca-medicamento-fluxo').on('keypress', function(e) {
      if (e.which === 13) {
        buscarMedicamentosFluxo();
      }
    });

    // Fun√ß√£o para buscar medicamentos
    function buscarMedicamentosFluxo() {
      const termoBusca = $('#busca-medicamento-fluxo').val().trim();
      const setor = $('#setorFarmacia').val();

      if (!setor) {
        showToast('Selecione o setor do estoque antes de buscar.', 'warning');
        return;
      }

      if (!termoBusca) {
        showToast('Digite o nome do medicamento para buscar.', 'warning');
        return;
      }

      $('#resultado-busca-medicamento').show();
      $('#texto-resultado-busca').text('Buscando medicamentos...');
      $('#lista-medicamentos-fluxo').empty();
      $('#btn-buscar-medicamento-fluxo').prop('disabled', true);

      $.ajax({
        url: '/api/medicamentos/buscar',
        method: 'GET',
        data: { q: termoBusca, setor: setor },
        success: function(response) {
          if (response.success) {
            exibirResultadosBuscaMedicamentos(response.medicamentos);
          } else {
            $('#texto-resultado-busca').text('Erro na busca.');
            showToast('Erro ao buscar medicamentos.', 'error');
          }
        },
        error: function(xhr) {
          console.error('Erro na busca:', xhr);
          $('#texto-resultado-busca').text('Erro na busca.');
          showToast('Erro ao buscar medicamentos.', 'error');
        },
        complete: function() {
          $('#btn-buscar-medicamento-fluxo').prop('disabled', false);
        }
      });
    }

    // Fun√ß√£o para exibir resultados da busca
    function exibirResultadosBuscaMedicamentos(medicamentos) {
      const container = $('#lista-medicamentos-fluxo');

      if (medicamentos.length === 0) {
        $('#texto-resultado-busca').text('Nenhum medicamento encontrado.');
        container.html('<div class="alert alert-warning">Nenhum medicamento encontrado com esse nome.</div>');
        return;
      }

      $('#texto-resultado-busca').text(`${medicamentos.length} medicamento(s) encontrado(s).`);

      let html = '<div class="row">';
      medicamentos.forEach(function(med) {
        html += `
          <div class="col-md-6 mb-3">
            <div class="card medicamento-card" data-medicamento-id="${med.id}" style="cursor: pointer;">
              <div class="card-body">
                <h6 class="card-title text-primary">${med.nome}</h6>
                <p class="card-text small mb-1">
                  <strong>Apresenta√ß√£o:</strong> ${med.apresentacao}<br>
                  <strong>Classe:</strong> ${med.classe}<br>
                  <strong>Estoque:</strong> ${med.quantidade_total} ${med.unidade}
                </p>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary btn-adicionar-medicamento" data-medicamento-id="${med.id}">
                    <i class="fas fa-plus mr-1"></i>Adicionar
                  </button>
                  <button class="btn btn-outline-secondary btn-detalhar-medicamento" data-medicamento-id="${med.id}">
                    <i class="fas fa-info-circle"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';

      container.html(html);
    }

    // Event listener para selecionar medicamento
    // Novo: adicionar medicamento √† lista
    $(document).on('click', '.btn-adicionar-medicamento', function(e) {
      e.stopPropagation();
      const medicamentoId = $(this).data('medicamento-id');
      adicionarMedicamentoALista(medicamentoId);
    });

    // Tamb√©m permitir sele√ß√£o clicando no card
    $(document).on('click', '.medicamento-card', function() {
      const medicamentoId = $(this).data('medicamento-id');
      adicionarMedicamentoALista(medicamentoId);
    });

    // Fun√ß√£o para selecionar medicamento
    function adicionarMedicamentoALista(medicamentoId) {
      // Evitar duplicatas (por id)
      const jaExiste = itensSelecionadosFluxo.some(item => item.id === medicamentoId);
      if (jaExiste) {
        showToast('Medicamento j√° adicionado √† lista.', 'warning');
        return;
      }

      const setor = $('#setorFarmacia').val();
      if (!setor) {
        showToast('Selecione o setor do estoque antes de adicionar.', 'warning');
        return;
      }

      $.ajax({
        url: '/api/medicamentos/buscar',
        method: 'GET',
        data: { medicamento_id: medicamentoId, setor: setor },
        success: function(response) {
          if (response.success && response.medicamento) {
            const med = response.medicamento;
            const quantidadeSolicitada = prescricaoAtualFluxo ? (prescricaoAtualFluxo.quantidade || 1) : 1;
            const quantidadeDefault = Math.min(quantidadeSolicitada, med.quantidade_total || 0);

            const item = {
              id: med.id,
              nome: med.nome,
              apresentacao: med.apresentacao,
              classe: med.classe,
              unidade: med.unidade,
              estoque_total: med.quantidade_total || 0,
              lotes: (med.itens && med.itens.length) ? med.itens.length : 0,
              quantidade: quantidadeDefault,
              status: 'Aprovado',
              observacoes: ''
            };

            itensSelecionadosFluxo.push(item);
            renderizarItensSelecionados();
            $('#card-medicamentos-selecionados').show();
            $('#btn-confirmar-dispensacao-fluxo').prop('disabled', false);
          } else {
            showToast('Erro ao carregar detalhes do medicamento.', 'error');
          }
        },
        error: function(xhr) {
          console.error('Erro ao carregar medicamento:', xhr);
          showToast('Erro ao carregar detalhes do medicamento.', 'error');
        }
      });
    }

    // Fun√ß√£o para preencher informa√ß√µes do medicamento selecionado
    // Renderiza√ß√£o da tabela de itens selecionados
    function renderizarItensSelecionados() {
      const tbody = $('#tabela-itens-selecionados');
      tbody.empty();

      if (itensSelecionadosFluxo.length === 0) {
        tbody.append('<tr class="sem-itens"><td colspan="7" class="text-center text-muted py-3">Nenhum medicamento adicionado. Busque e clique em "Adicionar".</td></tr>');
        $('#contador-itens-selecionados').text('0');
        validarEstadoConfirmar();
        return;
      }

      itensSelecionadosFluxo.forEach((item) => {
        const linha = `
          <tr data-id="${item.id}">
            <td>
              <div class="font-weight-bold">${item.nome}</div>
              <small class="text-muted">${item.apresentacao} ¬∑ ${item.classe} ¬∑ Lotes: ${item.lotes}</small>
            </td>
            <td>${item.estoque_total}</td>
            <td>${item.unidade}</td>
            <td>
              <input type="number" class="form-control form-control-sm campo-quantidade" min="0" max="${item.estoque_total}" value="${item.quantidade}" />
              <small class="text-muted">m√°x: ${item.estoque_total}</small>
            </td>
            <td>
              <select class="form-control form-control-sm campo-status">
                <option value="Aprovado" ${item.status === 'Aprovado' ? 'selected' : ''}>Aprovado</option>
                <option value="Parcial" ${item.status === 'Parcial' ? 'selected' : ''}>Parcial</option>
                <option value="Cancelado" ${item.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
              </select>
            </td>
            <td>
              <input type="text" class="form-control form-control-sm campo-observacoes" placeholder="Observa√ß√µes..." value="${item.observacoes || ''}" />
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger btn-remover-item" title="Remover">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
        tbody.append(linha);
      });

      $('#contador-itens-selecionados').text(String(itensSelecionadosFluxo.length));
      $('#info-quantidade-solicitada').text(prescricaoAtualFluxo ? (prescricaoAtualFluxo.quantidade || '-') : '-');
      validarEstadoConfirmar();
    }

    // Eventos da tabela: quantidade, status, observa√ß√µes, remo√ß√£o
    $(document).on('input change', '#tabela-itens-selecionados .campo-quantidade', function() {
      const linha = $(this).closest('tr');
      const id = linha.data('id');
      const valor = parseInt($(this).val()) || 0;
      const item = itensSelecionadosFluxo.find(i => i.id === id);
      if (!item) return;
      if (valor < 0) {
        $(this).val(0);
        item.quantidade = 0;
      } else if (valor > item.estoque_total) {
        $(this).val(item.estoque_total);
        item.quantidade = item.estoque_total;
        showToast('Quantidade ajustada ao m√°ximo dispon√≠vel.', 'warning');
      } else {
        item.quantidade = valor;
      }
      validarEstadoConfirmar();
    });

    $(document).on('change', '#tabela-itens-selecionados .campo-status', function() {
      const linha = $(this).closest('tr');
      const id = linha.data('id');
      const valor = $(this).val();
      const item = itensSelecionadosFluxo.find(i => i.id === id);
      if (item) item.status = valor;
      validarEstadoConfirmar();
    });

    $(document).on('input', '#tabela-itens-selecionados .campo-observacoes', function() {
      const linha = $(this).closest('tr');
      const id = linha.data('id');
      const valor = $(this).val();
      const item = itensSelecionadosFluxo.find(i => i.id === id);
      if (item) item.observacoes = valor;
    });

    $(document).on('click', '#tabela-itens-selecionados .btn-remover-item', function() {
      const linha = $(this).closest('tr');
      const id = linha.data('id');
      itensSelecionadosFluxo = itensSelecionadosFluxo.filter(i => i.id !== id);
      renderizarItensSelecionados();
      if (itensSelecionadosFluxo.length === 0) {
        $('#card-medicamentos-selecionados').hide();
      }
    });

    function validarEstadoConfirmar() {
      // Deve haver pelo menos 1 item com quantidade > 0 e status != Cancelado
      const temItemValido = itensSelecionadosFluxo.some(i => i.quantidade > 0 && i.status !== 'Cancelado');
      $('#btn-confirmar-dispensacao-fluxo').prop('disabled', !temItemValido);
    }

    // Event listener para confirmar dispensa√ß√£o
    $('#btn-confirmar-dispensacao-fluxo').on('click', function() {
      confirmarDispensacaoFluxo();
    });

    // Fun√ß√£o para confirmar dispensa√ß√£o
    function confirmarDispensacaoFluxo() {
      // Verificar se √© prescri√ß√£o de fluxo ou emerg√™ncia
      const isPrescricaoEmergencia = (prescricaoAtualEmergencia !== null);
      const prescricaoAtual = isPrescricaoEmergencia ? prescricaoAtualEmergencia : prescricaoAtualFluxo;

      if (!prescricaoAtual) {
        showToast('Dados da prescri√ß√£o ausentes.', 'error');
        return;
      }

      if (!Array.isArray(itensSelecionadosFluxo) || itensSelecionadosFluxo.length === 0) {
        showToast('Adicione pelo menos um medicamento.', 'warning');
        return;
      }

      const itensValidos = itensSelecionadosFluxo.filter(i => i.quantidade > 0 && i.quantidade <= i.estoque_total);
      if (itensValidos.length === 0) {
        showToast('Nenhum item v√°lido para dispensa√ß√£o.', 'warning');
        return;
      }

      const resumo = itensValidos.map(i => `‚Ä¢ ${i.nome}: ${i.quantidade} ${i.unidade} (${i.status})`).join('\n');
      const tipoPrescricao = isPrescricaoEmergencia ? 'Emerg√™ncia' : 'Fluxo';
      const mensagem = `Confirmar dispensa√ß√£o [${tipoPrescricao}] para ${prescricaoAtual.paciente.nome}?\n\n${resumo}`;
      if (!confirm(mensagem)) return;

      $('#btn-confirmar-dispensacao-fluxo').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Processando...');

      // Se for prescri√ß√£o de emerg√™ncia, usar endpoint diferente
      if (isPrescricaoEmergencia) {
        processarDispensacaoEmergencia(itensValidos);
        return;
      }

      // Tenta enviar em lote; se n√£o dispon√≠vel, cai no sequencial
      const payloadLote = {
        prescricao_id: prescricaoAtualFluxo.id,
        setor: $('#setorFarmacia').val() || '',
        itens: itensValidos.map(i => ({
          medicamento_id: i.id,
          quantidade_confirmada: i.quantidade,
          status: i.status,
          observacoes: i.observacoes || ''
        }))
      };

      console.log('Tentando processamento em lote:', payloadLote);

      $.ajax({
        url: '/api/dispensacoes/fluxo-processar-multiplos',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payloadLote),
        success: function(response) {
          console.log('Resposta processamento lote:', response);
          if (response && response.success) {
            showToast(response.message || 'Dispensa√ß√£o conclu√≠da.', 'success');
            $('#modalConfirmacaoFluxo').modal('hide');

            console.log('Processamento em lote conclu√≠do. Recarregando em 500ms...');

            // Dar tempo para o banco processar
            setTimeout(function() {
              console.log('Recarregando prescri√ß√µes e estat√≠sticas...');
              carregarTodasPrescricoes();
              carregarEstatisticas();
            }, 500);

            prescricaoAtualFluxo = null;
            itensSelecionadosFluxo = [];
            $('#btn-confirmar-dispensacao-fluxo').prop('disabled', false).html('<i class="fas fa-check mr-1"></i>Confirmar Dispensa√ß√£o');
          } else {
            console.warn('Resposta sem success, processando sequencialmente');
            // Se endpoint n√£o implementado ou falha geral, processa sequencialmente
            processarSequencialmente(itensValidos);
          }
        },
        error: function(xhr) {
          console.error('Erro no processamento em lote:', xhr);
          if (xhr && (xhr.status === 404 || xhr.status === 405)) {
            console.log('Endpoint n√£o encontrado, usando fallback sequencial');
            // Fallback: processar item a item
            processarSequencialmente(itensValidos);
          } else {
            console.error('Erro na dispensa√ß√£o em lote:', xhr);
            let msg = 'Erro ao processar dispensa√ß√£o.';
            try {
              const resp = xhr && xhr.responseJSON ? xhr.responseJSON : JSON.parse(xhr.responseText);
              if (resp && resp.message) msg = resp.message;
              console.error('Mensagem de erro do servidor:', msg);
            } catch (e) {
              console.error('Erro ao processar resposta de erro:', e);
            }
            showToast(msg, 'error');
            $('#btn-confirmar-dispensacao-fluxo').prop('disabled', false).html('<i class="fas fa-check mr-1"></i>Confirmar Dispensa√ß√£o');
          }
        }
      });
    }

    // Processa itens em sequ√™ncia usando o endpoint de item √∫nico
    function processarSequencialmente(itens) {
      const resultados = [];
      const processar = (indice) => {
        if (indice >= itens.length) {
          const falhas = resultados.filter(r => !r.success);
          if (falhas.length === 0) {
            showToast('Dispensa√ß√£o conclu√≠da para todos os itens.', 'success');
          } else {
            showToast(`Conclu√≠do com falhas em ${falhas.length} item(ns).`, 'warning');
          }
          $('#modalConfirmacaoFluxo').modal('hide');

          console.log('Processamento sequencial conclu√≠do. Recarregando em 500ms...');

          // Dar tempo para o banco processar
          setTimeout(function() {
            console.log('Recarregando prescri√ß√µes e estat√≠sticas...');
            carregarTodasPrescricoes();
            carregarEstatisticas();
          }, 500);

          prescricaoAtualFluxo = null;
          itensSelecionadosFluxo = [];
          $('#btn-confirmar-dispensacao-fluxo').prop('disabled', false).html('<i class="fas fa-check mr-1"></i>Confirmar Dispensa√ß√£o');
          return;
        }

        const i = itens[indice];
        const payload = {
          prescricao_id: prescricaoAtualFluxo.id,
          setor: $('#setorFarmacia').val() || '',
          medicamento_id: i.id,
          quantidade_confirmada: i.quantidade,
          status: i.status,
          observacoes: i.observacoes || ''
        };

        console.log('Enviando dispensa√ß√£o:', payload);

        $.ajax({
          url: '/api/dispensacoes/fluxo-processar',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(payload)
        })
        .done(function(resp) {
          console.log('Resposta do servidor:', resp);
          resultados.push({ success: !!(resp && resp.success), item: i, response: resp });
        })
        .fail(function(xhr) {
          console.error('Erro na dispensa√ß√£o:', xhr);
          let msg = 'Falha ao processar item.';
          try {
            const resp = xhr && xhr.responseJSON ? xhr.responseJSON : JSON.parse(xhr.responseText);
            if (resp && resp.message) msg = resp.message;
            console.error('Mensagem de erro:', msg);
          } catch (e) {
            console.error('Erro ao processar resposta de erro:', e);
          }
          showToast(`${i.nome}: ${msg}`, 'error');
          resultados.push({ success: false, item: i, error: xhr });
        })
        .always(function() {
          processar(indice + 1);
        });
      };

      processar(0);
    }

    // Fun√ß√£o para processar dispensa√ß√£o de emerg√™ncia
    function processarDispensacaoEmergencia(itensValidos) {
      $.ajax({
        url: '/api/dispensacoes/emergencia-processar',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          prescricao_id: prescricaoAtualEmergencia.id,
          setor: $('#setorFarmacia').val() || 'Farmacia Satelite',
          itens: itensValidos.map(i => ({
            medicamento_id: i.id,
            quantidade: i.quantidade,
            status: i.status,
            observacoes: i.observacoes || ''
          }))
        }),
        success: function(response) {
          if (response && response.success) {
            showToast(response.message || 'Dispensa√ß√£o de emerg√™ncia conclu√≠da.', 'success');
            $('#modalConfirmacaoFluxo').modal('hide');
            carregarTodasPrescricoes();
            carregarEstatisticas();
            prescricaoAtualEmergencia = null;
            itensSelecionadosFluxo = [];
          } else {
            showToast(response.message || 'Erro ao processar dispensa√ß√£o.', 'error');
          }
        },
        error: function(xhr) {
          console.error('Erro na dispensa√ß√£o de emerg√™ncia:', xhr);
          let msg = 'Erro ao processar dispensa√ß√£o de emerg√™ncia.';
          try {
            const resp = xhr && xhr.responseJSON ? xhr.responseJSON : JSON.parse(xhr.responseText);
            if (resp && resp.message) msg = resp.message;
          } catch (e) {}
          showToast(msg, 'error');
        },
        complete: function() {
          $('#btn-confirmar-dispensacao-fluxo').prop('disabled', false).html('<i class="fas fa-check mr-1"></i>Confirmar Dispensa√ß√£o');
        }
      });
    }

    // Resetar modal quando for fechado
    $('#modalConfirmacaoFluxo').on('hidden.bs.modal', function() {
      prescricaoAtualFluxo = null;
      prescricaoAtualEmergencia = null;
      medicamentoSelecionadoFluxo = null;
      itensSelecionadosFluxo = [];
      renderizarItensSelecionados();
      $('#card-medicamentos-selecionados').hide();
      // Resetar t√≠tulo do modal
      $('#modalConfirmacaoFluxo .modal-title').html('<i class="fas fa-check-circle mr-2"></i>Confirmar Dispensa√ß√£o - Fluxo');
      $('#modalConfirmacaoFluxo .modal-header').removeClass('bg-danger').addClass('bg-info');
    });

    // ========== MELHORIAS DE UI - AUTO-COMPLETE E ATALHOS ==========

    let autoCompleteTimeout = null;
    let autoCompleteResults = [];
    let autoCompleteSelectedIndex = -1;

    // Configurar auto-complete de medicamentos
    function configurarAutoComplete() {
      const input = $('#busca-medicamento-fluxo');
      const resultsContainer = $('#autocomplete-results');

      // Busca din√¢mica enquanto digita
      input.on('input', function() {
        const termo = $(this).val().trim();
        const setor = $('#setorFarmacia').val();

        clearTimeout(autoCompleteTimeout);

        if (termo.length < 2) {
          resultsContainer.hide().empty();
          return;
        }

        if (!setor) {
          resultsContainer.html('<div class="autocomplete-item"><div class="text-warning">‚ö†Ô∏è Selecione o setor primeiro</div></div>').show();
          return;
        }

        // Debounce - espera 300ms ap√≥s parar de digitar
        autoCompleteTimeout = setTimeout(function() {
          buscarMedicamentosAutoComplete(termo, setor);
        }, 300);
      });

      // Navega√ß√£o com teclado
      input.on('keydown', function(e) {
        const items = resultsContainer.find('.autocomplete-item');

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          autoCompleteSelectedIndex = Math.min(autoCompleteSelectedIndex + 1, items.length - 1);
          atualizarSelecaoAutoComplete();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          autoCompleteSelectedIndex = Math.max(autoCompleteSelectedIndex - 1, 0);
          atualizarSelecaoAutoComplete();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (autoCompleteSelectedIndex >= 0 && autoCompleteResults[autoCompleteSelectedIndex]) {
            adicionarMedicamentoALista(autoCompleteResults[autoCompleteSelectedIndex].id);
            input.val('');
            resultsContainer.hide();
            autoCompleteSelectedIndex = -1;
          }
        } else if (e.key === 'Escape') {
          resultsContainer.hide();
          autoCompleteSelectedIndex = -1;
        }
      });

      // Fechar ao clicar fora
      $(document).on('click', function(e) {
        if (!$(e.target).closest('.autocomplete-container').length) {
          resultsContainer.hide();
          autoCompleteSelectedIndex = -1;
        }
      });
    }

    // Buscar medicamentos para auto-complete
    function buscarMedicamentosAutoComplete(termo, setor) {
      const resultsContainer = $('#autocomplete-results');

      resultsContainer.html('<div class="autocomplete-item"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando...</div>').show();

      $.ajax({
        url: '/api/medicamentos/buscar',
        method: 'GET',
        data: { q: termo, setor: setor },
        success: function(response) {
          if (response.success && response.medicamentos && response.medicamentos.length > 0) {
            autoCompleteResults = response.medicamentos;
            exibirResultadosAutoComplete(response.medicamentos);
          } else {
            resultsContainer.html('<div class="autocomplete-item"><div class="text-muted">Nenhum medicamento encontrado</div></div>').show();
          }
        },
        error: function() {
          resultsContainer.html('<div class="autocomplete-item"><div class="text-danger">Erro ao buscar medicamentos</div></div>').show();
        }
      });
    }

    // Exibir resultados do auto-complete
    function exibirResultadosAutoComplete(medicamentos) {
      const resultsContainer = $('#autocomplete-results');
      resultsContainer.empty();

      medicamentos.forEach(function(med, index) {
        const stockClass = med.quantidade_total > 10 ? '' : (med.quantidade_total > 0 ? 'low' : 'out');
        const stockText = med.quantidade_total > 0 ? `${med.quantidade_total} ${med.unidade}` : 'Sem estoque';

        const item = $(`
          <div class="autocomplete-item" data-index="${index}" data-med-id="${med.id}">
            <div class="med-name">${med.nome} <span class="med-stock ${stockClass}">${stockText}</span></div>
            <div class="med-info">${med.apresentacao} ‚Ä¢ ${med.classe}</div>
          </div>
        `);

        item.on('click', function() {
          adicionarMedicamentoALista(med.id);
          $('#busca-medicamento-fluxo').val('');
          resultsContainer.hide();
          autoCompleteSelectedIndex = -1;
        });

        resultsContainer.append(item);
      });

      resultsContainer.show();
      autoCompleteSelectedIndex = -1;
    }

    // Atualizar sele√ß√£o visual do auto-complete
    function atualizarSelecaoAutoComplete() {
      const items = $('#autocomplete-results .autocomplete-item');
      items.removeClass('active');

      if (autoCompleteSelectedIndex >= 0 && autoCompleteSelectedIndex < items.length) {
        $(items[autoCompleteSelectedIndex]).addClass('active');
      }
    }

    // Bot√£o de adi√ß√£o r√°pida
    $('#btn-adicionar-rapido').on('click', function() {
      const termo = $('#busca-medicamento-fluxo').val().trim();
      const setor = $('#setorFarmacia').val();

      if (!setor) {
        showToast('Selecione o setor do estoque primeiro.', 'warning');
        return;
      }

      if (!termo) {
        showToast('Digite o nome do medicamento.', 'warning');
        return;
      }

      // Se houver resultados no autocomplete, adicionar o primeiro
      if (autoCompleteResults.length > 0) {
        adicionarMedicamentoALista(autoCompleteResults[0].id);
        $('#busca-medicamento-fluxo').val('');
        $('#autocomplete-results').hide();
      } else {
        showToast('Nenhum medicamento encontrado com esse nome.', 'info');
      }
    });

    // Configurar atalhos de teclado globais
    function configurarAtalhosTeclado() {
      let hintVisible = false;

      $(document).on('keydown', function(e) {
        // Ctrl + F - Focar no campo de busca
        if (e.ctrlKey && e.key === 'f') {
          e.preventDefault();
          if ($('#modalConfirmacaoFluxo').hasClass('show')) {
            $('#busca-medicamento-fluxo').focus();
          }
        }

        // Ctrl + Enter - Confirmar dispensa√ß√£o
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          if ($('#modalConfirmacaoFluxo').hasClass('show')) {
            $('#btn-confirmar-dispensacao-fluxo').click();
          }
        }

        // ESC - Fechar modal
        if (e.key === 'Escape') {
          if ($('#modalConfirmacaoFluxo').hasClass('show')) {
            $('#modalConfirmacaoFluxo').modal('hide');
          }
        }

        // ? - Mostrar/ocultar hint de atalhos
        if (e.key === '?' && !$(e.target).is('input, textarea')) {
          e.preventDefault();
          hintVisible = !hintVisible;
          if (hintVisible) {
            $('#keyboardHint').addClass('show');
            setTimeout(function() {
              $('#keyboardHint').removeClass('show');
              hintVisible = false;
            }, 5000);
          } else {
            $('#keyboardHint').removeClass('show');
          }
        }
      });

      // Mostrar hint ao abrir modal
      $('#modalConfirmacaoFluxo').on('shown.bs.modal', function() {
        $('#keyboardHint').addClass('show');
        setTimeout(function() {
          $('#keyboardHint').removeClass('show');
        }, 3000);
      });
    }

    // Fun√ß√£o auxiliar para mostrar overlay de processamento
    function mostrarProcessamento(mensagem, detalhe) {
      $('#processingMessage').text(mensagem || 'Processando...');
      $('#processingDetail').text(detalhe || 'Aguarde um momento');
      $('#processingOverlay').addClass('show');
    }

    function ocultarProcessamento() {
      $('#processingOverlay').removeClass('show');
    }

    // Melhorar feedback visual durante dispensa√ß√£o
    function processarDispensacaoEmergenciaComFeedback(itensValidos) {
      mostrarProcessamento('Processando dispensa√ß√£o de emerg√™ncia', `${itensValidos.length} medicamento(s)`);

      $.ajax({
        url: '/api/dispensacoes/emergencia-processar',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          prescricao_id: prescricaoAtualEmergencia.id,
          setor: $('#setorFarmacia').val() || 'Farmacia Satelite',
          itens: itensValidos.map(i => ({
            medicamento_id: i.id,
            quantidade: i.quantidade,
            status: i.status,
            observacoes: i.observacoes || ''
          }))
        }),
        success: function(response) {
          ocultarProcessamento();
          if (response && response.success) {
            showToast(response.message || 'Dispensa√ß√£o de emerg√™ncia conclu√≠da.', 'success');
            $('#modalConfirmacaoFluxo').modal('hide');
            carregarTodasPrescricoes();
            carregarEstatisticas();
            prescricaoAtualEmergencia = null;
            itensSelecionadosFluxo = [];
          } else {
            showToast(response.message || 'Erro ao processar dispensa√ß√£o.', 'error');
          }
        },
        error: function(xhr) {
          ocultarProcessamento();
          console.error('Erro na dispensa√ß√£o de emerg√™ncia:', xhr);
          let msg = 'Erro ao processar dispensa√ß√£o de emerg√™ncia.';
          try {
            const resp = xhr && xhr.responseJSON ? xhr.responseJSON : JSON.parse(xhr.responseText);
            if (resp && resp.message) msg = resp.message;
          } catch (e) {}
          showToast(msg, 'error');
        },
        complete: function() {
          $('#btn-confirmar-dispensacao-fluxo').prop('disabled', false).html('<i class="fas fa-check mr-1"></i>Confirmar Dispensa√ß√£o');
        }
      });
    }

    // Substituir chamada antiga pela nova com feedback
    window.processarDispensacaoEmergencia = processarDispensacaoEmergenciaComFeedback;

    // ========== CONTROLE DE SETOR ==========
    function configurarControleSetor() {
      // Carregar setor salvo do localStorage
      const setorSalvo = localStorage.getItem('setorFarmacia');
      if (setorSalvo) {
        $('#setorFarmacia').val(setorSalvo);
        atualizarIndicadorSetor();
      }

      // Salvar o setor quando alterado
      $('#setorFarmacia').on('change', function() {
        const setor = $(this).val();
        if (setor) {
          localStorage.setItem('setorFarmacia', setor);
          console.log('Setor selecionado:', setor);
        } else {
          localStorage.removeItem('setorFarmacia');
        }
        atualizarIndicadorSetor();
      });
    }

    function atualizarIndicadorSetor() {
      const setor = $('#setorFarmacia').val();

      if (setor) {
        // Mostra o indicador com o setor selecionado
        $('#setorAtualTextoFarmacia').text(setor);
        $('#setorIndicatorFarmacia').fadeIn(300);
        $('#groupSetorFarmacia').addClass('setor-ativo');
      } else {
        // Esconde o indicador
        $('#setorIndicatorFarmacia').fadeOut(300);
        $('#groupSetorFarmacia').removeClass('setor-ativo');
      }
    }

    // ========== BOT√ÉO DE EMERG√äNCIA ==========
    function configurarBotaoEmergencia() {
      $('#btnEmergenciaAprovar').on('click', function() {
        // Modal de confirma√ß√£o com aviso forte
        const confirmacao = confirm(
          '‚ö†Ô∏è ATEN√á√ÉO - FUN√á√ÉO DE EMERG√äNCIA ‚ö†Ô∏è\n\n' +
          'Este bot√£o ir√° APROVAR TODAS as solicita√ß√µes pendentes SEM REGISTRO DE BAIXA no estoque.\n\n' +
          'Use APENAS em casos de emerg√™ncia (queda de energia, falha do sistema, etc.)\n\n' +
          'Prescri√ß√µes afetadas:\n' +
          '‚Ä¢ Todas as prescri√ß√µes do FLUXO pendentes\n' +
          '‚Ä¢ Todas as prescri√ß√µes de EMERG√äNCIA pendentes\n\n' +
          'Esta a√ß√£o N√ÉO PODE ser desfeita!\n\n' +
          'Deseja REALMENTE continuar?'
        );

        if (!confirmacao) return;

        // Segunda confirma√ß√£o
        const segundaConfirmacao = confirm(
          '‚ö†Ô∏è √öLTIMA CONFIRMA√á√ÉO ‚ö†Ô∏è\n\n' +
          'Voc√™ tem CERTEZA ABSOLUTA de que deseja aprovar todas as solicita√ß√µes pendentes sem baixa no estoque?\n\n' +
          'Digite OK na pr√≥xima tela para confirmar.'
        );

        if (!segundaConfirmacao) return;

        // Terceira confirma√ß√£o com prompt
        const textoConfirmacao = prompt(
          'Digite "CONFIRMAR EMERGENCIA" (sem aspas) para prosseguir:'
        );

        if (textoConfirmacao !== 'CONFIRMAR EMERGENCIA') {
          alert('Opera√ß√£o cancelada. Texto de confirma√ß√£o incorreto.');
          return;
        }

        // Processar aprova√ß√£o em massa
        processarAprovacaoEmergencial();
      });
    }

    function processarAprovacaoEmergencial() {
      const btn = $('#btnEmergenciaAprovar');
      const textoOriginal = btn.html();

      // Desabilitar bot√£o e mostrar loading
      btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Processando Emerg√™ncia...');

      // Chamar endpoint de emerg√™ncia
      $.ajax({
        url: '/api/dispensacoes/aprovar-todas-emergencia',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          setor: $('#setorFarmacia').val() || 'Farmacia Satelite',
          timestamp: new Date().toISOString()
        }),
        success: function(response) {
          if (response && response.success) {
            alert(
              '‚úÖ APROVA√á√ÉO EMERGENCIAL CONCLU√çDA\n\n' +
              `Total de prescri√ß√µes aprovadas: ${response.total || 0}\n` +
              `‚Ä¢ Fluxo: ${response.total_fluxo || 0}\n` +
              `‚Ä¢ Emerg√™ncia: ${response.total_emergencia || 0}\n\n` +
              'IMPORTANTE: Estas dispensa√ß√µes foram aprovadas SEM baixa no estoque.\n' +
              'Registre manualmente as sa√≠das posteriormente.'
            );
            // Recarregar lista e estat√≠sticas
            carregarTodasPrescricoes();
            carregarEstatisticas();
          } else {
            alert('Erro: ' + (response.message || 'N√£o foi poss√≠vel processar a aprova√ß√£o emergencial.'));
          }
        },
        error: function(xhr) {
          console.error('Erro na aprova√ß√£o emergencial:', xhr);
          let msg = 'Erro ao processar aprova√ß√£o emergencial.';
          try {
            const resp = xhr && xhr.responseJSON ? xhr.responseJSON : JSON.parse(xhr.responseText);
            if (resp && resp.message) msg = resp.message;
          } catch (e) {}
          alert('‚ùå ERRO: ' + msg);
        },
        complete: function() {
          btn.prop('disabled', false).html(textoOriginal);
        }
      });
    }

  </script>

</body>
</html>
