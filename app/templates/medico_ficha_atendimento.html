<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de Atendimento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* ===== VARIÁVEIS DE DESIGN PROFISSIONAL ===== */
    :root {
      --azul-principal: #4A90E2;
      --azul-claro: #E8F4FF;
      --azul-medio: #7AB8F5;
      --branco-gelo: #F8FCFF;
      --cinza-texto: #4A5568;
      --cinza-claro: #E2E8F0;
      --sombra-suave: 0 2px 12px rgba(74, 144, 226, 0.08);
      --sombra-media: 0 4px 20px rgba(74, 144, 226, 0.12);
      
      --primary-dark: #357ABD;
      --primary-main: #4A90E2;
      --primary-light: #7AB8F5;
      --accent: #4A90E2;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --info: #0EA5E9;
      --secondary: #6B7280;
      
      --text-primary: #1F2937;
      --text-secondary: #4A5568;
      --text-muted: #9CA3AF;
      
      --bg-primary: #ffffff;
      --bg-secondary: #F8FCFF;
      --bg-tertiary: #E8F4FF;
      
      --border-light: #E8F4FF;
      --border-medium: #E2E8F0;
      --border-dark: #CBD5E1;
      
      --shadow-sm: 0 1px 3px rgba(74, 144, 226, 0.1);
      --shadow-md: 0 4px 12px rgba(74, 144, 226, 0.12);
      --shadow-lg: 0 10px 28px rgba(74, 144, 226, 0.15);
      
      --radius-sm: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
      
      --transition-fast: 0.15s ease;
      --transition-normal: 0.3s ease;
      --transition-slow: 0.5s ease;
    }

    /* ===== LAYOUT PRINCIPAL ===== */
    body { 
      background: linear-gradient(135deg, var(--branco-gelo) 0%, var(--azul-claro) 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* ===== SIDEBAR PROFISSIONAL ===== */
    .sidebar { 
      width: 80px; 
      height: 100vh; 
      position: fixed; 
      left: 0; 
      top: 0; 
      background: linear-gradient(180deg, var(--azul-principal) 0%, var(--primary-dark) 100%);
      display: flex; 
      flex-direction: column; 
      transition: all var(--transition-normal);
      z-index: 1000;
      box-shadow: 4px 0 20px rgba(74, 144, 226, 0.15);
      border-right: none;
    }
    
    .sidebar:hover { 
      width: 260px; 
      box-shadow: var(--shadow-lg);
    }
    
    .sidebar .nav-link { 
      color: rgba(255,255,255,0.85); 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      padding: 14px 16px; 
      border-radius: var(--radius-md); 
      margin: 4px 12px; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis;
      font-weight: 500;
      font-size: 14px;
      transition: all var(--transition-fast);
      position: relative;
    }
    
    .sidebar .nav-link::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 3px;
      background: var(--accent);
      transform: scaleY(0);
      transition: transform var(--transition-fast);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    
    .sidebar .nav-link i { 
      width: 20px; 
      text-align: center;
      font-size: 16px;
      color: rgba(255,255,255,0.9);
    }
    
    .sidebar .nav-link.active::before,
    .sidebar .nav-link:hover::before { 
      transform: scaleY(1);
    }
    
    .sidebar .nav-link.active, 
    .sidebar .nav-link:hover { 
      background-color: rgba(255,255,255,0.15);
      color: #ffffff;
      transform: translateX(3px);
    }
    
    .sidebar .nav-link span {
      opacity: 0;
      transform: translateX(-10px);
      transition: all var(--transition-normal);
    }
    
    .sidebar:hover .nav-link span {
      opacity: 1;
      transform: translateX(0);
    }

    /* ===== CONTEÚDO PRINCIPAL ===== */
    .main-content { 
      margin-left: 80px; 
      padding: 0;
      transition: margin-left var(--transition-normal); 
      min-height: 100vh;
      background: transparent;
    }
    
    .content-inner { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 24px;
    }

    /* ===== RESPONSIVIDADE MELHORADA ===== */
    @media (min-width: 1200px) {
      .sidebar:hover + .main-content { margin-left: 260px; }
    }
    
    @media (min-width: 1600px) { 
      .content-inner { max-width: 1600px; } 
    }
    
    @media (max-width: 992px) {
      .sidebar { width: 70px; }
      .sidebar:hover { width: 70px; }
      .main-content { margin-left: 70px; }
      .sidebar .nav-link span { display: none !important; }
      .content-inner { padding: 20px; }
    }
    
    @media (max-width: 768px) {
      .sidebar { width: 60px; }
      .main-content { margin-left: 60px; }
      .content-inner { padding: 16px; }
      .card .card-body { padding: 1rem; }
    }

    /* ===== HEADER DA PÁGINA ===== */
    .page-header {
      background: white;
      border-radius: var(--radius-lg);
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: var(--sombra-suave);
      border-left: 5px solid var(--azul-principal);
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 600;
      color: var(--azul-principal);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .page-title i {
      color: var(--azul-principal);
    }

    /* ===== CARDS PROFISSIONAIS ===== */
    .card { 
      border: 0; 
      border-radius: var(--radius-lg);
      box-shadow: var(--sombra-media);
      color: var(--cinza-texto);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      background: white;
      position: relative;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 28px rgba(74, 144, 226, 0.18);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--azul-principal), var(--azul-medio));
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
      color: white;
      border-bottom: none;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      padding: 20px 24px;
      font-weight: 600;
    }
    
    .card-body {
      padding: 24px;
    }

    /* ===== DADOS DO PACIENTE ===== */
    .patient-info-card {
      background: white;
      border: 0;
      border-radius: var(--radius-lg);
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: var(--sombra-media);
      position: relative;
      overflow: hidden;
    }
    
    .patient-info-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--azul-principal), var(--azul-medio));
    }
    
    .patient-info-card .info-item {
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--azul-claro);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--azul-principal);
      transition: all var(--transition-fast);
    }
    
    .patient-info-card .info-item:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
    }
    
    .patient-info-card .info-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--azul-principal);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      display: block;
    }
    
    .patient-info-card .info-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--cinza-texto);
      margin: 0;
    }

    /* ===== SEÇÕES DE CONTEÚDO ===== */
    .section { 
      display: none; 
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .section.active { 
      display: block; 
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== TRIAGEM CARD ===== */
    .triagem-card .card-header {
      background: linear-gradient(135deg, var(--info), #0ea5e9);
    }
    
    .vital-signs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .vital-sign-item {
      background: var(--bg-secondary);
      padding: 16px;
      border-radius: var(--radius-md);
      text-align: center;
      border: 1px solid var(--border-light);
      transition: all var(--transition-fast);
    }
    
    .vital-sign-item:hover {
      background: #ffffff;
      box-shadow: var(--shadow-sm);
      transform: translateY(-2px);
    }
    
    .vital-sign-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: block;
    }
    
    .vital-sign-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    /* ===== TEXTO BLOCKS MELHORADOS ===== */
    .texto-bloco { 
      white-space: pre-wrap; 
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid var(--border-light); 
      border-radius: var(--radius-lg); 
      padding: 20px; 
      min-height: 120px; 
      font-size: 14px; 
      line-height: 1.6;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text-primary);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      transition: all var(--transition-fast);
    }
    
    .texto-bloco:hover {
      border-color: var(--primary-light);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 0 3px rgba(40, 53, 147, 0.1);
    }

    /* ===== CARDS ESPECIALIZADOS ===== */
    .anamnese-card { 
      border-left: 5px solid var(--primary-main);
      background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
    }
    
    .anamnese-card .card-header {
      background: linear-gradient(135deg, var(--primary-main), var(--primary-light));
    }
    
    .reavaliacao-card { 
      border-left: 5px solid #6f42c1;
      background: linear-gradient(135deg, #ffffff 0%, #f8f4ff 100%);
    }
    
    .reavaliacao-card .card-header {
      background: linear-gradient(135deg, #6f42c1, #8e5ec6);
    }
    
    .conduta-card { 
      border-left: 5px solid var(--success);
      background: linear-gradient(135deg, #ffffff 0%, #f0fff4 100%);
    }
    
    .conduta-card .card-header {
      background: linear-gradient(135deg, var(--success), #43a047);
    }

    /* ===== BADGES E INDICADORES ===== */
    .risk-badge { 
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-sm);
    }

    /* ===== BOTÕES PROFISSIONAIS ===== */
    .btn {
      font-weight: 600;
      border-radius: var(--radius-md);
      padding: 10px 20px;
      font-size: 14px;
      transition: all var(--transition-fast);
      border: none;
      box-shadow: var(--shadow-sm);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
      border: none;
      color: white;
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--azul-medio), var(--azul-principal));
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(74, 144, 226, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success), #059669);
      border: none;
      color: white;
      font-weight: 500;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #059669, var(--success));
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
    }
    
    .btn-outline-secondary {
      border: 2px solid var(--cinza-claro);
      color: var(--cinza-texto);
      background: white;
    }
    
    .btn-outline-secondary:hover {
      background: var(--secondary);
      border-color: var(--secondary);
      color: white;
    }

    /* ===== FORMULÁRIOS E INPUTS ===== */
    .form-control, .form-select {
      border: 2px solid var(--azul-claro);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      font-size: 14px;
      transition: all var(--transition-fast);
      background: white;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--azul-principal);
      box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
      background: #ffffff;
    }
    
    .form-label {
      font-weight: 600;
      color: var(--cinza-texto);
      margin-bottom: 8px;
      font-size: 13px;
    }

    /* ===== MODAIS PROFISSIONAIS ===== */
    .modal-content {
      border: none;
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
      color: white;
      padding: 20px 24px;
      border-bottom: none;
    }
    
    .modal-title {
      font-weight: 600;
      font-size: 20px;
    }
    
    .modal-body {
      padding: 32px;
      background: var(--bg-secondary);
    }
    
    .modal-footer {
      padding: 24px 32px;
      background: var(--bg-primary);
      border-top: 1px solid var(--border-light);
    }

    /* ===== LISTAS E CONTAINERS ===== */
    .receita-container, .atestado-container, .prescricao-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      margin-bottom: 16px;
      transition: all var(--transition-normal);
      overflow: hidden;
    }
    
    .receita-container:hover, 
    .atestado-container:hover, 
    .prescricao-container:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-3px);
      border-color: var(--primary-light);
    }
    
    .receita-container .card-header,
    .atestado-container .card-header,
    .prescricao-container .card-header {
      background: linear-gradient(135deg, var(--bg-secondary), #e3f2fd);
      color: var(--text-primary);
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-light);
      font-weight: 600;
    }
    
    .receita-container .card-body,
    .atestado-container .card-body,
    .prescricao-container .card-body {
      padding: 20px;
      font-size: 14px;
      line-height: 1.6;
    }

    /* ===== BADGES E CONTADORES ===== */
    .badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== ESPAÇAMENTOS OTIMIZADOS ===== */
    .mb-3 { margin-bottom: 24px !important; }
    .mb-4 { margin-bottom: 32px !important; }
    .py-3 { padding-top: 24px !important; padding-bottom: 24px !important; }
    .py-4 { padding-top: 32px !important; padding-bottom: 32px !important; }

    /* ===== ESTADOS DE LOADING ===== */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .loading-state i {
      margin-right: 12px;
      font-size: 18px;
    }

    /* ===== MELHORIAS ESPECÍFICAS ===== */
    .text-center.text-muted {
      color: var(--text-secondary) !important;
      font-weight: 500;
    }
    
    .text-danger {
      color: var(--danger) !important;
      font-weight: 600;
    }
    
    .text-success {
      color: var(--success) !important;
      font-weight: 600;
    }

    /* ===== QUILL EDITOR STYLING ===== */
    .ql-container {
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      border: 2px solid var(--border-light);
      border-top: none;
    }
    
    .ql-toolbar {
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      border: 2px solid var(--border-light);
      border-bottom: 1px solid var(--border-medium);
      background: var(--bg-secondary);
    }
    
    .ql-editor {
      min-height: 150px;
      font-size: 14px;
      line-height: 1.6;
      font-family: 'Inter', system-ui, sans-serif;
    }

    /* ===== ANIMAÇÕES SUAVES ===== */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card {
      animation: slideInUp 0.4s ease-out;
    }

    /* ===== ABAS PROFISSIONAIS ===== */
    .nav-tabs {
      border-bottom: 2px solid var(--border-light);
      background: var(--bg-secondary);
      padding: 8px 8px 0 8px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    
    .nav-tabs .nav-link {
      border: none;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-secondary);
      background: transparent;
      transition: all var(--transition-fast);
      position: relative;
      margin-bottom: -2px;
    }
    
    .nav-tabs .nav-link::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-main), var(--accent));
      transform: scaleX(0);
      transition: transform var(--transition-fast);
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    }
    
    .nav-tabs .nav-link:hover {
      background: rgba(40, 53, 147, 0.05);
      color: var(--primary-main);
    }
    
    .nav-tabs .nav-link.active {
      background: var(--bg-primary);
      color: var(--primary-main);
      border-bottom: 3px solid var(--primary-main);
    }
    
    .nav-tabs .nav-link.active::before {
      transform: scaleX(1);
    }
    
    .tab-content {
      background: var(--bg-primary);
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      min-height: 400px;
    }
    
    .tab-pane {
      animation: fadeInTab 0.3s ease-in-out;
    }
    
    @keyframes fadeInTab {
      from { 
        opacity: 0; 
        transform: translateX(10px); 
      }
      to { 
        opacity: 1; 
        transform: translateX(0); 
      }
    }

    /* ===== Prescrições - visual aprimorado ===== */
    .prescricao-container { 
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      background: var(--bg-primary);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .prescricao-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--primary-main), var(--primary-light));
      color: #fff;
    }
    .prescricao-header .titulo { font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .prescricao-header .acoes { display: flex; align-items: center; gap: 8px; }
    .prescricao-body { padding: 16px; }
    .prescricao-section { margin-bottom: 10px; border-left: 4px solid var(--border-light); padding-left: 12px; }
    .prescricao-section h6 { margin: 0 0 6px 0; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: .3px; }
    .prescricao-meds ul { margin: 0; padding-left: 18px; }

    /* ===== CORES ESPECÍFICAS PARA CADA ABA ===== */
    #exame-fisico-tab.active {
      color: var(--primary-main) !important;
      border-bottom-color: var(--primary-main) !important;
    }
    
    #conduta-medica-tab.active {
      color: var(--success) !important;
      border-bottom-color: var(--success) !important;
    }
    
    #reavaliacao-medica-tab.active {
      color: var(--warning) !important;
      border-bottom-color: var(--warning) !important;
    }
    
    /* ===== EFEITOS DE TRANSIÇÃO DAS ABAS ===== */
    .fade-in-active {
      animation: fadeInTab 0.3s ease-in-out !important;
    }

    /* ===== ESTILOS PARA CARDS DE FICHAS DE REFERÊNCIA ===== */
    #listaFichasReferencia .card {
      transition: all 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
    }

    #listaFichasReferencia .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    #listaFichasReferencia .card-header {
      border-bottom: 2px solid rgba(255,255,255,0.2);
      font-weight: 600;
    }

    #listaFichasReferencia .card-body h6 {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 8px;
    }

    #listaFichasReferencia .card-body .bg-light {
      background-color: #f8f9fa !important;
      transition: background-color 0.2s ease;
      padding: 12px !important;
    }

    #listaFichasReferencia .card-body .bg-light:hover {
      background-color: #e9ecef !important;
    }

    /* ===== MELHORIAS PARA IMPRESSÃO ===== */
    @media print {
      .sidebar { display: none; }
      .main-content { margin-left: 0; }
      .btn { display: none; }
      .card { box-shadow: none; border: 1px solid #ddd; }
      .nav-tabs { display: none; }
      .tab-pane { display: block !important; }
    }

    /* ===== ALERTA DE FREQUÊNCIA NO MENU ===== */
    #alertaFrequencia {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    
    #linkHistorico {
      position: relative;
    }
    
    /* ===== ESTILOS PARA TABELA DE HISTÓRICO ===== */
    #listaHistoricoAtendimentos table tbody tr:hover:not([id^="detalhes_"]) {
      background-color: rgba(40, 53, 147, 0.05);
    }
    
    #listaHistoricoAtendimentos .btn-group {
      box-shadow: var(--shadow-sm);
    }
    
    #listaHistoricoAtendimentos .btn-group .btn {
      transition: all var(--transition-fast);
    }
    
    #listaHistoricoAtendimentos .btn-group .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    #listaHistoricoAtendimentos [id^="detalhes_"] {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 500px;
      }
    }
    
    #listaHistoricoAtendimentos [id^="detalhes_"] .p-3 {
      border-left: 4px solid var(--primary-light);
      background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
    }
    
    #listaHistoricoAtendimentos .btn-ver-detalhes.active {
      background-color: var(--primary-main);
      color: white;
      border-color: var(--primary-main);
    }
    
    /* ===== BOTÕES DE OBSERVAÇÃO E INTERNAÇÃO ===== */
    #listaHistoricoAtendimentos .btn-warning {
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      border: none;
      color: white;
      font-weight: 600;
      transition: all var(--transition-fast);
    }
    
    #listaHistoricoAtendimentos .btn-warning:hover {
      background: linear-gradient(135deg, #d97706, #f59e0b);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    #listaHistoricoAtendimentos .btn-info {
      background: linear-gradient(135deg, #0ea5e9, #06b6d4);
      border: none;
      color: white;
      font-weight: 600;
      transition: all var(--transition-fast);
    }
    
    #listaHistoricoAtendimentos .btn-info:hover {
      background: linear-gradient(135deg, #0284c7, #0ea5e9);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    #listaHistoricoAtendimentos .d-flex.flex-column.gap-1 {
      min-width: 120px;
    }
  </style>
</head>
<body>
  <div class="sidebar text-white">
    <nav class="nav flex-column">
      <a class="nav-link active" href="#" data-target="triagemSection"><i class="fas fa-heartbeat"></i><span>Triagem</span></a>
      <a class="nav-link" href="#" data-target="anamneseSection"><i class="fas fa-user-md"></i><span>Anamnese</span></a>
      <a class="nav-link" href="#" data-target="prescricaoSection"><i class="fas fa-prescription-bottle-alt"></i><span>Prescrição</span></a>
      <a class="nav-link" href="#" data-target="receituarioSection"><i class="fas fa-receipt"></i><span>Receituário</span></a>
      <a class="nav-link" href="#" data-target="atestadoSection"><i class="fas fa-file-medical"></i><span>Atestado</span></a>
      <a class="nav-link" href="#" data-target="fichaReferenciaSection"><i class="fas fa-file-export"></i><span>Ficha de Referência</span></a>
      <a class="nav-link" href="#" data-target="historicoSection" id="linkHistorico">
        <i class="fas fa-history"></i>
        <i class="fas fa-exclamation-circle text-warning" id="alertaFrequencia" style="display:none; font-size:10px; position:absolute; margin-left:-8px; margin-top:-5px;" title="Paciente com mais de 3 atendimentos nos últimos 7 dias"></i>
        <span>Histórico</span>
      </a>
      <a class="nav-link" href="#" data-target="enfermagemSection"><i class="fas fa-user-nurse"></i><span>Ficha de Enfermagem</span></a>
      <hr class="mx-3 my-2" style="opacity:.2">
      <a class="nav-link" href="/imprimir/ficha_atendimento/{{ atendimento.id }}" target="_blank" aria-label="Imprimir ficha de atendimento"><i class="fas fa-print"></i><span>Imprimir Ficha</span></a>
      <a class="nav-link" href="/medico/aguardando-medico"><i class="fas fa-arrow-left"></i><span>Voltar Lista</span></a>
    </nav>
  </div>

  <div class="main-content">
    <div class="content-inner">
    <!-- Header da Página -->
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="page-title">
          <i class="fas fa-notes-medical"></i>
          Ficha de Atendimento Médico
        </h1>
        <div class="d-flex gap-3">
          <!-- Botão de Ciclo de Reavaliação (só aparece quando status = REAVALIACAO e ciclos < 3) -->
          <button class="btn btn-lg" id="btnCicloReavaliacao" style="display: none; background: linear-gradient(135deg, var(--warning), #FBBF24); border: none; color: white; font-weight: 500; box-shadow: var(--sombra-suave);">
            <i class="fas fa-redo-alt me-2"></i> 
            Novo Ciclo de Reavaliação
          </button>
          <!-- Alerta de Necessária Conduta (aparece quando completar 3 ciclos) -->
          <div class="d-flex align-items-center gap-2 px-3 py-2 mb-0" id="alertaCondutaNecessaria" style="display: none !important; background: linear-gradient(135deg, #FEF3C7, #FDE68A); border-radius: var(--radius-md); border-left: 3px solid var(--warning); box-shadow: var(--sombra-suave); max-width: 420px;">
            <div class="d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; background: rgba(245, 158, 11, 0.15); border-radius: 50%; flex-shrink: 0;">
              <i class="fas fa-exclamation-triangle" style="font-size: 0.9rem; color: var(--warning);"></i>
            </div>
            <div class="flex-grow-1">
              <div style="font-weight: 600; font-size: 0.813rem; color: #92400E; line-height: 1.3;">
                Conduta Necessária <span style="font-weight: 400; color: #78350F;">• 3 ciclos</span>
              </div>
            </div>
          </div>
          <button class="btn btn-lg" id="btnEncerrarAtendimento" style="background: linear-gradient(135deg, var(--success), #059669); border: none; color: white; font-weight: 500; box-shadow: var(--sombra-suave);">
            <i class="fas fa-clipboard-check me-2"></i> 
            Encerrar Atendimento
          </button>
          <a href="/medico/aguardando-medico" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i>
            Voltar à Lista
          </a>
        </div>
      </div>
    </div>

    <!-- Dados do Paciente - Design Profissional -->
    <div class="patient-info-card">
      <div class="row g-4">
        <div class="col-md-4">
          <div class="info-item">
            <span class="info-label">Nome Completo</span>
            <div class="info-value" id="pacienteNome">{{ paciente.nome }}</div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="info-item">
            <span class="info-label">Idade</span>
            <div class="info-value" id="pacienteIdade">-</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="info-item">
            <span class="info-label">CPF</span>
            <div class="info-value" id="pacienteCpf">{{ paciente.cpf }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="info-item">
            <span class="info-label">Telefone</span>
            <div class="info-value" id="pacienteTelefone">{{ paciente.telefone }}</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-item">
            <span class="info-label">Endereço Completo</span>
            <div class="info-value" id="pacienteEndereco">{{ paciente.endereco }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="info-item">
            <span class="info-label">Município</span>
            <div class="info-value" id="pacienteMunicipio">{{ paciente.municipio }}</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="info-item">
            <span class="info-label">Cartão SUS</span>
            <div class="info-value" id="pacienteCns">{{ paciente.cartao_sus }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Triagem -->
    <div id="triagemSection" class="section active">
      <div class="card triagem-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-heartbeat"></i>
            <h5 class="mb-0">Dados da Triagem</h5>
          </div>
          <span id="badgeRisco" class="risk-badge bg-secondary">-</span>
        </div>
        <div class="card-body">
          <!-- Sinais Vitais em Grid -->
          <div class="vital-signs">
            <div class="vital-sign-item">
              <span class="vital-sign-label">Pressão Arterial</span>
              <div class="vital-sign-value" id="pa">-</div>
          </div>
            <div class="vital-sign-item">
              <span class="vital-sign-label">Pulso</span>
              <div class="vital-sign-value" id="pulso">-</div>
            </div>
            <div class="vital-sign-item">
              <span class="vital-sign-label">SpO₂</span>
              <div class="vital-sign-value" id="sp02">-</div>
            </div>
            <div class="vital-sign-item">
              <span class="vital-sign-label">Temperatura</span>
              <div class="vital-sign-value" id="temp">-</div>
            </div>
            <div class="vital-sign-item">
              <span class="vital-sign-label">Freq. Respiratória</span>
              <div class="vital-sign-value" id="fr">-</div>
            </div>
            <div class="vital-sign-item">
              <span class="vital-sign-label">Peso</span>
              <div class="vital-sign-value" id="peso">-</div>
            </div>
            <div class="vital-sign-item">
              <span class="vital-sign-label">DX</span>
              <div class="vital-sign-value" id="dx">-</div>
            </div>
            <div class="vital-sign-item">
              <span class="vital-sign-label">Classificação</span>
              <div class="vital-sign-value" id="classificacao">-</div>
            </div>
          </div>

          <!-- Alergias -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                  <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Alergias Conhecidas</h6>
                </div>
                <div class="card-body">
            <div id="alergias" class="fw-bold">-</div>
          </div>
              </div>
            </div>
          </div>

          <!-- Texto da Triagem -->
          <div class="row">
            <div class="col-12">
              <div class="card border-info">
                <div class="card-header bg-info text-white">
                  <h6 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Avaliação da Triagem</h6>
                </div>
                <div class="card-body">
            <div id="triagemTexto" class="texto-bloco">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Anamnese -->
    <div id="anamneseSection" class="section">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-user-md"></i>
            <h5 class="mb-0">Avaliação Médica</h5>
          </div>
          <button class="btn btn-light btn-sm" id="btnEditarAnamneseGeral">
            <i class="fas fa-edit me-2"></i> Editar Tudo
          </button>
        </div>
        <div class="card-body p-0">
          <!-- Navegação por abas -->
          <ul class="nav nav-tabs nav-justified" id="anamneseTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="exame-fisico-tab" data-bs-toggle="tab" data-bs-target="#exame-fisico-pane" type="button" role="tab">
                <i class="fas fa-stethoscope me-2"></i>Exame Físico
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="reavaliacao-medica-tab" data-bs-toggle="tab" data-bs-target="#reavaliacao-medica-pane" type="button" role="tab">
                <i class="fas fa-redo me-2"></i>Reavaliação Médica
              </button>
            </li>
          </ul>

          <div class="tab-content" id="anamneseTabContent">
            <!-- Aba: Exame Físico -->
            <div class="tab-pane fade show active p-4" id="exame-fisico-pane" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary fw-bold mb-0">
                  <i class="fas fa-user-check me-2"></i>Anamnese e Exame Físico
                </h6>
                <button class="btn btn-outline-primary btn-sm" id="btnEditarExameFisico">
                  <i class="fas fa-edit me-1"></i> Editar
                </button>
              </div>
              <div class="card border-primary">
                <div class="card-body">
                  <div class="texto-bloco" id="anamneseExame">-</div>
                </div>
              </div>
            </div>

            

            <!-- Aba: Reavaliação Médica -->
            <div class="tab-pane fade p-4" id="reavaliacao-medica-pane" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-warning fw-bold mb-0">
                  <i class="fas fa-redo me-2"></i>Reavaliação Médica
                </h6>
                <button class="btn btn-outline-warning btn-sm" id="btnEditarReavaliacao">
                  <i class="fas fa-edit me-1"></i> Editar
                </button>
              </div>
              <div class="card border-warning">
                <div class="card-body">
                  <div class="texto-bloco" id="reavaliacaoTexto">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Prescrição -->
    <div id="prescricaoSection" class="section">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-pills"></i>
          <h5 class="mb-0">Prescrições Médicas</h5>
          </div>
          <button class="btn btn-light btn-sm" id="btnNovaPrescricao">
            <i class="fas fa-plus me-2"></i> Nova Prescrição
          </button>
        </div>
        <div class="card-body">
          <div id="listaPrescricoes" class="loading-state">
            <i class="fas fa-spinner fa-spin"></i> 
            <span>Carregando prescrições médicas...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Receituário -->
    <div id="receituarioSection" class="section">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-prescription"></i>
            <h5 class="mb-0">Receituário Médico</h5>
          </div>
          <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalNovaReceita">
            <i class="fas fa-plus me-2"></i> Nova Receita
          </button>
        </div>
        <div class="card-body">
          <!-- Receitas de Hoje -->
          <div class="mb-4" id="hoje-container-receituario">
            <div class="d-flex align-items-center gap-2 mb-3">
              <i class="fas fa-calendar-day text-success"></i>
              <h6 class="fw-bold text-success mb-0" id="titulo-receitas-hoje">Receitas de Hoje</h6>
        </div>
            <div id="listaReceitasDoDia" class="loading-state">
              <i class="fas fa-spinner fa-spin"></i>
              <span>Carregando receitas de hoje...</span>
      </div>
    </div>

          <!-- Receitas Anteriores -->
          <div class="mb-0" id="antigas-container-receituario">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-2">
                <i class="fas fa-history text-secondary"></i>
                <h6 class="fw-bold text-secondary mb-0">Receitas Anteriores</h6>
              </div>
              <span class="badge bg-secondary" id="contador-receitas-antigas">0</span>
            </div>
            <div id="listaReceitasAntigas">
              <!-- Preenchido via JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Atestado -->
    <div id="atestadoSection" class="section">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-file-medical"></i>
            <h5 class="mb-0">Atestados Médicos</h5>
          </div>
          <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalNovoAtestado">
            <i class="fas fa-plus me-2"></i> Novo Atestado
          </button>
        </div>
        <div class="card-body">
          <!-- Atestados de Hoje -->
          <div class="mb-4" id="hoje-container-atestado">
            <div class="d-flex align-items-center gap-2 mb-3">
              <i class="fas fa-calendar-day text-success"></i>
              <h6 class="fw-bold text-success mb-0" id="titulo-atestados-hoje">Atestados de Hoje</h6>
        </div>
            <div id="listaAtestadosDoDia" class="loading-state">
              <i class="fas fa-spinner fa-spin"></i>
              <span>Carregando atestados de hoje...</span>
      </div>
    </div>

          <!-- Atestados Anteriores -->
          <div class="mb-0" id="antigas-container-atestado">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-2">
                <i class="fas fa-history text-secondary"></i>
                <h6 class="fw-bold text-secondary mb-0">Atestados Anteriores</h6>
              </div>
              <span class="badge bg-secondary" id="contador-atestados-antigos">0</span>
            </div>
            <div id="listaAtestadosAntigos">
              <!-- Preenchido via JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Ficha de Referência -->
    <div id="fichaReferenciaSection" class="section">
      <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-file-export"></i>
            <h5 class="mb-0">Fichas de Referência</h5>
          </div>
          <button class="btn btn-light btn-sm" id="btn_nova_ficha_referencia" data-bs-toggle="modal" data-bs-target="#modalNovaFichaReferencia">
            <i class="fas fa-plus-circle me-1"></i>Nova Ficha
          </button>
        </div>
        <div class="card-body">
          <div id="listaFichasReferencia">
            <div class="text-center py-4">
              <i class="fas fa-spinner fa-spin text-primary fa-2x"></i>
              <p class="mt-3 text-muted">Carregando fichas de referência...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Histórico de Atendimentos -->
    <div id="historicoSection" class="section">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-history"></i>
            <h5 class="mb-0">Histórico de Atendimentos</h5>
          </div>
          <span class="badge bg-info" id="totalAtendimentos">0 atendimentos</span>
        </div>
        <div class="card-body">
          <div id="alertaFrequenciaDetalhado" class="alert alert-warning border-0" style="display:none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Atenção:</strong> Este paciente teve <strong id="qtdAtendimentosRecentes">0</strong> atendimentos nos últimos 7 dias.
          </div>
          
          <div id="listaHistoricoAtendimentos" class="loading-state">
            <i class="fas fa-spinner fa-spin"></i> 
            <span>Carregando histórico de atendimentos...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção: Ficha de Enfermagem -->
    <div id="enfermagemSection" class="section">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-user-nurse"></i>
            <h5 class="mb-0">Ficha de Enfermagem</h5>
          </div>
          <span class="badge bg-info">Visualização</span>
        </div>
        <div class="card-body">
          <div class="alert alert-info border-0">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Em Desenvolvimento:</strong> A visualização integrada da ficha de enfermagem será implementada em breve.
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" id="ATENDIMENTO_ID" value="{{ atendimento.id }}">
    <input type="hidden" id="atendimento_id" value="{{ atendimento.id }}">
    <input type="hidden" id="user_id" value="{{ session.get('user_id', 0) }}">
    </div>
  </div>

  <!-- Modal Nova Receita -->
  <div class="modal fade" id="modalNovaReceita" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Nova Receita</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formReceita">
            <div class="mb-3">
              <label class="form-label">Tipo de Receita</label>
              <select class="form-select" id="tipo_receita" required>
                <option value="">Selecione o tipo de receita</option>
                <option value="normal">Receita Normal</option>
                <option value="especial">Receita Especial</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Conteúdo da Receita</label>
              <div id="editor-receita-container">
                <!-- Editor Quill será inicializado aqui -->
              </div>
              <textarea id="conteudo_receita" name="conteudo_receita" style="display:none"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btn_salvar_receita">Salvar Receita</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Novo Atestado -->
  <div class="modal fade" id="modalNovoAtestado" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Novo Atestado</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formAtestado">
            <div class="mb-3">
              <label class="form-label">Dias de Afastamento</label>
              <input type="number" class="form-control" id="dias_afastamento" min="1" placeholder="Número de dias">
            </div>

            <div class="mb-3">
              <label class="form-label">Conteúdo do Atestado</label>
              <div id="editor-atestado-container">
                <!-- Editor Quill será inicializado aqui -->
              </div>
              <textarea id="conteudo_atestado" name="conteudo_atestado" style="display:none"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btn_salvar_atestado">Salvar Atestado</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function idade(data) {
      if (!data) return '-';
      const d = new Date(data); const h = new Date();
      let i = h.getFullYear()-d.getFullYear(); const m=h.getMonth()-d.getMonth();
      if (m<0 || (m===0 && h.getDate()<d.getDate())) i--; return i + ' anos';
    }
    function badgeRisco(r) {
      if (!r) return '<span class="badge bg-secondary">-</span>';
      const t=r.toLowerCase();
      if (t.includes('vermelho')) return '<span class="badge bg-danger">Vermelho</span>';
      if (t.includes('laranja')) return '<span class="badge bg-warning text-dark">Laranja</span>';
      if (t.includes('amarelo')) return '<span class="badge bg-warning text-dark">Amarelo</span>';
      if (t.includes('verde')) return '<span class="badge bg-success">Verde</span>';
      if (t.includes('azul')) return '<span class="badge bg-primary">Azul</span>';
      return '<span class="badge bg-info">'+r+'</span>';
    }

    $(function(){
      // Navegação lateral simples
      $('.sidebar .nav-link').on('click', function(e){
        const target = $(this).data('target');
        if (!target) return; e.preventDefault();
        $('.sidebar .nav-link').removeClass('active');
        $(this).addClass('active');
        $('.section').removeClass('active');
        $('#'+target).addClass('active');
      });

      const id = document.getElementById('ATENDIMENTO_ID').value;
      fetch(`/api/atendimento/${id}`)
        .then(r => r.json())
        .then(d => {
          if (!d.success) return;
          const a = d.data.atendimento, p = d.data.paciente;
          $('#pacienteNome').text(p.nome||'-');
          $('#pacienteCpf').text(p.cpf||'-');
          $('#pacienteTelefone').text(p.telefone||'-');
          $('#pacienteEndereco').text(p.endereco||'-');
          $('#pacienteMunicipio').text(p.municipio||'-');
          $('#pacienteCns').text(p.cartao_sus||'-');
          $('#pacienteIdade').text(p.data_nascimento ? idade(p.data_nascimento) : (p.idade!=null? (p.idade+' anos'):'-'));

          $('#pa').text(a.pressao||'-');
          $('#pulso').text(a.pulso||'-');
          $('#sp02').text(a.sp02||'-');
          $('#temp').text(a.temp||'-');
          $('#fr').text(a.fr||'-');
          // Formatar peso com unidade
          if (a.peso && a.peso !== '-') {
            const pesoFormatado = a.peso.toString().includes('kg') ? a.peso : a.peso + ' kg';
            $('#peso').text(pesoFormatado);
          } else {
            $('#peso').text('-');
          }
          $('#dx').text(a.dx||'-');
          $('#classificacao').text(a.classificacao_risco||'-');
          $('#badgeRisco').html(badgeRisco(a.classificacao_risco));
          $('#alergias').text(a.alergias||'-');
          $('#triagemTexto').text(a.triagem||'-');
          $('#anamneseExame').html(a.anamnese_exame_fisico ? a.anamnese_exame_fisico.replace(/\n/g,'<br>') : '-');
          
          $('#reavaliacaoTexto').html(a.reavaliacao ? a.reavaliacao.replace(/\n/g,'<br>') : '-');
          // badge de status removido da Anamnese; status geral segue exibido em outros contextos
          
          // Verificar ciclos de reavaliação e mostrar botão ou alerta
          if (a.status && a.status.toUpperCase().includes('REAVALIACAO')) {
            // Contar ciclos atuais
            let ciclosAtuais = 0;
            if (a.medicacao_utilizada) {
              try {
                const medicacoes = JSON.parse(a.medicacao_utilizada);
                if (Array.isArray(medicacoes)) {
                  ciclosAtuais = medicacoes.length;
                }
              } catch (e) {
                // Se não for JSON válido, contar "1"s
                ciclosAtuais = (a.medicacao_utilizada.match(/1/g) || []).length;
              }
            }
            
            // Se completou 3 ou mais ciclos, mostrar alerta
            if (ciclosAtuais >= 3) {
              $('#alertaCondutaNecessaria').css('display', 'flex');
              $('#btnCicloReavaliacao').hide();
            } else {
              // Menos de 3 ciclos, mostrar botão
              $('#btnCicloReavaliacao').show();
              $('#alertaCondutaNecessaria').hide();
            }
          }
        })
        .catch(()=>{});
      
      // Handler do botão de ciclo de reavaliação
      $('#btnCicloReavaliacao').on('click', function() {
        const btn = $(this);
        const textoOriginal = btn.html();
        
        if (!confirm('Deseja registrar o início de um novo ciclo de reavaliação para este paciente?\n\nIsso marcará que uma nova medicação foi administrada e iniciará um novo período de 2 horas para reavaliação.')) {
          return;
        }
        
        // Desabilitar botão e mostrar loading
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>Registrando Ciclo...');
        
        // Fazer chamada API
        $.ajax({
          url: '/api/atendimento/' + id + '/registrar-ciclo-reavaliacao',
          method: 'POST',
          contentType: 'application/json',
          success: function(response) {
            if (response.success) {
              btn.removeClass('btn-warning').addClass('btn-success');
              btn.html('<i class="fas fa-check me-2"></i>Ciclo ' + response.ciclo_atual + ' Registrado!');
              
              setTimeout(function() {
                let msg = '✅ Ciclo ' + response.ciclo_atual + ' de reavaliação registrado com sucesso!\n\n' +
                          'O paciente permanecerá em reavaliação.\n' +
                          'Novo prazo: 2 horas a partir de agora.';
                
                if (response.precisa_observacao) {
                  msg += '\n\n⚠️ ATENÇÃO: Este paciente completou ' + response.ciclo_atual + ' ciclos.\n' +
                         'É RECOMENDADO ABRIR UMA OBSERVAÇÃO!';
                }
                
                alert(msg);
                location.reload();
              }, 1500);
            } else {
              alert('Erro ao registrar ciclo: ' + (response.message || 'Erro desconhecido'));
              btn.html(textoOriginal);
              btn.prop('disabled', false);
            }
          },
          error: function(xhr) {
            let msg = 'Erro ao registrar ciclo de reavaliação.';
            try {
              const resp = JSON.parse(xhr.responseText);
              msg = resp.message || msg;
            } catch (e) {}
            alert(msg);
            btn.html(textoOriginal);
            btn.prop('disabled', false);
          }
        });
      });
    });
  </script>

  <!-- Modal Edição Anamnese/Conduta -->
  <div class="modal fade" id="modalEditarAnamneseConduta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-notes-medical me-2"></i>Editar Anamnese e Conduta</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Anamnese e Exame Físico</label>
            <textarea id="campoAnamnese" class="form-control" rows="6" placeholder="Descreva a anamnese e exame físico..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Reavaliação</label>
            <textarea id="campoReavaliacao" class="form-control" rows="4" placeholder="Descreva a reavaliação..."></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Conduta</label>
            <textarea id="campoConduta" class="form-control" rows="5" placeholder="Descreva a conduta médica..."></textarea>
          </div>
          <small class="text-muted">As alterações serão salvas no atendimento atual.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnSalvarAnamneseConduta"><i class="fas fa-save me-1"></i>Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Handlers de edição
    $(function(){
      const modalEl = document.getElementById('modalEditarAnamneseConduta');
      const bsModal = modalEl ? new bootstrap.Modal(modalEl) : null;
      const atendimentoId = document.getElementById('ATENDIMENTO_ID').value;

      // Event handlers: abrir modal focado apenas no campo da aba clicada
      function abrirModalEdicao(tipo){
        // Limpar todos os campos e esconder os desnecessários via CSS inline
        const blocoAna = $('#campoAnamnese').closest('.mb-3');
        const blocoRea = $('#campoReavaliacao').closest('.mb-3');
        const blocoCon = $('#campoConduta').closest('.mb-2');
        blocoAna.hide(); blocoRea.hide(); blocoCon.hide();

        if (tipo === 'exame'){
          $('#campoAnamnese').val($('#anamneseExame').text() === '-' ? '' : $('#anamneseExame').text());
          blocoAna.show();
        } else if (tipo === 'reavaliacao'){
          $('#campoReavaliacao').val($('#reavaliacaoTexto').text() === '-' ? '' : $('#reavaliacaoTexto').text());
          blocoRea.show();
        } else if (tipo === 'conduta'){
          // Conduta final é definida no fluxo "Encerrar Atendimento"
          try {
            const enc = new bootstrap.Modal(document.getElementById('modalEncerrarAtendimento'));
            enc.show();
          } catch(e) {}
          return; // Não abrir o modal de anamnese neste caso
        } else if (tipo === 'todos'){
          blocoAna.show(); blocoRea.show();
          $('#campoAnamnese').val($('#anamneseExame').text() === '-' ? '' : $('#anamneseExame').text());
          $('#campoReavaliacao').val($('#reavaliacaoTexto').text() === '-' ? '' : $('#reavaliacaoTexto').text());
        }
        $('#modalEditarAnamneseConduta').data('tipo-edicao', tipo);
        if (bsModal) bsModal.show();
      }

      $('#btnEditarExameFisico').on('click', function(){ abrirModalEdicao('exame'); });
      $('#btnEditarReavaliacao').on('click', function(){ abrirModalEdicao('reavaliacao'); });
      $('#btnEditarAnamneseGeral').on('click', function(){ abrirModalEdicao('todos'); });

      $('#btnSalvarAnamneseConduta').on('click', function(){
        const tipo = $('#modalEditarAnamneseConduta').data('tipo-edicao');
        const payload = {};
        if (tipo === 'exame') {
          payload.anamnese_exame_fisico = $('#campoAnamnese').val().trim() || null;
        } else if (tipo === 'reavaliacao') {
          payload.reavaliacao = $('#campoReavaliacao').val().trim() || null;
        } else {
          payload.anamnese_exame_fisico = $('#campoAnamnese').val().trim() || null;
          payload.reavaliacao = $('#campoReavaliacao').val().trim() || null;
        }
        const btn = $(this); const original = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Salvando...');
        fetch(`/api/atendimento/${atendimentoId}/anamnese-conduta`, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            if ('anamnese_exame_fisico' in payload) {
              $('#anamneseExame').html((payload.anamnese_exame_fisico||'-').replace(/\n/g,'<br>'));
            }
            if ('reavaliacao' in payload) {
              $('#reavaliacaoTexto').html((payload.reavaliacao||'-').replace(/\n/g,'<br>'));
            }
            if (bsModal) bsModal.hide();
          } else {
            alert('Erro: ' + (data.message||'Falha ao salvar'));
          }
        })
        .catch(err => alert('Erro ao salvar: ' + err))
        .finally(() => btn.prop('disabled', false).html(original));
      });
    });
  </script>

  <!-- Modal Encerrar Atendimento -->
  <div class="modal fade" id="modalEncerrarAtendimento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Encerrar Atendimento</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Conduta Final</label>
              <select id="encerrarCondutaFinal" class="form-select">
                <option value="">Selecione...</option>
                <option>ALTA</option>
                <option>ALTA APOS MEDICACAO</option>
                <option>REAVALIACAO</option>
                <option>OBSERVACAO</option>
                <option>EVASAO POR CONTA PROPRIA</option>
                <option>INTERNAMENTO</option>
                <option>ENCAMINHAR PARA CIRURGIA</option>
                <option>TRANSFERENCIA</option>
                <option>RECUSA TRANSFERENCIA APOS CONDUTA MEDICA</option>
                <option>ASSINOU TERMO DE RESPONSABILIDADE</option>
              </select>
          </div>

          <div id="blocoObservacao" style="display:none;">
            <div class="alert alert-info">Preencha os dados para iniciar a observação.</div>
            <div class="mb-2">
              <label class="form-label">HDA</label>
              <textarea id="obsHda" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Exame Físico</label>
              <textarea id="obsExameFisico" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Diagnóstico Inicial</label>
              <textarea id="obsDiagnosticoInicial" class="form-control" rows="2"></textarea>
            </div>
            <div class="row g-2">
              <div class="col">
                <label class="form-label">CID Principal</label>
                <input id="obsCidPrincipal" class="form-control" />
              </div>
              <div class="col">
                <label class="form-label">CID Secundário</label>
                <input id="obsCidSecundario" class="form-control" />
              </div>
            </div>
          </div>

          <div id="blocoInternamento" style="display:none;" class="mt-2">
            <div class="alert alert-warning">Preencha os dados para iniciar o internamento.</div>
            <div class="mb-2">
              <label class="form-label">Leito (disponível)</label>
              <select id="intLeito" class="form-select">
                <option value="">Carregando leitos...</option>
              </select>
              <small class="text-muted">Mostrando apenas leitos com status "Disponível"</small>
            </div>
            <div class="mb-2">
              <label class="form-label">Caráter da Internação</label>
              <select id="intCarater" class="form-select">
                <option value="">Selecione…</option>
                <option>Urgência</option>
                <option>Eletiva</option>
                <option>Outros</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">HDA</label>
              <textarea id="intHda" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Diagnóstico Inicial</label>
              <textarea id="intDiagnosticoInicial" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Anamnese e Exame Físico</label>
              <textarea id="intAnamnese" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Conduta Inicial</label>
              <textarea id="intConduta" class="form-control" rows="3"></textarea>
            </div>
            <div class="row g-2">
              <div class="col">
                <label class="form-label">CID Principal</label>
                <input id="intCidPrincipal" class="form-control" />
              </div>
              <div class="col">
                <label class="form-label">CID Secundário</label>
                <input id="intCidSecundario" class="form-control" />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarEncerramento">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Pós-Encerramento (Imprimir Ficha) -->
  <div class="modal fade" id="modalPosEncerramento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i> Atendimento encerrado</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body text-center">
          <p class="mb-3">Atendimento encerrado com sucesso.</p>
          <p class="text-muted">Deseja imprimir a Ficha de Atendimento agora?</p>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <a id="btnImprimirFicha" class="btn btn-primary" target="_blank" href="#">Imprimir Ficha</a>
          <a class="btn btn-outline-secondary" href="/medico/aguardando-medico">Voltar à lista</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(function(){
      const ATENDIMENTO_ID = document.getElementById('ATENDIMENTO_ID').value;
      const modalEnc = new bootstrap.Modal(document.getElementById('modalEncerrarAtendimento'));
      const modalPos = new bootstrap.Modal(document.getElementById('modalPosEncerramento'));

      // Registrar explicitamente início da consulta para contagem no dashboard
      try {
        fetch(`/api/atendimento/${ATENDIMENTO_ID}/assumir`, { method: 'POST' });
      } catch(e) {}

      $('#btnEncerrarAtendimento').on('click', function(){
        $('#encerrarCondutaFinal').val('');
        $('#blocoObservacao, #blocoInternamento').hide();
        modalEnc.show();
      });

      $('#encerrarCondutaFinal').on('change', function(){
        const v = ($(this).val()||'').toUpperCase();
        $('#blocoObservacao').toggle(v === 'OBSERVACAO');
        $('#blocoInternamento').toggle(v === 'INTERNAMENTO');
        if (v === 'INTERNAMENTO'){
          // Carregar leitos disponíveis
          const sel = $('#intLeito');
          sel.html('<option value="">Carregando leitos...</option>');
          fetch('/api/leitos/opcoes')
            .then(r=>r.json())
            .then(lista=>{
              sel.empty();
              let disponiveis = 0;
              lista.forEach(l => {
                if ((l.status||'').toLowerCase().includes('dispon')){
                  sel.append(`<option value="${l.nome}">${l.nome} (${l.status})</option>`);
                  disponiveis++;
                }
              });
              if (disponiveis === 0){ sel.append('<option value="">Sem leitos disponíveis</option>'); }
            })
            .catch(()=>{ sel.html('<option value="">Erro ao carregar leitos</option>'); });
        }
      });

      $('#btnConfirmarEncerramento').on('click', function(){
        const conduta = $('#encerrarCondutaFinal').val();
        if (!conduta){ alert('Selecione a conduta final.'); return; }

        const v = conduta.toUpperCase();
        if (v === 'OBSERVACAO'){
          // Criar observação via endpoint existente
          const payload = {
            hda: $('#obsHda').val()||'',
            exame_fisico: $('#obsExameFisico').val()||'',
            diagnostico_inicial: $('#obsDiagnosticoInicial').val()||'',
            cid_principal: $('#obsCidPrincipal').val()||'',
            cid_secundario: $('#obsCidSecundario').val()||'',
            atendimento_id: ATENDIMENTO_ID
          };
          fetch('/api/observacao-paciente', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(r=>r.json())
            .then(d=>{
              if (d.success){
                modalEnc.hide();
                window.location.href = `/observacao/evolucao-paciente-medico/${ATENDIMENTO_ID}`;
              } else { alert('Erro: ' + (d.message||'Falha ao criar observação')); }
            })
            .catch(err=>alert('Erro: '+err));
          return;
        }

        if (v === 'INTERNAMENTO'){
          const payload = {
            atendimento_id: ATENDIMENTO_ID,
            leito: $('#intLeito').val()||'',
            carater_internacao: $('#intCarater').val()||'',
            hda: $('#intHda').val()||'',
            diagnostico_inicial: $('#intDiagnosticoInicial').val()||'',
            folha_anamnese: $('#intAnamnese').val()||'',
            conduta_inicial: $('#intConduta').val()||'',
            cid_principal: $('#intCidPrincipal').val()||'',
            cid_10_secundario: $('#intCidSecundario').val()||''
          };
          fetch('/api/internar-paciente', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(r=>r.json())
            .then(d=>{
              if (d.success){
                modalEnc.hide();
                window.location.href = '/clinica/pacientes-internados';
              } else { alert('Erro: ' + (d.message||'Falha ao internar')); }
            })
            .catch(err=>alert('Erro: '+err));
          return;
        }

        // ALTAS/EVASÃO/RECUSAS/TERMO/CIRURGIA -> encerrar direto
        const payloadEncerramento = {
          conduta_final: conduta
        };

        // Se for EVASÃO, atualizar status para "Evasão"
        if (v === 'EVASAO POR CONTA PROPRIA') {
          payloadEncerramento.status = 'Evasão';
          console.log('🚨 Evasão detectada - atualizando status para "Evasão"');
        }

        // Se for ENCAMINHAR PARA CIRURGIA, atualizar status para "aguardando cirurgia"
        if (v === 'ENCAMINHAR PARA CIRURGIA') {
          payloadEncerramento.status = 'aguardando cirurgia';
          console.log('🏥 Encaminhamento para cirurgia - atualizando status para "aguardando cirurgia"');
        }
        
        console.log('📤 Enviando encerramento com payload:', payloadEncerramento);
        
        fetch(`/api/atendimento/${ATENDIMENTO_ID}/encerrar`, { 
          method: 'PUT', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(payloadEncerramento) 
        })
          .then(r=>r.json())
          .then(d=>{
            if (d.success){
              console.log('✅ Atendimento encerrado com sucesso');
              
              if (v === 'EVASAO POR CONTA PROPRIA') {
                console.log('✅ Status atualizado para "Evasão"');
              }
              
              modalEnc.hide();
              // Se for reavaliação ou cirurgia, mantemos a ficha aberta e apenas informamos sucesso
              if ((conduta||'').toUpperCase().indexOf('REAVALIA') >= 0){
                alert('Conduta registrada: reavaliação. O atendimento permanece em aberto.');
              } else if ((conduta||'').toUpperCase().indexOf('CIRURGIA') >= 0){
                alert('Paciente encaminhado para cirurgia. O atendimento permanece em aberto.');
              } else {
                $('#btnImprimirFicha').attr('href', `/imprimir/ficha_atendimento/${ATENDIMENTO_ID}`);
                modalPos.show();
              }
            } else { 
              console.error('❌ Erro ao encerrar:', d.message);
              alert('Erro: ' + (d.message||'Falha ao encerrar')); 
            }
          })
          .catch(err=>{
            console.error('❌ Erro na requisição de encerramento:', err);
            alert('Erro: '+err);
          });
      });
    });
  </script>

  <!-- Modal Nova Prescrição -->
  <div class="modal fade" id="modalNovaPrescricao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Nova Prescrição Médica</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formPrescricao">
            <div class="mb-3">
              <label class="form-label">Dieta</label>
              <textarea class="form-control" id="texto_dieta" rows="2" placeholder="Descreva a dieta..."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Medicamentos</label>
              <div class="card mb-2">
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                      <label class="form-label">Nome do medicamento</label>
                      <input type="text" class="form-control" id="nome_medicamento_simples" placeholder="Ex.: Dipirona 500 mg">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Descrição de uso / Posologia</label>
                      <input type="text" class="form-control" id="descricao_posologia" placeholder="Ex.: 1 comp de 8/8h por 3 dias">
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-success w-100" id="btn_adicionar_medicamento_simples">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm" id="tabela_medicamentos">
                  <thead>
                    <tr>
                      <th>Medicamento</th>
                      <th>Descrição/Posologia</th>
                      <th style="width:70px">Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr id="sem_medicamentos"><td colspan="3" class="text-center text-muted">Nenhum medicamento adicionado</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Procedimentos Médicos</label>
              <textarea class="form-control" id="texto_procedimento_medico" rows="3" placeholder="Descreva os procedimentos médicos..."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Procedimentos Multiprofissionais</label>
              <textarea class="form-control" id="texto_procedimento_multi" rows="3" placeholder="Descreva os procedimentos multiprofissionais..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btn_salvar_prescricao">Salvar Prescrição</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Prescrição - agora por atendimento (emergência), sem exigir internação
    $(function(){
      /* internacaoId removido: prescrições por atendimento */
      const ATENDIMENTO_ID = document.getElementById('ATENDIMENTO_ID').value;
      window.medicamentosAdicionados = [];

      function atualizarTabelaMedicamentos(){
        const corpo = $('#tabela_medicamentos tbody');
        corpo.empty();
        if (!window.medicamentosAdicionados.length){
          corpo.append('<tr id="sem_medicamentos"><td colspan="3" class="text-center text-muted">Nenhum medicamento adicionado</td></tr>');
          return;
        }
        window.medicamentosAdicionados.forEach((m, idx) => {
          const linha = $(`
            <tr>
              <td>${m.nome_medicamento}</td>
              <td>${m.descricao_uso || '-'}</td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" data-idx="${idx}"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `);
          linha.find('button').on('click', function(){
            const i = parseInt($(this).data('idx'));
            window.medicamentosAdicionados.splice(i,1);
            atualizarTabelaMedicamentos();
          });
          corpo.append(linha);
        });
      }

      // Função para carregar medicamentos disponíveis
      function carregarMedicamentosDisponiveis(){
        $('#medicamento_selecionado').html('<option value="">Carregando...</option>');

        fetch('/api/medicamentos/disponiveis')
          .then(r => r.json())
          .then(data => {
            if (data.success && data.medicamentos){
              let options = '<option value="">Selecione um medicamento</option>';
              data.medicamentos.forEach(med => {
                options += `<option value="${med.id}" data-nome="${med.nome}" data-apresentacao="${med.apresentacao}" data-estoque="${med.quantidade_total}" data-unidade="${med.unidade}">${med.nome} (${med.apresentacao}) - ${med.quantidade_total} ${med.unidade}</option>`;
              });
              $('#medicamento_selecionado').html(options);
            } else {
              $('#medicamento_selecionado').html('<option value="">Erro ao carregar medicamentos</option>');
            }
          })
          .catch(() => {
            $('#medicamento_selecionado').html('<option value="">Erro ao carregar medicamentos</option>');
          });
      }

      // Função para buscar medicamentos
      function buscarMedicamentos(termo){
        if (!termo.trim()){
          carregarMedicamentosDisponiveis();
          return;
        }

        $('#medicamento_selecionado').html('<option value="">Buscando...</option>');

        fetch('/api/medicamentos/buscar?q=' + encodeURIComponent(termo))
          .then(r => r.json())
          .then(data => {
            if (data.success && data.medicamentos){
              let options = '<option value="">Selecione um medicamento</option>';
              data.medicamentos.forEach(med => {
                options += `<option value="${med.id}" data-nome="${med.nome}" data-apresentacao="${med.apresentacao}" data-estoque="${med.quantidade_total}" data-unidade="${med.unidade}">${med.nome} (${med.apresentacao}) - ${med.quantidade_total} ${med.unidade}</option>`;
              });
              $('#medicamento_selecionado').html(options);
            } else {
              $('#medicamento_selecionado').html('<option value="">Nenhum medicamento encontrado</option>');
            }
          })
          .catch(() => {
            $('#medicamento_selecionado').html('<option value="">Erro na busca</option>');
          });
      }

      function renderizarPrescricoes(lista){
        const cont = $('#listaPrescricoes');
        if (!lista || !lista.length){
          cont.html('<div class="text-center text-muted py-3">Nenhuma prescrição encontrada.</div>');
          return;
        }
        
        let html = `
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover">
              <thead class="table-primary">
                <tr>
                  <th style="width: 15%;">Data/Hora</th>
                  <th style="width: 20%;">Dieta</th>
                  <th style="width: 30%;">Medicamentos</th>
                  <th style="width: 17%;">Proc. Médicos</th>
                  <th style="width: 18%;">Proc. Multi</th>
                </tr>
              </thead>
              <tbody>`;
        
        lista.forEach(p => {
          const dataTxt = p.horario_prescricao ? new Date(p.horario_prescricao).toLocaleString('pt-BR', {
            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
          }) : '-';
          const temMeds = Array.isArray(p.medicamentos) && p.medicamentos.length > 0;
          const medsTxt = temMeds ? p.medicamentos.map(m => `• ${m.nome_medicamento}${m.descricao_uso ? ' - ' + m.descricao_uso : ''}`).join('<br>') : '-';
          
          html += `
            <tr>
              <td><small class="text-muted">${dataTxt}</small></td>
              <td>${p.texto_dieta || '-'}</td>
              <td><small>${medsTxt}</small></td>
              <td>${p.texto_procedimento_medico || '-'}</td>
              <td>${p.texto_procedimento_multi || '-'}</td>
            </tr>`;
        });
        
        html += `
              </tbody>
            </table>
          </div>`;
        
        cont.html(html);
      }

      function carregarPrescricoes(){
        $('#listaPrescricoes').html('<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Carregando prescrições...</div>');
        fetch(`/api/prescricoes-emergencia/${ATENDIMENTO_ID}`)
          .then(r => r.json())
          .then(d => {
            const lista = d.prescricoes || d.data || d || [];
            renderizarPrescricoes(Array.isArray(lista) ? lista : []);
          })
          .catch(() => {
            $('#listaPrescricoes').html('<div class="text-center text-danger">Erro ao carregar prescrições</div>');
          });
      }
      carregarPrescricoes();

      // Abrir modal Nova Prescrição
      const modalNP = new bootstrap.Modal(document.getElementById('modalNovaPrescricao'));
      $('#btnNovaPrescricao').on('click', function(){
        window.medicamentosAdicionados = [];
        $('#formPrescricao')[0].reset();
        $('#nome_medicamento_simples').val('');
        $('#descricao_posologia').val('');
        atualizarTabelaMedicamentos();
        modalNP.show();
      });

      // Adicionar medicamento simples (nome + posologia)
      $('#btn_adicionar_medicamento_simples').on('click', function(e){
        e.preventDefault();
        const nome = ($('#nome_medicamento_simples').val()||'').trim();
        const desc = ($('#descricao_posologia').val()||'').trim();
        if (!nome){
          alert('Informe o nome do medicamento.');
          return;
        }
        window.medicamentosAdicionados.push({
          nome_medicamento: nome,
          descricao_uso: desc
        });
        $('#nome_medicamento_simples').val('');
        $('#descricao_posologia').val('');
        atualizarTabelaMedicamentos();
      });

      // Salvar prescrição
      $('#btn_salvar_prescricao').on('click', function(){
        const dados = {
          atendimento_id: ATENDIMENTO_ID,
          texto_dieta: $('#texto_dieta').val().trim() || null,
          texto_procedimento_medico: $('#texto_procedimento_medico').val().trim() || null,
          texto_procedimento_multi: $('#texto_procedimento_multi').val().trim() || null,
          medicamentos: window.medicamentosAdicionados
        };
        const btn = $(this); const original = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');
        fetch('/api/prescricoes-emergencia', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dados) })
          .then(r => r.json())
          .then(resp => {
            if (resp.success){
              modalNP.hide();
              carregarPrescricoes();
            } else {
              alert('Erro ao salvar: ' + (resp.message||'Falha desconhecida'));
            }
          })
          .catch(err => alert('Erro ao salvar: ' + err))
          .finally(() => btn.prop('disabled', false).html(original));
      });
    });

    // Funções para Receituário
    function renderizarReceitas(lista) {
      const contHoje = $('#listaReceitasDoDia');
      const contAntigas = $('#listaReceitasAntigas');

      if (!lista || !lista.length) {
        contHoje.html('<div class="text-center text-muted py-4"><i class="fas fa-prescription fa-2x mb-3 d-block"></i>Nenhuma receita emitida hoje.</div>');
        contAntigas.html('<div class="text-center text-muted py-4"><i class="fas fa-history fa-2x mb-3 d-block"></i>Nenhuma receita anterior encontrada.</div>');
        $('#contador-receitas-antigas').text('0');
        return;
      }

      const hoje = new Date().toISOString().split('T')[0];
      const receitasHoje = [];
      const receitasAntigas = [];

      lista.forEach(r => {
        const data = new Date(r.data_receita).toISOString().split('T')[0];
        if (data === hoje) {
          receitasHoje.push(r);
        } else {
          receitasAntigas.push(r);
        }
      });

      // Renderizar receitas de hoje
      if (receitasHoje.length > 0) {
        let html = '';
        receitasHoje.forEach(r => {
          html += `
            <div class="card receita-container mb-2">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div><strong>${r.tipo_receita === 'especial' ? 'Receita Especial' : 'Receita Normal'}</strong></div>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted">${new Date(r.data_receita).toLocaleString()}</small>
                  <a class="btn btn-sm btn-outline-secondary" href="/clinica/receituario/${r.id}/imprimir_html" target="_blank">
                    <i class="fas fa-print"></i>
                  </a>
                </div>
              </div>
              <div class="card-body">
                <div>${r.conteudo_receita}</div>
              </div>
            </div>`;
        });
        contHoje.html(html);
      } else {
        contHoje.html('<div class="text-center text-muted py-4"><i class="fas fa-prescription fa-2x mb-3 d-block"></i>Nenhuma receita emitida hoje.</div>');
      }

      // Renderizar receitas antigas
      if (receitasAntigas.length > 0) {
        let html = '';
        receitasAntigas.forEach(r => {
          html += `
            <div class="card receita-container mb-2">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div><strong>${r.tipo_receita === 'especial' ? 'Receita Especial' : 'Receita Normal'}</strong></div>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted">${new Date(r.data_receita).toLocaleString()}</small>
                  <a class="btn btn-sm btn-outline-secondary" href="/clinica/receituario/${r.id}/imprimir_html" target="_blank">
                    <i class="fas fa-print"></i>
                  </a>
                </div>
              </div>
              <div class="card-body">
                <div>${r.conteudo_receita}</div>
              </div>
            </div>`;
        });
        contAntigas.html(html);
        $('#contador-receitas-antigas').text(receitasAntigas.length);
      } else {
        contAntigas.html('<div class="text-center text-muted py-4"><i class="fas fa-history fa-2x mb-3 d-block"></i>Nenhuma receita anterior encontrada.</div>');
        $('#contador-receitas-antigas').text('0');
      }
    }

    function carregarReceitas() {
      const atendimentoId = document.getElementById('ATENDIMENTO_ID').value;
      $('#listaReceitasDoDia').html('<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><span>Carregando receitas...</span></div>');

      fetch(`/api/receituarios/${atendimentoId}`)
        .then(r => r.json())
        .then(d => {
          const lista = d.receituarios || d.data || d || [];
          renderizarReceitas(Array.isArray(lista) ? lista : []);
        })
        .catch(() => {
          $('#listaReceitasDoDia').html('<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-3 d-block"></i>Erro ao carregar receitas</div>');
          $('#listaReceitasAntigas').html('');
        });
    }

    // Funções para Atestado
    function renderizarAtestados(lista) {
      const contHoje = $('#listaAtestadosDoDia');
      const contAntigas = $('#listaAtestadosAntigos');

      if (!lista || !lista.length) {
        contHoje.html('<div class="text-center text-muted py-4"><i class="fas fa-file-medical fa-2x mb-3 d-block"></i>Nenhum atestado emitido hoje.</div>');
        contAntigas.html('<div class="text-center text-muted py-4"><i class="fas fa-history fa-2x mb-3 d-block"></i>Nenhum atestado anterior encontrado.</div>');
        $('#contador-atestados-antigos').text('0');
        return;
      }

      const hoje = new Date().toISOString().split('T')[0];
      const atestadosHoje = [];
      const atestadosAntigos = [];

      lista.forEach(a => {
        const data = new Date(a.data_atestado).toISOString().split('T')[0];
        if (data === hoje) {
          atestadosHoje.push(a);
        } else {
          atestadosAntigos.push(a);
        }
      });

      // Renderizar atestados de hoje
      if (atestadosHoje.length > 0) {
        let html = '';
        atestadosHoje.forEach(a => {
          html += `
            <div class="card atestado-container mb-2">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div><strong>Atestado Médico</strong> ${a.dias_afastamento ? `(${a.dias_afastamento} dias)` : ''}</div>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted">${new Date(a.data_atestado).toLocaleString()}</small>
                  <a class="btn btn-sm btn-outline-secondary" href="/clinica/atestado/${a.id}/imprimir" target="_blank">
                    <i class="fas fa-print"></i>
                  </a>
                </div>
              </div>
              <div class="card-body">
                <div>${a.conteudo_atestado}</div>
              </div>
            </div>`;
        });
        contHoje.html(html);
      } else {
        contHoje.html('<div class="text-center text-muted py-4"><i class="fas fa-file-medical fa-2x mb-3 d-block"></i>Nenhum atestado emitido hoje.</div>');
      }

      // Renderizar atestados antigos
      if (atestadosAntigos.length > 0) {
        let html = '';
        atestadosAntigos.forEach(a => {
          html += `
            <div class="card atestado-container mb-2">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div><strong>Atestado Médico</strong> ${a.dias_afastamento ? `(${a.dias_afastamento} dias)` : ''}</div>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted">${new Date(a.data_atestado).toLocaleString()}</small>
                  <a class="btn btn-sm btn-outline-secondary" href="/clinica/atestado/${a.id}/imprimir" target="_blank">
                    <i class="fas fa-print"></i>
                  </a>
                </div>
              </div>
              <div class="card-body">
                <div>${a.conteudo_atestado}</div>
              </div>
            </div>`;
        });
        contAntigas.html(html);
        $('#contador-atestados-antigos').text(atestadosAntigos.length);
      } else {
        contAntigas.html('<div class="text-center text-muted py-4"><i class="fas fa-history fa-2x mb-3 d-block"></i>Nenhum atestado anterior encontrado.</div>');
        $('#contador-atestados-antigos').text('0');
      }
    }

    function carregarAtestados() {
      const atendimentoId = document.getElementById('ATENDIMENTO_ID').value;
      $('#listaAtestadosDoDia').html('<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><span>Carregando atestados...</span></div>');

      fetch(`/api/atestados/${atendimentoId}`)
        .then(r => r.json())
        .then(d => {
          const lista = d.atestados || d.data || d || [];
          renderizarAtestados(Array.isArray(lista) ? lista : []);
        })
        .catch(() => {
          $('#listaAtestadosDoDia').html('<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-3 d-block"></i>Erro ao carregar atestados</div>');
          $('#listaAtestadosAntigos').html('');
        });
    }

    // Inicializar Quill para editores
    let editorReceita, editorAtestado;

    // Função para inicializar editor de receita
    function inicializarEditorReceita() {
      if (typeof Quill !== 'undefined' && !editorReceita) {
        editorReceita = new Quill('#editor-receita-container', {
          theme: 'snow',
          placeholder: 'Digite o conteúdo da receita médica...',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'header': [1, 2, 3, false] }],
              ['clean']
            ]
          }
        });
      }
    }

    // Função para inicializar editor de atestado
    function inicializarEditorAtestado() {
      if (typeof Quill !== 'undefined' && !editorAtestado) {
        editorAtestado = new Quill('#editor-atestado-container', {
          theme: 'snow',
          placeholder: 'Digite o conteúdo do atestado médico...',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'header': [1, 2, 3, false] }],
              ['clean']
            ]
          }
        });
      }
    }

    // Event listeners para navegação
    $(document).on('click', 'a[data-target="receituarioSection"]', function() {
      carregarReceitas();
    });

    $(document).on('click', 'a[data-target="atestadoSection"]', function() {
      carregarAtestados();
    });

    // Event listeners para as abas da seção de anamnese
    $('#anamneseTabs .nav-link').on('click', function() {
      // Adicionar efeito visual de transição
      const targetPane = $($(this).data('bs-target'));
      targetPane.addClass('fade-in-active');
      
      setTimeout(() => {
        targetPane.removeClass('fade-in-active');
      }, 300);
    });

    // Event listeners para modais
    $('#modalNovaReceita').on('shown.bs.modal', function() {
      inicializarEditorReceita();
    });

    $('#modalNovoAtestado').on('shown.bs.modal', function () {
      inicializarEditorAtestado();

      const nomePaciente = ($('#pacienteNome').text() || 'NOME DO PACIENTE').trim();
      const cpfPaciente = ($('#pacienteCpf').text() || 'CPF DO PACIENTE').trim();
      const diasInput = document.getElementById('dias_afastamento');

      const gerarTextoAtestado = function(diasValor) {
        const diasNumerico = parseInt(diasValor, 10);
        const diasStr = diasNumerico > 0 ? `"${diasNumerico}"` : '"[dias]"';
        return `Atestado que o paciente "${nomePaciente}" portador do documento "${cpfPaciente}" deverá se afastar por um periodo de ${diasStr} dias\n\nCID: `;
      };

      const textoInicial = gerarTextoAtestado(diasInput ? diasInput.value : null);
      if (editorAtestado && editorAtestado.setText) {
        editorAtestado.setText(textoInicial);
      } else {
        $('#conteudo_atestado').val(textoInicial);
      }

      if (diasInput) {
        $(diasInput)
          .off('input.atestado change.atestado')
          .on('input.atestado change.atestado', function () {
            const texto = gerarTextoAtestado(this.value);
            if (editorAtestado && editorAtestado.setText) {
              editorAtestado.setText(texto);
            } else {
              $('#conteudo_atestado').val(texto);
            }
          });
      }
    });

    // Salvar receita
    $('#btn_salvar_receita').on('click', function() {
      const atendimentoId = document.getElementById('ATENDIMENTO_ID').value;
      const tipoReceita = $('#tipo_receita').val();
      const conteudoReceita = editorReceita ? editorReceita.root.innerHTML : $('#conteudo_receita').val();

      if (!tipoReceita || !conteudoReceita.trim()) {
        alert('Preencha todos os campos obrigatórios.');
        return;
      }

      // Obter o ID do médico atual da sessão
      const medicoId = document.getElementById('user_id') ? document.getElementById('user_id').value : null;

      const dados = {
        atendimento_id: atendimentoId,
        medico_id: medicoId,
        tipo_receita: tipoReceita,
        conteudo_receita: conteudoReceita
      };

      const btn = $(this);
      const original = btn.html();
      btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Salvando...');

      fetch('/api/receituarios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) {
          $('#modalNovaReceita').modal('hide');
          $('#formReceita')[0].reset();
          if (editorReceita) editorReceita.root.innerHTML = '';
          carregarReceitas();
        } else {
          alert('Erro ao salvar receita: ' + (resp.message || 'Falha desconhecida'));
        }
      })
      .catch(err => alert('Erro ao salvar receita: ' + err))
      .finally(() => {
        btn.prop('disabled', false).html(original);
      });
    });

    // Salvar atestado
    $('#btn_salvar_atestado').on('click', function() {
      const atendimentoId = document.getElementById('ATENDIMENTO_ID').value;
      const diasAfastamento = $('#dias_afastamento').val();
      const conteudoAtestado = editorAtestado ? editorAtestado.root.innerHTML : $('#conteudo_atestado').val();

      if (!conteudoAtestado.trim()) {
        alert('O conteúdo do atestado é obrigatório.');
        return;
      }

      // Obter o ID do médico atual da sessão
      const medicoId = document.getElementById('user_id') ? document.getElementById('user_id').value : null;

      const dados = {
        atendimento_id: atendimentoId,
        medico_id: medicoId,
        conteudo_atestado: conteudoAtestado,
        dias_afastamento: diasAfastamento ? parseInt(diasAfastamento) : null
      };

      const btn = $(this);
      const original = btn.html();
      btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Salvando...');

      fetch('/api/atestados', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) {
          $('#modalNovoAtestado').modal('hide');
          $('#formAtestado')[0].reset();
          if (editorAtestado) editorAtestado.root.innerHTML = '';
          carregarAtestados();
        } else {
          alert('Erro ao salvar atestado: ' + (resp.message || 'Falha desconhecida'));
        }
      })
      .catch(err => alert('Erro ao salvar atestado: ' + err))
      .finally(() => {
        btn.prop('disabled', false).html(original);
      });
    });

  </script>

  <!-- Adicionar Quill.js para editores ricos -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <!-- Script para fichas de referência -->
  <script src="/static/js/modal_ficha_fix.js"></script>

  <!-- Modal para Nova Ficha de Referência -->
  <div class="modal fade" id="modalNovaFichaReferencia" tabindex="-1" aria-labelledby="modalNovaFichaReferenciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content shadow-lg border-0 rounded-lg">
        <div class="modal-header bg-gradient-primary text-white" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;">
          <h5 class="modal-title fw-bold" id="modalNovaFichaReferenciaLabel">
            <i class="fas fa-file-export me-2"></i>Nova Ficha de Referência
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body p-4">
          <div class="alert alert-info d-flex align-items-center mb-4">
            <i class="fas fa-info-circle me-2"></i>
            <div>
              <strong>Orientação:</strong> Preencha as informações necessárias para o encaminhamento do paciente. O texto de referência é o campo principal para detalhar a situação clínica.
            </div>
          </div>
          
          <form id="formFichaReferencia">
            <!-- Primeira linha: Unidade de Referência e Tipo de Encaminhamento -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control form-control-lg" id="unidade_referencia" name="unidade_referencia" placeholder="Ex: Hospital Regional, UPA Central...">
                  <label for="unidade_referencia">
                    <i class="fas fa-hospital me-1 text-primary"></i>Unidade de Referência
                  </label>
                </div>
                <div class="form-text">Ex: Hospital de Referência, Centro da Vida, etc..</div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold mb-3">
                  <i class="fas fa-share me-1 text-success"></i>Tipo de Encaminhamento
                </label>
                <div class="d-flex flex-column gap-2">
                  <div class="form-check form-check-lg p-3 border rounded bg-light">
                    <input class="form-check-input form-check-input-lg" type="checkbox" id="encaminhamento_ambulatorial" name="encaminhamento_ambulatorial" value="Ambulatorial">
                    <label class="form-check-label fw-semibold" for="encaminhamento_ambulatorial">
                      <i class="fas fa-clinic-medical me-2 text-info"></i>Ambulatorial
                      <small class="d-block text-muted">Consultas e procedimentos ambulatoriais</small>
                    </label>
                  </div>
                  <div class="form-check form-check-lg p-3 border rounded bg-light">
                    <input class="form-check-input form-check-input-lg" type="checkbox" id="encaminhamento_hospitalar" name="encaminhamento_hospitalar" value="Hospitalar">
                    <label class="form-check-label fw-semibold" for="encaminhamento_hospitalar">
                      <i class="fas fa-hospital me-2 text-danger"></i>Hospitalar
                      <small class="d-block text-muted">Internação e cuidados hospitalares</small>
                    </label>
                  </div>
                  <div class="form-check form-check-lg p-3 border rounded bg-light">
                    <input class="form-check-input form-check-input-lg" type="checkbox" id="encaminhamento_auxilio_diagnostico" name="encaminhamento_auxilio_diagnostico" value="Auxilio Diagnostico">
                    <label class="form-check-label fw-semibold" for="encaminhamento_auxilio_diagnostico">
                      <i class="fas fa-x-ray me-2 text-warning"></i>Auxílio Diagnóstico
                      <small class="d-block text-muted">Exames e procedimentos diagnósticos</small>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Segunda linha: Procedimento -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="procedimento" name="procedimento" rows="3" style="height: 100px;" placeholder="Descreva o procedimento solicitado..."></textarea>
                  <label for="procedimento">
                    <i class="fas fa-cogs me-1 text-warning"></i>Procedimento Solicitado
                  </label>
                </div>
                <div class="form-text">Descreva procedimentos específicos, cirurgias ou tratamentos recomendados</div>
              </div>
            </div>

            <!-- Terceira linha: Texto de Referência (Campo Principal) -->
            <div class="row">
              <div class="col-12">
                <label for="texto_referencia" class="form-label fw-bold text-primary mb-3">
                  <i class="fas fa-file-text me-2"></i>Texto de Referência (Campo Principal)
                </label>
                <div class="border border-primary border-2 rounded p-2">
                  <textarea class="form-control form-control-lg border-0" 
                            id="texto_referencia" 
                            name="texto_referencia" 
                            rows="10" 
                            style="resize: vertical; min-height: 280px; font-size: 14px; line-height: 1.6;"
                            placeholder="Digite aqui os detalhes da referência:&#10;&#10;• História clínica resumida&#10;• Motivo do encaminhamento&#10;• Exames realizados&#10;• Tratamentos já tentados&#10;• Observações importantes&#10;&#10;Seja detalhado para facilitar o atendimento na unidade de destino."></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer bg-light border-0 p-4">
          <button type="button" class="btn btn-outline-secondary btn-lg me-2" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button type="button" 
                  class="btn btn-success btn-lg px-4" 
                  id="btn_salvar_ficha_referencia">
            <i class="fas fa-save me-2"></i>Salvar Ficha de Referência
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== FUNÇÃO PARA SALVAR FICHA DE REFERÊNCIA =====
    function salvarFichaReferencia() {
      console.log('🚀 Iniciando salvarFichaReferencia()');
      
      // Prevenir múltiplas execuções simultâneas
      const btnSalvar = document.getElementById('btn_salvar_ficha_referencia');
      if (btnSalvar && btnSalvar.disabled) {
        console.log('⚠️ Botão já está processando, ignorando clique duplo');
        return;
      }
      
      const texto_referencia = document.getElementById('texto_referencia').value;
      const procedimento = document.getElementById('procedimento').value;
      const unidade_referencia = document.getElementById('unidade_referencia').value;
      
      // Coletar checkboxes de encaminhamento
      const encaminhamentoCheckboxes = [];
      if (document.getElementById('encaminhamento_ambulatorial')?.checked) {
        encaminhamentoCheckboxes.push('Ambulatorial');
      }
      if (document.getElementById('encaminhamento_hospitalar')?.checked) {
        encaminhamentoCheckboxes.push('Hospitalar');
      }
      if (document.getElementById('encaminhamento_auxilio_diagnostico')?.checked) {
        encaminhamentoCheckboxes.push('Auxilio Diagnostico');
      }
      const encaminhamento_atendimento = encaminhamentoCheckboxes.join(', ');
      
      console.log('📝 Valores dos campos:');
      console.log('  - texto_referencia:', texto_referencia);
      console.log('  - encaminhamento_atendimento:', encaminhamento_atendimento);
      console.log('  - procedimento:', procedimento);
      console.log('  - unidade_referencia:', unidade_referencia);
      
      // Validação básica - pelo menos um campo deve ter conteúdo
      if (!texto_referencia && !encaminhamento_atendimento && !procedimento && !unidade_referencia) {
        console.log('❌ Validação falhou: nenhum campo preenchido');
        alert('Por favor, preencha pelo menos um dos campos da ficha de referência.');
        return;
      }
      
      console.log('✅ Validação passou');
      
      // Mostrar indicador de carregamento
      if (!btnSalvar) {
        console.error('❌ Botão btn_salvar_ficha_referencia não encontrado!');
        alert('Erro: Botão de salvamento não encontrado.');
        return;
      }
      
      const textoOriginal = btnSalvar.innerHTML;
      btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      btnSalvar.disabled = true;
      
      console.log('🔄 Botão de salvamento configurado para loading');
      
      // Obter ID do atendimento
      const atendimentoId = document.getElementById('ATENDIMENTO_ID')?.value || 
                           document.getElementById('atendimento_id')?.value;
      
      console.log('🆔 ID do atendimento:', atendimentoId);
      
      if (!atendimentoId) {
        console.error('❌ ID de atendimento não encontrado');
        alert('Erro: ID de atendimento não encontrado');
        btnSalvar.innerHTML = textoOriginal;
        btnSalvar.disabled = false;
        return;
      }
      
      // Preparar dados para envio
      const dados = {
        atendimento_id: atendimentoId,
        texto_referencia: texto_referencia,
        encaminhamento_atendimento: encaminhamento_atendimento,
        procedimento: procedimento,
        unidade_referencia: unidade_referencia
      };
      
      console.log('📦 Dados da ficha de referência sendo enviados:', dados);
      console.log('🌐 URL da requisição: /api/fichas-referencia');
      
      // Enviar requisição
      $.ajax({
        url: '/api/fichas-referencia',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dados),
        success: function(response) {
          console.log('✅ Resposta de sucesso recebida:', response);
          
          if (response.success) {
            console.log('🎉 Ficha criada com sucesso!');
            
            // Limpar formulário
            document.getElementById('formFichaReferencia').reset();
            
            // Fechar modal
            $('#modalNovaFichaReferencia').modal('hide');
            
            // Mostrar mensagem de sucesso
            alert('Ficha de referência criada com sucesso!');
            
            // Recarregar lista de fichas
            if (typeof carregarFichasReferencia === 'function') {
              setTimeout(carregarFichasReferencia, 500);
            }
          } else {
            console.error('❌ Erro na resposta:', response.message);
            alert('Erro ao criar ficha: ' + (response.message || 'Erro desconhecido'));
          }
        },
        error: function(xhr, status, error) {
          console.error('❌ Erro na requisição AJAX:', error);
          console.error('Status:', status);
          console.error('Response:', xhr.responseText);
          alert('Erro ao salvar ficha de referência: ' + error);
        },
        complete: function() {
          // Restaurar botão
          btnSalvar.innerHTML = textoOriginal;
          btnSalvar.disabled = false;
        }
      });
    }

    // ===== FUNÇÃO PARA IMPRIMIR FICHA DE REFERÊNCIA =====
    function imprimirFichaReferencia(fichaId) {
      console.log('🖨️ Imprimindo ficha de referência ID:', fichaId);
      window.open(`/clinica/ficha-referencia/${fichaId}/imprimir`, '_blank');
    }

    // ===== FUNÇÃO PARA CARREGAR FICHAS DE REFERÊNCIA =====
    function carregarFichasReferencia() {
      console.log('📂 Carregando fichas de referência...');
      
      const atendimentoId = document.getElementById('ATENDIMENTO_ID')?.value || 
                           document.getElementById('atendimento_id')?.value;
      
      if (!atendimentoId) {
        console.error('❌ ID de atendimento não encontrado');
        $('#listaFichasReferencia').html('<div class="alert alert-warning">ID de atendimento não encontrado</div>');
        return;
      }
      
      $('#listaFichasReferencia').html(`
        <div class="text-center py-4">
          <i class="fas fa-spinner fa-spin text-primary fa-2x"></i>
          <p class="mt-3 text-muted">Carregando fichas de referência...</p>
        </div>
      `);
      
      $.ajax({
        url: `/api/fichas-referencia/lista/${atendimentoId}`,
        method: 'GET',
        success: function(response) {
          console.log('✅ Fichas carregadas:', response);
          
          if (response.success && response.fichas && response.fichas.length > 0) {
            // Adicionar estatísticas
            let html = `
              <div class="alert alert-success mb-4">
                <div class="row text-center">
                  <div class="col-md-12">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>${response.fichas.length}</strong> ficha${response.fichas.length > 1 ? 's' : ''} de referência encontrada${response.fichas.length > 1 ? 's' : ''}
                  </div>
                </div>
              </div>
              <div class="row g-3">
            `;
            
            response.fichas.forEach(function(ficha, index) {
              // Formatar data de criação
              let dataExibicao = 'Data não informada';
              if (ficha.data_criacao_pretty) {
                dataExibicao = ficha.data_criacao_pretty;
              } else if (ficha.data && ficha.hora) {
                dataExibicao = `${ficha.data} ${ficha.hora}`;
              } else if (ficha.data) {
                dataExibicao = ficha.data;
              }
              
              html += `
                <div class="col-12">
                  <div class="card border-primary shadow-sm">
                    <div class="card-header bg-primary text-white">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <i class="fas fa-file-export me-2"></i>
                          <strong>Ficha de Referência #${ficha.id || (index + 1)}</strong>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <small><i class="fas fa-calendar me-1"></i>${dataExibicao}</small>
                          <button class="btn btn-light btn-sm" onclick="imprimirFichaReferencia(${ficha.id})" title="Imprimir Ficha">
                            <i class="fas fa-print"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      ${ficha.unidade_referencia ? `
                        <div class="mb-3">
                          <h6 class="text-primary mb-2">
                            <i class="fas fa-hospital me-2"></i>Unidade de Referência
                          </h6>
                          <div class="p-2 bg-light rounded border">${ficha.unidade_referencia}</div>
                        </div>
                      ` : ''}
                      
                      ${ficha.encaminhamento_atendimento ? `
                        <div class="mb-3">
                          <h6 class="text-success mb-2">
                            <i class="fas fa-share me-2"></i>Tipo de Encaminhamento
                          </h6>
                          <div class="p-2 bg-light rounded border">${ficha.encaminhamento_atendimento}</div>
                        </div>
                      ` : ''}
                      
                      ${ficha.procedimento ? `
                        <div class="mb-3">
                          <h6 class="text-warning mb-2">
                            <i class="fas fa-cogs me-2"></i>Procedimento Solicitado
                          </h6>
                          <div class="p-2 bg-light rounded border">${ficha.procedimento}</div>
                        </div>
                      ` : ''}
                      
                      ${ficha.texto_referencia ? `
                        <div class="mb-0">
                          <h6 class="text-info mb-2">
                            <i class="fas fa-file-text me-2"></i>Texto de Referência
                          </h6>
                          <div class="p-3 bg-light rounded border" style="white-space: pre-wrap;">${ficha.texto_referencia}</div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
            $('#listaFichasReferencia').html(html);
          } else {
            $('#listaFichasReferencia').html(`
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Nenhuma ficha de referência encontrada para este atendimento.
              </div>
            `);
          }
        },
        error: function(xhr, status, error) {
          console.error('❌ Erro ao carregar fichas:', error);
          $('#listaFichasReferencia').html(`
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Erro ao carregar fichas de referência.
            </div>
          `);
        }
      });
    }

    // ===== INICIALIZAÇÃO =====
    $(document).ready(function() {
      console.log('🎬 Inicializando ficha de atendimento médico...');
      console.log('📋 ID do Atendimento:', $('#ATENDIMENTO_ID').val());
      
      // Verificar se a função de inicialização existe
      if (typeof inicializarModuloFichasReferencia === 'function') {
        console.log('✅ Função inicializarModuloFichasReferencia encontrada');
        try {
          inicializarModuloFichasReferencia();
          console.log('✅ Módulo de fichas de referência inicializado com sucesso');
        } catch (error) {
          console.error('❌ Erro ao inicializar módulo de fichas:', error);
        }
      } else {
        console.log('⚠️ Função inicializarModuloFichasReferencia não encontrada (usando implementação local)');
      }

      // Carregar fichas quando a seção for ativada
      $(document).on('click', '[data-target="fichaReferenciaSection"]', function() {
        console.log('📂 Seção de fichas de referência ativada');
        setTimeout(function() {
          carregarFichasReferencia();
        }, 100);
      });
    });
  </script>

  <!-- Script para Histórico de Atendimentos -->
  <script>
    let pacienteIdGlobal = null;
    
    // Função para carregar histórico de atendimentos
    function carregarHistoricoAtendimentos() {
      if (!pacienteIdGlobal) {
        console.error('ID do paciente não definido');
        return;
      }
      
      const atendimentoAtualId = document.getElementById('ATENDIMENTO_ID').value;
      
      $('#listaHistoricoAtendimentos').html('<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><span>Carregando histórico...</span></div>');
      
      fetch(`/api/paciente/${pacienteIdGlobal}/historico-atendimentos?atendimento_atual_id=${atendimentoAtualId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // Atualizar badge de total
            $('#totalAtendimentos').text(`${data.total} atendimento${data.total !== 1 ? 's' : ''}`);
            
            // Verificar e exibir alerta de frequência
            if (data.alerta_frequente) {
              $('#alertaFrequencia').show(); // Ícone no menu
              $('#alertaFrequenciaDetalhado').show(); // Alerta na seção
              $('#qtdAtendimentosRecentes').text(data.atendimentos_ultimos_7_dias);
            }
            
            // Renderizar histórico
            if (data.historico && data.historico.length > 0) {
              let html = '<div class="table-responsive"><table class="table table-hover">';
              html += '<thead class="table-light"><tr>';
              html += '<th style="width: 10%;">Data</th><th style="width: 7%;">Hora</th><th style="width: 13%;">Status</th><th style="width: 13%;">Classificação</th><th style="width: 22%;">Médico</th><th style="width: 35%;">Ações</th>';
              html += '</tr></thead><tbody>';
              
              data.historico.forEach(atend => {
                // Badge de classificação de risco
                let badgeClass = 'secondary';
                const risco = (atend.classificacao_risco || '').toLowerCase();
                if (risco.includes('vermelho')) badgeClass = 'danger';
                else if (risco.includes('laranja') || risco.includes('amarelo')) badgeClass = 'warning';
                else if (risco.includes('verde')) badgeClass = 'success';
                else if (risco.includes('azul')) badgeClass = 'primary';
                
                html += '<tr>';
                html += `<td><strong>${atend.data}</strong></td>`;
                html += `<td>${atend.hora}</td>`;
                html += `<td><span class="badge bg-${atend.status === 'Alta' ? 'success' : 'info'}">${atend.status}</span></td>`;
                html += `<td><span class="badge bg-${badgeClass}">${atend.classificacao_risco}</span></td>`;
                html += `<td><small>${atend.medico}</small></td>`;
                html += `<td>
                  <div class="d-flex flex-column gap-1">
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-outline-primary btn-ver-detalhes" data-atend-id="${atend.id}" title="Ver detalhes">
                        <i class="fas fa-eye"></i>
                      </button>
                      <a href="/imprimir/ficha_atendimento/${atend.id}" target="_blank" class="btn btn-outline-success" title="Imprimir ficha">
                        <i class="fas fa-print"></i>
                      </a>
                    </div>`;
                
                // Adicionar botões de observação e internação se existirem
                if (atend.tem_observacao) {
                  html += `
                    <a href="/clinica/historico-internacao/${atend.id}" target="_blank" class="btn btn-sm btn-warning w-100" title="Ver histórico de observação">
                      <i class="fas fa-bed me-1"></i>Observação
                    </a>`;
                }
                
                if (atend.tem_internacao) {
                  html += `
                    <a href="/clinica/historico-internacao/${atend.id}" target="_blank" class="btn btn-sm btn-info w-100" title="Ver histórico de internação">
                      <i class="fas fa-hospital me-1"></i>Internação
                    </a>`;
                }
                
                html += `
                  </div>
                </td>`;
                html += '</tr>';
                
                // Linha expansível com detalhes
                html += `<tr id="detalhes_${atend.id}" style="display:none;">`;
                html += '<td colspan="6" class="bg-light">';
                html += '<div class="p-3">';
                html += '<div class="d-flex justify-content-between align-items-start mb-3">';
                html += '<div>';
                html += '<h6 class="text-primary mb-2"><i class="fas fa-info-circle me-2"></i>Detalhes do Atendimento</h6>';
                
                // Badges de observação e internação
                if (atend.tem_observacao) {
                  html += '<span class="badge bg-warning me-2"><i class="fas fa-bed me-1"></i>Teve Observação</span>';
                }
                if (atend.tem_internacao) {
                  html += '<span class="badge bg-info"><i class="fas fa-hospital me-1"></i>Teve Internação</span>';
                }
                
                html += '</div>';
                html += '<div class="d-flex gap-2">';
                
                // Botões de acesso rápido
                if (atend.tem_observacao) {
                  html += `<a href="/clinica/historico-internacao/${atend.id}" target="_blank" class="btn btn-sm btn-warning" title="Ver histórico de observação">
                    <i class="fas fa-bed me-1"></i>Ver Observação
                  </a>`;
                }
                if (atend.tem_internacao) {
                  html += `<a href="/clinica/historico-internacao/${atend.id}" target="_blank" class="btn btn-sm btn-info" title="Ver histórico de internação">
                    <i class="fas fa-hospital me-1"></i>Ver Internação
                  </a>`;
                }
                
                html += `<a href="/imprimir/ficha_atendimento/${atend.id}" target="_blank" class="btn btn-sm btn-success">
                  <i class="fas fa-print me-1"></i>Imprimir Ficha
                </a>`;
                html += '</div>';
                html += '</div>';
                
                // Triagem
                if (atend.triagem && atend.triagem !== '-') {
                  html += `<div class="mb-2"><strong><i class="fas fa-comment-medical me-2 text-info"></i>Triagem:</strong></div>`;
                  html += `<div class="ps-4 mb-3 text-muted">${atend.triagem.substring(0, 400)}${atend.triagem.length > 400 ? '...' : ''}</div>`;
                }
                
                // Exame Físico
                if (atend.anamnese_exame_fisico && atend.anamnese_exame_fisico !== '-') {
                  html += `<div class="mb-2"><strong><i class="fas fa-stethoscope me-2 text-primary"></i>Exame Físico:</strong></div>`;
                  html += `<div class="ps-4 mb-3 text-muted" style="white-space: pre-wrap;">${atend.anamnese_exame_fisico.substring(0, 400)}${atend.anamnese_exame_fisico.length > 400 ? '...' : ''}</div>`;
                }
                
                // Prescrição
                if (atend.prescricao && atend.prescricao !== '-') {
                  html += `<div class="mb-2"><strong><i class="fas fa-pills me-2 text-success"></i>Prescrição:</strong></div>`;
                  html += `<div class="ps-4 text-muted" style="white-space: pre-wrap;">${atend.prescricao}</div>`;
                }
                
                html += '<div class="mt-3 text-end">';
                html += `<small class="text-muted"><i class="fas fa-info-circle me-1"></i>Para ver todos os detalhes, clique em "Imprimir Ficha Completa"</small>`;
                html += '</div>';
                html += '</div></td></tr>';
              });
              
              html += '</tbody></table></div>';
              $('#listaHistoricoAtendimentos').html(html);
            } else {
              $('#listaHistoricoAtendimentos').html('<div class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-3 d-block"></i>Nenhum atendimento anterior encontrado.</div>');
            }
          } else {
            $('#listaHistoricoAtendimentos').html('<div class="alert alert-danger">Erro ao carregar histórico</div>');
          }
        })
        .catch(err => {
          console.error('Erro ao carregar histórico:', err);
          $('#listaHistoricoAtendimentos').html('<div class="alert alert-danger">Erro ao carregar histórico</div>');
        });
    }
    
    // Event listener delegado para os botões de ver detalhes (criados dinamicamente)
    $(document).on('click', '.btn-ver-detalhes', function() {
      const atendId = $(this).data('atend-id');
      console.log('Clicou em ver detalhes do atendimento:', atendId);
      
      const detalhes = $(`#detalhes_${atendId}`);
      console.log('Elemento detalhes encontrado:', detalhes.length > 0);
      
      if (detalhes.is(':visible')) {
        detalhes.fadeOut(300);
        $(this).removeClass('active');
      } else {
        // Fechar todos os outros detalhes abertos
        $('[id^="detalhes_"]').fadeOut(300);
        $('.btn-ver-detalhes').removeClass('active');
        
        // Abrir este
        detalhes.fadeIn(300);
        $(this).addClass('active');
      }
    });
    
    // Carregar histórico quando a seção for ativada
    $(document).on('click', '[data-target="historicoSection"]', function() {
      if (pacienteIdGlobal) {
        carregarHistoricoAtendimentos();
      }
    });
    
    // Capturar o ID do paciente quando os dados forem carregados
    $(function() {
      const atendimentoAtualId = document.getElementById('ATENDIMENTO_ID').value;
      fetch(`/api/atendimento/${atendimentoAtualId}`)
        .then(r => r.json())
        .then(d => {
          if (d.success && d.data && d.data.paciente) {
            pacienteIdGlobal = d.data.paciente.id;
            console.log('Paciente ID capturado:', pacienteIdGlobal);
            
            // Carregar histórico em background para verificar alerta (excluindo atendimento atual)
            fetch(`/api/paciente/${pacienteIdGlobal}/historico-atendimentos?atendimento_atual_id=${atendimentoAtualId}`)
              .then(r => r.json())
              .then(data => {
                if (data.success && data.alerta_frequente) {
                  $('#alertaFrequencia').show();
                }
              })
              .catch(() => {});
          }
        })
        .catch(() => {});
    });
  </script>

</body>
</html>


