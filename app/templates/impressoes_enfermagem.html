<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impress√µes de Enfermagem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header-container {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .paciente-info {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .paciente-info .info-item {
            font-size: 0.95rem;
            margin-bottom: 10px;
        }
        
        .paciente-info .info-item strong {
            color: #495057;
            font-weight: 600;
        }
        
        .impressao-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .section-header {
            background: linear-gradient(135deg, #007bff, #007bff);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        
        .section-content {
            padding: 1.5rem;
        }
        
        .btn-impressao {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .btn-impressao:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            color: white;
        }
        
        .btn-voltar {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            border: none;
            color: white;
        }
        
        .btn-voltar:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            color: white;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
            }
            
            .impressao-section {
                box-shadow: none !important;
                border: 1px solid #dee2e6 !important;
            }
        }

        /* Estilos personalizados para a modal de sele√ß√£o de data */
        .modal-content {
            border-radius: 10px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            border-bottom: none;
        }

        .list-group-item {
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
            border-left: 3px solid #007bff;
        }

        .list-group-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .list-group-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .badge {
            font-size: 0.75rem;
        }

        /* Anima√ß√£o de hover para os bot√µes de impress√£o */
        .btn-impressao:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Diferencia√ß√£o visual para modals de prescri√ß√µes */
        #modalSelecaoDataPrescricoes .modal-header {
            background: linear-gradient(135deg, #007bff, #0056b3) !important;
        }

        #modalSelecaoDataPrescricoes .list-group-item:hover {
            border-left: 3px solid #007bff;
        }

        #modalSelecaoDataPrescricoes .badge {
            background-color: #007bff !important;
        }

        /* Diferencia√ß√£o visual para modals de evolu√ß√µes */
        #modalSelecaoData .modal-header {
            background: linear-gradient(135deg, #2878a7, #2878a7) !important;
        }

        #modalSelecaoData .list-group-item:hover {
            border-left: 3px solid #2878a7;
        }

        #modalSelecaoData .badge {
            background-color: #2878a7 !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-container no-print">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-print me-3"></i>Impress√µes de Enfermagem
                    </h1>
                    <p class="mb-0 opacity-75">Sistema de relat√≥rios e documentos para enfermagem</p>
                </div>
                <div class="col-md-4 text-end">
                    <button type="button" class="btn btn-voltar" onclick="voltarParaEvolucao()">
                        <i class="fas fa-arrow-left me-2"></i>Voltar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Informa√ß√µes do Paciente -->
        <div class="paciente-info">
            <h5 class="mb-3 text-primary">
                <i class="fas fa-user me-2"></i>Informa√ß√µes do Paciente
            </h5>
            <div class="row">
                <div class="col-md-4 info-item"><strong>Nome:</strong> <span id="paciente-nome">{{ paciente.nome if paciente else 'Carregando...' }}</span></div>
                <div class="col-md-4 info-item"><strong>CPF:</strong> <span id="paciente-cpf">{{ paciente.cpf if paciente else 'Carregando...' }}</span></div>
                <div class="col-md-4 info-item"><strong>Cart√£o SUS:</strong> <span id="paciente-sus">{{ paciente.cartao_sus if paciente else 'Carregando...' }}</span></div>
                <div class="col-md-4 info-item"><strong>Sexo:</strong> <span id="paciente-sexo">{{ paciente.sexo if paciente else 'Carregando...' }}</span></div>
                <div class="col-md-4 info-item"><strong>Data de Nascimento:</strong> <span id="paciente-nascimento">{{ paciente.data_nascimento.strftime('%d/%m/%Y') if paciente and paciente.data_nascimento else 'Carregando...' }}</span></div>
                <div class="col-md-4 info-item"><strong>Telefone:</strong> <span id="paciente-telefone">{{ paciente.telefone if paciente else 'Carregando...' }}</span></div>
                <div class="col-md-6 info-item"><strong>Endere√ßo:</strong> <span id="paciente-endereco">{{ paciente.endereco if paciente else 'Carregando...' }}</span></div>
                <div class="col-md-3 info-item"><strong>Munic√≠pio:</strong> <span id="paciente-municipio">{{ paciente.municipio if paciente else 'Carregando...' }}</span></div>
                <div class="col-md-3 info-item"><strong>Atendimento ID:</strong> <span id="atendimento-id">{{ atendimento_id if atendimento_id else 'Carregando...' }}</span></div>
            </div>
        </div>

        <!-- Op√ß√µes de Impress√£o -->
        <div class="row">
            <!-- Admiss√£o de Enfermagem -->
            <div class="col-md-6 mb-4">
                <div class="impressao-section">
                    <div class="section-header">
                        <i class="fas fa-user-plus me-2"></i>Admiss√£o de Enfermagem
                    </div>
                    <div class="section-content">
                        <p class="text-muted mb-3">
                            Relat√≥rio da admiss√£o de enfermagem e avalia√ß√£o inicial do paciente.
                        </p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-impressao" onclick="imprimirAdmissao()">
                                <i class="fas fa-file-plus me-2"></i>Imprimir Admiss√£o
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="visualizarAdmissao()">
                                <i class="fas fa-eye me-2"></i>Visualizar antes de imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SAE - Sistematiza√ß√£o da Assist√™ncia de Enfermagem -->
            <div class="col-md-6 mb-4">
                <div class="impressao-section">
                    <div class="section-header">
                        <i class="fas fa-user-check me-2"></i>SAE - Sistematiza√ß√£o da Assist√™ncia
                    </div>
                    <div class="section-content">
                        <p class="text-muted mb-3">
                            Relat√≥rio completo da Sistematiza√ß√£o da Assist√™ncia de Enfermagem.
                        </p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-impressao" onclick="imprimirSae()">
                                <i class="fas fa-heartbeat me-2"></i>Imprimir SAE
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="visualizarSae()">
                                <i class="fas fa-eye me-2"></i>Visualizar antes de imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evolu√ß√µes de Enfermagem -->
            <div class="col-md-6 mb-4">
                <div class="impressao-section">
                    <div class="section-header">
                        <i class="fas fa-notes-medical me-2"></i>Evolu√ß√µes de Enfermagem
                    </div>
                    <div class="section-content">
                        <p class="text-muted mb-3">
                            Relat√≥rio das evolu√ß√µes de enfermagem registradas durante a interna√ß√£o.
                        </p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-impressao" onclick="imprimirEvolucoes()">
                                <i class="fas fa-file-medical-alt me-2"></i>Imprimir Evolu√ß√µes
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="visualizarEvolucoes()">
                                <i class="fas fa-eye me-2"></i>Visualizar antes de imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prescri√ß√µes de Enfermagem -->
            <div class="col-md-6 mb-4">
                <div class="impressao-section">
                    <div class="section-header">
                        <i class="fas fa-clipboard-list me-2"></i>Prescri√ß√µes de Enfermagem
                    </div>
                    <div class="section-content">
                        <p class="text-muted mb-3">
                            Relat√≥rio das prescri√ß√µes de enfermagem e cuidados prescritos.
                        </p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-impressao" onclick="imprimirPrescricoes()">
                                <i class="fas fa-prescription me-2"></i>Imprimir Prescri√ß√µes
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="visualizarPrescricoes()">
                                <i class="fas fa-eye me-2"></i>Visualizar antes de imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ficha de Identifica√ß√£o do Paciente -->
            <div class="col-md-6 mb-4">
                <div class="impressao-section">
                    <div class="section-header">
                        <i class="fas fa-id-card me-2"></i>Ficha de Identifica√ß√£o do Paciente
                    </div>
                    <div class="section-content">
                        <p class="text-muted mb-3">
                            Ficha de identifica√ß√£o completa do paciente para uso na interna√ß√£o.
                        </p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-impressao" onclick="imprimirFichaIdentificacao()">
                                <i class="fas fa-id-card me-2"></i>Imprimir Ficha de Identifica√ß√£o
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="visualizarFichaIdentificacao()">
                                <i class="fas fa-eye me-2"></i>Visualizar antes de imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ficha de Admiss√£o Hospitalar -->
            <div class="col-md-6 mb-4">
                <div class="impressao-section">
                    <div class="section-header">
                        <i class="fas fa-file-medical me-2"></i>Ficha de Admiss√£o Hospitalar
                    </div>
                    <div class="section-content">
                        <p class="text-muted mb-3">
                            Ficha de admiss√£o hospitalar detalhada do paciente, incluindo dados cl√≠nicos iniciais.
                        </p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-impressao" onclick="imprimirFichaAdmissao()">
                                <i class="fas fa-file-medical me-2"></i>Imprimir Ficha de Admiss√£o
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impress√£o da √öltima Evolu√ß√£o -->
            <div class="col-md-6 mb-4">
                <div class="impressao-section">
                    <div class="section-header">
                        <i class="fas fa-user-edit me-2"></i>√öltima Evolu√ß√£o Registrada
                    </div>
                    <div class="section-content">
                        <p class="text-muted mb-3">
                            Imprima a √∫ltima evolu√ß√£o registrada para este atendimento.
                        </p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-impressao" onclick="imprimirUltimaEvolucao()">
                                <i class="fas fa-file-medical me-2"></i>Imprimir √öltima Evolu√ß√£o
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lobby para Impress√µes M√©dicas (adiantamento pela Enfermagem) -->
        <div class="row mt-2">
            <div class="col-12">
                <div class="impressao-section">
                    <div class="section-header" style="background: linear-gradient(135deg, #6f42c1, #6f42c1);">
                        <i class="fas fa-user-md me-2"></i>Lobby de Impress√µes M√©dicas (adiantadas pela Enfermagem)
                    </div>
                    <div class="section-content">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <h6 class="mb-2 text-primary"><i class="fas fa-file-medical me-2"></i>Ficha de Admiss√£o Hospitalar</h6>
                                        <p class="text-muted small mb-3">Documento m√©dico. A enfermagem pode adiantar a impress√£o com os dados j√° dispon√≠veis.</p>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-impressao" onclick="abrirFichaAdmissao()">
                                                <i class="fas fa-print me-2"></i>Imprimir Ficha de Admiss√£o
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body">
                                        <h6 class="mb-2 text-primary"><i class="fas fa-file-invoice me-2"></i>AIH - Autoriza√ß√£o de Interna√ß√£o Hospitalar</h6>
                                        <p class="text-muted small mb-3">Documento m√©dico (AIH). A enfermagem pode gerar a visualiza√ß√£o/impress√£o com os dados do prontu√°rio.</p>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-impressao" onclick="abrirAIH()">
                                                <i class="fas fa-print me-2"></i>Imprimir AIH
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mb-0 small"><i class="fas fa-info-circle me-2"></i>Estes documentos s√£o de responsabilidade m√©dica. A impress√£o aqui √© apenas para adiantamento/apoio, conforme normas internas.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Extrair o ID do atendimento da URL
        const atendimentoId = window.location.pathname.split('/').pop();
        console.log('ID do atendimento extra√≠do:', atendimentoId);

        // Fun√ß√£o para voltar para a evolu√ß√£o do paciente
        function voltarParaEvolucao() {
            console.log('üîÑ Voltando para evolu√ß√£o do paciente...');
            try {
                // Detectar o cargo do usu√°rio
                const cargoUsuario = document.getElementById('page-data')?.dataset?.cargo?.toLowerCase().trim() || 'enfermeiro';
                
                let evolucaoUrl;
                if (cargoUsuario === 'multi') {
                    evolucaoUrl = `/clinica/evolucao-paciente-multi/${atendimentoId}`;
                } else if (cargoUsuario === 'medico') {
                    evolucaoUrl = `/clinica/evolucao-paciente-medico/${atendimentoId}`;
                } else {
                    evolucaoUrl = `/clinica/evolucao-paciente-enfermeiro/${atendimentoId}`;
                }
                
                window.location.href = evolucaoUrl;
            } catch (error) {
                console.error('‚ùå Erro no redirecionamento:', error);
                window.history.back();
            }
        }

        // Fun√ß√µes de impress√£o (ser√£o implementadas futuramente)
        function imprimirEvolucoes() {
            console.log('üñ®Ô∏è Imprimir evolu√ß√µes de enfermagem');
            // Buscar as datas dispon√≠veis
            carregarDatasEvolucoes();
        }

        function visualizarEvolucoes() {
            console.log('üëÅÔ∏è Visualizar evolu√ß√µes de enfermagem');
            // Buscar as datas dispon√≠veis
            carregarDatasEvolucoes();
        }

        // Fun√ß√£o para carregar as datas dispon√≠veis das evolu√ß√µes
        function carregarDatasEvolucoes() {
            console.log('üìÖ Carregando datas das evolu√ß√µes...');
            
            $.ajax({
                url: `/api/enfermagem/evolucoes/datas/${atendimentoId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.datas && response.datas.length > 0) {
                        mostrarModalSelecaoData(response.datas);
                    } else {
                        alert('Nenhuma evolu√ß√£o de enfermagem encontrada para este paciente.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Erro ao carregar datas das evolu√ß√µes:', error);
                    alert('Erro ao carregar as datas das evolu√ß√µes. Tente novamente.');
                }
            });
        }

        // Fun√ß√£o para mostrar a modal de sele√ß√£o de data
        function mostrarModalSelecaoData(datas) {
            // Criar modal dinamicamente
            let modalHtml = `
                <div class="modal fade" id="modalSelecaoData" tabindex="-1" aria-labelledby="modalSelecaoDataLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #28a745, #34ce57); color: white;">
                                <h5 class="modal-title" id="modalSelecaoDataLabel">
                                    <i class="fas fa-calendar-day me-2"></i>Selecionar Data das Evolu√ß√µes
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted mb-3">
                                    Selecione a data das evolu√ß√µes de enfermagem que deseja imprimir:
                                </p>
                                <div class="list-group" id="listaDatas">
                                    ${datas.map(data => `
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-calendar-day text-primary me-2"></i>
                                                <strong>${data.data_display}</strong>
                                                <span class="text-muted ms-2">(${data.quantidade} evolu√ß√£o${data.quantidade > 1 ? '√µes' : '√£o'})</span>
                                            </div>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="imprimirEvolucaoData('${data.data}')">
                                                    <i class="fas fa-print me-1"></i> Imprimir todas
                                                </button>
                                                <button type="button" class="btn btn-sm btn-primary" onclick="selecionarEvolucaoIndividual('${data.data}')">
                                                    <i class="fas fa-list me-1"></i> Selecionar evolu√ß√£o
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            $('#modalSelecaoData').remove();
            
            // Adicionar modal ao body
            $('body').append(modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalSelecaoData'));
            modal.show();
        }

        // Abrir sele√ß√£o de evolu√ß√£o individual de uma data
        function selecionarEvolucaoIndividual(data) {
            $.ajax({
                url: `/api/enfermagem/evolucoes/lista/${atendimentoId}?data=${data}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.evolucoes && response.evolucoes.length > 0) {
                        mostrarModalSelecaoEvolucao(response.evolucoes, data);
                    } else {
                        alert('Nenhuma evolu√ß√£o encontrada para a data selecionada.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Erro ao carregar evolu√ß√µes:', error);
                    alert('Erro ao carregar evolu√ß√µes. Tente novamente.');
                }
            });
        }

        // Modal para escolher qual evolu√ß√£o imprimir
        function mostrarModalSelecaoEvolucao(evolucoes, data) {
            let evolucoesHtml = evolucoes.map(ev => `
                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        onclick="imprimirEvolucaoIndividual(${ev.id})">
                    <div class="text-start">
                        <div><strong><i class="fas fa-clock me-2"></i>${ev.data_display}</strong></div>
                        <div class="small text-muted"><i class="fas fa-user-nurse me-1"></i>${ev.enfermeiro_nome || 'Enfermagem'}</div>
                        ${ev.preview ? `<div class="small text-truncate" style="max-width: 420px;">${ev.preview}</div>` : ''}
                    </div>
                    <i class="fas fa-print text-primary"></i>
                </button>
            `).join('');

            let modalHtml = `
                <div class="modal fade" id="modalSelecaoEvolucao" tabindex="-1" aria-labelledby="modalSelecaoEvolucaoLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #2878a7, #2878a7); color: white;">
                                <h5 class="modal-title" id="modalSelecaoEvolucaoLabel">
                                    <i class="fas fa-list me-2"></i>Escolher Evolu√ß√£o do dia ${new Date(data).toLocaleDateString('pt-BR')}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    ${evolucoesHtml}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#modalSelecaoEvolucao').remove();
            $('body').append(modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('modalSelecaoEvolucao'));
            modal.show();
        }

        // Abrir impress√£o individual de evolu√ß√£o de enfermagem
        function imprimirEvolucaoIndividual(evolucaoId) {
            try {
                const url = `/api/imprimir-evolucao-enfermagem-html/${evolucaoId}`;
                $('#modalSelecaoEvolucao').modal('hide');
                $('#modalSelecaoData').modal('hide');
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir impress√£o individual:', error);
                alert('Erro ao abrir a p√°gina de impress√£o. Tente novamente.');
            }
        }

        // Fun√ß√£o para imprimir evolu√ß√µes de uma data espec√≠fica
        function imprimirEvolucaoData(data) {
            console.log('üñ®Ô∏è Imprimindo evolu√ß√µes da data:', data);
            try {
                const url = `/imprimir/evolucoes_enfermagem/${atendimentoId}?data=${data}`;
                console.log('üîó Abrindo URL de impress√£o:', url);
                
                // Fechar modal
                $('#modalSelecaoData').modal('hide');
                
                // Abrir p√°gina de impress√£o
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir impress√£o:', error);
                alert('Erro ao abrir a p√°gina de impress√£o. Tente novamente.');
            }
        }

        function imprimirPrescricoes() {
            console.log('üñ®Ô∏è Imprimir prescri√ß√µes de enfermagem');
            // Buscar as datas dispon√≠veis
            carregarDatasPrescricoes();
        }

        function visualizarPrescricoes() {
            console.log('üëÅÔ∏è Visualizar prescri√ß√µes de enfermagem');
            // Buscar as datas dispon√≠veis
            carregarDatasPrescricoes();
        }

        // Fun√ß√£o para carregar as datas dispon√≠veis das prescri√ß√µes
        function carregarDatasPrescricoes() {
            console.log('üìÖ Carregando datas das prescri√ß√µes...');
            
            $.ajax({
                url: `/api/enfermagem/prescricoes/datas/${atendimentoId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.datas && response.datas.length > 0) {
                        mostrarModalSelecaoDataPrescricoes(response.datas);
                    } else {
                        alert('Nenhuma prescri√ß√£o de enfermagem encontrada para este paciente.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Erro ao carregar datas das prescri√ß√µes:', error);
                    alert('Erro ao carregar as datas das prescri√ß√µes. Tente novamente.');
                }
            });
        }

        // Fun√ß√£o para mostrar a modal de sele√ß√£o de data para prescri√ß√µes
        function mostrarModalSelecaoDataPrescricoes(datas) {
            // Criar modal dinamicamente
            let modalHtml = `
                <div class="modal fade" id="modalSelecaoDataPrescricoes" tabindex="-1" aria-labelledby="modalSelecaoDataPrescricoesLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
                                <h5 class="modal-title" id="modalSelecaoDataPrescricoesLabel">
                                    <i class="fas fa-clipboard-list me-2"></i>Selecionar Data das Prescri√ß√µes
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted mb-3">
                                    Selecione a data das prescri√ß√µes de enfermagem que deseja imprimir:
                                </p>
                                <div class="list-group" id="listaDatasPrescricoes">
                                    ${datas.map(data => `
                                        <button type="button" 
                                                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                                onclick="imprimirPrescricaoData('${data.data}')">
                                            <div>
                                                <i class="fas fa-clipboard-list text-primary me-2"></i>
                                                <strong>${data.data_display}</strong>
                                            </div>
                                            <div>
                                                <span class="badge bg-primary rounded-pill">${data.quantidade} prescri√ß√£o${data.quantidade > 1 ? '' : ''}</span>
                                                <i class="fas fa-chevron-right text-muted ms-2"></i>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            $('#modalSelecaoDataPrescricoes').remove();
            
            // Adicionar modal ao body
            $('body').append(modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalSelecaoDataPrescricoes'));
            modal.show();
        }

        // Fun√ß√£o para imprimir prescri√ß√µes de uma data espec√≠fica
        function imprimirPrescricaoData(data) {
            console.log('üñ®Ô∏è Imprimindo prescri√ß√µes da data:', data);
            try {
                const url = `/imprimir/prescricoes_enfermagem/${atendimentoId}?data=${data}`;
                console.log('üîó Abrindo URL de impress√£o:', url);
                
                // Fechar modal
                $('#modalSelecaoDataPrescricoes').modal('hide');
                
                // Abrir p√°gina de impress√£o
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir impress√£o:', error);
                alert('Erro ao abrir a p√°gina de impress√£o. Tente novamente.');
            }
        }

        function imprimirSae() {
            console.log('üñ®Ô∏è Imprimir SAE de enfermagem');
            try {
                const url = `/imprimir/sae_enfermagem/${atendimentoId}`;
                console.log('üîó Abrindo URL de impress√£o:', url);
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir impress√£o:', error);
                alert('Erro ao abrir a p√°gina de impress√£o. Tente novamente.');
            }
        }

        function visualizarSae() {
            console.log('üëÅÔ∏è Visualizar SAE de enfermagem');
            try {
                const url = `/imprimir/sae_enfermagem/${atendimentoId}`;
                console.log('üîó Abrindo URL de visualiza√ß√£o:', url);
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir visualiza√ß√£o:', error);
                alert('Erro ao abrir a p√°gina de visualiza√ß√£o. Tente novamente.');
            }
        }

        function imprimirAdmissao() {
            console.log('üñ®Ô∏è Imprimir admiss√£o de enfermagem');
            try {
                const url = `/imprimir/admissao_enfermagem/${atendimentoId}`;
                console.log('üîó Abrindo URL de impress√£o:', url);
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir impress√£o:', error);
                alert('Erro ao abrir a p√°gina de impress√£o. Tente novamente.');
            }
        }

        function visualizarAdmissao() {
            console.log('üëÅÔ∏è Visualizar admiss√£o de enfermagem');
            try {
                const url = `/imprimir/admissao_enfermagem/${atendimentoId}`;
                console.log('üîó Abrindo URL de visualiza√ß√£o:', url);
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir visualiza√ß√£o:', error);
                alert('Erro ao abrir a p√°gina de visualiza√ß√£o. Tente novamente.');
            }
        }

        // Novas fun√ß√µes para os termos e ficha do acompanhante
        function imprimirFichaIdentificacao() {
            console.log('üñ®Ô∏è Imprimir ficha de identifica√ß√£o do paciente');
            try {
                const url = `/imprimir/identificacao_paciente/${atendimentoId}`;
                console.log('üîó Abrindo URL de impress√£o:', url);
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir impress√£o:', error);
                alert('Erro ao abrir a p√°gina de impress√£o. Tente novamente.');
            }
        }

        function visualizarFichaIdentificacao() {
            console.log('üëÅÔ∏è Visualizar ficha de identifica√ß√£o do paciente');
            try {
                const url = `/imprimir/identificacao_paciente/${atendimentoId}`;
                console.log('üîó Abrindo URL de visualiza√ß√£o:', url);
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir visualiza√ß√£o:', error);
                alert('Erro ao abrir a p√°gina de visualiza√ß√£o. Tente novamente.');
            }
        }

        // Fun√ß√£o para imprimir a ficha de admiss√£o hospitalar
        function imprimirFichaAdmissao() {
            console.log('üñ®Ô∏è Imprimir ficha de admiss√£o hospitalar');
            try {
                const url = `/imprimir/ficha_admissao/${atendimentoId}`;
                console.log('üîó Abrindo URL de impress√£o:', url);
                window.open(url, '_blank');
            } catch (error) {
                console.error('‚ùå Erro ao abrir impress√£o:', error);
                alert('Erro ao abrir a p√°gina de impress√£o. Tente novamente.');
            }
        }

        // Fun√ß√£o para imprimir a √∫ltima evolu√ß√£o registrada
        function imprimirUltimaEvolucao() {
            console.log('üñ®Ô∏è Imprimir √∫ltima evolu√ß√£o registrada');
            $.ajax({
                url: `/api/ultima-evolucao-id/${atendimentoId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.evolucao_id) {
                        const url = `/api/imprimir-evolucao-html/${response.evolucao_id}`;
                        window.open(url, '_blank');
                    } else {
                        alert('Nenhuma evolu√ß√£o encontrada para este atendimento.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Erro ao buscar √∫ltima evolu√ß√£o:', error);
                    alert('Erro ao buscar a √∫ltima evolu√ß√£o. Tente novamente.');
                }
            });
        }

        // ==== Lobby: A√ß√µes de impress√£o m√©dica auxiliadas pela Enfermagem ====
        function abrirFichaAdmissao() {
            try {
                const url = `/imprimir/ficha_admissao/${atendimentoId}`;
                window.open(url, '_blank');
            } catch (e) {
                console.error('Erro ao abrir Ficha de Admiss√£o:', e);
                alert('Erro ao abrir a Ficha de Admiss√£o.');
            }
        }

        function abrirAIH() {
            try {
                const url = `/imprimir/aih/${atendimentoId}`;
                window.open(url, '_blank');
            } catch (e) {
                console.error('Erro ao abrir AIH:', e);
                alert('Erro ao abrir a AIH.');
            }
        }

        // Carregar informa√ß√µes do paciente se n√£o estiverem dispon√≠veis do backend
        $(document).ready(function() {
            console.log('üìÑ P√°gina de impress√µes carregada para atendimento:', atendimentoId);
            
            // Se as informa√ß√µes do paciente n√£o est√£o carregadas, buscar via AJAX
            if ($('#paciente-nome').text().includes('Carregando')) {
                carregarInformacoesPaciente();
            }
        });

        function carregarInformacoesPaciente() {
            console.log(' Carregando informa√ß√µes do paciente via AJAX...');
            
            $.ajax({
                url: `/api/paciente-por-atendimento/${atendimentoId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.paciente) {
                        const p = response.paciente;
                        $('#paciente-nome').text(p.nome || '-');
                        $('#paciente-cpf').text(p.cpf || '-');
                        $('#paciente-sus').text(p.cartao_sus || '-');
                        $('#paciente-sexo').text(p.sexo || '-');
                        $('#paciente-nascimento').text(p.data_nascimento ? new Date(p.data_nascimento).toLocaleDateString('pt-BR') : '-');
                        $('#paciente-telefone').text(p.telefone || '-');
                        $('#paciente-endereco').text(p.endereco || '-');
                        $('#paciente-municipio').text(p.municipio || '-');
                        $('#atendimento-id').text(atendimentoId);
                        
                        console.log('‚úÖ Informa√ß√µes do paciente carregadas com sucesso');
                    } else {
                        console.error('‚ùå Erro ao carregar informa√ß√µes do paciente:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Erro na requisi√ß√£o AJAX:', error);
                    $('.paciente-info').prepend('<div class="alert alert-warning">N√£o foi poss√≠vel carregar todas as informa√ß√µes do paciente.</div>');
                }
            });
        }
    </script>
</body>
</html> 