{% extends 'base_funcionarios.html' %}

{% block title %}Administração - HSOP{% endblock %}

{% block styles %}
<style>
    .kpi-card {
        border: none;
        border-left: 4px solid #0d6efd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        transition: all .2s;
    }
    .kpi-card:hover {
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    .kpi-icon {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        background: rgba(13,110,253,.1);
        color: #0d6efd;
        font-size: 1.1rem;
    }
    .card-header-min {
        padding: .4rem .6rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        font-size: .85rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .expand-icon {
        cursor: pointer;
        opacity: .5;
        transition: opacity .2s;
    }
    .expand-icon:hover { opacity: 1; }
    .table-sm td, .table-sm th { padding: .35rem .5rem; font-size: .85rem; }
    .muted { color: #6c757d; font-size: .8rem; }
    .topbar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        border-bottom: 1px solid #e9ecef;
        padding: .4rem 1rem;
        margin: 0 -1rem 0 -1rem;
    }
    .compact .card-body { padding: .5rem; }
    .compact .h3 { font-size: 1.2rem; margin-bottom: 0; }
    .compact .h5 { font-size: 1rem; margin-bottom: 0; }
    .scroll-section { max-height: 180px; overflow: auto; }
    .mini-chart-container { height: 80px; position: relative; cursor: pointer; }
    .clickable-card { cursor: pointer; transition: all .2s; }
    .clickable-card:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
    .stat-label { font-size: .75rem; color: #6c757d; margin-bottom: .1rem; }
    .stat-value { font-size: 1.1rem; font-weight: 600; }
    @media (min-width: 1400px) {
        .col-xxl-3 { flex: 0 0 auto; width: 25%; }
        .col-xxl-4 { flex: 0 0 auto; width: 33.333333%; }
        .col-xxl-6 { flex: 0 0 auto; width: 50%; }
        .col-xxl-2-4 { flex: 0 0 auto; width: 20%; }
    }
</style>
{% endblock %}

{% block content %}
<div class="py-2 compact">
    <div class="topbar d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
            <h2 class="h5 mb-0 me-2">Painel do Gestor</h2>
            <span class="muted">Visão geral operacional e técnica do hospital</span>
        </div>
        <div class="text-end muted">
            Atualizado em: <span id="dsb-now">-</span>
        </div>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Internações hoje</div>
                        <div class="stat-value">{{ total_internacoes_hoje|default(0) }}</div>
                    </div>
                    <div class="kpi-icon"><i class="fas fa-hospital-user"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#20c997">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Ocupação leitos</div>
                        <div class="stat-value">{{ taxa_ocupacao|default(0) }}%</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(32,201,151,.1);color:#20c997"><i class="fas fa-procedures"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#fd7e14">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Tempo médio perm.</div>
                        <div class="stat-value">{{ tempo_medio_permanencia|default(0) }}d</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(253,126,20,.1);color:#fd7e14"><i class="fas fa-clock"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#dc3545">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Em observação</div>
                        <div class="stat-value">{{ pacientes_observacao|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(220,53,69,.1);color:#dc3545"><i class="fas fa-heartbeat"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#6f42c1">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Atend. hoje</div>
                        <div class="stat-value">{{ total_atendimentos_hoje|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(111,66,193,.1);color:#6f42c1"><i class="fas fa-users"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#ffc107">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Aguard. triagem</div>
                        <div class="stat-value">{{ aguardando_triagem|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(255,193,7,.1);color:#ffc107"><i class="fas fa-hourglass-half"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#17a2b8">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Aguard. médico</div>
                        <div class="stat-value">{{ aguardando_medico|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(23,162,184,.1);color:#17a2b8"><i class="fas fa-user-md"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandChartRisco()">
                <div class="card-header-min">
                    <span>Classificação de risco</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="mini-chart-container">
                        <canvas id="chartClassificacaoRisco" aria-label="Gráfico de atendimentos por classificação de risco" role="img"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandChartFluxo()">
                <div class="card-header-min">
                    <span>Entradas x Altas (7d)</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="mini-chart-container">
                        <canvas id="chartFluxo" aria-label="Gráfico de entradas e altas na última semana" role="img"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandChartHora()">
                <div class="card-header-min">
                    <span>Atendimentos por hora</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="mini-chart-container">
                        <canvas id="chartAtendimentosHora" aria-label="Gráfico de atendimentos por hora no dia" role="img"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandTemposMedios()">
                <div class="card-header-min">
                    <span>Tempos médios (min)</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="row text-center" style="font-size: .75rem;">
                        <div class="col-4">
                            <div class="stat-label" style="font-size: .65rem;">Triagem</div>
                            <div class="stat-value" style="font-size: .9rem;">{{ tempo_medio_triagem|default(0) }}</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label" style="font-size: .65rem;">Consulta</div>
                            <div class="stat-value" style="font-size: .9rem;">{{ tempo_medio_consulta|default(0) }}</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label" style="font-size: .65rem;">Total</div>
                            <div class="stat-value" style="font-size: .9rem;">{{ tempo_medio_total|default(0) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header-min">
                    <span>Alertas técnicos em fichas</span>
                    <span class="badge bg-danger">{{ alertas_tecnicos|default([])|length }}</span>
                </div>
                <div class="card-body p-0 scroll-section">
                    <div class="table-responsive mb-0">
                        <table class="table table-sm mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Paciente</th>
                                    <th>Atend.</th>
                                    <th>Problema</th>
                                    <th class="text-end">Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alerta in alertas_tecnicos|default([]) %}
                                <tr>
                                    <td>{{ alerta.paciente }}</td>
                                    <td>#{{ alerta.atendimento_id }}</td>
                                    <td>{{ alerta.problema }}</td>
                                    <td class="text-end">
                                        <a href="{{ alerta.url|default('#') }}" class="btn btn-sm btn-outline-primary py-0 px-1">Ver</a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-2">Sem alertas</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header-min">
                    <span>Últimas alterações técnicas</span>
                </div>
                <div class="card-body p-0 scroll-section">
                    <ul class="list-group list-group-flush mb-0">
                        {% for alt in ultimas_alteracoes|default([]) %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
                            <div>
                                <div style="font-size:.85rem;"><strong>{{ alt.titulo }}</strong></div>
                                <div class="muted">{{ alt.usuario }} • {{ alt.data }}</div>
                            </div>
                            <a href="{{ alt.url|default('#') }}" class="btn btn-sm btn-outline-secondary py-0 px-1">Ver</a>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted py-2">Nenhuma alteração recente</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header-min">
            <span>Ações rápidas do gestor</span>
        </div>
        <div class="card-body p-2">
            <div class="row g-2">
                <div class="col-6 col-md-3">
                    <a href="{{ url_for('index') if false else '#' }}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-database"></i> Normalizar CID
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-link"></i> Vincular atend.
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-file-medical-alt"></i> Corrigir prescrições
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-user-shield"></i> Revisar permissões
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para expandir gráfico de classificação de risco -->
<div class="modal fade" id="modalRisco" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Análise de Classificação de Risco</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div style="height: 400px; position: relative;">
                            <canvas id="chartModalRisco"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <h6 class="font-weight-bold mb-3">Detalhamento por Classificação</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Classificação</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">%</th>
                                        <th class="text-center">Tempo Médio</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaRiscoDetalhes">
                                    <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <h6 class="font-weight-bold mb-2">Indicadores</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total de atendimentos:</strong> <span id="riscoTotalAtend">-</span></li>
                            <li><strong>Casos urgentes (Vermelho):</strong> <span id="riscoVermelho">-</span></li>
                            <li><strong>Tempo médio de espera:</strong> <span id="riscoTempoMedio">-</span> min</li>
                            <li><strong>Taxa de urgência:</strong> <span id="riscoTaxaUrgente">-</span>%</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para expandir gráfico de fluxo -->
<div class="modal fade" id="modalFluxo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> Análise de Fluxo - Entradas x Altas</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div style="height: 400px; position: relative;">
                            <canvas id="chartModalFluxo"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <h6 class="font-weight-bold mb-3">Análise Diária (Últimos 7 dias)</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Data</th>
                                        <th class="text-center">Entradas</th>
                                        <th class="text-center">Altas</th>
                                        <th class="text-center">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaFluxoDetalhes">
                                    <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <h6 class="font-weight-bold mb-2">Estatísticas do Período</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total de entradas:</strong> <span id="fluxoTotalEntradas">-</span></li>
                            <li><strong>Total de altas:</strong> <span id="fluxoTotalAltas">-</span></li>
                            <li><strong>Saldo líquido:</strong> <span id="fluxoSaldo">-</span></li>
                            <li><strong>Média de entradas/dia:</strong> <span id="fluxoMediaEntradas">-</span></li>
                            <li><strong>Taxa de ocupação:</strong> <span id="fluxoTaxaOcupacao">-</span>%</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para expandir gráfico de atendimentos por hora -->
<div class="modal fade" id="modalHora" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-clock"></i> Análise de Atendimentos por Hora</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div style="height: 400px; position: relative;">
                            <canvas id="chartModalHora"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <h6 class="font-weight-bold mb-3">Distribuição Horária</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Período</th>
                                        <th>Horário</th>
                                        <th class="text-center">Atendimentos</th>
                                        <th class="text-center">%</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaHoraDetalhes">
                                    <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <h6 class="font-weight-bold mb-2">Picos de Atendimento</h6>
                        <ul class="list-unstyled">
                            <li><strong>Horário de pico:</strong> <span id="horaPico">-</span></li>
                            <li><strong>Atendimentos no pico:</strong> <span id="horaPicoQtd">-</span></li>
                            <li><strong>Horário mais vazio:</strong> <span id="horaVazio">-</span></li>
                            <li><strong>Média por hora:</strong> <span id="horaMedia">-</span></li>
                            <li><strong>Período mais movimentado:</strong> <span id="horaPeriodo">-</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para análise de tempos médios -->
<div class="modal fade" id="modalTemposMedios" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-stopwatch"></i> Análise de Tempos Médios de Atendimento</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-lg-6">
                        <h6 class="font-weight-bold mb-3">Tempos por Etapa do Fluxo</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Etapa</th>
                                        <th class="text-center">Tempo Médio</th>
                                        <th class="text-center">Atendimentos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-clipboard-check text-primary"></i> <strong>Triagem</strong></td>
                                        <td class="text-center"><span class="badge badge-primary">{{ tempo_medio_triagem|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_triagem|default(0) }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-user-md text-success"></i> <strong>Consulta Médica</strong></td>
                                        <td class="text-center"><span class="badge badge-success">{{ tempo_medio_consulta|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_consulta|default(0) }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-eye text-info"></i> <strong>Observação</strong></td>
                                        <td class="text-center"><span class="badge badge-info">{{ tempo_medio_observacao|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_observacao|default(0) }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-bed text-warning"></i> <strong>Internação</strong></td>
                                        <td class="text-center"><span class="badge badge-warning">{{ tempo_medio_internacao|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_internacao|default(0) }}</td>
                                    </tr>
                                    <tr class="table-active">
                                        <td><i class="fas fa-clock text-dark"></i> <strong>Tempo Total</strong></td>
                                        <td class="text-center"><span class="badge badge-dark">{{ tempo_medio_total|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_finalizados|default(0) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <h6 class="font-weight-bold mb-3">Tempo de Espera por Classificação de Risco</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Classificação</th>
                                        <th class="text-center">Tempo até Consulta</th>
                                        <th class="text-center">Casos</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaTemposPorRisco">
                                    {% if tempos_por_risco %}
                                        {% for item in tempos_por_risco %}
                                        <tr>
                                            <td><strong>{{ item.classificacao }}</strong></td>
                                            <td class="text-center">{{ item.tempo_medio }} min</td>
                                            <td class="text-center">{{ item.quantidade }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="font-weight-bold mb-3">Gráfico de Tempos Médios por Etapa</h6>
                        <div style="height: 300px; position: relative;">
                            <canvas id="chartTemposMedios"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    (function() {
        var chartInstances = {};
        var modalChart = null;

        var nowEl = document.getElementById('dsb-now');
        if (nowEl) {
            var now = new Date();
            nowEl.textContent = now.toLocaleString('pt-BR');
        }

        // Armazenar dados para análise
        var dadosAnalise = {
            risco: { labels: [], valores: [], datas: [] },
            fluxo: { labels: [], entradas: [], altas: [], datas: [] },
            hora: { labels: [], valores: [] }
        };

        // Função para expandir gráfico de RISCO com análise
        window.expandChartRisco = function() {
            var labelsRisco = dadosAnalise.risco.labels;
            var dataRisco = dadosAnalise.risco.valores;
            
            if (labelsRisco.length === 0) return;

            // Criar gráfico expandido
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartModalRisco').getContext('2d');
            modalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labelsRisco,
                    datasets: [{
                        data: dataRisco,
                        backgroundColor: labelsRisco.map(function(l) {
                            var cores = {
                                'Vermelho': 'rgba(220,53,69,0.7)',
                                'Laranja': 'rgba(253,126,20,0.7)',
                                'Amarelo': 'rgba(255,193,7,0.7)',
                                'Verde': 'rgba(32,201,151,0.7)',
                                'Azul': 'rgba(13,110,253,0.7)',
                                'Não classificado': 'rgba(108,117,125,0.7)'
                            };
                            return cores[l] || 'rgba(108,117,125,0.7)';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Popular tabela de detalhes
            var total = dataRisco.reduce(function(a, b) { return a + b; }, 0);
            var tbody = $('#tabelaRiscoDetalhes');
            tbody.empty();
            
            for (var i = 0; i < labelsRisco.length; i++) {
                var perc = total > 0 ? ((dataRisco[i] / total) * 100).toFixed(1) : 0;
                var tempoMedio = Math.floor(Math.random() * 40) + 15; // Placeholder
                tbody.append(
                    '<tr><td><strong>' + labelsRisco[i] + '</strong></td>' +
                    '<td class="text-center">' + dataRisco[i] + '</td>' +
                    '<td class="text-center">' + perc + '%</td>' +
                    '<td class="text-center">' + tempoMedio + ' min</td></tr>'
                );
            }

            // Calcular indicadores
            var vermelho = dataRisco[labelsRisco.indexOf('Vermelho')] || 0;
            var taxaUrgente = total > 0 ? ((vermelho / total) * 100).toFixed(1) : 0;
            
            $('#riscoTotalAtend').text(total);
            $('#riscoVermelho').text(vermelho);
            $('#riscoTempoMedio').text(Math.floor(Math.random() * 20) + 25); // Placeholder
            $('#riscoTaxaUrgente').text(taxaUrgente);

            $('#modalRisco').modal('show');
        };

        // Função para expandir gráfico de FLUXO com análise
        window.expandChartFluxo = function() {
            var labelsFluxo = dadosAnalise.fluxo.labels;
            var entradas = dadosAnalise.fluxo.entradas;
            var altas = dadosAnalise.fluxo.altas;
            
            if (labelsFluxo.length === 0) return;

            // Criar gráfico expandido
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartModalFluxo').getContext('2d');
            modalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsFluxo,
                    datasets: [
                        { label: 'Entradas', data: entradas, backgroundColor: 'rgba(32,201,151,0.7)', borderColor: '#20c997', borderWidth: 2 },
                        { label: 'Altas', data: altas, backgroundColor: 'rgba(253,126,20,0.7)', borderColor: '#fd7e14', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Popular tabela de detalhes
            var tbody = $('#tabelaFluxoDetalhes');
            tbody.empty();
            var totalEntradas = 0, totalAltas = 0;
            
            for (var i = 0; i < labelsFluxo.length; i++) {
                var saldo = entradas[i] - altas[i];
                var saldoClass = saldo > 0 ? 'text-success' : (saldo < 0 ? 'text-danger' : '');
                totalEntradas += entradas[i];
                totalAltas += altas[i];
                
                tbody.append(
                    '<tr><td>' + labelsFluxo[i] + '</td>' +
                    '<td class="text-center text-success"><strong>' + entradas[i] + '</strong></td>' +
                    '<td class="text-center text-danger"><strong>' + altas[i] + '</strong></td>' +
                    '<td class="text-center ' + saldoClass + '"><strong>' + (saldo > 0 ? '+' : '') + saldo + '</strong></td></tr>'
                );
            }

            // Calcular estatísticas
            var saldoLiquido = totalEntradas - totalAltas;
            var mediaEntradas = (totalEntradas / labelsFluxo.length).toFixed(1);
            var taxaOcup = {{ taxa_ocupacao|default(0) }};
            
            $('#fluxoTotalEntradas').text(totalEntradas);
            $('#fluxoTotalAltas').text(totalAltas);
            $('#fluxoSaldo').text((saldoLiquido > 0 ? '+' : '') + saldoLiquido);
            $('#fluxoMediaEntradas').text(mediaEntradas);
            $('#fluxoTaxaOcupacao').text(taxaOcup);

            $('#modalFluxo').modal('show');
        };

        // Função para expandir gráfico de HORA com análise
        window.expandChartHora = function() {
            var labelsHora = dadosAnalise.hora.labels;
            var valoresHora = dadosAnalise.hora.valores;
            
            if (labelsHora.length === 0) return;

            // Criar gráfico expandido
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartModalHora').getContext('2d');
            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labelsHora,
                    datasets: [{
                        label: 'Atendimentos',
                        data: valoresHora,
                        backgroundColor: 'rgba(13,110,253,0.2)',
                        borderColor: 'rgba(13,110,253,1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Popular tabela de detalhes
            var tbody = $('#tabelaHoraDetalhes');
            tbody.empty();
            var total = valoresHora.reduce(function(a, b) { return a + b; }, 0);
            var maxValor = Math.max.apply(null, valoresHora);
            var minValor = Math.min.apply(null, valoresHora);
            var horaMaxIdx = valoresHora.indexOf(maxValor);
            var horaMinIdx = valoresHora.indexOf(minValor);
            
            var periodos = {
                'Madrugada': [0, 1, 2, 3, 4, 5],
                'Manhã': [6, 7, 8, 9, 10, 11],
                'Tarde': [12, 13, 14, 15, 16, 17],
                'Noite': [18, 19, 20, 21, 22, 23]
            };
            
            for (var periodo in periodos) {
                var horas = periodos[periodo];
                var totalPeriodo = 0;
                for (var j = 0; j < horas.length; j++) {
                    totalPeriodo += valoresHora[horas[j]];
                }
                var percPeriodo = total > 0 ? ((totalPeriodo / total) * 100).toFixed(1) : 0;
                var horaInicio = horas[0];
                var horaFim = horas[horas.length - 1];
                
                tbody.append(
                    '<tr><td><strong>' + periodo + '</strong></td>' +
                    '<td>' + horaInicio + 'h - ' + horaFim + 'h</td>' +
                    '<td class="text-center">' + totalPeriodo + '</td>' +
                    '<td class="text-center">' + percPeriodo + '%</td></tr>'
                );
            }

            // Calcular estatísticas
            var media = total > 0 ? (total / 24).toFixed(1) : 0;
            var periodoMax = '';
            var maxPeriodo = 0;
            for (var p in periodos) {
                var somaPer = 0;
                for (var k = 0; k < periodos[p].length; k++) {
                    somaPer += valoresHora[periodos[p][k]];
                }
                if (somaPer > maxPeriodo) {
                    maxPeriodo = somaPer;
                    periodoMax = p;
                }
            }
            
            $('#horaPico').text(labelsHora[horaMaxIdx]);
            $('#horaPicoQtd').text(maxValor);
            $('#horaVazio').text(labelsHora[horaMinIdx]);
            $('#horaMedia').text(media);
            $('#horaPeriodo').text(periodoMax + ' (' + maxPeriodo + ' atendimentos)');

            $('#modalHora').modal('show');
        };

        // Função para expandir análise de tempos médios
        window.expandTemposMedios = function() {
            // Criar gráfico de barras com os tempos por etapa
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartTemposMedios').getContext('2d');
            
            var tempos = {
                labels: ['Triagem', 'Consulta Médica', 'Observação', 'Internação', 'Tempo Total'],
                valores: [
                    {{ tempo_medio_triagem|default(0) }},
                    {{ tempo_medio_consulta|default(0) }},
                    {{ tempo_medio_observacao|default(0) }},
                    {{ tempo_medio_internacao|default(0) }},
                    {{ tempo_medio_total|default(0) }}
                ]
            };
            
            modalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tempos.labels,
                    datasets: [{
                        label: 'Tempo Médio (minutos)',
                        data: tempos.valores,
                        backgroundColor: [
                            'rgba(13,110,253,0.7)',
                            'rgba(32,201,151,0.7)',
                            'rgba(23,162,184,0.7)',
                            'rgba(255,193,7,0.7)',
                            'rgba(52,58,64,0.7)'
                        ],
                        borderColor: [
                            'rgba(13,110,253,1)',
                            'rgba(32,201,151,1)',
                            'rgba(23,162,184,1)',
                            'rgba(255,193,7,1)',
                            'rgba(52,58,64,1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minutos'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' minutos';
                                }
                            }
                        }
                    }
                }
            });

            $('#modalTemposMedios').modal('show');
        };

        var ctxRisco = document.getElementById('chartClassificacaoRisco');
        if (ctxRisco) {
            var labelsRisco = {{ porta_risco_labels|default([])|tojson }};
            var dataRisco = {{ porta_risco_valores|default([])|tojson }};
            
            // Se não houver dados, usar valores padrão para exibição
            if (labelsRisco.length === 0) {
                labelsRisco = ["Vermelho","Laranja","Amarelo","Verde","Azul","Não classificado"];
                dataRisco = [0,0,0,0,0,0];
            }
            var triageBg = {
                'Vermelho': 'rgba(220,53,69,0.2)',
                'Laranja': 'rgba(253,126,20,0.2)',
                'Amarelo': 'rgba(255,193,7,0.2)',
                'Verde': 'rgba(32,201,151,0.2)',
                'Azul': 'rgba(13,110,253,0.2)',
                'Não classificado': 'rgba(108,117,125,0.2)'
            };
            var triageBorder = {
                'Vermelho': 'rgba(220,53,69,1)',
                'Laranja': 'rgba(253,126,20,1)',
                'Amarelo': 'rgba(255,193,7,1)',
                'Verde': 'rgba(32,201,151,1)',
                'Azul': 'rgba(13,110,253,1)',
                'Não classificado': 'rgba(108,117,125,1)'
            };
            var bgColorsRisco = labelsRisco.map(function(l){ return triageBg[l] || 'rgba(13,110,253,0.2)'; });
            var borderColorsRisco = labelsRisco.map(function(l){ return triageBorder[l] || 'rgba(13,110,253,1)'; });
            
            // Armazenar dados para análise
            dadosAnalise.risco.labels = labelsRisco;
            dadosAnalise.risco.valores = dataRisco;
            
            chartInstances['chartClassificacaoRisco'] = new Chart(ctxRisco, {
                type: 'bar',
                data: {
                    labels: labelsRisco,
                    datasets: [{
                        label: 'Atendimentos',
                        data: dataRisco,
                        backgroundColor: bgColorsRisco,
                        borderColor: borderColorsRisco,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        var ctxFluxo = document.getElementById('chartFluxo');
        if (ctxFluxo) {
            var labelsFluxo = {{ fluxo_labels|default([])|tojson }};
            var entradas = {{ fluxo_entradas|default([])|tojson }};
            var altas = {{ fluxo_altas|default([])|tojson }};
            
            // Se não houver dados, usar valores padrão
            if (labelsFluxo.length === 0) {
                labelsFluxo = ["D-6","D-5","D-4","D-3","D-2","D-1","Hoje"];
                entradas = [0,0,0,0,0,0,0];
                altas = [0,0,0,0,0,0,0];
            }
            
            // Armazenar dados para análise
            dadosAnalise.fluxo.labels = labelsFluxo;
            dadosAnalise.fluxo.entradas = entradas;
            dadosAnalise.fluxo.altas = altas;
            
            chartInstances['chartFluxo'] = new Chart(ctxFluxo, {
                type: 'line',
                data: {
                    labels: labelsFluxo,
                    datasets: [
                        { label: 'Entradas', data: entradas, borderColor: '#20c997', backgroundColor: 'rgba(32,201,151,.15)', tension: .3, fill: true },
                        { label: 'Altas', data: altas, borderColor: '#fd7e14', backgroundColor: 'rgba(253,126,20,.15)', tension: .3, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        var ctxHora = document.getElementById('chartAtendimentosHora');
        if (ctxHora) {
            var labelsHora = {{ atend_hora_labels|default([])|tojson }};
            var valoresHora = {{ atend_hora_valores|default([])|tojson }};
            
            // Se não houver dados, usar valores padrão
            if (labelsHora.length === 0) {
                labelsHora = ["00h","01h","02h","03h","04h","05h","06h","07h","08h","09h","10h","11h","12h","13h","14h","15h","16h","17h","18h","19h","20h","21h","22h","23h"];
                valoresHora = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
            }
            
            // Armazenar dados para análise
            dadosAnalise.hora.labels = labelsHora;
            dadosAnalise.hora.valores = valoresHora;
            
            chartInstances['chartAtendimentosHora'] = new Chart(ctxHora, {
                type: 'bar',
                data: {
                    labels: labelsHora,
                    datasets: [{
                        label: 'Atendimentos',
                        data: valoresHora,
                        backgroundColor: 'rgba(13,110,253,0.2)',
                        borderColor: 'rgba(13,110,253,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    })();
    </script>
{% endblock %}


