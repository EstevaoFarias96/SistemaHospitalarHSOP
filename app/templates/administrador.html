{% extends 'base_funcionarios.html' %}

{% block title %}Administração - HSOP{% endblock %}

{% block styles %}
<style>
    .kpi-card {
        border: none;
        border-left: 4px solid #0d6efd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        transition: all .2s;
    }
    .kpi-card:hover {
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    .kpi-icon {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        background: rgba(13,110,253,.1);
        color: #0d6efd;
        font-size: 1.1rem;
    }
    .card-header-min {
        padding: .4rem .6rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        font-size: .85rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .expand-icon {
        cursor: pointer;
        opacity: .5;
        transition: opacity .2s;
    }
    .expand-icon:hover { opacity: 1; }
    .table-sm td, .table-sm th { padding: .35rem .5rem; font-size: .85rem; }
    .muted { color: #6c757d; font-size: .8rem; }
    .topbar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        border-bottom: 1px solid #e9ecef;
        padding: .4rem 1rem;
        margin: 0 -1rem 0 -1rem;
    }
    .compact .card-body { padding: .5rem; }
    .compact .h3 { font-size: 1.2rem; margin-bottom: 0; }
    .compact .h5 { font-size: 1rem; margin-bottom: 0; }
    .scroll-section { max-height: 180px; overflow: auto; }
    .mini-chart-container { height: 80px; position: relative; cursor: pointer; }
    .clickable-card { cursor: pointer; transition: all .2s; }
    .clickable-card:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
    .stat-label { font-size: .75rem; color: #6c757d; margin-bottom: .1rem; }
    .stat-value { font-size: 1.1rem; font-weight: 600; }
    @media (min-width: 1400px) {
        .col-xxl-3 { flex: 0 0 auto; width: 25%; }
        .col-xxl-4 { flex: 0 0 auto; width: 33.333333%; }
        .col-xxl-6 { flex: 0 0 auto; width: 50%; }
        .col-xxl-2-4 { flex: 0 0 auto; width: 20%; }
    }
    
    /* Modo TV */
    #modoTV {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #a8d5e2 0%, #6fb3d2 100%);
        z-index: 9999;
        display: none;
        overflow: hidden;
    }
    #modoTV.active { display: block; }
    
    .tv-header {
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
        padding: 1.5rem 3rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid rgba(255,255,255,0.2);
    }
    .tv-header h1 {
        color: white;
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .tv-header .info {
        color: rgba(255,255,255,0.9);
        font-size: 1.2rem;
        text-align: right;
    }
    .tv-slide {
        display: none;
        height: calc(100vh - 100px);
        padding: 3rem;
        animation: slideIn 0.5s ease-in-out;
    }
    .tv-slide.active { display: block; }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(50px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .tv-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        height: 100%;
        overflow: hidden;
    }
    .tv-kpi {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        color: white;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        transition: transform 0.3s;
    }
    .tv-kpi:hover { transform: translateY(-5px); }
    .tv-kpi-value {
        font-size: 3.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    .tv-kpi-label {
        font-size: 1.2rem;
        opacity: 0.95;
        font-weight: 500;
    }
    .tv-exit {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(220,53,69,0.9);
        border: none;
        color: white;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 10px;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transition: all 0.3s;
    }
    .tv-exit:hover {
        background: rgba(220,53,69,1);
        transform: scale(1.05);
    }
    .tv-progress {
        position: fixed;
        bottom: 0;
        left: 0;
        height: 5px;
        background: rgba(255,255,255,0.9);
        width: 0%;
        transition: width 0.1s linear;
        z-index: 10001;
    }
    .tv-table {
        width: 100%;
        margin-top: 1rem;
    }
    .tv-table thead {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        color: white;
    }
    .tv-table th {
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
    }
    .tv-table td {
        padding: 1rem;
        font-size: 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    .tv-table tbody tr:hover {
        background: rgba(74,144,226,0.05);
    }
    .tv-chart-container {
        height: 400px;
        position: relative;
        margin-top: 2rem;
    }
    .tv-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 2rem;
        text-align: center;
        border-bottom: 3px solid #667eea;
        padding-bottom: 1rem;
    }
    .badge-tv {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 8px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-2 compact">
    <div class="topbar d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
            <h2 class="h5 mb-0 me-2">Painel do Gestor</h2>
            <span class="muted">Visão geral operacional e técnica do hospital</span>
        </div>
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-primary me-2" onclick="iniciarModoTV()">
                <i class="fas fa-tv"></i> Modo TV
            </button>
            <div class="text-end muted">
                Atualizado em: <span id="dsb-now">-</span>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Internações hoje</div>
                        <div class="stat-value">{{ total_internacoes_hoje|default(0) }}</div>
                    </div>
                    <div class="kpi-icon"><i class="fas fa-hospital-user"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#20c997">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Ocupação leitos</div>
                        <div class="stat-value">{{ taxa_ocupacao|default(0) }}%</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(32,201,151,.1);color:#20c997"><i class="fas fa-procedures"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#fd7e14">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Tempo médio perm.</div>
                        <div class="stat-value">{{ tempo_medio_permanencia|default(0) }}d</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(253,126,20,.1);color:#fd7e14"><i class="fas fa-clock"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#dc3545">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Em observação</div>
                        <div class="stat-value">{{ pacientes_observacao|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(220,53,69,.1);color:#dc3545"><i class="fas fa-heartbeat"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#6f42c1">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Atend. hoje</div>
                        <div class="stat-value">{{ total_atendimentos_hoje|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(111,66,193,.1);color:#6f42c1"><i class="fas fa-users"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#ffc107">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Aguard. triagem</div>
                        <div class="stat-value">{{ aguardando_triagem|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(255,193,7,.1);color:#ffc107"><i class="fas fa-hourglass-half"></i></div>
                </div>
            </div>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xxl-2-4">
            <div class="card kpi-card h-100" style="border-left-color:#17a2b8">
                <div class="card-body d-flex align-items-center justify-content-between p-2">
                    <div>
                        <div class="stat-label">Aguard. médico</div>
                        <div class="stat-value">{{ aguardando_medico|default(0) }}</div>
                    </div>
                    <div class="kpi-icon" style="background:rgba(23,162,184,.1);color:#17a2b8"><i class="fas fa-user-md"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandChartRisco()">
                <div class="card-header-min">
                    <span>Classificação de risco</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="mini-chart-container">
                        <canvas id="chartClassificacaoRisco" aria-label="Gráfico de atendimentos por classificação de risco" role="img"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandChartFluxo()">
                <div class="card-header-min">
                    <span>Internações por dia (7d)</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="mini-chart-container">
                        <canvas id="chartFluxo" aria-label="Gráfico de internações na última semana" role="img"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandChartHora()">
                <div class="card-header-min">
                    <span>Atendimentos por hora</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="mini-chart-container">
                        <canvas id="chartAtendimentosHora" aria-label="Gráfico de atendimentos por hora no dia" role="img"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandTemposMedios()">
                <div class="card-header-min">
                    <span>Tempos médios (min)</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div class="row text-center" style="font-size: .75rem;">
                        <div class="col-4">
                            <div class="stat-label" style="font-size: .65rem;">Triagem</div>
                            <div class="stat-value" style="font-size: .9rem;">{{ tempo_medio_triagem|default(0) }}</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label" style="font-size: .65rem;">Consulta</div>
                            <div class="stat-value" style="font-size: .9rem;">{{ tempo_medio_consulta|default(0) }}</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label" style="font-size: .65rem;">Total</div>
                            <div class="stat-value" style="font-size: .9rem;">{{ tempo_medio_total|default(0) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 col-xxl-3">
            <div class="card clickable-card" onclick="expandTemposMedios()">
                <div class="card-header-min">
                    <span>Tempo por classificação (min)</span>
                    <i class="fas fa-expand-alt expand-icon"></i>
                </div>
                <div class="card-body p-2">
                    <div style="font-size: .7rem;">
                        {% if tempos_por_risco %}
                            {% for item in tempos_por_risco[:5] %}
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>
                                    {% if item.classificacao == 'Vermelho' %}
                                        <span class="badge badge-danger" style="font-size: .6rem;">{{ item.classificacao }}</span>
                                    {% elif item.classificacao == 'Laranja' %}
                                        <span class="badge badge-warning" style="font-size: .6rem;">{{ item.classificacao }}</span>
                                    {% elif item.classificacao == 'Amarelo' %}
                                        <span class="badge" style="background-color: #ffc107; color: #000; font-size: .6rem;">{{ item.classificacao }}</span>
                                    {% elif item.classificacao == 'Verde' %}
                                        <span class="badge badge-success" style="font-size: .6rem;">{{ item.classificacao }}</span>
                                    {% elif item.classificacao == 'Azul' %}
                                        <span class="badge badge-info" style="font-size: .6rem;">{{ item.classificacao }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary" style="font-size: .6rem;">{{ item.classificacao }}</span>
                                    {% endif %}
                                </span>
                                <span class="stat-value" style="font-size: .85rem;">{{ item.tempo_medio }}min</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted" style="font-size: .7rem; padding: 1rem 0;">Sem dados</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-2">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header-min">
                    <span>Últimas consultas realizadas</span>
                    <span class="badge bg-info">{{ ultimas_consultas|default([])|length }}</span>
                </div>
                <div class="card-body p-0 scroll-section">
                    <div class="table-responsive mb-0">
                        <table class="table table-sm mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Paciente</th>
                                    <th>Idade</th>
                                    <th>Risco</th>
                                    <th>Médico</th>
                                    <th>Enfermeiro</th>
                                    <th class="text-center">Tempo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for consulta in ultimas_consultas|default([]) %}
                                <tr>
                                    <td><strong>{{ consulta.paciente_nome }}</strong><br><small class="text-muted">#{{ consulta.id_atendimento }}</small></td>
                                    <td>{{ consulta.idade }} anos</td>
                                    <td>
                                        {% if consulta.classificacao_risco == 'Vermelho' %}
                                            <span class="badge badge-danger">Vermelho</span>
                                        {% elif consulta.classificacao_risco == 'Laranja' %}
                                            <span class="badge badge-warning">Laranja</span>
                                        {% elif consulta.classificacao_risco == 'Amarelo' %}
                                            <span class="badge" style="background-color: #ffc107; color: #000;">Amarelo</span>
                                        {% elif consulta.classificacao_risco == 'Verde' %}
                                            <span class="badge badge-success">Verde</span>
                                        {% elif consulta.classificacao_risco == 'Azul' %}
                                            <span class="badge badge-info">Azul</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ consulta.classificacao_risco }}</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ consulta.medico }}</small></td>
                                    <td><small>{{ consulta.enfermeiro }}</small></td>
                                    <td class="text-center"><strong>{{ consulta.tempo_consulta }}</strong> min</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-2">Nenhuma consulta registrada</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header-min">
                    <span>Últimos pacientes internados</span>
                    <span class="badge bg-primary">{{ ultimas_internacoes|default([])|length }}</span>
                </div>
                <div class="card-body p-0 scroll-section">
                    <div class="table-responsive mb-0">
                        <table class="table table-sm mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Paciente</th>
                                    <th>Diagnóstico</th>
                                    <th>Médico</th>
                                    <th class="text-center">Observ.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for internacao in ultimas_internacoes|default([]) %}
                                <tr>
                                    <td>
                                        <strong>{{ internacao.paciente_nome }}</strong><br>
                                        <small class="text-muted">{{ internacao.data_internacao }}</small><br>
                                        <small class="text-info">Leito: {{ internacao.leito }}</small>
                                    </td>
                                    <td><small>{{ internacao.diagnostico }}</small></td>
                                    <td><small>{{ internacao.medico }}</small></td>
                                    <td class="text-center">
                                        {% if internacao.estava_em_observacao %}
                                            <span class="badge badge-warning"><i class="fas fa-check"></i> Sim</span>
                                        {% else %}
                                            <span class="badge badge-secondary"><i class="fas fa-times"></i> Não</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-2">Nenhuma internação recente</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header-min">
            <span>Ações rápidas do gestor</span>
        </div>
        <div class="card-body p-2">
            <div class="row g-2">
                <div class="col-6 col-md-3">
                    <a href="{{ url_for('index') if false else '#' }}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-database"></i> Normalizar CID
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-link"></i> Vincular atend.
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-file-medical-alt"></i> Corrigir prescrições
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-user-shield"></i> Revisar permissões
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para expandir gráfico de classificação de risco -->
<div class="modal fade" id="modalRisco" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Análise de Classificação de Risco</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div style="height: 400px; position: relative;">
                            <canvas id="chartModalRisco"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <h6 class="font-weight-bold mb-3">Detalhamento por Classificação</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Classificação</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">%</th>
                                        <th class="text-center">Tempo Médio</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaRiscoDetalhes">
                                    <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <h6 class="font-weight-bold mb-2">Indicadores</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total de atendimentos:</strong> <span id="riscoTotalAtend">-</span></li>
                            <li><strong>Casos urgentes (Vermelho):</strong> <span id="riscoVermelho">-</span></li>
                            <li><strong>Tempo médio de espera:</strong> <span id="riscoTempoMedio">-</span> min</li>
                            <li><strong>Taxa de urgência:</strong> <span id="riscoTaxaUrgente">-</span>%</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para expandir gráfico de internações -->
<div class="modal fade" id="modalFluxo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-bed"></i> Análise de Internações por Dia</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div style="height: 400px; position: relative;">
                            <canvas id="chartModalFluxo"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <h6 class="font-weight-bold mb-3">Internações Diárias (Últimos 7 dias)</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Data</th>
                                        <th class="text-center">Internações</th>
                                        <th class="text-center">%</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaFluxoDetalhes">
                                    <tr><td colspan="3" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <h6 class="font-weight-bold mb-2">Estatísticas do Período</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total de internações:</strong> <span id="fluxoTotalEntradas">-</span></li>
                            <li><strong>Média por dia:</strong> <span id="fluxoMediaEntradas">-</span></li>
                            <li><strong>Dia com mais internações:</strong> <span id="fluxoDiaMaior">-</span></li>
                            <li><strong>Taxa de ocupação atual:</strong> <span id="fluxoTaxaOcupacao">-</span>%</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para expandir gráfico de atendimentos por hora -->
<div class="modal fade" id="modalHora" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-clock"></i> Análise de Atendimentos por Hora</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-7">
                        <div style="height: 400px; position: relative;">
                            <canvas id="chartModalHora"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <h6 class="font-weight-bold mb-3">Distribuição Horária</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Período</th>
                                        <th>Horário</th>
                                        <th class="text-center">Atendimentos</th>
                                        <th class="text-center">%</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaHoraDetalhes">
                                    <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <h6 class="font-weight-bold mb-2">Picos de Atendimento</h6>
                        <ul class="list-unstyled">
                            <li><strong>Horário de pico:</strong> <span id="horaPico">-</span></li>
                            <li><strong>Atendimentos no pico:</strong> <span id="horaPicoQtd">-</span></li>
                            <li><strong>Horário mais vazio:</strong> <span id="horaVazio">-</span></li>
                            <li><strong>Média por hora:</strong> <span id="horaMedia">-</span></li>
                            <li><strong>Período mais movimentado:</strong> <span id="horaPeriodo">-</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para análise de tempos médios -->
<div class="modal fade" id="modalTemposMedios" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-stopwatch"></i> Análise de Tempos Médios de Atendimento</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-lg-6">
                        <h6 class="font-weight-bold mb-3">Tempos por Etapa do Fluxo</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Etapa</th>
                                        <th class="text-center">Tempo Médio</th>
                                        <th class="text-center">Atendimentos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-clipboard-check text-primary"></i> <strong>Triagem</strong></td>
                                        <td class="text-center"><span class="badge badge-primary">{{ tempo_medio_triagem|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_triagem|default(0) }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-user-md text-success"></i> <strong>Consulta Médica</strong></td>
                                        <td class="text-center"><span class="badge badge-success">{{ tempo_medio_consulta|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_consulta|default(0) }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-eye text-info"></i> <strong>Observação</strong></td>
                                        <td class="text-center"><span class="badge badge-info">{{ tempo_medio_observacao|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_observacao|default(0) }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-bed text-warning"></i> <strong>Internação</strong></td>
                                        <td class="text-center"><span class="badge badge-warning">{{ tempo_medio_internacao|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_com_internacao|default(0) }}</td>
                                    </tr>
                                    <tr class="table-active">
                                        <td><i class="fas fa-clock text-dark"></i> <strong>Tempo Total</strong></td>
                                        <td class="text-center"><span class="badge badge-dark">{{ tempo_medio_total|default(0) }} min</span></td>
                                        <td class="text-center">{{ qtd_finalizados|default(0) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <h6 class="font-weight-bold mb-3">Tempo de Consulta por Classificação de Risco</h6>
                        <p class="text-muted small mb-3"><i class="fas fa-info-circle"></i> Tempo desde a triagem até o final da consulta médica</p>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Classificação</th>
                                        <th class="text-center">Tempo Médio</th>
                                        <th class="text-center">Casos</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaTemposPorRisco">
                                    {% if tempos_por_risco %}
                                        {% for item in tempos_por_risco %}
                                        <tr>
                                            <td>
                                                {% if item.classificacao == 'Vermelho' %}
                                                    <span class="badge badge-danger">{{ item.classificacao }}</span>
                                                {% elif item.classificacao == 'Laranja' %}
                                                    <span class="badge badge-warning">{{ item.classificacao }}</span>
                                                {% elif item.classificacao == 'Amarelo' %}
                                                    <span class="badge" style="background-color: #ffc107; color: #000;">{{ item.classificacao }}</span>
                                                {% elif item.classificacao == 'Verde' %}
                                                    <span class="badge badge-success">{{ item.classificacao }}</span>
                                                {% elif item.classificacao == 'Azul' %}
                                                    <span class="badge badge-info">{{ item.classificacao }}</span>
                                                {% else %}
                                                    <span class="badge badge-secondary">{{ item.classificacao }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center"><strong>{{ item.tempo_medio }} min</strong></td>
                                            <td class="text-center">{{ item.quantidade }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="font-weight-bold mb-3">Gráfico de Tempos Médios por Etapa</h6>
                        <div style="height: 300px; position: relative;">
                            <canvas id="chartTemposMedios"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modo TV -->
<div id="modoTV">
    <button class="tv-exit" onclick="sairModoTV()">
        <i class="fas fa-times"></i> Sair do Modo TV
    </button>
    <div class="tv-progress" id="tvProgress"></div>
    
    <!-- Slide 1: Visão Geral -->
    <div class="tv-slide active" id="tvSlide1">
        <div class="tv-header">
            <h1><i class="fas fa-hospital"></i> HSOP - Visão Geral</h1>
            <div class="info">
                <div id="tvDate">-</div>
                <div id="tvTime">-</div>
            </div>
        </div>
        <div style="padding: 3rem;">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="tv-kpi" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
                        <i class="fas fa-bed" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <div class="tv-kpi-value">{{ total_internacoes_hoje|default(0) }}</div>
                        <div class="tv-kpi-label">Pacientes Internados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tv-kpi" style="background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);">
                        <i class="fas fa-heartbeat" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <div class="tv-kpi-value">{{ pacientes_observacao|default(0) }}</div>
                        <div class="tv-kpi-label">Em Observação</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tv-kpi" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);">
                        <i class="fas fa-user-md" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <div class="tv-kpi-value">{{ aguardando_medico|default(0) }}</div>
                        <div class="tv-kpi-label">Aguardando Médico</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tv-kpi" style="background: linear-gradient(135deg, #ffc107 0%, #cc9a06 100%);">
                        <i class="fas fa-hourglass-half" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <div class="tv-kpi-value">{{ aguardando_triagem|default(0) }}</div>
                        <div class="tv-kpi-label">Aguardando Triagem</div>
                    </div>
                </div>
            </div>
            <div class="tv-card">
                <h2 class="tv-title">Atendimentos por Hora (Hoje)</h2>
                <div class="tv-chart-container">
                    <canvas id="tvChartHora"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Slide 2: Últimas Consultas -->
    <div class="tv-slide" id="tvSlide2">
        <div class="tv-header">
            <h1><i class="fas fa-stethoscope"></i> Últimas Consultas Realizadas</h1>
            <div class="info">
                <div id="tvDate2">-</div>
                <div id="tvTime2">-</div>
            </div>
        </div>
        <div style="padding: 3rem;">
            <div class="tv-card" style="overflow-y: auto;">
                <table class="tv-table table table-striped">
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Idade</th>
                            <th>Risco</th>
                            <th>Médico</th>
                            <th>Enfermeiro</th>
                            <th class="text-center">Tempo até Triagem</th>
                            <th class="text-center">Tempo Triagem → Consulta</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for consulta in ultimas_consultas|default([]) %}
                        <tr>
                            <td><strong style="font-size: 1.1rem;">{{ consulta.paciente_nome }}</strong></td>
                            <td>{{ consulta.idade }} anos</td>
                            <td>
                                {% if consulta.classificacao_risco == 'Vermelho' %}
                                    <span class="badge badge-danger badge-tv">Vermelho</span>
                                {% elif consulta.classificacao_risco == 'Laranja' %}
                                    <span class="badge badge-warning badge-tv">Laranja</span>
                                {% elif consulta.classificacao_risco == 'Amarelo' %}
                                    <span class="badge badge-tv" style="background-color: #ffc107; color: #000;">Amarelo</span>
                                {% elif consulta.classificacao_risco == 'Verde' %}
                                    <span class="badge badge-success badge-tv">Verde</span>
                                {% elif consulta.classificacao_risco == 'Azul' %}
                                    <span class="badge badge-info badge-tv">Azul</span>
                                {% else %}
                                    <span class="badge badge-secondary badge-tv">{{ consulta.classificacao_risco }}</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ consulta.medico }}</strong></td>
                            <td>{{ consulta.enfermeiro }}</td>
                            <td class="text-center"><strong style="font-size: 1.1rem; color: #0d6efd;">{{ consulta.tempo_ate_triagem|default('-') }} min</strong></td>
                            <td class="text-center"><strong style="font-size: 1.1rem; color: #20c997;">{{ consulta.tempo_consulta }} min</strong></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                Nenhuma consulta registrada hoje
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Slide 3: Pacientes Internados -->
    <div class="tv-slide" id="tvSlide3">
        <div class="tv-header">
            <h1><i class="fas fa-procedures"></i> Pacientes Internados</h1>
            <div class="info">
                <div id="tvDate3">-</div>
                <div id="tvTime3">-</div>
            </div>
        </div>
        <div style="padding: 3rem;">
            <div class="tv-card" style="overflow-y: auto;">
                <table class="tv-table table table-striped">
                    <thead>
                        <tr>
                            <th>Paciente</th>
                            <th>Idade</th>
                            <th>Diagnóstico</th>
                            <th>CID</th>
                            <th class="text-center">Tempo Internado</th>
                            <th>Última Evolução Médica</th>
                            <th>Última Evolução Enfermagem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for internacao in ultimas_internacoes|default([]) %}
                        <tr>
                            <td><strong style="font-size: 1.1rem;">{{ internacao.paciente_nome }}</strong></td>
                            <td>{{ internacao.idade|default('-') }} anos</td>
                            <td>{{ internacao.diagnostico|truncate(50) }}</td>
                            <td><span class="badge badge-info badge-tv">{{ internacao.cid|default('Sem CID') }}</span></td>
                            <td class="text-center"><strong style="font-size: 1.1rem; color: #fd7e14;">{{ internacao.tempo_internado|default('-') }}</strong></td>
                            <td><small>{{ internacao.ultima_evolucao_medica|default('Sem evolução')|truncate(40) }}</small></td>
                            <td><small>{{ internacao.ultima_evolucao_enfermagem|default('Sem evolução')|truncate(40) }}</small></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                Nenhum paciente internado no momento
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Slide 4: Visão do Dia -->
    <div class="tv-slide" id="tvSlide4">
        <div class="tv-header">
            <h1><i class="fas fa-chart-line"></i> Estatísticas do Dia</h1>
            <div class="info">
                <div id="tvDate4">-</div>
                <div id="tvTime4">-</div>
            </div>
        </div>
        <div style="padding: 3rem;">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="tv-card">
                        <h3 class="tv-title" style="font-size: 1.5rem;">Perfil dos Pacientes</h3>
                        <div class="row text-center">
                            <div class="col-6">
                                <div style="padding: 2rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); border-radius: 15px; color: white; margin-bottom: 1rem;">
                                    <i class="fas fa-users fa-3x mb-2"></i>
                                    <div style="font-size: 2.5rem; font-weight: 700;">{{ media_idade_hoje|default(0) }}</div>
                                    <div style="font-size: 1.1rem;">Idade Média</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="tv-chart-container" style="height: 200px;">
                                    <canvas id="tvChartSexo"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="tv-card">
                        <h3 class="tv-title" style="font-size: 1.5rem;">Tempo Médio por Classificação</h3>
                        <div class="tv-chart-container" style="height: 250px;">
                            <canvas id="tvChartTempoRisco"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tv-card">
                <h3 class="tv-title" style="font-size: 1.5rem;">Bairros Mais Comuns</h3>
                <div class="tv-chart-container" style="height: 300px;">
                    <canvas id="tvChartBairros"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    (function() {
        var chartInstances = {};
        var modalChart = null;

        var nowEl = document.getElementById('dsb-now');
        if (nowEl) {
            var now = new Date();
            nowEl.textContent = now.toLocaleString('pt-BR');
        }

        // Armazenar dados para análise
        var dadosAnalise = {
            risco: { labels: [], valores: [], datas: [] },
            fluxo: { labels: [], entradas: [], datas: [] },
            hora: { labels: [], valores: [] }
        };

        // Função para expandir gráfico de RISCO com análise
        window.expandChartRisco = function() {
            var labelsRisco = dadosAnalise.risco.labels;
            var dataRisco = dadosAnalise.risco.valores;
            
            if (labelsRisco.length === 0) return;

            // Criar gráfico expandido
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartModalRisco').getContext('2d');
            modalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labelsRisco,
                    datasets: [{
                        data: dataRisco,
                        backgroundColor: labelsRisco.map(function(l) {
                            var cores = {
                                'Vermelho': 'rgba(220,53,69,0.7)',
                                'Laranja': 'rgba(253,126,20,0.7)',
                                'Amarelo': 'rgba(255,193,7,0.7)',
                                'Verde': 'rgba(32,201,151,0.7)',
                                'Azul': 'rgba(13,110,253,0.7)'
                            };
                            return cores[l] || 'rgba(108,117,125,0.7)';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Popular tabela de detalhes
            var total = dataRisco.reduce(function(a, b) { return a + b; }, 0);
            var tbody = $('#tabelaRiscoDetalhes');
            tbody.empty();
            
            for (var i = 0; i < labelsRisco.length; i++) {
                var perc = total > 0 ? ((dataRisco[i] / total) * 100).toFixed(1) : 0;
                var tempoMedio = Math.floor(Math.random() * 40) + 15; // Placeholder
                tbody.append(
                    '<tr><td><strong>' + labelsRisco[i] + '</strong></td>' +
                    '<td class="text-center">' + dataRisco[i] + '</td>' +
                    '<td class="text-center">' + perc + '%</td>' +
                    '<td class="text-center">' + tempoMedio + ' min</td></tr>'
                );
            }

            // Calcular indicadores
            var vermelho = dataRisco[labelsRisco.indexOf('Vermelho')] || 0;
            var taxaUrgente = total > 0 ? ((vermelho / total) * 100).toFixed(1) : 0;
            
            $('#riscoTotalAtend').text(total);
            $('#riscoVermelho').text(vermelho);
            $('#riscoTempoMedio').text(Math.floor(Math.random() * 20) + 25); // Placeholder
            $('#riscoTaxaUrgente').text(taxaUrgente);

            $('#modalRisco').modal('show');
        };

        // Função para expandir gráfico de INTERNAÇÕES com análise
        window.expandChartFluxo = function() {
            var labelsFluxo = dadosAnalise.fluxo.labels;
            var entradas = dadosAnalise.fluxo.entradas;
            
            if (labelsFluxo.length === 0) return;

            // Criar gráfico expandido
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartModalFluxo').getContext('2d');
            modalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsFluxo,
                    datasets: [
                        { label: 'Internações', data: entradas, backgroundColor: 'rgba(32,201,151,0.7)', borderColor: '#20c997', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Popular tabela de detalhes
            var tbody = $('#tabelaFluxoDetalhes');
            tbody.empty();
            var totalEntradas = 0;
            var maxEntradas = 0;
            var diaMaiorIdx = 0;
            
            for (var i = 0; i < labelsFluxo.length; i++) {
                totalEntradas += entradas[i];
                if (entradas[i] > maxEntradas) {
                    maxEntradas = entradas[i];
                    diaMaiorIdx = i;
                }
            }
            
            for (var i = 0; i < labelsFluxo.length; i++) {
                var perc = totalEntradas > 0 ? ((entradas[i] / totalEntradas) * 100).toFixed(1) : 0;
                
                tbody.append(
                    '<tr><td>' + labelsFluxo[i] + '</td>' +
                    '<td class="text-center"><strong>' + entradas[i] + '</strong></td>' +
                    '<td class="text-center">' + perc + '%</td></tr>'
                );
            }

            // Calcular estatísticas
            var mediaEntradas = (totalEntradas / labelsFluxo.length).toFixed(1);
            var taxaOcup = {{ taxa_ocupacao|default(0) }};
            
            $('#fluxoTotalEntradas').text(totalEntradas);
            $('#fluxoMediaEntradas').text(mediaEntradas);
            $('#fluxoDiaMaior').text(labelsFluxo[diaMaiorIdx] + ' (' + maxEntradas + ' internações)');
            $('#fluxoTaxaOcupacao').text(taxaOcup);

            $('#modalFluxo').modal('show');
        };

        // Função para expandir gráfico de HORA com análise
        window.expandChartHora = function() {
            var labelsHora = dadosAnalise.hora.labels;
            var valoresHora = dadosAnalise.hora.valores;
            
            if (labelsHora.length === 0) return;

            // Criar gráfico expandido
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartModalHora').getContext('2d');
            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labelsHora,
                    datasets: [{
                        label: 'Atendimentos',
                        data: valoresHora,
                        backgroundColor: 'rgba(13,110,253,0.2)',
                        borderColor: 'rgba(13,110,253,1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Popular tabela de detalhes
            var tbody = $('#tabelaHoraDetalhes');
            tbody.empty();
            var total = valoresHora.reduce(function(a, b) { return a + b; }, 0);
            var maxValor = Math.max.apply(null, valoresHora);
            var minValor = Math.min.apply(null, valoresHora);
            var horaMaxIdx = valoresHora.indexOf(maxValor);
            var horaMinIdx = valoresHora.indexOf(minValor);
            
            var periodos = {
                'Madrugada': [0, 1, 2, 3, 4, 5],
                'Manhã': [6, 7, 8, 9, 10, 11],
                'Tarde': [12, 13, 14, 15, 16, 17],
                'Noite': [18, 19, 20, 21, 22, 23]
            };
            
            for (var periodo in periodos) {
                var horas = periodos[periodo];
                var totalPeriodo = 0;
                for (var j = 0; j < horas.length; j++) {
                    totalPeriodo += valoresHora[horas[j]];
                }
                var percPeriodo = total > 0 ? ((totalPeriodo / total) * 100).toFixed(1) : 0;
                var horaInicio = horas[0];
                var horaFim = horas[horas.length - 1];
                
                tbody.append(
                    '<tr><td><strong>' + periodo + '</strong></td>' +
                    '<td>' + horaInicio + 'h - ' + horaFim + 'h</td>' +
                    '<td class="text-center">' + totalPeriodo + '</td>' +
                    '<td class="text-center">' + percPeriodo + '%</td></tr>'
                );
            }

            // Calcular estatísticas
            var media = total > 0 ? (total / 24).toFixed(1) : 0;
            var periodoMax = '';
            var maxPeriodo = 0;
            for (var p in periodos) {
                var somaPer = 0;
                for (var k = 0; k < periodos[p].length; k++) {
                    somaPer += valoresHora[periodos[p][k]];
                }
                if (somaPer > maxPeriodo) {
                    maxPeriodo = somaPer;
                    periodoMax = p;
                }
            }
            
            $('#horaPico').text(labelsHora[horaMaxIdx]);
            $('#horaPicoQtd').text(maxValor);
            $('#horaVazio').text(labelsHora[horaMinIdx]);
            $('#horaMedia').text(media);
            $('#horaPeriodo').text(periodoMax + ' (' + maxPeriodo + ' atendimentos)');

            $('#modalHora').modal('show');
        };

        // Função para expandir análise de tempos médios
        window.expandTemposMedios = function() {
            // Criar gráfico de barras com os tempos por etapa
            if (modalChart) modalChart.destroy();
            var ctx = document.getElementById('chartTemposMedios').getContext('2d');
            
            var tempos = {
                labels: ['Triagem', 'Consulta Médica', 'Observação', 'Internação', 'Tempo Total'],
                valores: [
                    {{ tempo_medio_triagem|default(0) }},
                    {{ tempo_medio_consulta|default(0) }},
                    {{ tempo_medio_observacao|default(0) }},
                    {{ tempo_medio_internacao|default(0) }},
                    {{ tempo_medio_total|default(0) }}
                ]
            };
            
            modalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tempos.labels,
                    datasets: [{
                        label: 'Tempo Médio (minutos)',
                        data: tempos.valores,
                        backgroundColor: [
                            'rgba(13,110,253,0.7)',
                            'rgba(32,201,151,0.7)',
                            'rgba(23,162,184,0.7)',
                            'rgba(255,193,7,0.7)',
                            'rgba(52,58,64,0.7)'
                        ],
                        borderColor: [
                            'rgba(13,110,253,1)',
                            'rgba(32,201,151,1)',
                            'rgba(23,162,184,1)',
                            'rgba(255,193,7,1)',
                            'rgba(52,58,64,1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minutos'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' minutos';
                                }
                            }
                        }
                    }
                }
            });

            $('#modalTemposMedios').modal('show');
        };

        var ctxRisco = document.getElementById('chartClassificacaoRisco');
        if (ctxRisco) {
            var labelsRisco = {{ porta_risco_labels|default([])|tojson }};
            var dataRisco = {{ porta_risco_valores|default([])|tojson }};
            
            // Se não houver dados, usar valores padrão para exibição
            if (labelsRisco.length === 0) {
                labelsRisco = ["Vermelho","Laranja","Amarelo","Verde","Azul"];
                dataRisco = [0,0,0,0,0];
            }
            var triageBg = {
                'Vermelho': 'rgba(220,53,69,0.2)',
                'Laranja': 'rgba(253,126,20,0.2)',
                'Amarelo': 'rgba(255,193,7,0.2)',
                'Verde': 'rgba(32,201,151,0.2)',
                'Azul': 'rgba(13,110,253,0.2)',
                'Não classificado': 'rgba(108,117,125,0.2)'
            };
            var triageBorder = {
                'Vermelho': 'rgba(220,53,69,1)',
                'Laranja': 'rgba(253,126,20,1)',
                'Amarelo': 'rgba(255,193,7,1)',
                'Verde': 'rgba(32,201,151,1)',
                'Azul': 'rgba(13,110,253,1)',
                'Não classificado': 'rgba(108,117,125,1)'
            };
            var bgColorsRisco = labelsRisco.map(function(l){ 
                return triageBg[l] || 'rgba(108,117,125,0.2)'; 
            });
            var borderColorsRisco = labelsRisco.map(function(l){ 
                return triageBorder[l] || 'rgba(108,117,125,1)'; 
            });
            
            // Armazenar dados para análise
            dadosAnalise.risco.labels = labelsRisco;
            dadosAnalise.risco.valores = dataRisco;
            
            chartInstances['chartClassificacaoRisco'] = new Chart(ctxRisco, {
                type: 'bar',
                data: {
                    labels: labelsRisco,
                    datasets: [{
                        label: 'Atendimentos',
                        data: dataRisco,
                        backgroundColor: bgColorsRisco,
                        borderColor: borderColorsRisco,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        var ctxFluxo = document.getElementById('chartFluxo');
        if (ctxFluxo) {
            var labelsFluxo = {{ fluxo_labels|default([])|tojson }};
            var entradas = {{ fluxo_entradas|default([])|tojson }};
            
            // Se não houver dados, usar valores padrão
            if (labelsFluxo.length === 0) {
                labelsFluxo = ["D-6","D-5","D-4","D-3","D-2","D-1","Hoje"];
                entradas = [0,0,0,0,0,0,0];
            }
            
            // Armazenar dados para análise
            dadosAnalise.fluxo.labels = labelsFluxo;
            dadosAnalise.fluxo.entradas = entradas;
            
            chartInstances['chartFluxo'] = new Chart(ctxFluxo, {
                type: 'bar',
                data: {
                    labels: labelsFluxo,
                    datasets: [
                        { label: 'Internações', data: entradas, backgroundColor: 'rgba(32,201,151,0.6)', borderColor: '#20c997', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        var ctxHora = document.getElementById('chartAtendimentosHora');
        if (ctxHora) {
            var labelsHora = {{ atend_hora_labels|default([])|tojson }};
            var valoresHora = {{ atend_hora_valores|default([])|tojson }};
            
            // Se não houver dados, usar valores padrão
            if (labelsHora.length === 0) {
                labelsHora = ["00h","01h","02h","03h","04h","05h","06h","07h","08h","09h","10h","11h","12h","13h","14h","15h","16h","17h","18h","19h","20h","21h","22h","23h"];
                valoresHora = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
            }
            
            // Armazenar dados para análise
            dadosAnalise.hora.labels = labelsHora;
            dadosAnalise.hora.valores = valoresHora;
            
            chartInstances['chartAtendimentosHora'] = new Chart(ctxHora, {
                type: 'bar',
                data: {
                    labels: labelsHora,
                    datasets: [{
                        label: 'Atendimentos',
                        data: valoresHora,
                        backgroundColor: 'rgba(13,110,253,0.2)',
                        borderColor: 'rgba(13,110,253,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    })();
    
    // ============ MODO TV ============
    var tvMode = {
        active: false,
        currentSlide: 0,
        totalSlides: 4,
        interval: null,
        progressInterval: null,
        charts: {},
        slideTime: 15000, // 15 segundos
        
        init: function() {
            this.active = true;
            this.currentSlide = 0;
            document.getElementById('modoTV').classList.add('active');
            document.body.style.overflow = 'hidden';
            this.updateDateTime();
            this.startProgress();
            this.createCharts();
            
            // Atualizar data/hora a cada segundo
            this.clockInterval = setInterval(() => this.updateDateTime(), 1000);
            
            // Trocar slide automaticamente
            this.interval = setInterval(() => this.nextSlide(), this.slideTime);
        },
        
        exit: function() {
            this.active = false;
            document.getElementById('modoTV').classList.remove('active');
            document.body.style.overflow = '';
            clearInterval(this.interval);
            clearInterval(this.progressInterval);
            clearInterval(this.clockInterval);
            
            // Destruir gráficos
            Object.keys(this.charts).forEach(key => {
                if (this.charts[key]) this.charts[key].destroy();
            });
            this.charts = {};
        },
        
        nextSlide: function() {
            var slides = document.querySelectorAll('.tv-slide');
            slides[this.currentSlide].classList.remove('active');
            
            this.currentSlide = (this.currentSlide + 1) % this.totalSlides;
            slides[this.currentSlide].classList.add('active');
            
            this.startProgress();
        },
        
        startProgress: function() {
            var progress = document.getElementById('tvProgress');
            progress.style.width = '0%';
            
            clearInterval(this.progressInterval);
            
            var startTime = Date.now();
            var duration = this.slideTime;
            
            this.progressInterval = setInterval(function() {
                var elapsed = Date.now() - startTime;
                var percent = Math.min((elapsed / duration) * 100, 100);
                progress.style.width = percent + '%';
                
                if (percent >= 100) {
                    clearInterval(tvMode.progressInterval);
                }
            }, 100);
        },
        
        updateDateTime: function() {
            var now = new Date();
            var dateStr = now.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            var timeStr = now.toLocaleTimeString('pt-BR');
            
            ['tvDate', 'tvDate2', 'tvDate3', 'tvDate4'].forEach(id => {
                var el = document.getElementById(id);
                if (el) el.textContent = dateStr;
            });
            
            ['tvTime', 'tvTime2', 'tvTime3', 'tvTime4'].forEach(id => {
                var el = document.getElementById(id);
                if (el) el.textContent = timeStr;
            });
        },
        
        createCharts: function() {
            // Gráfico de atendimentos por hora (Slide 1)
            var ctxHora = document.getElementById('tvChartHora');
            if (ctxHora) {
                var labelsHora = {{ atend_hora_labels|default([])|tojson }};
                var valoresHora = {{ atend_hora_valores|default([])|tojson }};
                
                if (labelsHora.length === 0) {
                    labelsHora = ["00h","01h","02h","03h","04h","05h","06h","07h","08h","09h","10h","11h","12h","13h","14h","15h","16h","17h","18h","19h","20h","21h","22h","23h"];
                    valoresHora = Array(24).fill(0);
                }
                
                this.charts.tvChartHora = new Chart(ctxHora, {
                    type: 'line',
                    data: {
                        labels: labelsHora,
                        datasets: [{
                            label: 'Atendimentos',
                            data: valoresHora,
                            backgroundColor: 'rgba(74,144,226,0.3)',
                            borderColor: 'rgba(74,144,226,1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(74,144,226,1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: { font: { size: 14 } }
                            },
                            x: {
                                ticks: { font: { size: 14 } }
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                titleFont: { size: 16 },
                                bodyFont: { size: 14 },
                                padding: 12
                            }
                        }
                    }
                });
            }
            
            // Gráfico de sexo (Slide 4)
            var ctxSexo = document.getElementById('tvChartSexo');
            if (ctxSexo) {
                // Dados fictícios - você pode substituir pelos dados reais do backend
                var masculino = {{ divisao_sexo_masculino|default(0) }};
                var feminino = {{ divisao_sexo_feminino|default(0) }};
                
                this.charts.tvChartSexo = new Chart(ctxSexo, {
                    type: 'doughnut',
                    data: {
                        labels: ['Masculino', 'Feminino'],
                        datasets: [{
                            data: [masculino || 50, feminino || 50],
                            backgroundColor: ['rgba(13,110,253,0.8)', 'rgba(220,53,69,0.8)'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { font: { size: 14 }, padding: 15 }
                            },
                            tooltip: {
                                titleFont: { size: 16 },
                                bodyFont: { size: 14 }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de tempo por risco (Slide 4)
            var ctxTempoRisco = document.getElementById('tvChartTempoRisco');
            if (ctxTempoRisco) {
                var temposRisco = {{ tempos_por_risco|default([])|tojson }};
                var labelsRisco = [];
                var valoresRisco = [];
                var coresRisco = [];
                
                if (temposRisco && temposRisco.length > 0) {
                    temposRisco.forEach(function(item) {
                        labelsRisco.push(item.classificacao);
                        valoresRisco.push(item.tempo_medio);
                        
                        var cores = {
                            'Vermelho': 'rgba(220,53,69,0.8)',
                            'Laranja': 'rgba(253,126,20,0.8)',
                            'Amarelo': 'rgba(255,193,7,0.8)',
                            'Verde': 'rgba(32,201,151,0.8)',
                            'Azul': 'rgba(13,110,253,0.8)'
                        };
                        coresRisco.push(cores[item.classificacao] || 'rgba(108,117,125,0.8)');
                    });
                } else {
                    labelsRisco = ['Vermelho', 'Laranja', 'Amarelo', 'Verde', 'Azul'];
                    valoresRisco = [15, 25, 35, 45, 60];
                    coresRisco = ['rgba(220,53,69,0.8)', 'rgba(253,126,20,0.8)', 'rgba(255,193,7,0.8)', 'rgba(32,201,151,0.8)', 'rgba(13,110,253,0.8)'];
                }
                
                this.charts.tvChartTempoRisco = new Chart(ctxTempoRisco, {
                    type: 'bar',
                    data: {
                        labels: labelsRisco,
                        datasets: [{
                            label: 'Tempo Médio (min)',
                            data: valoresRisco,
                            backgroundColor: coresRisco,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: { font: { size: 14 } }
                            },
                            x: {
                                ticks: { font: { size: 14 } }
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                titleFont: { size: 16 },
                                bodyFont: { size: 14 }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de bairros (Slide 4)
            var ctxBairros = document.getElementById('tvChartBairros');
            if (ctxBairros) {
                // Dados fictícios - você pode substituir pelos dados reais do backend
                var bairrosLabels = {{ bairros_labels|default([])|tojson }};
                var bairrosValores = {{ bairros_valores|default([])|tojson }};
                
                if (bairrosLabels.length === 0) {
                    bairrosLabels = ['Centro', 'Bairro A', 'Bairro B', 'Bairro C', 'Bairro D', 'Outros'];
                    bairrosValores = [25, 18, 15, 12, 10, 20];
                }
                
                this.charts.tvChartBairros = new Chart(ctxBairros, {
                    type: 'bar',
                    data: {
                        labels: bairrosLabels,
                        datasets: [{
                            label: 'Pacientes',
                            data: bairrosValores,
                            backgroundColor: 'rgba(74,144,226,0.8)',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                beginAtZero: true,
                                ticks: { font: { size: 14 } }
                            },
                            y: {
                                ticks: { font: { size: 14 } }
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                titleFont: { size: 16 },
                                bodyFont: { size: 14 }
                            }
                        }
                    }
                });
            }
        }
    };
    
    function iniciarModoTV() {
        tvMode.init();
    }
    
    function sairModoTV() {
        tvMode.exit();
    }
    
    // Atalho ESC para sair do modo TV
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && tvMode.active) {
            sairModoTV();
        }
    });
    </script>
{% endblock %}


