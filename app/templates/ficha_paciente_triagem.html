<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ficha de Triagem - Enfermeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
      :root {
        --azul-principal: #4A90E2;
        --azul-claro: #E8F4FF;
        --azul-medio: #7AB8F5;
        --branco-gelo: #F8FCFF;
        --cinza-texto: #4A5568;
        --cinza-claro: #E2E8F0;
        --sombra-suave: 0 2px 12px rgba(74, 144, 226, 0.08);
        --sombra-media: 0 4px 20px rgba(74, 144, 226, 0.12);
      }
      
      body {
        background: linear-gradient(135deg, var(--branco-gelo) 0%, var(--azul-claro) 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
      }
      
      .required-asterisk {
        color: #dc3545;
        margin-left: 2px;
      }
      
      .required-hint {
        font-size: 0.9rem;
        color: var(--cinza-texto);
      }
      
      .card {
        border: 0;
        border-radius: 16px;
        box-shadow: var(--sombra-media);
        background: white;
      }
      
      .card-header {
        background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
        color: white;
        border-radius: 16px 16px 0 0 !important;
        border-bottom: none;
        padding: 20px 24px;
        font-weight: 600;
        font-size: 1.5rem;
      }
      
      .section-header {
        background: linear-gradient(135deg, var(--azul-claro), #D8ECFF);
        color: var(--azul-principal);
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 15px;
        font-weight: 600;
        border-left: 4px solid var(--azul-principal);
      }
      
      .section-header i {
        margin-right: 10px;
      }
      
      .info-row {
        margin-bottom: 10px;
        padding: 8px;
        background: var(--branco-gelo);
        border-radius: 8px;
      }
      
      .nurse-signature {
        border: 2px solid var(--azul-claro);
        padding: 20px;
        margin-top: 30px;
        text-align: center;
        border-radius: 12px;
        background: white;
        box-shadow: var(--sombra-suave);
      }
      
      .nurse-signature h5 {
        margin-bottom: 8px;
        color: var(--azul-principal);
        font-weight: 600;
      }
      
      .nurse-signature p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--cinza-texto);
      }
      
      .gestante-fields, .condicoes-clinicas {
        display: none;
        border: 2px solid var(--azul-claro);
        padding: 20px;
        margin-top: 15px;
        border-radius: 12px;
        background-color: #fff;
        box-shadow: var(--sombra-suave);
      }
      
      .back-btn {
        margin-bottom: 20px;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      
      .back-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
      }
      
      #dstTextContainer {
        display: none;
      }
      
      .bg-orange {
        background-color: #fd7e14;
        color: #fff;
      }
      
      .form-control {
        transition: all 0.3s ease;
        border-radius: 8px;
      }
      
      .form-control:focus {
        border-color: var(--azul-principal);
        box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        transform: translateY(-1px);
      }
      
      .form-select {
        transition: all 0.3s ease;
        border-radius: 8px;
      }
      
      .form-select:focus {
        border-color: var(--azul-principal);
        box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
      }
      
      .form-check-input {
        transition: all 0.3s ease;
      }
      
      .form-check-input:checked {
        background-color: var(--azul-principal);
        border-color: var(--azul-principal);
      }
      
      textarea.form-control {
        resize: vertical;
        min-height: 80px;
      }
      
      .form-label {
        font-weight: 500;
        color: var(--cinza-texto);
        margin-bottom: 8px;
      }
      
      .form-label i,
      .btn i,
      .card-header i {
        margin-right: 8px;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
        border: none;
        border-radius: 10px;
        padding: 12px 24px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
      }
      
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 14px rgba(74, 144, 226, 0.4);
      }
      
      .btn-outline-secondary {
        border-radius: 10px;
        transition: all 0.3s ease;
      }
      
      /* Botões de Classificação de Risco */
      .risk-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      
      .risk-btn {
        flex: 1;
        min-width: 90px;
        padding: 12px 10px;
        border: 3px solid transparent;
        border-radius: 10px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        position: relative;
        user-select: none;
        opacity: 0.85;
      }
      
      .risk-btn:hover:not(.active) {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        opacity: 1;
      }
      
      .risk-btn:active:not(.active) {
        transform: translateY(-1px) scale(0.98);
      }
      
      .risk-btn.active {
        border-color: #fff;
        border-width: 4px;
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), 
                    0 0 0 3px rgba(0, 0, 0, 0.3),
                    inset 0 0 15px rgba(255, 255, 255, 0.2);
        opacity: 1;
        animation: pulse-active 0.4s ease-out;
      }
      
      @keyframes pulse-active {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.08);
        }
        100% {
          transform: scale(1.05);
        }
      }
      
      .risk-btn.active::before {
        content: '✓';
        position: absolute;
        top: 3px;
        right: 6px;
        font-size: 18px;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        animation: check-appear 0.3s ease-out;
      }
      
      @keyframes check-appear {
        0% {
          opacity: 0;
          transform: scale(0) rotate(-180deg);
        }
        100% {
          opacity: 1;
          transform: scale(1) rotate(0deg);
        }
      }
      
      .risk-btn.azul {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
      }
      
      .risk-btn.verde {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
      }
      
      .risk-btn.amarelo {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        color: #000;
      }
      
      .risk-btn.amarelo.active::before {
        color: #000;
      }
      
      .risk-btn.laranja {
        background: linear-gradient(135deg, #fd7e14 0%, #e35d00 100%);
        color: white;
      }
      
      .risk-btn.vermelho {
        background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
        color: white;
      }
      
      .risk-btn small {
        display: block;
        margin-top: 4px;
        font-size: 11px;
        opacity: 0.9;
      }
      
      /* Efeito de destaque quando precisa selecionar */
      .risk-buttons.needs-selection {
        animation: shake-horizontal 0.5s ease-in-out;
        padding: 10px;
        border: 3px dashed #dc3545;
        border-radius: 16px;
        background: rgba(220, 53, 69, 0.05);
      }
      
      @keyframes shake-horizontal {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
      }
      
      /* Indicador de seleção obrigatória */
      .risk-selection-required {
        display: none;
        color: #dc3545;
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
        padding: 10px;
        background: rgba(220, 53, 69, 0.1);
        border-radius: 8px;
        border-left: 4px solid #dc3545;
      }
      
      .risk-selection-required.show {
        display: block;
        animation: fadeIn 0.3s ease-in;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .input-group-text {
        background-color: var(--azul-claro);
        border-color: var(--cinza-claro);
        color: var(--azul-principal);
        font-weight: 600;
      }
      
      /* Toast de Feedback */
      .toast-feedback {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 20px;
        z-index: 9999;
        display: none;
        animation: slideInRight 0.4s ease-out;
        border-left: 5px solid;
      }
      
      .toast-feedback.show {
        display: block;
      }
      
      .toast-feedback.success {
        border-left-color: #28a745;
      }
      
      .toast-feedback.error {
        border-left-color: #dc3545;
      }
      
      .toast-feedback.warning {
        border-left-color: #ffc107;
      }
      
      .toast-feedback .toast-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 16px;
      }
      
      .toast-feedback .toast-header i {
        font-size: 24px;
        margin-right: 12px;
      }
      
      .toast-feedback.success .toast-header {
        color: #28a745;
      }
      
      .toast-feedback.error .toast-header {
        color: #dc3545;
      }
      
      .toast-feedback.warning .toast-header {
        color: #ffc107;
      }
      
      .toast-feedback .toast-body {
        color: var(--cinza-texto);
        line-height: 1.5;
      }
      
      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
      
      .toast-feedback.hiding {
        animation: slideOutRight 0.4s ease-in;
      }
      
      /* Overlay de loading */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9998;
        display: none;
        align-items: center;
        justify-content: center;
      }
      
      .loading-overlay.show {
        display: flex;
      }
      
      .loading-content {
        background: white;
        padding: 40px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
      }
      
      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid var(--azul-claro);
        border-top-color: var(--azul-principal);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .loading-text {
        color: var(--cinza-texto);
        font-size: 18px;
        font-weight: 500;
      }
      
      /* Responsividade */
      @media (max-width: 768px) {
        .risk-buttons {
          flex-direction: column;
        }
        
        .risk-btn {
          width: 100%;
          min-width: auto;
        }
        
        .card-header {
          flex-direction: column;
          text-align: center;
          gap: 10px;
        }
        
        .info-row {
          font-size: 0.9rem;
        }
        
        .card-body {
          padding: 20px !important;
        }
        
        .toast-feedback {
          right: 10px;
          left: 10px;
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <!-- Botão de voltar para triagens -->
      <button class="btn btn-secondary back-btn" onclick="window.location.href='/enfermeiro?view=triagem'">
        <i class="fas fa-arrow-left mr-2"></i>Voltar para Triagens
      </button>
      
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="flex-grow-1 text-center"><i class="fas fa-notes-medical mr-2"></i>Ficha de Triagem</div>
          <button id="btnEvasao" type="button" class="btn btn-outline-light btn-sm" title="Paciente Evadiu / Não Compareceu" style="border-radius: 8px; font-weight: 500;">
            <i class="fas fa-user-times mr-1"></i>Paciente Evadiu
          </button>
        </div>
        <div class="card-body" style="padding: 30px;">
          <!-- Dados do Paciente -->
          <div class="mb-4" id="dadosPaciente">
            <div class="section-header"><i class="fas fa-user-injured mr-2"></i>Dados do Paciente</div>
            <div class="row info-row">
              <div class="col-md-4"><strong>Cartão SUS:</strong> <span id="pacienteCartaoSus"></span></div>
              <div class="col-md-4"><strong>Nome:</strong> <span id="pacienteNome"></span></div>
              <div class="col-md-4"><strong>Nome Social:</strong> <span id="pacienteNomeSocial"></span></div>
            </div>
            <div class="row info-row">
              <div class="col-md-4"><strong>Filiação:</strong> <span id="pacienteFiliacao"></span></div>
              <div class="col-md-4"><strong>Data Nasc. / Idade:</strong> <span id="pacienteDataNasc"></span> (<span id="pacienteIdade"></span> anos)</div>
              <div class="col-md-4"><strong>Sexo:</strong> <span id="pacienteSexo"></span></div>
            </div>
            <div class="row info-row">
              <div class="col-md-4"><strong>CPF:</strong> <span id="pacienteCpf"></span></div>
              <div class="col-md-4"><strong>Endereço:</strong> <span id="pacienteEndereco"></span></div>
              <div class="col-md-4"><strong>Município / Bairro:</strong> <span id="pacienteMunicipio"></span> / <span id="pacienteBairro"></span></div>
            </div>
            <div class="row info-row">
              <div class="col-md-4"><strong>Telefone:</strong> <span id="pacienteTelefone"></span></div>
            </div>
          </div>
          
          <!-- Checkbox para informar se o paciente é gestante -->
          <div class="mb-3">
            <div class="form-check" style="background: var(--azul-claro); padding: 15px; border-radius: 10px; border-left: 4px solid var(--azul-principal);">
              <input class="form-check-input" type="checkbox" id="isGestante" name="isGestante" style="width: 20px; height: 20px; cursor: pointer;">
              <label class="form-check-label" for="isGestante" style="font-weight: 600; font-size: 1.1rem; color: var(--azul-principal); cursor: pointer; margin-left: 10px;">
                <i class="fas fa-pregnant mr-2"></i>Paciente é Gestante?
              </label>
            </div>
          </div>
          
          <!-- Formulário de triagem -->
          <form id="triagemForm" class="needs-validation" novalidate>
            <!-- Campo oculto para id do atendimento -->
            <input type="hidden" id="atendimento_id" name="atendimento_id">
            <p class="required-hint mb-2"><span class="required-asterisk">*</span> Campos obrigatórios</p>
            
            <!-- Sinais Vitais -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="pressao" class="form-label">Pressão <span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <input type="text" class="form-control" id="pressao" name="pressao" required inputmode="numeric" maxlength="7" pattern="^\d{2,3}/\d{2,3}$" title="Formato: NN/NN ou NNN/NN (use /)" oninput="let v=this.value.replace(/[^0-9]/g,'').slice(0,6); if(v.length<=2){ this.value=v; } else if(v.length<=4){ this.value=v.slice(0,2)+'/'+v.slice(2); } else { this.value=v.slice(0,3)+'/'+v.slice(3,5); }">
                  <span class="input-group-text">mmHg</span>
                </div>
                <div class="invalid-feedback">Informe no formato NN/NN ou NNN/NN.</div>
              </div>
              <div class="col-md-4">
                <label for="pulso" class="form-label">Pulso <span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <input type="text" class="form-control" id="pulso" name="pulso" required inputmode="numeric" maxlength="3" pattern="^\d{1,3}$" title="Somente números (até 3 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,3)">
                  <span class="input-group-text">bpm</span>
                </div>
                <div class="invalid-feedback">Campo obrigatório (até 3 dígitos).</div>
              </div>
              <div class="col-md-4">
                <label for="sp02" class="form-label">SpO₂ <span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <input type="text" class="form-control" id="sp02" name="sp02" required inputmode="numeric" maxlength="3" pattern="^\d{1,3}$" title="Somente números (até 3 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,3)">
                  <span class="input-group-text">%</span>
                </div>
                <div class="invalid-feedback">Campo obrigatório (até 3 dígitos).</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="temp" class="form-label">Temperatura <span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <input type="text" class="form-control" id="temp" name="temp" required inputmode="numeric" maxlength="4" pattern="^\d{2},\d$" title="Formato: NN,N" oninput="let d=this.value.replace(/\D/g,'').slice(0,3); this.value = d.length<=2 ? d : d.slice(0,2)+','+d.slice(2);">
                  <span class="input-group-text">°C</span>
                </div>
                <div class="invalid-feedback">Campo obrigatório.</div>
              </div>
              <div class="col-md-4">
                <label for="peso" class="form-label">Peso <span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <input type="text" class="form-control" id="peso" name="peso" required inputmode="numeric" pattern="^\d{1,3}(,\d)?$" title="Formato: até 3 dígitos inteiros e 1 decimal (ex.: 52,3)" oninput="formatPesoProgressive(this)">
                  <span class="input-group-text">kg</span>
                </div>
                <div class="invalid-feedback">Informe no formato 5 | 52 | 52,3 | 523,4.</div>
              </div>
              <div class="col-md-4">
                <label for="altura" class="form-label">Altura (cm)</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="altura" name="altura" inputmode="numeric" pattern="\d+" title="Informe apenas números (cm)" oninput="this.value = this.value.replace(/\D/g, '')">
                  <span class="input-group-text">cm</span>
                </div>
                <div class="invalid-feedback">Informe apenas números (cm).</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="fr" class="form-label">Frequência Respiratória (FR)</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="fr" name="fr" inputmode="numeric" maxlength="3" pattern="^\d{1,3}$" title="Somente números (até 3 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,3)">
                  <span class="input-group-text">/min</span>
                </div>
              </div>
              <div class="col-md-6">
                <label for="dx" class="form-label">DX</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="dx" name="dx" inputmode="numeric" maxlength="3" pattern="^\d{1,3}$" title="Somente números (até 3 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,3)">
                  <span class="input-group-text">mg/dL</span>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="triagem" class="form-label">Triagem <span class="required-asterisk">*</span></label>
              <textarea class="form-control" id="triagem" name="triagem" rows="2" required></textarea>
              <div class="invalid-feedback">Campo obrigatório.</div>
            </div>
            <div class="mb-3">
              <label for="alergias" class="form-label">Alergias <span class="required-asterisk">*</span></label>
              <textarea class="form-control" id="alergias" name="alergias" rows="2" required></textarea>
              <div class="invalid-feedback">Campo obrigatório.</div>
            </div>
            
            <!-- Informações de Gestante (exibidas somente se marcado) -->
            <div id="gestanteFields" class="gestante-fields">
              <div class="section-header"><i class="fas fa-baby-carriage mr-2"></i>Informações de Gestante</div>
              <div class="row mb-3">
                <div class="col-md-2">
                  <label for="idade_gestacional_semanas" class="form-label">Semanas</label>
                  <input type="text" class="form-control" id="idade_gestacional_semanas" name="idade_gestacional_semanas" inputmode="numeric" maxlength="2" pattern="^\d{1,2}$" title="Até 2 dígitos" oninput="this.value=this.value.replace(/\D/g,'').slice(0,2)">
                </div>
                <div class="col-md-2">
                  <label for="idade_gestacional_dias" class="form-label">Dias</label>
                  <input type="text" class="form-control" id="idade_gestacional_dias" name="idade_gestacional_dias" inputmode="numeric" maxlength="2" pattern="^\d{1,2}$" title="Até 2 dígitos" oninput="this.value=this.value.replace(/\D/g,'').slice(0,2)">
                </div>
                <div class="col-md-4">
                  <label for="altura_uterina" class="form-label">Altura Uterina (cm)</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="altura_uterina" name="altura_uterina" inputmode="numeric" maxlength="3" pattern="^\d{1,3}$" title="Somente números (até 3 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,3)">
                    <span class="input-group-text">cm</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="quantidade_de_gestacoes" class="form-label">Quantidade de Gestacoes</label>
                  <input type="text" class="form-control" id="quantidade_de_gestacoes" name="quantidade_de_gestacoes" inputmode="numeric" maxlength="2" pattern="^\d{1,2}$" title="Somente números (até 2 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,2)">
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="ultima_mestruacao" class="form-label">Última Menstruação</label>
                  <input type="date" class="form-control" id="ultima_mestruacao" name="ultima_mestruacao">
                  <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="ultima_mestruacao_desconhecida">
                    <label class="form-check-label" for="ultima_mestruacao_desconhecida">Não sabe identificar</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="bcf" class="form-label">BCF</label>
                  <div class="input-group">
                  <input type="text" class="form-control" id="bcf" name="bcf" inputmode="numeric" maxlength="3" pattern="^\d{1,3}$" title="Somente números (até 3 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,3)">
                    <span class="input-group-text">bpm</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="data_primeira_ultrassom" class="form-label">Data do 1º Ultrassom</label>
                  <input type="date" class="form-control" id="data_primeira_ultrassom" name="data_primeira_ultrassom">
                  <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="ultrassom_nao_possui">
                    <label class="form-check-label" for="ultrassom_nao_possui">Não possui</label>
                  </div>
                </div>
              </div>
              <!-- Abo/RH na seção de gestante -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="abo_rh" class="form-label">Abo/RH</label>
                <input type="text" class="form-control" id="abo_rh" name="abo_rh" inputmode="numeric" maxlength="3" pattern="^\d{1,3}$" title="Somente números (até 3 dígitos)" oninput="this.value=this.value.replace(/\D/g,'').slice(0,3)">
                </div>
              </div>
            </div>
            
            <!-- Condições Clínicas (apenas se gestante estiver marcada) -->
            <div id="condicoesClinicas" class="condicoes-clinicas">
              <div class="section-header"><i class="fas fa-heartbeat mr-2"></i>Condições Clínicas</div>
              <div class="row mb-3">
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="itu" name="itu">
                    <label class="form-check-label" for="itu">ITU</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sheg" name="sheg">
                    <label class="form-check-label" for="sheg">SHEG</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="diabetes" name="diabetes">
                    <label class="form-check-label" for="diabetes">Diabetes</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cardiopata" name="cardiopata">
                    <label class="form-check-label" for="cardiopata">Cardiopata</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tromboembolismo" name="tromboembolismo">
                    <label class="form-check-label" for="tromboembolismo">Tromboembolismo</label>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="hipertensao_arterial" name="hipertensao_arterial">
                    <label class="form-check-label" for="hipertensao_arterial">Hipertensão Arterial</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cirugia" name="cirugia">
                    <label class="form-check-label" for="cirugia">Cirurgia</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="usa_insulina" name="usa_insulina">
                    <label class="form-check-label" for="usa_insulina">Usa Insulina</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="anemia" name="anemia">
                    <label class="form-check-label" for="anemia">Anemia</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="toxoplasmose" name="toxoplasmose">
                    <label class="form-check-label" for="toxoplasmose">Toxoplasmose</label>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dst_checkbox" name="dst_checkbox">
                    <label class="form-check-label" for="dst_checkbox">DST</label>
                  </div>
                </div>
                <div class="col-md-4" id="dstTextContainer">
                <input type="text" class="form-control" id="dst_text" name="dst_text">
                </div>
              </div>
            </div>
            
            <!-- Resto do formulário -->
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label" style="font-size: 1.1rem; font-weight: 600;">
                  <i class="fas fa-hand-pointer mr-2" style="color: var(--azul-principal);"></i>
                  Classificação de Risco (Manchester) <span class="required-asterisk">*</span>
                  <small style="display: block; font-weight: 400; color: var(--cinza-texto); margin-top: 5px;">
                    Clique em um dos botões abaixo para selecionar
                  </small>
                </label>
                <input type="hidden" id="classificacao_risco" name="classificacao_risco" required>
                <div class="risk-buttons">
                  <div class="risk-btn azul" data-value="Azul" onclick="selecionarRisco('Azul', this)">
                    AZUL
                    <small>Não Urgente</small>
                  </div>
                  <div class="risk-btn verde" data-value="Verde" onclick="selecionarRisco('Verde', this)">
                    VERDE
                    <small>Pouco Urgente</small>
                  </div>
                  <div class="risk-btn amarelo" data-value="Amarelo" onclick="selecionarRisco('Amarelo', this)">
                    AMARELO
                    <small>Urgente</small>
                  </div>
                  <div class="risk-btn laranja" data-value="Laranja" onclick="selecionarRisco('Laranja', this)">
                    LARANJA
                    <small>Muito Urgente</small>
                  </div>
                  <div class="risk-btn vermelho" data-value="Vermelho" onclick="selecionarRisco('Vermelho', this)">
                    VERMELHO
                    <small>Emergência</small>
                  </div>
                </div>
                <div class="risk-selection-required" id="risco-selection-warning">
                  <i class="fas fa-exclamation-triangle mr-2"></i>Por favor, selecione uma classificação de risco clicando em um dos botões acima.
                </div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-12">
                <label for="anamnese_exame_fisico" class="form-label">Anamnese/Exame Físico</label>
                <textarea class="form-control" id="anamnese_exame_fisico" name="anamnese_exame_fisico" rows="3"></textarea>
              </div>
            </div>
            <div class="mb-3">
              <label for="observacao" class="form-label">Observações Adicionais</label>
              <textarea class="form-control" id="observacao" name="observacao" rows="3"></textarea>
            </div>
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save mr-2"></i>Salvar Triagem
              </button>
            </div>
          </form>
          
          <!-- Quadro de assinatura do enfermeiro -->
          <div class="nurse-signature mt-4" id="nurseSignature">
            <h5><i class="fas fa-user-nurse mr-2"></i>Enfermeiro Responsável</h5>
            <p id="nurseNome" style="font-weight: 600; font-size: 1.1rem;"></p>
            <p id="nurseNumero" class="text-muted"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Assinatura removido: assinatura automática após salvar -->

    <!-- Toast de Feedback -->
    <div class="toast-feedback" id="toastFeedback">
      <div class="toast-header">
        <i class="fas fa-check-circle"></i>
        <span id="toastTitle">Sucesso</span>
      </div>
      <div class="toast-body" id="toastMessage">
        Operação realizada com sucesso!
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Salvando triagem...</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ========== FUNÇÕES DE FEEDBACK VISUAL ==========
      
      function showToast(type, title, message, duration = 5000) {
        const toast = document.getElementById('toastFeedback');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = toast.querySelector('.toast-header i');
        
        // Remove classes anteriores
        toast.classList.remove('success', 'error', 'warning', 'show', 'hiding');
        
        // Define o tipo
        toast.classList.add(type);
        
        // Define ícone baseado no tipo
        toastIcon.className = 'fas';
        if (type === 'success') {
          toastIcon.classList.add('fa-check-circle');
        } else if (type === 'error') {
          toastIcon.classList.add('fa-exclamation-circle');
        } else if (type === 'warning') {
          toastIcon.classList.add('fa-exclamation-triangle');
        }
        
        // Define título e mensagem
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        // Mostra o toast
        toast.classList.add('show');
        
        // Auto-esconde após o duration
        setTimeout(() => {
          hideToast();
        }, duration);
      }
      
      function hideToast() {
        const toast = document.getElementById('toastFeedback');
        toast.classList.add('hiding');
        setTimeout(() => {
          toast.classList.remove('show', 'hiding');
        }, 400);
      }
      
      function showLoading(message = 'Salvando triagem...') {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        loadingText.textContent = message;
        overlay.classList.add('show');
      }
      
      function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('show');
      }
      
      // ========== FIM DAS FUNÇÕES DE FEEDBACK ==========
      
      // Botão: Paciente Evadiu / Não Compareceu
      document.addEventListener('DOMContentLoaded', function(){
        const btnEvasao = document.getElementById('btnEvasao');
        if (btnEvasao){
          btnEvasao.addEventListener('click', function(){
            const atendimentoId = document.getElementById('atendimento_id').value;
            if (!atendimentoId){
              alert('Atendimento não identificado.');
              return;
            }
            if (!confirm('Confirmar: marcar como Evasão e retirar da fila?')){
              return;
            }
            
            showLoading('Marcando como evasão...');
            
            fetch('/api/enfermeiro/atendimentos/' + atendimentoId + '/evasao', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(d => {
              hideLoading();
              if (d && d.success){
                showToast('success', 'Sucesso!', 'Marcado como Evasão com sucesso.');
                setTimeout(() => {
                  window.location.href = '/enfermeiro?view=triagem';
                }, 1500);
              } else {
                showToast('error', 'Erro!', 'Falha ao marcar evasão: ' + (d && d.message ? d.message : 'erro desconhecido'));
              }
            })
            .catch(err => {
              hideLoading();
              console.error('Erro ao marcar evasão:', err);
              showToast('error', 'Erro!', 'Erro ao marcar evasão.');
            });
          });
        }
      });

      // Toggle do campo DST: exibe campo de texto se checkbox estiver marcado
      document.getElementById('dst_checkbox').addEventListener('change', function() {
        const dstTextContainer = document.getElementById('dstTextContainer');
        dstTextContainer.style.display = this.checked ? 'block' : 'none';
      });

      // Exibe as seções de gestante e condições clínicas somente se o paciente for gestante
      document.getElementById('isGestante').addEventListener('change', function() {
        const gestanteFields = document.getElementById('gestanteFields');
        const condicoesClinicas = document.getElementById('condicoesClinicas');
        if(this.checked) {
          gestanteFields.style.display = 'block';
          condicoesClinicas.style.display = 'block';
        } else {
          gestanteFields.style.display = 'none';
          condicoesClinicas.style.display = 'none';
          // Limpa campos da seção de condições clínicas
          document.getElementById('itu').checked = false;
          document.getElementById('sheg').checked = false;
          document.getElementById('diabetes').checked = false;
          document.getElementById('cardiopata').checked = false;
          document.getElementById('tromboembolismo').checked = false;
          document.getElementById('hipertensao_arterial').checked = false;
          document.getElementById('cirugia').checked = false;
          document.getElementById('usa_insulina').checked = false;
          document.getElementById('anemia').checked = false;
          document.getElementById('toxoplasmose').checked = false;
          document.getElementById('abo_rh').value = "";
        }
      });

      // Checkboxes para datas: desabilitar/limpar quando marcados
      (function(){
        const ultimaMestruacaoChk = document.getElementById('ultima_mestruacao_desconhecida');
        const ultimaMestruacaoInput = document.getElementById('ultima_mestruacao');
        if (ultimaMestruacaoChk && ultimaMestruacaoInput) {
          ultimaMestruacaoChk.addEventListener('change', function(){
            if (this.checked) {
              ultimaMestruacaoInput.value = '';
              ultimaMestruacaoInput.setAttribute('disabled', 'disabled');
            } else {
              ultimaMestruacaoInput.removeAttribute('disabled');
            }
          });
        }
        const ultrassomChk = document.getElementById('ultrassom_nao_possui');
        const ultrassomInput = document.getElementById('data_primeira_ultrassom');
        if (ultrassomChk && ultrassomInput) {
          ultrassomChk.addEventListener('change', function(){
            if (this.checked) {
              ultrassomInput.value = '';
              ultrassomInput.setAttribute('disabled', 'disabled');
            } else {
              ultrassomInput.removeAttribute('disabled');
            }
          });
        }
      })();

      // Função para obter parâmetros da query string
      function getQueryParam(param) {
        let urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Verifica quais seções estão vazias
      function verificarCamposVazios() {
        let emptySections = [];

        // Sinais Vitais
        const sinaisVitaisIds = ['pressao', 'pulso', 'sp02', 'temp', 'peso', 'altura', 'fr', 'dx'];
        const sinaisVitaisPreenchido = sinaisVitaisIds.some(id => document.getElementById(id).value.trim() !== "");
        if (!sinaisVitaisPreenchido) {
          emptySections.push("Sinais Vitais");
        }

        // Triagem
        if(document.getElementById('triagem').value.trim() === ""){
          emptySections.push("Triagem");
        }

        // Alergias
        if(document.getElementById('alergias').value.trim() === ""){
          emptySections.push("Alergias");
        }

        // Se for gestante, verifica Informações de Gestante e Condições Clínicas
        if(document.getElementById('isGestante').checked){
          const gestanteIds = ['idade_gestacional_semanas', 'idade_gestacional_dias', 'altura_uterina', 'quantidade_de_gestacoes', 'ultima_mestruacao', 'bcf', 'data_primeira_ultrassom', 'abo_rh'];
          const gestantePreenchido = gestanteIds.some(id => {
            const campo = document.getElementById(id);
            return campo && campo.value.trim() !== "";
          });
          if(!gestantePreenchido){
            emptySections.push("Informações de Gestante");
          }

          const condicoes = document.querySelectorAll('#condicoesClinicas input[type="checkbox"]');
          const algumaCondicaoMarcada = Array.from(condicoes).some(checkbox => checkbox.checked);
          if(!algumaCondicaoMarcada){
            emptySections.push("Condições Clínicas");
          }
        }

        return emptySections;
      }

      // Carrega os dados do paciente via API
      function carregarDadosPaciente() {
        const pacienteId = getQueryParam('paciente_id');
        if (!pacienteId) {
          alert("Paciente não informado na URL.");
          return;
        }
        fetch('/api/enfermeiro/paciente_detalhado?paciente_id=' + pacienteId)
          .then(response => response.json())
          .then(data => {
            if(data.success) {
              const paciente = data.paciente;
              document.getElementById('pacienteCartaoSus').textContent = paciente.cartao_sus || '';
              document.getElementById('pacienteNome').textContent = paciente.nome || '';
              document.getElementById('pacienteNomeSocial').textContent = paciente.nome_social || '';
              document.getElementById('pacienteFiliacao').textContent = paciente.filiacao || '';
              document.getElementById('pacienteDataNasc').textContent = paciente.data_nascimento || '';
              document.getElementById('pacienteIdade').textContent = paciente.idade !== null ? paciente.idade : '';
              document.getElementById('pacienteSexo').textContent = paciente.sexo || '';
              document.getElementById('pacienteCpf').textContent = paciente.cpf || '';
              document.getElementById('pacienteEndereco').textContent = paciente.endereco || '';
              document.getElementById('pacienteMunicipio').textContent = paciente.municipio || '';
              document.getElementById('pacienteBairro').textContent = paciente.bairro || '';
              document.getElementById('pacienteTelefone').textContent = paciente.telefone || '';
              fetch('/api/enfermeiro/atendimento?paciente_id=' + pacienteId)
                .then(response => response.json())
                .then(atData => {
                  if(atData.success) {
                    document.getElementById('atendimento_id').value = atData.atendimento_id;
                  } else {
                    alert("Erro: " + atData.message);
                  }
                })
                .catch(error => {
                  console.error("Erro ao carregar atendimento:", error);
                  alert("Erro ao carregar o atendimento vinculado.");
                });
            } else {
              alert("Erro ao carregar os dados do paciente: " + data.message);
            }
          })
          .catch(error => {
            console.error("Erro:", error);
            alert("Erro ao carregar os dados do paciente.");
          });
      }

      // Carrega os dados do enfermeiro via API
      function carregarDadosEnfermeiro() {
        fetch('/api/enfermeiro/info')
          .then(response => response.json())
          .then(data => {
            if(data.success) {
              const info = data.funcionario;
              document.getElementById('nurseNome').textContent = info.nome;
              document.getElementById('nurseNumero').textContent = info.numero_profissional;
            } else {
              document.getElementById('nurseNome').textContent = "";
              document.getElementById('nurseNumero').textContent = "";
            }
          })
          .catch(error => {
            console.error("Erro ao carregar dados do enfermeiro:", error);
          });
      }

      // Submissão do formulário com validação e cálculo da idade gestacional em dias
      document.getElementById('triagemForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formEl = document.getElementById('triagemForm');
        
        // Validar classificação de risco
        const classificacaoRisco = document.getElementById('classificacao_risco').value;
        if (!classificacaoRisco) {
          console.log('⚠️ Tentou submeter sem selecionar risco');
          
          // Adiciona efeito visual de shake
          const containerRisk = document.querySelector('.risk-buttons');
          const warningElement = document.getElementById('risco-selection-warning');
          
          if (containerRisk) {
            containerRisk.classList.add('needs-selection');
            // Remove a classe após a animação
            setTimeout(() => {
              containerRisk.classList.remove('needs-selection');
            }, 500);
          }
          
          if (warningElement) {
            warningElement.classList.add('show');
          }
          
          // Scroll suave até a seção de risco
          containerRisk.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Toast de aviso
          showToast('warning', 'Atenção!', 'Por favor, selecione a classificação de risco clicando em um dos botões coloridos.');
          return;
        }
        
        if (!formEl.checkValidity()) {
          formEl.classList.add('was-validated');
          const firstInvalid = formEl.querySelector(':invalid');
          if (firstInvalid) { 
            firstInvalid.focus();
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          showToast('warning', 'Atenção!', 'Preencha os campos obrigatórios marcados com *');
          return;
        }
        const atendimentoId = document.getElementById('atendimento_id').value;
        if (!atendimentoId) {
          showToast('error', 'Erro!', 'Atendimento não identificado.');
          return;
        }

        const emptySections = verificarCamposVazios();
        if(emptySections.length > 0) {
          const confirmMsg = "Os seguintes quadros estão vazios: " + emptySections.join(", ") +
                             ".\nDeseja concluir a triagem mesmo assim?";
          if(!window.confirm(confirmMsg)) {
            return;
          }
        }
        
        // Mostra loading
        showLoading('Salvando triagem...');

        const isGestante = document.getElementById('isGestante').checked;
        // Se for gestante, usamos o endpoint de transformação; senão, o endpoint de atualização da triagem
        const endpoint = isGestante ?
          '/api/atendimentos/' + atendimentoId + '/transformar_gestante' :
          '/api/atendimentos/' + atendimentoId + '/triagem';

        // Calcula a idade gestacional total em dias se for gestante; caso contrário, ignora
        let totalDias = 0;
        if(isGestante) {
          let semanas = parseInt(document.getElementById('idade_gestacional_semanas').value) || 0;
          let dias = parseInt(document.getElementById('idade_gestacional_dias').value) || 0;
          totalDias = semanas * 7 + dias;
        }

        // Função para limpar e validar valores numéricos
        function limparValorNumerico(valor, campo) {
          if (!valor || valor.trim() === '') return '';

          // Remove unidades comuns e caracteres não numéricos
          let valorLimpo = valor.toString()
            .replace(/[^\d.,]/g, '')  // Remove tudo exceto dígitos, ponto e vírgula
            .replace(',', '.');       // Converte vírgula para ponto

          // Converte para número e valida
          const numero = parseFloat(valorLimpo);
          if (isNaN(numero)) {
            alert(`Valor inválido para ${campo}: ${valor}`);
            return '';
          }

          return numero.toString();
        }

        const formData = {
          pressao: document.getElementById('pressao').value,
          pulso: limparValorNumerico(document.getElementById('pulso').value, 'Pulso'),
          sp02: limparValorNumerico(document.getElementById('sp02').value, 'SpO₂'),
          temp: limparValorNumerico(document.getElementById('temp').value, 'Temperatura'),
          peso: limparValorNumerico(document.getElementById('peso').value, 'Peso'),
          altura: document.getElementById('altura').value,
          fr: limparValorNumerico(document.getElementById('fr').value, 'FR'),
          dx: document.getElementById('dx').value,
          triagem: document.getElementById('triagem').value,
          alergias: document.getElementById('alergias').value,
          classificacao_risco: document.getElementById('classificacao_risco').value,
          anamnese_exame_fisico: document.getElementById('anamnese_exame_fisico').value,
          observacao: document.getElementById('observacao').value,
          // Envia a idade gestacional total em dias (se for gestante)
          idade_gestacional: totalDias,
          idade_gestacional_semanas: document.getElementById('idade_gestacional_semanas').value,
          idade_gestacional_dias: document.getElementById('idade_gestacional_dias').value,
          altura_uterina: limparValorNumerico(document.getElementById('altura_uterina').value, 'Altura Uterina'),
          quantidade_de_gestacoes: limparValorNumerico(document.getElementById('quantidade_de_gestacoes').value, 'Quantidade de Gestações'),
          ultima_mestruacao: document.getElementById('ultima_mestruacao').value,
          bcf: limparValorNumerico(document.getElementById('bcf').value, 'BCF'),
          data_primeira_ultrassom: document.getElementById('data_primeira_ultrassom').value,
          // Condições clínicas (apenas se gestante estiver marcada)
          itu: document.getElementById('itu').checked,
          sheg: document.getElementById('sheg').checked,
          diabetes: document.getElementById('diabetes').checked,
          cardiopata: document.getElementById('cardiopata').checked,
          tromboembolismo: document.getElementById('tromboembolismo').checked,
          hipertensao_arterial: document.getElementById('hipertensao_arterial').checked,
          cirugia: document.getElementById('cirugia').checked,
          usa_insulina: document.getElementById('usa_insulina').checked,
          anemia: document.getElementById('anemia').checked,
          abo_rh: document.getElementById('abo_rh').value,
          dst: document.getElementById('dst_checkbox').checked ? document.getElementById('dst_text').value : "",
          toxoplasmose: document.getElementById('toxoplasmose').checked
        };

        fetch(endpoint, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
          if(!data.success) {
            hideLoading();
            showToast('error', 'Erro ao Salvar!', data.message || 'Erro desconhecido ao salvar triagem.');
            return;
          }
          
          // Se for gestante, atualiza o campo de atendimento com o novo ID retornado
          if(isGestante && data.novo_id) {
            document.getElementById('atendimento_id').value = data.novo_id;
          }
          
          // Atualiza mensagem do loading
          showLoading('Assinando triagem...');
          
          // Assinatura automática
          const assinaturaEndpoint = isGestante ?
            ('/api/atendimentos_gestantes/' + (data.novo_id || atendimentoId) + '/assinatura') :
            ('/api/atendimentos/' + atendimentoId + '/assinatura');
          return fetch(assinaturaEndpoint, { method: 'PUT', headers: { 'Content-Type': 'application/json' }})
            .then(resp => resp.json())
            .then(r => {
              hideLoading();
              if(r && r.success){
                showToast('success', 'Sucesso!', 'Triagem concluída e assinada com sucesso.');
                setTimeout(() => {
                  window.location.href = '/enfermeiro?view=triagem';
                }, 2000);
              } else {
                showToast('warning', 'Atenção!', 'Triagem salva, mas falhou ao assinar: ' + (r && r.message ? r.message : 'desconhecido'));
                setTimeout(() => {
                  window.location.href = '/enfermeiro?view=triagem';
                }, 3000);
              }
            });
        })
        .catch(error => {
          hideLoading();
          console.error("Erro:", error);
          showToast('error', 'Erro!', 'Erro ao salvar triagem. Tente novamente.');
        });
      });

      // Removido: fluxo de assinatura manual (agora automático após salvar)

      // Função para selecionar classificação de risco
      function selecionarRisco(valor, elemento) {
        console.log('🎯 Classificação selecionada:', valor);
        
        // Remove 'active' de todos os botões
        document.querySelectorAll('.risk-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Adiciona 'active' ao botão clicado
        elemento.classList.add('active');
        
        // Atualiza o campo hidden
        const campoRisco = document.getElementById('classificacao_risco');
        campoRisco.value = valor;
        
        // Remove avisos de erro
        const containerRisk = document.querySelector('.risk-buttons');
        const warningElement = document.getElementById('risco-selection-warning');
        
        if (containerRisk) {
          containerRisk.classList.remove('needs-selection');
        }
        
        if (warningElement) {
          warningElement.classList.remove('show');
        }
        
        // Feedback visual de confirmação com mini-pulso
        elemento.style.transition = 'none';
        elemento.style.transform = 'scale(1.08)';
        setTimeout(() => {
          elemento.style.transition = '';
          elemento.style.transform = '';
        }, 150);
        
        // Log de confirmação com ícone
        console.log('✅ Risco definido como:', valor);
        
        // Pequeno feedback sonoro visual (vibração visual)
        if (navigator.vibrate) {
          navigator.vibrate(50); // Vibração em dispositivos móveis
        }
      }

      window.onload = function() {
        carregarDadosPaciente();
        carregarDadosEnfermeiro();
        
        // Adiciona evento de click em toda a área do botão para melhor responsividade
        document.querySelectorAll('.risk-btn').forEach(btn => {
          // Adiciona um pulso sutil inicial para chamar atenção
          btn.style.animation = 'pulse-subtle 2s ease-in-out 3';
          
          // Melhora a área clicável
          btn.style.cursor = 'pointer';
          
          // Remove a animação após alguns segundos
          setTimeout(() => {
            btn.style.animation = '';
          }, 6000);
        });
      };
      
      // Animação sutil de pulso
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse-subtle {
          0%, 100% { opacity: 0.85; }
          50% { opacity: 1; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        }
      `;
      document.head.appendChild(style);
    </script>
  <script>
    // Máscara RTL para Peso: digitação da direita para esquerda (NNN,N)
    function formatPesoProgressive(input){
      // Mantém apenas dígitos, máximo 4 caracteres
      let digits = (input.value || '').replace(/\D/g, '').slice(0, 4);
      if(digits.length === 0){ input.value = ''; return; }
      if(digits.length <= 2){
        // 1-2 dígitos: mostra como inteiro (5 -> 5, 52 -> 52)
        input.value = digits;
        return;
      }
      // 3-4 dígitos: separa última casa com vírgula (523 -> 52,3 ; 5234 -> 523,4)
      input.value = digits.slice(0, digits.length - 1) + ',' + digits.slice(-1);
    }
  </script>
  </body>
</html>
