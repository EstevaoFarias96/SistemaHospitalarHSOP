<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aguardando Médico</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --azul-principal: #4A90E2;
      --azul-claro: #E8F4FF;
      --azul-medio: #7AB8F5;
      --branco-gelo: #F8FCFF;
      --cinza-texto: #4A5568;
      --cinza-claro: #E2E8F0;
      --sombra-suave: 0 2px 12px rgba(74, 144, 226, 0.08);
      --sombra-media: 0 4px 20px rgba(74, 144, 226, 0.12);
    }
    
    body { 
      background: linear-gradient(135deg, var(--branco-gelo) 0%, var(--azul-claro) 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    
    .header { 
      background: white;
      border-radius: 1rem;
      padding: 18px 24px;
      margin: 16px 0;
      box-shadow: var(--sombra-suave);
      border-left: 5px solid var(--azul-principal);
    }
    
    .card-item { 
      border: 0;
      border-radius: 0.875rem;
      box-shadow: var(--sombra-media);
      background: white;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
      margin-bottom: 12px;
    }
    
    .card-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--azul-principal), var(--azul-medio));
    }
    
    .card-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(74, 144, 226, 0.18);
    }
    
    .risk-badge { font-weight: 600; }
    .triagem-text { 
      white-space: pre-wrap;
      color: var(--cinza-texto);
      line-height: 1.5;
    }
    
    #resultadosPesquisa { 
      box-shadow: var(--sombra-media);
      border: 1px solid var(--azul-claro);
      border-top: none;
      margin-top: -1px;
      border-radius: 0 0 0.75rem 0.75rem;
      background: white;
    }
    
    #inputPesquisaAtendimento {
      border: 2px solid var(--azul-claro);
      border-radius: 0.75rem;
      transition: all 0.3s ease;
    }
    
    #inputPesquisaAtendimento:focus {
      border-color: var(--azul-principal);
      box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
    }
    
    /* Títulos e textos */
    h3 {
      color: var(--azul-principal);
      font-weight: 600;
      font-size: 1.5rem;
      margin-bottom: 0;
    }
    
    .text-muted {
      color: var(--cinza-texto) !important;
    }
    
    /* Botões estilizados */
    .btn {
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
      box-shadow: var(--sombra-suave);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
      color: white;
    }
    
    .btn-outline-secondary {
      background: white;
      color: var(--cinza-texto);
      border: 2px solid var(--cinza-claro) !important;
    }
    
    .btn-outline-secondary:hover {
      background: #6B7280;
      color: white;
      border-color: #6B7280 !important;
    }
    
    .btn-outline-primary {
      background: white;
      color: var(--azul-principal);
      border: 2px solid var(--azul-principal) !important;
    }
    
    .btn-outline-primary:hover {
      background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
      color: white;
    }
    
    /* Tabs harmonizadas */
    .nav-tabs {
      border-bottom: 2px solid var(--azul-claro);
    }
    
    .nav-tabs .nav-link {
      color: var(--cinza-texto);
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link.active {
      color: var(--azul-principal);
      background-color: transparent;
      border-bottom: 3px solid var(--azul-principal);
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
      color: var(--azul-medio);
      border-bottom: 3px solid var(--azul-claro);
    }
    
    /* Estilos para sistema de ciclos de reavaliação */
    .ciclo-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 10px 12px;
      background: var(--azul-claro);
      border-radius: 0.5rem;
      border-left: 3px solid var(--azul-medio);
      transition: all 0.3s ease;
    }
    .ciclo-container.alerta { 
      border-left-color: #F59E0B; 
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
    }
    .ciclo-container.urgente { 
      border-left-color: #EF4444; 
      background: linear-gradient(135deg, #FEE2E2, #FECACA);
    }
    .ciclo-container.observacao { 
      border-left-color: #F59E0B; 
      background: linear-gradient(135deg, #FFEDD5, #FED7AA);
    }
    
    .ciclo-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #6B7280;
      color: white;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }
    .ciclo-badge.ciclo-1 { background: linear-gradient(135deg, #10B981, #059669); }
    .ciclo-badge.ciclo-2 { background: linear-gradient(135deg, #F59E0B, #D97706); color: white; }
    .ciclo-badge.ciclo-3 { background: linear-gradient(135deg, #EF4444, #DC2626); }
    
    .ciclo-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .ciclo-tempo {
      font-size: 13px;
      font-weight: 600;
      color: var(--cinza-texto);
      line-height: 1.3;
    }
    .ciclo-tempo.alerta { color: #92400E; }
    .ciclo-tempo.urgente { color: #991B1B; }
    
    .ciclo-status {
      font-size: 12px;
      color: #6B7280;
      font-weight: 500;
      line-height: 1.3;
    }
    .ciclo-status.alerta { color: #92400E; }
    .ciclo-status.urgente { color: #991B1B; font-weight: 600; }
    
    .tempo-barra {
      height: 5px;
      background-color: rgba(0,0,0,0.08);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    .tempo-barra-progresso {
      height: 100%;
      background: linear-gradient(90deg, #10B981, #059669);
      transition: width 0.3s ease, background 0.3s ease;
    }
    .tempo-barra-progresso.alerta { background: linear-gradient(90deg, #F59E0B, #D97706); }
    .tempo-barra-progresso.urgente { background: linear-gradient(90deg, #EF4444, #DC2626); }
    
    .badge-observacao {
      background: linear-gradient(135deg, #F59E0B, #D97706);
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 0.375rem;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
      animation: pulse-subtle 2s infinite;
      line-height: 1;
    }
    
    @keyframes pulse-subtle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.02); }
    }
    
    /* Cards de resultado vazio */
    .empty-state {
      background: white;
      border-radius: 1rem;
      padding: 32px 24px;
      text-align: center;
      box-shadow: var(--sombra-suave);
    }
    
    .empty-state i {
      color: var(--azul-medio);
      opacity: 0.5;
      margin-bottom: 12px;
    }
    
    .empty-state h5 {
      color: var(--cinza-texto);
      font-weight: 500;
      font-size: 16px;
      margin: 0;
    }
    
    /* Loading spinner */
    .spinner-border-primary {
      color: var(--azul-principal) !important;
    }
    
    /* Lista de resultados de pesquisa */
    #resultadosPesquisa .list-group-item {
      border: none;
      border-bottom: 1px solid var(--azul-claro);
      transition: all 0.2s ease;
    }
    
    #resultadosPesquisa .list-group-item:hover {
      background: var(--azul-claro);
      transform: translateX(4px);
    }
    
    #resultadosPesquisa .list-group-item:last-child {
      border-bottom: none;
    }
    
    /* Badge de status nos resultados */
    .badge-success { background: linear-gradient(135deg, #10B981, #059669); }
    .badge-secondary { background: linear-gradient(135deg, #6B7280, #4B5563); }
    .badge-danger { background: linear-gradient(135deg, #EF4444, #DC2626); }
    .badge-warning { background: linear-gradient(135deg, #F59E0B, #D97706); }
    .badge-primary { background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio)); }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="header">
      <div class="w-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h3 class="mb-1"><i class="fas fa-user-md mr-2"></i>Atendimentos Médicos</h3>
            <small class="text-muted">Visualize e gerencie seus atendimentos por categoria</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="position-relative" style="width: 300px;">
              <input type="text" id="inputPesquisaAtendimento" class="form-control" placeholder="Buscar por nº atendimento..." autocomplete="off">
              <div id="resultadosPesquisa" class="list-group position-absolute w-100" style="z-index: 1000; max-height: 300px; overflow-y: auto; display: none;"></div>
            </div>
            <select id="setorMedico" class="form-control" style="width: 200px;">
              <option value="">Selecione o setor</option>
              <option value="Consultório 1">Consultório 1</option>
              <option value="Consultório 2">Consultório 2</option>
              <option value="Maternidade">Maternidade</option>
              <option value="Centro Cirúrgico">Centro Cirúrgico</option>
            </select>
            <button id="btnAtualizar" class="btn btn-primary"><i class="fas fa-sync-alt mr-1"></i>Atualizar</button>
            <a href="/medico" class="btn btn-outline-secondary"><i class="fas fa-arrow-left mr-1"></i>Voltar</a>
          </div>
        </div>

        <ul class="nav nav-tabs" id="tabsMedico" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link active" id="tab-aguardando" data-toggle="tab" href="#pane-aguardando" role="tab" aria-controls="pane-aguardando" aria-selected="true">Aguardando Médico</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="tab-triagem" data-toggle="tab" href="#pane-triagem" role="tab" aria-controls="pane-triagem" aria-selected="false">Aguardando Triagem</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="tab-gestantes" data-toggle="tab" href="#pane-gestantes" role="tab" aria-controls="pane-gestantes" aria-selected="false">Gestantes</a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link" id="tab-reavaliacao" data-toggle="tab" href="#pane-reavaliacao" role="tab" aria-controls="pane-reavaliacao" aria-selected="false">Reavaliação</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="tab-content" id="tabsConteudo" style="margin-top: 16px; margin-bottom: 16px;">
      <div class="tab-pane fade show active" id="pane-aguardando" role="tabpanel" aria-labelledby="tab-aguardando">
        <div id="lista-aguardando">
          <div class="empty-state">
            <div class="spinner-border spinner-border-primary" role="status"><span class="sr-only">Carregando...</span></div>
            <p class="text-muted mt-3 mb-0">Carregando atendimentos...</p>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="pane-triagem" role="tabpanel" aria-labelledby="tab-triagem">
        <div id="lista-triagem">
          <div class="empty-state">
            <div class="spinner-border spinner-border-primary" role="status"><span class="sr-only">Carregando...</span></div>
            <p class="text-muted mt-3 mb-0">Carregando pacientes aguardando triagem...</p>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="pane-gestantes" role="tabpanel" aria-labelledby="tab-gestantes">
        <div id="lista-gestantes">
          <div class="empty-state">
            <div class="spinner-border spinner-border-primary" role="status"><span class="sr-only">Carregando...</span></div>
            <p class="text-muted mt-3 mb-0">Carregando pacientes gestantes...</p>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="pane-reavaliacao" role="tabpanel" aria-labelledby="tab-reavaliacao">
        <div id="lista-reavaliacao">
          <div class="empty-state">
            <div class="spinner-border spinner-border-primary" role="status"><span class="sr-only">Carregando...</span></div>
            <p class="text-muted mt-3 mb-0">Carregando reavaliações...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    function calcularIdade(data) {
      if (!data) return 'N/A';
      const d = new Date(data);
      const h = new Date();
      let idade = h.getFullYear() - d.getFullYear();
      const m = h.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && h.getDate() < d.getDate())) idade--;
      return idade;
    }

    function badgeRisco(risco) {
      if (!risco) return '<span class="badge badge-secondary risk-badge">Sem classificação</span>';
      const r = (''+risco).toLowerCase();
      if (r.includes('vermelho')) return '<span class="badge badge-danger risk-badge">Vermelho</span>';
      if (r.includes('laranja')) return '<span class="badge badge-warning risk-badge" style="color:#000">Laranja</span>';
      if (r.includes('amarelo')) return '<span class="badge badge-warning risk-badge" style="color:#000">Amarelo</span>';
      if (r.includes('verde')) return '<span class="badge badge-success risk-badge">Verde</span>';
      if (r.includes('azul')) return '<span class="badge badge-primary risk-badge">Azul</span>';
      return '<span class="badge badge-info risk-badge">' + risco + '</span>';
    }

    function renderLista(containerSel, itens, vazioHtml) {
      if (!itens || itens.length === 0) { $(containerSel).html(vazioHtml); return; }
      let html = '';
      itens.forEach(item => {
        // Pega o ID do paciente - pode estar em paciente_id ou id
        const pacienteId = item.paciente_id || item.id_paciente || item.id;
        html += `
          <div class="card card-item mb-2">
            <div class="card-body" style="padding: 16px;">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h5 class="mb-1" style="color: var(--cinza-texto); font-weight: 600; font-size: 1.1rem;">${item.nome || 'Paciente'}</h5>
                  <div class="text-muted" style="font-size: 13px;">${item.idade != null ? item.idade + ' anos' : 'Idade N/A'}${item.horario_triagem ? ' • Triagem: ' + new Date(item.horario_triagem).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : ''}</div>
                </div>
                <div>${badgeRisco(item.classificacao_risco)}</div>
              </div>
              <div class="triagem-text" style="padding: 10px; background: var(--azul-claro); border-radius: 0.5rem; font-size: 13px;">${(item.triagem || 'Sem texto de triagem').replace(/\n/g,'<br>')}</div>
              <div class="mt-2 text-right">
                <button class="btn btn-success btn-sm mr-2" onclick="chamarPaciente(${pacienteId}, '${(item.nome || 'Paciente').replace(/'/g, "\\'")}', '${item.atendimento_id}')"><i class="fas fa-bell mr-1"></i>Chamar Paciente</button>
                <a class="btn btn-outline-primary btn-sm" href="/medico/atendimento/${item.atendimento_id}"><i class="fas fa-notes-medical mr-1"></i>Abrir atendimento</a>
              </div>
            </div>
          </div>
        `;
      });
      $(containerSel).html(html);
    }

    // Função para chamar paciente no chamador
    function chamarPaciente(pacienteId, pacienteNome, atendimentoId) {
      console.log('Chamando paciente:', pacienteId, pacienteNome, atendimentoId);
      
      // Verifica se o setor foi selecionado
      const setor = $('#setorMedico').val();
      if (!setor) {
        mostrarErro('Por favor, selecione o setor antes de chamar o paciente.');
        $('#setorMedico').focus();
        return;
      }
      
      // Define os dados para o modal
      window.chamadoTemp = {
        id_paciente: pacienteId,
        nome: pacienteNome,
        id_atendimento: atendimentoId,
        local: setor
      };
      
      // Atualiza o modal com os dados do paciente
      $('#modalChamarPacienteNome').text(pacienteNome);
      $('#modalChamarPacienteLocal').text(setor);
      
      // Abre o modal de confirmação
      $('#modalChamarPaciente').modal('show');
    }

    // Função para confirmar o chamado
    function confirmarChamado() {
      if (!window.chamadoTemp) return;
      
      const dados = {
        id_paciente: window.chamadoTemp.id_paciente,
        id_atendimento: window.chamadoTemp.id_atendimento,
        local: window.chamadoTemp.local
      };
      
      // Mostra loading no botão
      const btnConfirmar = $('#btnConfirmarChamado');
      const textoOriginal = btnConfirmar.html();
      btnConfirmar.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Chamando...');
      
      // Enviar chamado para o servidor
      fetch('/api/chamados/criar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
      })
      .then(response => response.json())
      .then(data => {
        btnConfirmar.prop('disabled', false).html(textoOriginal);
        
        if (data.success) {
          // Fecha modal de confirmação
          $('#modalChamarPaciente').modal('hide');
          
          // Mostra modal de sucesso
          $('#modalSucessoNome').text(window.chamadoTemp.nome);
          $('#modalSucessoLocal').text(window.chamadoTemp.local);
          $('#modalSucesso').modal('show');
          
          // Fecha automaticamente após 3 segundos
          setTimeout(() => {
            $('#modalSucesso').modal('hide');
          }, 3000);
        } else {
          $('#modalChamarPaciente').modal('hide');
          mostrarErro(data.message || 'Erro ao chamar paciente');
        }
      })
      .catch(error => {
        btnConfirmar.prop('disabled', false).html(textoOriginal);
        console.error('Erro:', error);
        $('#modalChamarPaciente').modal('hide');
        mostrarErro('Erro ao chamar paciente. Verifique sua conexão.');
      });
    }

    // Função para mostrar erro
    function mostrarErro(mensagem) {
      $('#modalErroMensagem').text(mensagem);
      $('#modalErro').modal('show');
    }

    function renderListaReavaliacao(containerSel, itens, vazioHtml) {
      if (!itens || itens.length === 0) { $(containerSel).html(vazioHtml); return; }
      let html = '';
      itens.forEach(item => {
        // Determinar classes de alerta
        const ciclo = item.ciclo_atual || 1;
        const passou2h = item.passou_2_horas;
        const precisaObs = item.precisa_observacao;
        const horas = item.horas_decorridas || 0;
        const minutos = item.minutos_para_reavaliacao || 0;
        
        let containerClass = '';
        let tempoClass = '';
        let statusClass = '';
        let statusTexto = '';
        let progressoPct = 0;
        
        if (precisaObs) {
          containerClass = 'observacao';
          tempoClass = 'urgente';
          statusClass = 'urgente';
          statusTexto = '<i class="fas fa-exclamation-triangle mr-1"></i>ATENÇÃO: Necessária abertura de OBSERVAÇÃO';
        } else if (passou2h) {
          containerClass = 'urgente';
          tempoClass = 'urgente';
          statusClass = 'urgente';
          statusTexto = '<i class="fas fa-clock mr-1"></i>Reavaliação ATRASADA';
          progressoPct = 100;
        } else if (horas >= 1.5) {
          containerClass = 'alerta';
          tempoClass = 'alerta';
          statusClass = 'alerta';
          statusTexto = '<i class="fas fa-clock mr-1"></i>Próximo da reavaliação';
          progressoPct = Math.min((horas / 2) * 100, 100);
        } else {
          statusTexto = minutos > 0 ? `Próxima reavaliação em ${Math.floor(minutos)} minutos` : 'Aguardando reavaliação';
          progressoPct = Math.min((horas / 2) * 100, 100);
        }
        
        const progressoClass = passou2h ? 'urgente' : (horas >= 1.5 ? 'alerta' : '');
        
        // Horário de referência
        const horarioRef = item.horario_medicacao || item.horario_consulta_medica;
        const horarioTexto = horarioRef ? new Date(horarioRef).toLocaleString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }) : 'N/A';
        
        // Pega o ID do paciente
        const pacienteId = item.paciente_id || item.id_paciente || item.id;
        
        html += `
          <div class="card card-item mb-2">
            <div class="card-body" style="padding: 16px;">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h5 class="mb-1" style="color: var(--cinza-texto); font-weight: 600; font-size: 1.1rem;">
                    ${item.nome || 'Paciente'}
                    ${precisaObs ? '<span class="badge-observacao ml-2">OBSERVAÇÃO</span>' : ''}
                  </h5>
                  <div class="text-muted" style="font-size: 13px;">
                    ${item.idade != null ? item.idade + ' anos' : 'Idade N/A'}
                    ${item.horario_triagem ? ' • ' + new Date(item.horario_triagem).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : ''}
                  </div>
                </div>
                <div>${badgeRisco(item.classificacao_risco)}</div>
              </div>
              
              <div class="triagem-text" style="padding: 10px; background: var(--azul-claro); border-radius: 0.5rem; font-size: 13px; margin-bottom: 8px;">${(item.triagem || 'Sem texto de triagem').replace(/\n/g,'<br>')}</div>
              
              <div class="ciclo-container ${containerClass}">
                <div class="ciclo-badge ciclo-${ciclo}">${ciclo}</div>
                <div class="ciclo-info">
                  <div class="ciclo-tempo ${tempoClass}">
                    <strong>Ciclo ${ciclo}/3</strong> • ${horarioTexto} • ${horas.toFixed(1)}h
                  </div>
                  <div class="ciclo-status ${statusClass}">${statusTexto}</div>
                  ${!precisaObs ? `
                  <div class="tempo-barra">
                    <div class="tempo-barra-progresso ${progressoClass}" style="width: ${progressoPct}%"></div>
                  </div>
                  ` : ''}
                </div>
              </div>
              
              <div class="mt-2 text-right">
                <button class="btn btn-success btn-sm mr-2" onclick="chamarPaciente(${pacienteId}, '${(item.nome || 'Paciente').replace(/'/g, "\\'")}', '${item.atendimento_id}')"><i class="fas fa-bell mr-1"></i>Chamar Paciente</button>
                <a class="btn btn-outline-primary btn-sm" href="/medico/atendimento/${item.atendimento_id}">
                  <i class="fas fa-notes-medical mr-1"></i>${precisaObs ? 'Definir Conduta' : 'Reavaliar'}
                </a>
              </div>
            </div>
          </div>
        `;
      });
      $(containerSel).html(html);
    }

    function setTabCount(tabId, baseLabel, count){
      const n = (typeof count === 'number' && count >= 0) ? count : 0;
      $('#'+tabId).text(`${baseLabel} (${n})`);
    }

    function carregarContadores(){
      Promise.all([
        fetch('/api/medico/atendimentos/aguardando').then(r=>r.json()).catch(()=>({atendimentos:[]})),
        fetch('/api/medico/atendimentos/aguardando-triagem').then(r=>r.json()).catch(()=>({atendimentos:[]})),
        fetch('/api/medico/atendimentos/gestantes').then(r=>r.json()).catch(()=>({atendimentos:[]})),
        fetch('/api/medico/atendimentos/reavaliacao-medicacao').then(r=>r.json()).catch(()=>({atendimentos:[]}))
      ]).then(([aguardando, triagem, gestantes, reav])=>{
        setTabCount('tab-aguardando', 'Aguardando Médico', (aguardando.atendimentos||[]).length);
        setTabCount('tab-triagem', 'Aguardando Triagem', (triagem.atendimentos||[]).length);
        setTabCount('tab-gestantes', 'Gestantes', (gestantes.atendimentos||[]).length);
        setTabCount('tab-reavaliacao', 'Reavaliação', (reav.atendimentos||[]).length);
      });
    }

    function carregarAba(tipo) {
      if (tipo === 'aguardando') {
        fetch('/api/medico/atendimentos/aguardando')
          .then(r => r.json())
          .then(data => {
            if (!data.success) { $('#lista-aguardando').html('<p class="text-danger">Erro ao carregar</p>'); return; }
            renderLista('#lista-aguardando', data.atendimentos, '<div class="empty-state"><i class="fas fa-check-circle fa-3x"></i><h5>Nenhum atendimento aguardando</h5></div>');
            setTabCount('tab-aguardando', 'Aguardando Médico', (data.atendimentos||[]).length);
          })
          .catch(() => { $('#lista-aguardando').html('<p class="text-danger">Erro ao carregar dados</p>'); });
      } else if (tipo === 'triagem') {
        fetch('/api/medico/atendimentos/aguardando-triagem')
          .then(r => r.json())
          .then(data => {
            if (!data.success) { $('#lista-triagem').html('<p class="text-danger">Erro ao carregar</p>'); return; }
            renderLista('#lista-triagem', data.atendimentos, '<div class="empty-state"><i class="fas fa-info-circle fa-3x"></i><h5>Sem pacientes aguardando triagem</h5></div>');
            setTabCount('tab-triagem', 'Aguardando Triagem', (data.atendimentos||[]).length);
          })
          .catch(() => { $('#lista-triagem').html('<p class="text-danger">Erro ao carregar dados</p>'); });
      } else if (tipo === 'gestantes') {
        fetch('/api/medico/atendimentos/gestantes')
          .then(r => r.json())
          .then(data => {
            if (!data.success) { $('#lista-gestantes').html('<p class="text-danger">Erro ao carregar</p>'); return; }
            renderLista('#lista-gestantes', data.atendimentos, '<div class="empty-state"><i class="fas fa-baby fa-3x"></i><h5>Sem pacientes gestantes</h5></div>');
            setTabCount('tab-gestantes', 'Gestantes', (data.atendimentos||[]).length);
          })
          .catch(() => { $('#lista-gestantes').html('<p class="text-danger">Erro ao carregar dados</p>'); });
      } else if (tipo === 'reavaliacao') {
        fetch('/api/medico/atendimentos/reavaliacao-medicacao')
          .then(r => r.json())
          .then(data => {
            if (!data.success) { $('#lista-reavaliacao').html('<p class="text-danger">Erro ao carregar</p>'); return; }
            renderListaReavaliacao('#lista-reavaliacao', data.atendimentos, '<div class="empty-state"><i class="fas fa-info-circle fa-3x"></i><h5>Sem pacientes para reavaliação</h5></div>');
            setTabCount('tab-reavaliacao', 'Reavaliação', (data.atendimentos||[]).length);
          })
          .catch(() => { $('#lista-reavaliacao').html('<p class="text-danger">Erro ao carregar dados</p>'); });
      }
    }

    $(function(){
      // Carrega o setor salvo do localStorage
      const setorSalvo = localStorage.getItem('setorMedico');
      if (setorSalvo) {
        $('#setorMedico').val(setorSalvo);
      }
      
      // Salva o setor quando alterado
      $('#setorMedico').on('change', function() {
        const setor = $(this).val();
        if (setor) {
          localStorage.setItem('setorMedico', setor);
          console.log('Setor selecionado:', setor);
        }
      });
      
      carregarAba('aguardando');
      carregarContadores();
      $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const id = $(e.target).attr('id');
        if (id === 'tab-aguardando') carregarAba('aguardando');
        if (id === 'tab-triagem') carregarAba('triagem');
        if (id === 'tab-gestantes') carregarAba('gestantes');
        if (id === 'tab-reavaliacao') carregarAba('reavaliacao');
        carregarContadores();
      });
      $('#btnAtualizar').click(function(){
        const btn = $(this); const icon = btn.find('i');
        btn.prop('disabled', true); icon.addClass('fa-spin');
        const activeId = $('.nav-link.active').attr('id');
        if (activeId === 'tab-aguardando') carregarAba('aguardando');
        if (activeId === 'tab-triagem') carregarAba('triagem');
        if (activeId === 'tab-gestantes') carregarAba('gestantes');
        if (activeId === 'tab-reavaliacao') carregarAba('reavaliacao');
        carregarContadores();
        setTimeout(()=>{ btn.prop('disabled', false); icon.removeClass('fa-spin'); }, 800);
      });

      // Pesquisa de atendimentos por número
      let timeoutPesquisa;
      $('#inputPesquisaAtendimento').on('input', function(){
        const termo = $(this).val().trim();
        clearTimeout(timeoutPesquisa);
        if (termo.length < 2) {
          $('#resultadosPesquisa').hide().html('');
          return;
        }
        timeoutPesquisa = setTimeout(() => {
          fetch(`/api/medico/atendimento/buscar?numero=${encodeURIComponent(termo)}`)
            .then(r => r.json())
            .then(data => {
              if (!data.success || !data.atendimentos || data.atendimentos.length === 0) {
                $('#resultadosPesquisa').html('<div class="list-group-item text-muted">Nenhum atendimento encontrado</div>').show();
                return;
              }
              let html = '';
              data.atendimentos.forEach(atend => {
                const statusClass = atend.status_finalizado ? 'badge-secondary' : 'badge-success';
                const statusText = atend.status_finalizado ? 'Finalizado' : 'Aberto';
                html += `<a href="#" class="list-group-item list-group-item-action item-atendimento" data-atendimento-id="${atend.id}" data-status="${atend.status}" data-status-finalizado="${atend.status_finalizado}">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Atendimento #${atend.id}</h6>
                    <small><span class="badge ${statusClass}">${statusText}</span></small>
                  </div>
                  <div class="d-flex w-100 justify-content-between">
                    <small class="text-muted">${atend.paciente_nome || 'Sem nome'}</small>
                    <small class="text-muted">${atend.data_atendimento ? new Date(atend.data_atendimento).toLocaleDateString('pt-BR') : ''}</small>
                  </div>
                  <small class="text-muted">Status: ${atend.status || 'N/A'}</small>
                </a>`;
              });
              $('#resultadosPesquisa').html(html).show();
            })
            .catch(() => {
              $('#resultadosPesquisa').html('<div class="list-group-item text-danger">Erro ao buscar atendimentos</div>').show();
            });
        }, 400);
      });

      // Clique em item de atendimento
      $(document).on('click', '.item-atendimento', function(e){
        e.preventDefault();
        const atendimentoId = $(this).data('atendimento-id');
        const status = ($(this).data('status') || '').toLowerCase();
        const statusFinalizado = $(this).data('status-finalizado');
        
        // Verifica se é ALTA ou ALTA APOS MEDICACAO
        if (statusFinalizado || status.includes('alta') || status.includes('finalizado')) {
          if (confirm('Este atendimento já foi finalizado. Deseja reabrir esse prontuário?')) {
            window.location.href = `/medico/atendimento/${atendimentoId}`;
          }
        } else {
          window.location.href = `/medico/atendimento/${atendimentoId}`;
        }
      });

      // Fechar resultados ao clicar fora
      $(document).on('click', function(e) {
        if (!$(e.target).closest('#inputPesquisaAtendimento, #resultadosPesquisa').length) {
          $('#resultadosPesquisa').hide();
        }
      });
    });
  </script>

  <!-- Modal Confirmar Chamado -->
  <div class="modal fade" id="modalChamarPaciente" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
        <div class="modal-header" style="background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio)); color: white; border-radius: 16px 16px 0 0; border: none;">
          <h5 class="modal-title"><i class="fas fa-bell mr-2"></i>Confirmar Chamado</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Fechar" style="opacity: 1;">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center" style="padding: 30px;">
          <i class="fas fa-user-md fa-3x mb-3" style="color: var(--azul-principal);"></i>
          <h5 class="mb-3">Deseja chamar o paciente?</h5>
          <p class="mb-2"><strong id="modalChamarPacienteNome" style="font-size: 1.2rem; color: var(--azul-principal);"></strong></p>
          <p class="text-muted mb-0">Para: <strong id="modalChamarPacienteLocal"></strong></p>
          <small class="text-muted d-block mt-2">O chamado aparecerá no painel em instantes</small>
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--cinza-claro); padding: 16px 24px;">
          <button type="button" class="btn btn-outline-secondary" data-dismiss="modal" style="border-radius: 10px;">
            <i class="fas fa-times mr-1"></i>Cancelar
          </button>
          <button type="button" class="btn btn-primary" id="btnConfirmarChamado" onclick="confirmarChamado()" style="border-radius: 10px; background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio)); border: none;">
            <i class="fas fa-bell mr-1"></i>Confirmar Chamado
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Sucesso -->
  <div class="modal fade" id="modalSucesso" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
      <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
        <div class="modal-body text-center" style="padding: 40px 20px;">
          <div class="mb-3" style="color: #10B981;">
            <i class="fas fa-check-circle fa-4x"></i>
          </div>
          <h5 class="mb-2" style="color: #10B981; font-weight: 600;">Paciente Chamado!</h5>
          <p class="mb-0"><strong id="modalSucessoNome" style="color: var(--cinza-texto);"></strong></p>
          <small class="text-muted d-block mt-2">Chamado para: <strong id="modalSucessoLocal"></strong></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Erro -->
  <div class="modal fade" id="modalErro" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
        <div class="modal-header" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border-radius: 16px 16px 0 0; border: none;">
          <h5 class="modal-title"><i class="fas fa-exclamation-triangle mr-2"></i>Erro</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Fechar" style="opacity: 1;">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center" style="padding: 30px;">
          <i class="fas fa-times-circle fa-3x mb-3" style="color: #EF4444;"></i>
          <p id="modalErroMensagem" class="mb-0"></p>
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--cinza-claro);">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" style="border-radius: 10px;">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>




