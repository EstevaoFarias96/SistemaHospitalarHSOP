<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolu√ß√£o do Paciente - Enfermagem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Adicionar html2canvas para exporta√ß√£o de imagens -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Script para interceptar e substituir scroll.js -->
    <script>
        // Interceptar scripts antes que sejam carregadosz
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
            const element = originalCreateElement.call(document, tagName);
            
            if (tagName.toLowerCase() === 'script') {
                const originalSetAttribute = element.setAttribute;
                element.setAttribute = function(name, value) {
                    if (name === 'src' && value && value.includes('scroll.js')) {
                        console.log('Interceptado carregamento de scroll.js - Substituindo com implementa√ß√£o moderna');
                        // N√£o carregamos o script original
                        return element;
                    }
                    return originalSetAttribute.call(this, name, value);
                };
            }
            
            return element;
        };
        
        // Sobrescrever EventTarget.prototype.addEventListener para monitorar eventos depreciados
        (function() {
            const originalAddEventListener = EventTarget.prototype.addEventListener;
            const deprecatedEvents = [
                'DOMNodeInserted', 
                'DOMNodeRemoved', 
                'DOMSubtreeModified',
                'DOMAttrModified',
                'DOMCharacterDataModified'
            ];
            
            EventTarget.prototype.addEventListener = function(type, listener, options) {
                if (deprecatedEvents.includes(type)) {
                    console.warn(`Evento depreciado '${type}' detectado e n√£o ser√° adicionado`);
                    // N√£o adicionamos o listener para eventos depreciados
                    return;
                }
                
                return originalAddEventListener.call(this, type, listener, options);
            };
        })();
    </script>
    
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* Vari√°veis de cores */
        :root {
            --primary-dark: #1a237e;
            --primary-main: #283593;
            --primary-light: #3949ab;
            --accent: #1565c0;
            --hover-light: rgba(255,255,255,0.08);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.85);
            --shadow-soft: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-strong: 0 4px 8px rgba(0,0,0,0.12);
            --gradient-primary: linear-gradient(135deg, var(--primary-main), var(--primary-light));
            --gradient-accent: linear-gradient(135deg, var(--accent), var(--primary-light));
            --primary-main-rgb: 40, 53, 147;
            --primary-light-rgb: 57, 73, 171;
        }

        /* Estilos para notifica√ß√µes toast personalizadas */
        .toast-notification {
            animation: slideInRight 0.3s ease-out;
        }
        
        .toast-notification .alert {
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: none;
            border-radius: 8px;
        }
        
        .toast-notification .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid #28a745;
        }
        
        .toast-notification .alert-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);
            border-left: 4px solid #dc3545;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Estilos para evolu√ß√£o nova com destaque */
        .nova-evolucao {
            transition: all 0.3s ease;
        }
        
        .nova-evolucao:hover {
            transform: translateX(2px);
        }
        
        /* Melhorar apar√™ncia do loading de evolu√ß√µes */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        /* Estilos globais para cards e headers */
        .card {
            border: none;
            box-shadow: var(--shadow-soft);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-strong);
        }

        .card-header {
            border-bottom: none;
            background: var(--gradient-primary) !important;
            color: var(--text-primary) !important;
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--gradient-accent);
            box-shadow: var(--shadow-strong);
            transform: translateY(-1px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f57c00, #ffb74d);
            border: none;
            color: var(--text-primary);
            box-shadow: var(--shadow-soft);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #ff9800, #ffa726);
            color: var(--text-primary);
            box-shadow: var(--shadow-strong);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
            border: none;
            box-shadow: var(--shadow-soft);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #34ce57, #28a745);
            box-shadow: var(--shadow-strong);
            transform: translateY(-1px);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            border: none;
            box-shadow: var(--shadow-soft);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            box-shadow: var(--shadow-strong);
            transform: translateY(-1px);
        }

        .badge {
            background: var(--gradient-primary);
            border: none;
            box-shadow: var(--shadow-soft);
        }

        /* Estilo do menu lateral */
        .sidebar {
            width: 60px;
            height: 100vh;
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary-main) 100%);
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 20px;
            transition: all 0.3s ease;
            overflow: visible;
            z-index: 1000;
            box-shadow: var(--shadow-soft);
        }
        
        .sidebar:hover {
            width: 200px;
            box-shadow: var(--shadow-strong);
        }
        
        /* Submenu */
        .nav-item-with-submenu {
            position: relative;
        }
        
        .submenu {
            position: absolute;
            left: 100%;
            top: 0;
            min-width: 180px;
            background: linear-gradient(180deg, var(--primary-main) 0%, var(--primary-light) 100%);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0 !important;
            visibility: hidden !important;
            transform: translateX(-10px);
            transition: all 0.3s ease;
            z-index: 1001;
            margin-left: 5px;
            pointer-events: none;
        }
        
        .sidebar:hover .nav-item-with-submenu:hover .submenu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateX(0);
            pointer-events: auto;
        }
        
        /* Garantir que o submenu n√£o apare√ßa com classe active */
        .nav-item-with-submenu .nav-link.active ~ .submenu {
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        /* Apenas mostrar submenu quando sidebar E item estiverem em hover */
        .sidebar:not(:hover) .submenu {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none;
        }
        
        .submenu .nav-link {
            padding: 10px 15px;
            margin: 5px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .submenu .nav-link:hover {
            background-color: rgba(255,255,255,0.15);
        }
        
        .nav-pills {
            flex-direction: column;
            padding: 0;
            margin: 0;
        }
        
        .nav-pills .nav-link {
            margin: 5px 10px;
            border-radius: 8px;
            padding: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .nav-pills .nav-link:hover {
            background-color: var(--hover-light);
            transform: translateX(5px);
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.1);
        }
        
        .nav-pills .nav-link i {
            font-size: 1.2rem;
            min-width: 30px;
            text-align: center;
            transition: transform 0.3s ease;
            color: var(--text-primary);
        }
        
        .nav-pills .nav-link:hover i {
            transform: scale(1.1);
        }
        
        .nav-pills .nav-link span {
            margin-left: 10px;
            opacity: 0;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .sidebar:hover .nav-pills .nav-link span {
            opacity: 1;
            transform: translateX(0);
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--accent);
            color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(21,101,192,0.3);
            border-color: rgba(255,255,255,0.2);
        }
        
        .nav-pills .nav-link.active:hover {
            transform: translateX(5px) scale(1.02);
            background-color: var(--accent);
        }
        
        /* Ajuste do conte√∫do principal */
        .main-content {
            margin-left: 60px;
            flex: 1;
            padding: 20px;
            transition: all 0.3s ease;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        
        .sidebar:hover + .main-content {
            margin-left: 200px;
        }

        /* Estilos para as a√ß√µes r√°pidas */
        .quick-actions {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(0deg, var(--primary-dark) 0%, transparent 100%);
        }

        .quick-actions .action-btn {
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            opacity: 0.9;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .quick-actions .action-btn:hover {
            opacity: 1;
            color: var(--text-primary);
            background-color: var(--hover-light);
            transform: translateX(5px);
            border-color: rgba(255,255,255,0.1);
        }

        .menu-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .nav-pills {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Resto dos estilos existentes */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        .table-medicamentos {
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
        }
        .alerta-alergia {
            border: 2px solid #ffc107;
            padding: 5px 10px;
            display: none;
            font-weight: bold;
            color: #856404;
            background-color: #fff3cd;
            border-radius: 4px;
            margin-top: 5px;
        }
        /* Estilos adicionais para a tabela de evolu√ß√µes */
        .table-medicamentos td {
            vertical-align: middle;
            padding: 10px;
        }
        
        /* Estilos para as tabelas de medicamentos nas prescri√ß√µes */
        .prescricao-card {
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .prescricao-card .card-header {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        .prescricao-card .card-body {
            padding: 8px;
        }
        
        .tabela-medicamentos-prescricao th,
        .tabela-medicamentos-prescricao td {
            padding: 4px 8px;
            font-size: 0.85rem;
        }
        
        .tabela-medicamentos-prescricao tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        /* Estilos para prescri√ß√µes */
        .prescricao-container {
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: visible;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
            background-color: #fff;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .prescricao-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        /* Novo estilo para prescri√ß√µes do dia */
        .prescricao-hoje {
            border-left: 4px solid #4299e1;
            background: linear-gradient(to right, rgba(66, 153, 225, 0.02), transparent 20%);
        }

        .prescricao-antiga {
            border-left: 4px solid #e2e8f0;
        }

        .prescricao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid #edf2f7;
            background: linear-gradient(to right, #f8fafc, #fff);
            position: relative;
            z-index: 2;
            border-radius: 12px 12px 0 0;
        }

        .medico-info {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .medico-nome {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.05rem;
            position: relative;
            padding-right: 16px;
        }

        .medico-nome::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 4px;
            width: 4px;
            background-color: #cbd5e0;
            border-radius: 50%;
        }

        .timestamp {
            color: #718096;
            font-size: 0.925rem;
            font-weight: 400;
        }

        .badge.bg-success {
            background-color: #ebf8ff !important;
            color: #2b6cb0;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            border: 1px solid #bee3f8;
        }

        .prescricao-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-print-discreto {
            background: #f7fafc;
            border: 1px solid #edf2f7;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-print-discreto:hover {
            background: #fff;
            border-color: #e2e8f0;
            color: #2d3748;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .btn-print-discreto:active {
            transform: scale(0.98);
        }

        .btn-print-discreto i {
            font-size: 0.9rem;
            color: #718096;
        }

        /* Estilos para as se√ß√µes de conte√∫do */
        .prescricao-section {
            padding: 1.5rem;
            position: relative;
            background: #fff;
            margin: 0.5rem;
            border-radius: 8px;
            border: 1px solid #edf2f7;
        }

        .prescricao-section:not(:last-child) {
            margin-bottom: 0.75rem;
        }

        /* Cores espec√≠ficas para cada tipo de se√ß√£o */
        .prescricao-section[data-tipo="dieta"] {
            border-left: 3px solid #48bb78;
            background: linear-gradient(to right, rgba(72, 187, 120, 0.02), transparent 15%);
        }

        .prescricao-section[data-tipo="medicamentos"] {
            border-left: 3px solid #4299e1;
            background: linear-gradient(to right, rgba(66, 153, 225, 0.02), transparent 15%);
        }

        .prescricao-section[data-tipo="procedimentos"] {
            border-left: 3px solid #ed8936;
            background: linear-gradient(to right, rgba(237, 137, 54, 0.02), transparent 15%);
        }

        .prescricao-section[data-tipo="multi"] {
            border-left: 3px solid #9f7aea;
            background: linear-gradient(to right, rgba(159, 122, 234, 0.02), transparent 15%);
        }

        .prescricao-section-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* √çcones para cada tipo de se√ß√£o */
        .prescricao-section[data-tipo="dieta"] .prescricao-section-title::before {
            content: 'üçΩÔ∏è';
            font-size: 1rem;
        }

        .prescricao-section[data-tipo="medicamentos"] .prescricao-section-title::before {
            content: 'üíä';
            font-size: 1rem;
        }

        .prescricao-section[data-tipo="procedimentos"] .prescricao-section-title::before {
            content: 'üè•';
            font-size: 1rem;
        }

        .prescricao-section[data-tipo="multi"] .prescricao-section-title::before {
            content: 'üë•';
            font-size: 1rem;
        }

        .prescricao-section-content {
            color: #4a5568;
            font-size: 0.95rem;
            line-height: 1.6;
            background: #fafafa;
            padding: 1rem;
            border-radius: 6px;
        }

        /* Estilo para tabelas dentro das se√ß√µes */
        .tabela-medicamentos-prescricao {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .tabela-medicamentos-prescricao thead th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #edf2f7;
        }

        .tabela-medicamentos-prescricao tbody td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #edf2f7;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .tabela-medicamentos-prescricao tbody tr:hover {
            background: #f7fafc;
        }

        .tabela-medicamentos-prescricao .btn-info {
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            color: #2b6cb0;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .tabela-medicamentos-prescricao .btn-info:hover {
            background: #bee3f8;
            border-color: #90cdf4;
            color: #2c5282;
        }
        
        /* Formata√ß√£o especial para a coluna de texto de evolu√ß√£o */
        .texto-evolucao {
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 450px;
            min-height: 150px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #0d6efd;
            font-size: 0.9rem;
            line-height: 1.5;
            transition: max-height 0.3s ease;
        }
        
        .texto-evolucao:hover {
            max-height: 600px;
        }

        /* Estilo espec√≠fico para prescri√ß√µes de enfermagem - sempre mostrar texto completo */
        #listaPrescricoesEnfermagem .texto-evolucao {
            max-height: none !important;
            min-height: auto !important;
            height: auto !important;
            overflow: visible !important;
            padding: 12px;
            background-color: transparent;
            border: none;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        #listaPrescricoesEnfermagem .texto-evolucao:hover {
            max-height: none !important;
        }

        /* Garantir que as c√©lulas da tabela de prescri√ß√µes se ajustem ao conte√∫do */
        #listaPrescricoesEnfermagem td {
            vertical-align: top !important;
            padding: 8px 12px !important;
        }

        #listaPrescricoesEnfermagem tr {
            height: auto !important;
        }
        
        .texto-evolucao p {
            margin-bottom: 0.6rem;
        }
        
        .texto-evolucao * {
            max-width: 100%;
        }
        
        .texto-evolucao h1, .texto-evolucao h2, .texto-evolucao h3 {
            margin-top: 0.8rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }
        
        .texto-evolucao ul, .texto-evolucao ol {
            padding-left: 25px;
            margin-bottom: 0.8rem;
        }
        
        .texto-evolucao li {
            margin-bottom: 0.3rem;
        }
        
        .texto-evolucao strong, .texto-evolucao b {
            font-weight: 700;
        }
        
        .texto-evolucao em, .texto-evolucao i {
            font-style: italic;
        }
        
        .texto-evolucao blockquote {
            margin: 0.8rem 0;
            padding: 0.5rem 1rem;
            border-left: 3px solid #adb5bd;
            background-color: #f0f0f0;
        }
        
        .texto-evolucao::-webkit-scrollbar {
            width: 10px;
        }
        
        .texto-evolucao::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .texto-evolucao::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .texto-evolucao::-webkit-scrollbar-thumb:hover {
            background: #0d6efd;
        }
        
        #editor-container {
            height: 450px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        
        .ql-editor {
            font-size: 13px;
            line-height: 1.5;
            min-height: 400px;
        }
        
        .ql-tooltip {
            z-index: 1060 !important;
        }
        
        @media (max-width: 768px) {
            .texto-evolucao {
                max-height: 250px;
                font-size: 0.85rem;
                min-height: 100px;
            }
            #editor-container {
                height: 250px;
            }
            .ql-editor {
                min-height: 200px;
            }
        }
        
        /* Estilos para adaptar a altura da caixa baseado no tamanho do conte√∫do */
        /* N√£o aplicar limita√ß√µes de altura para prescri√ß√µes de enfermagem */
        .texto-evolucao[data-lines="1"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="2"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="3"]:not(#listaPrescricoesEnfermagem .texto-evolucao) {
            max-height: 150px;
            min-height: 80px;
        }
        
        .texto-evolucao[data-lines="4"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="5"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="6"]:not(#listaPrescricoesEnfermagem .texto-evolucao) {
            max-height: 200px;
            min-height: 100px;
        }
        
        .texto-evolucao[data-lines="7"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="8"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="9"]:not(#listaPrescricoesEnfermagem .texto-evolucao) {
            max-height: 250px;
            min-height: 150px;
        }
        
        .texto-evolucao[data-lines="10"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="11"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="12"]:not(#listaPrescricoesEnfermagem .texto-evolucao) {
            max-height: 300px;
            min-height: 200px;
        }
        
        .texto-evolucao[data-lines="13"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="14"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="15"]:not(#listaPrescricoesEnfermagem .texto-evolucao) {
            max-height: 350px;
            min-height: 250px;
        }
        
        .texto-evolucao[data-lines="16"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="17"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="18"]:not(#listaPrescricoesEnfermagem .texto-evolucao) {
            max-height: 400px;
            min-height: 300px;
        }
        
        .texto-evolucao[data-lines="19"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="20"]:not(#listaPrescricoesEnfermagem .texto-evolucao),
        .texto-evolucao[data-lines="21"]:not(#listaPrescricoesEnfermagem .texto-evolucao) {
            max-height: 450px;
            min-height: 350px;
        }
        
        .texto-evolucao[data-lines="22"] {
            max-height: 500px;
            min-height: 400px;
        }
        
        /* Estilos para o calend√°rio de aprazamento */
        .calendar-day {
            width: 120px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-color: #f8f9fa;
        }
        
        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        
        .day-header {
            font-weight: bold;
            border-bottom: 1px dashed #dee2e6;
            padding-bottom: 5px;
        }
        
        .time-pill {
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .time-pill:hover {
            background-color: #e9ecef;
        }
        
        /* Estilos para popovers dos dias */
        .popover {
            max-width: 300px;
        }
        
        .popover-body {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Estilos para o novo modal de aprazamento */
        #modalAprazamento .modal-content {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
        }

        #modalAprazamento .modal-header {
            border-bottom: none;
            padding: 0.75rem 1rem;
            border-radius: 8px 8px 0 0;
        }

        #modalAprazamento .modal-body {
            padding: 0.75rem 1rem;
        }

        #modalAprazamento label.form-label {
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 0.1rem;
        }

        #modalAprazamento .form-control-sm, 
        #modalAprazamento .form-select-sm {
            border-radius: 6px;
            border-color: #dee2e6;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        #modalAprazamento .form-control-sm:focus, 
        #modalAprazamento .form-select-sm:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.15);
        }

        #modalAprazamento .form-check-input {
            cursor: pointer;
        }

        #modalAprazamento .form-check-label {
            cursor: pointer;
        }

        #modalAprazamento #horarios_multiplos_dias {
            background-color: #f8f9fa;
            border-color: #e9ecef !important;
            border-radius: 6px;
        }

        #modalAprazamento .btn-sm {
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Estilos para o modal de visualiza√ß√£o de aprazamentos */
        .modal-visualizar-aprazamento .modal-content {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .modal-visualizar-aprazamento .modal-header {
            background-color: #17a2b8;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-visualizar-aprazamento .table {
            margin-bottom: 0;
        }

        .modal-visualizar-aprazamento .table th {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .modal-visualizar-aprazamento .table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .modal-visualizar-aprazamento .btn-realizar-aprazamento {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .modal-visualizar-aprazamento .btn-realizar-aprazamento:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos .col {
            text-align: center;
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos small {
            display: block;
            margin-bottom: 0.25rem;
            color: #6c757d;
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos strong {
            font-size: 1.25rem;
            display: block;
        }

        .modal-visualizar-aprazamento .status-icon {
            margin-right: 0.5rem;
        }

        .modal-visualizar-aprazamento .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Estilos para o bot√£o de impress√£o */
        .btn-print-discreto {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #212529;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative;
            z-index: 4;
        }

        /* Estilos para loading mais bonito */
        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .loading-container .spinner-border {
            margin-right: 0.5rem;
        }
        
        /* Estilos para bot√µes com estado de loading */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: button-loading-spinner 1s ease infinite;
        }
        
        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }
        
        /* Melhorar apar√™ncia da tabela de evolu√ß√µes */
        .table-evolucoes {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .table-evolucoes thead th {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        .table-evolucoes tbody tr {
            transition: all 0.2s ease;
        }
        
        .table-evolucoes tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }
        
        /* Estilo para evolu√ß√£o do dia atual */
        .evolucao-hoje {
            border-left: 4px solid #28a745;
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.05) 0%, transparent 100%);
        }
        
        /* Melhorar apar√™ncia do texto de evolu√ß√£o */
        .texto-evolucao {
            max-height: 150px;
            overflow-y: auto;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .texto-evolucao::-webkit-scrollbar {
            width: 4px;
        }
        
        .texto-evolucao::-webkit-scrollbar-track {
            background: #e9ecef;
            border-radius: 2px;
        }
        
        .texto-evolucao::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 2px;
        }
        
        /* Melhorar apar√™ncia do modal */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            border-bottom: 1px solid #e9ecef;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        /* Melhorar apar√™ncia dos campos de texto */
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* Estilos para contadores e badges */
        .badge-contador {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .btn-print-discreto:hover {
            background: #e9ecef;
            border-color: #ced4da;
            color: #212529;
            transform: translateY(-1px);
        }

        .btn-print-discreto:active {
            transform: scale(0.95);
        }

        .btn-print-discreto i {
            font-size: 0.9rem;
            margin-right: 4px;
        }

        /* Estilos para o container de prescri√ß√£o */
        .prescricao-container {
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 16px;
            padding: 16px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .prescricao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .prescricao-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative;
            z-index: 2;
        }

        /* Estilos para cards de evolu√ß√£o m√©dica */
        .evolucao-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .evolucao-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #007bff;
        }

        .evolucao-card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .evolucao-info h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .evolucao-data {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .evolucao-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .evolucao-actions .btn {
            min-width: 40px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .evolucao-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .evolucao-card-body {
            padding: 1.25rem;
        }

        .evolucao-conteudo {
            line-height: 1.6;
            color: #495057;
        }

        .evolucao-conteudo p {
            margin-bottom: 0.75rem;
        }

        .evolucao-conteudo p:last-child {
            margin-bottom: 0;
        }

        .evolucao-vazia {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .evolucao-vazia i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Anima√ß√µes para loading */
        .evolucao-loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .evolucao-loading .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        /* Responsividade para cards de evolu√ß√£o */
        @media (max-width: 768px) {
            .evolucao-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .evolucao-data {
                font-size: 0.8rem;
            }

            .evolucao-card-header {
                padding: 0.75rem 1rem;
            }

            .evolucao-card-body {
                padding: 1rem;
            }
        }        /* === ESTILOS PARA SE√á√ÉO DE ENFERMAGEM === */
        
        /* Garantir que a se√ß√£o de enfermagem ocupe toda a largura dispon√≠vel no container */
        #enfermagemSection {
            width: 100%;
            max-width: 100%;
            /* Removido padding: 0 que estava causando conflito */
        }
        
        /* Garantir que as se√ß√µes de conte√∫do n√£o afetem o paciente-info */
        .content-section {
            margin-top: 0;
            padding-top: 0;
        }
        
        /* Aplicar margem top apenas quando a se√ß√£o estiver ativa, exceto para a primeira se√ß√£o vis√≠vel */
        .content-section.active:not(:first-child) {
            margin-top: 1.5rem;
        }
        
        /* Cards de enfermagem com bordas coloridas */
        .card.border-success.border-opacity-25 {
            border-width: 2px !important;
        }
        
        .card.border-secondary.border-opacity-25 {
            border-width: 2px !important;
        }
        
        .card.border-warning.border-opacity-25 {
            border-width: 2px !important;
        }

        /* Melhorar apar√™ncia das tabelas de enfermagem */
        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.025);
            transform: translateY(-1px);
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* √çcones nos cabe√ßalhos das tabelas */
        .table thead th {
            border-bottom: 2px solid rgba(0,0,0,0.1);
            font-weight: 600;
            color: #495057;
            vertical-align: middle;
        }

        /* Cards de filtros e resumo */
        .card.border-0.bg-light {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .card.border-0.bg-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Contadores de resumo */
        .bg-success.bg-opacity-10 {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05)) !important;
            border: 1px solid rgba(40, 167, 69, 0.2);
            transition: all 0.2s ease;
        }

        .bg-secondary.bg-opacity-10 {
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.05)) !important;
            border: 1px solid rgba(108, 117, 125, 0.2);
            transition: all 0.2s ease;
        }

        .bg-success.bg-opacity-10:hover,
        .bg-secondary.bg-opacity-10:hover {
            transform: scale(1.05);
        }

        /* √Årea de texto da admiss√£o */
        .texto-admissao {
            line-height: 1.6;
            color: #495057;
            width: 100%;
        }

        .texto-admissao:empty::before {
            content: "Nenhuma admiss√£o registrada";
            color: #6c757d;
            font-style: italic;
        }

        /* Bot√µes da se√ß√£o de enfermagem */
        .card-header .btn {
            transition: all 0.2s ease;
        }

        .card-header .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Estados de carregamento melhorados */
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Garantir que as tabelas ocupem toda a largura */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        .table {
            width: 100%;
            margin-bottom: 0;
        }        /* Responsividade para se√ß√£o de enfermagem */
        @media (max-width: 768px) {
            /* Regra removida para n√£o interferir com container-fluid */
            
            .card-header h5 {
                font-size: 1rem;
            }
            
            .card-header .btn {
                font-size: 0.8rem;
                padding: 0.375rem 0.75rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .bg-success.bg-opacity-10,
            .bg-secondary.bg-opacity-10 {
                padding: 0.5rem !important;
            }
            
            .col-lg-6 {
                margin-bottom: 1rem;
            }
        }

        /* Anima√ß√µes suaves */
        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        /* Melhorar espa√ßamento dos √≠cones */
        .fas.me-1, .fas.me-2 {
            opacity: 0.8;
        }

        .card-header .fas {
            opacity: 1;
        }        /* Garantir que o conte√∫do n√£o saia da tela */
        .content-section {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }        /* Garantir que a se√ß√£o de enfermagem respeite o container-fluid */
        .main-content .container-fluid #enfermagemSection {
            margin: 0;
            padding: 0;
            width: 100%;
        }

        /* Garantir espa√ßamento adequado para cards dentro da se√ß√£o de enfermagem */
        #enfermagemSection .card {
            margin-left: 0;
            margin-right: 0;
        }

        /* Garantir que rows e cols funcionem corretamente dentro da se√ß√£o */
        #enfermagemSection .row {
            margin-left: 0;
            margin-right: 0;
        }

        #enfermagemSection .col,
        #enfermagemSection [class*="col-"] {
            padding-left: 15px;
            padding-right: 15px;
        }

        /* CORRE√á√ÉO FINAL - Garantir que o paciente-info n√£o seja comprimido */
        .paciente-info {
            margin-bottom: 20px !important;
            flex-shrink: 0 !important;
            position: relative !important;
            z-index: 10 !important;
        }

        /* Resetar regras problem√°ticas */
        .content-section {
            position: static !important;
        }

        /* === ESTILOS PARA SISTEMA DE BUSCA DE PRESCRI√á√ïES PADR√ÉO === */
        
        /* Modal de prescri√ß√£o expandido */
        #modalPrescricaoEnfermagem .modal-xl {
            max-width: 90%;
        }

        /* Cards de prescri√ß√µes padr√£o */
        .prescricao-padrao-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fff;
        }

        .prescricao-padrao-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
        }

        .prescricao-padrao-card .card-title {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .prescricao-padrao-card .btn-usar-template {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            transition: all 0.2s ease;
        }

        .prescricao-padrao-card .btn-usar-template:hover {
            background: #007bff;
            border-color: #007bff;
            color: white;
            transform: scale(1.05);
        }

        .prescricao-preview {
            font-size: 0.8rem;
            line-height: 1.4;
            color: #6c757d;
        }

        /* √Årea de busca */
        #busca_prescricao_template {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        #busca_prescricao_template:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        #titulo_prescricao {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        #titulo_prescricao:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Lista de prescri√ß√µes padr√£o */
        #lista_prescricoes_padrao {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.5rem;
        }

        #lista_prescricoes_padrao::-webkit-scrollbar {
            width: 6px;
        }

        #lista_prescricoes_padrao::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #lista_prescricoes_padrao::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 3px;
        }

        #lista_prescricoes_padrao::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }

        /* Tags NIC */
        .prescricao-padrao-card .text-muted {
            font-size: 0.75rem;
        }

        .prescricao-padrao-card .fas {
            font-size: 0.7rem;
            margin-right: 0.25rem;
        }

        /* Anima√ß√µes de loading */
        .loading-prescricoes {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #6c757d;
        }

        .loading-prescricoes .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Alerta de nenhuma prescri√ß√£o encontrada */
        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-color: #b8daff;
            color: #0c5460;
        }

        /* Melhorias no textarea da prescri√ß√£o */
        #texto_prescricao_enfermagem {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
        }

        #texto_prescricao_enfermagem:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }

        /* Bot√µes do modal */
        .btn-warning.text-white {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border: none;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-warning.text-white:hover {
            background: linear-gradient(135deg, #e0a800 0%, #d39e00 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            #modalPrescricaoEnfermagem .modal-xl {
                max-width: 95%;
            }
            
            #modalPrescricaoEnfermagem .row {
                flex-direction: column;
            }
            
            #modalPrescricaoEnfermagem .col-md-5,
            #modalPrescricaoEnfermagem .col-md-7 {
                width: 100%;
                margin-bottom: 1rem;
            }
            
            #lista_prescricoes_padrao {
                max-height: 250px;
            }
            
            #texto_prescricao_enfermagem {
                min-height: 200px;
            }
        }

        /* === FIM DOS ESTILOS PARA SISTEMA DE BUSCA === */
        
        /* === ESTILOS PARA FICHAS DE REFER√äNCIA === */
        .fichas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 0.5rem;
        }
        .ficha-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .ficha-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border-color: #cfe2ff;
        }
        .ficha-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #edf2f7;
            background: linear-gradient(180deg, #fafbff 0%, #ffffff 100%);
        }
        .ficha-titulo .titulo-texto {
            font-weight: 600;
            color: #2d3748;
        }
        .ficha-metadados {
            display: flex;
            gap: 0.75rem;
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        .ficha-actions {
            display: flex;
            gap: 0.4rem;
        }
        .btn-action {
            width: 34px;
            height: 34px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #fff;
            color: #4a5568;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .btn-action:hover {
            background: #f8fafc;
            border-color: #cbd5e0;
            color: #2b6cb0;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(43,108,176,0.15);
        }
        .btn-action.btn-print {
            color: #198754;
            border-color: #d1e7dd;
        }
        .btn-action.btn-print:hover {
            background: #e9f7ef;
            color: #146c43;
            border-color: #badbcc;
        }
        .ficha-content {
            padding: 0.85rem 1rem 1rem;
        }
        .campo-principal {
            margin-bottom: 0.5rem;
        }
        .campo-label {
            color: #6c757d;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .campo-valor {
            color: #2d3748;
            background: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
        }
        .destaque-unidade {
            border-left: 4px solid #0d6efd;
            background: linear-gradient(90deg, rgba(13,110,253,0.05), transparent 70%);
        }
        .campo-secundario {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .campo-label-pequeno {
            color: #6c757d;
            font-size: 0.8rem;
            min-width: 110px;
        }
        .campo-valor-pequeno {
            color: #495057;
            font-size: 0.9rem;
        }
        .tem-mais-conteudo {
            margin-top: 0.5rem;
            color: #6c757d;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        #listaFichasReferencia .empty-state i { opacity: 0.5; }
        #listaFichasReferencia .empty-state h6 { font-weight: 600; }
        
        /* Painel de estat√≠sticas das fichas */
        .stats-panel { margin-bottom: 0.75rem; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .stat-item {
            background: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 10px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #e7f1ff;
            color: #0d6efd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stat-number { font-weight: 700; font-size: 1.1rem; color: #2d3748; }
        .stat-label { color: #6c757d; font-size: 0.8rem; }
        
        /* Modal da Ficha de Refer√™ncia */
        .ficha-visualizacao .ficha-header-modal {
            border-bottom: 1px solid #edf2f7;
            margin-bottom: 0.75rem;
        }
        .ficha-visualizacao .campo-titulo-modal {
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ficha-visualizacao .campo-conteudo-modal {
            background: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 8px;
            padding: 0.75rem;
            color: #2d3748;
        }
        .destaque-unidade-modal {
            border-left: 4px solid #0d6efd;
            background: linear-gradient(90deg, rgba(13,110,253,0.05), transparent 70%);
        }
    </style>
    <script>
        // Ajuste global de fuso-hor√°rio
        // Este patch garante que qualquer chamada a toLocaleString / toLocaleTimeString / toLocaleDateString
        // utilize, por padr√£o, o fuso hor√°rio do Brasil (America/Sao_Paulo). Assim evitamos exibi√ß√£o em GMT
        // quando o cliente estiver com time-zone diferente.
        (function() {
            const TZ_BR = 'America/Sao_Paulo';
            const DEFAULT_LOCALE = 'pt-BR';
            ['toLocaleString', 'toLocaleTimeString', 'toLocaleDateString'].forEach(function(methodName) {
                const original = Date.prototype[methodName];
                Date.prototype[methodName] = function(localeOrOptions, maybeOptions) {
                    let locales = localeOrOptions;
                    let options = maybeOptions;

                    // Se o primeiro par√¢metro for um objeto, significa que o chamador passou apenas as op√ß√µes.
                    if (typeof localeOrOptions === 'object' && localeOrOptions !== null) {
                        options = localeOrOptions;
                        locales = undefined;
                    }

                    locales = locales || DEFAULT_LOCALE;
                    options = options || {};

                    // Garante que o timezone seja sempre America/Sao_Paulo se n√£o especificado explicitamente.
                    if (!options.timeZone) {
                        options.timeZone = TZ_BR;
                    }

                    return original.call(this, locales, options);
                };
            });
        })();
    </script>
</head>
<body>
<script>
// Extrair o ID do atendimento da URL e disponibiliz√°-lo globalmente
window.ATENDIMENTO_ID = window.location.pathname.split('/').pop();
console.log('[Debug] ID do atendimento extra√≠do:', window.ATENDIMENTO_ID);

// Verificar se o ID foi extra√≠do corretamente
if (!window.ATENDIMENTO_ID) {
    console.error('[Debug] Erro: ID do atendimento n√£o encontrado na URL');
} else {
    console.log('[Debug] ID do atendimento dispon√≠vel globalmente');
}

// Fun√ß√£o para voltar para a p√°gina de pacientes internados
function voltarParaPacientesInternados() {
    console.log('üîÑ Bot√£o Voltar clicado - Redirecionando para /clinica/pacientes-internados');
    try {
        window.location.href = '/clinica/pacientes-internados';
        console.log('‚úÖ Redirecionamento iniciado com sucesso');
    } catch (error) {
        console.error('‚ùå Erro no redirecionamento:', error);
        // Fallback usando window.location.replace
        window.location.replace('/clinica/pacientes-internados');
    }
}

// Fun√ß√£o para abrir a p√°gina de impress√µes de enfermagem
function abrirImpressoesEnfermagem() {
    console.log('üñ®Ô∏è Bot√£o Impress√µes de Enfermagem clicado - Redirecionando para impress√µes');
    try {
        const atendimentoId = window.ATENDIMENTO_ID;
        if (!atendimentoId) {
            console.error('‚ùå Erro: ID do atendimento n√£o encontrado');
            alert('Erro: ID do atendimento n√£o encontrado. Por favor, recarregue a p√°gina.');
            return;
        }
        
        const url = `/clinica/impressoes-enfermagem/${atendimentoId}`;
        console.log('‚úÖ Redirecionando para:', url);
        window.location.href = url;
    } catch (error) {
        console.error('‚ùå Erro no redirecionamento:', error);
        alert('Erro ao abrir as impress√µes de enfermagem. Por favor, tente novamente.');
    }
}
</script>

<!-- Menu Lateral -->
<div class="sidebar">
    <nav class="nav nav-pills flex-column">
        <!-- Menu Principal -->
        <div class="menu-section">
            <a class="nav-link action-btn" href="#" onclick="voltarParaPacientesInternados(); return false;">
                <i class="fas fa-arrow-left"></i>
                <span>Voltar</span>
            </a>
            <a class="nav-link" href="#" onclick="abrirImpressoesEnfermagem(); return false;">
                <i class="fas fa-print"></i>
                <span>Imprimir</span>
            </a>
            <a class="nav-link" href="#" data-target="prescricaoSection">
                <i class="fas fa-pills"></i>
                <span>Prescri√ß√£o</span>
            </a>
            <a class="nav-link" href="#" data-target="evolucaoSection">
                <i class="fas fa-notes-medical"></i>
                <span>Evolu√ß√£o M√©dica</span>
            </a>
            
            <!-- Menu Enfermagem com Submenu -->
            <div class="nav-item-with-submenu">
                <a class="nav-link active" href="#" data-target="evolucaoEnfermagemSection">
                    <i class="fas fa-user-nurse"></i>
                    <span>Enfermagem</span>
                </a>
                <div class="submenu">
                    <a class="nav-link" href="#" data-target="admissaoEnfermagemSection">
                        <i class="fas fa-user-plus me-2"></i>
                        <span>Admiss√£o</span>
                    </a>
                    <a class="nav-link" href="#" data-target="evolucaoEnfermagemSection">
                        <i class="fas fa-heartbeat me-2"></i>
                        <span>Evolu√ß√£o</span>
                    </a>
                    <a class="nav-link" href="#" data-target="prescricaoEnfermagemSection">
                        <i class="fas fa-prescription-bottle-alt me-2"></i>
                        <span>Prescri√ß√£o</span>
                    </a>
                    <a class="nav-link" href="#" data-target="saeSection">
                        <i class="fas fa-clipboard-check me-2"></i>
                        <span>SAE</span>
                    </a>
                </div>
            </div>
            
            <a class="nav-link" href="#" data-target="examesSection">
                <i class="fas fa-vial"></i>
                <span>Exames Lab.</span>
            </a>
            <a class="nav-link" href="#" data-target="fichaReferenciaSection">
                <i class="fas fa-file-export"></i>
                <span>Fichas Ref.</span>
            </a>
            <a class="nav-link" href="#" data-target="receituariosSection">
                <i class="fas fa-file-prescription"></i>
                <span>Receitu√°rios</span>
            </a>
            <a class="nav-link" href="#" data-target="atestadosSection">
                <i class="fas fa-file-signature"></i>
                <span>Atestados</span>
            </a>
        </div>

        <!-- A√ß√µes R√°pidas -->
        <div class="quick-actions">
        </div>
    </nav>
</div>

<!-- Conte√∫do Principal -->
<div class="main-content">
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Evolu√ß√£o do Paciente - Enfermagem</h2>
        </div>

        <!-- Informa√ß√µes do Paciente -->
        <div class="paciente-info row">
            <div class="col-md-3 info-item"><strong>Nome:</strong> {{ paciente.nome }}</div>
            <div class="col-md-3 info-item"><strong>CPF:</strong> {{ paciente.cpf }}</div>
            <div class="col-md-3 info-item"><strong>Cart√£o SUS:</strong> {{ paciente.cartao_sus }}</div>
            <div class="col-md-3 info-item"><strong>Sexo:</strong> {{ paciente.sexo }}</div>
            <div class="col-md-3 info-item"><strong>Data de Nascimento:</strong> {{ paciente.data_nascimento.strftime('%d/%m/%Y') if paciente.data_nascimento else '-' }}</div>
            <div class="col-md-3 info-item"><strong>Endere√ßo:</strong> {{ paciente.endereco }}</div>
            <div class="col-md-3 info-item"><strong>Munic√≠pio:</strong> {{ paciente.municipio }}</div>
            <div class="col-md-3 info-item"><strong>Telefone:</strong> {{ paciente.telefone }}</div>
            <div class="col-md-3 info-item"><strong>Nome Social:</strong> {{ paciente.nome_social }}</div>
            <div class="col-md-3 info-item"><strong>Filia√ß√£o:</strong> {{ paciente.filiacao }}</div>
        </div>

        <div id="printSection" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Op√ß√µes de Impress√£o</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-user-nurse fa-3x text-primary mb-3"></i>
                                    <h6 class="card-title">Relat√≥rios de Enfermagem</h6>
                                    <p class="card-text">Imprimir evolu√ß√µes, prescri√ß√µes e SAE de enfermagem</p>
                                    <button type="button" class="btn btn-primary" onclick="abrirImpressoesEnfermagem()">
                                        <i class="fas fa-print me-2"></i>Acessar Impress√µes
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-medical fa-3x text-info mb-3"></i>
                                    <h6 class="card-title">Outras Op√ß√µes</h6>
                                    <p class="card-text">Outras funcionalidades de impress√£o ser√£o implementadas</p>
                                    <button type="button" class="btn btn-outline-secondary" disabled>
                                        <i class="fas fa-cogs me-2"></i>Em Desenvolvimento
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="prescricaoSection" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Prescri√ß√µes M√©dicas</h5>
                </div>
                <div class="card-body">
                    <div class="prescricoes-lista">
                        <!-- Todas as prescri√ß√µes ser√£o listadas aqui -->
                        <div id="listaPrescricoes">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Fun√ß√£o para renderizar prescri√ß√µes
        function renderizarPrescricao(prescricao) {
            // Determinar a melhor data dispon√≠vel
            const dataOriginal = prescricao.horario_prescricao || prescricao.data_prescricao || prescricao.created_at;
            
            // Formatar data para exibi√ß√£o
            let dataFormatada;
            if (dataOriginal) {
                const data = new Date(dataOriginal);
                dataFormatada = data.toLocaleString('pt-BR');
            } else {
                dataFormatada = 'Data n√£o dispon√≠vel';
            }
            
            // Verificar se √© de hoje
            const hoje = new Date();
            const dataPrescricao = new Date(dataOriginal);
            const ehHoje = dataPrescricao.toDateString() === hoje.toDateString();
            
            // Classe CSS adicional para prescri√ß√µes de hoje
            const classeContainer = ehHoje ? 'prescricao-container prescricao-hoje' : 'prescricao-container prescricao-antiga';
            
            let html = `
                <div class="${classeContainer}">
                    <div class="prescricao-header">
                        <div class="medico-info">
                            <span class="medico-nome">Dr(a). ${prescricao.medico_nome || 'M√©dico n√£o informado'}</span>
                            <span class="timestamp">${dataFormatada}</span>
                            ${ehHoje ? '<span class="badge bg-success">HOJE</span>' : ''}
                        </div>
                        <div class="prescricao-actions">
                            <button type="button" class="btn-print-discreto" 
                                    onclick="imprimirPrescricao(${prescricao.id})" 
                                    title="Imprimir Prescri√ß√£o">
                                <i class="fas fa-print"></i>
                                <span>Imprimir</span>
                            </button>
                        </div>
                    </div>
            `;
            
            // Se√ß√£o de Dieta
            if (prescricao.texto_dieta) {
                html += `
                    <div class="prescricao-section" data-tipo="dieta">
                        <div class="prescricao-section-title">Dieta</div>
                        <div class="prescricao-section-content">${prescricao.texto_dieta}</div>
                    </div>
                `;
            }
            
            // Se√ß√£o de Medicamentos
            if (prescricao.medicamentos && prescricao.medicamentos.length > 0) {
                html += `
                    <div class="prescricao-section" data-tipo="medicamentos">
                        <div class="prescricao-section-title">Medicamentos</div>
                        <div class="prescricao-section-content">
                            <table class="table table-sm table-hover tabela-medicamentos-prescricao">
                                <thead>
                                    <tr>
                                        <th>Medicamento</th>
                                        <th>Descri√ß√£o</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${prescricao.medicamentos.map(med => `
                                        <tr>
                                            <td>${med.nome_medicamento}</td>
                                            <td>${med.descricao_uso}</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-info" onclick="visualizarAprazamentos('${med.nome_medicamento}')">
                                                    <i class="fas fa-clock"></i> Ver Hor√°rios
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Se√ß√£o de Procedimentos M√©dicos
            if (prescricao.texto_procedimento_medico) {
                html += `
                    <div class="prescricao-section" data-tipo="procedimentos">
                        <div class="prescricao-section-title">Procedimentos M√©dicos</div>
                        <div class="prescricao-section-content">${prescricao.texto_procedimento_medico}</div>
                    </div>
                `;
            }
            
            // Se√ß√£o de Procedimentos Multiprofissionais
            if (prescricao.texto_procedimento_multi) {
                html += `
                    <div class="prescricao-section" data-tipo="multi">
                        <div class="prescricao-section-title">Procedimentos Multiprofissionais</div>
                        <div class="prescricao-section-content">${prescricao.texto_procedimento_multi}</div>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }

        // Fun√ß√£o para imprimir prescri√ß√£o
        function imprimirPrescricao(prescricaoId) {
            const url = `/imprimir/prescricao/${window.internacaoId}`;
            window.open(url, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
        }
        
        // Fun√ß√£o para carregar evolu√ß√µes ser√° chamada ap√≥s o jQuery ser carregado
        function inicializarEvolucoesMedicas() {
            carregarEvolucoes();
        }
        </script>

        <div id="evolucaoSection" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-notes-medical me-2"></i>Evolu√ß√£o e Acompanhamento M√©dico</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Navega√ß√£o por abas dentro da se√ß√£o de Evolu√ß√£o -->
                    <ul class="nav nav-tabs" id="evolucaoTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="evolucoes-tab" data-bs-toggle="tab" data-bs-target="#evolucoes-pane" type="button" role="tab">
                                <i class="fas fa-notes-medical me-2"></i>Evolu√ß√µes
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="anamnese-tab" data-bs-toggle="tab" data-bs-target="#anamnese-pane" type="button" role="tab">
                                <i class="fas fa-user-md me-2"></i>Anamnese & Conduta
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="diagnostico-tab" data-bs-toggle="tab" data-bs-target="#diagnostico-pane" type="button" role="tab">
                                <i class="fas fa-stethoscope me-2"></i>Diagn√≥stico
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="justificativas-tab" data-bs-toggle="tab" data-bs-target="#justificativas-pane" type="button" role="tab">
                                <i class="fas fa-clipboard-list me-2"></i>Justificativas
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content p-4" id="evolucaoTabContent">
                        <!-- Aba de Evolu√ß√µes -->
                        <div class="tab-pane fade show active" id="evolucoes-pane" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="mb-0 text-primary fw-bold">Registro de Evolu√ß√µes</h6>
                                <!-- Bot√£o de Nova Evolu√ß√£o removido - apenas m√©dicos podem adicionar evolu√ß√µes -->
                            </div>

                            <!-- HDA Section -->
                            <div class="card mb-4 border-info">
                                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Hist√≥ria da Doen√ßa Atual (HDA)</h6>
                                    <!-- Bot√£o de Editar HDA removido - apenas m√©dicos podem editar -->
                                </div>
                                <div class="card-body">
                                    <div id="hdaContainer" class="texto-evolucao bg-light p-3 rounded" style="min-height: 100px; white-space: pre-wrap;">{{ internacao.hda or 'HDA n√£o registrada.' }}</div>
                                    <textarea class="form-control d-none" id="hdaTexto">{{ internacao.hda or '' }}</textarea>
                                </div>
                            </div>
                            
                            <!-- Lista de Evolu√ß√µes -->
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-secondary"><i class="fas fa-list me-2"></i>Hist√≥rico de Evolu√ß√µes M√©dicas</h6>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-secondary" id="btn-filtrar-evolucoes-medicas">
                                            <i class="fas fa-filter me-1"></i>Filtrar
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" id="btn-toggle-evolucoes-antigas-medicas">
                                            <i class="fas fa-eye me-1"></i>Ver Antigas
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Filtro de data para evolu√ß√µes m√©dicas -->
                                    <div class="row mb-3" id="filtro-evolucoes-medicas" style="display: none;">
                                        <div class="col-md-4">
                                            <label for="filtro-data-evolucoes-medicas" class="form-label small">Filtrar por data:</label>
                                            <div class="input-group input-group-sm">
                                                <input type="date" id="filtro-data-evolucoes-medicas" class="form-control">
                                                <button class="btn btn-outline-primary" id="btn-aplicar-filtro-evolucoes-medicas">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" id="btn-limpar-filtro-evolucoes-medicas">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Evolu√ß√µes de Hoje -->
                                    <div class="mb-4" id="evolucoes-hoje-container">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="fw-bold text-success mb-0">
                                                <i class="fas fa-calendar-day me-1"></i>Evolu√ß√µes de Hoje
                                            </h6>
                                            <span class="badge bg-success" id="contador-evolucoes-hoje">0</span>
                                        </div>
                                        <div id="listaEvolucoesMedicasHoje">
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Carregando evolu√ß√µes de hoje...</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Evolu√ß√µes Anteriores -->
                                    <div class="mb-3" id="evolucoes-antigas-container" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="fw-bold text-secondary mb-0">
                                                <i class="fas fa-history me-1"></i>Evolu√ß√µes Anteriores
                                            </h6>
                                            <span class="badge bg-secondary" id="contador-evolucoes-antigas-medicas">0</span>
                                        </div>
                                        <div id="listaEvolucoesMedicasAntigas">
                                            <div class="text-center text-muted py-3">
                                                <i class="fas fa-clock fa-2x mb-2"></i>
                                                <p>Carregando evolu√ß√µes anteriores...</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Fallback para lista original (oculta por padr√£o) -->
                                    <div id="lista-evolucoes-original" style="display: none;">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-primary">
                                                    <tr>
                                                        <th scope="col" style="width: 12%">Data/Hora</th>
                                                        <th scope="col" style="width: 13%">M√©dico</th>
                                                        <th scope="col" style="width: 75%">Evolu√ß√£o</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="listaEvolucoes">
                                                    <tr>
                                                        <td colspan="3" class="text-center py-4">
                                                            <div class="spinner-border text-primary" role="status">
                                                                <span class="visually-hidden">Carregando...</span>
                                                            </div>
                                                            <p class="mt-2 text-muted">Carregando evolu√ß√µes...</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aba de Anamnese e Conduta -->
                        <div class="tab-pane fade" id="anamnese-pane" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="mb-0 text-success fw-bold">Anamnese e Conduta M√©dica</h6>
                                <!-- Bot√£o de Editar removido - apenas m√©dicos podem editar -->
                            </div>

                            <div id="anamnese-conduta-loading" class="text-center my-4" style="display:none;">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            
                            <div id="anamnese-conduta-visualizacao">
                                <!-- Anamnese e Exame F√≠sico -->
                                <div class="row g-4 mb-4">
                                    <div class="col-12">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">
                                                <h6 class="mb-0"><i class="fas fa-user-check me-2"></i>Anamnese e Exame F√≠sico</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="p-4 bg-light rounded texto-evolucao" id="anamnese-exame-fisico-display" style="min-height: 200px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-file-medical fa-3x mb-3"></i>
                                                        <p>Carregando informa√ß√µes da anamnese...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Conduta M√©dica -->
                                <div class="row g-4 mb-4">
                                    <div class="col-12">
                                        <div class="card border-warning">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0"><i class="fas fa-prescription me-2"></i>Conduta M√©dica</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="p-4 bg-light rounded texto-evolucao" id="conduta-medica-display" style="min-height: 200px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                                        <p>Carregando conduta m√©dica...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aba de Diagn√≥stico -->
                        <div class="tab-pane fade" id="diagnostico-pane" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="mb-0 text-info fw-bold">Diagn√≥stico e Classifica√ß√£o</h6>
                                <!-- Bot√£o de Editar removido - apenas m√©dicos podem editar -->
                            </div>

                            <div id="diagnostico-loading" class="text-center my-4" style="display:none;">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2 text-muted">Carregando dados do diagn√≥stico...</p>
                            </div>
                            
                            <!-- Visualiza√ß√£o (padr√£o) -->
                            <div id="diagnostico-visualizacao">
                                <!-- Diagn√≥stico Principal -->
                                <div class="row g-4 mb-4">
                                    <div class="col-md-12">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0"><i class="fas fa-diagnoses me-2"></i>Diagn√≥stico Principal</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label fw-bold text-muted">Diagn√≥stico Inicial:</label>
                                                        <div class="p-4 bg-light rounded border" id="diagnostico-inicial-display" style="min-height: 150px;">
                                                            <div class="text-center text-muted">
                                                                <i class="fas fa-stethoscope fa-2x mb-3"></i>
                                                                <p class="mb-0">Carregando diagn√≥stico...</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label fw-bold text-muted">CID Principal:</label>
                                                        <div class="p-3 bg-light rounded border" id="cid-principal-display" style="min-height: 80px;">
                                                            <div class="text-center text-muted">
                                                                <i class="fas fa-code fa-lg mb-2"></i>
                                                                <p class="mb-0">Carregando CID...</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-0">
                                                    <label class="form-label fw-bold text-muted">Diagn√≥stico Atual:</label>
                                                    <div class="p-4 bg-light rounded border" id="diagnostico-atual-display" style="min-height: 150px;">
                                                        <div class="text-center text-muted">
                                                            <i class="fas fa-clipboard-check fa-2x mb-3"></i>
                                                            <p class="mb-0">Carregando diagn√≥stico atual...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Classifica√ß√µes Secund√°rias -->
                                <div class="row g-4 mb-4">
                                    <div class="col-md-6">
                                        <div class="card border-secondary h-100">
                                            <div class="card-header bg-secondary text-white">
                                                <h6 class="mb-0"><i class="fas fa-list me-2"></i>CID Secund√°rio</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="p-3 bg-light rounded border" id="cid-secundario-display" style="min-height: 100px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-list-ul fa-lg mb-2"></i>
                                                        <p>Nenhum CID secund√°rio registrado</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-warning h-100">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Causas Associadas</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="p-3 bg-light rounded border" id="causas-associadas-display" style="min-height: 100px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-link fa-lg mb-2"></i>
                                                        <p>Nenhuma causa associada registrada</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aba de Justificativas da Interna√ß√£o -->
                        <div class="tab-pane fade" id="justificativas-pane" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="mb-0 text-success fw-bold">Justificativas da Interna√ß√£o</h6>
                                <!-- Bot√£o de Editar removido - apenas m√©dicos podem editar -->
                            </div>

                            <div id="justificativas-loading" class="text-center my-4" style="display:none;">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            
                            <div id="justificativas-visualizacao">
                                <!-- Cards com mais espa√ßo -->
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="card border-danger h-100">
                                            <div class="card-header bg-danger text-white">
                                                <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Sinais e Sintomas</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="p-4 bg-light rounded border" id="sinais-sintomas-display" style="min-height: 200px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-heartbeat fa-2x mb-3"></i>
                                                        <p>Carregando sinais e sintomas...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-warning h-100">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Condi√ß√µes Justificativas</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="p-4 bg-light rounded border" id="condicoes-display" style="min-height: 200px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-check-double fa-2x mb-3"></i>
                                                        <p>Carregando condi√ß√µes que justificam...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-4 mt-2">
                                    <div class="col-12">
                                        <div class="card border-info">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-flask me-2"></i>Principais Resultados Diagn√≥sticos</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="p-4 bg-light rounded border" id="resultados-diagnosticos-display" style="min-height: 200px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-chart-line fa-2x mb-3"></i>
                                                        <p>Carregando resultados diagn√≥sticos...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fichaReferenciaSection" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-export me-2"></i>Fichas de Refer√™ncia</h5>
                </div>
                <div class="card-body">
                    <div id="listaFichasReferencia">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-primary"></i>
                            Carregando fichas de refer√™ncia...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="receituariosSection" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-prescription me-2"></i>Receitu√°rios</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 20%">Data</th>
                                    <th style="width: 20%">Tipo</th>
                                    <th style="width: 50%">Conte√∫do</th>
                                    <th style="width: 10%" class="text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaReceituarios">
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visualmente-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 text-muted mb-0">Carregando receitu√°rios...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="atestadosSection" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-signature me-2"></i>Atestados</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-secondary">
                                <tr>
                                    <th style="width: 25%">Data</th>
                                    <th style="width: 65%">Conte√∫do</th>
                                    <th style="width: 10%" class="text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaAtestados">
                                <tr>
                                    <td colspan="3" class="text-center py-4">
                                        <div class="spinner-border text-secondary" role="status">
                                            <span class="visualmente-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 text-muted mb-0">Carregando atestados...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="examesSection" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Exames Laboratoriais</h5>
                </div>
                <div class="card-body">
                    <textarea class="form-control" rows="5" readonly>{{ internacao.exames_laboratoriais or 'N√£o registrado.' }}</textarea>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Admiss√£o de Enfermagem -->
        <div id="admissaoEnfermagemSection" class="content-section">
            <!-- Admiss√£o de Enfermagem -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Admiss√£o de Enfermagem</h5>
                    {% if session.get('cargo')|lower|trim == 'enfermeiro' %}
                    <button class="btn btn-light btn-sm" id="btn-editar-admissao">
                        <i class="fas fa-edit me-1"></i>Editar Admiss√£o
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="admissao-texto-container">
                        <div class="texto-admissao p-3 bg-light rounded border" style="min-height: 120px;">
                            {% if internacao.admissao_enfermagem %}
                                {{ internacao.admissao_enfermagem | safe }}
                            {% else %}
                                <div class="text-muted text-center py-4">
                                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                                    <p class="mb-0">Nenhuma admiss√£o de enfermagem registrada para este paciente.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div id="admissao-form-container" style="display: none;">
                        <div class="mb-3">
                            <input type="hidden" id="internacao_id" value="{{ internacao.id }}">
                            <label for="admissao_enfermagem" class="form-label fw-bold">Texto da Admiss√£o</label>
                            <textarea class="form-control" id="admissao_enfermagem" rows="8" 
                                      placeholder="Digite aqui a admiss√£o de enfermagem...">{{ internacao.admissao_enfermagem or '' }}</textarea>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button id="btn-cancelar-admissao" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                            <button id="btn-salvar-admissao" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Salvar Admiss√£o
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Evolu√ß√µes de Enfermagem -->
        <div id="evolucaoEnfermagemSection" class="content-section active">
            <!-- Evolu√ß√µes de Enfermagem -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-notes-medical me-2"></i>Evolu√ß√µes de Enfermagem</h5>
                    <div class="d-flex gap-2">
                        {% if session.get('cargo')|lower|trim == 'enfermeiro' %}
                        <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#modalEnfermagemEvolucao">
                            <i class="fas fa-plus me-1"></i>Nova Evolu√ß√£o
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Resumo -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card border-0 bg-light">
                                <div class="card-body py-2">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="p-2 bg-info bg-opacity-10 rounded">
                                                <div class="h5 mb-1 text-info" id="contador-evolucoes-total">0</div>
                                                <small class="text-muted">Total</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 bg-success bg-opacity-10 rounded">
                                                <div class="h5 mb-1 text-success" id="contador-evolucoes-hoje-resumo">0</div>
                                                <small class="text-muted">Hoje</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 bg-secondary bg-opacity-10 rounded">
                                                <div class="h5 mb-1 text-secondary" id="contador-evolucoes-antigas">0</div>
                                                <small class="text-muted">Anteriores</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Todas as Evolu√ß√µes em uma √∫nica tabela -->
                    <div class="card border-info border-opacity-25">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-info">
                                    <tr>
                                        <th scope="col" style="width: 20%" class="fw-semibold">
                                            <i class="fas fa-clock me-1"></i>Data/Hora
                                        </th>
                                        <th scope="col" style="width: 25%" class="fw-semibold">
                                            <i class="fas fa-user-nurse me-1"></i>Enfermeiro(a)
                                        </th>
                                        <th scope="col" style="width: 55%" class="fw-semibold">
                                            <i class="fas fa-notes-medical me-1"></i>Evolu√ß√£o
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-evolucoes-enfermagem">
                                    <tr>
                                        <td colspan="3" class="text-center py-4">
                                            <div class="spinner-border text-info" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <p class="text-muted mt-2 mb-0">Carregando evolu√ß√µes...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Prescri√ß√µes de Enfermagem -->
        <div id="prescricaoEnfermagemSection" class="content-section">
            <!-- Prescri√ß√µes de Enfermagem -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-prescription-bottle-alt me-2"></i>Prescri√ß√µes de Enfermagem</h5>
                    {% if session.get('cargo')|lower|trim == 'enfermeiro' %}
                    <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#modalPrescricaoEnfermagem">
                        <i class="fas fa-plus-circle me-1"></i>Nova Prescri√ß√£o
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-warning">
                                <tr>
                                    <th scope="col" style="width: 15%">
                                        <i class="fas fa-clock me-1"></i>Data/Hora
                                    </th>
                                    <th scope="col" style="width: 10%">
                                        <i class="fas fa-user-nurse me-1"></i>Enfermeiro
                                    </th>
                                    <th scope="col" style="width: 65%">
                                        <i class="fas fa-prescription me-1"></i>Prescri√ß√£o
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="listaPrescricoesEnfermagem">
                                <tr>
                                    <td colspan="3" class="text-center py-4">
                                        <div class="spinner-border text-warning" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="text-muted mt-2 mb-0">Carregando prescri√ß√µes...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de SAE -->
        <div id="saeSection" class="content-section">
            <!-- SAE - Sistematiza√ß√£o da Assist√™ncia de Enfermagem -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Sistematiza√ß√£o da Assist√™ncia de Enfermagem (SAE)</h5>
                    {% if session.get('cargo')|lower|trim == 'enfermeiro' %}
                    <div>
                        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalSAE">
                            <i class="fas fa-plus-circle"></i> Nova SAE
                        </button>
                        <button class="btn btn-light btn-sm" id="btn-historico-sae">
                            <i class="fas fa-history"></i> Ver Hist√≥rico
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="listaSAE">
                        <p class="text-center text-muted">Carregando dados da SAE...</p>
                    </div>
                    <div id="historicoSAE" style="display: none;">
                        <h6 class="mb-3 text-secondary"><i class="fas fa-history me-2"></i> Hist√≥rico de SAE</h6>
                        <div id="listaHistoricoSAE">
                            <p class="text-center text-muted">Carregando hist√≥rico...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Remover se√ß√£o imagensSection -->
    </div>
</div>

<!-- Modal Aprazamento -->
<div class="modal fade" id="modalAprazamento" tabindex="-1" aria-labelledby="modalAprazamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title" id="modalAprazamentoLabel">
                    <i class="fas fa-clock me-2"></i>Aprazar Medicamento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <form id="formAprazamento" class="needs-validation" novalidate>
                    <input type="hidden" id="aprazamento_prescricao_id">
                    <input type="hidden" id="aprazamento_medicamento_index">
                    
                    <!-- Informa√ß√µes do Medicamento -->
                    <div class="alert alert-info py-2 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-pills me-2"></i>
                            <div>
                                <small class="text-muted">Medicamento:</small>
                                <strong id="aprazamento_medicamento_nome" class="ms-1">Medicamento</strong>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <!-- Per√≠odo -->
                        <div class="col-12">
                            <div class="card border-0 bg-light">
                                <div class="card-body p-2">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">Data Inicial</label>
                                            <input type="date" class="form-control form-control-sm" id="aprazamento_data_inicio" required>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">Data Final</label>
                                            <input type="date" class="form-control form-control-sm" id="aprazamento_data_fim" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configura√ß√£o de Hor√°rios -->
                        <div class="col-12">
                            <div class="card border-0 bg-light">
                                <div class="card-body p-2">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">Hor√°rio Inicial</label>
                                            <input type="time" class="form-control form-control-sm" id="aprazamento_hora_inicial_multiplos" required>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">Intervalo</label>
                                            <select class="form-select form-select-sm" id="aprazamento_multiplos_intervalo" required>
                                                <option value="4">4 horas</option>
                                                <option value="6" selected>6 horas</option>
                                                <option value="8">8 horas</option>
                                                <option value="12">12 horas</option>
                                                <option value="24">24 horas</option>
                                                <option value="custom">Personalizado</option>
                                            </select>
                                        </div>
                                        <div class="col-12" id="multiplos_intervalo_custom" style="display: none;">
                                            <input type="number" class="form-control form-control-sm" 
                                                id="aprazamento_multiplos_intervalo_custom" 
                                                min="0.5" max="24" step="0.5" value="6" 
                                                placeholder="Intervalo em horas (0.5 a 24)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√µes de A√ß√£o -->
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-primary flex-grow-1" id="btn_calcular_multiplos_dias">
                                    <i class="fas fa-calculator me-1"></i>Calcular
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btn_selecionar_todos">
                                    <i class="fas fa-check-square"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btn_desmarcar_todos">
                                    <i class="fas fa-square"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Hor√°rios Calculados -->
                        <div class="col-12">
                            <div id="horarios_multiplos_dias" class="border rounded bg-light p-2" 
                                style="max-height: 200px; overflow-y: auto;">
                                <p class="text-muted small text-center mb-0">
                                    <i class="fas fa-info-circle me-1"></i>Clique em "Calcular" para ver os hor√°rios
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes do Modal -->
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-sm btn-success">
                            <i class="fas fa-check me-1"></i>Registrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para nova evolu√ß√£o de enfermagem -->
<div class="modal fade" id="modalEnfermagemEvolucao" tabindex="-1" aria-labelledby="modalEnfermagemEvolucaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalEnfermagemEvolucaoLabel">Nova Evolu√ß√£o de Enfermagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formEvolucaoEnfermagem">
                    <!-- ID da interna√ß√£o e do usu√°rio -->
                    <input type="hidden" id="internacao_id_evolucao" value="{{ internacao.id }}">
                    <input type="hidden" id="usuario_id" value="{{ session.get('user_id', 0) }}">
                    <input type="hidden" id="nome_usuario" value="{{ session.get('nome', 'Usu√°rio Atual') }}">

                    <!-- Textarea simples (√∫nico editor usado) -->
                    <div class="mb-3">
                        <label for="texto_evolucao_enfermagem" class="form-label fw-bold">Texto da Evolu√ß√£o</label>
                        <textarea id="texto_evolucao_enfermagem"
                                  name="texto"
                                  class="form-control"
                                  rows="10"
                                  style="width: 100%; min-height: 300px; font-size: 14px;"
                                  placeholder="Digite a evolu√ß√£o de enfermagem..."></textarea>
                    </div>

                    <!-- Bot√µes -->
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Registrar Evolu√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Modal SAE -->
<div class="modal fade" id="modalSAE" tabindex="-1" aria-labelledby="modalSAELabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalSAELabel">SAE - Sistematiza√ß√£o da Assist√™ncia de Enfermagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <form id="formSAE" class="row g-3">
                    <input type="hidden" id="sae_paciente_id" value="{{ internacao.atendimento_id }}">
                    
                    <!-- Sinais Vitais -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-heartbeat text-primary me-2"></i>Sinais Vitais</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-2">
                                        <label class="form-label small">PA</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_pa" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">FC</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_fc" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">SAT</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_sat" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">R</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_r" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">T</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_t" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Pulso</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_pulso" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">DX (mg/dL)</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_dx" name="dx" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema Neurol√≥gico e Estado Geral -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-brain text-primary me-2"></i>Sistema Neurol√≥gico</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_neuro_consciente">
                                        <label class="form-check-label small" for="sae_neuro_consciente">Consciente</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_neuro_orientado">
                                        <label class="form-check-label small" for="sae_neuro_orientado">Orientado</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_neuro_desorientado">
                                        <label class="form-check-label small" for="sae_neuro_desorientado">Desorientado</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_neuro_torporoso">
                                        <label class="form-check-label small" for="sae_neuro_torporoso">Torporoso</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_neuro_inquieto">
                                        <label class="form-check-label small" for="sae_neuro_inquieto">Inquieto</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_neuro_reage">
                                        <label class="form-check-label small" for="sae_neuro_reage">Reage a est√≠mulos</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-user-check text-primary me-2"></i>Estado Geral</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sae_estado_geral" id="sae_estado_bom" value="bom">
                                        <label class="form-check-label small" for="sae_estado_bom">Bom</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sae_estado_geral" id="sae_estado_regular" value="regular">
                                        <label class="form-check-label small" for="sae_estado_regular">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sae_estado_geral" id="sae_estado_prejudicado" value="prejudicado">
                                        <label class="form-check-label small" for="sae_estado_prejudicado">Prejudicado</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ventila√ß√£o e Pele -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-lungs text-primary me-2"></i>Ventila√ß√£o</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_ventilacao_eupneico">
                                        <label class="form-check-label small" for="sae_ventilacao_eupneico">Eupneico</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_ventilacao_bradipneico">
                                        <label class="form-check-label small" for="sae_ventilacao_bradipneico">Bradipneico</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_ventilacao_dispneico">
                                        <label class="form-check-label small" for="sae_ventilacao_dispneico">Dispneico</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_ventilacao_aa">
                                        <label class="form-check-label small" for="sae_ventilacao_aa">AA</label>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small d-block">O2 POR:</label>
                                        <input type="text" class="form-control form-control-sm" id="sae_ventilacao_o2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-hand-holding-medical text-primary me-2"></i>Pele</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_pele_normocorado">
                                        <label class="form-check-label small" for="sae_pele_normocorado">Normocorado</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_pele_hipocorado">
                                        <label class="form-check-label small" for="sae_pele_hipocorado">Hipocorado</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_pele_acianotica">
                                        <label class="form-check-label small" for="sae_pele_acianotica">Acian√≥tica</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_pele_icterica">
                                        <label class="form-check-label small" for="sae_pele_icterica">Ict√©rica</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_pele_anicterica">
                                        <label class="form-check-label small" for="sae_pele_anicterica">Anict√©rica</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema Gastrointestinal e Regula√ß√£o Vascular -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-stomach text-primary me-2"></i>Sistema Gastrointestinal</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_gi_gavagem">
                                        <label class="form-check-label small" for="sae_gi_gavagem">Gavagem</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_gi_aberta">
                                        <label class="form-check-label small" for="sae_gi_aberta">Aberta</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_gi_emese">
                                        <label class="form-check-label small" for="sae_gi_emese">Emese</label>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label small d-block">Evacua√ß√µes:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_gi_evac_presente">
                                            <label class="form-check-label small" for="sae_gi_evac_presente">Presente</label>
                                        </div>
                                        <div class="form-check d-flex align-items-center gap-2">
                                            <input class="form-check-input" type="checkbox" id="sae_gi_evac_ausente">
                                            <label class="form-check-label small" for="sae_gi_evac_ausente">Ausente h√°</label>
                                            <input type="number" class="form-control form-control-sm" id="sae_gi_evac_dias" min="0" style="width: 60px;">
                                            <span class="small">dias</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-heartbeat text-primary me-2"></i>Regula√ß√£o Vascular</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_vascular_normocardico">
                                        <label class="form-check-label small" for="sae_vascular_normocardico">Normoc√°rdico</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_vascular_taquicardico">
                                        <label class="form-check-label small" for="sae_vascular_taquicardico">Taquic√°rdico</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_vascular_bradicardico">
                                        <label class="form-check-label small" for="sae_vascular_bradicardico">Bradic√°rdico</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_vascular_hipertenso">
                                        <label class="form-check-label small" for="sae_vascular_hipertenso">Hipertenso</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_vascular_hipotenso">
                                        <label class="form-check-label small" for="sae_vascular_hipotenso">Hipotenso</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sae_vascular_normotenso">
                                        <label class="form-check-label small" for="sae_vascular_normotenso">Normotenso</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pulso -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Pulso</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_pulso_cheio">
                                        <label class="form-check-label" for="sae_pulso_cheio">Cheio</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_pulso_filiforme">
                                        <label class="form-check-label" for="sae_pulso_filiforme">Filiforme</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_pulso_ritmico">
                                        <label class="form-check-label" for="sae_pulso_ritmico">R√≠tmico</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_pulso_arritmico">
                                        <label class="form-check-label" for="sae_pulso_arritmico">Arr√≠tmico</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Regula√ß√£o Abdominal -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Regula√ß√£o Abdominal</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_abdominal_normotenso">
                                        <label class="form-check-label" for="sae_abdominal_normotenso">Normotenso</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_abdominal_tenso">
                                        <label class="form-check-label" for="sae_abdominal_tenso">Tenso</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_abdominal_globoso">
                                        <label class="form-check-label" for="sae_abdominal_globoso">Globoso</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_abdominal_distendido">
                                        <label class="form-check-label" for="sae_abdominal_distendido">Distendido</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_abdominal_concavo">
                                        <label class="form-check-label" for="sae_abdominal_concavo">C√¥ncavo</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RHA -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">RHA (Ru√≠dos hidroa√©reos)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="sae_rha" id="sae_rha_presente" value="presente">
                                        <label class="form-check-label" for="sae_rha_presente">Presente</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="sae_rha" id="sae_rha_ausente" value="ausente">
                                        <label class="form-check-label" for="sae_rha_ausente">Ausente</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema Urin√°rio -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Sistema Urin√°rio</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_urinario_espontanea">
                                        <label class="form-check-label" for="sae_urinario_espontanea">Espont√¢nea</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_urinario_anuria">
                                        <label class="form-check-label" for="sae_urinario_anuria">An√∫ria</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_urinario_poliuria">
                                        <label class="form-check-label" for="sae_urinario_poliuria">Poli√∫ria</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_urinario_disuria">
                                        <label class="form-check-label" for="sae_urinario_disuria">Dis√∫ria</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_urinario_hematuria">
                                        <label class="form-check-label" for="sae_urinario_hematuria">Hemat√∫ria</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_urinario_oliguria">
                                        <label class="form-check-label" for="sae_urinario_oliguria">Olig√∫ria</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="sae_urinario_cistostomia">
                                        <label class="form-check-label" for="sae_urinario_cistostomia">Cistostomia</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Diagn√≥stico de Enfermagem -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-clipboard-check text-primary me-2"></i>Diagn√≥stico de Enfermagem</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_risco_infeccao">
                                            <label class="form-check-label small" for="sae_dx_risco_infeccao">Risco de infec√ß√£o</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_risco_pele">
                                            <label class="form-check-label small" for="sae_dx_risco_pele">Risco de integridade da pele prejudicada</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_mobilidade">
                                            <label class="form-check-label small" for="sae_dx_mobilidade">Mobilidade f√≠sica prejudicada</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_perfusao">
                                            <label class="form-check-label small" for="sae_dx_perfusao">Perfus√£o tissular prejudicada</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_autocuidado">
                                            <label class="form-check-label small" for="sae_dx_autocuidado">D√©ficit autocuidado para banho/higieniza√ß√£o</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_eliminacao_vesical">
                                            <label class="form-check-label small" for="sae_dx_eliminacao_vesical">Elimina√ß√£o vesical alterada</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_eliminacao_intestinal">
                                            <label class="form-check-label small" for="sae_dx_eliminacao_intestinal">Elimina√ß√£o intestinal alterada</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_risco_lp">
                                            <label class="form-check-label small" for="sae_dx_risco_lp">Risco de LP</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_troca_gases">
                                            <label class="form-check-label small" for="sae_dx_troca_gases">Troca de gases ineficaz</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_nutricao">
                                            <label class="form-check-label small" for="sae_dx_nutricao">Nutri√ß√£o desequilibrada</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_dor_aguda">
                                            <label class="form-check-label small" for="sae_dx_dor_aguda">Dor aguda</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_dor_cronica">
                                            <label class="form-check-label small" for="sae_dx_dor_cronica">Dor cr√¥nica</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sae_dx_protecao">
                                            <label class="form-check-label small" for="sae_dx_protecao">Prote√ß√£o ineficaz</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label for="sae_dx_outros" class="form-label small">Outros diagn√≥sticos:</label>
                                        <textarea class="form-control form-control-sm" id="sae_dx_outros" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0"><i class="fas fa-notes-medical text-primary me-2"></i>Informa√ß√µes Adicionais</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2"><label class="form-label small">Medica√ß√£o</label><textarea class="form-control form-control-sm" id="sae_medicacao" name="medicacao" rows="2" placeholder="Descreva as medica√ß√µes em uso..."></textarea></div>
                                <div class="mb-2"><label class="form-label small">Alergias</label><input type="text" class="form-control form-control-sm" id="sae_alergias" name="alergias"></div>
                                <div class="mb-2"><label class="form-label small">Antecedentes Pessoais</label><input type="text" class="form-control form-control-sm" id="sae_antecedentes_pessoais" name="antecedentes_pessoais"></div>
                                <div class="mb-2"><label class="form-label small">Acesso Venoso</label><input type="text" class="form-control form-control-sm" id="sae_acesso_venoso" name="acesso_venoso"></div>
                                <div class="mb-2"><label class="form-label small">Observa√ß√£o</label><textarea class="form-control form-control-sm" id="sae_observacao" name="observacao" rows="2"></textarea></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary btn-sm">Salvar SAE</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Prescri√ß√£o de Enfermagem -->
<div class="modal fade" id="modalPrescricaoEnfermagem" tabindex="-1" aria-labelledby="modalPrescricaoEnfermagemLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="modalPrescricaoEnfermagemLabel">Nova Prescri√ß√£o de Enfermagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Coluna da esquerda: Prescri√ß√µes padr√£o -->
                    <div class="col-md-5">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-search me-2"></i>
                                    Prescri√ß√µes Padr√£o
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Filtros de busca -->
                                <div class="mb-3">
                                    <label for="busca_prescricao_template" class="form-label">Buscar prescri√ß√£o:</label>
                                    <input type="text" 
                                           id="busca_prescricao_template" 
                                           class="form-control form-control-sm"
                                           placeholder="Digite para buscar...">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="titulo_prescricao" class="form-label">T√≠tulo:</label>
                                    <select id="titulo_prescricao" class="form-select form-select-sm">
                                        <option value="">Todos os t√≠tulos</option>
                                    </select>
                                </div>
                                
                                <!-- Resultados da busca -->
                                <div id="resultados_busca_prescricao" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">Prescri√ß√µes encontradas:</small>
                                    </div>
                                    <div id="lista_prescricoes_padrao" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Lista de prescri√ß√µes ser√° carregada aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Coluna da direita: Formul√°rio -->
                    <div class="col-md-7">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-edit me-2"></i>
                                    Texto da Prescri√ß√£o
                                </h6>
                            </div>
                            <div class="card-body">
                                <form id="formPrescricaoEnfermagem">
                                    <input type="hidden" id="prescricao_enfermagem_id" value="">
                                    <input type="hidden" id="internacao_id_prescricao" value="{{ internacao.id }}">
                                    <input type="hidden" id="enfermeiro_id" value="{{ session.get('user_id', 0) }}">

                                    <div class="mb-3">
                                        <textarea id="texto_prescricao_enfermagem"
                                                  name="texto"
                                                  class="form-control"
                                                  rows="15"
                                                  style="width: 100%; min-height: 400px; font-size: 14px;"
                                                  placeholder="Digite a prescri√ß√£o de enfermagem ou use os templates da esquerda..."></textarea>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Clique nos templates da esquerda para adicionar prescri√ß√µes padr√£o
                                        </small>
                                    </div>

                                    <div class="text-end">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-warning text-white">
                                            <i class="fas fa-save me-2"></i>
                                            Registrar Prescri√ß√£o
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
 </div>
 </div>

 <!-- Modal de Visualiza√ß√£o de Ficha de Refer√™ncia -->
 <div class="modal fade" id="modalVisualizarFichaReferencia" tabindex="-1" aria-labelledby="modalVisualizarFichaReferenciaLabel" aria-hidden="true">
     <div class="modal-dialog modal-lg">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title" id="modalVisualizarFichaReferenciaLabel">Ficha de Refer√™ncia</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
             </div>
             <div class="modal-body">
                 <div class="text-center py-4">
                     <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                     <p class="text-muted mb-0">Carregando ficha de refer√™ncia...</p>
                 </div>
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
             </div>
         </div>
     </div>
 </div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Quill Rich Text Editor -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script src="/static/js/aprazamento.js"></script>
<script src="/static/js/calculo_horarios.js"></script>
<script src="/static/js/admissao_enfermagem.js"></script>
<script src="/static/js/clinica_medico.js"></script>

<!-- Adicionar refer√™ncia ao m√≥dulo de evolu√ß√µes de enfermeiro -->

<!-- Adicionar o novo m√≥dulo completo de enfermagem - DEVE VIR POR √öLTIMO -->
<script src="/static/js/enfermagem_completo.js"></script>
<!-- modal_ficha_fix removido nesta tela para evitar interfer√™ncias -->

<!-- Campo hidden para armazenar o cargo do usu√°rio -->
<input type="hidden" id="cargo_usuario" value="{{ session.get('cargo', '') }}">
<!-- Campo hidden com o ID do atendimento para carregar fichas de refer√™ncia corretamente -->
<input type="hidden" id="atendimento_id" value="{{ internacao.atendimento_id }}">

<script>
    // Extrair ID da interna√ß√£o - serializa√ß√£o segura sem quebrar o linter
    const internacaoIdRaw = JSON.parse(`{{ internacao.id|tojson }}`);
    console.log('Valor raw de internacao.id:', internacaoIdRaw);
    
    // FOR√áAR atribui√ß√£o da vari√°vel internacaoId ANTES de qualquer m√≥dulo usar
    window.internacaoId = parseInt(internacaoIdRaw, 10);
    
    // Tamb√©m tentar atribuir √† vari√°vel do m√≥dulo se j√° estiver declarada
    if (typeof internacaoId !== 'undefined') {
        internacaoId = parseInt(internacaoIdRaw, 10);
        console.log('‚úÖ internacaoId atribu√≠do ao m√≥dulo:', internacaoId);
    }
    
    console.log('‚úÖ window.internacaoId definido:', window.internacaoId);
    
    // Definir tamb√©m a vari√°vel global internacaoIdRaw para compatibilidade
    window.internacaoIdRaw = internacaoIdRaw;
    
    // Recarregar dados agora que temos o internacaoId correto
    $(document).ready(function() {
        console.log('Reinicializando dados de enfermagem com internacaoId:', internacaoIdRaw);
        
        // Garantir que o ID est√° dispon√≠vel globalmente
        if (internacaoIdRaw && !isNaN(parseInt(internacaoIdRaw, 10))) {
            // Atribuir √† vari√°vel do m√≥dulo enfermagem_completo.js
            if (typeof internacaoId !== 'undefined') {
                internacaoId = parseInt(internacaoIdRaw, 10);
            }
            
            // Carregar evolu√ß√µes de enfermagem
            if (typeof carregarEvolucoesEnfermagem === 'function') {
                console.log('Carregando evolu√ß√µes de enfermagem...');
                carregarEvolucoesEnfermagem();
            } else {
                console.error('Fun√ß√£o carregarEvolucoesEnfermagem n√£o encontrada');
            }
        } else {
            console.error('ID da interna√ß√£o inv√°lido:', internacaoIdRaw);
        }
        
        // Carregar SAE
        const atendimentoId = $('#sae_paciente_id').val();
        if (atendimentoId && typeof carregarSAE === 'function') {
            console.log('Carregando SAE para atendimento:', atendimentoId);
            carregarSAE(atendimentoId);
        } else {
            console.error('ID do atendimento n√£o encontrado ou fun√ß√£o carregarSAE n√£o dispon√≠vel');
        }
    });
    
    // Declarar funcionarioId globalmente (JSON seguro sem quebrar o linter)
    const funcionarioId = JSON.parse(`{{ session.get('user_id', 0)|tojson }}`);
    console.log('ID do funcion√°rio:', funcionarioId);
    
    // Garantir que a fun√ß√£o formatarAprazamentoLegivel esteja dispon√≠vel
    if (typeof formatarAprazamentoLegivel !== 'function') {
        // Definir a fun√ß√£o se n√£o estiver dispon√≠vel globalmente
        window.formatarAprazamentoLegivel = function(texto) {
            if (!texto) return "N√£o aprazado";
            
            // Dividir por datas
            const secoes = texto.split(';');
            const datasDias = [];
            
            secoes.forEach(secao => {
                secao = secao.trim();
                if (!secao) return;
                
                const [data, horariosTexto] = secao.split(':');
                if (!data || !horariosTexto) return;
                
                const dataTrimmed = data.trim();
                const horarios = horariosTexto.split(',').map(h => h.trim()).join(', ');
                
                datasDias.push(`${dataTrimmed}: ${horarios}`);
            });
            
            return datasDias.join(" | ");
        };
        
        console.log('Fun√ß√£o formatarAprazamentoLegivel definida no escopo global');
    }
    
    // Array global para armazenar os medicamentos adicionados
    let medicamentosAdicionados = [];
    
    // Inicializar alergias do paciente com serializa√ß√£o segura
    let alergiasPaciente = '';
    try {
        const alergiasRaw = JSON.parse(`{{ (paciente.alergias or "")|tojson }}`);
        alergiasPaciente = (alergiasRaw || '').toLowerCase();
    } catch(e) {
        console.warn('Erro ao carregar alergias do paciente:', e);
        alergiasPaciente = '';
    }
    
    let quill; // Editor Quill para evolu√ß√£o m√©dica
    
    // Inicializar Observador de Muta√ß√µes para monitorar problemas DOM
    function observarMutacoesDom(seletor, callback) {
        const elemento = document.querySelector(seletor);
        if (!elemento) return null;
        
        const observer = new MutationObserver(callback);
        observer.observe(elemento, { 
            childList: true, 
            subtree: true,
            attributes: true,
            characterData: true
        });
        
        return observer;
    }
    

    // Fun√ß√£o para garantir que n√£o haja eventos depreciados no DOM
    function removerEventosDepreciados() {
        // Lista de eventos depreciados
        const eventosDepreciados = [
            'DOMNodeInserted',
            'DOMNodeRemoved',
            'DOMSubtreeModified',
            'DOMAttrModified',
            'DOMCharacterDataModified'
        ];
        
        // Fun√ß√£o para limpar o evento
        function limparEvento(event) {
            const elementos = document.querySelectorAll('*');
            for (let i = 0; i < elementos.length; i++) {
                const el = elementos[i];
                if (el._events && el._events[event]) {
                    delete el._events[event];
                    console.log(`Evento depreciado ${event} removido do elemento:`, el);
                }
            }
        }
        
        // Limpar todos os eventos depreciados
        eventosDepreciados.forEach(limparEvento);
    }

    $(document).ready(function() {
        // Atribuir valor √† vari√°vel global internacaoId declarada em enfermagem_completo.js
        if (typeof internacaoId !== 'undefined') {
            internacaoId = parseInt(internacaoIdRaw, 10);
            console.log('Valor de internacaoId ap√≥s parse:', internacaoId, typeof internacaoId);
            
            // Verificar se internacaoId √© um n√∫mero v√°lido
            if (isNaN(internacaoId)) {
                console.error('Erro: internacaoId n√£o √© um n√∫mero v√°lido!');
                alert('Erro ao carregar o ID da interna√ß√£o. Por favor, recarregue a p√°gina ou contate o suporte.');
            } else {
                console.log('internacaoId v√°lido:', internacaoId);
            }
        } else {
            console.error('Vari√°vel internacaoId n√£o declarada! Verifique se enfermagem_completo.js foi carregado.');
        }
        
        // DEFINIR EXPLICITAMENTE AS VARI√ÅVEIS GLOBAIS
        window.internacaoId = parseInt(internacaoIdRaw, 10);
        console.log('üí° Definindo window.internacaoId:', window.internacaoId);
        
        // Debugar cargo do usu√°rio (serializa√ß√£o segura sem quebrar o linter)
        try { window.CARGO_SESSAO = JSON.parse(`{{ session.get('cargo')|tojson }}`); } catch (e) { window.CARGO_SESSAO = ''; }
        console.log("Cargo do usu√°rio na sess√£o:", window.CARGO_SESSAO);
        
        // Inicializar Quill editor apenas se o container existir (para p√°gina m√©dica)
        const editorContainer = document.getElementById('editor-container');
        if (editorContainer) {
            try {
                quill = new Quill('#editor-container', {
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            [{ 'font': [] }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'list': 'check' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            [{ 'direction': 'rtl' }, { 'align': [] }],
                            ['blockquote', 'code-block'],
                            ['link'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Digite a evolu√ß√£o do paciente...',
                    theme: 'snow'
                });
                
                // Configurar fonte menor por padr√£o
                quill.root.style.fontSize = '13px';
                quill.root.style.lineHeight = '1.5';
                
                // Monitorar quando o Quill estiver totalmente carregado
                if (quill && quill.root) {
                    // Configurar um observador espec√≠fico para o editor
                    editorObserver = observarMutacoesDom('#editor-container', function() {
                        // Remover eventos depreciados sempre que houver uma altera√ß√£o
                        setTimeout(removerEventosDepreciados, 0);
                    });
                    
                    // Aplicar uma limpeza inicial de eventos depreciados
                    setTimeout(removerEventosDepreciados, 100);
                    
                    // Aplicar a implementa√ß√£o de scroll moderna
                    setupModernScroll(document.getElementById('editor-container'));
                }
                
                console.log('Quill editor inicializado com sucesso para #editor-container');
            } catch (error) {
                console.error('Erro ao inicializar Quill para #editor-container:', error);
            }
        } else {
            console.log('Container #editor-container n√£o encontrado - provavelmente p√°gina de enfermagem');
        }
        
        // Aplicar a implementa√ß√£o de scroll moderna para o editor de enfermagem (se existir)
        if (document.getElementById('editor-container-enfermagem')) {
            setupModernScroll(document.getElementById('editor-container-enfermagem'));
        }
        
        // Usar MutationObserver em vez de DOMNodeInserted (apenas se Quill foi inicializado)
        if (typeof quill !== 'undefined' && quill) {
            observarMutacoesDom('.ql-toolbar', function(mutacoes) {
                // Processar as muta√ß√µes aqui, se necess√°rio
                console.log('Toolbar do editor atualizada');
                // Remover eventos depreciados ap√≥s atualiza√ß√£o da toolbar
                setTimeout(removerEventosDepreciados, 0);
            });
        } else {
            console.log('Quill n√£o inicializado - pulando configura√ß√£o do MutationObserver');
        }
        
        // Manipular erros que possam ocorrer com o editor (apenas se container existir)
        if (document.getElementById('editor-container')) {
            try {
                // Verificar se o editor foi inicializado corretamente
                if (!quill || !quill.root) {
                    console.error('Erro ao inicializar o editor Quill.');
                    // Criar um editor de fallback se Quill falhar
                    $('#editor-container').hide();
                    $('<textarea class="form-control" rows="6" id="fallback-editor"></textarea>')
                        .insertAfter('#editor-container');
                    
                    // Atualizar o handler de submit para usar o editor de fallback
                    $('#formEvolucao').off('submit').on('submit', function(e) {
                        e.preventDefault();
                        const textoPlano = $('#fallback-editor').val().trim();
                        
                        if (!textoPlano) {
                            alert('Por favor, preencha o texto da evolu√ß√£o.');
                            return;
                        }
                        
                        const dados = {
                            internacao_id: isNaN(internacaoId) ? null : internacaoId,
                            funcionario_id: parseInt("{{ session.get('user_id', 0) }}", 10),
                            evolucao: textoPlano
                        };
                        
                        enviarEvolucao(dados);
                    });
                }
            } catch (error) {
                console.error('Erro no editor Quill:', error);
            }
        }
        
        // Adicionar listener de erro global para Quill (apenas se container existir)
        if (document.getElementById('editor-container')) {
            window.addEventListener('error', function(e) {
                if (e.message && e.message.includes('quill')) {
                    console.error('Erro relacionado ao Quill:', e.message);
                    if ($('#fallback-editor').length === 0) {
                        $('#editor-container').hide();
                        $('<textarea class="form-control" rows="6" id="fallback-editor"></textarea>')
                            .insertAfter('#editor-container');
                        
                        // Atualizar o handler de submit
                        $('#formEvolucao').off('submit').on('submit', function(evt) {
                            evt.preventDefault();
                            const textoPlano = $('#fallback-editor').val().trim();
                            
                            if (!textoPlano) {
                                alert('Por favor, preencha o texto da evolu√ß√£o.');
                                return;
                            }
                            
                            const dados = {
                                internacao_id: isNaN(internacaoId) ? null : internacaoId,
                                funcionario_id: parseInt("{{ session.get('user_id', 0) }}", 10),
                                evolucao: textoPlano
                            };
                            
                            enviarEvolucao(dados);
                        });
                    }
                }
            });
        }
        
        // Configurar navega√ß√£o das abas
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                // Remove active de todos os links (exceto action-btn)
                document.querySelectorAll('.sidebar .nav-link').forEach(l => {
                    if (!l.classList.contains('action-btn')) {
                        l.classList.remove('active');
                    }
                });
                // Adiciona active ao link clicado (se n√£o for action-btn)
                if (!this.classList.contains('action-btn')) {
                    this.classList.add('active');
                }

                const target = this.getAttribute('data-target');
                if (target) {
                    // Esconde todas as se√ß√µes
                    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
                    // Mostra a se√ß√£o alvo
                    document.getElementById(target).classList.add('active');
                    // Carregar dados on-demand
                    if (target === 'receituariosSection') {
                        carregarReceituariosSomenteLeitura();
                    } else if (target === 'atestadosSection') {
                        carregarAtestadosSomenteLeitura();
                    }
                }
            });
        });

        // Ativar a aba de evolu√ß√£o de enfermagem por padr√£o
        document.querySelector('.sidebar .nav-link[data-target="evolucaoEnfermagemSection"]').click();

        // Carregar prescri√ß√µes ao iniciar
        carregarPrescricoes();
        
        // Carregar evolu√ß√µes ao iniciar
        carregarEvolucoes();

        // Pr√©-carregar listas em background (somente leitura)
        setTimeout(() => {
            try { carregarReceituariosSomenteLeitura(); } catch (e) { console.warn('Erro preloading receituarios:', e); }
            try { carregarAtestadosSomenteLeitura(); } catch (e) { console.warn('Erro preloading atestados:', e); }
        }, 500);
        
        // Garantir que os bot√µes de prescri√ß√£o fichem sempre vis√≠veis
        $('.prescricao-actions, .btn-print-discreto').css({
            'opacity': '1',
            'visibility': 'visible',
            'position': 'relative',
            'z-index': '999'
        });
        
        // Carregar evolu√ß√µes de enfermagem usando a fun√ß√£o do m√≥dulo externo
        if (typeof carregarEvolucoesEnfermagem === 'function') {
            console.log('Carregando evolu√ß√µes de enfermagem do m√≥dulo externo');
            carregarEvolucoesEnfermagem();
        } else {
            console.error('Fun√ß√£o carregarEvolucoesEnfermagem n√£o encontrada no m√≥dulo externo');
        }

        // Desativado nesta tela: m√≥dulo de Fichas de Refer√™ncia para evitar interfer√™ncias
        
        // Configurar handler para editar admiss√£o
        $('#btn-editar-admissao').click(function() {
            $('#modalEnfermagem').modal('show');
        });
        
        // Handler para salvar admiss√£o de enfermagem
        // Usar vari√°veis globais j√° declaradas acima
        // const internacaoId = $('#internacao_id').val(); // Removido - usar a global
        // const funcionarioId = $('#usuario_id').val(); // Removido - usar a global

        // Handler para salvar admiss√£o de enfermagem
        $(document).on('submit', '#formEnfermagem', function(e) {
            e.preventDefault();

            const admissaoTexto = $('#admissao_enfermagem').val().trim();

            if (!admissaoTexto) {
                alert('Por favor, preencha a admiss√£o de enfermagem.');
                return;
            }

            if (!internacaoId || !funcionarioId) {
                alert('Erro: interna√ß√£o ou enfermeiro n√£o identificado.');
                return;
            }

            $('#btn-salvar-admissao').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');

            $.ajax({
                url: '/api/enfermagem/admissao',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    internacao_id: internacaoId,
                    enfermeiro_id: funcionarioId,
                    admissao_texto: admissaoTexto
                }),
                success: function(response) {
                    $('#btn-salvar-admissao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Admiss√£o');
                    $('.texto-admissao').html(admissaoTexto);
                    $('#admissao-form-container').hide();
                    $('#admissao-texto-container').show();
                    alert('Admiss√£o de enfermagem registrada com sucesso!');
                },
                error: function(xhr, status, error) {
                    $('#btn-salvar-admissao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Admiss√£o');
                    console.error('Erro ao salvar admiss√£o de enfermagem:', xhr.responseText);
                    alert('Erro de comunica√ß√£o ao tentar salvar admiss√£o: ' + (xhr.responseJSON?.erro || error));
                }
            });
        });


        


        // Handler completo para registrar m√∫ltiplos aprazamentos
       // Handler completo ‚Äî vers√£o corrigida (mant√©m minutos "HH:MM")
        // Handler de envio do formul√°rio de aprazamento (pronto para copiar)
        $(document).on('submit', '#formAprazamento', function (e) {
            e.preventDefault();

            /* ------------------------------------------------------------------
            1. Coleta de dados b√°sicos
            ------------------------------------------------------------------ */
            const prescricao_id             = $('#aprazamento_prescricao_id').val();
            const nome_medicamento          = $('#aprazamento_medicamento_nome').text();
            const enfermeiro_responsavel_id = $(this).data('enfermeiro-id') || window.session?.user_id;

            /* ------------------------------------------------------------------
            2. Hor√°rios selecionados
            ------------------------------------------------------------------ */
            const horariosSelecionados = $('#horarios_multiplos_dias .horario-check:checked')
                .map(function () { return $(this).val().trim(); })    // "DD/MM/YYYY:HH:MM"
                .get();

            if (horariosSelecionados.length === 0) {
                alert('Selecione pelo menos um hor√°rio para aprazamento.');
                return;
            }

            /* ------------------------------------------------------------------
            3. Agrupa por data (preservando minutos)
                { '23/05/2025': ['08:00','14:30'], ... }
            ------------------------------------------------------------------ */
            const horariosPorData = {};
            horariosSelecionados.forEach(v => {
                const idx  = v.indexOf(':');     // primeiro ":"
                if (idx === -1) return;          // seguran√ßa
                const data = v.slice(0, idx);    // "23/05/2025"
                const hora = v.slice(idx + 1);   // "08:00", "14:30", etc.
                (horariosPorData[data] = horariosPorData[data] || []).push(hora);
            });

            /* ------------------------------------------------------------------
            4. Callback coletor ‚Äì fecha modal quando todas as requisi√ß√µes ok
            ------------------------------------------------------------------ */
            const totalRequisicoes = horariosSelecionados.length;
            let respostas = 0;
            let erroDetectado = false;

            function callbackColetor(response) {
                respostas++;

                if (!response.success && !erroDetectado) {
                    erroDetectado = true;
                    alert(response.message || 'Erro ao registrar aprazamento.');
                }

                if (respostas === totalRequisicoes && !erroDetectado) {
                    $('#modalAprazamento').modal('hide');
                    carregarPrescricoes();
                }
            }

            /* ------------------------------------------------------------------
            5. Envia 1 requisi√ß√£o por hor√°rio (1 hor√°rio ‚Üí 1 Aprazamento)
            ------------------------------------------------------------------ */
            for (const [data, horas] of Object.entries(horariosPorData)) {
                horas.forEach(hora => {
                    registrarAprazamento({
                        prescricao_id,
                        nome_medicamento,
                        data_hora_aprazamento: `${data} ${hora}`,  // "DD/MM/YYYY HH:MM"
                        enfermeiro_responsavel_id
                    }, callbackColetor);
                });
            }
});



        // Fun√ß√£o para carregar evolu√ß√µes de enfermagem
        function carregarEvolucoesEnfermagem() {
            console.log('üîÑ Iniciando carregamento de evolu√ß√µes de enfermagem...');
            
            // Usar a vari√°vel global internacaoId que foi definida no in√≠cio da p√°gina
            const idInternacao = window.internacaoId || internacaoId;
            
            console.log('üîç ID da interna√ß√£o encontrado:', idInternacao);
            
            if (!idInternacao) {
                console.error('‚ùå ID da interna√ß√£o n√£o encontrado');
                $('#tabela-evolucoes-hoje').html(`
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="text-danger">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p class="mb-0">Erro: ID da interna√ß√£o n√£o encontrado.</p>
                            </div>
                        </td>
                    </tr>
                `);
                return;
            }
            
            console.log(`üì° Fazendo requisi√ß√£o para: /api/enfermagem/evolucao/${idInternacao}`);
            
            $.ajax({
                url: `/api/enfermagem/evolucao/${idInternacao}`,
                method: 'GET',
                success: function(response) {
                    console.log('‚úÖ Resposta recebida da API:', response);
                    // Separar evolu√ß√µes de hoje e anteriores
                    const hoje = new Date().toISOString().split('T')[0];
                    const evolucoesDoDia = [];
                    const evolucoesAntigas = [];
                    
                    if (Array.isArray(response)) {
                        response.forEach(ev => {
                            const dataEvolucao = new Date(ev.data_evolucao).toISOString().split('T')[0];
                            if (dataEvolucao === hoje) {
                                evolucoesDoDia.push(ev);
                            } else {
                                evolucoesAntigas.push(ev);
                            }
                        });
                        
                        // Atualizar contadores do resumo
                        $('#contador-evolucoes-hoje-resumo').text(evolucoesDoDia.length);
                        $('#contador-evolucoes-antigas').text(evolucoesAntigas.length);
                        
                        // Renderizar evolu√ß√µes do dia
                        if (evolucoesDoDia.length > 0) {
                            let htmlDoDia = '';
                            evolucoesDoDia.forEach(ev => {
                                const hora = new Date(ev.data_evolucao).toLocaleTimeString('pt-BR', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                htmlDoDia += `
                                    <tr class="evolucao-row">
                                        <td class="align-middle">
                                            <span class="badge bg-success bg-opacity-25 text-success">${hora}</span>
                                        </td>
                                        <td class="align-middle">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-nurse text-success me-2"></i>
                                                <span class="fw-medium">${ev.enfermeiro_nome || 'N√£o informado'}</span>
                                            </div>
                                        </td>
                                        <td class="align-middle">
                                            <div class="texto-evolucao p-2 bg-light rounded border-start border-success border-3">
                                                ${ev.texto || '---'}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });
                            $('#tabela-evolucoes-hoje').html(htmlDoDia);
                        } else {
                            $('#tabela-evolucoes-hoje').html(`
                                <tr>
                                    <td colspan="3" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-calendar-check fa-2x mb-2 text-success opacity-50"></i>
                                            <p class="mb-0">Nenhuma evolu√ß√£o registrada hoje.</p>
                                        </div>
                                    </td>
                                </tr>
                            `);
                        }
                        
                        // Renderizar evolu√ß√µes antigas
                        if (evolucoesAntigas.length > 0) {
                            let htmlAntigas = '';
                            evolucoesAntigas.forEach(ev => {
                                const dataFormatada = new Date(ev.data_evolucao).toLocaleDateString('pt-BR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                });
                                const hora = new Date(ev.data_evolucao).toLocaleTimeString('pt-BR', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                htmlAntigas += `
                                    <tr class="evolucao-row">
                                        <td class="align-middle">
                                            <span class="badge bg-secondary bg-opacity-25 text-secondary">${dataFormatada} ${hora}</span>
                                        </td>
                                        <td class="align-middle">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-nurse text-secondary me-2"></i>
                                                <span class="fw-medium">${ev.enfermeiro_nome || 'N√£o informado'}</span>
                                            </div>
                                        </td>
                                        <td class="align-middle">
                                            <div class="texto-evolucao p-2 bg-light rounded border-start border-secondary border-3">
                                                ${ev.texto || '---'}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });
                            $('#tabela-evolucoes-antigas').html(htmlAntigas);
                        } else {
                            $('#tabela-evolucoes-antigas').html(`
                                <tr>
                                    <td colspan="3" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-history fa-2x mb-2 text-secondary opacity-50"></i>
                                            <p class="mb-0">Nenhuma evolu√ß√£o anterior registrada.</p>
                                        </div>
                                    </td>
                                </tr>
                            `);
                        }
                    } else {
                        // Atualizar contadores para zero
                        $('#contador-evolucoes-hoje-resumo').text('0');
                        $('#contador-evolucoes-antigas').text('0');
                        
                        $('#tabela-evolucoes-hoje').html(`
                            <tr>
                                <td colspan="3" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-2 text-info opacity-50"></i>
                                        <p class="mb-0">Nenhuma evolu√ß√£o registrada.</p>
                                    </div>
                                </td>
                            </tr>
                        `);
                        $('#tabela-evolucoes-antigas').html(`
                            <tr>
                                <td colspan="3" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-2 text-info opacity-50"></i>
                                        <p class="mb-0">Nenhuma evolu√ß√£o registrada.</p>
                                    </div>
                                </td>
                            </tr>
                        `);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao carregar evolu√ß√µes de enfermagem:', xhr.responseText);
                    $('#contador-evolucoes-hoje-resumo').text('0');
                    $('#contador-evolucoes-antigas').text('0');
                    
                    const errorHtml = `
                        <tr>
                            <td colspan="3" class="text-center py-4">
                                <div class="text-danger">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                    <p class="mb-0">Erro ao carregar evolu√ß√µes.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    $('#tabela-evolucoes-hoje').html(errorHtml);
                    $('#tabela-evolucoes-antigas').html(errorHtml);
                }
            });
        }
        
        // Toggle evolu√ß√µes antigas (handler configurado em enfermagem_completo.js)
        // Removido daqui para evitar duplica√ß√£o
        
        // Agora as fun√ß√µes est√£o no m√≥dulo enfermagem_completo.js
        
        // Autocomplete de medicamentos
        $('#nome_medicamento').on('input', function() {
            const termo = $(this).val().trim();
            if (termo.length >= 2) {
                $.getJSON(`/api/medicamentos/buscar?termo=${termo}`, function(nomes) {
                    $('#listaMedicamentosDisponiveis').empty();
                    nomes.forEach(nome => {
                        $('#listaMedicamentosDisponiveis').append(`<option value="${nome}">`);
                    });
                });
            }
            
            // Verifica√ß√£o de alergia
            const valorDigitado = termo.toLowerCase();
            const termosAlergia = alergiasPaciente.split(/[\s,;.]+/).map(t => t.trim().toLowerCase()).filter(t => t.length > 2);
            const ehAlergico = valorDigitado.length >= 3 && termosAlergia.some(t =>
                t === valorDigitado || valorDigitado.includes(t) || t.includes(valorDigitado)
            );
            
            if (ehAlergico) {
                $('#avisoAlergia').show();
            } else {
                $('#avisoAlergia').hide();
            }
        });

        // Fun√ß√£o para adicionar medicamento √† lista
        $('#btnAdicionarMedicamento').click(function() {
            const nome = $('#nome_medicamento').val().trim();
            const descricao = $('#descricao_uso').val().trim();
            let aprazamento = $('#aprazamento').val();
            
            if (!nome || !descricao) {
                alert('Por favor, preencha nome do medicamento e descri√ß√£o de uso.');
                return;
            }
            
            // Adicionar medicamento ao array
            const medicamento = {
                nome_medicamento: nome,
                descricao_uso: descricao,
                aprazamento: aprazamento || null
            };
            
            medicamentosAdicionados.push(medicamento);
            
            // Atualizar a tabela
            atualizarTabelaMedicamentos();
            
            // Limpar os campos para novo medicamento
            $('#nome_medicamento').val('');
            $('#descricao_uso').val('');
            $('#aprazamento').val('');
            $('#avisoAlergia').hide();
        });
        
        // Fun√ß√£o global para atualizar a tabela de medicamentos
        function atualizarTabelaMedicamentos() {
            const tabela = $('#tabelaMedicamentosAdicionados tbody');
            
            if (medicamentosAdicionados.length === 0) {
                tabela.html('<tr id="semMedicamentos"><td colspan="4" class="text-center">Nenhum medicamento adicionado</td></tr>');
                return;
            }
            
            // Esconder a mensagem de "nenhum medicamento"
            $('#semMedicamentos').hide();
            
            // Limpar e reconstruir a tabela
            tabela.empty();
            
            
            medicamentosAdicionados.forEach((med, index) => {
                const aprazamentoFormatado = med.aprazamento ? 
                    new Date(med.aprazamento).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                
                tabela.append(`
                    <tr data-index="${index}">
                        <td>${med.nome_medicamento}</td>
                        <td>${med.descricao_uso}</td>
                        <td>${aprazamentoFormatado}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm btn-remover-medicamento">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Adicionar event listeners para bot√µes de remover
            $('.btn-remover-medicamento').click(function() {
                const index = $(this).closest('tr').data('index');
                medicamentosAdicionados.splice(index, 1);
                atualizarTabelaMedicamentos();
            });
        }

        // Submiss√£o do formul√°rio de prescri√ß√£o
        $('#formPrescricao').on('submit', function(e) {
            e.preventDefault();
            
            // Verificar se √© uma nova prescri√ß√£o ou uma edi√ß√£o
            const prescricaoId = $('#prescricao_id').val();
            const isEdicao = prescricaoId !== "";
            
            const texto_dieta = $('#texto_dieta').val().trim();
            const texto_procedimento_medico = $('#texto_procedimento_medico').val().trim();
            const texto_procedimento_multi = $('#texto_procedimento_multi').val().trim();
            
            // Verificar se ao menos algo foi preenchido (dieta, procedimentos ou medicamentos)
            if (!texto_dieta && !texto_procedimento_medico && !texto_procedimento_multi && medicamentosAdicionados.length === 0) {
                alert('Por favor, preencha pelo menos um dos campos da prescri√ß√£o ou adicione ao menos um medicamento.');
                return;
            }
            
            // Obter hor√°rio atual formatado para o Brasil
            const dataAtual = new Date();
            const horarioBrasil = dataAtual.toLocaleString('pt-BR', { 
                timeZone: 'America/Sao_Paulo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            // Log para debug do hor√°rio
            console.log('Hor√°rio formatado para Brasil:', horarioBrasil);
            
            // Preparar dados para envio
            let dados = {
                atendimentos_clinica_id: isNaN(internacaoId) ? null : internacaoId,
                medico_id: parseInt("{{ session.get('user_id', 0) }}", 10),
                funcionario_id: parseInt("{{ session.get('user_id', 0) }}", 10),
                texto_dieta: texto_dieta || null,
                texto_procedimento_medico: texto_procedimento_medico || null,
                texto_procedimento_multi: texto_procedimento_multi || null,
                horario_prescricao: horarioBrasil,
                medicamentos: medicamentosAdicionados
            };
            
            // Log para debug
            console.log('Dados da prescri√ß√£o:', dados);
            
            if (!dados.atendimentos_clinica_id) {
                alert('Erro: ID da interna√ß√£o inv√°lido.');
                return;
            }
            
            // URL e m√©todo dependem se √© edi√ß√£o ou nova prescri√ß√£o
            const url = isEdicao ? `/api/prescricoes/${prescricaoId}` : '/api/prescricoes';
            const method = isEdicao ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(dados),
                success: function(response) {
                    if (response.success) {
                        // Fechar modal e limpar campos
                        $('#modalPrescricao').modal('hide');
                        limparFormularioPrescricao();
                        
                        // Recarregar lista de prescri√ß√µes
                        carregarPrescricoes();
                    } else {
                        alert('Erro ao registrar prescri√ß√£o: ' + (response.message || 'Erro desconhecido'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao registrar prescri√ß√£o:', xhr.responseText);
                    alert('Erro de comunica√ß√£o ao tentar registrar prescri√ß√£o: ' + (xhr.responseJSON?.error || error));
                    console.error('Erro ao buscar prescri√ß√µes:', xhr.responseText);
                    alert('Erro de comunica√ß√£o ao buscar prescri√ß√µes');
                }
            });
        });
        
        // Adicione bot√£o Novo ao clicar no bot√£o de nova prescri√ß√£o
        $('.btn[data-bs-target="#modalPrescricao"]').on('click', function() {
            limparFormularioPrescricao();
        });

        // Fun√ß√£o para carregar prescri√ß√µes da interna√ß√£o
        function carregarPrescricoes(idInternacao = null, lastUpdate = false) {
            // Se internacaoId n√£o foi fornecido, use a vari√°vel global
            const id = idInternacao || internacaoId;
            
            console.log(`Iniciando carregarPrescricoes com ID: ${id}, lastUpdate: ${lastUpdate}`);
            
            if (!lastUpdate) {
                $("#listaPrescricoes").html("<div class='d-flex justify-content-center align-items-center py-4'><div class='spinner-border text-primary' role='status'><span class='visually-hidden'>Carregando...</span></div><span class='ms-2'>Carregando prescri√ß√µes...</span></div>");
            }
            
            $.ajax({
                url: "/api/prescricoes/" + id,
                type: 'GET',
                success: function(response) {
                    console.log("Resposta recebida:", response);
                    
                    if (!response.success) {
                        $("#listaPrescricoes").html("<div class='alert alert-warning text-center'><i class='fas fa-exclamation-triangle me-2'></i>Erro ao carregar prescri√ß√µes: " + response.error + "</div>");
                        console.error("Erro ao carregar prescri√ß√µes:", response.error);
                        return;
                    }
                    
                    if (!response.prescricoes || response.prescricoes.length === 0) {
                        $("#listaPrescricoes").html("<div class='alert alert-info text-center'><i class='fas fa-info-circle me-2'></i>Nenhuma prescri√ß√£o encontrada para este paciente.</div>");
                        console.log("Nenhuma prescri√ß√£o encontrada");
                        return;
                    }
                    
                    console.log(`${response.prescricoes.length} prescri√ß√µes encontradas`);
                    
                    // Ordenar prescri√ß√µes por data (mais recente primeiro)
                    var prescricoes = response.prescricoes.sort(function(a, b) {
                        const dataA = new Date(a.horario_prescricao || a.data_prescricao || a.created_at);
                        const dataB = new Date(b.horario_prescricao || b.data_prescricao || b.created_at);
                        
                        // Se as datas s√£o v√°lidas, ordenar do mais recente para o mais antigo
                        if (!isNaN(dataA.getTime()) && !isNaN(dataB.getTime())) {
                            return dataB.getTime() - dataA.getTime();
                        }
                        
                        // Se uma das datas √© inv√°lida, colocar a v√°lida primeiro
                        if (!isNaN(dataA.getTime()) && isNaN(dataB.getTime())) return -1;
                        if (isNaN(dataA.getTime()) && !isNaN(dataB.getTime())) return 1;
                        
                        // Se ambas s√£o inv√°lidas, manter ordem original (por ID decrescente)
                        return b.id - a.id;
                    });
                    
                    var html = "";
                    
                    // Renderizar cada prescri√ß√£o individualmente igual ao m√©dico
                    prescricoes.forEach(function(prescricao) {
                        html += renderizarPrescricao(prescricao);
                    });
                    
                    $("#listaPrescricoes").html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro na requisi√ß√£o AJAX:", xhr.responseText);
                    $("#listaPrescricoes").html("<div class='alert alert-danger text-center'><i class='fas fa-exclamation-triangle me-2'></i>Erro ao carregar prescri√ß√µes: " + error + "</div>");
                    
                    // Tentar novamente automaticamente apenas uma vez se for erro 404 ou 500
                    if ((xhr.status === 404 || xhr.status === 500) && !lastUpdate) {
                        console.log("Tentando carregar prescri√ß√µes novamente ap√≥s erro " + xhr.status);
                        setTimeout(function() {
                            carregarPrescricoes(id, true);
                        }, 2000);
                    }
                }
            });
        }

        // Fun√ß√£o para carregar evolu√ß√µes da interna√ß√£o
        function carregarEvolucoes() {
            console.log('Carregando evolu√ß√µes para internacaoId:', internacaoId);
            
            if (!internacaoId || isNaN(internacaoId)) {
                console.error('ID de interna√ß√£o inv√°lido ao carregar evolu√ß√µes:', internacaoId);
                $('#listaEvolucoesMedicasHoje').html('<div class="evolucao-vazia"><i class="fas fa-exclamation-triangle"></i><p>Erro: ID de interna√ß√£o inv√°lido</p></div>');
                return;
            }
            
            $.ajax({
                url: `/api/evolucoes/${internacaoId}`,
                method: 'GET',
                success: function(response) {
                    console.log('Resposta da API de evolu√ß√µes:', response);
                    
                    if (response.success && response.evolucoes && response.evolucoes.length > 0) {
                        const hoje = new Date().toISOString().split('T')[0];
                        const evolucoesDoDia = [];
                        const evolucoesAntigas = [];
                        
                        response.evolucoes.forEach(ev => {
                            const dataEvolucao = new Date(ev.data_evolucao).toISOString().split('T')[0];
                            if (dataEvolucao === hoje) {
                                evolucoesDoDia.push(ev);
                            } else {
                                evolucoesAntigas.push(ev);
                            }
                        });
                        
                        // Renderizar evolu√ß√µes de hoje
                        if (evolucoesDoDia.length > 0) {
                            let htmlHoje = '';
                            evolucoesDoDia.forEach(ev => {
                                const dataFormatada = new Date(ev.data_evolucao).toLocaleDateString('pt-BR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                htmlHoje += `
                                    <div class="evolucao-card">
                                        <div class="evolucao-card-header">
                                            <div class="evolucao-info">
                                                <h6 class="evolucao-medico mb-1">Dr(a). ${ev.nome_medico || 'M√©dico n√£o informado'}</h6>
                                                <span class="evolucao-data text-muted">${dataFormatada}</span>
                                                <span class="badge bg-success ms-2">HOJE</span>
                                            </div>
                                            <div class="evolucao-actions">
                                                <button class="btn btn-sm btn-outline-success" onclick="imprimirEvolucao(${ev.id})" title="Imprimir Evolu√ß√£o">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="evolucao-card-body">
                                            <div class="evolucao-conteudo">
                                                ${ev.evolucao || '---'}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            $('#listaEvolucoesMedicasHoje').html(htmlHoje);
                            $('#contadorEvolucoesHoje').text(evolucoesDoDia.length);
                        } else {
                            $('#listaEvolucoesMedicasHoje').html('<div class="evolucao-vazia"><i class="fas fa-calendar-times"></i><p>Nenhuma evolu√ß√£o m√©dica registrada hoje.</p></div>');
                            $('#contadorEvolucoesHoje').text('0');
                        }
                        
                        // Renderizar evolu√ß√µes antigas
                        if (evolucoesAntigas.length > 0) {
                            let htmlAntigas = '';
                            evolucoesAntigas.forEach(ev => {
                                const dataFormatada = new Date(ev.data_evolucao).toLocaleDateString('pt-BR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                htmlAntigas += `
                                    <div class="evolucao-card">
                                        <div class="evolucao-card-header">
                                            <div class="evolucao-info">
                                                <h6 class="evolucao-medico mb-1">Dr(a). ${ev.nome_medico || 'M√©dico n√£o informado'}</h6>
                                                <span class="evolucao-data text-muted">${dataFormatada}</span>
                                                <span class="badge bg-secondary ms-2">ANTERIOR</span>
                                            </div>
                                            <div class="evolucao-actions">
                                                <button class="btn btn-sm btn-outline-primary" onclick="imprimirEvolucao(${ev.id})" title="Imprimir Evolu√ß√£o">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="evolucao-card-body">
                                            <div class="evolucao-conteudo">
                                                ${ev.evolucao || '---'}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            $('#listaEvolucoesMedicasAntigas').html(htmlAntigas);
                            $('#contadorEvolucoesAntigas').text(evolucoesAntigas.length);
                        } else {
                            $('#listaEvolucoesMedicasAntigas').html('<div class="evolucao-vazia"><i class="fas fa-history"></i><p>Nenhuma evolu√ß√£o m√©dica anterior registrada.</p></div>');
                            $('#contadorEvolucoesAntigas').text('0');
                        }
                    } else {
                        $('#listaEvolucoesMedicasHoje').html('<div class="evolucao-vazia"><i class="fas fa-file-medical"></i><p>Nenhuma evolu√ß√£o m√©dica encontrada para esta interna√ß√£o.</p></div>');
                        $('#listaEvolucoesMedicasAntigas').html('<div class="evolucao-vazia"><i class="fas fa-file-medical"></i><p>Nenhuma evolu√ß√£o m√©dica encontrada.</p></div>');
                        $('#contadorEvolucoesHoje').text('0');
                        $('#contadorEvolucoesAntigas').text('0');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao carregar evolu√ß√µes:', xhr.responseText);
                    $('#listaEvolucoesMedicasHoje').html('<div class="evolucao-erro"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar evolu√ß√µes m√©dicas.</p></div>');
                    $('#listaEvolucoesMedicasAntigas').html('<div class="evolucao-erro"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar evolu√ß√µes m√©dicas.</p></div>');
                }
            });
        }

        // Fun√ß√£o para renderizar card de evolu√ß√£o
        function renderizarCardEvolucao(evolucao, ehHoje) {
            const dataFormatada = evolucao.data_evolucao ? 
                new Date(evolucao.data_evolucao).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }) : 'Data n√£o dispon√≠vel';
            
            const horaFormatada = evolucao.data_evolucao ? 
                new Date(evolucao.data_evolucao).toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '';
            
            const nomeMedico = evolucao.nome_medico || 'M√©dico n√£o informado';
            const textoEvolucao = evolucao.evolucao || 'Texto da evolu√ß√£o n√£o dispon√≠vel';
            
            const classeCard = ehHoje ? 'evolucao-card-hoje' : 'evolucao-card-antiga';
            const classeBadge = ehHoje ? 'hoje' : 'antiga';
            const textoBadge = ehHoje ? 'HOJE' : 'ANTERIOR';
            const iconeData = ehHoje ? 'fas fa-clock' : 'fas fa-calendar-alt';
            
            return `
                <div class="evolucao-card ${classeCard}">
                    <div class="evolucao-card-header">
                        <div class="evolucao-meta">
                            <div class="evolucao-medico">
                                <i class="fas fa-user-md me-2"></i>Dr(a). ${nomeMedico}
                            </div>
                            <div class="evolucao-data">
                                <i class="${iconeData} me-1"></i>
                                ${ehHoje ? horaFormatada : `${dataFormatada} ${horaFormatada}`}
                                <span class="evolucao-badge ${classeBadge}">${textoBadge}</span>
                            </div>
                        </div>
                    </div>
                    <div class="evolucao-card-body">
                        <div class="evolucao-texto">
                            ${textoEvolucao.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para atualizar tabela original (fallback)
        function atualizarTabelaEvolucoes(evolucoes) {
            const tabela = $('#listaEvolucoes');
            tabela.empty();
            
            if (evolucoes && evolucoes.length > 0) {
                evolucoes.forEach(ev => {
                    const evolucaoHtml = ev.evolucao || '---';
                    
                    tabela.append(`
                        <tr>
                            <td>${ev.data_evolucao || '---'}</td>
                            <td>${ev.nome_medico || '---'}</td>
                            <td>
                                <div class="texto-evolucao">
                                    ${evolucaoHtml}
                                </div>
                            </td>
                        </tr>
                    `);
                });
            } else {
                tabela.html('<tr><td colspan="3" class="text-center">Nenhuma evolu√ß√£o registrada at√© o momento.</td></tr>');
            }
        }

        // Implementa√ß√£o moderna de scroll para substituir a funcionalidade problem√°tica
        function setupModernScroll(container) {
            if (!container) return;
            
            // Elementos que podem precisar de scroll
            const scrollElements = container.querySelectorAll('.ql-editor');
            
            scrollElements.forEach(element => {
                // Assegurar que o elemento tem estilo de overflow adequado
                element.style.overflowY = 'auto';
                element.style.maxHeight = '100%';
                
                // Observar redimensionamento do conte√∫do
                const resizeObserver = new ResizeObserver(() => {
                    // Ajustar posi√ß√£o de scroll quando o conte√∫do mudar
                    const isAtBottom = element.scrollHeight - element.scrollTop === element.clientHeight;
                    if (isAtBottom) {
                        element.scrollTop = element.scrollHeight;
                    }
                });
                
                // Observar mudan√ßas no conte√∫do
                const mutationObserver = new MutationObserver(() => {
                    // Verificar se o scroll precisa ser ajustado
                    const shouldScrollToBottom = element.scrollHeight - element.scrollTop <= element.clientHeight + 50;
                    if (shouldScrollToBottom) {
                        element.scrollTop = element.scrollHeight;
                    }
                });
                
                // Iniciar observadores
                resizeObserver.observe(element);
                mutationObserver.observe(element, { 
                    childList: true, 
                    subtree: true, 
                    characterData: true 
                });
                
                // Armazenar observadores para limpeza futura
                element._scrollObservers = {
                    resize: resizeObserver,
                    mutation: mutationObserver
                };
            });
        }
        
        // Fun√ß√£o para verificar e corrigir o Quill ap√≥s carregar
        function checkQuillAndApplyFixes() {
            // Aguardar um momento para garantir que o Quill tenha carregado completamente
            setTimeout(() => {
                const editorContainer = document.getElementById('editor-container');
                if (editorContainer) {
                    setupModernScroll(editorContainer);
                    console.log('Scroll moderno aplicado ao editor Quill');
                }
            }, 500);
        }
        
        // Executar verifica√ß√£o ap√≥s a p√°gina carregar
        document.addEventListener('DOMContentLoaded', checkQuillAndApplyFixes);

        // Fun√ß√£o para limpar o formul√°rio de prescri√ß√£o
        function limparFormularioPrescricao() {
            $('#prescricao_id').val('');
            $('#nome_medicamento').val('');
            $('#descricao_uso').val('');
            $('#aprazamento').val('');
            $('#texto_dieta').val('');
            $('#texto_procedimento_medico').val('');
            $('#texto_procedimento_multi').val('');
            $('#avisoAlergia').hide();
            medicamentosAdicionados = [];
            atualizarTabelaMedicamentos();
            $('#modalPrescricaoLabel').text('Nova Prescri√ß√£o');
        }
        
        // Fun√ß√£o para editar prescri√ß√£o
        function editarPrescricao(prescricaoId) {
            // Limpar o formul√°rio primeiro
            limparFormularioPrescricao();
            
            // Buscar os dados da prescri√ß√£o espec√≠fica
            $.ajax({
                url: `/api/prescricoes/${internacaoId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.prescricoes) {
                        // Encontrar a prescri√ß√£o pelo ID
                        const prescricao = response.prescricoes.find(p => p.id == prescricaoId);
                        
                        if (prescricao) {
                            console.log("Editando prescri√ß√£o:", prescricao);
                            
                            // Preencher o formul√°rio com os dados da prescri√ß√£o
                            $('#prescricao_id').val(prescricao.id);
                            $('#texto_dieta').val(prescricao.texto_dieta || '');
                            $('#texto_procedimento_medico').val(prescricao.texto_procedimento_medico || '');
                            $('#texto_procedimento_multi').val(prescricao.texto_procedimento_multi || '');
                            
                            // Limpar a lista atual de medicamentos
                            medicamentosAdicionados = [];
                            
                            // Adicionar medicamentos da prescri√ß√£o na lista
                            if (prescricao.medicamentos && prescricao.medicamentos.length > 0) {
                                prescricao.medicamentos.forEach(med => {
                                    // Converter formato de data se necess√°rio
                                    let aprazamento = med.aprazamento;
                                    if (aprazamento && typeof aprazamento === 'string') {
                                        // Converter de DD/MM/YYYY HH:MM para YYYY-MM-DDTHH:MM
                                        const partes = aprazamento.split(' ');
                                        if (partes.length === 2) {
                                            const dataPartes = partes[0].split('/');
                                            if (dataPartes.length === 3) {
                                                aprazamento = `${dataPartes[2]}-${dataPartes[1]}-${dataPartes[0]}T${partes[1]}`;
                                            }
                                        }
                                    }
                                    
                                    medicamentosAdicionados.push({
                                        nome_medicamento: med.nome_medicamento,
                                        descricao_uso: med.descricao_uso,
                                        aprazamento: aprazamento
                                    });
                                });
                                
                                // Atualizar a tabela de medicamentos
                                atualizarTabelaMedicamentos();
                            }
                            
                            // Alterar o t√≠tulo do modal
                            $('#modalPrescricaoLabel').text('Editar Prescri√ß√£o');
                            
                            // Abrir o modal
                            $('#modalPrescricao').modal('show');
                        } else {
                            alert('Prescri√ß√£o n√£o encontrada.');
                        }
                    } else {
                        alert('Erro ao buscar prescri√ß√£o: ' + (response.error || 'Erro desconhecido'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao buscar prescri√ß√£o:', xhr.responseText);
                    alert('Erro ao buscar prescri√ß√£o: ' + error);
                }
            });
        }
        
        // Adicionar listeners para os bot√µes da tabela de prescri√ß√µes usando delega√ß√£o de eventos
        $(document).on('click', '.btn-editar-prescricao', function() {
            const prescricaoId = $(this).data('id');
            editarPrescricao(prescricaoId);
        });

        // Evento para o bot√£o de aprazamento
        $(document).on('click', '.btn-aprazamento', function() {
            const prescricaoId = $(this).data('prescricao-id');
            const medicamentoIndex = $(this).data('medicamento-index');
            const medicamentoNome = $(this).data('medicamento-nome');
            
            // Preencher os campos do modal de aprazamento
            $('#aprazamento_prescricao_id').val(prescricaoId);
            $('#aprazamento_medicamento_index').val(medicamentoIndex);
            $('#aprazamento_medicamento_nome').text(medicamentoNome);
            
            // Definir ID do enfermeiro para usar no formul√°rio
            $('#formAprazamento').data('enfermeiro-id', "{{ session.get('user_id', 0) }}");
            
            // Definir data atual para os campos de data
            const hoje = new Date();
            const anoAtual = hoje.getFullYear();
            const mesAtual = String(hoje.getMonth() + 1).padStart(2, '0');
            const diaAtual = String(hoje.getDate()).padStart(2, '0');
            
            // Data de fim padr√£o (7 dias ap√≥s a data atual)
            const dataFim = new Date(hoje);
            dataFim.setDate(dataFim.getDate() + 6);
            const anoFim = dataFim.getFullYear();
            const mesFim = String(dataFim.getMonth() + 1).padStart(2, '0');
            const diaFim = String(dataFim.getDate()).padStart(2, '0');
            
            // Definir datas de in√≠cio e fim para aprazamento
            $('#aprazamento_data_inicio').val(`${anoAtual}-${mesAtual}-${diaAtual}`);
            $('#aprazamento_data_fim').val(`${anoFim}-${mesFim}-${diaFim}`);
            
            // Definir a hora inicial padr√£o (hora atual)
            const horaAtual = String(hoje.getHours()).padStart(2, '0');
            const minutoAtual = String(Math.floor(hoje.getMinutes() / 5) * 5).padStart(2, '0'); // Arredondar para m√∫ltiplo de 5
            $('#aprazamento_hora_inicial_multiplos').val(`${horaAtual}:${minutoAtual}`);
            
            // Resetar o conte√∫do de hor√°rios calculados
            $('#horarios_multiplos_dias').html('<p class="text-muted small text-center mb-0">Clique em "Calcular Hor√°rios" para visualizar os hor√°rios</p>');
            
            // Esconder o campo de intervalo personalizado inicialmente
            $('#multiplos_intervalo_custom').hide();
            
            // Abrir o modal
            $('#modalAprazamento').modal('show');
        });

        $(document).on('click', '.btn-visualizar-aprazamento', function() {
            const prescricaoId = $(this).data('prescricao-id');
            const medicamentoIndex = $(this).data('medicamento-index');
            const medicamentoNome = $(this).data('medicamento-nome');

            console.log('Visualizar aprazamento para:', prescricaoId, medicamentoIndex, medicamentoNome);

            abrirCalendarioAprazamento(prescricaoId, medicamentoIndex, medicamentoNome);
});

        
        // Fun√ß√£o para calcular hor√°rios entre dois hor√°rios com um intervalo espec√≠fico
        function calcularHorariosEntreIntervalo(horaInicio, horaFim, intervaloHoras) {
            // Converter horas para minutos para facilitar o c√°lculo
            const [horaInicioH, horaInicioM] = horaInicio.split(':').map(Number);
            const [horaFimH, horaFimM] = horaFim.split(':').map(Number);
            
            const inicioMinutos = horaInicioH * 60 + horaInicioM;
            const fimMinutos = horaFimH * 60 + horaFimM;
            
            // Converter intervalo de horas para minutos
            const intervaloMinutos = Math.round(intervaloHoras * 60);
            
            const horarios = [];
            let minutoAtual = inicioMinutos;
            
            // Adicionar o hor√°rio inicial
            horarios.push(formatarHoraMinutos(minutoAtual));
            
            // Calcular hor√°rios subsequentes
            while (minutoAtual + intervaloMinutos <= fimMinutos) {
                minutoAtual += intervaloMinutos;
                horarios.push(formatarHoraMinutos(minutoAtual));
            }
            
            return horarios;
        }
        
        // Formatar minutos para formato de hora HH:MM
        function formatarHoraMinutos(minutos) {
            const horas = Math.floor(minutos / 60);
            const mins = minutos % 60;
            return `${String(horas).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }
        
        // Mostrar campo de intervalo personalizado quando "Personalizado" √© selecionado
        $('#aprazamento_intervalo').change(function() {
            if ($(this).val() === 'custom') {
                $('#intervalo_custom').show();
            } else {
                $('#intervalo_custom').hide();
            }
        });
        
        // Mostrar campo de intervalo personalizado para m√∫ltiplos dias
        $('#aprazamento_multiplos_intervalo').change(function() {
            if ($(this).val() === 'custom') {
                $('#multiplos_intervalo_custom').show();
            } else {
                $('#multiplos_intervalo_custom').hide();
            }
        });
        
        // Calcular hor√°rios com base nos par√¢metros para mesmo dia
        $('#btn_calcular_horarios').click(function() {
            const horaInicio = $('#aprazamento_hora_inicio').val();
            const horaFim = $('#aprazamento_hora_fim').val();
            
            if (!horaInicio || !horaFim) {
                alert('Por favor, defina a hora de in√≠cio e a hora de fim.');
                return;
            }
            
            // Verificar se hora de in√≠cio √© menor que hora de fim
            const [horaInicioH, horaInicioM] = horaInicio.split(':').map(Number);
            const [horaFimH, horaFimM] = horaFim.split(':').map(Number);
            
            const inicioMinutos = horaInicioH * 60 + horaInicioM;
            const fimMinutos = horaFimH * 60 + horaFimM;
            
            if (inicioMinutos >= fimMinutos) {
                alert('A hora de in√≠cio deve ser menor que a hora de fim.');
                return;
            }
            
            // Obter o intervalo
            let intervaloHoras;
            if ($('#aprazamento_intervalo').val() === 'custom') {
                intervaloHoras = parseFloat($('#aprazamento_intervalo_custom').val());
                if (!intervaloHoras || intervaloHoras <= 0 || intervaloHoras > 24) {
                    alert('Por favor, defina um intervalo v√°lido entre 0.5 e 24 horas.');
                    return;
                }
            } else {
                intervaloHoras = parseFloat($('#aprazamento_intervalo').val());
            }
            
            // Calcular hor√°rios entre in√≠cio e fim com o intervalo definido
            const horarios = calcularHorariosEntreIntervalo(horaInicio, horaFim, intervaloHoras);
            
            if (horarios.length === 0) {
                $('#horarios_calculados').html('<p class="text-danger">N√£o foi poss√≠vel calcular hor√°rios com os par√¢metros informados. Verifique se o intervalo n√£o √© muito grande para o per√≠odo definido.</p>');
                return;
            }
            
            // Exibir os hor√°rios calculados
            let html = '<div class="row">';
            horarios.forEach((horario, index) => {
                html += `<div class="col-md-4 mb-2">
                           <div class="form-check">
                             <input class="form-check-input horario-check" type="checkbox" value="${horario}" id="horario_${index}" checked>
                             <label class="form-check-label" for="horario_${index}">
                               ${horario}
                             </label>
                           </div>
                         </div>`;
            });
            html += '</div>';
            
            $('#horarios_calculados').html(html);
        });
        
        // Calcular hor√°rios para m√∫ltiplos dias
        $('#btn_calcular_multiplos_dias').click(function() {
            const dataInicio = $('#aprazamento_data_inicio').val();
            const dataFim = $('#aprazamento_data_fim').val();
            const horaInicial = $('#aprazamento_hora_inicial_multiplos').val();
            
            if (!dataInicio || !dataFim) {
                alert('Por favor, defina as datas de in√≠cio e fim.');
                return;
            }
            
            // Verificar se data de in√≠cio √© menor que data de fim
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            
            if (inicio > fim) {
                alert('A data de in√≠cio deve ser menor ou igual √† data de fim.');
                return;
            }
            
            // Obter o intervalo
            let intervaloHoras;
            if ($('#aprazamento_multiplos_intervalo').val() === 'custom') {
                intervaloHoras = parseFloat($('#aprazamento_multiplos_intervalo_custom').val());
                if (!intervaloHoras || intervaloHoras <= 0 || intervaloHoras > 24) {
                    alert('Por favor, defina um intervalo v√°lido entre 0.5 e 24 horas.');
                    return;
                }
            } else {
                intervaloHoras = parseFloat($('#aprazamento_multiplos_intervalo').val());
            }
            
            try {
                // Usar a nova fun√ß√£o importada do arquivo calculo_horarios.js
                // Passar a hora inicial se definida
                const horariosPorDia = calcularHorariosIntervaloFixo(dataInicio, dataFim, intervaloHoras, horaInicial);
                
                if (Object.keys(horariosPorDia).length === 0) {
                    $('#horarios_multiplos_dias').html('<p class="text-danger">N√£o foi poss√≠vel calcular hor√°rios com os par√¢metros informados. Verifique se o intervalo n√£o √© muito grande para o per√≠odo definido.</p>');
                    return;
                }
                
                // Formatar HTML com dias e hor√°rios
                const html = gerarHTMLHorariosPorDia(horariosPorDia);
                $('#horarios_multiplos_dias').html(html);
                
                // Adicionar manipuladores de eventos para selecionar/desmarcar todos
                $('#selecionar_todos').click(function() {
                    $('#horarios_multiplos_dias .horario-check').prop('checked', true);
                });
                
                $('#desmarcar_todos').click(function() {
                    $('#horarios_multiplos_dias .horario-check').prop('checked', false);
                });
            } catch (error) {
                console.error('Erro ao calcular hor√°rios:', error);
                $('#horarios_multiplos_dias').html(`<p class="text-danger">Erro ao calcular hor√°rios: ${error.message}</p>`);
            }
        });
        
        
        // Submiss√£o do formul√°rio de evolu√ß√£o
        $('#formEvolucao').on('submit', function(e) {
            e.preventDefault();
            
            let conteudo = '';
            
            // Capturar conte√∫do do editor Quill se estiver dispon√≠vel
            if (quill && quill.root) {
                conteudo = quill.root.innerHTML;
                // Salvar no textarea oculto tamb√©m
                $('#texto_evolucao').val(conteudo);
            } else if ($('#fallback-editor').length > 0) {
                conteudo = $('#fallback-editor').val().trim();
            } else {
                conteudo = $('#texto_evolucao').val().trim();
            }
            
            if (!conteudo) {
                alert('Por favor, preencha o texto da evolu√ß√£o.');
                return;
            }
            
            // Mostrar carregamento
            const btnSubmit = $(this).find('button[type="submit"]');
            const textoOriginal = btnSubmit.html();
            btnSubmit.html('<i class="fas fa-spinner fa-spin"></i> Enviando...');
            btnSubmit.prop('disabled', true);
            
            // Preparar dados para envio
            const dados = {
                internacao_id: internacaoId,
                funcionario_id: parseInt("{{ session.get('user_id', 0) }}", 10),
                evolucao: conteudo
            };
            
            // Enviar os dados para o servidor
            $.ajax({
                url: '/api/evolucoes/registrar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dados),
                success: function(response) {
                    // Restaurar bot√£o
                    btnSubmit.html(textoOriginal);
                    btnSubmit.prop('disabled', false);
                    
                    if (response.success) {
                        // Fechar modal e limpar campos
                        $('#modalEvolucao').modal('hide');
                        
                        // Limpar o editor Quill
                        if (quill) {
                            quill.setText('');
                        } else if ($('#fallback-editor').length > 0) {
                            $('#fallback-editor').val('');
                        }
                        
                        // Recarregar lista de evolu√ß√µes
                        carregarEvolucoes();
                        
                        // Mostrar mensagem de sucesso
                        alert('Evolu√ß√£o registrada com sucesso!');
                    } else {
                        alert('Erro ao registrar evolu√ß√£o: ' + (response.message || 'Erro desconhecido'));
                    }
                },
                error: function(xhr, status, error) {
                    // Restaurar bot√£o
                    btnSubmit.html(textoOriginal);
                    btnSubmit.prop('disabled', false);
                    
                    console.error('Erro ao registrar evolu√ß√£o:', xhr.responseText);
                    alert('Erro de comunica√ß√£o ao tentar registrar evolu√ß√£o: ' + (xhr.responseJSON?.error || error));
                }
            });
        });

        // Carregar dados ao iniciar - adicionando tratamento de erros e logs
        try {
            console.log("Carregando prescri√ß√µes...");
            carregarPrescricoes();
            console.log("Carregando evolu√ß√µes...");
            carregarEvolucoes();
            console.log("Carregando evolu√ß√µes de enfermagem...");
            // Garantir que estamos usando a fun√ß√£o do arquivo JS externo
            if (typeof carregarEvolucoesEnfermagem === 'function') {
                console.log("Chamando a fun√ß√£o carregarEvolucoesEnfermagem do m√≥dulo externo");
                carregarEvolucoesEnfermagem();
            } else {
                console.error("Fun√ß√£o carregarEvolucoesEnfermagem n√£o encontrada");
            }
        } catch (error) {
            console.error("Erro ao carregar dados iniciais:", error);
        }
        
        // Configurar um intervalo para tentar carregar prescri√ß√µes novamente ap√≥s alguns segundos
        setTimeout(function() {
            if ($("#listaPrescricoes").text().includes("Carregando prescri√ß√µes...") || 
                $("#listaPrescricoes").text().includes("Erro ao carregar prescri√ß√µes")) {
                console.log("Tentando carregar prescri√ß√µes novamente...");
                carregarPrescricoes(null, true);
            }
            
            // VERIFICAR SE AS EVOLU√á√ïES DE ENFERMAGEM N√ÉO CARREGARAM
            const tabelaHoje = $('#tabela-evolucoes-hoje');
            if (tabelaHoje.find('.spinner-border').length > 0 || 
                tabelaHoje.text().includes("Carregando evolu√ß√µes...") ||
                tabelaHoje.text().includes("Erro ao carregar")) {
                console.log("üîÑ Tentando carregar evolu√ß√µes de enfermagem novamente...");
                if (window.internacaoId) {
                    carregarEvolucoesEnfermagem();
                } else {
                    console.error("‚ùå internacaoId n√£o dispon√≠vel para recarregar evolu√ß√µes");
                }
            }
            
            if ($("#listaEvolucoesDoDia").text().includes("Carregando evolu√ß√µes...") || 
                $("#listaEvolucoesDoDia").text().includes("Erro ao carregar evolu√ß√µes")) {
                console.log("Tentando carregar evolu√ß√µes de enfermagem novamente...");
                if (typeof carregarEvolucoesEnfermagem === 'function') {
                    carregarEvolucoesEnfermagem();
                }
            }
        }, 3000);

        // Fun√ß√µes para gerenciar a admiss√£o de enfermagem
        $('#btn-editar-admissao').on('click', function() {
            // Esconder o texto e mostrar o formul√°rio
            $('#admissao-texto-container').hide();
            $('#admissao-form-container').show();
            
            // Focar no textarea
            $('#admissao_enfermagem').focus();
        });
        
        $('#btn-cancelar-admissao').on('click', function() {
            // Restaurar o texto original e esconder o formul√°rio (serializa√ß√£o segura)
            let admissaoTexto = '';
            try {
                admissaoTexto = JSON.parse(`{{ (internacao.admissao_enfermagem or "")|tojson }}`);
            } catch (e) { admissaoTexto = ''; }
            $('#admissao_enfermagem').val(admissaoTexto);
            $('#admissao-form-container').hide();
            $('#admissao-texto-container').show();
        });

        // Toggle evolucoes antigas (handler j√° configurado em enfermagem_completo.js)
        // Removido para evitar duplica√ß√£o

        // O m√≥dulo enfermagem_completo.js j√° configura o handler de submit e carrega as prescri√ß√µes
        // Apenas garantir que seja chamado ap√≥s a inicializa√ß√£o
        console.log('M√≥dulo enfermagem_completo.js carregar√° as prescri√ß√µes de enfermagem automaticamente');

        // Event handlers para evolu√ß√µes m√©dicas
        $('#btn-filtrar-evolucoes-medicas').click(function() {
            const filtro = $('#filtro-evolucoes-medicas');
            if (filtro.is(':visible')) {
                filtro.hide();
                $(this).html('<i class="fas fa-filter me-1"></i>Filtrar');
            } else {
                filtro.show();
                $(this).html('<i class="fas fa-filter me-1"></i>Ocultar Filtro');
            }
        });

        $('#btn-toggle-evolucoes-antigas-medicas').click(function() {
            const container = $('#evolucoes-antigas-container');
            if (container.is(':visible')) {
                container.hide();
                $(this).html('<i class="fas fa-eye me-1"></i>Ver Antigas');
            } else {
                container.show();
                $(this).html('<i class="fas fa-eye-slash me-1"></i>Ocultar Antigas');
            }
        });

        $('#btn-aplicar-filtro-evolucoes-medicas').click(function() {
            const dataFiltro = $('#filtro-data-evolucoes-medicas').val();
            if (!dataFiltro) {
                alert('Por favor, selecione uma data para filtrar.');
                return;
            }
            
            // Recarregar evolu√ß√µes com filtro
            filtrarEvolucoesPorData(dataFiltro);
        });

        $('#btn-limpar-filtro-evolucoes-medicas').click(function() {
            $('#filtro-data-evolucoes-medicas').val('');
            carregarEvolucoes(); // Recarregar todas as evolu√ß√µes
        });

        // Fun√ß√£o para filtrar evolu√ß√µes por data
        function filtrarEvolucoesPorData(dataFiltro) {
            console.log('Filtrando evolu√ß√µes por data:', dataFiltro);
            
            $.ajax({
                url: `/api/evolucoes/${internacaoId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.evolucoes && response.evolucoes.length > 0) {
                        // Filtrar evolu√ß√µes pela data selecionada
                        const evolucoesFiltradas = response.evolucoes.filter(ev => {
                            if (!ev.data_evolucao) return false;
                            const dataEvolucao = new Date(ev.data_evolucao).toISOString().split('T')[0];
                            return dataEvolucao === dataFiltro;
                        });
                        
                        if (evolucoesFiltradas.length > 0) {
                            let htmlFiltrado = '';
                            evolucoesFiltradas.forEach(ev => {
                                const hoje = new Date().toISOString().split('T')[0];
                                const dataEvolucao = new Date(ev.data_evolucao).toISOString().split('T')[0];
                                const ehHoje = dataEvolucao === hoje;
                                htmlFiltrado += renderizarCardEvolucao(ev, ehHoje);
                            });
                            
                            $('#listaEvolucoesMedicasHoje').html(htmlFiltrado);
                            $('#listaEvolucoesMedicasAntigas').html('');
                            $('#contador-evolucoes-hoje').text(evolucoesFiltradas.length);
                            $('#contador-evolucoes-antigas-medicas').text('0');
                        } else {
                            const dataFormatada = new Date(dataFiltro).toLocaleDateString('pt-BR');
                            $('#listaEvolucoesMedicasHoje').html(`
                                <div class="evolucao-vazia">
                                    <i class="fas fa-search"></i>
                                    <p>Nenhuma evolu√ß√£o encontrada para ${dataFormatada}.</p>
                                </div>
                            `);
                            $('#listaEvolucoesMedicasAntigas').html('');
                            $('#contador-evolucoes-hoje').text('0');
                            $('#contador-evolucoes-antigas-medicas').text('0');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao filtrar evolu√ß√µes:', error);
                    alert('Erro ao filtrar evolu√ß√µes. Tente novamente.');
                }
            });
        }
    });


    function abrirCalendarioAprazamento(prescricaoId, medicamentoIndex, medicamentoNome) {
        // Atualizar t√≠tulo do modal
        $('#modalVisualizarAprazamentoTitulo').text(`Hor√°rios do medicamento: ${medicamentoNome}`);
        
        // Abrir o modal
        $('#modalVisualizarAprazamento').modal('show');
        
        // Chamar a fun√ß√£o do m√≥dulo de calend√°rio
        visualizarCalendarioAprazamento(prescricaoId, medicamentoIndex, medicamentoNome);
    }


</script>

<!-- admissao_enfermagem.js j√° foi movido para o topo dos scripts -->

<!-- Modal para visualizar aprazamentos por medicamento -->
<div class="modal fade" id="modalAprazamentosMedicamento" tabindex="-1" aria-labelledby="modalAprazamentosMedicamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalAprazamentosMedicamentoLabel">Aprazamentos do Medicamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="aprazamentosMedicamentoContent">
                    <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando aprazamentos...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para visualizar aprazamentos de um medicamento espec√≠fico
function visualizarAprazamentosMedicamento(atendimentoId, nomeMedicamento) {
    // Atualizar t√≠tulo do modal
    $('#modalAprazamentosMedicamentoLabel').text(`Aprazamentos: ${nomeMedicamento}`);
    
    // Mostrar modal
    $('#modalAprazamentosMedicamento').modal('show');
    
    // Buscar aprazamentos
    $.ajax({
        url: `/api/aprazamentos/atendimento/${atendimentoId}/medicamento/${encodeURIComponent(nomeMedicamento)}`,
        method: 'GET',
        success: function(response) {
            if (response.success && response.aprazamentos) {
                // Agrupar aprazamentos por data
                const aprazamentosPorData = {};
                response.aprazamentos.forEach(apr => {
                    const data = apr.data_hora_aprazamento.split(' ')[0];
                    if (!aprazamentosPorData[data]) {
                        aprazamentosPorData[data] = [];
                    }
                    aprazamentosPorData[data].push(apr);
                });

                let html = '';
                
                // Para cada data
                Object.keys(aprazamentosPorData).sort().forEach(data => {
                    const dataFormatada = new Date(data).toLocaleDateString('pt-BR');
                    
                    html += `
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Data: ${dataFormatada}</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered mb-0">
                                        <thead class="table-primary">
                                            <tr>
                                                <th>Hor√°rio</th>
                                                <th>Status</th>
                                                <th>Enfermeiro</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;

                    // Ordenar hor√°rios do dia
                    aprazamentosPorData[data].sort((a, b) => 
                        new Date(a.data_hora_aprazamento) - new Date(b.data_hora_aprazamento)
                    ).forEach(apr => {
                        const hora = apr.data_hora_aprazamento.split(' ')[1];
                        let statusClass, statusIcon, statusText;
                        
                        if (apr.realizado) {
                            statusClass = 'text-success';
                            statusIcon = 'fa-check-circle';
                            statusText = 'Realizado';
                        } else if (apr.atrasado) {
                            statusClass = 'text-danger';
                            statusIcon = 'fa-exclamation-circle';
                            statusText = 'Atrasado';
                        } else {
                            statusClass = 'text-warning';
                            statusIcon = 'fa-clock';
                            statusText = 'Pendente';
                        }

                        html += `
                            <tr>
                                <td class="align-middle">${hora}</td>
                                <td class="align-middle ${statusClass}">
                                    <i class="fas ${statusIcon}"></i> ${statusText}
                                </td>
                                <td class="align-middle">
                                    ${apr.enfermeiro_responsavel || '-'}
                                    ${apr.data_realizacao ? `<br><small class="text-muted">em ${new Date(apr.data_realizacao).toLocaleString('pt-BR')}</small>` : ''}
                                </td>
                                <td class="align-middle">
                        `;

                        if (!apr.realizado) {
                            html += `
                                <button class="btn btn-sm btn-success btn-realizar-aprazamento" 
                                        data-id="${apr.id}">
                                    <i class="fas fa-check"></i> Realizar
                                </button>
                            `;
                        }

                        html += `
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Adicionar resumo estat√≠stico
                const totalAprazamentos = response.aprazamentos.length;
                const realizados = response.aprazamentos.filter(a => a.realizado).length;
                const atrasados = response.aprazamentos.filter(a => !a.realizado && a.atrasado).length;
                const pendentes = totalAprazamentos - realizados - atrasados;

                html += `
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Resumo dos Aprazamentos</h6>
                            <div class="row text-center">
                                <div class="col">
                                    <div class="p-3 border rounded bg-light">
                                        <div class="small text-muted">Total</div>
                                        <div class="h4 mb-0">${totalAprazamentos}</div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="p-3 border rounded bg-success bg-opacity-10">
                                        <div class="small text-success">Realizados</div>
                                        <div class="h4 mb-0">${realizados}</div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="p-3 border rounded bg-warning bg-opacity-10">
                                        <div class="small text-warning">Pendentes</div>
                                        <div class="h4 mb-0">${pendentes}</div>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="p-3 border rounded bg-danger bg-opacity-10">
                                        <div class="small text-danger">Atrasados</div>
                                        <div class="h4 mb-0">${atrasados}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                $('#aprazamentosMedicamentoContent').html(html);

                // Configurar handlers dos bot√µes
                $('.btn-realizar-aprazamento').click(function() {
                    const aprazamentoId = $(this).data('id');
                    
                    if (confirm('Confirma a realiza√ß√£o deste aprazamento?')) {
                        const btnOriginal = $(this);
                        const htmlOriginal = btnOriginal.html();
                        btnOriginal.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processando...');
                        
                        $.ajax({
                            url: `/api/aprazamentos/${aprazamentoId}/realizar`,
                            method: 'PUT',
                            success: function(response) {
                                if (response.success) {
                                    // Recarregar aprazamentos
                                    visualizarAprazamentosMedicamento(atendimentoId, nomeMedicamento);
                                    // Atualizar a visualiza√ß√£o da prescri√ß√£o
                                    carregarPrescricoes();
                                } else {
                                    alert('Erro ao realizar aprazamento: ' + response.message);
                                    btnOriginal.prop('disabled', false).html(htmlOriginal);
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Erro ao realizar aprazamento:', xhr.responseText);
                                alert('Erro ao realizar aprazamento. Por favor, tente novamente.');
                                btnOriginal.prop('disabled', false).html(htmlOriginal);
                            }
                        });
                    }
                });
            } else {
                $('#aprazamentosMedicamentoContent').html('<p class="text-muted text-center">Nenhum aprazamento encontrado.</p>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Erro ao buscar aprazamentos:', xhr.responseText);
            $('#aprazamentosMedicamentoContent').html('<p class="text-danger text-center">Erro ao carregar aprazamentos.</p>');
        }
    });
}

// Modificar a fun√ß√£o que renderiza as prescri√ß√µes para incluir o novo bot√£o
function renderizarMedicamentosPrescricao(medicamentos, prescricao) {
    let html = `
        <div class="mt-3 mb-2">
            <h6><i class="fas fa-pills text-danger mr-1"></i> Medicamentos</h6>
            <table class="table table-sm table-bordered table-striped">
                <thead class="thead-light">
                    <tr>
                        <th>Medicamento</th>
                        <th>Uso</th>
                        <th>Aprazamento</th>
                        <th>Enfermeiro</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
    `;

    medicamentos.forEach(function(medicamento) {
        html += `<tr>
            <td>${medicamento.nome_medicamento || ''}</td>
            <td>${medicamento.descricao_uso || ''}</td>
            <td>`;

        // Verificar se tem aprazamentos_novos
        if (medicamento.aprazamentos_novos && medicamento.aprazamentos_novos.length > 0) {
            html += `<div class="d-flex justify-content-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-info btn-visualizar-aprazamento" 
                    data-prescricao-id="${prescricao.id}" 
                    data-medicamento-index="${medicamentos.indexOf(medicamento)}" 
                    data-medicamento-nome="${medicamento.nome_medicamento.replace(/"/g, '&quot;')}">
                    <i class="fas fa-calendar-alt"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary btn-ver-aprazamentos"
                    data-atendimento-id="${prescricao.atendimentos_clinica_id}"
                    data-medicamento-nome="${medicamento.nome_medicamento.replace(/"/g, '&quot;')}">
                    <i class="fas fa-list"></i>
                </button>
            </div>`;
        } else {
            html += '<span class="text-muted">N√£o aprazado</span>';
        }

        html += `</td>
            <td>${medicamento.enfermeiro_nome || ''}</td>
            <td>`;

        if (((window.CARGO_SESSAO || '') + '').toLowerCase().trim() === "enfermeiro") {
            html += `<button class="btn btn-primary btn-sm btn-aprazamento" 
                data-prescricao-id="${prescricao.id}" 
                data-medicamento-index="${medicamentos.indexOf(medicamento)}" 
                data-medicamento-nome="${medicamento.nome_medicamento.replace(/"/g, '&quot;')}">
                <i class="fas fa-clock"></i> Aprazar
            </button>`;
        }

        html += '</td></tr>';
    });

    html += '</tbody></table></div>';
    return html;
}

// Adicionar handler para o novo bot√£o
$(document).on('click', '.btn-ver-aprazamentos', function() {
    const atendimentoId = $(this).data('atendimento-id');
    const medicamentoNome = $(this).data('medicamento-nome');
    visualizarAprazamentosMedicamento(atendimentoId, medicamentoNome);
});

// Obter o ID do atendimento da URL
const urlParts = window.location.pathname.split('/');
const atendimentoId = urlParts[urlParts.length - 1];

// Modificar a fun√ß√£o que lida com o clique no bot√£o
$(document).on('click', '.btn-ver-aprazamentos', function() {
    const medicamentoNome = $(this).data('medicamento-nome');
    console.log('[Debug] Clique no bot√£o ver-aprazamentos:', {
        atendimentoId: window.ATENDIMENTO_ID,
        medicamentoNome: medicamentoNome
    });
    
    if (!window.ATENDIMENTO_ID) {
        console.error('[Debug] Erro: ID do atendimento n√£o encontrado');
        alert('Erro: ID do atendimento n√£o encontrado. Por favor, recarregue a p√°gina.');
        return;
    }
    
    visualizarAprazamentosMedicamento(window.ATENDIMENTO_ID, medicamentoNome);
});

    // Fun√ß√£o para carregar hist√≥rico de SAE
    function carregarHistoricoSAE() {
        const pacienteId = parseInt("{{ paciente.id }}", 10);
        
        $.ajax({
            url: `/api/enfermagem/sae/historico/${pacienteId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.sae && response.sae.length > 0) {
                    let htmlHistorico = '';
                    
                    response.sae.forEach(sae => {
                        const dataFormatada = new Date(sae.data_registro).toLocaleDateString('pt-BR');
                        
                        htmlHistorico += `
                            <div class="card mb-3 border-secondary">
                                <div class="card-header bg-secondary text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div><strong>Registro de:</strong> ${dataFormatada}</div>
                                        <div><span class="badge bg-light text-dark">Hist√≥rico</span></div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <h6 class="text-primary mb-2">Sinais Vitais</h6>
                                            <div class="row g-2">
                                                <div class="col-md-2"><strong>PA:</strong> ${sae.pa}</div>
                                                <div class="col-md-2"><strong>FC:</strong> ${sae.fc}</div>
                                                <div class="col-md-2"><strong>SAT:</strong> ${sae.sat}</div>
                                                <div class="col-md-2"><strong>R:</strong> ${sae.r}</div>
                                                <div class="col-md-2"><strong>T:</strong> ${sae.t}</div>
                                                <div class="col-md-2"><strong>Pulso:</strong> ${sae.pulso}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-2">Hip√≥tese Diagn√≥stica</h6>
                                            <div class="p-2 bg-light rounded">${sae.hipotese_diagnostica}</div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary mb-2">DX</h6>
                                            <div class="p-2 bg-light rounded">${sae.dx}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <h6 class="text-primary mb-2">Diagn√≥stico de Enfermagem</h6>
                                            <div class="p-2 bg-light rounded">${sae.diagnostico_de_enfermagem}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    $('#listaHistoricoSAE').html(htmlHistorico);
                } else {
                    $('#listaHistoricoSAE').html('<div class="alert alert-info">Nenhum hist√≥rico de SAE encontrado.</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao carregar hist√≥rico SAE:', xhr.responseText);
                $('#listaHistoricoSAE').html('<div class="alert alert-danger">Erro ao carregar hist√≥rico de SAE.</div>');
            }
        });
    }

    // Fun√ß√£o de impress√£o usando ID da prescri√ß√£o
    window.imprimirPrescricao = function(prescricaoId) {
        if (!prescricaoId) {
            alert('ID da prescri√ß√£o n√£o informado.');
            return;
        }
        
        // Abrir p√°gina de impress√£o em nova aba
        const url = `/api/imprimir-prescricao-html/${prescricaoId}`;
        const novaJanela = window.open(url, '_blank');
        
        if (!novaJanela) {
            alert('Popup bloqueado. Por favor, permita popups para este site e tente novamente.');
            return;
        }
        
        // Aguardar carregamento e tentar imprimir automaticamente
        novaJanela.onload = function() {
            setTimeout(function() {
                try {
                    novaJanela.print();
                } catch (error) {
                    console.warn('N√£o foi poss√≠vel imprimir automaticamente:', error);
                }
            }, 1000); // Aguarda 1 segundo para garantir que a p√°gina carregou completamente
        };
    };

    // Fun√ß√£o para visualizar aprazamentos
    window.visualizarAprazamentos = function(medicamento) {
        alert(`Funcionalidade de visualiza√ß√£o de aprazamentos para "${medicamento}" em desenvolvimento.`);
    };

    // Fun√ß√£o para carregar SAE espec√≠fica para enfermeiros
    function carregarSAEEnfermagem() {
        const pacienteId = parseInt("{{ paciente.id }}", 10);
        $.ajax({
            url: `/api/enfermagem/sae/${pacienteId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.sae) {
                    const sae = response.sae;
                    
                    // Montar a visualiza√ß√£o da SAE
                    let html = `
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div><strong>Data do Registro:</strong> ${new Date(sae.data_registro).toLocaleDateString('pt-BR')}</div>
                                    <div><span class="badge ${sae.eh_hoje ? 'bg-success' : 'bg-secondary'}">
                                        ${sae.eh_hoje ? 'Hoje' : 'Registro Anterior'}
                                    </span></div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-primary mb-2">Sinais Vitais</h6>
                                        <div class="row g-2">
                                            <div class="col-md-2"><strong>PA:</strong> ${sae.pa}</div>
                                            <div class="col-md-2"><strong>FC:</strong> ${sae.fc}</div>
                                            <div class="col-md-2"><strong>SAT:</strong> ${sae.sat}</div>
                                            <div class="col-md-2"><strong>R:</strong> ${sae.r}</div>
                                            <div class="col-md-2"><strong>T:</strong> ${sae.t}</div>
                                            <div class="col-md-2"><strong>Pulso:</strong> ${sae.pulso}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">Hip√≥tese Diagn√≥stica</h6>
                                        <div class="p-2 bg-light rounded">${sae.hipotese_diagnostica}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">DX</h6>
                                        <div class="p-2 bg-light rounded">${sae.dx}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-primary mb-2">Medica√ß√£o</h6>
                                        <div class="p-2 bg-light rounded">${sae.medicacao}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">Alergias</h6>
                                        <div class="p-2 bg-light rounded">${sae.alergias}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">Antecedentes Pessoais</h6>
                                        <div class="p-2 bg-light rounded">${sae.antecedentes_pessoais}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-primary mb-2">Diagn√≥stico de Enfermagem</h6>
                                        <div class="p-2 bg-light rounded">${sae.diagnostico_de_enfermagem}</div>
                                    </div>
                                </div>
                                
                                <div class="accordion" id="accordionSAE">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetalhes">
                                                Ver mais detalhes da SAE
                                            </button>
                                        </h2>
                                        <div id="collapseDetalhes" class="accordion-collapse collapse">
                                            <div class="accordion-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Sistema Neurol√≥gico</h6>
                                                        <div class="p-2 bg-light rounded">${sae.sistema_neurologico}</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Estado Geral</h6>
                                                        <div class="p-2 bg-light rounded">${sae.estado_geral}</div>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Ventila√ß√£o</h6>
                                                        <div class="p-2 bg-light rounded">${sae.ventilacao}</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Pele</h6>
                                                        <div class="p-2 bg-light rounded">${sae.pele}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('#listaSAE').html(html);
                } else {
                    $('#listaSAE').html('<div class="alert alert-info">Nenhum registro SAE encontrado para este paciente.</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao carregar SAE:', xhr.responseText);
                
                // Se o erro for de permiss√£o (403), tentar buscar pelo hist√≥rico SAE
                if (xhr.status === 403) {
                    // Mostrar mensagem informativa
                    $('#listaSAE').html('<div class="alert alert-info">Acessando hist√≥rico de SAE...</div>');
                    
                    // Chamar diretamente a API de hist√≥rico SAE
                    const pacienteId = parseInt("{{ paciente.id }}", 10);
                    $.ajax({
                        url: `/api/enfermagem/sae/historico/${pacienteId}`,
                        method: 'GET',
                        success: function(response) {
                            if (response.success && response.sae && response.sae.length > 0) {
                                // Mostrar o primeiro registro como principal
                                const maisRecente = response.sae.sort((a, b) => new Date(b.data_registro) - new Date(a.data_registro))[0];
                                let htmlPrincipal = `
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div><strong>Data do Registro:</strong> ${new Date(maisRecente.data_registro).toLocaleDateString('pt-BR')}</div>
                                                <div><span class="badge bg-secondary">Via Hist√≥rico SAE</span></div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <h6 class="text-primary mb-2">Sinais Vitais</h6>
                                                    <div class="row g-2">
                                                        <div class="col-md-2"><strong>PA:</strong> ${maisRecente.pa}</div>
                                                        <div class="col-md-2"><strong>FC:</strong> ${maisRecente.fc}</div>
                                                        <div class="col-md-2"><strong>SAT:</strong> ${maisRecente.sat}</div>
                                                        <div class="col-md-2"><strong>R:</strong> ${maisRecente.r}</div>
                                                        <div class="col-md-2"><strong>T:</strong> ${maisRecente.t}</div>
                                                        <div class="col-md-2"><strong>Pulso:</strong> ${maisRecente.pulso}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">Hip√≥tese Diagn√≥stica</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.hipotese_diagnostica}</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">DX</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.dx}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <h6 class="text-primary mb-2">Medica√ß√£o</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.medicacao}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">Alergias</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.alergias}</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">Antecedentes Pessoais</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.antecedentes_pessoais}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <h6 class="text-primary mb-2">Diagn√≥stico de Enfermagem</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.diagnostico_de_enfermagem}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                $('#listaSAE').html(htmlPrincipal);
                                
                                // Ativar bot√£o de hist√≥rico e carreg√°-lo automaticamente
                                $('#btn-historico-sae').html('<i class="fas fa-times"></i> Ocultar Hist√≥rico');
                                
                                // Carregar resto do hist√≥rico normalmente
                                carregarHistoricoSAE();
                            } else {
                                $('#listaSAE').html('<div class="alert alert-info">Nenhum registro SAE encontrado para este paciente.</div>');
                            }
                        },
                        error: function() {
                            $('#listaSAE').html('<div class="alert alert-info">N√£o foi poss√≠vel acessar os dados de SAE.</div>');
                        }
                    });
                } else {
                    // Mostrar mensagem gen√©rica para outros erros
                    $('#listaSAE').html('<div class="alert alert-info">Nenhum registro SAE dispon√≠vel para este paciente.</div>');
                }
            }
        });
    }

    // Fun√ß√£o para carregar hist√≥rico de SAE
    function carregarHistoricoSAE() {
        const pacienteId = parseInt("{{ paciente.id }}", 10);
        $('#listaHistoricoSAE').html('<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando hist√≥rico completo...</p>');
        
        $.ajax({
            url: `/api/enfermagem/sae/historico/${pacienteId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.sae && response.sae.length > 0) {
                    let html = '';
                    
                    // Ordenar por data (mais recente primeiro)
                    const saeOrdenado = response.sae.sort((a, b) => {
                        return new Date(b.data_registro) - new Date(a.data_registro);
                    });
                    
                    // Processar cada registro SAE
                    saeOrdenado.forEach((sae, index) => {
                        const dataRegistro = new Date(sae.data_registro);
                        html += `
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div><strong>Data do Registro:</strong> ${dataRegistro.toLocaleDateString('pt-BR')}</div>
                                        <div>
                                            <span class="badge bg-secondary">Registro Anterior</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="accordion" id="accordionSAE${index}">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSAE${index}">
                                                    Ver detalhes deste registro SAE
                                                </button>
                                            </h2>
                                            <div id="collapseSAE${index}" class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <div class="row mb-3">
                                                        <div class="col-md-12">
                                                            <h6 class="text-primary mb-2">Sinais Vitais</h6>
                                                            <div class="row g-2">
                                                                <div class="col-md-2"><strong>PA:</strong> ${sae.pa}</div>
                                                                <div class="col-md-2"><strong>FC:</strong> ${sae.fc}</div>
                                                                <div class="col-md-2"><strong>SAT:</strong> ${sae.sat}</div>
                                                                <div class="col-md-2"><strong>R:</strong> ${sae.r}</div>
                                                                <div class="col-md-2"><strong>T:</strong> ${sae.t}</div>
                                                                <div class="col-md-2"><strong>Pulso:</strong> ${sae.pulso}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">Hip√≥tese Diagn√≥stica</h6>
                                                            <div class="p-2 bg-light rounded">${sae.hipotese_diagnostica}</div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">DX</h6>
                                                            <div class="p-2 bg-light rounded">${sae.dx}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-md-12">
                                                            <h6 class="text-primary mb-2">Medica√ß√£o</h6>
                                                            <div class="p-2 bg-light rounded">${sae.medicacao}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">Alergias</h6>
                                                            <div class="p-2 bg-light rounded">${sae.alergias}</div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">Antecedentes Pessoais</h6>
                                                            <div class="p-2 bg-light rounded">${sae.antecedentes_pessoais}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-md-12">
                                                            <h6 class="text-primary mb-2">Diagn√≥stico de Enfermagem</h6>
                                                            <div class="p-2 bg-light rounded">${sae.diagnostico_de_enfermagem}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">Sistema Neurol√≥gico</h6>
                                                            <div class="p-2 bg-light rounded">${sae.sistema_neurologico}</div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">Estado Geral</h6>
                                                            <div class="p-2 bg-light rounded">${sae.estado_geral}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">Ventila√ß√£o</h6>
                                                            <div class="p-2 bg-light rounded">${sae.ventilacao}</div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="text-primary mb-2">Pele</h6>
                                                            <div class="p-2 bg-light rounded">${sae.pele}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (html === '') {
                        $('#listaHistoricoSAE').html('<div class="alert alert-info">N√£o h√° registros SAE adicionais para este paciente.</div>');
                    } else {
                        $('#listaHistoricoSAE').html(html);
                    }
                } else {
                    $('#listaHistoricoSAE').html('<div class="alert alert-info">Nenhum registro SAE anterior encontrado para este paciente.</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao carregar hist√≥rico SAE:', xhr.responseText);
                $('#listaHistoricoSAE').html('<div class="alert alert-danger">Erro ao carregar hist√≥rico SAE.</div>');
            }
        });
    }

    // Substituir o carregamento da SAE
    carregarSAEEnfermagem();

    // Configurar bot√£o para mostrar hist√≥rico SAE
    $('#btn-historico-sae').on('click', function() {
        const historicoContainer = $('#historicoSAE');
        if (historicoContainer.is(':visible')) {
            historicoContainer.hide();
            $(this).html('<i class="fas fa-history"></i> Ver Hist√≥rico');
        } else {
            carregarHistoricoSAE();
            historicoContainer.show();
            $(this).html('<i class="fas fa-times"></i> Ocultar Hist√≥rico');
        }
    });

    // === FUN√á√ïES PARA CARREGAR DADOS DAS ABAS DE EVOLU√á√ÉO M√âDICA ===
    
    // Vari√°veis globais para cache de dados das abas m√©dicas
    let dadosDiagnosticoCache = null;
    let dadosAnamneseCondutaCache = null;
    let dadosJustificativasCache = null;

    // Fun√ß√£o para carregar dados de diagn√≥stico
    function carregarDadosDiagnostico() {
        const atendimentoId = window.ATENDIMENTO_ID || internacaoId;
        console.log('Carregando diagn√≥stico para atendimento:', atendimentoId);
        
        
        if (!atendimentoId) {
            console.error('ID do atendimento n√£o encontrado');
            return;
        }

        $('#diagnostico-loading').show();
        
        $.ajax({
            url: `/api/internacao/${atendimentoId}`,
            method: 'GET',
            timeout: 10000,
            success: function(response) {
                console.log('Dados da interna√ß√£o recebidos:', response);
                
                if (response.success && response.internacao) {
                    dadosDiagnosticoCache = response.internacao;
                    atualizarVisualizacaoDiagnostico(response.internacao);
                } else {
                    // Se n√£o tem success, mas tem dados diretos
                    dadosDiagnosticoCache = response;
                    atualizarVisualizacaoDiagnostico(response);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao carregar diagn√≥stico:', error);
                console.error('Status:', status);
                
                // Mostrar erro nos campos de visualiza√ß√£o
                const errorMsg = '<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Erro ao carregar dados</div>';
                $('#diagnostico-inicial-display').html(errorMsg);
                $('#cid-principal-display').html(errorMsg);
                $('#diagnostico-atual-display').html(errorMsg);
                $('#cid-secundario-display').html(errorMsg);
                $('#causas-associadas-display').html(errorMsg);
            },
            complete: function() {
                $('#diagnostico-loading').hide();
            }
        });
    }

    // Fun√ß√£o para atualizar visualiza√ß√£o de diagn√≥stico
    function atualizarVisualizacaoDiagnostico(dados) {
        console.log('Atualizando visualiza√ß√£o de diagn√≥stico com dados:', dados);
        
        // Atualizar campos de visualiza√ß√£o com verifica√ß√£o de conte√∫do
        $('#diagnostico-inicial-display').html(
            dados.diagnostico_inicial ? 
            `<div class="text-dark">${dados.diagnostico_inicial.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#cid-principal-display').html(
            dados.cid_principal ? 
            `<div class="text-dark fw-bold">${dados.cid_principal}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#diagnostico-atual-display').html(
            dados.diagnostico ? 
            `<div class="text-dark">${dados.diagnostico.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#cid-secundario-display').html(
            dados.cid_10_secundario ? 
            `<div class="text-dark">${dados.cid_10_secundario.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>Nenhum CID secund√°rio registrado</div>'
        );
        
        $('#causas-associadas-display').html(
            dados.cid_10_causas_associadas ? 
            `<div class="text-dark">${dados.cid_10_causas_associadas.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>Nenhuma causa associada registrada</div>'
        );
    }

    // Fun√ß√£o para carregar dados de anamnese e conduta
    function carregarDadosAnamneseConduta() {
        const atendimentoId = window.ATENDIMENTO_ID || internacaoId;
        if (!atendimentoId) return;

        $('#anamnese-conduta-loading').show();
        
        fetch(`/api/internacao/${atendimentoId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Dados de anamnese e conduta recebidos:', data);
                if (data.success && data.internacao) {
                    dadosAnamneseCondutaCache = data.internacao;
                    atualizarVisualizacaoAnamneseConduta(data.internacao);
                } else {
                    // Se n√£o tem success, mas tem dados diretos
                    dadosAnamneseCondutaCache = data;
                    atualizarVisualizacaoAnamneseConduta(data);
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ß√£o de anamnese e conduta:', error);
                // Mostrar erro nos campos
                const errorMsg = '<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Erro ao carregar dados</div>';
                $('#anamnese-exame-fisico-display').html(errorMsg);
                $('#conduta-medica-display').html(errorMsg);
            })
            .finally(() => {
                $('#anamnese-conduta-loading').hide();
            });
    }

    // Fun√ß√£o para atualizar visualiza√ß√£o de anamnese e conduta
    function atualizarVisualizacaoAnamneseConduta(dados) {
        console.log('Atualizando visualiza√ß√£o de anamnese e conduta:', dados);
        
        $('#anamnese-exame-fisico-display').html(
            dados.anamnese_exame_fisico ? 
            `<div class="text-dark">${dados.anamnese_exame_fisico.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#conduta-medica-display').html(
            dados.conduta ? 
            `<div class="text-dark">${dados.conduta.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
    }

    // Fun√ß√£o para carregar dados de justificativas
    function carregarDadosJustificativas() {
        const atendimentoId = window.ATENDIMENTO_ID || internacaoId;
        if (!atendimentoId) return;

        $('#justificativas-loading').show();
        
        fetch(`/api/internacao/${atendimentoId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Dados de justificativas recebidos:', data);
                if (data.success && data.internacao) {
                    dadosJustificativasCache = data.internacao;
                    atualizarVisualizacaoJustificativas(data.internacao);
                } else {
                    // Se n√£o tem success, mas tem dados diretos
                    dadosJustificativasCache = data;
                    atualizarVisualizacaoJustificativas(data);
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ß√£o de justificativas:', error);
                // Mostrar erro nos campos
                const errorMsg = '<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Erro ao carregar dados</div>';
                $('#sinais-sintomas-display').html(errorMsg);
                $('#condicoes-display').html(errorMsg);
                $('#resultados-diagnosticos-display').html(errorMsg);
            })
            .finally(() => {
                $('#justificativas-loading').hide();
            });
    }

    // Fun√ß√£o para atualizar visualiza√ß√£o de justificativas
    function atualizarVisualizacaoJustificativas(dados) {
        console.log('Atualizando visualiza√ß√£o de justificativas:', dados);
        
        $('#sinais-sintomas-display').html(
            dados.justificativa_internacao_sinais_e_sintomas ? 
            `<div class="text-dark">${dados.justificativa_internacao_sinais_e_sintomas.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#condicoes-display').html(
            dados.justificativa_internacao_condicoes ? 
            `<div class="text-dark">${dados.justificativa_internacao_condicoes.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#resultados-diagnosticos-display').html(
            dados.justificativa_internacao_principais_resultados_diagnostico ? 
            `<div class="text-dark">${dados.justificativa_internacao_principais_resultados_diagnostico.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
    }

    // Event handlers para carregar dados quando as abas forem clicadas
    $(document).on('click', '#evolucaoTabs .nav-link', function(e) {
        const targetId = $(this).attr('data-bs-target');
        
        // Carregar dados espec√≠ficos conforme a aba clicada
        if (targetId === '#diagnostico-pane') {
            console.log('Aba de diagn√≥stico clicada - carregando dados...');
            if (!dadosDiagnosticoCache) {
                carregarDadosDiagnostico();
            }
        } else if (targetId === '#anamnese-pane') {
            console.log('Aba de anamnese clicada - carregando dados...');
            if (!dadosAnamneseCondutaCache) {
                carregarDadosAnamneseConduta();
            }
        } else if (targetId === '#justificativas-pane') {
            console.log('Aba de justificativas clicada - carregando dados...');
            if (!dadosJustificativasCache) {
                carregarDadosJustificativas();
            }
        }
    });

    // Carregar dados automaticamente se alguma aba estiver ativa por padr√£o
    setTimeout(function() {
        if ($('#diagnostico-tab').hasClass('active')) {
            carregarDadosDiagnostico();
        }
        if ($('#anamnese-tab').hasClass('active')) {
            carregarDadosAnamneseConduta();
        }
        if ($('#justificativas-tab').hasClass('active')) {
            carregarDadosJustificativas();
        }
    }, 1000);

    // === FIM DAS FUN√á√ïES DE EVOLU√á√ÉO M√âDICA ===

    // === FUN√á√ÉO PARA IMPRIMIR EVOLU√á√ÉO ===
    
    // Fun√ß√£o para imprimir evolu√ß√£o m√©dica
    function imprimirEvolucao(evolucaoId) {
        if (!evolucaoId) {
            alert('ID da evolu√ß√£o n√£o informado.');
            return;
        }
        
        // Abrir p√°gina de impress√£o em nova aba
        const url = `/api/imprimir-evolucao-html/${evolucaoId}`;
        const novaJanela = window.open(url, '_blank');
        
        if (!novaJanela) {
            alert('Popup bloqueado. Por favor, permita popups para este site e tente novamente.');
            return;
        }
        
        // Aguardar carregamento e tentar imprimir automaticamente
        novaJanela.onload = function() {
            setTimeout(function() {
                try {
                    novaJanela.print();
                } catch (error) {
                    console.warn('N√£o foi poss√≠vel imprimir automaticamente:', error);
                }
            }, 1000); // Aguarda 1 segundo para garantir que a p√°gina carregou completamente
        };
    }

    // === RECEITU√ÅRIOS E ATESTADOS - SOMENTE LEITURA ===
    function carregarReceituariosSomenteLeitura() {
        const atendimentoId = window.ATENDIMENTO_ID || internacaoId;
        if (!atendimentoId) return;
        const tbody = document.getElementById('tabelaReceituarios');
        if (!tbody) return;
        // Evitar recarga se j√° carregado
        if (tbody.dataset.loaded === '1') return;
        $.ajax({
            url: `/api/receituarios/${atendimentoId}`,
            method: 'GET',
            success: function(resp) {
                if (!resp.success || !Array.isArray(resp.receituarios)) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">Nenhum receitu√°rio encontrado.</td></tr>`;
                    return;
                }
                if (resp.receituarios.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">Nenhum receitu√°rio encontrado.</td></tr>`;
                    return;
                }
                // Mais recentes primeiro por data_receita
                const items = resp.receituarios.slice().sort((a,b) => new Date(b.data_receita) - new Date(a.data_receita));
                let html = '';
                items.forEach(r => {
                    const data = r.data_receita ? new Date(r.data_receita).toLocaleString('pt-BR') : '-';
                    const tipo = (r.tipo_receita || '').toUpperCase();
                    const preview = (r.conteudo_receita || '').replace(/<[^>]*>/g,'').slice(0,140) + (r.conteudo_receita && r.conteudo_receita.length>140 ? '...' : '');
                    html += `
                        <tr>
                            <td class="align-middle">${data}</td>
                            <td class="align-middle"><span class="badge bg-info-subtle text-info border">${tipo || '‚Äî'}</span></td>
                            <td class="align-middle text-truncate" style="max-width: 520px;">${preview || '‚Äî'}</td>
                            <td class="align-middle text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="window.open('/clinica/receituario/${r.id}/imprimir_html', '_blank')">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        </tr>`;
                });
                tbody.innerHTML = html;
                tbody.dataset.loaded = '1';
            },
            error: function() {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-3">Erro ao carregar receitu√°rios.</td></tr>`;
            }
        });
    }

    function carregarAtestadosSomenteLeitura() {
        const atendimentoId = window.ATENDIMENTO_ID || internacaoId;
        if (!atendimentoId) return;
        const tbody = document.getElementById('tabelaAtestados');
        if (!tbody) return;
        if (tbody.dataset.loaded === '1') return;
        $.ajax({
            url: `/api/atestados/${atendimentoId}`,
            method: 'GET',
            success: function(resp) {
                if (!resp.success || !Array.isArray(resp.atestados)) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-3">Nenhum atestado encontrado.</td></tr>`;
                    return;
                }
                if (resp.atestados.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-3">Nenhum atestado encontrado.</td></tr>`;
                    return;
                }
                const items = resp.atestados.slice().sort((a,b) => new Date(b.data_atestado) - new Date(a.data_atestado));
                let html = '';
                items.forEach(a => {
                    const data = a.data_atestado ? new Date(a.data_atestado).toLocaleString('pt-BR') : '-';
                    const preview = (a.conteudo_atestado || '').replace(/<[^>]*>/g,'').slice(0,160) + (a.conteudo_atestado && a.conteudo_atestado.length>160 ? '...' : '');
                    html += `
                        <tr>
                            <td class="align-middle">${data}</td>
                            <td class="align-middle text-truncate" style="max-width: 560px;">${preview || '‚Äî'}</td>
                            <td class="align-middle text-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="window.open('/clinica/atestado/${a.id}/imprimir', '_blank')">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        </tr>`;
                });
                tbody.innerHTML = html;
                tbody.dataset.loaded = '1';
            },
            error: function() {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center text-danger py-3">Erro ao carregar atestados.</td></tr>`;
            }
        });
    }
</script>

<!-- Modal para visualizar aprazamentos -->
<div class="modal fade modal-visualizar-aprazamento" id="modalVisualizarAprazamento" tabindex="-1" aria-labelledby="modalVisualizarAprazamentoTitulo" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalVisualizarAprazamentoTitulo">Hor√°rios de Aprazamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="modalVisualizarAprazamentoBody">
                <p class="text-center">Aguardando dados...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="exportarCalendarioComoImagem()">
                    <i class="fas fa-download"></i> Exportar
                </button>            </div>
        </div>
    </div>
</div>
</div>
</body>
</html>
