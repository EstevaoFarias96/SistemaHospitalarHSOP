<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Recepcionista</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='Imagens/favicon hsop.svgz') }}">

  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />

  <style>
    :root {
      --azul-principal: #4A90E2;
      --azul-claro: #E8F4FF;
      --azul-medio: #7AB8F5;
      --branco-gelo: #F8FCFF;
      --cinza-texto: #4A5568;
      --cinza-claro: #E2E8F0;
      --sombra-suave: 0 2px 12px rgba(74, 144, 226, 0.08);
      --sombra-media: 0 4px 20px rgba(74, 144, 226, 0.12);
    }
    
    body {
      background: linear-gradient(135deg, var(--branco-gelo) 0%, var(--azul-claro) 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 80px;
      height: 100vh;
      background: linear-gradient(180deg, #4A90E2 0%, #357ABD 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      position: relative;
      box-shadow: 4px 0 20px rgba(74, 144, 226, 0.15);
      transition: width 0.3s ease;
    }
    
    .sidebar ul {
      list-style: none;
      padding: 0;
      width: 100%;
    }
    
    .sidebar li {
      position: relative;
      width: 100%;
      margin: 8px 0;
    }
    
    .sidebar a {
      color: #fff;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      width: 100%;
      font-size: 20px;
      white-space: nowrap;
      position: relative;
      text-decoration: none;
      transition: all 0.3s ease;
      border-radius: 10px;
    }
    
    .menu-label {
      display: none;
      margin-left: 10px;
      font-size: 16px;
    }
    
    .sidebar.expanded {
      width: 220px;
      align-items: flex-start;
      padding-left: 10px;
    }
    
    .sidebar.expanded a {
      justify-content: flex-start;
    }
    
    .sidebar.expanded .menu-label {
      display: inline-block;
    }
    
    /* Expandir ao passar o mouse */
    .sidebar:hover {
      width: 220px;
      align-items: flex-start;
      padding-left: 10px;
    }
    
    .sidebar:hover a {
      justify-content: flex-start;
    }
    
    .sidebar:hover .menu-label {
      display: inline-block;
    }
    
    .sidebar a:hover {
      background-color: rgba(255, 255, 255, 0.15);
      transform: translateX(5px);
    }
    
    .sidebar a:hover::after {
      content: attr(data-title);
      position: absolute;
      left: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      white-space: nowrap;
      margin-left: 15px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }
    
    .badge-notification {
      position: absolute;
      top: 8px;
      right: 12px;
      background-color: #F59E0B;
      color: #fff;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    .main-content {
      padding: 30px 40px;
      position: relative;
      background-color: transparent;
    }
    
    .hidden {
      display: none;
    }
    
    /* Menu do Usuário na sidebar */
    .user-menu {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
    }
    
    .user-menu-button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #fff;
      color: var(--azul-principal);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 22px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .user-menu-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .user-dropdown {
      display: none;
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(20px);
      background-color: #fff;
      border: 1px solid var(--cinza-claro);
      border-radius: 12px;
      min-width: 180px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      overflow: hidden;
    }
    
    .user-dropdown a, .user-dropdown span {
      display: block;
      padding: 12px 16px;
      color: var(--cinza-texto);
      text-decoration: none;
      transition: background 0.2s ease;
    }
    
    .user-dropdown a:hover {
      background-color: var(--azul-claro);
      color: var(--azul-principal);
    }
    
    .user-dropdown span {
      font-weight: 600;
      border-bottom: 1px solid var(--cinza-claro);
    }

    /* Estilos para o Modal de Cadastro de Paciente */
    .form-control:focus {
      border-color: var(--azul-principal);
      box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
    }

    .invalid-feedback {
      display: none;
    }

    .was-validated .form-control:invalid {
      border-color: #dc3545;
    }

    .was-validated .form-control:invalid ~ .invalid-feedback {
      display: block;
    }

    .form-label {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .text-warning {
      color: #856404 !important;
    }

    /* Cards modernos */
    .card {
      border: 0;
      border-radius: 16px;
      box-shadow: var(--sombra-media);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      background: white;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 28px rgba(74, 144, 226, 0.18);
    }
    
    .card-header {
      border-radius: 16px 16px 0 0 !important;
      font-weight: 600;
    }

    /* Estilos para busca de pacientes */
    .bg-gradient-primary {
      background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
    }

    .input-group-lg .form-control {
      border-radius: 0.375rem 0 0 0.375rem;
    }

    .input-group-lg .input-group-append .btn {
      border-radius: 0 0.375rem 0.375rem 0;
    }

    .busca-avancada {
      background-color: var(--azul-claro);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--cinza-claro);
    }

    .btn-toggle-avancada {
      transition: all 0.3s ease;
    }

    .btn-toggle-avancada:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Estilos para resultados da busca */
    .paciente-item {
      transition: background-color 0.2s ease;
    }
    
    .paciente-item:hover {
      background-color: var(--azul-claro);
    }

    .avatar-circle {
      font-size: 1.2rem;
      font-weight: bold;
      color: white;
    }

    /* Efeitos para botões laterais */
    .sidebar .nav-link {
      transition: all 0.3s ease;
    }

    .sidebar .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar .nav-link:active {
      transform: translateX(2px);
    }
    
    /* Fichas de Referência (agrupadas por atendimento) */
    .attn-card + .attn-card { border-top: 1px solid var(--cinza-claro); }
    .attn-group-header .btn-toggle { min-width: 36px; }
    .table-fichas td, .table-fichas th { vertical-align: middle; }
    
    /* Estilos dos Modais */
    .modal-content {
      border-radius: 16px;
      border: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
      color: white;
      border-radius: 16px 16px 0 0;
      border-bottom: none;
      padding: 20px 24px;
    }
    
    .modal-header .modal-title {
      font-weight: 600;
      font-size: 20px;
    }
    
    .modal-header .close {
      color: white;
      opacity: 0.9;
      text-shadow: none;
    }
    
    .modal-header .close:hover {
      opacity: 1;
    }
    
    .modal-body {
      padding: 24px;
    }

    /* Modal scrollável - altura máxima de 70vh */
    .modal-dialog-scrollable .modal-body {
      max-height: calc(70vh - 120px);
      overflow-y: auto;
    }

    .modal-dialog-scrollable .modal-content {
      max-height: 85vh;
    }

    .btn {
      transition: all 0.3s ease;
      border-radius: 10px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .alert {
      border-radius: 12px;
      border: none;
    }
    
    /* Cadastro: exibir campos de texto em MAIÚSCULAS */
    #form-paciente input[type="text"],
    #formCadastroPaciente input[type="text"] {
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <ul class="nav flex-column">
          <li class="nav-item" data-title="Menu">
            <a class="nav-link" href="#" id="toggleSidebarBtn" onclick="toggleSidebar(); return false;">
              <i class="fas fa-bars"></i><span class="menu-label">Menu</span>
            </a>
          </li>
          <li class="nav-item" data-title="Menu Inicial">
            <a class="nav-link" href="#" onclick="onVoltarMenu()">
              <i class="fas fa-home"></i><span class="menu-label">Menu Inicial</span>
            </a>
          </li>
          <li class="nav-item" data-title="Cadastrar novo paciente">
            <a class="nav-link" href="#" onclick="abrirModalCadastroPaciente()" title="Cadastrar Paciente">
              <i class="fas fa-user-plus"></i><span class="menu-label">Cadastrar Paciente</span>
            </a>
          </li>
          <li class="nav-item" data-title="Buscar Paciente">
            <a class="nav-link" href="#" onclick="showBuscaPaciente()">
              <i class="fas fa-search"></i><span class="menu-label">Buscar Paciente</span>
            </a>
          </li>
          <li class="nav-item" data-title="Status de Pacientes">
            <a class="nav-link" href="/recepcionista/status-pacientes">
              <i class="fas fa-chart-line"></i><span class="menu-label">Status de Pacientes</span>
            </a>
          </li>
          <li class="nav-item" data-title="Fichas de Referência">
            <a class="nav-link" href="#" onclick="showFichasReferenciaAtivas()">
              <i class="fas fa-share-square"></i><span class="menu-label">Fichas de Referência</span>
            </a>
          </li>
          <li class="nav-item" data-title="Buscar Fichas de Atendimento">
            <a class="nav-link" href="#" onclick="showBuscaFichasAtendimento()">
              <i class="fas fa-file-medical"></i><span class="menu-label">Buscar Fichas</span>
            </a>
          </li>
        </ul>
        <!-- Menu do Usuário -->
        <div class="user-menu">
          <button class="user-menu-button" id="userMenuButton"><i class="fas fa-user"></i></button>
          <div class="user-dropdown" id="userDropdown">
            <span id="userNameDisplay">Nome do Funcionário</span>
            <a href="#" id="changePasswordOption">Mudar a senha</a>
            <a href="/logout" id="logoutOption">Sair</a>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col main-content">
        <!-- Dashboard -->
        <div id="dashboard">
          <!-- Ações rápidas -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body d-flex align-items-center justify-content-between">
              <div>
                <h5 class="mb-1">Criar Atendimento por CPF</h5>
                <small class="text-muted">Busque o paciente pelo CPF para abrir um novo atendimento</small>
              </div>
              <button class="btn btn-primary" onclick="abrirModalCriarAtendimentoCPF()">
                <i class="fas fa-notes-medical mr-1"></i>Novo Atendimento
              </button>
            </div>
          </div>

          <!-- Menu Rápido -->
          <div class="row">
            <div class="col-md-3 mb-4">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column align-items-start">
                  <div class="mb-3 text-primary" style="font-size: 2rem;">
                    <i class="fas fa-user-plus"></i>
                  </div>
                  <h5 class="card-title">Cadastrar Paciente</h5>
                  <p class="card-text text-muted">Abra o formulário para novo cadastro.</p>
                  <button class="btn btn-outline-primary mt-auto" onclick="abrirModalCadastroPaciente()">
                    Abrir
                  </button>
                </div>
              </div>
            </div>

            <div class="col-md-3 mb-4">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column align-items-start">
                  <div class="mb-3 text-success" style="font-size: 2rem;">
                    <i class="fas fa-search"></i>
                  </div>
                  <h5 class="card-title">Buscar Paciente</h5>
                  <p class="card-text text-muted">Localize pacientes por nome ou CPF.</p>
                  <button class="btn btn-outline-success mt-auto" onclick="showBuscaPaciente()">
                    Abrir
                  </button>
                </div>
              </div>
            </div>

            <div class="col-md-3 mb-4">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column align-items-start">
                  <div class="mb-3 text-info" style="font-size: 2rem;">
                    <i class="fas fa-chart-line"></i>
                  </div>
                  <h5 class="card-title">Status de Pacientes</h5>
                  <p class="card-text text-muted">Acompanhe o status geral.</p>
                  <a class="btn btn-outline-info mt-auto" href="/recepcionista/status-pacientes">
                    Abrir
                  </a>
                </div>
              </div>
            </div>

            <div class="col-md-3 mb-4">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column align-items-start">
                  <div class="mb-3 text-secondary" style="font-size: 2rem;">
                    <i class="fas fa-share-square"></i>
                  </div>
                  <h5 class="card-title">Fichas de Referência</h5>
                  <p class="card-text text-muted">Veja fichas para atendimentos ativos.</p>
                  <button class="btn btn-outline-secondary mt-auto" onclick="showFichasReferenciaAtivas()">
                    Abrir
                  </button>
                </div>
              </div>
            </div>

            <div class="col-md-3 mb-4">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column align-items-start">
                  <div class="mb-3 text-warning" style="font-size: 2rem;">
                    <i class="fas fa-file-medical"></i>
                  </div>
                  <h5 class="card-title">Buscar Fichas</h5>
                  <p class="card-text text-muted">Liste e imprima fichas por paciente.</p>
                  <button class="btn btn-outline-warning mt-auto" onclick="showBuscaFichasAtendimento()">
                    Abrir
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Submenu: Fichas de Referência (Atendimentos Ativos) -->
        <div id="submenu-fichas-referencia" class="hidden">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
              <i class="fas fa-share-square mr-2 text-info"></i>Fichas de Referência - Atendimentos Ativos
            </h2>
            <button class="btn btn-outline-secondary" onclick="onVoltarMenu()">
              <i class="fas fa-arrow-left mr-1"></i>Voltar ao Menu
            </button>
          </div>
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white d-flex align-items-center justify-content-between">
              <h6 class="mb-0 font-weight-bold">Lista de fichas</h6>
              <span class="badge badge-light" id="badgeTotalFichasAtivas">0</span>
            </div>
            <div class="card-body p-0">
              <div id="fichas-referencia-ativas">
                <div class="p-3 text-muted">Carregando...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tela de Cadastro -->
        <div id="cadastro-paciente" class="form-container hidden">
          <h2>Cadastrar Paciente</h2>
          <button class="btn btn-secondary mb-3" onclick="onVoltarMenu()">Voltar ao Menu</button>
          <form id="form-paciente">
            <!-- Campos do Paciente -->            <div id="campos-identificado">              <div class="form-group">
                <label for="cpf">CPF *</label>
                <input type="text" class="form-control" id="cpf" name="cpf" required />
              </div>
              <div class="form-group">
                <label for="nome">Nome Completo *</label>
                <input type="text" class="form-control" id="nome" name="nome" required />
              </div>
              <div class="form-group">
                <label for="cartao_sus">Cartão SUS</label>
                <input type="text" class="form-control" id="cartao_sus" name="cartao_sus" />
              </div>
              <div class="form-group">
                <label for="nome_social">Nome Social</label>
                <input type="text" class="form-control" id="nome_social" name="nome_social" />
              </div>
              <div class="form-group">
                <label for="filiacao">Filiação</label>
                <input type="text" class="form-control" id="filiacao" name="filiacao" />
              </div>
              <div class="form-group">
                <label for="data_nascimento">Data de Nascimento *</label>
                <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" required />
              </div>
              <div class="form-group">
                <label for="sexo">Sexo *</label>
                <select class="form-control" id="sexo" name="sexo" required>
                  <option value="">Selecione</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Feminino">Feminino</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>
              <div class="form-group">
                <label for="endereco">Endereço</label>
                <input type="text" class="form-control" id="endereco" name="endereco" />
              </div>
            </div><!-- Campo Telefone (sempre visível) -->
            <div class="form-group">
              <label for="telefone">Telefone</label>
              <input type="text" class="form-control" id="telefone" name="telefone" placeholder="(XX) XXXXX-XXXX" />
            </div>
            <button type="submit" class="btn btn-primary mt-3">Cadastrar</button>
          </form>
        </div>

        <!-- Tela de Busca de Paciente -->
        <div id="busca-paciente" class="hidden">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
              <i class="fas fa-search mr-2 text-primary"></i>Buscar Paciente
            </h2>
            <button class="btn btn-outline-secondary" onclick="onVoltarMenu()">
              <i class="fas fa-arrow-left mr-1"></i>Voltar ao Menu
            </button>
          </div>

          <!-- Formulário de Busca -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-gradient-primary text-white">
              <h6 class="mb-0 font-weight-bold">
                <i class="fas fa-search mr-2"></i>Pesquisa de Pacientes
              </h6>
            </div>
            <div class="card-body">
              <!-- Busca Rápida -->
              <div class="mb-4">
                <label for="busca-rapida" class="font-weight-bold text-muted mb-2">
                  <i class="fas fa-bolt mr-1"></i>Busca Rápida
                </label>
                <div class="input-group input-group-lg">
                  <input type="text" class="form-control" id="busca-rapida"
                         placeholder="Digite nome ou CPF para buscar..." minlength="3">
                  <div class="input-group-append">
                    <button class="btn btn-success" type="button" onclick="buscarPacienteRapido()" id="btn-busca-rapida">
                      <i class="fas fa-search mr-1"></i>Buscar
                    </button>
                  </div>
                </div>
                <small class="form-text text-muted">
                  <i class="fas fa-info-circle mr-1"></i>Digite pelo menos 3 caracteres para nome ou CPF completo
                </small>
              </div>

              <hr class="my-4">

              <!-- Busca Avançada -->
              <div class="busca-avancada" id="busca-avancada" style="display: none;">
                <h6 class="font-weight-bold text-primary mb-3">
                  <i class="fas fa-sliders-h mr-1"></i>Busca Avançada
                </h6>

                <!-- Primeira linha: Nome e CPF -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="busca-nome" class="font-weight-bold">
                        <i class="fas fa-user mr-1 text-primary"></i>Nome Completo
                      </label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="busca-nome"
                               placeholder="Digite o nome completo" minlength="3">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary" type="button" onclick="buscarPorNome()">
                            <i class="fas fa-search"></i>
                          </button>
                        </div>
                      </div>
                      <small class="form-text text-muted">Busca parcial por nome</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="busca-cpf" class="font-weight-bold">
                        <i class="fas fa-id-card mr-1 text-primary"></i>CPF
                      </label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="busca-cpf"
                               placeholder="000.000.000-00">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary" type="button" onclick="buscarPorCPF()">
                            <i class="fas fa-search"></i>
                          </button>
                        </div>
                      </div>
                      <small class="form-text text-muted">CPF completo (11 dígitos)</small>
                    </div>
                  </div>
                </div>

                <!-- Segunda linha: Nome da Mãe e Cartão SUS -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="busca-filiacao" class="font-weight-bold">
                        <i class="fas fa-female mr-1 text-primary"></i>Nome da Mãe
                      </label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="busca-filiacao"
                               placeholder="Digite o nome da mãe" minlength="3">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary" type="button" onclick="buscarPorFiliacao()">
                            <i class="fas fa-search"></i>
                          </button>
                        </div>
                      </div>
                      <small class="form-text text-muted">Busca parcial por nome da mãe</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="busca-cartao-sus" class="font-weight-bold">
                        <i class="fas fa-id-badge mr-1 text-primary"></i>Cartão SUS
                      </label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="busca-cartao-sus"
                               placeholder="000000000000000" maxlength="15">
                        <div class="input-group-append">
                          <button class="btn btn-outline-primary" type="button" onclick="buscarPorCartaoSUS()">
                            <i class="fas fa-search"></i>
                          </button>
                        </div>
                      </div>
                      <small class="form-text text-muted">Cartão SUS completo (15 dígitos)</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Toggle para Busca Avançada -->
              <div class="text-center">
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleBuscaAvancada()" id="btn-toggle-avancada">
                  <i class="fas fa-chevron-down mr-1"></i>Opções Avançadas
                </button>
              </div>
            </div>
          </div>

          <!-- Resultado da Busca -->
          <div id="resultado-busca"></div>
        </div>

        <!-- Tela: Buscar Fichas de Atendimento -->
        <div id="busca-fichas-atendimento" class="hidden">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
              <i class="fas fa-file-medical mr-2 text-primary"></i>Buscar Fichas de Atendimento
            </h2>
            <button class="btn btn-outline-secondary" onclick="onVoltarMenu()">
              <i class="fas fa-arrow-left mr-1"></i>Voltar ao Menu
            </button>
          </div>

          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-gradient-primary text-white">
              <h6 class="mb-0 font-weight-bold">
                <i class="fas fa-search mr-2"></i>Pesquisar por Nome ou CPF
              </h6>
            </div>
            <div class="card-body">
              <div class="input-group input-group-lg mb-2">
                <input type="text" class="form-control" id="input-busca-fichas" placeholder="Digite nome (mín. 3 letras) ou CPF completo">
                <div class="input-group-append">
                  <button class="btn btn-success" type="button" id="btn-busca-fichas" onclick="buscarFichasAtendimento()">
                    <i class="fas fa-search mr-1"></i>Buscar
                  </button>
                </div>
              </div>
              <small class="form-text text-muted">
                <i class="fas fa-info-circle mr-1"></i>Para nome, digite pelo menos 3 caracteres. Para CPF, use 11 dígitos.
              </small>
            </div>
          </div>

          <!-- Resultado da busca de fichas -->
          <div id="resultado-fichas"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Mudar Senha -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="changePasswordModalLabel">Mudar a senha</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="form-group">
              <label for="senhaAtual">Senha Atual</label>
              <input type="password" class="form-control" id="senhaAtual" name="senhaAtual" required>
            </div>
            <div class="form-group">
              <label for="novaSenha">Nova Senha</label>
              <input type="password" class="form-control" id="novaSenha" name="novaSenha" required>
            </div>
            <div class="form-group">
              <label for="confirmarNovaSenha">Confirmar Nova Senha</label>
              <input type="password" class="form-control" id="confirmarNovaSenha" name="confirmarNovaSenha" required>
            </div>
            <button type="submit" class="btn btn-primary">Alterar Senha</button>
          </form>
        </div>
      </div>
    </div>  </div>

  <!-- Modal para Cadastro de Paciente -->
  <div class="modal fade" id="modalCadastroPaciente" tabindex="-1" role="dialog" aria-labelledby="modalCadastroPacienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered" role="document">
      <div class="modal-content">
        <!-- Header do Modal -->
        <div class="modal-header">
          <h5 class="modal-title" id="modalCadastroPacienteLabel">
            <i class="fas fa-user-plus mr-2"></i>Cadastrar Paciente
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span>&times;</span>
          </button>
        </div>

        <!-- Corpo do Modal -->
        <div class="modal-body">
          <form id="formCadastroPaciente" novalidate>
            <!-- Informações Básicas -->
            <div class="row mb-3">
              <div class="col-md-8">
                <label for="modalNome" class="form-label">
                  <i class="fas fa-user mr-1"></i>Nome Completo <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="modalNome" name="nome" placeholder="Digite o nome completo" required>
                <div class="invalid-feedback">Nome é obrigatório</div>
              </div>
              <div class="col-md-4">
                <label for="modalCpf" class="form-label">
                  <i class="fas fa-id-card mr-1"></i>CPF <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="modalCpf" name="cpf" placeholder="000.000.000-00" required>
                <small class="text-muted">Digite 11 dígitos</small>
                <div class="invalid-feedback">CPF é obrigatório</div>
              </div>
            </div>

            <!-- Dados Pessoais -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="modalDataNascimento" class="form-label">
                  <i class="fas fa-calendar-alt mr-1"></i>Data Nascimento <span class="text-danger">*</span>
                </label>
                <input type="date" class="form-control" id="modalDataNascimento" name="data_nascimento" required>
                <div class="invalid-feedback">Data é obrigatória</div>
              </div>
              <div class="col-md-4">
                <label for="modalSexo" class="form-label">
                  <i class="fas fa-venus-mars mr-1"></i>Sexo <span class="text-danger">*</span>
                </label>
                <select class="form-control" id="modalSexo" name="sexo" required>
                  <option value="">Selecione</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Feminino">Feminino</option>
                </select>
                <div class="invalid-feedback">Sexo é obrigatório</div>
              </div>
              <div class="col-md-4">
                <label for="modalCor" class="form-label">
                  <i class="fas fa-palette mr-1"></i>Cor/Raça
                </label>
                <select class="form-control" id="modalCor" name="cor">
                  <option value="">Selecione</option>
                  <option value="Branca">Branca</option>
                  <option value="Preta">Preta</option>
                  <option value="Parda">Parda</option>
                  <option value="Amarela">Amarela</option>
                  <option value="Indígena">Indígena</option>
                </select>
              </div>
            </div>

            <!-- Informações Adicionais -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="modalNomeSocial" class="form-label">
                  <i class="fas fa-user-tag mr-1"></i>Nome Social
                </label>
                <input type="text" class="form-control" id="modalNomeSocial" name="nome_social" placeholder="Se houver">
              </div>
              <div class="col-md-6">
                <label for="modalFiliacao" class="form-label">
                  <i class="fas fa-female mr-1"></i>Nome da Mãe <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="modalFiliacao" name="filiacao" placeholder="Nome completo" required>
                <div class="invalid-feedback">Nome da mãe é obrigatório</div>
              </div>
            </div>

            <!-- Contato -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="modalCartaoSus" class="form-label">
                  <i class="fas fa-id-badge mr-1"></i>Cartão SUS
                </label>
                <input type="text" class="form-control" id="modalCartaoSus" name="cartao_sus" placeholder="000000000000000" maxlength="15">
                <small class="text-muted">Opcional</small>
              </div>
              <div class="col-md-6">
                <label for="modalTelefone" class="form-label">
                  <i class="fas fa-phone mr-1"></i>Telefone
                </label>
                <input type="text" class="form-control" id="modalTelefone" name="telefone" placeholder="(00) 00000-0000">
              </div>
            </div>

            <!-- Endereço -->
            <div class="row mb-3">
              <div class="col-md-8">
                <label for="modalEndereco" class="form-label">
                  <i class="fas fa-map-marker-alt mr-1"></i>Endereço
                </label>
                <input type="text" class="form-control" id="modalEndereco" name="endereco" placeholder="Rua, Avenida, etc.">
              </div>
              <div class="col-md-4">
                <label for="modalBairro" class="form-label">
                  <i class="fas fa-building mr-1"></i>Bairro
                </label>
                <input type="text" class="form-control" id="modalBairro" name="bairro" placeholder="Nome do bairro">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-12">
                <label for="modalMunicipio" class="form-label">
                  <i class="fas fa-city mr-1"></i>Município
                </label>
                <input type="text" class="form-control" id="modalMunicipio" name="municipio" placeholder="Nome da cidade">
              </div>
            </div>

            <!-- Prioridade Administrativa -->
            <div class="form-row">
              <div class="col-md-12">
                <div class="custom-control custom-checkbox mb-3">
                  <input type="checkbox" class="custom-control-input" id="modalPrioridade" name="prioridade">
                  <label class="custom-control-label" for="modalPrioridade">
                    <i class="fas fa-star text-warning mr-1"></i>
                    <strong>Paciente com Prioridade Administrativa</strong>
                    <small class="text-muted d-block">Idoso (60+), gestante, lactante, pessoa com deficiência</small>
                  </label>
                </div>
              </div>
            </div>

            <!-- Tipo de Prioridade (oculto inicialmente) -->
            <div class="form-row" id="rowTipoPrioridade" style="display: none;">
              <div class="col-md-12 mb-3">
                <label for="modalDescPrioridade">
                  <i class="fas fa-info-circle mr-1"></i>Tipo de Prioridade
                </label>
                <select class="form-control" id="modalDescPrioridade" name="desc_prioridade">
                  <option value="">Selecione o tipo...</option>
                  <option value="Idoso">Idoso (60 anos ou mais)</option>
                  <option value="Gestante">Gestante</option>
                  <option value="Lactante">Lactante (mãe amamentando)</option>
                  <option value="Pessoa com deficiência">Pessoa com deficiência</option>
                  <option value="Autismo">Autismo (TEA)</option>
                  <option value="Pessoa com criança de colo">Pessoa com criança de colo</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>
            </div>

            <!-- Info sobre campos obrigatórios -->
            <div class="alert alert-light border text-muted small">
              <i class="fas fa-info-circle mr-1"></i>
              Campos marcados com <span class="text-danger">*</span> são obrigatórios
            </div>
          </form>
        </div>

        <!-- Footer do Modal -->
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i>Cancelar
          </button>
          <button type="button" class="btn btn-primary" id="btnSalvarPaciente">
            <i class="fas fa-save mr-1"></i>Cadastrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery, Bootstrap JS e jQuery Mask Plugin -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

  <!-- Modal: Pergunta criar atendimento após cadastro -->
  <div class="modal fade" id="modalPerguntaCriarAtendimento" tabindex="-1" role="dialog" aria-labelledby="modalPerguntaCriarAtendimentoLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalPerguntaCriarAtendimentoLabel">Criar atendimento agora?</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Deseja criar um atendimento para <strong id="nomePacienteCriado">o paciente</strong> agora?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Não</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarCriarAtendimentoPosCadastro">Sim, criar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Criar Atendimento por CPF -->
  <div class="modal fade" id="modalCriarAtendimentoCPF" tabindex="-1" role="dialog" aria-labelledby="modalCriarAtendimentoCPFLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalCriarAtendimentoCPFLabel">Criar Atendimento por CPF</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="cpfAtendimentoInput">CPF do Paciente</label>
            <input type="text" class="form-control" id="cpfAtendimentoInput" placeholder="000.000.000-00">
            <small class="form-text text-muted">Digite o CPF completo (11 dígitos)</small>
          </div>
          <div id="previewAtendimentoPaciente" class="mt-3" style="display:none;">
            <hr>
            <h6 class="mb-3">Confirmar dados do paciente</h6>
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-12"><strong>Nome:</strong> <span id="prevNome"></span></div>
                </div>
                <div class="row">
                  <div class="col-6"><strong>CPF:</strong> <span id="prevCpf"></span></div>
                  <div class="col-6"><strong>Data Nasc.:</strong> <span id="prevDataNasc"></span></div>
                </div>
                <div class="row">
                  <div class="col-12"><strong>Nome da mãe:</strong> <span id="prevMae"></span></div>
                </div>
                <div class="row">
                  <div class="col-6"><strong>Sexo:</strong> <span id="prevSexo"></span></div>
                  <div class="col-6"><strong>Cartão SUS:</strong> <span id="prevSUS"></span></div>
                </div>
                <div class="row">
                  <div class="col-12"><strong>Telefone:</strong> <span id="prevTelefone"></span></div>
                </div>
                <div class="row">
                  <div class="col-12"><strong>Endereço:</strong> <span id="prevEndereco"></span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarCriarAtendimento">Criar Atendimento</button>
        </div>
      </div>
    </div>
  </div>

  <script>    $(document).ready(function () {
      $('#cpf').mask('000.000.000-00');
      document.getElementById('form-paciente').addEventListener('submit', cadastrarPaciente);
      // toggleIdentificacao() removido - não precisa mais
      $.getJSON('/api/recepcionista/nome', function(data) {
        if(data.nome) {
          $('#userNameDisplay').text(data.nome);
        }
      });
      // As listas de atendimentos foram removidas
      // Atualização periódica apenas quando a seção estiver visível
      setInterval(function() {
        if ($('#submenu-fichas-referencia').is(':visible')) {
          carregarFichasReferenciaAtivas();
        }
      }, 30000);

      // Máscara e Enter na busca de fichas
      $('#input-busca-fichas').on('keypress', function(e){
        if (e.key === 'Enter') { buscarFichasAtendimento(); }
      });
    });

    function toggleSidebar() {
      $('#sidebar').toggleClass('expanded');
    }

    $('#userMenuButton').click(function() {
      $('#userDropdown').toggle();
    });
    $(document).click(function(event) {
      if(!$(event.target).closest('#userMenuButton, #userDropdown').length) {
        $('#userDropdown').hide();
      }
    });
    $('#changePasswordOption').click(function(e) {
      e.preventDefault();
      $('#userDropdown').hide();
      $('#changePasswordModal').modal('show');
    });
    $('#changePasswordForm').submit(function(e) {
      e.preventDefault();
      const senhaAtual = $('#senhaAtual').val();
      const novaSenha = $('#novaSenha').val();
      const confirmarNovaSenha = $('#confirmarNovaSenha').val();
      
      if(novaSenha !== confirmarNovaSenha) {
        alert('A nova senha e a confirmação não conferem.');
        return;
      }
      
      if (!senhaAtual.trim() || !novaSenha.trim()) {
        alert('Por favor, preencha todos os campos.');
        return;
      }
      
      fetch('/api/recepcionista/mudar-senha', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ 
          senha_atual: senhaAtual, 
          nova_senha: novaSenha 
        })
      })
      .then(response => {
        // Verificar se a resposta é válida
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Resposta não é JSON válido');
        }
        
        return response.json();
      })
      .then(data => {
        if(data.success) {
          alert('Senha alterada com sucesso.');
          $('#changePasswordModal').modal('hide');
          $('#changePasswordForm')[0].reset();
        } else {
          alert('Erro: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        
        if (error.message.includes('JSON')) {
          alert('Erro: Sessão expirada. Por favor, faça login novamente.');
          window.location.href = '/logout';
        } else {
          alert('Erro ao alterar a senha: ' + error.message);
        }
      });
    });
    function showDashboard() {
      $('#dashboard').show();
      $('#cadastro-paciente').hide();
      $('#busca-paciente').hide();
      $('#submenu-fichas-referencia').hide();
      $('#busca-fichas-atendimento').hide();
    }
    function showCadastroPaciente() {
      $('#dashboard').hide();
      $('#cadastro-paciente').show();
      $('#busca-paciente').hide();
      $('#submenu-fichas-referencia').hide();
      $('#busca-fichas-atendimento').hide();
    }
    function showBuscaPaciente() {
      $('#dashboard').hide();
      $('#cadastro-paciente').hide();
      $('#busca-paciente').show();
      $('#submenu-fichas-referencia').hide();
      $('#busca-fichas-atendimento').hide();
    }    function onVoltarMenu() {
      if($('#cadastro-paciente').is(':visible')) {
        if(!confirm('Deseja cancelar o cadastro e voltar ao menu? Todos os dados serão perdidos.')) return;
        $('#form-paciente')[0].reset();
        // toggleIdentificacao() removido - não precisa mais
      }
      if($('#busca-paciente').is(':visible')) {
        $('#filtro-busca').val('');
        $('#resultado-busca').html('');
      }
      if($('#busca-fichas-atendimento').is(':visible')) {
        $('#input-busca-fichas').val('');
        $('#resultado-fichas').html('');
      }
      showDashboard();
    }// Função removida - não precisamos mais alternar identificação

    function showFichasReferenciaAtivas() {
      $('#dashboard').hide();
      $('#cadastro-paciente').hide();
      $('#busca-paciente').hide();
      $('#submenu-fichas-referencia').show();
      $('#busca-fichas-atendimento').hide();
      carregarFichasReferenciaAtivas();
    }

    function showBuscaFichasAtendimento() {
      $('#dashboard').hide();
      $('#cadastro-paciente').hide();
      $('#busca-paciente').hide();
      $('#submenu-fichas-referencia').hide();
      $('#busca-fichas-atendimento').show();
      setTimeout(() => { $('#input-busca-fichas').focus(); }, 200);
    }

    function validarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
      }
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      soma = 0;
      for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
      }
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(10))) return false;
      return true;
    }    function cadastrarPaciente(event) {
      event.preventDefault();
      let cpfVal = $('#cpf').val().replace(/\D/g, '');
      
      // Validar CPF obrigatório - sem validação de formato
      if (!cpfVal) {
        alert('CPF é obrigatório.');
        return;
      }
      
      const formEl = document.getElementById('form-paciente');
      const formData = new FormData(formEl);
      let data = Object.fromEntries(formData.entries());
      // Forçar maiúsculas em campos textuais
      const toUpperIfString = v => (typeof v === 'string' ? v.toUpperCase() : v);
      const upperKeys = ['nome','cartao_sus','nome_social','filiacao','endereco','bairro','municipio','telefone'];
      upperKeys.forEach(k => { if (data[k] !== undefined) data[k] = toUpperIfString(data[k]); });
      data.identificado = true;
      fetch('/api/pacientes/cadastrar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      })
      .then(response => response.json())
      .then(result => {        if (result.success) {
          alert('Paciente cadastrado com sucesso!');
          document.getElementById('form-paciente').reset();
          // toggleIdentificacao() removido - não precisa mais
          showDashboard();
        } else {
          alert('Erro ao cadastrar paciente: ' + result.message);
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao cadastrar paciente.');
      });
    }

    // Função para buscar paciente rapidamente
    function buscarPacienteRapido() {
      const filtro = $('#busca-rapida').val().trim();

      if (!filtro) {
        alert('Digite um nome ou CPF para buscar.');
        $('#busca-rapida').focus();
        return;
      }

      if (filtro.length < 3) {
        alert('Digite pelo menos 3 caracteres para buscar.');
        $('#busca-rapida').focus();
        return;
      }

      mostrarLoadingBusca();

      // Mostrar que está buscando no botão
      const btnOriginal = $('#btn-busca-rapida').html();
      $('#btn-busca-rapida').html('<i class="fas fa-spinner fa-spin mr-1"></i>Buscando...').prop('disabled', true);

      fetch('/api/pacientes/buscar?filtro=' + encodeURIComponent(filtro))
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na resposta do servidor: ' + response.status + ' - ' + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        ocultarLoadingBusca();
        $('#btn-busca-rapida').html(btnOriginal).prop('disabled', false);

        if (data.success && data.pacientes && data.pacientes.length > 0) {
          exibirResultadosBuscaAvancada(data.pacientes);
        } else {
          mostrarPacienteNaoEncontrado();
        }
      })
      .catch(error => {
        ocultarLoadingBusca();
        $('#btn-busca-rapida').html(btnOriginal).prop('disabled', false);
        alert('Erro ao buscar pacientes. Verifique sua conexão e tente novamente.');
      });
    }

    // Função para mostrar loading da busca
    function mostrarLoadingBusca() {
      $('#resultado-busca').html(`
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Buscando...</span>
          </div>
          <p class="mt-3 text-muted">Buscando paciente...</p>
        </div>
      `);
    }

    // Função para ocultar loading da busca
    function ocultarLoadingBusca() {
      // O loading será substituído pelo resultado
    }

    // Função para exibir resultados de busca avançada
    function exibirResultadosBuscaAvancada(pacientes) {
      if (!pacientes || pacientes.length === 0) {
        mostrarPacienteNaoEncontrado();
        return;
      }

      let html = `
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0 font-weight-bold">
              <i class="fas fa-check-circle mr-2"></i>
              ${pacientes.length} paciente${pacientes.length > 1 ? 's' : ''} encontrado${pacientes.length > 1 ? 's' : ''}
            </h6>
          </div>
          <div class="card-body p-0">
      `;

      pacientes.forEach((paciente, index) => {
        const idade = calcularIdade(paciente.data_nascimento);
        const cpfFormatado = formatarCPF(paciente.cpf);

        html += `
          <div class="paciente-item border-bottom ${index === pacientes.length - 1 ? 'border-bottom-0' : ''}" style="padding: 1.5rem;">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex align-items-center mb-2">
                  <div class="avatar-circle bg-primary text-white mr-3" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${paciente.nome ? paciente.nome.charAt(0).toUpperCase() : '?'}
                  </div>
                  <div>
                    <h5 class="mb-1 font-weight-bold text-primary">
                      <a href="/ficha_geral_paciente?paciente_id=${paciente.id}" target="_blank" style="text-decoration:none;">
                        ${paciente.nome || 'Nome não informado'}
                      </a>
                    </h5>
                    <p class="mb-1 text-muted small">
                      <i class="fas fa-id-card mr-1"></i>CPF: ${cpfFormatado || 'Não informado'} |
                      <i class="fas fa-birthday-cake mr-1"></i>${idade} anos |
                      <i class="fas fa-venus-mars mr-1"></i>${paciente.sexo || 'Não informado'}
                    </p>
                    <p class="mb-0 text-muted small">
                      <i class="fas fa-calendar-alt mr-1"></i>Data nascimento: ${paciente.data_nascimento || 'Não informado'} |
                      <i class="fas fa-map-marker-alt mr-1"></i>${paciente.municipio || 'Município não informado'}
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-4 text-right">
                <div class="btn-group" role="group">
                  <a class="btn btn-outline-info btn-sm" href="/ficha_geral_paciente?paciente_id=${paciente.id}" target="_blank" title="Abrir Ficha do Paciente">
                    <i class="fas fa-file-alt mr-1"></i>Ficha
                  </a>
                  <button class="btn btn-outline-success btn-sm" onclick="criarFichaAtendimento(${paciente.id})" title="Criar ficha de atendimento">
                    <i class="fas fa-plus-circle mr-1"></i>Atendimento
                  </button>
                  <button class="btn btn-outline-primary btn-sm" onclick="verDetalhesPaciente(${paciente.id})" title="Ver detalhes completos">
                    <i class="fas fa-eye mr-1"></i>Detalhes
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      html += `
          </div>
        </div>
      `;

      $('#resultado-busca').html(html);
    }

    // Função para mostrar quando paciente não é encontrado
    function mostrarPacienteNaoEncontrado() {
      $('#resultado-busca').html(`
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <div class="text-warning mb-3">
              <i class="fas fa-search fa-3x"></i>
            </div>
            <h5 class="text-muted">Paciente não encontrado</h5>
            <p class="text-muted mb-4">Não foi possível encontrar um paciente com os dados informados.</p>
            <div class="row justify-content-center">
              <div class="col-md-6">
                <button class="btn btn-success btn-block" onclick="abrirModalCadastroPaciente()">
                  <i class="fas fa-user-plus mr-2"></i>Cadastrar Novo Paciente
                </button>
              </div>
            </div>
          </div>
        </div>
      `);
    }    function abrirObservacoes(pacienteId) {
      window.open('/observacoes-recepcao?paciente_id=' + pacienteId, 'ObservacoesPaciente', 'width=800,height=600');
    }    // Função para buscar paciente por nome (busca avançada)
    function buscarPorNome() {
      const nome = $('#busca-nome').val().trim();

      if (!nome) {
        alert('Por favor, digite um nome para busca.');
        $('#busca-nome').focus();
        return;
      }

      if (nome.length < 3) {
        alert('Digite pelo menos 3 caracteres para buscar por nome.');
        $('#busca-nome').focus();
        return;
      }

      mostrarLoadingBusca();

      // Usar endpoint específico para busca por nome
      fetch('/api/pacientes/buscar/nome?valor=' + encodeURIComponent(nome))
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na resposta do servidor: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        ocultarLoadingBusca();
        if (data.success && data.pacientes && data.pacientes.length > 0) {
          exibirResultadosBuscaAvancada(data.pacientes);
        } else {
          mostrarPacienteNaoEncontrado();
        }
      })
      .catch(error => {
        ocultarLoadingBusca();
        console.error('Erro:', error);
        alert('Erro ao buscar paciente. Tente novamente.');
      });
    }

    // Função para buscar paciente por CPF (busca avançada)
    function buscarPorCPF() {
      const cpf = $('#busca-cpf').val().trim();

      if (!cpf) {
        alert('Por favor, digite um CPF para busca.');
        $('#busca-cpf').focus();
        return;
      }

      const cpfLimpo = cpf.replace(/\D/g, '');
      if (cpfLimpo.length !== 11) {
        alert('CPF deve ter 11 dígitos.');
        $('#busca-cpf').focus();
        return;
      }

      mostrarLoadingBusca();

      // Usar endpoint específico para busca por CPF
      fetch('/api/pacientes/buscar/cpf?valor=' + encodeURIComponent(cpfLimpo))
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na resposta do servidor: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        ocultarLoadingBusca();
        if (data.success && data.pacientes && data.pacientes.length > 0) {
          exibirResultadosBuscaAvancada(data.pacientes);
        } else {
          mostrarPacienteNaoEncontrado();
        }
      })
      .catch(error => {
        ocultarLoadingBusca();
        console.error('Erro:', error);
        alert('Erro ao buscar paciente. Tente novamente.');
      });
    }

    // Função para buscar paciente por nome da mãe
    function buscarPorFiliacao() {
      const filiacao = $('#busca-filiacao').val().trim();

      if (!filiacao) {
        alert('Por favor, digite o nome da mãe para busca.');
        $('#busca-filiacao').focus();
        return;
      }

      if (filiacao.length < 3) {
        alert('Digite pelo menos 3 caracteres para buscar por nome da mãe.');
        $('#busca-filiacao').focus();
        return;
      }

      mostrarLoadingBusca();

      fetch('/api/pacientes/buscar/filiacao?valor=' + encodeURIComponent(filiacao))
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na resposta do servidor: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        ocultarLoadingBusca();
        if (data.success && data.pacientes && data.pacientes.length > 0) {
          exibirResultadosBuscaAvancada(data.pacientes);
        } else {
          mostrarPacienteNaoEncontrado();
        }
      })
      .catch(error => {
        ocultarLoadingBusca();
        console.error('Erro:', error);
        alert('Erro ao buscar paciente. Tente novamente.');
      });
    }

    // Função para buscar paciente por cartão SUS
    function buscarPorCartaoSUS() {
      const cartaoSus = $('#busca-cartao-sus').val().trim();

      if (!cartaoSus) {
        alert('Por favor, digite o cartão SUS para busca.');
        $('#busca-cartao-sus').focus();
        return;
      }

      if (cartaoSus.length < 3) {
        alert('Digite pelo menos 3 caracteres para buscar por cartão SUS.');
        $('#busca-cartao-sus').focus();
        return;
      }

      mostrarLoadingBusca();

      fetch('/api/pacientes/buscar/cartao-sus?valor=' + encodeURIComponent(cartaoSus))
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na resposta do servidor: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        ocultarLoadingBusca();
        if (data.success && data.pacientes && data.pacientes.length > 0) {
          exibirResultadosBuscaAvancada(data.pacientes);
        } else {
          mostrarPacienteNaoEncontrado();
        }
      })
      .catch(error => {
        ocultarLoadingBusca();
        console.error('Erro:', error);
        alert('Erro ao buscar paciente. Tente novamente.');
      });
    }

    // Função para ver detalhes do paciente
    function verDetalhesPaciente(pacienteId) {
      // Buscar dados completos do paciente via API
      fetch(`/api/pacientes/${pacienteId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          mostrarModalDetalhesPaciente(data.paciente);
        } else {
          alert('Erro ao carregar detalhes do paciente.');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao carregar detalhes do paciente.');
      });
    }

    // Função para criar ficha de atendimento
    function criarFichaAtendimento(pacienteId) {
      // Confirmar se o usuário quer criar a ficha
      if (!confirm('Deseja criar uma ficha de atendimento para este paciente?')) {
        return;
      }

      // Mostrar loading no modal
      const modalFooter = $('#modalDetalhesPaciente .modal-footer');
      const originalFooter = modalFooter.html();
      modalFooter.html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Criando atendimento...</div>');

      // Obter data e hora atuais
      const agora = new Date();
      const dataAtual = agora.toISOString().split('T')[0]; // YYYY-MM-DD
      const horaAtual = agora.toTimeString().slice(0, 5); // HH:MM

      // Criar atendimento automaticamente
      fetch('/api/atendimentos/cadastrar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          paciente_id: pacienteId,
          data_atendimento: dataAtual,
          hora_atendimento: horaAtual
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('✓ Ficha de atendimento criada com sucesso!\n\nID do Atendimento: ' + data.atendimento.id);

          // Fechar modal
          $('#modalDetalhesPaciente').modal('hide');

          // Opcional: redirecionar para a ficha de atendimento
          // Se existir uma rota para visualizar a ficha, descomente a linha abaixo:
          // window.location.href = '/atendimento/' + data.atendimento.id;

        } else {
          alert('Erro ao criar ficha de atendimento: ' + data.message);
          // Restaurar footer original
          modalFooter.html(originalFooter);
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao criar ficha de atendimento. Verifique sua conexão e tente novamente.');
        // Restaurar footer original
        modalFooter.html(originalFooter);
      });
    }

    // Função para mostrar modal com detalhes do paciente
    function mostrarModalDetalhesPaciente(paciente) {
      const idade = calcularIdade(paciente.data_nascimento);
      const cpfFormatado = formatarCPF(paciente.cpf);

      const modalHtml = `
        <div class="modal fade" id="modalDetalhesPaciente" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="fas fa-user-circle mr-2"></i>Detalhes do Paciente
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                  <span>&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-8">
                    <h4 class="text-primary mb-3">${paciente.nome || 'Nome não informado'}</h4>
                  </div>
                  <div class="col-md-4 text-right">
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong><i class="fas fa-id-card mr-1"></i>CPF:</strong> ${cpfFormatado || 'Não informado'}
                  </div>
                  <div class="col-md-6">
                    <strong><i class="fas fa-birthday-cake mr-1"></i>Data Nascimento:</strong> ${paciente.data_nascimento || 'Não informado'}
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong><i class="fas fa-venus-mars mr-1"></i>Sexo:</strong> ${paciente.sexo || 'Não informado'}
                  </div>
                  <div class="col-md-6">
                    <strong><i class="fas fa-palette mr-1"></i>Cor/Raça:</strong> ${paciente.cor || 'Não informado'}
                  </div>
                </div>

                ${paciente.nome_social ? `
                <div class="row mb-3">
                  <div class="col-12">
                    <strong><i class="fas fa-user-tag mr-1"></i>Nome Social:</strong> ${paciente.nome_social}
                  </div>
                </div>
                ` : ''}

                ${paciente.filiacao ? `
                <div class="row mb-3">
                  <div class="col-12">
                    <strong><i class="fas fa-female mr-1"></i>Nome da Mãe:</strong> ${paciente.filiacao}
                  </div>
                </div>
                ` : ''}

                ${paciente.cartao_sus ? `
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong><i class="fas fa-id-badge mr-1"></i>Cartão SUS:</strong> ${paciente.cartao_sus}
                  </div>
                  <div class="col-md-6">
                    <strong><i class="fas fa-phone mr-1"></i>Telefone:</strong> ${paciente.telefone || 'Não informado'}
                  </div>
                </div>
                ` : ''}

                ${(paciente.endereco || paciente.bairro || paciente.municipio) ? `
                <div class="row mb-3">
                  <div class="col-12">
                    <strong><i class="fas fa-map-marker-alt mr-1"></i>Endereço:</strong>
                    ${paciente.endereco || ''} ${paciente.bairro ? '- ' + paciente.bairro : ''} ${paciente.municipio ? '- ' + paciente.municipio : ''}
                  </div>
                </div>
                ` : ''}

                <div class="row">
                  <div class="col-12">
                    <strong><i class="fas fa-info-circle mr-1"></i>Status:</strong>
                    <span class="badge ${paciente.identificado ? 'badge-success' : 'badge-warning'}">
                      ${paciente.identificado ? 'Identificado' : 'Não identificado'}
                    </span>
                    ${idade ? `<span class="ml-2"><strong>Idade:</strong> ${idade} anos</span>` : ''}
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="criarFichaAtendimento(${paciente.id})">
                  <i class="fas fa-plus-circle mr-1"></i>Criar Ficha de Atendimento
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remover modal anterior se existir
      $('#modalDetalhesPaciente').remove();

      // Adicionar novo modal ao body
      $('body').append(modalHtml);

      // Mostrar modal
      $('#modalDetalhesPaciente').modal('show');
    }

    // Função para toggle da busca avançada
    function toggleBuscaAvancada() {
      const avancada = $('#busca-avancada');
      const btnToggle = $('#btn-toggle-avancada');
      const isVisible = avancada.is(':visible');

      if (isVisible) {
        avancada.slideUp(300);
        btnToggle.html('<i class="fas fa-chevron-down mr-1"></i>Opções Avançadas');
      } else {
        avancada.slideDown(300);
        btnToggle.html('<i class="fas fa-chevron-up mr-1"></i>Ocultar Avançadas');
      }
    }

    // Função unificada para realizar busca
    function realizarBusca(tipo, valor) {
      // Limpar resultados anteriores
      limparResultadosBusca();
      
      // Mostrar loading
      document.getElementById('loading-busca').style.display = 'block';

      // Fazer requisição de busca
      fetch(`/api/pacientes/buscar/${tipo}?valor=${encodeURIComponent(valor)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('loading-busca').style.display = 'none';
          
          if (data.success && data.pacientes && data.pacientes.length > 0) {
            mostrarResultadosPacientes(data.pacientes);
          } else {
            mostrarOpcaoCadastrar();
          }
        })
        .catch(error => {
          console.error('Erro na busca:', error);
          document.getElementById('loading-busca').style.display = 'none';
          alert('Erro ao buscar paciente. Tente novamente.');
        });
    }

    // Função para limpar resultados da busca
    function limparResultadosBusca() {
      document.getElementById('resultados-busca').style.display = 'none';
      document.getElementById('opcao-cadastrar').style.display = 'none';
      document.getElementById('lista-pacientes').innerHTML = '';
    }

    // Função para mostrar resultados da busca
    function mostrarResultadosPacientes(pacientes) {
      const container = document.getElementById('lista-pacientes');
      container.innerHTML = '';

      pacientes.forEach(paciente => {
        const idade = calcularIdade(paciente.data_nascimento);
        const cpfFormatado = formatarCPF(paciente.cpf);
        const cartaoSus = paciente.cartao_sus || 'Não informado';

        const pacienteCard = `
          <div class="card mb-2">
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <h6 class="card-title mb-1">${paciente.nome}</h6>
                  <p class="card-text mb-1">
                    <small class="text-muted">
                      <strong>CPF:</strong> ${cpfFormatado} | 
                      <strong>Idade:</strong> ${idade} anos | 
                      <strong>Sexo:</strong> ${paciente.sexo || 'Não informado'}
                    </small>
                  </p>                  <p class="card-text mb-1">
                    <small class="text-muted">
                      <strong>Cartão SUS:</strong> ${cartaoSus}
                    </small>
                  </p>
                  <p class="card-text mb-1">
                    <small class="text-muted">
                      <strong>Mãe:</strong> ${paciente.filiacao || 'Não informado'}
                    </small>
                  </p>
                  <p class="card-text mb-0">
                    <small class="text-muted">
                      <strong>Telefone:</strong> ${paciente.telefone || 'Não informado'}
                    </small>
                  </p>
                </div>
                <div class="col-md-4 text-right">
                </div>
              </div>
            </div>
          </div>
        `;
        container.innerHTML += pacienteCard;
      });

      document.getElementById('resultados-busca').style.display = 'block';
    }

    // Função para mostrar opção de cadastrar novo paciente
    function mostrarOpcaoCadastrar() {
      document.getElementById('opcao-cadastrar').style.display = 'block';
    }

    // Função para selecionar paciente e abrir ficha
    function selecionarPaciente(pacienteId) {
      $('#modalBuscarPaciente').modal('hide');

      // Obter data e hora atuais
      const agora = new Date();
      const dataAtual = agora.toISOString().split('T')[0]; // YYYY-MM-DD
      const horaAtual = agora.toTimeString().slice(0, 5); // HH:MM

      // Criar atendimento automaticamente
      fetch('/api/atendimentos/cadastrar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          paciente_id: pacienteId,
          data_atendimento: dataAtual,
          hora_atendimento: horaAtual
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Atendimento criado com sucesso!\n\nID: ' + data.atendimento.id);
          // Não abrir ficha automaticamente conforme solicitado
        } else {
          alert('Erro ao criar atendimento: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao criar atendimento. Tente novamente.');
      });
    }    // Função para abrir modal de buscar paciente existente
    function abrirBuscaPacienteExistente() {
      $('#modalBuscarPaciente').modal('show');
    }    // Função para abrir cadastro de novo paciente
    function abrirRegistroPaciente() {
      abrirModalCadastroPaciente();
    }

    // Função para calcular idade
    function calcularIdade(dataNascimento) {
      if (!dataNascimento) return 'Não informado';
      
      const nascimento = new Date(dataNascimento);
      const hoje = new Date();
      let idade = hoje.getFullYear() - nascimento.getFullYear();
      const mes = hoje.getMonth() - nascimento.getMonth();
      
      if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
        idade--;
      }
      
      return idade;
    }

    // Função para formatar CPF
    function formatarCPF(cpf) {
      if (!cpf) return 'Não informado';
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }    // Event listener para busca com Enter
    document.addEventListener('DOMContentLoaded', function() {
      // Aplicar máscara no campo CPF
      $('#busca-cpf').mask('000.000.000-00');
      
      // Event listeners para Enter nos campos de busca
      const campoBuscaNome = document.getElementById('busca-nome');
      if (campoBuscaNome) {
        campoBuscaNome.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            buscarPorNome();
          }
        });
      }
      
      const campoBuscaCPF = document.getElementById('busca-cpf');
      if (campoBuscaCPF) {
        campoBuscaCPF.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            buscarPorCPF();
          }
        });
      }
      
      // Limpar campos quando modal for fechado
      $('#modalBuscarPaciente').on('hidden.bs.modal', function () {
        $('#busca-nome').val('');
        $('#busca-cpf').val('');
        limparResultadosBusca();
      });
    });

    // ========== CRIAR ATENDIMENTO POR CPF ==========
    function abrirModalCriarAtendimentoCPF() {
      $('#modalCriarAtendimentoCPF').modal('show');
      setTimeout(() => { $('#cpfAtendimentoInput').focus(); }, 300);
    }

    // Abre o cadastro de paciente já preenchendo o CPF informado
    function abrirCadastroComCPF(cpfSomenteDigitos) {
      // Fechar modal de atendimento por CPF
      $('#modalCriarAtendimentoCPF').modal('hide');

      // Abrir modal de cadastro e preencher o CPF
      setTimeout(() => {
        abrirModalCadastroPaciente();
        const cpfFormatado = formatarCPF(cpfSomenteDigitos);
        $('#modalCpf').val(cpfFormatado).trigger('input');
        // Focar no nome para acelerar o cadastro
        setTimeout(() => { $('#modalNome').focus(); }, 200);
      }, 200);
    }

    $('#modalCriarAtendimentoCPF').on('shown.bs.modal', function() {
      $('#cpfAtendimentoInput').mask('000.000.000-00');
    });

    // Fluxo em duas etapas: buscar → confirmar
    $('#btnConfirmarCriarAtendimento').on('click', function() {
      const btn = $(this);
      const estado = btn.data('state') || 'buscar';

      if (estado === 'buscar') {
        const cpf = ($('#cpfAtendimentoInput').val() || '').replace(/\D/g, '');
        if (cpf.length !== 11) {
          alert('CPF deve ter 11 dígitos.');
          $('#cpfAtendimentoInput').focus();
          return;
        }

        const textoOriginal = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Buscando...');

        // Buscar paciente por CPF
        fetch('/api/pacientes/buscar/cpf?valor=' + encodeURIComponent(cpf))
          .then(r => r.json())
          .then(data => {
            if (!data.success || !data.pacientes || data.pacientes.length === 0) {
              // Não encontrou: oferecer cadastro imediato com CPF preenchido
              abrirCadastroComCPF(cpf);
              // Interromper cadeia sem exibir alerta de erro
              return Promise.reject({ skipAlert: true });
            }
            const p = data.pacientes[0];

            // Buscar detalhes completos do paciente
            return fetch(`/api/pacientes/${p.id}`).then(r => r.json());
          })
          .then(det => {
            if (!det.success || !det.paciente) throw new Error('Não foi possível carregar os dados do paciente.');
            const paciente = det.paciente;

            // Preencher prévia
            $('#prevNome').text(paciente.nome || '-');
            $('#prevCpf').text(formatarCPF(paciente.cpf) || '-');
            $('#prevDataNasc').text(paciente.data_nascimento || '-');
            $('#prevMae').text(paciente.filiacao || '-');
            $('#prevSexo').text(paciente.sexo || '-');
            $('#prevSUS').text(paciente.cartao_sus || '-');
            $('#prevTelefone').text(paciente.telefone || '-');
            const enderecoCompleto = [paciente.endereco, paciente.bairro, paciente.municipio].filter(Boolean).join(' - ');
            $('#prevEndereco').text(enderecoCompleto || '-');

            $('#previewAtendimentoPaciente').slideDown(150);
            btn.data('state', 'confirmar');
            btn.data('pacienteId', paciente.id);
            btn.html('<i class="fas fa-check mr-1"></i>Confirmar criação da ficha');
          })
          .catch(err => {
            if (err && err.skipAlert) return; // fluxo já tratado (cadastro aberto)
            alert(err && err.message ? err.message : 'Erro ao buscar paciente.');
          })
          .finally(() => {
            btn.prop('disabled', false);
          });
      } else {
        // Confirmar criação
        const pacienteId = btn.data('pacienteId');
        if (!pacienteId) {
          alert('Paciente não selecionado. Tente novamente.');
          return;
        }

        const textoOriginal = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Criando...');

        const agora = new Date();
        const dataAtual = agora.toISOString().split('T')[0];
        const horaAtual = agora.toTimeString().slice(0, 5);

        fetch('/api/atendimentos/cadastrar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            paciente_id: pacienteId,
            data_atendimento: dataAtual,
            hora_atendimento: horaAtual
          })
        })
        .then(r => r.json())
        .then(resp => {
          if (resp && resp.success) {
            alert('✓ Atendimento criado com sucesso! ID: ' + resp.atendimento.id);
            $('#modalCriarAtendimentoCPF').modal('hide');
            // reset
            $('#cpfAtendimentoInput').val('');
            $('#previewAtendimentoPaciente').hide();
            btn.data('state', 'buscar').data('pacienteId', null).html('Criar Atendimento');
          } else {
            throw new Error((resp && resp.message) || 'Erro ao criar atendimento');
          }
        })
        .catch(err => {
          alert(err.message || 'Erro ao criar atendimento');
        })
        .finally(() => {
          btn.prop('disabled', false).html(textoOriginal);
        });
      }
    });

    // Resetar pré-visualização ao alterar o CPF ou ao fechar o modal
    $('#cpfAtendimentoInput').on('input', function() {
      $('#previewAtendimentoPaciente').hide();
      const btn = $('#btnConfirmarCriarAtendimento');
      btn.data('state', 'buscar').data('pacienteId', null).html('Criar Atendimento');
    });
    $('#modalCriarAtendimentoCPF').on('hidden.bs.modal', function() {
      $('#previewAtendimentoPaciente').hide();
      const btn = $('#btnConfirmarCriarAtendimento');
      btn.data('state', 'buscar').data('pacienteId', null).html('Criar Atendimento');
      $('#cpfAtendimentoInput').val('');
    });
  </script>

  <script>
    function carregarFichasReferenciaAtivas() {
      const container = $('#fichas-referencia-ativas');
      const badge = $('#badgeTotalFichasAtivas');
      if (!container.length) return;

      container.html('<div class="p-3"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando...</div>');

      fetch('/api/fichas-referencia/ativas')
        .then(r => r.json())
        .then(data => {
          if (!data || data.success !== true) {
            throw new Error('Falha ao carregar fichas ativas');
          }

          const fichas = data.fichas || [];
          badge.text(fichas.length);

          if (fichas.length === 0) {
            container.html('<div class="p-3 text-muted">Nenhuma ficha de referência pendente para atendimentos ativos.</div>');
            return;
          }

          // Agrupar por atendimento
          const grupos = {};
          fichas.forEach(f => {
            const key = f.atendimento_id || 'sem_atendimento';
            if (!grupos[key]) grupos[key] = [];
            grupos[key].push(f);
          });

          // Ordenar grupos por última ficha (mais recente primeiro)
          const ordenarPorDataHoraDesc = (a, b) => {
            const da = new Date(`${a.data}T${(a.hora || '00:00')}`);
            const db = new Date(`${b.data}T${(b.hora || '00:00')}`);
            return db - da;
          };

          const gruposOrdenados = Object.keys(grupos).sort((ga, gb) => {
            const la = (grupos[ga] || []).slice().sort(ordenarPorDataHoraDesc)[0];
            const lb = (grupos[gb] || []).slice().sort(ordenarPorDataHoraDesc)[0];
            const da = la ? new Date(`${la.data}T${(la.hora || '00:00')}`) : new Date(0);
            const db = lb ? new Date(`${lb.data}T${(lb.hora || '00:00')}`) : new Date(0);
            return db - da;
          });

          // Toolbar expandir/recolher
          let html = '';
          html += '<div class="d-flex justify-content-between align-items-center p-3">';
          html += '  <div class="text-muted small">';
          html += '    <i class="fas fa-info-circle mr-1"></i> Agrupado por atendimento';
          html += '  </div>';
          html += '  <div class="btn-group btn-group-sm" role="group">';
          html += '    <button id="btnExpandirTodasFichas" class="btn btn-outline-secondary"><i class="fas fa-chevron-down mr-1"></i>Expandir tudo</button>';
          html += '    <button id="btnRecolherTodasFichas" class="btn btn-outline-secondary"><i class="fas fa-chevron-up mr-1"></i>Recolher tudo</button>';
          html += '  </div>';
          html += '</div>';

          // Renderizar cada atendimento como um card com tabela colapsável
          gruposOrdenados.forEach(key => {
            const lista = grupos[key].slice().sort(ordenarPorDataHoraDesc);
            const f0 = lista[0] || {};
            const atendimentoId = key;
            const pacienteNome = f0.paciente_nome || 'Paciente';
            const pacienteId = f0.paciente_id;
            const statusAtendimento = f0.status_atendimento || '-';
            const collapseId = `attn-${atendimentoId}`;
            const total = lista.length;

            html += '<div class="attn-card">';
            html += '  <div class="card-header bg-light d-flex justify-content-between align-items-center attn-group-header">';
            html += '    <div class="d-flex align-items-center">';
            html += `      <button class="btn btn-sm btn-toggle btn-outline-secondary mr-2" data-toggle="collapse" data-target="#${collapseId}" aria-expanded="true" aria-controls="${collapseId}">`;
            html += '        <i class="fas fa-chevron-down"></i>';
            html += '      </button>';
            html += `      <div><div class="font-weight-bold text-primary">${pacienteNome}</div>`;
            html += `      <div class="small text-muted">Atendimento #${atendimentoId} • Status: ${statusAtendimento}</div></div>`;
            html += '    </div>';
            html += '    <div class="d-flex align-items-center">';
            html += `      <span class="badge badge-primary mr-2">${total} ficha${total !== 1 ? 's' : ''}</span>`;
            html += '      <div class="btn-group btn-group-sm" role="group">';
            html += `        <a class="btn btn-outline-info" href="/ficha_geral_paciente?paciente_id=${pacienteId}" target="_blank" title="Abrir ficha do paciente"><i class="fas fa-file-alt"></i></a>`;
            html += `        <button class="btn btn-outline-success" onclick="criarFichaAtendimento(${pacienteId})" title="Criar ficha de atendimento"><i class="fas fa-plus-circle"></i></button>`;
            html += '      </div>';
            html += '    </div>';
            html += '  </div>';

            html += `  <div id="${collapseId}" class="collapse show attn-collapse">`;
            html += '    <div class="table-responsive">';
            html += '      <table class="table table-sm table-hover mb-0 table-fichas">';
            html += '        <thead class="thead-light">';
            html += '          <tr>';
            html += '            <th style="width: 140px;">Data/Hora</th>';
            html += '            <th>Descrição</th>';
            html += '            <th style="width: 220px;">Unidade de Referência</th>';
            html += '            <th style="width: 180px;">Médico</th>';
            html += '            <th style="width: 120px;">Ações</th>';
            html += '          </tr>';
            html += '        </thead>';
            html += '        <tbody>';

            lista.forEach(f => {
              const dataHora = `${f.data} ${f.hora || ''}`.trim();
              const medicoNome = f.medico_nome || '-';
              const unidade = f.unidade_referencia || '-';
              const desc = (f.procedimento || f.texto_referencia || '-');
              html += '          <tr>';
              html += `            <td class="text-nowrap">${dataHora}</td>`;
              html += `            <td>${desc}</td>`;
              html += `            <td>${unidade}</td>`;
              html += `            <td class="text-nowrap">${medicoNome}</td>`;
              html += '            <td class="text-right">';
              html += `              <button class="btn btn-sm btn-outline-info mr-1" title="Abrir ficha de referência" onclick="abrirModalFichaReferencia(this)" data-ficha-id="${f.id || ''}" data-ficha-json='${JSON.stringify({
                id: (typeof f.id!=="undefined"?f.id:null),
                data: (f.data||null),
                hora: (f.hora||null),
                paciente_id: (f.paciente_id||null),
                paciente_nome: (f.paciente_nome||null),
                status_atendimento: (f.status_atendimento||null),
                procedimento: (f.procedimento||null),
                texto_referencia: (f.texto_referencia||null),
                unidade_referencia: (f.unidade_referencia||null),
                medico_nome: (f.medico_nome||null)
              }).replace(/'/g, '&apos;')}'>`;
              html += '                <i class="fas fa-eye"></i>';
              html += '              </button>';
              html += `              <a class="btn btn-sm btn-outline-primary" href="/ficha_geral_paciente?paciente_id=${f.paciente_id}" target="_blank" title="Abrir ficha do paciente"><i class="fas fa-file-alt"></i></a>`;
              html += '            </td>';
              html += '          </tr>';
            });

            html += '        </tbody>';
            html += '      </table>';
            html += '    </div>';
            html += '  </div>';
            html += '</div>';
          });

          container.html(html);

          // Controles globais expandir/recolher
          $('#btnExpandirTodasFichas').off('click').on('click', function() {
            $('.attn-collapse').collapse('show');
          });
          $('#btnRecolherTodasFichas').off('click').on('click', function() {
            $('.attn-collapse').collapse('hide');
          });
        })
        .catch(err => {
          container.html('<div class="p-3 text-danger">Erro ao carregar fichas de referência ativas.</div>');
          console.error(err);
        });
    }

    // ====== BUSCAR FICHAS DE ATENDIMENTO ======
    function buscarFichasAtendimento() {
      const termo = ($('#input-busca-fichas').val() || '').trim();
      if (!termo) {
        alert('Digite um nome (mín. 3 letras) ou CPF completo.');
        $('#input-busca-fichas').focus();
        return;
      }

      const cpfSomenteDigitos = termo.replace(/\D/g, '');
      let urlPacientes;
      if (cpfSomenteDigitos.length === 11) {
        urlPacientes = '/api/pacientes/buscar/cpf?valor=' + encodeURIComponent(cpfSomenteDigitos);
      } else if (termo.length >= 3) {
        urlPacientes = '/api/pacientes/buscar/nome?valor=' + encodeURIComponent(termo);
      } else {
        alert('Para busca por nome, digite ao menos 3 caracteres.');
        return;
      }

      const $btn = $('#btn-busca-fichas');
      const btnOriginal = $btn.html();
      $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Buscando...');
      $('#resultado-fichas').html('<div class="text-center py-4"><div class="spinner-border text-primary"></div><div class="mt-2 small text-muted">Buscando...</div></div>');

      fetch(urlPacientes)
        .then(r => r.json())
        .then(data => {
          if (!data.success || !data.pacientes || data.pacientes.length === 0) {
            $('#resultado-fichas').html('<div class="alert alert-warning">Nenhum paciente encontrado.</div>');
            return;
          }

          // Para cada paciente, buscar seus atendimentos
          const pacientes = data.pacientes;
          const promises = pacientes.map(p => 
            fetch(`/api/pacientes/${p.id}/atendimentos`).then(r => r.json()).then(at => ({ paciente: p, atendimentos: (at && at.success && at.atendimentos) ? at.atendimentos : [] }))
          );

          return Promise.all(promises).then(lista => {
            if (!lista || lista.length === 0) {
              $('#resultado-fichas').html('<div class="alert alert-warning">Nenhum atendimento encontrado.</div>');
              return;
            }

            let html = '';
            lista.forEach(item => {
              const paciente = item.paciente;
              const atendimentos = item.atendimentos || [];
              const cpfFmt = paciente.cpf ? paciente.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : 'Não informado';

              html += '<div class="card border-0 shadow-sm mb-3">';
              html += '  <div class="card-header bg-light d-flex justify-content-between align-items-center">';
              html += `    <div><strong>${paciente.nome || 'Paciente'}</strong><br><small class="text-muted">CPF: ${cpfFmt}</small></div>`;
              html += `    <span class="badge badge-primary">${atendimentos.length} atendimento${atendimentos.length !== 1 ? 's' : ''}</span>`;
              html += '  </div>';
              html += '  <div class="card-body p-0">';

              if (atendimentos.length === 0) {
                html += '<div class="p-3 text-muted">Sem atendimentos.</div>';
              } else {
                html += '<div class="list-group list-group-flush">';
                atendimentos.forEach(a => {
                  const data = a.data_atendimento ? a.data_atendimento.split('-').reverse().join('/') : '-';
                  const hora = a.hora_atendimento || '-';
                  const status = a.status || '-';
                  const risco = a.classificacao_risco || '-';
                  const urlImp = `/imprimir/ficha_atendimento/${a.id}`;
                  html += '<div class="list-group-item d-flex justify-content-between align-items-center">';
                  html += `  <div><div class="font-weight-bold">Atendimento #${a.id}</div><div class="small text-muted">${data} ${hora} • Status: ${status} • Risco: ${risco}</div></div>`;
                  html += `  <div><a class="btn btn-sm btn-outline-primary" href="${urlImp}" target="_blank" title="Imprimir ficha"><i class="fas fa-print mr-1"></i>Imprimir</a></div>`;
                  html += '</div>';
                });
                html += '</div>';
              }

              html += '  </div>';
              html += '</div>';
            });

            $('#resultado-fichas').html(html || '<div class="alert alert-warning">Nenhum atendimento encontrado.</div>');
          });
        })
        .catch(err => {
          console.error(err);
          $('#resultado-fichas').html('<div class="alert alert-danger">Erro ao buscar fichas de atendimento.</div>');
        })
        .finally(() => {
          $btn.prop('disabled', false).html(btnOriginal);
        });
    }
  </script>
  <!-- Modal: Visualizar Ficha de Referência -->
  <div class="modal fade" id="modalFichaReferencia" tabindex="-1" role="dialog" aria-labelledby="modalFichaReferenciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalFichaReferenciaLabel">
            <i class="fas fa-eye mr-2"></i>Ficha de Referência
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="fichaRefConteudo">
            <div class="text-center text-muted py-4">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Buscar Paciente -->
  <div class="modal fade" id="modalBuscarPaciente" tabindex="-1" role="dialog" aria-labelledby="modalBuscarPacienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">        <div class="modal-header">
          <h5 class="modal-title" id="modalBuscarPacienteLabel">
            <i class="fas fa-search mr-2"></i>Buscar Paciente
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div><div class="modal-body">
          <!-- Formulário de Busca -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="busca-nome">Buscar por Nome:</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="busca-nome" 
                         placeholder="Digite o nome do paciente">
                  <div class="input-group-append">
                    <button class="btn btn-primary" type="button" onclick="buscarPorNome()">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
                <small class="form-text text-muted">Busca parcial pelo nome</small>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="busca-cpf">Buscar por CPF:</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="busca-cpf" 
                         placeholder="000.000.000-00">
                  <div class="input-group-append">
                    <button class="btn btn-primary" type="button" onclick="buscarPorCPF()">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
                <small class="form-text text-muted">CPF completo (11 dígitos)</small>
              </div>
            </div>
          </div>

          <!-- Loading -->
          <div id="loading-busca" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Buscando...</span>
            </div>
            <p class="mt-2">Buscando paciente...</p>
          </div>

          <!-- Resultados da Busca -->
          <div id="resultados-busca" style="display: none;">
            <hr>
            <h6 class="mb-3">Pacientes Encontrados:</h6>
            <div id="lista-pacientes"></div>
          </div>

          <!-- Opção para Cadastrar Novo Paciente -->
          <div id="opcao-cadastrar" style="display: none;">
            <hr>
            <div class="alert alert-info">
              <i class="fas fa-info-circle mr-2"></i>
              Paciente não encontrado. Deseja cadastrar um novo paciente?
            </div>
            <button type="button" class="btn btn-success" onclick="abrirRegistroPaciente()">
              <i class="fas fa-plus mr-2"></i>Cadastrar Novo Paciente
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============ MODAL CADASTRO DE PACIENTE ============
      // Função para abrir modal de cadastro de paciente
    function abrirModalCadastroPaciente() {
      $('#modalCadastroPaciente').modal('show');
      $('#formCadastroPaciente')[0].reset();

      // Pequeno delay para garantir que o modal esteja totalmente carregado
      setTimeout(() => {
        $('#modalNome').focus();
      }, 500);
    }    // Máscaras para os campos do modal
    $(document).ready(function() {
      $('#modalCadastroPaciente #modalCpf').mask('000.000.000-00');
      $('#modalCadastroPaciente #modalTelefone').mask('(00) 00000-0000');
      $('#modalCadastroPaciente #modalCartaoSus').mask('000000000000000');

      // Máscaras para campos de busca
      $('#busca-cpf').mask('000.000.000-00');
      $('#busca-cartao-sus').mask('000000000000000');

      // Eventos para busca com Enter
      $('#busca-rapida').on('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarPacienteRapido();
        }
      });

      $('#busca-nome').on('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarPorNome();
        }
      });

      $('#busca-cpf').on('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarPorCPF();
        }
      });

      $('#busca-filiacao').on('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarPorFiliacao();
        }
      });

      $('#busca-cartao-sus').on('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarPorCartaoSUS();
        }
      });

      // Limpar formulário quando modal for fechado
      $('#modalCadastroPaciente').on('hidden.bs.modal', function () {
        $('#formCadastroPaciente')[0].reset();
        $('#btnSalvarPaciente').html('<i class="fas fa-save mr-1"></i>Cadastrar Paciente').prop('disabled', false);
        $('#rowTipoPrioridade').hide(); // Ocultar campo de tipo de prioridade ao fechar
      });

      // Toggle para mostrar/ocultar tipo de prioridade
      $('#modalPrioridade').on('change', function() {
        if ($(this).is(':checked')) {
          $('#rowTipoPrioridade').slideDown();
        } else {
          $('#rowTipoPrioridade').slideUp();
          $('#modalDescPrioridade').val(''); // Limpar seleção
        }
      });
    });    // Função para salvar paciente
    $('#btnSalvarPaciente').click(function() {
      const form = document.getElementById('formCadastroPaciente');

      // Adicionar classe de validação
      form.classList.add('was-validated');

      if (!form.checkValidity()) {
        // Scroll para o primeiro campo inválido
        const primeiroCampoInvalido = form.querySelector(':invalid');
        if (primeiroCampoInvalido) {
          primeiroCampoInvalido.scrollIntoView({ behavior: 'smooth', block: 'center' });
          primeiroCampoInvalido.focus();
        }
        return;
      }

      const formData = new FormData(form);
      const dados = {};

      // Coletar dados do formulário (forçando MAIÚSCULAS em texto)
      for (let [key, value] of formData.entries()) {
        if (typeof value === 'string') value = value.trim();
        if (value !== '') {
          if (typeof value === 'string') {
            value = value.toUpperCase();
          }
          dados[key] = value;
        }
      }

      // Adicionar prioridade (checkbox não entra em FormData se não marcado)
      dados.prioridade = $('#modalPrioridade').is(':checked');

      // Se não tem prioridade, limpar desc_prioridade
      if (!dados.prioridade) {
        delete dados.desc_prioridade;
      }

      // Validações básicas - mais amigáveis
      if (!dados.nome) {
        $('#modalNome').focus();
        alert('Por favor, preencha o nome completo');
        return;
      }

      if (!dados.cpf) {
        $('#modalCpf').focus();
        alert('Por favor, preencha o CPF');
        return;
      }

      // Validação básica do CPF (apenas se preenchido)
      const cpfLimpo = dados.cpf.replace(/\D/g, '');
      if (cpfLimpo.length > 0 && cpfLimpo.length < 11) {
        $('#modalCpf').focus();
        alert('CPF deve ter 11 dígitos');
        return;
      }
      if (cpfLimpo.length === 11 && /^(\d)\1+$/.test(cpfLimpo)) {
        $('#modalCpf').focus();
        alert('CPF inválido (números repetidos)');
        return;
      }

      if (!dados.data_nascimento) {
        $('#modalDataNascimento').focus();
        alert('Por favor, preencha a data de nascimento');
        return;
      }

      if (!dados.sexo) {
        $('#modalSexo').focus();
        alert('Por favor, selecione o sexo');
        return;
      }

      // Mostrar loading
      const btnSalvar = $('#btnSalvarPaciente');
      const textoOriginal = btnSalvar.html();
      btnSalvar.html('<i class="fas fa-spinner fa-spin mr-1"></i>Cadastrando...').prop('disabled', true).addClass('disabled');

      // Enviar dados para o servidor
      fetch('/api/pacientes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
      })
      .then(response => response.json())
      .then(data => {
        btnSalvar.html(textoOriginal).prop('disabled', false);
        
        if (data.success) {
          // Sucesso no cadastro
          alert('✓ Paciente cadastrado com sucesso!');

          // Guardar dados do paciente recém criado
          const pacienteIdCriado = data.paciente_id || (data.paciente && data.paciente.id);
          const pacienteNomeCriado = (data.paciente && data.paciente.nome) || dados.nome || '';

          // Fechar modal de cadastro
          $('#modalCadastroPaciente').modal('hide');

          // Perguntar se deseja criar atendimento
          if (pacienteIdCriado) {
            $('#nomePacienteCriado').text(pacienteNomeCriado || 'o paciente');
            $('#modalPerguntaCriarAtendimento').data('pacienteId', pacienteIdCriado).modal('show');
          }

          // Limpar a classe de validação para próximos usos
          $('#formCadastroPaciente')[0].classList.remove('was-validated');

          // Se existir, atualizar lista de pacientes
          if (typeof atualizarListaPacientes === 'function') {
            atualizarListaPacientes();
          }
        } else {
          // Mostrar erro de forma amigável
          let mensagemErro = data.message || 'Erro ao cadastrar paciente';

          // Simplificar mensagens de erro comuns
          if (mensagemErro.includes('CPF já cadastrado')) {
            mensagemErro = 'Este CPF já está cadastrado no sistema';
            $('#modalCpf').focus();
          } else if (mensagemErro.includes('obrigatório')) {
            mensagemErro = 'Preencha todos os campos obrigatórios';
          }

          alert(mensagemErro);

          // Resetar botão
          btnSalvar.html(textoOriginal).prop('disabled', false).removeClass('disabled');
        }
      })
      .catch(error => {
        btnSalvar.html(textoOriginal).prop('disabled', false).removeClass('disabled');
        console.error('Erro:', error);
        alert('Erro de conexão. Verifique sua internet e tente novamente.');
      });
    });

    // Confirmar criação de atendimento após cadastro
    $('#btnConfirmarCriarAtendimentoPosCadastro').off('click').on('click', function() {
      const btn = $(this);
      const original = btn.html();
      const pacienteId = $('#modalPerguntaCriarAtendimento').data('pacienteId');
      if (!pacienteId) { $('#modalPerguntaCriarAtendimento').modal('hide'); return; }

      btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>Criando...');

      const agora = new Date();
      const dataAtual = agora.toISOString().split('T')[0];
      const horaAtual = agora.toTimeString().slice(0, 5);

      fetch('/api/atendimentos/cadastrar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          paciente_id: pacienteId,
          data_atendimento: dataAtual,
          hora_atendimento: horaAtual
        })
      })
      .then(r => r.json())
      .then(resp => {
        if (resp && resp.success) {
          alert('✓ Atendimento criado com sucesso! ID: ' + resp.atendimento.id);
          $('#modalPerguntaCriarAtendimento').modal('hide');
        } else {
          throw new Error((resp && resp.message) || 'Erro ao criar atendimento');
        }
      })
      .catch(err => {
        alert(err.message || 'Erro ao criar atendimento');
      })
      .finally(() => {
        btn.prop('disabled', false).html(original);
      });
    });

    // Função para validar CPF (básica)
    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]/g, '');
      
      if (cpf.length !== 11) return false;
      if (/^(\d)\1+$/.test(cpf)) return false; // Todos iguais
      
      // Validação básica dos dígitos verificadores
      let soma = 0;
      for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
      }
      let resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      
      soma = 0;
      for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
      }
      resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(10))) return false;
      
      return true;
    }    // Pequena ajuda visual para CPF
    $('#modalCadastroPaciente #modalCpf').on('input', function() {
      const cpf = $(this).val().replace(/\D/g, '');
      const helpText = $(this).siblings('small');

      if (cpf.length === 0) {
        helpText.text('Digite 11 dígitos');
        helpText.removeClass('text-success text-danger');
      } else if (cpf.length < 11) {
        helpText.text(`Faltam ${11 - cpf.length} dígitos`);
        helpText.removeClass('text-success').addClass('text-warning');
      } else if (cpf.length === 11) {
        if (/^(\d)\1+$/.test(cpf)) {
          helpText.text('CPF inválido');
          helpText.removeClass('text-success').addClass('text-danger');
        } else {
          helpText.text('CPF válido');
          helpText.removeClass('text-danger text-warning').addClass('text-success');
        }
      } else {
        helpText.text('CPF muito longo');
        helpText.removeClass('text-success').addClass('text-danger');
      }
    });
    
    // ====== MODAL FICHA DE REFERÊNCIA ======
    function abrirModalFichaReferencia(btn) {
      try {
        const id = btn.getAttribute('data-ficha-id');
        const jsonAttr = btn.getAttribute('data-ficha-json');
        let ficha = null;
        if (jsonAttr) {
          ficha = JSON.parse(jsonAttr.replace(/&apos;/g, "'"));
        }

        $('#modalFichaReferencia').modal('show');
        const $conteudo = $('#fichaRefConteudo');
        $conteudo.html('<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin"></i></div>');

        const data = (ficha && ficha.data) ? ficha.data : '-';
        const hora = (ficha && ficha.hora) ? ficha.hora : '-';
        const pacienteNome = (ficha && ficha.paciente_nome) ? ficha.paciente_nome : '-';
        const procedimento = (ficha && ficha.procedimento) ? ficha.procedimento : null;
        const texto = (ficha && ficha.texto_referencia) ? ficha.texto_referencia : null;
        const unidade = (ficha && ficha.unidade_referencia) ? ficha.unidade_referencia : '-';
        const medico = (ficha && ficha.medico_nome) ? ficha.medico_nome : '-';
        const statusAtt = (ficha && ficha.status_atendimento) ? ficha.status_atendimento : '-';

        const descricao = procedimento || texto || '-';

        const html = [
          '<div class="container-fluid">',
          '  <div class="row">',
          '    <div class="col-12 mb-3">',
          `      <h5 class="mb-1 text-primary">${pacienteNome}</h5>`,
          `      <div class="small text-muted">${data} ${hora} • Status atendimento: ${statusAtt}</div>`,
          '    </div>',
          '  </div>',
          '  <div class="row">',
          '    <div class="col-md-8">',
          '      <div class="card border-0 shadow-sm mb-3">',
          '        <div class="card-header bg-light"><strong>Descrição</strong></div>',
          `        <div class="card-body"><div class="text-wrap">${descricao}</div></div>`,
          '      </div>',
          '    </div>',
          '    <div class="col-md-4">',
          '      <div class="card border-0 shadow-sm mb-3">',
          '        <div class="card-header bg-light"><strong>Unidade de Referência</strong></div>',
          `        <div class="card-body">${unidade}</div>`,
          '      </div>',
          '      <div class="card border-0 shadow-sm mb-3">',
          '        <div class="card-header bg-light"><strong>Médico</strong></div>',
          `        <div class="card-body">${medico}</div>`,
          '      </div>',
          '    </div>',
          '  </div>',
          '</div>'
        ].join('');

        $conteudo.html(html);
      } catch (e) {
        console.error(e);
        alert('Não foi possível abrir a ficha de referência.');
      }
    }
  </script>

</body>
</html>
