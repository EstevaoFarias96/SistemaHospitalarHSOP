<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolu√ß√£o do Paciente</title>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
    <meta name="theme-color" content="#2c3e50" />

    <!-- JS ‚Äì ordem de depend√™ncia preservada com defer -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Seu script, que depende das bibliotecas acima -->
    <script src="/static/js/clinica_medico.js?v=20250627" defer></script>
    <script src="/static/js/informacoes_alta.js" defer></script>
    <script src="/static/js/modal_hda_fix.js" defer></script>
    <script src="/static/js/modals_medico_fix.js" defer></script>
    
    <!-- Script para interceptar e substituir scroll.js -->
    <script>
        // Interceptar scripts antes que sejam carregados
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
            const element = originalCreateElement.call(document, tagName);
            
            if (tagName.toLowerCase() === 'script') {
                const originalSetAttribute = element.setAttribute;
                element.setAttribute = function(name, value) {
                    if (name === 'src' && value && value.includes('scroll.js')) {
                        console.log('Interceptado carregamento de scroll.js - Substituindo com implementa√ß√£o moderna');
                        // N√£o carregamos o script original
                        return element;
                    }
                    return originalSetAttribute.call(this, name, value);
                };
            }
            
            return element;
        };
        
        // Nota: As fun√ß√µes de observadores foram movidas para clinica_medico.js
    </script>
    
    <style>
        /* Vari√°veis de cores - harmonizadas com o padr√£o do sistema */
        :root {
            --azul-principal: #4A90E2;
            --azul-claro: #E8F4FF;
            --azul-medio: #7AB8F5;
            --branco-gelo: #F8FCFF;
            --cinza-texto: #4A5568;
            --cinza-claro: #E2E8F0;
            --sombra-suave: 0 2px 12px rgba(74, 144, 226, 0.08);
            --sombra-media: 0 4px 20px rgba(74, 144, 226, 0.12);
            
            /* Manter compatibilidade com c√≥digo existente */
            --primary-dark: #357ABD;
            --primary-main: #4A90E2;
            --primary-light: #7AB8F5;
            --accent: #1565c0;
            --hover-light: rgba(255,255,255,0.08);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.85);
            --shadow-soft: var(--sombra-suave);
            --shadow-strong: var(--sombra-media);
            --gradient-primary: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
            --gradient-accent: linear-gradient(135deg, var(--accent), var(--azul-medio));
            --primary-main-rgb: 74, 144, 226;
            --primary-light-rgb: 122, 184, 245;
        }
        
        body {
            background: linear-gradient(135deg, var(--branco-gelo) 0%, var(--azul-claro) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .sidebar:hover + .main-content {
            margin-left: 200px;
        }

        /* Estilos globais para cards e headers */
        .card {
            border: 0;
            border-radius: 16px;
            box-shadow: var(--sombra-media);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            background: white;
            position: relative;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 28px rgba(74, 144, 226, 0.18);
        }

        .card-header {
            border-bottom: none;
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio)) !important;
            color: white !important;
            border-radius: 16px 16px 0 0;
            padding: 20px 24px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--azul-medio), var(--azul-principal));
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            border: none;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #ffb300, #ffc107);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #10B981);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .btn-info {
            background: linear-gradient(135deg, #0EA5E9, #0284C7);
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #0284C7, #0EA5E9);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .badge {
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-radius: 999px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 12px;
        }

        /* Estilos para prescri√ß√µes - modernizados */
        .prescricao-container {
            transition: all 0.3s ease;
            border-radius: 12px;
            overflow: visible;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
            background-color: #fff;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .prescricao-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        /* Novo estilo para prescri√ß√µes do dia */
        .prescricao-hoje {
            border-left: 4px solid #4299e1;
            background: linear-gradient(to right, rgba(66, 153, 225, 0.02), transparent 20%);
        }

        .prescricao-antiga {
            border-left: 4px solid #e2e8f0;
        }

        .prescricao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid #edf2f7;
            background: linear-gradient(to right, #f8fafc, #fff);
            position: relative;
            z-index: 2;
            border-radius: 12px 12px 0 0;
        }

        .prescricao-body {
            padding: 1.5rem;
            position: relative;
            background: #fff;
        }

        /* Estilos para as a√ß√µes r√°pidas */
        .quick-actions {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(0deg, var(--primary-dark) 0%, transparent 100%);
        }

        .quick-actions .action-btn {
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            opacity: 0.9;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .quick-actions .action-btn:hover {
            opacity: 1;
            color: var(--text-primary);
            background-color: var(--hover-light);
            transform: translateX(5px);
            border-color: rgba(255,255,255,0.1);
        }

        .menu-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .nav-pills {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Resto dos estilos existentes */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        
        /* Header Dashboard */
        .dashboard-header {
            background: white;
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: var(--sombra-suave);
            border-left: 5px solid var(--azul-principal);
        }
        
        .dashboard-header h2 {
            color: var(--azul-principal);
            font-size: 28px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }
        
        .dashboard-header p {
            color: var(--cinza-texto);
            margin: 0;
            font-size: 14px;
        }
        
        /* Estilos para informa√ß√µes do paciente */
        .paciente-info {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--sombra-suave);
        }
        
        .paciente-info .info-item {
            padding: 8px 0;
            color: var(--cinza-texto);
            font-size: 14px;
        }
        
        .paciente-info .info-item strong {
            color: var(--azul-principal);
            margin-right: 8px;
        }
        .table-medicamentos {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background: linear-gradient(135deg, #f8fafc, #edf2f7);
            color: #2d3748;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #edf2f7;
        }
        
        .table tbody td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #edf2f7;
            color: #4a5568;
            font-size: 0.9rem;
        }
        
        .table tbody tr:hover {
            background: #f7fafc;
            transition: background 0.2s ease;
        }
        
        .alerta-alergia {
            border: 2px solid #ffc107;
            padding: 8px 12px;
            display: none;
            font-weight: bold;
            color: #856404;
            background-color: #fff3cd;
            border-radius: 8px;
            margin-top: 8px;
        }
        /* Estilos adicionais para a tabela de evolu√ß√µes */
        .table-medicamentos td {
            vertical-align: middle;
            padding: 10px;
        }
        
        /* Estilos para as tabelas de medicamentos nas prescri√ß√µes - removidos (j√° definidos acima) */
        
        .prescricao-section {
            padding: 1.5rem;
            position: relative;
            background: #fff;
            margin: 0.5rem;
            border-radius: 8px;
            border: 1px solid #edf2f7;
        }

        .prescricao-section:not(:last-child) {
            margin-bottom: 0.75rem;
        }

        /* Cores espec√≠ficas para cada tipo de se√ß√£o */
        .prescricao-section[data-tipo="dieta"] {
            border-left: 3px solid #48bb78;
            background: linear-gradient(to right, rgba(72, 187, 120, 0.02), transparent 15%);
        }

        .prescricao-section[data-tipo="medicamentos"] {
            border-left: 3px solid #4299e1;
            background: linear-gradient(to right, rgba(66, 153, 225, 0.02), transparent 15%);
        }

        .prescricao-section[data-tipo="procedimentos"] {
            border-left: 3px solid #ed8936;
            background: linear-gradient(to right, rgba(237, 137, 54, 0.02), transparent 15%);
        }

        .prescricao-section[data-tipo="multi"] {
            border-left: 3px solid #9f7aea;
            background: linear-gradient(to right, rgba(159, 122, 234, 0.02), transparent 15%);
        }
        
        .prescricao-section-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* √çcones para cada tipo de se√ß√£o */
        .prescricao-section[data-tipo="dieta"] .prescricao-section-title::before {
            content: 'üçΩÔ∏è';
            font-size: 1rem;
        }

        .prescricao-section[data-tipo="medicamentos"] .prescricao-section-title::before {
            content: 'üíä';
            font-size: 1rem;
        }

        .prescricao-section[data-tipo="procedimentos"] .prescricao-section-title::before {
            content: 'üè•';
            font-size: 1rem;
        }

        .prescricao-section[data-tipo="multi"] .prescricao-section-title::before {
            content: 'üë•';
            font-size: 1rem;
        }
        
        .prescricao-section-content {
            color: #4a5568;
            font-size: 0.95rem;
            line-height: 1.6;
            background: #fafafa;
            padding: 1rem;
            border-radius: 6px;
        }
        
        /* Estilo para tabelas dentro das se√ß√µes */
        .tabela-medicamentos-prescricao {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .tabela-medicamentos-prescricao thead th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #edf2f7;
        }

        .tabela-medicamentos-prescricao tbody td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #edf2f7;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .tabela-medicamentos-prescricao tbody tr:hover {
            background: #f7fafc;
        }
        
        .prescricao-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-print-discreto {
            background: #f7fafc;
            border: 1px solid #edf2f7;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-print-discreto:hover {
            background: #fff;
            border-color: #e2e8f0;
            color: #2d3748;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .btn-print-discreto:active {
            transform: scale(0.98);
        }

        .btn-print-discreto i {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .data-header {
            background-color: #6c757d;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        /* Formata√ß√£o especial para a coluna de texto de evolu√ß√£o */
        .texto-evolucao {
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            min-height: 150px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #0d6efd;
            font-size: 0.9rem;
            line-height: 1.5;
            transition: all 0.3s ease;
        }
        
        .texto-evolucao p {
            margin-bottom: 0.6rem;
        }
        
        .texto-evolucao * {
            max-width: 100%;
        }
        
        .texto-evolucao h1, .texto-evolucao h2, .texto-evolucao h3 {
            margin-top: 0.8rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }
        
        .texto-evolucao ul, .texto-evolucao ol {
            padding-left: 25px;
            margin-bottom: 0.8rem;
        }
        
        .texto-evolucao li {
            margin-bottom: 0.3rem;
        }
        
        .texto-evolucao strong, .texto-evolucao b {
            font-weight: 700;
        }
        
        .texto-evolucao em, .texto-evolucao i {
            font-style: italic;
        }
        
        .texto-evolucao blockquote {
            margin: 0.8rem 0;
            padding: 0.5rem 1rem;
            border-left: 3px solid #adb5bd;
            background-color: #f0f0f0;
        }
        
        .texto-evolucao::-webkit-scrollbar {
            width: 10px;
        }
        
        .texto-evolucao::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .texto-evolucao::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .texto-evolucao::-webkit-scrollbar-thumb:hover {
            background: #0d6efd;
        }
        
        #editor-container {
            height: 450px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        
        .ql-editor {
            overflow-y: auto !important;
            max-height: 100% !important;
            scroll-behavior: smooth;
            font-size: 13px;
            line-height: 1.5;
            min-height: 400px;
        }
        
        .ql-tooltip {
            z-index: 1060 !important;
        }
        
        @media (max-width: 768px) {
            .texto-evolucao {
                font-size: 0.85rem;
                min-height: 100px;
            }
            #editor-container {
                height: 250px;
            }
            .ql-editor {
                min-height: 200px;
            }
        }
        
        /* Estilos para adaptar a altura da caixa baseado no tamanho do conte√∫do */
        .texto-evolucao[data-lines="1"],
        .texto-evolucao[data-lines="2"],
        .texto-evolucao[data-lines="3"] {
            max-height: 150px;
            min-height: 80px;
        }
        
        .texto-evolucao[data-lines="4"],
        .texto-evolucao[data-lines="5"],
        .texto-evolucao[data-lines="6"] {
            max-height: 200px;
            min-height: 100px;
        }
        
        .texto-evolucao[data-lines="7"],
        .texto-evolucao[data-lines="8"],
        .texto-evolucao[data-lines="9"] {
            max-height: 250px;
            min-height: 150px;
        }
        
        .texto-evolucao[data-lines="10"],
        .texto-evolucao[data-lines="11"],
        .texto-evolucao[data-lines="12"] {
            max-height: 300px;
            min-height: 200px;
        }
        
        .texto-evolucao[data-lines="13"],
        .texto-evolucao[data-lines="14"],
        .texto-evolucao[data-lines="15"] {
            max-height: 350px;
            min-height: 250px;
        }
        
        .texto-evolucao[data-lines="16"],
        .texto-evolucao[data-lines="17"],
        .texto-evolucao[data-lines="18"] {
            max-height: 400px;
            min-height: 300px;
        }
        
        .texto-evolucao[data-lines="19"],
        .texto-evolucao[data-lines="20"],
        .texto-evolucao[data-lines="21"] {
            max-height: 450px;
            min-height: 350px;
        }
        
        .texto-evolucao[data-lines="22"] {
            max-height: 500px;
            min-height: 400px;
        }
        
        /* Sobrescrever regras data-lines para permitir expans√£o autom√°tica */
        .texto-evolucao[data-lines] {
            max-height: none !important;
            height: auto !important;
        }
        
        /* Estilos para o calend√°rio de aprazamento */
        .calendar-day {
            width: 120px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-color: #f8f9fa;
        }
        
        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        
        .day-header {
            font-weight: bold;
            border-bottom: 1px dashed #dee2e6;
            padding-bottom: 5px;
        }
        
        .time-pill {
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .time-pill:hover {
            background-color: #e9ecef;
        }
        
        /* Estilos para popovers dos dias */
        .popover {
            max-width: 300px;
        }
        
        .popover-body {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Estilos dos Modais - modernizados */
        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
            color: white;
            border-radius: 16px 16px 0 0;
            border-bottom: none;
            padding: 20px 24px;
        }
        
        .modal-header .modal-title {
            font-weight: 600;
            font-size: 20px;
        }
        
        .modal-header .close,
        .modal-header .btn-close {
            color: white;
            opacity: 0.9;
            text-shadow: none;
        }
        
        .modal-header .close:hover,
        .modal-header .btn-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            border-top: none;
            padding: 20px 24px;
        }
        
        /* Novos estilos para o modal de aprazamento redesenhado */
        #modalAprazamento .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        #modalAprazamento .modal-header {
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
            border-bottom: none;
            padding: 20px 24px;
        }
        
        #modalAprazamento .modal-title {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        #modalAprazamento .modal-body {
            padding: 24px;
        }
        
        #modalAprazamento .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        
        #modalAprazamento .input-group-text {
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #6c757d;
        }
        
        #modalAprazamento .form-control,
        #modalAprazamento .form-select {
            border-color: #ced4da;
            padding: 10px 15px;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        #modalAprazamento .form-control:focus,
        #modalAprazamento .form-select:focus {
            border-color: var(--azul-principal);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }
        
        /* Estilos globais para form controls */
        .form-control:focus,
        .form-select:focus {
            border-color: var(--azul-principal);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }
        
        .alert {
            border-radius: 12px;
            border: none;
        }
        
        .alert-success {
            background-color: #D1FAE5;
            color: #065F46;
        }
        
        .alert-info {
            background-color: var(--azul-claro);
            color: #1E40AF;
        }
        
        .alert-warning {
            background-color: #FEF3C7;
            color: #92400E;
        }
        
        #modalAprazamento .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        #modalAprazamento .card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }
        
        #modalAprazamento .alert {
            border-radius: 8px;
            border: none;
        }
        
        #modalAprazamento .alert-info {
            background-color: #e6f3fd;
            color: #0c63e4;
        }
        
        #modalAprazamento .btn-primary {
            background: linear-gradient(to right, #4a6fdc, #2856d4);
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        #modalAprazamento .btn-primary:hover {
            background: linear-gradient(to right, #5d7fe3, #3967e5);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(45, 85, 211, 0.3);
        }
        
        #modalAprazamento .btn-outline-secondary {
            border-color: #ced4da;
            color: #495057;
        }
        
        #modalAprazamento .btn-success {
            background: linear-gradient(to right, #28a745, #218838);
            border: none;
            font-weight: 500;
        }
        
        #modalAprazamento .btn-success:hover {
            background: linear-gradient(to right, #2fd050, #27a844);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        #horarios_multiplos_dias .form-check-input {
            width: 18px;
            height: 18px;
            margin-top: 3px;
        }
        
        #horarios_multiplos_dias .form-check-input:checked {
            background-color: #4a6fdc;
            border-color: #4a6fdc;
        }
        
        #horarios_multiplos_dias .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
            padding: 12px 15px;
        }
        
        #horarios_multiplos_dias .btn-group .btn {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        /* Estilos para o modal de visualiza√ß√£o de aprazamentos */
        .modal-visualizar-aprazamento .modal-content {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .modal-visualizar-aprazamento .modal-header {
            background-color: #17a2b8;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-visualizar-aprazamento .table {
            margin-bottom: 0;
        }

        .modal-visualizar-aprazamento .table th {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .modal-visualizar-aprazamento .table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos .col {
            text-align: center;
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos small {
            display: block;
            margin-bottom: 0.25rem;
            color: #6c757d;
        }

        .modal-visualizar-aprazamento .resumo-aprazamentos strong {
            font-size: 1.25rem;
            display: block;
        }

        .modal-visualizar-aprazamento .status-icon {
            margin-right: 0.5rem;
        }

        .modal-visualizar-aprazamento .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Estilos para os bot√µes de RN */
        .rn-buttons {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .rn-buttons .btn {
            margin-right: 10px;
        }

        /* Estilos para o modal de RN */
        .modal-rn .form-group {
            margin-bottom: 15px;
        }

        /* Efeito visual ap√≥s atualiza√ß√£o */
        @keyframes flashUpdate {
            0% { background-color: #d4edda; }
            100% { background-color: transparent; }
        }
        .flash-update {
            animation: flashUpdate 1.5s ease-out;
        }

        /* Submenu lateral */
        .submenu .nav-link {
            padding-left: 40px;
            font-size: 0.85rem;
        }

        .submenu .nav-link i {
            font-size: 0.9rem;
        }

        .submenu {
            display: none; /* escondida por padr√£o */
            flex-direction: column;
        }

        /* Mostrar submenu quando o item principal estiver em hover ou o pr√≥prio submenu em hover */
        .nav-pills .nav-link:hover + .submenu,
        .submenu:hover {
            display: flex;
        }

        .nav-pills .nav-link.has-submenu {
            margin-bottom: 0; /* remove gap abaixo do item principal */
        }

        .submenu {
            margin: 0 10px 5px 10px; /* mesmo recuo lateral e espa√ßamento inferior */
        }

        /* Mostrar submenu ao passar o mouse */
        .nav-pills .nav-link.has-submenu:hover + .submenu,
        .submenu:hover {
            display: flex;
        }

        /* Se√ß√µes de Enfermagem */
        .enf-section {display: none;}
        .enf-section.active {display: block;}

        /* Link ativo no submenu */
        .submenu .nav-link.active {
            background-color: var(--accent);
            color: var(--text-primary);
        }

        /* Estilos para o bot√£o de impress√£o discreto */
        .timestamp-with-print {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-print-discreto {
            background: none;
            border: none;
            color: #26db0e;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            opacity: 0.7;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-print-discreto:hover {
            background-color: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
            opacity: 1;
            transform: scale(1.1);
        }

        .btn-print-discreto:active {
            transform: scale(0.95);
        }

        .btn-print-discreto i {
            font-size: 0.9rem;
        }

        /* Estilos para bot√µes de a√ß√£o das prescri√ß√µes - removidos (duplicados acima) */
        
        .btn-verde {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .btn-verde:hover {
            background: linear-gradient(135deg, #20c997, #28a745) !important;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }
        
        /* Estilos para bot√µes outline */
        .btn-outline-primary {
            border: 2px solid var(--azul-principal);
            color: var(--azul-principal);
            background: white;
        }
        
        .btn-outline-primary:hover {
            background: var(--azul-principal);
            color: white;
            border-color: var(--azul-principal);
        }
        
        .btn-outline-success {
            border: 2px solid #10B981;
            color: #10B981;
            background: white;
        }
        
        .btn-outline-success:hover {
            background: #10B981;
            color: white;
            border-color: #10B981;
        }
        
        .btn-outline-info {
            border: 2px solid #0EA5E9;
            color: #0EA5E9;
            background: white;
        }
        
        .btn-outline-info:hover {
            background: #0EA5E9;
            color: white;
            border-color: #0EA5E9;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 8px;
        }

        /* Vari√°veis RGB para transpar√™ncia - atualizado */
        :root {
            --primary-main-rgb: 74, 144, 226;
            --primary-light-rgb: 122, 184, 245;
        }

        /* Estilos espec√≠ficos para informa√ß√µes do m√©dico e timestamp */
        .medico-info {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .medico-nome {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.05rem;
            position: relative;
            padding-right: 16px;
        }

        .medico-nome::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 4px;
            width: 4px;
            background-color: #cbd5e0;
            border-radius: 50%;
        }

        .timestamp {
            color: #718096;
            font-size: 0.925rem;
            font-weight: 400;
        }
        
        .badge.bg-success {
            background-color: #ebf8ff !important;
            color: #2b6cb0;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            border: 1px solid #bee3f8;
        }

        /* Estilo do menu lateral */
        .sidebar {
            width: 60px;
            height: 100vh;
            background: linear-gradient(180deg, var(--azul-principal) 0%, var(--primary-dark) 100%);
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(74, 144, 226, 0.15);
        }
        
        .sidebar:hover {
            width: 200px;
            box-shadow: 4px 0 20px rgba(74, 144, 226, 0.25);
        }
        
        .nav-pills {
            flex-direction: column;
            padding: 0;
            margin: 0;
        }
        
        .nav-pills .nav-link {
            margin: 5px 10px;
            border-radius: 8px;
            padding: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .nav-pills .nav-link:hover {
            background-color: var(--hover-light);
            transform: translateX(5px);
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.1);
        }
        
        .nav-pills .nav-link i {
            font-size: 1.2rem;
            min-width: 30px;
            text-align: center;
            transition: transform 0.3s ease;
            color: var(--text-primary);
        }
        
        .nav-pills .nav-link:hover i {
            transform: scale(1.1);
        }
        
        .nav-pills .nav-link span {
            margin-left: 10px;
            opacity: 0;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .sidebar:hover .nav-pills .nav-link span {
            opacity: 1;
            transform: translateX(0);
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--accent);
            color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(21,101,192,0.3);
            border-color: rgba(255,255,255,0.2);
        }
        
        .nav-pills .nav-link.active:hover {
            transform: translateX(5px) scale(1.02);
            background-color: var(--accent);
        }
        
        /* Ajuste do conte√∫do principal */
        .main-content {
            margin-left: 60px;
            flex: 1;
            padding: 30px 40px;
            transition: all 0.3s ease;
            min-height: 100vh;
            background-color: transparent;
            position: relative;
        }

        /* Estilos espec√≠ficos para as abas de evolu√ß√£o */
        .nav-tabs {
            border-bottom: 2px solid var(--azul-claro);
        }
        
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--cinza-texto);
            border: none;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link:hover:not(.disabled) {
            background-color: rgba(74, 144, 226, 0.05);
            color: var(--azul-medio);
            border-bottom: 3px solid var(--azul-claro);
        }

        .nav-tabs .nav-link.active {
            background-color: transparent;
            border-bottom: 3px solid var(--azul-principal);
            color: var(--azul-principal);
        }
        
        .nav-tabs .nav-link.disabled {
            color: var(--cinza-claro);
            cursor: not-allowed;
        }

        #evolucaoTabContent {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 12px 12px;
            background: white;
        }

        /* Estilos para cards aninhados nas abas */
        #evolucaoTabContent .card {
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        #evolucaoTabContent .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Espa√ßamento adicional para visualiza√ß√µes */
        #evolucaoTabContent .card-body {
            padding: 1.5rem;
        }

        #evolucaoTabContent .p-4 {
            padding: 2rem !important;
        }

        /* Melhor espa√ßamento para cards com altura fixa */
        .card.h-100 {
            height: auto !important;
            min-height: 300px;
        }

        /* Espa√ßamento entre linhas de cards */
        .row.g-4 {
            margin-bottom: 2rem;
        }

        /* Indicadores de status para os cards */
        .card-header.bg-primary {
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio)) !important;
            color: white !important;
        }

        .card-header.bg-info {
            background: linear-gradient(135deg, #0EA5E9, #0284C7) !important;
            color: white !important;
        }

        .card-header.bg-warning {
            background: linear-gradient(135deg, #ffc107, #ffb300) !important;
            color: #333 !important;
        }

        .card-header.bg-success {
            background: linear-gradient(135deg, #10B981, #059669) !important;
            color: white !important;
        }

        .card-header.bg-secondary {
            background: linear-gradient(135deg, #6B7280, #4B5563) !important;
            color: white !important;
        }
        
        .card-header.bg-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626) !important;
            color: white !important;
        }

        /* Estilos para loading states */
        .tab-pane .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* Responsive para as abas */
        @media (max-width: 768px) {
            #evolucaoTabs .nav-link {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            
            #evolucaoTabs .nav-link i {
                display: none;
            }
            
            #evolucaoTabContent {
                padding: 15px !important;
            }
        }
        
        /* Estilos personalizados para a interface de diagn√≥stico */
        #diagnostico-edicao .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        #diagnostico-edicao .card {
            transition: all 0.3s ease;
        }
        
        #diagnostico-edicao .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-loading .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        #diagnostico-visualizacao .card-header button {
            transition: all 0.2s ease;
        }
        
        #diagnostico-visualizacao .card-header button:hover {
            transform: scale(1.05);
        }
        
        .alert {
            border-left: 4px solid;
        }
        
        .alert-success {
            border-left-color: #198754;
        }
        
        .alert-danger {
            border-left-color: #dc3545;
        }
        
        .alert-info {
            border-left-color: #0dcaf0;
        }
        
        /* Anima√ß√£o suave para transi√ß√µes */
        #diagnostico-visualizacao, #diagnostico-edicao {
            transition: opacity 0.3s ease;
        }
        
        /* Melhorar apar√™ncia dos campos de texto */
        #diagnostico-edicao textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        #diagnostico-edicao input[type="text"] {
            text-transform: uppercase;
        }
        
        /* Loading spinner personalizado */
        .spinner-border-primary {
            color: #0d6efd;
        }

        /* ===== ESTILOS PARA FICHAS DE REFER√äNCIA ===== */
        
        /* Estat√≠sticas das fichas */
        .fichas-stats {
            margin-bottom: 0.75rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 10px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #e7f1ff;
            color: #0d6efd;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-number {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2d3748;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.8rem;
        }

        /* Grid das fichas */
        .fichas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 0.5rem;
        }

        /* Card da ficha */
        .ficha-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .ficha-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border-color: #cfe2ff;
        }

        /* Header da ficha */
        .ficha-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #edf2f7;
            background: linear-gradient(180deg, #fafbff 0%, #ffffff 100%);
        }

        .ficha-info {
            flex: 1;
        }
        
        .ficha-titulo .titulo-texto {
            font-weight: 600;
            color: #2d3748;
        }
        
        .ficha-metadados {
            display: flex;
            gap: 0.75rem;
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        .ficha-actions {
            display: flex;
            gap: 0.4rem;
        }
        
        .btn-action {
            width: 34px;
            height: 34px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #fff;
            color: #4a5568;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .btn-action:hover {
            background: #f8fafc;
            border-color: #cbd5e0;
            color: #2b6cb0;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(43,108,176,0.15);
        }
        
        .btn-action.btn-print {
            color: #198754;
            border-color: #d1e7dd;
        }
        
        .btn-action.btn-print:hover {
            background: #e9f7ef;
            color: #146c43;
            border-color: #badbcc;
        }
        
        .ficha-content {
            padding: 0.85rem 1rem 1rem;
        }
        
        .campo-principal {
            margin-bottom: 0.5rem;
        }
        
        .campo-label {
            color: #6c757d;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .campo-valor {
            color: #2d3748;
            background: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
        }
        
        .destaque-unidade {
            border-left: 4px solid #0d6efd;
            background: linear-gradient(90deg, rgba(13,110,253,0.05), transparent 70%);
        }
        
        .campo-secundario {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .campo-label-pequeno {
            color: #6c757d;
            font-size: 0.8rem;
            min-width: 110px;
        }
        
        .campo-valor-pequeno {
            color: #495057;
            font-size: 0.9rem;
        }
        
        .tem-mais-conteudo {
            margin-top: 0.5rem;
            color: #6c757d;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        /* Estilos removidos: ficha-footer, btn-expand, expand-icon, ficha-expanded */
        /* Agora usamos apenas o modal de visualiza√ß√£o */
        
        /* Estilos para o Modal de Visualiza√ß√£o */
        .ficha-visualizacao {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .ficha-visualizacao .ficha-header-modal {
            border-bottom: 1px solid #edf2f7;
            margin-bottom: 0.75rem;
        }
        
        .ficha-visualizacao .campo-titulo-modal {
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ficha-visualizacao .campo-conteudo-modal {
            background: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 8px;
            padding: 0.75rem;
            color: #2d3748;
        }
        
        .destaque-unidade-modal {
            border-left: 4px solid #0d6efd;
            background: linear-gradient(90deg, rgba(13,110,253,0.05), transparent 70%);
        }
        
        .empty-state {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            margin: 20px 0;
            padding: 2rem;
            text-align: center;
        }
        
        .empty-state i {
            opacity: 0.5;
        }
        
        .empty-state h6 {
            font-weight: 600;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .fichas-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .ficha-header {
                padding: 12px;
            }
            
            .ficha-content {
                padding: 12px;
            }
            
            .ficha-metadados {
                font-size: 0.8rem;
            }
        }
        
        /* Estilos adicionais para Modal de Visualiza√ß√£o de Ficha */
        .ficha-header-modal {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .ficha-header-modal h5 {
            color: #2d3748;
            font-weight: 600;
            margin: 0;
        }
        
        .campo-modal {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .texto-referencia-modal {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
            color: #e65100;
        }
        
        /* === ESTILOS PARA A NOVA MODAL DE FICHA DE REFER√äNCIA === */
        
        /* Modal de tamanho extra-large com visual aprimorado */
        .modal-xl {
            --bs-modal-width: 1200px;
        }
        
        /* Header com gradiente */
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--azul-principal) 0%, var(--primary-dark) 100%) !important;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }
        
        /* Conte√∫do da modal com padding aprimorado */
        .modal-body.p-4 {
            padding: 2rem !important;
            background: #f8f9fa;
        }
        
        /* Form floating labels melhorados */
        .form-floating > .form-control {
            height: calc(3.5rem + 2px);
            line-height: 1.25;
            font-size: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .form-floating > .form-control:focus {
            border-color: var(--azul-principal);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
            background-color: #fff;
        }
        
        .form-floating > label {
            padding: 1rem 0.75rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        /* Checkboxes aprimorados */
        .form-check-lg {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 1rem;
        }
        
        .form-check-lg:hover {
            border-color: var(--azul-principal);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15);
            transform: translateY(-2px);
        }
        
        .form-check-lg .form-check-input {
            margin-top: 0.1rem;
            transform: scale(1.3);
        }
        
        .form-check-lg .form-check-input:checked {
            background-color: var(--azul-principal);
            border-color: var(--azul-principal);
        }
        
        .form-check-lg .form-check-label {
            cursor: pointer;
            font-size: 1rem;
            padding-left: 0.5rem;
            font-weight: 600;
        }
        
        .form-check-lg .form-check-label small {
            color: #6c757d;
            font-size: 0.875rem;
            display: block;
            font-weight: 400;
        }
        
        /* √Årea do texto de refer√™ncia destacada */
        .border-primary.border-2 {
            border-color: var(--azul-principal) !important;
            border-width: 2px !important;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 15px !important;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.1);
        }
        
        /* Textarea principal */
        #texto_referencia {
            border: none !important;
            background: transparent !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
            resize: vertical !important;
            box-shadow: none !important;
        }
        
        #texto_referencia:focus {
            outline: none !important;
            box-shadow: none !important;
        }
        
        #texto_referencia::placeholder {
            color: #6c757d;
            font-style: italic;
            opacity: 0.8;
        }
        
        /* Footer da modal */
        .modal-footer.bg-light {
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%) !important;
            border-top: 2px solid #e2e8f0;
        }
        
        /* Bot√µes aprimorados */
        .btn-lg {
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-success.btn-lg {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-success.btn-lg:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-outline-secondary.btn-lg {
            border: 2px solid #6B7280;
            color: #6B7280;
        }
        
        .btn-outline-secondary.btn-lg:hover {
            background: #6B7280;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }
        
        /* √çcones coloridos - atualizados */
        .text-primary { color: var(--azul-principal) !important; }
        .text-info { color: #0EA5E9 !important; }
        .text-success { color: #10B981 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-danger { color: #EF4444 !important; }
        
        /* Anima√ß√µes suaves */
        .modal.fade .modal-dialog {
            transition: transform 0.4s ease-out;
        }
        
        .modal.show .modal-dialog {
            transform: none;
        }
        
        /* Responsividade */
        @media (max-width: 1200px) {
            .modal-xl {
                --bs-modal-width: 95vw;
            }
        }
        
        @media (max-width: 768px) {
            .modal-body.p-4 {
                padding: 1rem !important;
            }
            
            .form-check-lg {
                padding: 0.75rem;
            }
            
            #texto_referencia {
                min-height: 200px !important;
            }
            
            .btn-lg {
                padding: 0.6rem 1.5rem;
                font-size: 1rem;
            }
        }
        
        /* Responsividade do Modal */
        @media (max-width: 768px) {
            .ficha-header-modal {
                padding: 15px;
            }
            
            .campo-modal {
                padding: 12px;
            }
            
            .campo-titulo-modal {
                font-size: 0.9rem;
            }
            
            .campo-conteudo-modal {
                font-size: 0.9rem;
                padding: 10px;
            }
        }
        
        /* Responsividade Global - Tablets */
        @media (max-width: 992px) {
            .main-content {
                padding: 20px 24px;
            }
            
            .dashboard-header {
                padding: 20px 24px;
            }
            
            .dashboard-header h2 {
                font-size: 24px;
            }
            
            .paciente-info {
                padding: 20px;
            }
        }
        
        /* Responsividade - Mobile */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            .dashboard-header {
                padding: 16px 20px;
                margin-bottom: 16px;
            }
            
            .dashboard-header h2 {
                font-size: 20px;
            }
            
            .dashboard-header p {
                font-size: 12px;
            }
            
            .paciente-info {
                padding: 16px;
            }
            
            .paciente-info .info-item {
                font-size: 12px;
                padding: 6px 0;
            }
            
            .card {
                margin-bottom: 16px;
            }
            
            .card-header {
                padding: 16px 20px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }
        
        /* Responsividade - Mobile Pequeno */
        @media (max-width: 576px) {
            .main-content {
                padding: 12px;
            }
            
            .dashboard-header {
                padding: 12px 16px;
            }
            
            .dashboard-header h2 {
                font-size: 18px;
            }
            
            .paciente-info {
                padding: 12px;
            }
            
            .card-header {
                padding: 12px 16px;
            }
            
            .card-header h5 {
                font-size: 14px;
            }
        }
        
        /* Estilos para o Modal de Op√ß√µes de Impress√£o */
        #modalOpcoesImpressao .btn-outline-dark {
            border-width: 2px;
            transition: all 0.3s ease;
            padding: 1rem;
        }
        
        #modalOpcoesImpressao .btn-outline-dark:hover:not(:disabled):not(.disabled) {
            background-color: #212529;
            color: white;
            border-color: #212529;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        #modalOpcoesImpressao .btn-outline-dark i {
            color: #6c757d;
            transition: color 0.3s ease;
        }
        
        #modalOpcoesImpressao .btn-outline-dark:hover:not(:disabled):not(.disabled) i {
            color: white;
        }
        
        #modalOpcoesImpressao .btn-outline-dark:disabled,
        #modalOpcoesImpressao .btn-outline-dark.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
<!-- Menu Lateral -->
<div class="sidebar">
    <nav class="nav nav-pills flex-column">
        <!-- Menu Principal -->
        <div class="menu-section">
            <a class="nav-link active" href="#resumoGeralSection" data-bs-toggle="pill">
                <i class="fas fa-home"></i>
                <span>Resumo Geral</span>
            </a>
            <a class="nav-link" href="#prescricaoSection" data-bs-toggle="pill">
                <i class="fas fa-pills"></i>
                <span>Prescri√ß√£o</span>
            </a>
            <a class="nav-link" href="#evolucaoSection" data-bs-toggle="pill">
                <i class="fas fa-notes-medical"></i>
                <span>Evolu√ß√£o</span>
            </a>
            <a class="nav-link has-submenu" href="#enfermagemSection" data-bs-toggle="pill">
                <i class="fas fa-user-nurse"></i>
                <span>Enfermagem</span>
            </a>
            <!-- Submenu para Enfermagem -->
            <div class="submenu">
                <a class="nav-link submenu-link active" href="#" data-enf-target="enfAdmissaoSection">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Admiss√£o</span>
                </a>
                <a class="nav-link submenu-link" href="#" data-enf-target="enfEvolucoesSection">
                    <i class="fas fa-notes-medical"></i>
                    <span>Evolu√ß√µes</span>
                </a>
                <a class="nav-link submenu-link" href="#" data-enf-target="enfSAESection">
                    <i class="fas fa-stethoscope"></i>
                    <span>SAE</span>
                </a>
            </div>
            <a class="nav-link" href="#prescricaoEnfermagemSection" data-bs-toggle="pill">
                <i class="fas fa-clipboard-list"></i>
                <span>Prescri√ß√£o Enf.</span>
            </a>
            <a class="nav-link" href="#examesSection" data-bs-toggle="pill">
                <i class="fas fa-vial"></i>
                <span>Exames</span>
            </a>
            <a class="nav-link" href="#receituarioSection" data-bs-toggle="pill">
                <i class="fas fa-prescription"></i>
                <span>Receitu√°rio</span>
            </a>
            <a class="nav-link" href="#fichaReferenciaSection" data-bs-toggle="pill">
                <i class="fas fa-file-export"></i>
                <span>Ficha de Refer√™ncia</span>
            </a>
            <a class="nav-link" href="#atestadoSection" data-bs-toggle="pill">
                <i class="fas fa-file-medical"></i>
                <span>Atestados</span>
            </a>
            <a class="nav-link" href="#internamentoInfoSection" data-bs-toggle="pill">
                <i class="fas fa-notes-medical"></i>
                <span>Informa√ß√µes Internamento</span>
            </a>
        </div>

        <!-- A√ß√µes R√°pidas -->
        <div class="quick-actions">
            <a class="nav-link action-btn" href="#" onclick="abrirImpressao('{{ internacao.atendimento_id }}'); return false;">
                <i class="fas fa-print"></i>
                <span>Imprimir</span>
            </a>
        </div>
    </nav>
</div>

<!-- Conte√∫do Principal -->
<div class="main-content">
    <div class="container-fluid py-4">
        <!-- Header do Dashboard -->
        <div class="dashboard-header mb-4">
            <h2 class="d-flex align-items-center gap-2">
                <i class="fas fa-user-md me-2"></i>
                Evolu√ß√£o do Paciente
                {% if rn_ativo_info %}
                <a href="/clinica/evolucao-paciente-medico/{{ rn_ativo_info.atendimento_id }}" class="badge bg-success text-decoration-none" title="Ir para a ficha do RN ativo">
                    <i class="fas fa-baby me-1"></i> RN ATIVO: {{ rn_ativo_info.nome }}
                </a>
                {% endif %}
            </h2>
            <p class="mb-0">
                <i class="fas fa-stethoscope me-2"></i>
                Acompanhamento m√©dico e registros cl√≠nicos
            </p>
        </div>
        
        <!-- Bot√µes de a√ß√£o -->
        <div class="d-flex justify-content-end align-items-center mb-4 gap-2">
            <button type="button" class="btn btn-outline-info btn-sm" id="btnHistoricoInternamentos">
                <i class="fas fa-history me-1"></i> Hist√≥rico
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" id="btnAdicionarRN">
                <i class="fas fa-plus me-1"></i> Adicionar RN
            </button>
            {% if rn_ativo_info %}
            <a href="/clinica/evolucao-paciente-medico/{{ rn_ativo_info.atendimento_id }}" class="btn btn-success btn-sm">
                <i class="fas fa-baby me-1"></i> Ficha do RN
            </a>
            {% endif %}
            {% if internacao.data_alta %}
            <button type="button" class="btn btn-success btn-sm" onclick="verInformacoesAlta('{{ internacao.atendimento_id }}')">
                <i class="fas fa-user-check me-1"></i> Alta
            </button>
            {% endif %}
            <a href="/clinica/pacientes-internados" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
        </div>

    <!-- Informa√ß√µes do Paciente -->
    <div class="paciente-info row">
        <div class="col-md-3 info-item"><strong>Nome:</strong> {{ paciente.nome }}</div>
        <div class="col-md-3 info-item"><strong>CPF:</strong> {{ paciente.cpf }}</div>
        <div class="col-md-3 info-item"><strong>Cart√£o SUS:</strong> {{ paciente.cartao_sus }}</div>
        <div class="col-md-3 info-item"><strong>Sexo:</strong> {{ paciente.sexo }}</div>
        <div class="col-md-3 info-item"><strong>Data de Nascimento:</strong> {{ paciente.data_nascimento.strftime('%d/%m/%Y') if paciente.data_nascimento else '-' }}</div>
        <div class="col-md-3 info-item"><strong>Endere√ßo:</strong> {{ paciente.endereco }}</div>
        <div class="col-md-3 info-item"><strong>Munic√≠pio:</strong> {{ paciente.municipio }}</div>
        <div class="col-md-3 info-item"><strong>Telefone:</strong> {{ paciente.telefone }}</div>
        <div class="col-md-3 info-item"><strong>Nome Social:</strong> {{ paciente.nome_social }}</div>
        <div class="col-md-3 info-item"><strong>Filia√ß√£o:</strong> {{ paciente.filiacao }}</div>
    </div>

    <!-- Bot√µes de RN/M√£e -->
    <div class="rn-buttons">
        <!-- Bot√µes para quando o paciente √© a m√£e -->
        <div id="botoesResponsavel" style="display: none;">
            <button type="button" class="btn btn-primary" id="btnAssociarRN" onclick="abrirModalRN()">
                <i class="fas fa-baby"></i> Associar RN
            </button>
            <button type="button" class="btn btn-info" id="btnVerRN" style="display: none;" onclick="verFichaRN()">
                <i class="fas fa-file-medical"></i> Ver ficha do RN
            </button>
        </div>
        
        <!-- Bot√£o para quando o paciente √© RN -->
        <div id="botoesRN" style="display: none;">
            <button type="button" class="btn btn-info" id="btnVerMae" onclick="verFichaMae()">
                <i class="fas fa-female"></i> Ver ficha da m√£e
            </button>
        </div>
    </div>

    <!-- Se√ß√£o de Resumo Geral (NOVA) -->
    <div id="resumoGeralSection" class="content-section active">
        <div class="row g-4">
            <!-- Card: Status da Interna√ß√£o -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100" style="border-left: 3px solid #4A90E2 !important;">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 text-dark fw-bold"><i class="fas fa-hospital-user me-2"></i>Status da Interna√ß√£o</h6>
                    </div>
                    <div class="card-body bg-white">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item px-0 py-3 border-0 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-dark"><i class="fas fa-calendar-alt me-2"></i>Data de Interna√ß√£o</span>
                                    <span class="text-dark fw-bold">{{ internacao.data_internacao.strftime('%d/%m/%Y') if internacao.data_internacao else 'N√£o informada' }}</span>
                                </div>
                            </div>
                            <div class="list-group-item px-0 py-3 border-0 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-dark"><i class="fas fa-bed me-2"></i>Leito</span>
                                    <span class="text-dark fw-bold">{{ internacao.leito or 'N√£o informado' }}</span>
                                </div>
                            </div>
                            <div class="list-group-item px-0 py-3 border-0 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-dark"><i class="fas fa-stethoscope me-2"></i>CID Principal</span>
                                    <span class="text-dark fw-bold">{{ internacao.cid_principal or 'N√£o informado' }}</span>
                                </div>
                            </div>
                            <div class="list-group-item px-0 py-3 border-0 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-dark"><i class="fas fa-user-md me-2"></i>M√©dico que realizou internamento</span>
                                    <span class="text-dark fw-bold" id="medicoResponsavel">Carregando...</span>
                                </div>
                            </div>
                            {% if internacao.data_alta %}
                            <div class="list-group-item px-0 py-3 border-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-dark"><i class="fas fa-check-circle me-2"></i>Alta M√©dica</span>
                                    <span class="text-success fw-bold">{{ internacao.data_alta.strftime('%d/%m/%Y') }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: √öltimas Atividades -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100" style="border-left: 3px solid #6c757d !important;">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 text-dark fw-bold"><i class="fas fa-clock me-2"></i>√öltimas Atividades</h6>
                    </div>
                    <div class="card-body bg-white">
                        <div class="mb-4">
                            <div class="d-flex align-items-start mb-2">
                                <div class="me-3">
                                    <div class="rounded-circle bg-light p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-pills text-dark"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-dark fw-bold">√öltima Prescri√ß√£o</h6>
                                    <div id="ultimaPrescricaoInfo" class="text-dark">
                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                        Carregando...
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="d-flex align-items-start mb-2">
                                <div class="me-3">
                                    <div class="rounded-circle bg-light p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-notes-medical text-dark"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-dark fw-bold">√öltima Evolu√ß√£o</h6>
                                    <div id="ultimaEvolucaoInfo" class="text-dark">
                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                        Carregando...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Avisos e Alertas -->
            {% if rn_ativo_info %}
            <div class="col-12">
                <div class="card border-0 shadow-sm" style="border-left: 3px solid #28a745 !important;">
                    <div class="card-body bg-white">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="rounded-circle bg-light p-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-baby text-success"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 text-dark">RN Ativo Vinculado</h6>
                                <p class="mb-2 text-muted small">{{ rn_ativo_info.nome }}</p>
                                <a href="/clinica/evolucao-paciente-medico/{{ rn_ativo_info.atendimento_id }}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-arrow-right me-1"></i>Acessar Ficha
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card: A√ß√µes R√°pidas -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h6 class="mb-0 text-dark fw-bold"><i class="fas fa-bolt me-2"></i>A√ß√µes R√°pidas</h6>
                    </div>
                    <div class="card-body bg-white">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-secondary w-100" id="btnAdicionarRNResumo" style="padding: 1rem;">
                                    <i class="fas fa-plus-circle d-block mb-2" style="font-size: 1.5rem;"></i>
                                    <div class="fw-bold text-dark">Adicionar RN</div>
                                    <small class="text-dark d-block mt-1" style="font-size: 0.75rem;">Vincular rec√©m-nascido</small>
                                </button>
                            </div>
                            {% if internacao.data_alta %}
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="verInformacoesAlta('{{ internacao.atendimento_id }}')" style="padding: 1rem;">
                                    <i class="fas fa-user-check d-block mb-2" style="font-size: 1.5rem;"></i>
                                    <div class="fw-bold text-dark">Ver Alta</div>
                                    <small class="text-dark d-block mt-1" style="font-size: 0.75rem;">Relat√≥rio de alta</small>
                                </button>
                            </div>
                            {% endif %}
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-secondary w-100" id="btnHistoricoResumo" style="padding: 1rem;">
                                    <i class="fas fa-history d-block mb-2" style="font-size: 1.5rem;"></i>
                                    <div class="fw-bold text-dark">Hist√≥rico</div>
                                    <small class="text-dark d-block mt-1" style="font-size: 0.75rem;">Interna√ß√µes anteriores</small>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-secondary w-100" id="btnImprimirResumo" data-bs-toggle="modal" data-bs-target="#modalOpcoesImpressao" style="padding: 1rem;">
                                    <i class="fas fa-print d-block mb-2" style="font-size: 1.5rem;"></i>
                                    <div class="fw-bold text-dark">Imprimir</div>
                                    <small class="text-dark d-block mt-1" style="font-size: 0.75rem;">Documentos</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Diagn√≥stico Atual -->
            <div class="col-12">
                <div class="card border-0 shadow-sm" style="border-left: 3px solid #4A90E2 !important;">
                    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-dark fw-bold"><i class="fas fa-diagnoses me-2"></i>Diagn√≥stico Atual</h6>
                        <button class="btn btn-outline-secondary btn-sm" onclick="$('.nav-link[href=\'#evolucaoSection\']').click(); setTimeout(() => $('#diagnostico-tab').click(), 100);">
                            <i class="fas fa-edit me-1"></i>Editar
                        </button>
                    </div>
                    <div class="card-body bg-white">
                        <p class="mb-0 text-dark fw-medium" id="diagnosticoAtualResumo" style="white-space: pre-wrap; line-height: 1.6;">{{ internacao.diagnostico or 'Diagn√≥stico n√£o informado.' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o de Prescri√ß√µes M√©dicas -->
    <div id="prescricaoSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Prescri√ß√µes M√©dicas</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-light btn-sm" id="btn-nova-prescricao">
                        <i class="fas fa-plus"></i> Nova Prescri√ß√£o
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="prescricoes-lista">
                    <!-- Todas as prescri√ß√µes ser√£o listadas aqui -->
                    <div id="listaPrescricoes">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o de Prescri√ß√µes de Enfermagem -->
    <div id="prescricaoEnfermagemSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Prescri√ß√µes de Enfermagem</h5>
            </div>
            <div class="card-body">
                <!-- Prescri√ß√µes de Enfermagem de Hoje -->
                <div class="mb-3" id="hoje-container-prescricao-enfermagem">
                    <h6 class="fw-bold text-success mb-2">
                        <i class="fas fa-calendar-day me-1"></i> 
                        <span id="titulo-prescricoes-enfermagem-hoje">Prescri√ß√µes de Enfermagem de Hoje</span>
                    </h6>
                    <div id="listaPrescricoesEnfermagemDoDia">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
                
                <!-- Prescri√ß√µes de Enfermagem Anteriores -->
                <div class="mb-3" id="antigas-container-prescricao-enfermagem">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-secondary mb-0">
                            <i class="fas fa-history me-1"></i> Prescri√ß√µes de Enfermagem Anteriores
                        </h6>
                        <span class="badge bg-info" id="contador-prescricoes-enfermagem-antigas">0</span>
                    </div>
                    <div id="listaPrescricoesEnfermagemAntigas">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="evolucaoSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-notes-medical me-2"></i>Evolu√ß√£o e Acompanhamento M√©dico</h5>
            </div>
            <div class="card-body p-0">
                <!-- Navega√ß√£o por abas dentro da se√ß√£o de Evolu√ß√£o -->
                <ul class="nav nav-tabs" id="evolucaoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="evolucoes-tab" data-bs-toggle="tab" data-bs-target="#evolucoes-pane" type="button" role="tab">
                            <i class="fas fa-notes-medical me-2"></i>Evolu√ß√µes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="anamnese-tab" data-bs-toggle="tab" data-bs-target="#anamnese-pane" type="button" role="tab">
                            <i class="fas fa-user-md me-2"></i>Anamnese & Conduta
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="diagnostico-tab" data-bs-toggle="tab" data-bs-target="#diagnostico-pane" type="button" role="tab">
                            <i class="fas fa-stethoscope me-2"></i>Diagn√≥stico
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="justificativas-tab" data-bs-toggle="tab" data-bs-target="#justificativas-pane" type="button" role="tab">
                            <i class="fas fa-clipboard-list me-2"></i>Justificativas
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-4" id="evolucaoTabContent">
                    <!-- Aba de Evolu√ß√µes -->
                    <div class="tab-pane fade show active" id="evolucoes-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0 text-primary fw-bold">Registro de Evolu√ß√µes</h6>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEvolucao">
                                <i class="fas fa-plus-circle"></i> Nova Evolu√ß√£o
                            </button>
                        </div>

                        <!-- HDA Section -->
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Hist√≥ria da Doen√ßa Atual (HDA)</h6>
                                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarHDA">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="hdaContainer" class="texto-evolucao bg-light p-3 rounded" style="min-height: 100px; white-space: pre-wrap;">{{ internacao.hda or 'HDA n√£o registrada.' }}</div>
                                <textarea class="form-control d-none" id="hdaTexto">{{ internacao.hda or '' }}</textarea>
                            </div>
                        </div>
                        
                        <!-- Lista de Evolu√ß√µes -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 text-secondary"><i class="fas fa-list me-2"></i>Hist√≥rico de Evolu√ß√µes</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-primary">
                                            <tr>
                                                <th scope="col" style="width: 12%">Data/Hora</th>
                                                <th scope="col" style="width: 13%">M√©dico</th>
                                                <th scope="col" style="width: 65%">Evolu√ß√£o</th>
                                                <th scope="col" style="width: 10%">A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listaEvolucoes">
                                            <tr>
                                                <td colspan="4" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Carregando...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Carregando evolu√ß√µes...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba de Anamnese e Conduta -->
                    <div class="tab-pane fade" id="anamnese-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0 text-success fw-bold">Anamnese e Conduta M√©dica</h6>
                            <button type="button" class="btn btn-success btn-sm" id="btnEditarAnamneseConduta">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>

                        <div id="anamnese-conduta-loading" class="text-center my-4" style="display:none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                        
                        <div id="anamnese-conduta-visualizacao">
                            <!-- Anamnese e Exame F√≠sico -->
                            <div class="row g-4 mb-4">
                                <div class="col-12">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-user-check me-2"></i>Anamnese e Exame F√≠sico</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="p-4 bg-light rounded texto-evolucao" id="anamnese-exame-fisico-display" style="min-height: 200px;">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-file-medical fa-3x mb-3"></i>
                                                    <p>Carregando informa√ß√µes da anamnese...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conduta M√©dica -->
                            <div class="row g-4 mb-4">
                                <div class="col-12">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-prescription me-2"></i>Conduta M√©dica</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="p-4 bg-light rounded texto-evolucao" id="conduta-medica-display" style="min-height: 200px;">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                                    <p>Carregando conduta m√©dica...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formul√°rio de Edi√ß√£o (oculto inicialmente) -->
                        <div id="anamnese-conduta-edicao" style="display:none;">
                            <!-- FORMUL√ÅRIO EMBUTIDO REMOVIDO: edi√ß√£o s√≥ via modal -->
                        </div>
                    </div>

                    <!-- Aba de Diagn√≥stico -->
                    <div class="tab-pane fade" id="diagnostico-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0 text-info fw-bold">Diagn√≥stico e Classifica√ß√£o</h6>
                            <button type="button" class="btn btn-info btn-sm" id="btnEditarDiagnostico">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>

                        <div id="diagnostico-loading" class="text-center my-4" style="display:none;">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 text-muted">Carregando dados do diagn√≥stico...</p>
                        </div>
                        
                        <!-- Visualiza√ß√£o (padr√£o) -->
                        <div id="diagnostico-visualizacao">
                            <!-- Diagn√≥stico Principal -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-12">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-diagnoses me-2"></i>Diagn√≥stico Principal</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label fw-bold text-muted">Diagn√≥stico Inicial:</label>
                                                    <div class="p-4 bg-light rounded border" id="diagnostico-inicial-display" style="min-height: 150px;">
                                                        <div class="text-center text-muted">
                                                            <i class="fas fa-stethoscope fa-2x mb-3"></i>
                                                            <p class="mb-0">Carregando diagn√≥stico...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label fw-bold text-muted">CID Principal:</label>
                                                    <div class="p-3 bg-light rounded border" id="cid-principal-display" style="min-height: 80px;">
                                                        <div class="text-center text-muted">
                                                            <i class="fas fa-code fa-lg mb-2"></i>
                                                            <p class="mb-0">Carregando CID...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-0">
                                                <label class="form-label fw-bold text-muted">Diagn√≥stico Atual:</label>
                                                <div class="p-4 bg-light rounded border" id="diagnostico-atual-display" style="min-height: 150px;">
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-clipboard-check fa-2x mb-3"></i>
                                                        <p class="mb-0">Carregando diagn√≥stico atual...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Classifica√ß√µes Secund√°rias -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="card border-secondary h-100">
                                        <div class="card-header bg-secondary text-white">
                                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>CID Secund√°rio</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="p-3 bg-light rounded border" id="cid-secundario-display" style="min-height: 100px;">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-list-ul fa-lg mb-2"></i>
                                                    <p>Nenhum CID secund√°rio registrado</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Causas Associadas</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="p-3 bg-light rounded border" id="causas-associadas-display" style="min-height: 100px;">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-link fa-lg mb-2"></i>
                                                    <p>Nenhuma causa associada registrada</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formul√°rio de Edi√ß√£o (oculto inicialmente) -->
                        <div id="diagnostico-edicao" style="display: none;">
                            <!-- Header do Formul√°rio -->
                            <div class="alert alert-info d-flex align-items-center mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Modo de Edi√ß√£o Ativado</strong><br>
                                    <small>Preencha os campos abaixo e clique em "Salvar" para atualizar o diagn√≥stico.</small>
                                </div>
                            </div>

                            <form id="formDiagnostico">
                                <!-- Diagn√≥stico Principal -->
                                <div class="row g-4 mb-4">
                                    <div class="col-md-12">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">
                                                <h6 class="mb-0"><i class="fas fa-diagnoses me-2"></i>Diagn√≥stico Principal</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="diagnostico-inicial-edit" class="form-label fw-bold">
                                                            <i class="fas fa-stethoscope me-1"></i>Diagn√≥stico Inicial
                                                        </label>
                                                        <textarea class="form-control" id="diagnostico-inicial-edit" name="diagnostico_inicial" 
                                                                rows="6" placeholder="Digite o diagn√≥stico inicial baseado na avalia√ß√£o cl√≠nica..."></textarea>
                                                        <div class="form-text">Diagn√≥stico estabelecido na admiss√£o do paciente.</div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="cid-principal-edit" class="form-label fw-bold">
                                                            <i class="fas fa-code me-1"></i>CID Principal
                                                        </label>
                                                        <input type="text" class="form-control" id="cid-principal-edit" name="cid_principal" 
                                                               placeholder="Ex: A09.5, K35.2" maxlength="20">
                                                        <div class="form-text">C√≥digo da Classifica√ß√£o Internacional de Doen√ßas (CID-10).</div>
                                                    </div>
                                                </div>
                                                <div class="mb-0">
                                                    <label for="diagnostico-atual-edit" class="form-label fw-bold">
                                                        <i class="fas fa-clipboard-check me-1"></i>Diagn√≥stico Atual
                                                    </label>
                                                    <textarea class="form-control" id="diagnostico-atual-edit" name="diagnostico" 
                                                            rows="6" placeholder="Digite o diagn√≥stico atual baseado na evolu√ß√£o do quadro..."></textarea>
                                                    <div class="form-text">Situa√ß√£o diagn√≥stica atual baseada na evolu√ß√£o do quadro cl√≠nico.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Classifica√ß√µes Secund√°rias -->
                                <div class="row g-4 mb-4">
                                    <div class="col-md-6">
                                        <div class="card border-secondary h-100">
                                            <div class="card-header bg-secondary text-white">
                                                <h6 class="mb-0"><i class="fas fa-list me-2"></i>CID Secund√°rio</h6>
                                            </div>
                                            <div class="card-body">
                                                <textarea class="form-control" id="cid-secundario-edit" name="cid_10_secundario" 
                                                        rows="4" placeholder="Digite os CIDs secund√°rios (um por linha)&#10;Ex: Z51.1&#10;I10"></textarea>
                                                <div class="form-text">C√≥digos de condi√ß√µes associadas ou comorbidades.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-warning h-100">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Causas Associadas</h6>
                                            </div>
                                            <div class="card-body">
                                                <textarea class="form-control" id="causas-associadas-edit" name="cid_10_causas_associadas" 
                                                        rows="4" placeholder="Digite as causas associadas (uma por linha)&#10;Ex: Tabagismo&#10;Hipertens√£o"></textarea>
                                                <div class="form-text">Fatores que contribu√≠ram para o quadro cl√≠nico atual.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bot√µes de A√ß√£o -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-outline-secondary" id="btnCancelarDiagnostico">
                                        <i class="fas fa-times me-1"></i> Cancelar
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary me-2" id="btnLimparFormulario">
                                            <i class="fas fa-eraser me-1"></i> Limpar
                                        </button>
                                        <button type="submit" class="btn btn-success" id="btnSalvarDiagnostico">
                                            <span class="btn-text">
                                                <i class="fas fa-save me-1"></i> Salvar Diagn√≥stico
                                            </span>
                                            <span class="btn-loading" style="display: none;">
                                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                Salvando...
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Aba de Justificativas da Interna√ß√£o -->
                    <div class="tab-pane fade" id="justificativas-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0 text-success fw-bold">Justificativas da Interna√ß√£o</h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-warning btn-sm" id="btnGerarAIHPadrao" title="Preenche automaticamente os campos com dados padr√£o para AIH">
                                    <i class="fas fa-file-medical me-1"></i> Gerar AIH Padr√£o
                                </button>
                            <button type="button" class="btn btn-success btn-sm" id="btnEditarJustificativas">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            </div>
                        </div>

                        <div id="justificativas-loading" class="text-center my-4" style="display:none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                        
                        <div id="justificativas-visualizacao">
                            <!-- Cards com mais espa√ßo -->
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card border-danger h-100">
                                        <div class="card-header bg-danger text-white">
                                            <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Sinais e Sintomas</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="p-4 bg-light rounded border" id="sinais-sintomas-display" style="min-height: 200px;">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-heartbeat fa-2x mb-3"></i>
                                                    <p>Carregando sinais e sintomas...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Condi√ß√µes Justificativas</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="p-4 bg-light rounded border" id="condicoes-display" style="min-height: 200px;">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-check-double fa-2x mb-3"></i>
                                                    <p>Carregando condi√ß√µes que justificam...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-4 mt-2">
                                <div class="col-12">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="fas fa-flask me-2"></i>Principais Resultados Diagn√≥sticos</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="p-4 bg-light rounded border" id="resultados-diagnosticos-display" style="min-height: 200px;">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-chart-line fa-2x mb-3"></i>
                                                    <p>Carregando resultados diagn√≥sticos...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formul√°rio de Edi√ß√£o de Justificativas (oculto inicialmente) -->
                        <div id="justificativas-edicao" style="display:none;">
                            <!-- FORMUL√ÅRIO EMBUTIDO REMOVIDO: edi√ß√£o s√≥ via modal -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Evolu√ß√£o -->
    <div class="modal fade" id="modalEvolucao" tabindex="-1" aria-labelledby="modalEvolucaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalEvolucaoLabel">Registrar Nova Evolu√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <script>
                    // Limpar observadores quando o modal for fechado
                    document.getElementById('modalEvolucao').addEventListener('hidden.bs.modal', function () {
                        const editor = document.querySelector('#editor-container .ql-editor');
                        if (editor) {
                            limparObservadores(editor);
                        }
                    });
                </script>
                <div class="modal-body">
                    <form id="formEvolucao">
                        <div class="mb-3">
                            <label class="form-label">Texto da Evolu√ß√£o</label>
                            <!-- Editor container -->
                            <div id="editor-container"></div>
                            <!-- Hidden textarea to store the content -->
                            <textarea id="texto_evolucao" name="texto_evolucao" style="display:none"></textarea>
                            <small class="text-muted">Descreva a evolu√ß√£o do paciente, sinais, sintomas, exames, condutas realizadas, etc.</small>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Registrar Evolu√ß√£o</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="enfermagemSection" class="content-section">
        <!-- Admiss√£o de Enfermagem -->
        <div id="enfAdmissaoSection" class="enf-section card shadow-sm mb-4 active">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Admiss√£o de Enfermagem</h5>
            </div>
            <div class="card-body">
                <div id="admissao-texto-container">
                    <div class="texto-admissao">
                        {% if internacao.admissao_enfermagem %}
                            {{ internacao.admissao_enfermagem | safe }}
                        {% else %}
                            <div class="text-muted">Nenhuma admiss√£o de enfermagem registrada para este paciente.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Evolu√ß√µes de Enfermagem -->
        <div id="enfEvolucoesSection" class="enf-section card shadow-sm mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Evolu√ß√µes de Enfermagem</h5>
            </div>
            <div class="card-body">
                <!-- Seletor de data para filtrar evolu√ß√µes -->
                <div class="mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="filtro-data" class="form-label">Filtrar por data:</label>
                            <div class="input-group">
                                <input type="date" id="filtro-data" class="form-control form-control-sm">
                                <button class="btn btn-sm btn-outline-primary" id="btn-filtrar-data">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="btn-limpar-filtro">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3" id="hoje-container">
                    <h6 class="fw-bold text-success mb-2"><i class="fas fa-calendar-day me-1"></i> <span id="titulo-evolucoes-hoje">Evolu√ß√µes de Hoje</span></h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-medicamentos">
                            <thead class="table-info">
                                <tr>
                                    <th scope="col" style="width: 12%">Hora</th>
                                    <th scope="col" style="width: 13%">Enfermeiro</th>
                                    <th scope="col" style="width: 75%">Evolu√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="listaEvolucoesDoDia">
                                <tr>
                                    <td colspan="3" class="text-center">Carregando evolu√ß√µes de hoje...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mb-3" id="antigas-container">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-secondary mb-0"><i class="fas fa-history me-1"></i> Evolu√ß√µes Anteriores</h6>
                        <span class="badge bg-info" id="contador-evolucoes-antigas">0</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-medicamentos">
                            <thead class="table-secondary">
                                <tr>
                                    <th scope="col" style="width: 12%">Data/Hora</th>
                                    <th scope="col" style="width: 13%">Enfermeiro</th>
                                    <th scope="col" style="width: 75%">Evolu√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="listaEvolucoesAntigas">
                                <tr>
                                    <td colspan="3" class="text-center">Carregando evolu√ß√µes anteriores...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAE -->
        <div id="enfSAESection" class="enf-section card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Sistematiza√ß√£o da Assist√™ncia de Enfermagem (SAE)</h5>
                <div>
                    <button class="btn btn-light btn-sm" id="btn-historico-sae">
                        <i class="fas fa-history"></i> Ver Hist√≥rico
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="listaSAE">
                    <p class="text-center text-muted">Carregando dados da SAE...</p>
                </div>
                <div id="historicoSAE" style="display: none;">
                    <h6 class="mb-3 text-secondary"><i class="fas fa-history me-2"></i> Hist√≥rico de SAE</h6>
                    <div id="listaHistoricoSAE">
                        <p class="text-center text-muted">Carregando hist√≥rico...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="examesSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Exames Laboratoriais</h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarExames">
                    <i class="fas fa-edit"></i> Editar Exames
                </button>
            </div>
            <div class="card-body">
                <div id="examesLaboratoriaisTexto" class="texto-evolucao">
                    {{ internacao.exames_laboratoriais or 'N√£o registrado.' }}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Exames -->
    <div class="modal fade" id="modalEditarExames" tabindex="-1" aria-labelledby="modalEditarExamesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="modalEditarExamesLabel">Editar Exames Laboratoriais</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formExames">
                        <div class="mb-3">
                            <label for="textoExames" class="form-label">Exames Laboratoriais</label>
                            <textarea class="form-control" id="textoExames" name="textoExames" rows="10" 
                                placeholder="Registre os exames laboratoriais do paciente...">{{ internacao.exames_laboratoriais or '' }}</textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar Exames</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="receituarioSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Receitu√°rio</h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalNovaReceita">
                    <i class="fas fa-plus-circle"></i> Nova Receita
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3" id="hoje-container-receituario">
                    <h6 class="fw-bold text-success mb-2">
                        <i class="fas fa-calendar-day me-1"></i> 
                        <span id="titulo-receitas-hoje">Receitas de Hoje</span>
                    </h6>
                    <div id="listaReceitasDoDia">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
                
                <div class="mb-3" id="antigas-container-receituario">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-secondary mb-0">
                            <i class="fas fa-history me-1"></i> Receitas Anteriores
                        </h6>
                        <span class="badge bg-info" id="contador-receitas-antigas">0</span>
                    </div>
                    <div id="listaReceitasAntigas">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Receita -->
    <div class="modal fade" id="modalNovaReceita" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Nova Receita</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formReceita">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Receita</label>
                            <select class="form-select" id="tipo_receita" required>
                                <option value="">Selecione o tipo de receita</option>
                                <option value="normal">Receita Normal</option>
                                <option value="especial">Receita Especial</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Conte√∫do da Receita</label>
                            <div id="editor-receita-container">
                                <!-- Editor Quill ser√° inicializado aqui -->
                            </div>
                            <textarea id="conteudo_receita" name="conteudo_receita" style="display:none"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn_salvar_receita">Salvar Receita</button>
                </div>
            </div>
        </div>
    </div>

    <div id="fichaReferenciaSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-export me-2"></i>Fichas de Refer√™ncia
                </h5>
                <button class="btn btn-light btn-sm" id="btn_nova_ficha_referencia" data-bs-toggle="modal" data-bs-target="#modalNovaFichaReferencia">
                    <i class="fas fa-plus-circle"></i> Nova Ficha de Refer√™ncia
                </button>
            </div>
            <div class="card-body">
                <!-- Estat√≠sticas ser√£o inseridas aqui automaticamente pelo JS -->
                
                <div id="listaFichasReferencia">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin text-primary"></i> 
                        Carregando fichas de refer√™ncia...
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div id="atestadoSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Atestados</h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalNovoAtestado">
                    <i class="fas fa-plus-circle"></i> Novo Atestado
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3" id="hoje-container-atestado">
                    <h6 class="fw-bold text-success mb-2">
                        <i class="fas fa-calendar-day me-1"></i> 
                        <span id="titulo-atestados-hoje">Atestados de Hoje</span>
                    </h6>
                    <div id="listaAtestadosDoDia">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
                
                <div class="mb-3" id="antigas-container-atestado">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-secondary mb-0">
                            <i class="fas fa-history me-1"></i> Atestados Anteriores
                        </h6>
                        <span class="badge bg-info" id="contador-atestados-antigos">0</span>
                    </div>
                    <div id="listaAtestadosAntigos">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Atestado -->
    <div class="modal fade" id="modalNovoAtestado" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Novo Atestado</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formAtestado">
                        <div class="mb-3">
                            <label class="form-label">Dias de Afastamento</label>
                            <input type="number" class="form-control" id="dias_afastamento" min="1" placeholder="N√∫mero de dias">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Conte√∫do do Atestado</label>
                            <div id="editor-atestado-container">
                                <!-- Editor Quill ser√° inicializado aqui -->
                            </div>
                            <textarea id="conteudo_atestado" name="conteudo_atestado" style="display:none"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn_salvar_atestado">Salvar Atestado</button>
                </div>
            </div>
        </div>
    </div>

    <div id="imagensSection" class="content-section">
        <div class="alert alert-info">Visualiza√ß√£o de imagens ainda n√£o dispon√≠vel.</div>
    </div>

    <!-- Se√ß√£o de Informa√ß√µes de Internamento -->
    <div id="internamentoInfoSection" class="content-section">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Informa√ß√µes Detalhadas do Internamento</h5>
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnEditarInternamentoInfo">
                    <i class="fas fa-edit"></i> Editar Informa√ß√µes
                </button>
            </div>
            <div class="card-body">
                <div id="internamento-info-loading" class="text-center my-3">
                    <div class="spinner-border text-warning" role="status"><span class="visually-hidden">Carregando...</span></div>
                </div>
                <div id="internamento-info-content" style="display:none;"></div>
            </div>
            <div class="card-footer text-end" id="internamento-info-footer" style="display:none;">
                <!-- Bot√µes de Salvar/Cancelar para o modo de edi√ß√£o aparecer√£o aqui -->
            </div>
        </div>
    </div>

</div>

<!-- jQuery (deve ser carregado primeiro) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- CSS Fix para modais -->
<link rel="stylesheet" href="/static/css/modal_fix.css">

<style>
/* Fix inline para garantir que o bot√£o funcione */
#btn_salvar_ficha_referencia {
    position: relative !important;
    z-index: 1070 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
    display: inline-block !important;
}

.modal-footer {
    position: relative !important;
    z-index: 1060 !important;
    pointer-events: auto !important;
}

#modalNovaFichaReferencia .modal-footer .btn {
    position: relative !important;
    z-index: 1065 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
}

/* Estilos para o modal de RN */
#modalAdicionarRN .form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

#modalAdicionarRN .form-control:focus,
#modalAdicionarRN select.form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

#modalAdicionarRN .nav-tabs .nav-link.active {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

#modalAdicionarRN .nav-tabs .nav-link:hover {
    border-color: #28a745;
}

#modalAdicionarRN .nav-tabs .nav-link.disabled {
    color: #6c757d;
    background-color: transparent;
    border-color: transparent;
}

#modalAdicionarRN .alert-info {
    border-left: 4px solid #17a2b8;
}

#modalAdicionarRN .form-control[readonly] {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

#modalAdicionarRN .invalid-feedback {
    display: block;
}

#modalAdicionarRN .form-group {
    margin-bottom: 1rem;
}
</style>

<script src="/static/js/aprazamento.js"></script>
<script src="/static/js/calendario_aprazamento.js"></script>
<script src="/static/js/calculo_horarios.js"></script>
<script src="/static/js/modal_ficha_fix.js"></script>
<script src="/static/js/modal-rn-fix-ultimate.js"></script>

<!-- Definir vari√°veis globais importantes -->
<script>
    // Definir globalmente o ID do usu√°rio e cargo para os scripts
    const session = {
        cargo: "{{ session.get('cargo', '') }}",
        user_id: "{{ session.get('user_id', '') }}"
    };
</script>

<!-- Campo oculto para o ID do atendimento -->
<input type="hidden" id="atendimento_id" value="{{ internacao.atendimento_id }}">

<script>
    // Vari√°veis globais
    let quill;
    let medicamentosAdicionados = [];
    
    // Extrair e validar o ID da interna√ß√£o - declara√ß√£o local e global
    const internacaoId = parseInt("{{ internacao.id }}", 10);
    window.internacaoId = internacaoId; // Tamb√©m disponibilizar globalmente
    console.log('ID da interna√ß√£o:', internacaoId);
    
    // Verificar se internacaoId √© um n√∫mero v√°lido
    if (isNaN(internacaoId)) {
        console.error('Erro: ID da interna√ß√£o n√£o √© v√°lido!');
        alert('Erro ao carregar o ID da interna√ß√£o. Por favor, recarregue a p√°gina ou contate o suporte.');
    }

    $(document).ready(function() {
        const urlAnterior = "{{ url_anterior }}";
        
        // Iniciar carregamento das visualiza√ß√µes de enfermagem
        carregarEvolucoesEnfermagem();
        carregarPrescricoesEnfermagem();
        
        // Configurar filtros
        $('#filtrarEvolucoesPorData').on('change', function() {
            const dataFiltro = $(this).val();
            filtrarEvolucoesEnfermagemPorData(dataFiltro);
        });
        
        $('#filtrarPrescricoesPorData').on('change', function() {
            const dataFiltro = $(this).val();
            filtrarPrescricoesEnfermagemPorData(dataFiltro);
        });
        
        // Debugar cargo do usu√°rio
        console.log("Cargo do usu√°rio na sess√£o:", "{{ session.get('cargo') }}");
        
        // Verificar permiss√£o do usu√°rio
        if ("{{ session.get('cargo')|lower|trim }}" !== "medico") {
            $('body').prepend('<div class="alert alert-warning text-center">Esta p√°gina est√° otimizada para uso por m√©dicos. Algumas funcionalidades podem estar limitadas.</div>');
        }
        
        // Configurar navega√ß√£o das abas
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('#menuTabs .nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    const target = this.getAttribute('data-target');
                    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
                    if (target) document.getElementById(target).classList.add('active');
                });
            });

            // Ativar a primeira aba por padr√£o
            const primeiraAba = document.querySelector('#menuTabs .nav-link');
            if (primeiraAba) {
                primeiraAba.click();
            }
        });
        
        // Inicializar o Editor Quill
        try {
            console.log('A inicializa√ß√£o do editor Quill ser√° feita pelo script clinica_medico.js');
            
            // Configurar observadores modernos ap√≥s a inicializa√ß√£o (se necess√°rio)
            setTimeout(() => {
                const editor = document.querySelector('#editor-container .ql-editor');
                if (editor) {
                    configurarObservadoresModernos(editor);
                }
            }, 100);
        } catch (error) {
            console.error('Erro ao configurar o editor Quill:', error);
            // Criar um fallback para o editor
            $('#editor-container').html('<textarea id="fallback-editor" class="form-control" rows="10" placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>');
            
            // Atualizar o textarea oculto quando o fallback for alterado
            $('#fallback-editor').on('input', function() {
                $('#texto_evolucao').val($(this).val());
            });
        }

        // Carregar prescri√ß√µes ao iniciar
        carregarPrescricoes();
        
        // Carregar evolu√ß√µes ao iniciar
        carregarEvolucoes();
        
        // Inicializar m√≥dulo de receitas
        if (typeof inicializarModuloReceitas === 'function') {
            inicializarModuloReceitas();
        }
        
        // Adicionar evento para o bot√£o de adicionar medicamento

        
        // Preparar modal HDA quando for aberto
        $('#modalEditarHDA').on('show.bs.modal', function() {
            // Pegar o valor atual do textarea escondido e colocar no campo de edi√ß√£o
            const hdaAtual = $('#hdaTexto').val();
            $('#textoHDA').val(hdaAtual);
        });
        
        // Fun√ß√£o atualizarTabelaMedicamentos foi movida para clinica_medico.js
        
        // Adicionar listeners para eventos de carregamento de prescri√ß√µes
        $(document).on('click', 'a.nav-link[href="#prescricaoSection"]', function() {
            console.log('Clique na aba de prescri√ß√µes detectado');
            carregarPrescricoes();
        });

        $(document).on('click', '.fa-pills', function() {
            console.log('Clique no √≠cone de p√≠lulas detectado');
            carregarPrescricoes();
        });

        // Carregar dados ao iniciar
        carregarPrescricoes();
        carregarEvolucoes();
        
        // Carregar evolu√ß√µes de enfermagem
        carregarEvolucoesEnfermagem();
        
        // Carregar prescri√ß√µes de enfermagem
        carregarPrescricoesEnfermagem();
        
        // Configurar toggles para mostrar/ocultar evolu√ß√µes e prescri√ß√µes antigas
        $('#toggle-evolucoes-antigas').on('click', function() {
            const container = $('#antigas-container');
            const toggleText = $('#toggle-evolucoes-text');
            const toggleIcon = $(this).find('i');
            
            if (container.is(':visible')) {
                container.hide();
                toggleText.text('Mostrar Antigas');
                toggleIcon.removeClass('fa-eye-slash').addClass('fa-eye');
            } else {
                container.show();
                toggleText.text('Ocultar Antigas');
                toggleIcon.removeClass('fa-eye').addClass('fa-eye-slash');
            }
        });
        
        $('#toggle-prescricoes-antigas').on('click', function() {
            const container = $('#antigas-container-prescricao');
            if (container.is(':visible')) {
                container.hide();
                $('#toggle-prescricoes-text').text('Mostrar Antigas');
                $(this).find('i').removeClass('fa-eye-slash').addClass('fa-eye');
            } else {
                container.show();
                $('#toggle-prescricoes-text').text('Ocultar Antigas');
                $(this).find('i').removeClass('fa-eye').addClass('fa-eye-slash');
            }
        });
        
        // Carregar dados da SAE
        const pacienteId = parseInt("{{ paciente.id }}", 10);
        $.ajax({
            url: `/api/enfermagem/sae/${pacienteId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.sae) {
                    const sae = response.sae;
                    
                    // Montar a visualiza√ß√£o da SAE
                    let html = `
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div><strong>Data do Registro:</strong> ${new Date(sae.data_registro).toLocaleDateString('pt-BR')}</div>
                                    <div><span class="badge ${sae.eh_hoje ? 'bg-success' : 'bg-secondary'}">
                                        ${sae.eh_hoje ? 'Hoje' : 'Registro Anterior'}
                                    </span></div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-primary mb-2">Sinais Vitais</h6>
                                        <div class="row g-2">
                                            <div class="col-md-2"><strong>PA:</strong> ${sae.pa}</div>
                                            <div class="col-md-2"><strong>FC:</strong> ${sae.fc}</div>
                                            <div class="col-md-2"><strong>SAT:</strong> ${sae.sat}</div>
                                            <div class="col-md-2"><strong>R:</strong> ${sae.r}</div>
                                            <div class="col-md-2"><strong>T:</strong> ${sae.t}</div>
                                            <div class="col-md-2"><strong>Pulso:</strong> ${sae.pulso}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">Hip√≥tese Diagn√≥stica</h6>
                                        <div class="p-2 bg-light rounded">${sae.hipotese_diagnostica}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">DX</h6>
                                        <div class="p-2 bg-light rounded">${sae.dx}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-primary mb-2">Medica√ß√£o</h6>
                                        <div class="p-2 bg-light rounded">${sae.medicacao}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">Alergias</h6>
                                        <div class="p-2 bg-light rounded">${sae.alergias}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">Antecedentes Pessoais</h6>
                                        <div class="p-2 bg-light rounded">${sae.antecedentes_pessoais}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-primary mb-2">Diagn√≥stico de Enfermagem</h6>
                                        <div class="p-2 bg-light rounded">${sae.diagnostico_de_enfermagem}</div>
                                    </div>
                                </div>
                                
                                <div class="accordion" id="accordionSAE">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetalhes">
                                                Ver mais detalhes da SAE
                                            </button>
                                        </h2>
                                        <div id="collapseDetalhes" class="accordion-collapse collapse">
                                            <div class="accordion-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Sistema Neurol√≥gico</h6>
                                                        <div class="p-2 bg-light rounded">${sae.sistema_neurologico}</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Estado Geral</h6>
                                                        <div class="p-2 bg-light rounded">${sae.estado_geral}</div>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Ventila√ß√£o</h6>
                                                        <div class="p-2 bg-light rounded">${sae.ventilacao}</div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary mb-2">Pele</h6>
                                                        <div class="p-2 bg-light rounded">${sae.pele}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('#listaSAE').html(html);
                } else {
                    $('#listaSAE').html('<div class="alert alert-info">Nenhum registro SAE encontrado para este paciente.</div>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao carregar SAE:', xhr.responseText);
                
                // Se o erro for de permiss√£o (403), tentar buscar pelo hist√≥rico SAE
                if (xhr.status === 403) {
                    // Mostrar mensagem informativa
                    $('#listaSAE').html('<div class="alert alert-info">Acessando hist√≥rico de SAE...</div>');
                    
                    // Chamar diretamente a API de hist√≥rico SAE
                    const pacienteId = parseInt("{{ paciente.id }}", 10);
                    $.ajax({
                        url: `/api/enfermagem/sae/historico/${pacienteId}`,
                        method: 'GET',
                        success: function(response) {
                            if (response.success && response.sae && response.sae.length > 0) {
                                // Mostrar o primeiro registro como principal
                                const maisRecente = response.sae.sort((a, b) => new Date(b.data_registro) - new Date(a.data_registro))[0];
                                let htmlPrincipal = `
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div><strong>Data do Registro:</strong> ${new Date(maisRecente.data_registro).toLocaleDateString('pt-BR')}</div>
                                                <div><span class="badge bg-secondary">Via Hist√≥rico SAE</span></div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <h6 class="text-primary mb-2">Sinais Vitais</h6>
                                                    <div class="row g-2">
                                                        <div class="col-md-2"><strong>PA:</strong> ${maisRecente.pa}</div>
                                                        <div class="col-md-2"><strong>FC:</strong> ${maisRecente.fc}</div>
                                                        <div class="col-md-2"><strong>SAT:</strong> ${maisRecente.sat}</div>
                                                        <div class="col-md-2"><strong>R:</strong> ${maisRecente.r}</div>
                                                        <div class="col-md-2"><strong>T:</strong> ${maisRecente.t}</div>
                                                        <div class="col-md-2"><strong>Pulso:</strong> ${maisRecente.pulso}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">Hip√≥tese Diagn√≥stica</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.hipotese_diagnostica}</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">DX</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.dx}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <h6 class="text-primary mb-2">Medica√ß√£o</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.medicacao}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">Alergias</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.alergias}</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-2">Antecedentes Pessoais</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.antecedentes_pessoais}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <h6 class="text-primary mb-2">Diagn√≥stico de Enfermagem</h6>
                                                    <div class="p-2 bg-light rounded">${maisRecente.diagnostico_de_enfermagem}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="accordion" id="accordionSAE">
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetalhes">
                                                            Ver mais detalhes da SAE
                                                        </button>
                                                    </h2>
                                                    <div id="collapseDetalhes" class="accordion-collapse collapse">
                                                        <div class="accordion-body">
                                                            <div class="row mb-3">
                                                                <div class="col-md-6">
                                                                    <h6 class="text-primary mb-2">Sistema Neurol√≥gico</h6>
                                                                    <div class="p-2 bg-light rounded">${maisRecente.sistema_neurologico}</div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6 class="text-primary mb-2">Estado Geral</h6>
                                                                    <div class="p-2 bg-light rounded">${maisRecente.estado_geral}</div>
                                                                </div>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <div class="col-md-6">
                                                                    <h6 class="text-primary mb-2">Ventila√ß√£o</h6>
                                                                    <div class="p-2 bg-light rounded">${maisRecente.ventilacao}</div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6 class="text-primary mb-2">Pele</h6>
                                                                    <div class="p-2 bg-light rounded">${maisRecente.pele}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                // Atualizar view principal
                                $('#listaSAE').html(htmlPrincipal);
                                
                                // Mostrar o hist√≥rico automaticamente
                                $('#historicoSAE').show();
                                $('#btn-historico-sae').html('<i class="fas fa-times"></i> Ocultar Hist√≥rico');
                                
                                // Carregar resto do hist√≥rico normalmente
                                carregarHistoricoSAE();
                            } else {
                                $('#listaSAE').html('<div class="alert alert-info">Nenhum registro SAE encontrado para este paciente.</div>');
                            }
                        },
                        error: function() {
                            $('#listaSAE').html('<div class="alert alert-info">N√£o foi poss√≠vel acessar os dados de SAE.</div>');
                        }
                    });
                } else {
                    // Mostrar mensagem gen√©rica para outros erros
                    $('#listaSAE').html('<div class="alert alert-info">Nenhum registro SAE dispon√≠vel para este paciente.</div>');
                }
            }
        });

        // Adicionar fun√ß√µes para filtrar evolu√ß√µes e prescri√ß√µes por data
        
        // Configurar filtros
        $('#btn-filtrar-data').on('click', function() {
            const dataFiltro = $('#filtro-data').val();
            filtrarEvolucoesEnfermagemPorData(dataFiltro);
        });
        
        $('#btn-limpar-filtro').on('click', function() {
            $('#filtro-data').val('');
            carregarEvolucoesEnfermagem();
        });
        
        $('#btn-filtrar-data-prescricao').on('click', function() {
            const dataFiltro = $('#filtro-data-prescricao').val();
            filtrarPrescricoesEnfermagemPorData(dataFiltro);
        });
        
        $('#btn-limpar-filtro-prescricao').on('click', function() {
            $('#filtro-data-prescricao').val('');
            carregarPrescricoesEnfermagem();
        });
        
        // Configurar toggles para mostrar/ocultar evolu√ß√µes e prescri√ß√µes antigas
        $('#toggle-evolucoes-antigas').on('click', function() {
            const container = $('#antigas-container');
            const toggleText = $('#toggle-evolucoes-text');
            const toggleIcon = $(this).find('i');
            
            if (container.is(':visible')) {
                container.hide();
                toggleText.text('Mostrar Antigas');
                toggleIcon.removeClass('fa-eye-slash').addClass('fa-eye');
            } else {
                container.show();
                toggleText.text('Ocultar Antigas');
                toggleIcon.removeClass('fa-eye').addClass('fa-eye-slash');
            }
        });
        
        $('#toggle-prescricoes-antigas').on('click', function() {
            const container = $('#antigas-container-prescricao');
            if (container.is(':visible')) {
                container.hide();
                $('#toggle-prescricoes-text').text('Mostrar Antigas');
                $(this).find('i').removeClass('fa-eye-slash').addClass('fa-eye');
            } else {
                container.show();
                $('#toggle-prescricoes-text').text('Ocultar Antigas');
                $(this).find('i').removeClass('fa-eye').addClass('fa-eye-slash');
            }
        });
        
        // Configurar bot√£o para mostrar hist√≥rico SAE
        $('#btn-historico-sae').on('click', function() {
            const historicoContainer = $('#historicoSAE');
            if (historicoContainer.is(':visible')) {
                historicoContainer.hide();
                $(this).html('<i class="fas fa-history"></i> Ver Hist√≥rico');
            } else {
                carregarHistoricoSAE();
                historicoContainer.show();
                $(this).html('<i class="fas fa-times"></i> Ocultar Hist√≥rico');
            }
        });

        // Ativar se√ß√£o Enfermagem ao clicar no submenu
        $('.submenu .nav-link').on('click', function(){
            $('a.nav-link[href="#enfermagemSection"]').click();
        });

        // Inicializar visibilidade das se√ß√µes de enfermagem
        $('.enf-section').removeClass('active').hide();
        $('#enfAdmissaoSection').addClass('active').show();

        // Clique no submenu para alternar se√ß√µes
        $('.submenu-link').on('click', function(e){
            e.preventDefault();
            const alvo = $(this).data('enf-target');

            // Atualizar links ativos
            $('.submenu .nav-link').removeClass('active');
            $(this).addClass('active');

            // Mostrar se√ß√£o correspondente
            $('.enf-section').removeClass('active').hide();
            $('#' + alvo).addClass('active').show();

            // Garantir que aba Enfermagem esteja ativada
            $('a.nav-link[href="#enfermagemSection"]').addClass('active');
        });

        // Evento para abrir o modal de hist√≥rico de internamentos
        $('#btnHistoricoInternamentos').on('click', function() {
            $('#modalHistoricoInternamentos').modal('show');
            carregarHistoricoInternamentos();
        });
        
        // Evento para o bot√£o Adicionar RN
        $('#btnAdicionarRN').on('click', function() {
            console.log('Bot√£o Adicionar RN clicado');
            $('#modalAdicionarRN').modal('show');
            resetarModalAdicionarRN();
        });
        
        // Evento para o bot√£o Adicionar RN no Resumo
        $('#btnAdicionarRNResumo').on('click', function() {
            console.log('Bot√£o Adicionar RN (Resumo) clicado');
            $('#modalAdicionarRN').modal('show');
            resetarModalAdicionarRN();
        });
        
        // Evento para o bot√£o Hist√≥rico no Resumo
        $('#btnHistoricoResumo').on('click', function() {
            $('#modalHistoricoInternamentos').modal('show');
            carregarHistoricoInternamentos();
        });
        
        // Carregar informa√ß√µes do resumo geral
        carregarResumoGeral();
        
        // Recarregar informa√ß√µes quando abrir o modal de impress√£o
        $('#modalOpcoesImpressao').on('show.bs.modal', function() {
            // Verificar se j√° temos as informa√ß√µes, sen√£o recarregar
            if ($('#infoPrescricaoModal').text().includes('Carregando')) {
                carregarResumoGeral();
            }
        });
        
        // Eventos dos bot√µes de debug
        $('#btn-show-debug').on('click', function() {
            $('#debug-panel').show();
            atualizarInformacoesDebug();
        });
        
        $('#btn-toggle-debug').on('click', function() {
            $('#debug-panel').hide();
        });
        
        $('#btn-debug-reload').on('click', function() {
            carregarHistoricoInternamentos();
        });
        
        // M√°scaras e valida√ß√µes para campos do RN
        $('#pesoRN').on('input', function() {
            let valor = $(this).val();
            // Permitir apenas n√∫meros
            valor = valor.replace(/[^0-9]/g, '');
            if (valor.length > 4) valor = valor.substring(0, 4);
            $(this).val(valor);
            
            // Valida√ß√£o visual
            if (valor && (parseInt(valor) < 500 || parseInt(valor) > 8000)) {
                $(this).addClass('is-invalid');
                if (!$(this).next('.invalid-feedback').length) {
                    $(this).after('<div class="invalid-feedback">Peso deve estar entre 500g e 8000g</div>');
                }
            } else {
                $(this).removeClass('is-invalid');
                $(this).next('.invalid-feedback').remove();
            }
        });
        
        $('#alturaRN').on('input', function() {
            let valor = $(this).val();
            // Permitir apenas n√∫meros e ponto decimal
            valor = valor.replace(/[^0-9.]/g, '');
            // Limitar a 2 casas decimais
            if (valor.indexOf('.') !== -1) {
                const partes = valor.split('.');
                if (partes[1] && partes[1].length > 1) {
                    valor = partes[0] + '.' + partes[1].substring(0, 1);
                }
            }
            $(this).val(valor);
            
            // Valida√ß√£o visual
            if (valor && (parseFloat(valor) < 30 || parseFloat(valor) > 70)) {
                $(this).addClass('is-invalid');
                if (!$(this).next('.invalid-feedback').length) {
                    $(this).after('<div class="invalid-feedback">Altura deve estar entre 30cm e 70cm</div>');
                }
            } else {
                $(this).removeClass('is-invalid');
                $(this).next('.invalid-feedback').remove();
            }
        });
        
        // Formata√ß√£o autom√°tica do nome do RN
        $('#nomeRN').on('input', function() {
            let valor = $(this).val().toUpperCase();
            $(this).val(valor);
        });
        
        // Valida√ß√£o do Apgar
        $('#apgarRN').on('input', function() {
            let valor = $(this).val();
            // Permitir formato como 8/9 ou 8-9
            valor = valor.replace(/[^0-9\/\-]/g, '');
            $(this).val(valor);
        });
        
        // Auto-foco no pr√≥ximo campo ao pressionar Enter
        $('#nomeRN').on('keypress', function(e) {
            if (e.which === 13) {
                e.preventDefault();
                $('#sexoRN').focus();
            }
        });
        
        $('#sexoRN').on('change', function() {
            $('#dataNascimentoRN').focus();
        });
        
        // Atalhos de teclado para o modal RN
        $(document).on('keydown', function(e) {
            // Verificar se o modal RN est√° aberto
            if ($('#modalAdicionarRN').hasClass('show')) {
                // Ctrl + Enter para avan√ßar para pr√≥xima aba ou salvar
                if (e.ctrlKey && e.which === 13) {
                    e.preventDefault();
                    const abaAtiva = $('#adicionarRNTabs .nav-link.active').attr('id');
                    if (abaAtiva === 'dados-rn-tab') {
                        $('#proximoRN').trigger('click');
                    } else if (abaAtiva === 'internacao-rn-tab') {
                        $('#finalizarRN').trigger('click');
                    }
                }
                
                // Escape para fechar modal
                if (e.which === 27) {
                    $('#modalAdicionarRN').modal('hide');
                }
                
                // Alt + 1 para aba 1, Alt + 2 para aba 2
                if (e.altKey && e.which === 49) { // Alt + 1
                    e.preventDefault();
                    $('#dados-rn-tab').tab('show');
                }
                if (e.altKey && e.which === 50) { // Alt + 2
                    e.preventDefault();
                    if (!$('#internacao-rn-tab').hasClass('disabled')) {
                        $('#internacao-rn-tab').tab('show');
                    }
                }
            }
        });
    });
    
    // Todas as fun√ß√µes foram movidas para o arquivo clinica_medico.js
    
    // Handler personalizado para modal HDA - Corre√ß√£o do erro de backdrop
    $(document).ready(function() {
        // Remover handlers conflitantes
        $('#modalEditarHDA').off('show.bs.modal shown.bs.modal');
        
        // Handler personalizado para o bot√£o editar HDA
        $(document).on('click', '[data-bs-target="#modalEditarHDA"]', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            try {
                // Pegar valor atual do HDA
                const hdaAtual = $('#hdaTexto').val() || '';
                $('#textoHDA').val(hdaAtual);
                
                // Verificar se o modal existe
                const modalElement = document.getElementById('modalEditarHDA');
                if (!modalElement) {
                    console.error('Modal HDA n√£o encontrado');
                    return false;
                }
                
                // Tentar abrir com Bootstrap 5
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    // Remover inst√¢ncia existente se houver
                    const existingInstance = bootstrap.Modal.getInstance(modalElement);
                    if (existingInstance) {
                        existingInstance.dispose();
                    }
                    
                    // Criar nova inst√¢ncia
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: 'static',
                        keyboard: true,
                        focus: true
                    });
                    
                    modal.show();
                    
                } else {
                    // Fallback para jQuery
                    $('#modalEditarHDA').modal('show');
                }
                
            } catch (error) {
                console.error('Erro ao abrir modal HDA:', error);
                // √öltimo recurso - mostrar modal manualmente
                $('#modalEditarHDA')
                    .removeClass('fade')
                    .addClass('show')
                    .css({
                        'display': 'block',
                        'padding-right': '17px'
                    });
                
                $('body').addClass('modal-open');
                
                // Adicionar backdrop
                if ($('.modal-backdrop').length === 0) {
                    $('body').append('<div class="modal-backdrop fade show"></div>');
                }
            }
            
            return false;
        });
    });
</script>
<!-- Modal Nova Prescri√ß√£o -->
<div class="modal fade" id="modalNovaPrescricao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Nova Prescri√ß√£o M√©dica</h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="collapse" data-bs-target="#ajudaPrescricao" aria-expanded="false">
                        <i class="fas fa-question-circle"></i> Ajuda
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Se√ß√£o de Ajuda Colaps√°vel -->
                <div class="collapse" id="ajudaPrescricao">
                    <div class="card card-body mb-3 bg-light">
                        <h6 class="fw-bold mb-2"><i class="fas fa-lightbulb text-warning me-1"></i> Como usar as prescri√ß√µes:</h6>
                        <ul class="mb-2 small">
                            <li><strong>Nova Prescri√ß√£o:</strong> Crie uma prescri√ß√£o do zero preenchendo os campos</li>
                            <li><strong>Baseada em Anterior:</strong> Clique no √≠cone <i class="fas fa-copy text-primary"></i> de qualquer prescri√ß√£o para usar como base</li>
                            <li><strong>Modifica√ß√£o:</strong> Quando baseada, voc√™ pode adicionar/remover medicamentos e editar campos</li>
                            <li><strong>Teclas r√°pidas:</strong> Use Enter para navegar entre campos de medicamentos</li>
                        </ul>
                    </div>
                </div>
                
                <form id="formPrescricao">
                    <div class="mb-3">
                        <label class="form-label">Dieta</label>
                        <textarea class="form-control" id="texto_dieta" rows="2" placeholder="Descreva a dieta do paciente..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Medicamentos</label>
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="nome_medicamento" placeholder="Nome do medicamento">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="descricao_posologia" placeholder="Descri√ß√£o de uso / Posologia">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success w-100" id="btn_adicionar_medicamento">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm" id="tabela_medicamentos">
                                <thead>
                                    <tr>
                                        <th>Medicamento</th>
                                        <th>Descri√ß√£o/Posologia</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="sem_medicamentos">
                                        <td colspan="3" class="text-center text-muted">Nenhum medicamento adicionado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Procedimentos M√©dicos</label>
                        <textarea class="form-control" id="texto_procedimento_medico" rows="3" placeholder="Descreva os procedimentos m√©dicos..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Procedimentos Multiprofissionais</label>
                        <textarea class="form-control" id="texto_procedimento_multi" rows="3" placeholder="Descreva os procedimentos multiprofissionais..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn_salvar_prescricao">Salvar Prescri√ß√£o</button>
            </div>
        </div>
    </div>
</div>


<script>
    // Vari√°veis globais
    window.medicamentosAdicionados = window.medicamentosAdicionados || [];
    
    // Evento para abrir o modal de nova prescri√ß√£o
    $('#btn-nova-prescricao').on('click', function() {
        // Limpar o formul√°rio
        $('#formPrescricao')[0].reset();
        window.medicamentosAdicionados = [];
        atualizarTabelaMedicamentos();
        
        // Restaurar t√≠tulo original do modal
        $('#modalNovaPrescricao .modal-title').text('Nova Prescri√ß√£o M√©dica');
        
        // Remover indicador de prescri√ß√£o baseada se existir
        $('#indicador-prescricao-base').remove();
        
        // Abrir o modal
        $('#modalNovaPrescricao').modal('show');
    });
    
    
    // Evento para adicionar medicamento
    $('#btn_adicionar_medicamento').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const nome_medicamento = $('#nome_medicamento').val().trim();
        const descricao = $('#descricao_posologia').val().trim();
        if (!nome_medicamento) {
            alert('Por favor, informe o nome do medicamento.');
            return;
        }
        window.medicamentosAdicionados.push({
            nome_medicamento: nome_medicamento,
            descricao_uso: descricao
        });
        // Limpar campos
        $('#nome_medicamento').val('');
        $('#descricao_posologia').val('');
        atualizarTabelaMedicamentos();
        $('#nome_medicamento').focus();
    });
    
    // Evento para salvar prescri√ß√£o
    $('#btn_salvar_prescricao').on('click', function(e) {
        e.preventDefault(); // Previne o comportamento padr√£o do bot√£o
        
        const texto_dieta = $('#texto_dieta').val().trim();
        const texto_procedimento_medico = $('#texto_procedimento_medico').val().trim();
        const texto_procedimento_multi = $('#texto_procedimento_multi').val().trim();
        
        // Verificar se ao menos algo foi preenchido
        if (!texto_dieta && !texto_procedimento_medico && !texto_procedimento_multi && window.medicamentosAdicionados.length === 0) {
            alert('Por favor, preencha pelo menos um dos campos da prescri√ß√£o ou adicione ao menos um medicamento.');
            return;
        }
        
        // Preparar dados para envio
        const dados = {
            atendimentos_clinica_id: internacaoId,
            texto_dieta: texto_dieta || null,
            texto_procedimento_medico: texto_procedimento_medico || null,
            texto_procedimento_multi: texto_procedimento_multi || null,
            medicamentos: window.medicamentosAdicionados
        };
        
        // Mostrar indicador de carregamento
        const btnSalvar = $(this);
        const textoOriginal = btnSalvar.html();
        btnSalvar.html('<i class="fas fa-spinner fa-spin"></i> Salvando...').prop('disabled', true);
        
        // Enviar requisi√ß√£o
        $.ajax({
            url: '/api/prescricoes',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dados),
            success: async function(response) {
                if (response.success) {
                    try {
                        // Limpar o formul√°rio
                        $('#formPrescricao')[0].reset();
                        window.medicamentosAdicionados = [];
                        atualizarTabelaMedicamentos();
                        
                        // Fechar modal
                        $('#modalNovaPrescricao').modal('hide');
                        
                        // For√ßar atualiza√ß√£o das prescri√ß√µes
                        await carregarPrescricoes();
                        
                        // Mostrar mensagem de sucesso
                        const alertHtml = `
                            <div class="alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3" role="alert" style="z-index: 1060">
                                Prescri√ß√£o registrada com sucesso!
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `;
                        $('body').append(alertHtml);
                        
                        // Remover o alerta ap√≥s 3 segundos
                        setTimeout(function() {
                            $('.alert').alert('close');
                        }, 3000);
                        
                        // For√ßar atualiza√ß√£o da visualiza√ß√£o
                        $('#prescricaoSection').show();
                        $('#listaPrescricoesDoDia').html('<tr><td colspan="3" class="text-center"><i class="fas fa-spinner fa-spin"></i> Atualizando prescri√ß√µes...</td></tr>');
                        
                        // Recarregar prescri√ß√µes novamente ap√≥s um pequeno delay
                        setTimeout(async function() {
                            await carregarPrescricoes();
                        }, 500);
                        
                    } catch (error) {
                        console.error('Erro ao atualizar prescri√ß√µes:', error);
                    }
                } else {
                    alert('Erro ao registrar prescri√ß√£o: ' + (response.message || 'Erro desconhecido'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao registrar prescri√ß√£o:', xhr.responseText);
                alert('Erro ao registrar prescri√ß√£o: ' + (xhr.responseJSON?.error || error));
            },
            complete: function() {
                // Restaurar bot√£o
                btnSalvar.html(textoOriginal).prop('disabled', false);
            }
        });
    });
    
    // Adicionar evento de tecla para os campos de medicamento
    
    // Adicionar evento de tecla para os campos de medicamento
    $('#nome_medicamento, #descricao_posologia').on('keypress', function(e) {
        // Se pressionar Enter
        if (e.which === 13) {
            e.preventDefault(); // Previne o comportamento padr√£o
            // Se estiver no campo nome, vai para quantidade
            if ($(this).attr('id') === 'nome_medicamento') {
                $('#descricao_posologia').focus();
            } else {
                // Se estiver na quantidade, aciona o bot√£o adicionar
                $('#btn_adicionar_medicamento').click();
            }
        }
    });
    
    // Prevenir submiss√£o do formul√°rio ao pressionar Enter
    $('#formPrescricao').on('submit', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Evento para salvar exames laboratoriais
    $('#formExames').on('submit', function(e) {
        e.preventDefault();
        
        const textoExames = $('#textoExames').val().trim();
        
        // Mostrar indicador de carregamento
        const btnSubmit = $(this).find('button[type="submit"]');
        const textoOriginal = btnSubmit.html();
        btnSubmit.html('<i class="fas fa-spinner fa-spin"></i> Salvando...').prop('disabled', true);
        
        // Enviar requisi√ß√£o para atualizar exames
        $.ajax({
            url: `/api/internacao/${internacaoId}/atualizar`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                exames_laboratoriais: textoExames
            }),
            success: function(response) {
                if (response.success) {
                    // Atualizar o texto na tela
                    $('#examesLaboratoriaisTexto').html(textoExames || 'N√£o registrado.');
                    
                    // Fechar o modal
                    $('#modalEditarExames').modal('hide');
                    
                    // Mostrar mensagem de sucesso
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3" role="alert" style="z-index: 1060">
                            Exames laboratoriais atualizados com sucesso!
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    $('body').append(alertHtml);
                    
                    // Remover o alerta ap√≥s 3 segundos
                    setTimeout(function() {
                        $('.alert').alert('close');
                    }, 3000);
                } else {
                    alert('Erro ao atualizar exames: ' + (response.message || 'Erro desconhecido'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao atualizar exames:', xhr.responseText);
                alert('Erro ao atualizar exames: ' + (xhr.responseJSON?.error || error));
            },
            complete: function() {
                // Restaurar bot√£o
                btnSubmit.html(textoOriginal).prop('disabled', false);
            }
        });
    });
</script>
 
<script>




    // ==== FUNCIONALIDADES PARA ADICIONAR RN ====
    
    // Fun√ß√£o para resetar o modal de adicionar RN
    function resetarModalAdicionarRN() {
        console.log('üîÑ Resetando modal de adicionar RN...');
        
        // Voltar para a primeira aba
        $('#dados-rn-tab').tab('show');
        $('#internacao-rn-tab').addClass('disabled');
        
        // Limpar formul√°rios
        $('#dadosRNForm')[0].reset();
        $('#internacaoRNForm')[0].reset();
        
        // Definir data padr√£o como hoje
        const hoje = new Date().toISOString().split('T')[0];
        $('#dataNascimentoRN').val(hoje);
        
        // Definir hora atual como padr√£o
        const agora = new Date();
        const horaAtual = agora.getHours().toString().padStart(2, '0') + ':' + agora.getMinutes().toString().padStart(2, '0');
        $('#horaNascimentoRN').val(horaAtual);
        
        // Preencher nome sugerido
        $('#nomeRN').val('RN DE {{ paciente.nome|upper }}');
        
        // Preencher valores padr√£o para campos de interna√ß√£o
        $('#caraterInternacaoRN').val('Urg√™ncia');
        $('#cidPrincipalRN').val('Z38.0');
        $('#hdaRN').val('');
        $('#diagnosticoInicialRN').val('');
        $('#anamneseExameFisicoRN').val('');
        $('#condutaInicialRN').val('');
        $('#primeiraEvolucaoRN').val('');
        
        // Carregar leitos para o RN
        carregarLeitosRN();
        
        // Remover qualquer classe de valida√ß√£o
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        // Limpar dados de sess√£o
        sessionStorage.removeItem('dadosRN');
        
        // Inicializar tooltips
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('#modalAdicionarRN [data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        console.log('‚úÖ Modal RN resetado com valores padr√£o');
    }
    
    // Fun√ß√£o para carregar leitos dispon√≠veis
    function carregarLeitosRN() {
        fetch('/api/leitos/opcoes')
            .then(response => response.json())
            .then(data => {
                const leitoSelect = $('#leitoRN');
                leitoSelect.empty();
                leitoSelect.append('<option value="">Selecione um leito...</option>');
                
                if (data && data.length > 0) {
                    data.forEach(leito => {
                        // Verificar se o leito est√° dispon√≠vel (n√£o ocupado)
                        const statusBadge = leito.status === 'Dispon√≠vel' ? 
                            '<span class="text-success">‚úì</span>' : 
                            '<span class="text-warning">‚ö†</span>';
                        
                        const ocupacao = leito.ocupacao_atual || 0;
                        const capacidade = leito.capacidade_maxima || 1;
                        const vagasDisponiveis = capacidade - ocupacao;
                        
                        // S√≥ mostrar leitos com vagas dispon√≠veis
                        if (vagasDisponiveis > 0) {
                            const leitoInfo = `${leito.nome} - ${leito.tipo || 'N/A'}`;
                            const setorInfo = leito.setor ? ` (${leito.setor})` : '';
                            const vagasInfo = ` - ${vagasDisponiveis}/${capacidade} vagas`;
                            
                            leitoSelect.append(`
                                <option value="${leito.nome}" title="Setor: ${leito.setor || 'N/A'} | Status: ${leito.status} | Vagas: ${vagasDisponiveis}/${capacidade}">
                                    ${leitoInfo}${setorInfo}${vagasInfo}
                                </option>
                            `);
                        }
                    });
                    
                    // Se n√£o h√° leitos dispon√≠veis
                    if (leitoSelect.children().length === 1) {
                        leitoSelect.append('<option value="">Nenhum leito com vagas dispon√≠veis</option>');
                    }
                } else {
                    leitoSelect.append('<option value="">Nenhum leito cadastrado</option>');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar leitos:', error);
                $('#leitoRN').html('<option value="">Erro ao carregar leitos</option>');
            });
    }
    
    // ==== HANDLERS DE FORMUL√ÅRIO RN - COMENTADOS PARA USAR FIX ULTIMATE ====
    // O handler de submit foi movido para modal-rn-fix-ultimate.js
    /*
    // Submiss√£o do formul√°rio de dados do RN (etapa 1)
    $('#dadosRNForm').on('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('=== INICIANDO VALIDA√á√ÉO E TRANSI√á√ÉO RN ===');
        
        // Prevenir fechamento do modal durante a transi√ß√£o
        $('#modalAdicionarRN').off('hide.bs.modal hidden.bs.modal');
        
        const nomeRN = $('#nomeRN').val().trim();
        const sexoRN = $('#sexoRN').val();
        const dataNascimentoRN = $('#dataNascimentoRN').val();
        const corRN = $('#corRN').val();
        const pesoRN = $('#pesoRN').val();
        const alturaRN = $('#alturaRN').val();
        
        // Remover valida√ß√µes anteriores
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        let hasError = false;
        
        // Valida√ß√µes b√°sicas
        if (!nomeRN) {
            $('#nomeRN').addClass('is-invalid');
            $('#nomeRN').after('<div class="invalid-feedback">Nome √© obrigat√≥rio</div>');
            hasError = true;
        }
        
        if (!sexoRN) {
            $('#sexoRN').addClass('is-invalid');
            $('#sexoRN').after('<div class="invalid-feedback">Sexo √© obrigat√≥rio</div>');
            hasError = true;
        }
        
        if (!dataNascimentoRN) {
            $('#dataNascimentoRN').addClass('is-invalid');
            $('#dataNascimentoRN').after('<div class="invalid-feedback">Data de nascimento √© obrigat√≥ria</div>');
            hasError = true;
        }
        
        if (!corRN) {
            $('#corRN').addClass('is-invalid');
            $('#corRN').after('<div class="invalid-feedback">Ra√ßa/Cor √© obrigat√≥ria</div>');
            hasError = true;
        }
        
        // Validar data de nascimento (n√£o pode ser futura)
        if (dataNascimentoRN) {
            const dataHoje = new Date();
            const dataNasc = new Date(dataNascimentoRN);
            const umMesAtras = new Date();
            umMesAtras.setMonth(umMesAtras.getMonth() - 1);
            
            if (dataNasc > dataHoje) {
                $('#dataNascimentoRN').addClass('is-invalid');
                $('#dataNascimentoRN').after('<div class="invalid-feedback">A data de nascimento n√£o pode ser no futuro</div>');
                hasError = true;
            } else if (dataNasc < umMesAtras) {
                $('#dataNascimentoRN').addClass('is-invalid');
                $('#dataNascimentoRN').after('<div class="invalid-feedback">Data muito antiga para um RN (m√°ximo 1 m√™s)</div>');
                hasError = true;
            }
        }
        
        // Validar peso se preenchido
        if (pesoRN && (parseInt(pesoRN) < 500 || parseInt(pesoRN) > 8000)) {
            $('#pesoRN').addClass('is-invalid');
            $('#pesoRN').after('<div class="invalid-feedback">Peso deve estar entre 500g e 8000g</div>');
            hasError = true;
        }
        
        // Validar altura se preenchida
        if (alturaRN && (parseFloat(alturaRN) < 30 || parseFloat(alturaRN) > 70)) {
            $('#alturaRN').addClass('is-invalid');
            $('#alturaRN').after('<div class="invalid-feedback">Altura deve estar entre 30cm e 70cm</div>');
            hasError = true;
        }
        
        if (hasError) {
            // Focar no primeiro campo com erro
            $('.is-invalid').first().focus();
            console.log('‚ùå Erro na valida√ß√£o, interrompendo transi√ß√£o');
            return false;
        }
        
        // Armazenar dados temporariamente
        const dadosRN = {
            nome: nomeRN,
            sexo: sexoRN,
            data_nascimento: dataNascimentoRN,
            hora_nascimento: $('#horaNascimentoRN').val(),
            peso: pesoRN,
            altura: alturaRN,
            cor: corRN,
            apgar: $('#apgarRN').val(),
            filiacao: $('#filiacaoRN').val(),
            telefone: $('#telefoneRN').val(),
            endereco: $('#enderecoRN').val(),
            bairro: $('#bairroRN').val(),
            municipio: $('#municipioRN').val(),
            observacoes: $('#observacoesRN').val()
        };
        
        sessionStorage.setItem('dadosRN', JSON.stringify(dadosRN));
        console.log('‚úÖ Dados do RN salvos:', dadosRN);
        
        // Garantir que o modal permane√ßa aberto
        $('#modalAdicionarRN').modal('show');
        
        // Aguardar um pouco antes de fazer a transi√ß√£o para garantir estabilidade
        setTimeout(function() {
            console.log('üîÑ Iniciando transi√ß√£o entre abas...');
            
            // Habilitar e mostrar a pr√≥xima aba
            $('#internacao-rn-tab').removeClass('disabled').removeAttr('disabled');
            
            // Esconder aba atual
            $('#dados-rn').removeClass('show active');
            $('#dados-rn-tab').removeClass('active').attr('aria-selected', 'false');
            
            // Mostrar pr√≥xima aba
            $('#internacao-rn').addClass('show active');
            $('#internacao-rn-tab').addClass('active').attr('aria-selected', 'true');
            
            console.log('‚úÖ Transi√ß√£o de abas conclu√≠da');
            
            // Mostrar mensagem de sucesso
            setTimeout(function() {
                // Usar alert simples para garantir que apare√ßa
                alert('‚úÖ Dados do RN salvos com sucesso!\n\nAgora preencha os dados da interna√ß√£o.');
            }, 200);
            
        }, 300);
        
        return false; // Importante: evitar comportamento padr√£o
    });
    */
    
    /*
    // Submiss√£o do formul√°rio de interna√ß√£o do RN (etapa 2)
    $('#internacaoRNForm').on('submit', function(e) {
        e.preventDefault();
        
        // Verificar se um leito foi selecionado
        const leitoSelecionado = $('#leitoRN').val();
        if (!leitoSelecionado) {
            alert('Por favor, selecione um leito para o RN.');
            return;
        }
        
        // Verificar se a primeira evolu√ß√£o foi preenchida
        const primeiraEvolucao = $('#primeiraEvolucaoRN').val().trim();
        if (!primeiraEvolucao) {
            alert('Por favor, preencha a Primeira Evolu√ß√£o do RN.');
            $('#primeiraEvolucaoRN').focus();
            return;
        }
        
        // Coletar dados da interna√ß√£o
        const dadosInternacao = {
            leito_id: leitoSelecionado,
            carater_internacao: $('#caraterInternacaoRN').val(),
            hda: $('#hdaRN').val(),
            diagnostico_inicial: $('#diagnosticoInicialRN').val(),
            anamnese_exame_fisico: $('#anamneseExameFisicoRN').val(),
            conduta_inicial: $('#condutaInicialRN').val(),
            primeira_evolucao: $('#primeiraEvolucaoRN').val(),
            cid_principal: $('#cidPrincipalRN').val(),
            cid_10_secundario: $('#cid10SecundarioRN').val(),
            cid_10_causas_associadas: $('#cid10CausasAssociadasRN').val(),
            exames_realizados: $('#examesRealizadosRN').val()
        };
        
        // Recuperar dados do RN
        const dadosRN = JSON.parse(sessionStorage.getItem('dadosRN'));
        
        // Criar payload completo
        const payload = {
            paciente: dadosRN,
            internacao: dadosInternacao,
            paciente_mae_id: "{{ paciente.id }}", // ID da m√£e
            tipo: 'rn' // Identificar como RN
        };
        
        console.log('Payload para adicionar RN:', payload);
        
        // Mostrar loading
        const btnSubmit = $(this).find('button[type="submit"]');
        const textoOriginal = btnSubmit.html();
        btnSubmit.html('<i class="fas fa-spinner fa-spin me-1"></i> Cadastrando RN...').prop('disabled', true);
        
        // Enviar para o backend
        fetch('/api/adicionar-rn', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar detalhes do sucesso
                const detalhes = data.dados || {};
                const mensagem = `RN adicionado com sucesso!\n\n` +
                               `Nome: ${detalhes.nome_rn || 'N/A'}\n` +
                               `M√£e: ${detalhes.nome_mae || 'N/A'}\n` +
                               `Leito: ${detalhes.leito || 'N/A'}\n` +
                               `Peso: ${detalhes.peso ? detalhes.peso + 'g' : 'N/A'}\n` +
                               `Altura: ${detalhes.altura ? detalhes.altura + 'cm' : 'N/A'}\n` +
                               `Apgar: ${detalhes.apgar || 'N/A'}\n\n` +
                               `ID Atendimento: ${data.atendimento_id || 'N/A'}`;
                
                alert(mensagem);
                $('#modalAdicionarRN').modal('hide');
                
                // Recarregar p√°gina ap√≥s 1 segundo para mostrar o novo paciente
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Erro ao adicionar RN: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro ao adicionar RN:', error);
            alert('Erro ao adicionar RN. Verifique os dados e tente novamente.');
        })
        .finally(() => {
            btnSubmit.html(textoOriginal).prop('disabled', false);
        });
    });
    */
    // ==== FIM DOS HANDLERS COMENTADOS ====
    
    // Bot√£o voltar na segunda aba
    $('#btnVoltarDadosRN').on('click', function() {
        $('#dados-rn-tab').tab('show');
    });
    
    // Event listener para quando o modal for fechado
    $('#modalAdicionarRN').on('hidden.bs.modal', function() {
        // Limpar dados tempor√°rios
        sessionStorage.removeItem('dadosRN');
        
        // Destruir tooltips para evitar vazamentos de mem√≥ria
        $('#modalAdicionarRN [data-bs-toggle="tooltip"]').each(function() {
            const tooltip = bootstrap.Tooltip.getInstance(this);
            if (tooltip) {
                tooltip.dispose();
            }
        });
        
        console.log('Modal RN fechado e dados limpos');
    });
    
    // Prevenir fechamento acidental do modal durante a transi√ß√£o
    $('#modalAdicionarRN').on('hide.bs.modal', function(e) {
        // Se estamos na segunda aba (dados da interna√ß√£o), prevenir fechamento acidental
        if ($('#internacao-rn').hasClass('active')) {
            console.log('‚ö†Ô∏è Prevenindo fechamento durante transi√ß√£o para segunda aba');
            // Verificar se realmente √© um fechamento acidental (n√£o intencional)
            const target = e.relatedTarget || e.target;
            if (!target || !$(target).hasClass('btn-close')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
    });
    
    // Fun√ß√£o de debug para o modal RN (apenas para desenvolvimento)
    window.debugModalRN = function() {
        console.log('=== DEBUG MODAL RN ===');
        console.log('Modal vis√≠vel:', $('#modalAdicionarRN').hasClass('show'));
        console.log('Aba ativa:', $('#adicionarRNTabs .nav-link.active').attr('id'));
        console.log('Dados RN armazenados:', sessionStorage.getItem('dadosRN'));
        console.log('Leitos carregados:', $('#leitoRN option').length);
        console.log('Campos RN preenchidos:', {
            nome: $('#nomeRN').val(),
            sexo: $('#sexoRN').val(),
            data: $('#dataNascimentoRN').val(),
            peso: $('#pesoRN').val(),
            altura: $('#alturaRN').val()
        });
        console.log('Campos Interna√ß√£o preenchidos:', {
            leito: $('#leitoRN').val(),
            carater: $('#caraterInternacaoRN').val(),
            hda: $('#hdaRN').val(),
            diagnostico: $('#diagnosticoInicialRN').val(),
            conduta: $('#condutaInicialRN').val(),
            primeira_evolucao: $('#primeiraEvolucaoRN').val(),
            cid_principal: $('#cidPrincipalRN').val()
        });
        console.log('=== FIM DEBUG ===');
    };
    
    // ==== FIM FUNCIONALIDADES ADICIONAR RN ====

    // ==== FUN√á√ïES DO RESUMO GERAL ====
    
    // Fun√ß√£o para carregar informa√ß√µes do resumo geral
    function carregarResumoGeral() {
        const atendimentoId = $('#atendimento_id').val();
        const internacaoIdValue = parseInt("{{ internacao.id }}", 10);
        
        console.log('üîç DEBUG - IDs dispon√≠veis:');
        console.log('   Atendimento ID:', atendimentoId);
        console.log('   Interna√ß√£o ID:', internacaoIdValue);
        console.log('   Interna√ß√£o ID √© NaN?', isNaN(internacaoIdValue));
        
        if (!atendimentoId || isNaN(internacaoIdValue)) {
            console.error('‚ùå IDs inv√°lidos - Atendimento:', atendimentoId, 'Interna√ß√£o:', internacaoIdValue);
            $('#infoPrescricaoModal').html('Erro: IDs n√£o encontrados');
            $('#infoEvolucaoModal').html('Erro: IDs n√£o encontrados');
            return;
        }
        
        console.log('‚úÖ Carregando resumo geral - Atendimento:', atendimentoId, 'Interna√ß√£o:', internacaoIdValue);
        
        // Carregar √∫ltima prescri√ß√£o (usa ID da INTERNA√á√ÉO)
        $.ajax({
            url: `/api/prescricoes/${internacaoIdValue}`,
            method: 'GET',
            success: function(response) {
                console.log('‚úÖ Resposta API Prescri√ß√µes:', response);
                if (response.success && response.prescricoes && response.prescricoes.length > 0) {
                    // Ordenar por data decrescente
                    const prescricoes = response.prescricoes.sort((a, b) => {
                        return new Date(b.data_prescricao) - new Date(a.data_prescricao);
                    });
                    
                    const ultima = prescricoes[0];
                    const dataPrescricao = new Date(ultima.data_prescricao);
                    const dataFormatada = dataPrescricao.toLocaleDateString('pt-BR');
                    const horaFormatada = dataPrescricao.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    const html = `
                        <div class="mb-2">
                            <span class="text-dark fw-bold">${dataFormatada}</span>
                            <span class="text-dark"> √†s ${horaFormatada}</span>
                        </div>
                        <div class="mb-2">
                            <span class="text-dark">Dr(a). ${ultima.medico_nome || 'N√£o informado'}</span>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm mt-1" onclick="$('.nav-link[href=\'#prescricaoSection\']').click();">
                            <i class="fas fa-arrow-right me-1"></i>Ver detalhes
                        </button>
                    `;
                    $('#ultimaPrescricaoInfo').html(html);
                    
                    // Atualizar tamb√©m as informa√ß√µes no modal de impress√£o
                    const infoModalPrescricao = `Dr(a). ${ultima.medico_nome || 'N√£o informado'} - ${dataFormatada} √†s ${horaFormatada}`;
                    $('#infoPrescricaoModal').html(infoModalPrescricao);
                } else {
                    $('#ultimaPrescricaoInfo').html('<p class="text-dark mb-0">Nenhuma prescri√ß√£o registrada ainda.</p>');
                    $('#infoPrescricaoModal').html('Nenhuma prescri√ß√£o registrada');
                    $('#btnModalImprimirPrescricao').prop('disabled', true).addClass('disabled');
                }
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Erro ao carregar √∫ltima prescri√ß√£o:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                console.error('URL tentada:', `/api/prescricoes/${internacaoIdValue}`);
                $('#ultimaPrescricaoInfo').html('<p class="text-muted small mb-0">Erro ao carregar informa√ß√µes.</p>');
                $('#infoPrescricaoModal').html('Erro ao carregar');
                $('#btnModalImprimirPrescricao').prop('disabled', true).addClass('disabled');
            }
        });
        
        // Carregar √∫ltima evolu√ß√£o (usa ID da INTERNA√á√ÉO)
        $.ajax({
            url: `/api/evolucoes/${internacaoIdValue}`,
            method: 'GET',
            success: function(response) {
                console.log('‚úÖ Resposta API Evolu√ß√µes:', response);
                if (response.success && response.evolucoes && response.evolucoes.length > 0) {
                    // A API j√° retorna ordenado por data_evolucao.desc(), ent√£o pegar o primeiro
                    const ultima = response.evolucoes[0];
                    const dataEvolucao = new Date(ultima.data_evolucao);
                    const dataFormatada = dataEvolucao.toLocaleDateString('pt-BR');
                    const horaFormatada = dataEvolucao.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    // A API retorna 'nome_medico' e n√£o 'medico_nome'
                    const nomeMedico = ultima.nome_medico || ultima.medico_nome || 'N√£o informado';
                    
                    const html = `
                        <div class="mb-2">
                            <span class="text-dark fw-bold">${dataFormatada}</span>
                            <span class="text-dark"> √†s ${horaFormatada}</span>
                        </div>
                        <div class="mb-2">
                            <span class="text-dark">Dr(a). ${nomeMedico}</span>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm mt-1" onclick="$('.nav-link[href=\'#evolucaoSection\']').click();">
                            <i class="fas fa-arrow-right me-1"></i>Ver detalhes
                        </button>
                    `;
                    $('#ultimaEvolucaoInfo').html(html);
                    
                    // Atualizar tamb√©m as informa√ß√µes no modal de impress√£o
                    const infoModalEvolucao = `Dr(a). ${nomeMedico} - ${dataFormatada} √†s ${horaFormatada}`;
                    $('#infoEvolucaoModal').html(infoModalEvolucao);
                } else {
                    $('#ultimaEvolucaoInfo').html('<p class="text-dark mb-0">Nenhuma evolu√ß√£o registrada ainda.</p>');
                    $('#infoEvolucaoModal').html('Nenhuma evolu√ß√£o registrada');
                    $('#btnModalImprimirEvolucao').prop('disabled', true).addClass('disabled');
                }
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Erro ao carregar √∫ltima evolu√ß√£o:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                console.error('URL tentada:', `/api/evolucoes/${internacaoIdValue}`);
                $('#ultimaEvolucaoInfo').html('<p class="text-muted small mb-0">Erro ao carregar informa√ß√µes.</p>');
                $('#infoEvolucaoModal').html('Erro ao carregar');
                $('#btnModalImprimirEvolucao').prop('disabled', true).addClass('disabled');
            }
        });
        
        // Carregar nome do m√©dico que realizou o internamento (da tabela atendimento)
        $.ajax({
            url: `/api/atendimento/${atendimentoId}/completo`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.data) {
                    const medicoNome = response.data.medico ? response.data.medico.nome : 'N√£o informado';
                    $('#medicoResponsavel').text(medicoNome);
                } else {
                    $('#medicoResponsavel').text('N√£o informado');
                }
            },
            error: function() {
                // Fallback: tentar pegar da API de interna√ß√£o
                $.ajax({
                    url: `/api/internacao/${atendimentoId}`,
                    method: 'GET',
                    success: function(response) {
                        const dados = response.success ? response.internacao : response;
                        const medicoNome = dados.medico_nome || dados.usuario_nome || 'N√£o informado';
                        $('#medicoResponsavel').text(medicoNome);
                    },
                    error: function() {
                        $('#medicoResponsavel').text('N√£o informado');
                    }
                });
            }
        });
    }
    
    // ==== FIM FUN√á√ïES DO RESUMO GERAL ====

    // Fun√ß√£o para carregar hist√≥rico de internamentos
    function carregarHistoricoInternamentos() {
        // M√∫ltiplas formas de obter o ID do paciente
        let pacienteId = $('#paciente_id').val();
        
        // Se n√£o conseguir do campo hidden, tentar pegar da vari√°vel global
        if (!pacienteId) {
            pacienteId = "{{ paciente.id }}";
        }
        
        // Se ainda n√£o tiver, tentar do contexto da p√°gina
        if (!pacienteId) {
            console.error('ID do paciente n√£o encontrado');
            $('#loading-historico').hide();
            $('#conteudo-historico').show();
            $('#sem-historico').show().html(`
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5 class="text-warning">Erro de configura√ß√£o</h5>
                <p class="text-muted">ID do paciente n√£o encontrado. Verifique a configura√ß√£o da p√°gina.</p>
            `);
            return;
        }
        
        const atendimentoAtual = $('#atendimento_id').val() || "{{ internacao.atendimento_id }}";
        
        // Atualizar informa√ß√µes de debug
        atualizarInformacoesDebug();
        
        // Mostrar loading
        $('#loading-historico').show();
        $('#conteudo-historico').hide();
        
        console.log('Carregando hist√≥rico de internamentos:');
        console.log('- Paciente ID:', pacienteId);
        console.log('- Atendimento atual:', atendimentoAtual);
        console.log('- URL da API:', `/api/paciente/${pacienteId}/historico-internamentos`);
        
        $.ajax({
            url: `/api/paciente/${pacienteId}/historico-internamentos`,
            method: 'GET',
            data: {
                atendimento_atual: atendimentoAtual // Para excluir o internamento atual
            },
            success: function(response) {
                console.log('Resposta da API:', response);
                
                if (response.success && response.internamentos && response.internamentos.length > 0) {
                    renderizarHistoricoInternamentos(response.internamentos);
                    $('#sem-historico').hide();
                } else {
                    console.log('Nenhum internamento encontrado no hist√≥rico');
                    $('#sem-historico').show();
                }
                
                // Ocultar loading e mostrar conte√∫do
                $('#loading-historico').hide();
                $('#conteudo-historico').show();
            },
            error: function(xhr, status, error) {
                console.error('Erro detalhado na requisi√ß√£o AJAX:');
                console.error('- Status:', xhr.status);
                console.error('- Status Text:', xhr.statusText);
                console.error('- Response Text:', xhr.responseText);
                console.error('- Error:', error);
                
                let mensagemErro = 'Erro desconhecido';
                
                try {
                    const responseJson = JSON.parse(xhr.responseText);
                    mensagemErro = responseJson.message || mensagemErro;
                } catch (e) {
                    // Se n√£o conseguir fazer parse do JSON, usar mensagem padr√£o
                    if (xhr.status === 404) {
                        mensagemErro = 'Endpoint n√£o encontrado';
                    } else if (xhr.status === 403) {
                        mensagemErro = 'Acesso negado';
                    } else if (xhr.status === 500) {
                        mensagemErro = 'Erro interno do servidor';
                    }
                }
                
                $('#loading-historico').hide();
                $('#conteudo-historico').show();
                $('#sem-historico').show();
                
                // Mostrar painel de debug automaticamente em caso de erro
                $('#debug-panel').show();
                atualizarInformacoesDebug();
                
                // Mostrar mensagem de erro mais detalhada
                $('#sem-historico').html(`
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-warning">Erro ao carregar hist√≥rico</h5>
                    <p class="text-muted">${mensagemErro}</p>
                    <small class="text-muted">C√≥digo do erro: ${xhr.status}</small>
                `);
            }
        });
    }
    
    // Fun√ß√£o para renderizar a tabela de hist√≥rico de internamentos
    function renderizarHistoricoInternamentos(internamentos) {
        let html = '';
        
        internamentos.forEach(function(internamento) {
            const dataInternacao = internamento.data_internacao ? 
                new Date(internamento.data_internacao).toLocaleDateString('pt-BR') : 
                'N√£o informada';
                
            const dataAlta = internamento.data_alta ? 
                new Date(internamento.data_alta).toLocaleDateString('pt-BR') : 
                '<span class="badge bg-warning">Em andamento</span>';
                
            const diagnostico = internamento.diagnostico_inicial || internamento.diagnostico || 'N√£o informado';
            const medico = internamento.medico_nome || 'N√£o informado';
            const leito = internamento.leito || 'N√£o informado';
            
            // Truncar diagn√≥stico se muito longo
            const diagnosticoTruncado = diagnostico.length > 80 ? 
                diagnostico.substring(0, 80) + '...' : 
                diagnostico;
            
            html += `
                <tr>
                    <td>
                        <strong>${dataInternacao}</strong>
                    </td>
                    <td>
                        <span class="text-truncate" title="${diagnostico}">
                            ${diagnosticoTruncado}
                        </span>
                    </td>
                    <td>${dataAlta}</td>
                    <td>
                        <small class="text-muted">Dr(a).</small><br>
                        ${medico}
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${leito}</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="visualizarInternamentoHistorico('${internamento.atendimento_id}')"
                                title="Ver detalhes do internamento">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        $('#tabelaHistoricoInternamentos').html(html);
    }
    
    // Fun√ß√£o para visualizar internamento hist√≥rico
    function visualizarInternamentoHistorico(atendimentoId) {
        const url = `/clinica/historico-internacao/${atendimentoId}`;
        window.open(url, '_blank');
    }
    
    // Fun√ß√£o para atualizar informa√ß√µes de debug
    function atualizarInformacoesDebug() {
        const pacienteId = $('#paciente_id').val() || "{{ paciente.id }}";
        const atendimentoId = $('#atendimento_id').val() || "{{ internacao.atendimento_id }}";
        const urlApi = `/api/paciente/${pacienteId}/historico-internamentos`;
        
        $('#debug-paciente-id').text(pacienteId || 'N√£o encontrado');
        $('#debug-atendimento-id').text(atendimentoId || 'N√£o encontrado');
        $('#debug-url-api').text(urlApi);
    }

    // ==== FUNCIONALIDADES PARA DIAGN√ìSTICO E CLASSIFICA√á√ÉO ====
    
    // Vari√°veis globais para editores Quill das novas se√ß√µes
    let anamneseQuillEditor, condutaQuillEditor;
    let dadosDiagnosticoCache = null;
    let dadosAnamneseCondutaCache = null;
    let dadosJustificativasCache = null;

    // Fun√ß√£o para carregar dados de diagn√≥stico
    function carregarDadosDiagnostico() {
        const atendimentoId = $('#atendimento_id').val() || window.ATENDIMENTO_ID;
        // console.log('Carregando diagn√≥stico para atendimento:', atendimentoId); // Debug removido para produ√ß√£o
        
        if (!atendimentoId) {
            console.error('ID do atendimento n√£o encontrado');
            return;
        }

        $('#diagnostico-loading').show();
        
        $.ajax({
            url: `/api/internacao/${atendimentoId}`,
            method: 'GET',
            timeout: 10000,
            success: function(response) {
                // console.log('Dados da interna√ß√£o recebidos:', response); // Debug removido para produ√ß√£o
                
                if (response.success && response.internacao) {
                                     dadosDiagnosticoCache = response.internacao;
                    atualizarVisualizacaoDiagnostico(response.internacao);
                } else {
                    // Se n√£o tem success, mas tem dados diretos
                    dadosDiagnosticoCache = response;
                    atualizarVisualizacaoDiagnostico(response);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao carregar diagn√≥stico:', error);
                console.error('Status:', status);
                // console.error('Response:', xhr.responseText); // Removido para produ√ß√£o
                
                // Mostrar erro nos campos de visualiza√ß√£o
                const errorMsg = '<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Erro ao carregar dados</div>';
                $('#diagnostico-inicial-display').html(errorMsg);
                $('#cid-principal-display').html(errorMsg);
                $('#diagnostico-atual-display').html(errorMsg);
                $('#cid-secundario-display').html(errorMsg);
                $('#causas-associadas-display').html(errorMsg);
                
                // Mostrar alerta de erro
                const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro ao carregar dados!</strong> N√£o foi poss√≠vel carregar as informa√ß√µes do diagn√≥stico.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('#diagnostico-pane').prepend(alertHtml);
            },
            complete: function() {
                $('#diagnostico-loading').hide();
            }
        });
    }

    // Fun√ß√£o para atualizar visualiza√ß√£o de diagn√≥stico
    function atualizarVisualizacaoDiagnostico(dados) {
        // console.log('Atualizando visualiza√ß√£o com dados:', dados); // Debug removido para produ√ß√£o
        
        // Atualizar campos de visualiza√ß√£o com verifica√ß√£o de conte√∫do
        $('#diagnostico-inicial-display').html(
            dados.diagnostico_inicial ? 
            `<div class="text-dark">${dados.diagnostico_inicial.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#cid-principal-display').html(
            dados.cid_principal ? 
            `<div class="text-dark fw-bold">${dados.cid_principal}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#diagnostico-atual-display').html(
            dados.diagnostico ? 
            `<div class="text-dark">${dados.diagnostico.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        
        $('#cid-secundario-display').html(
            dados.cid_10_secundario ? 
            `<div class="text-dark">${dados.cid_10_secundario.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>Nenhum CID secund√°rio registrado</div>'
        );
        
        $('#causas-associadas-display').html(
            dados.cid_10_causas_associadas ? 
            `<div class="text-dark">${dados.cid_10_causas_associadas.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>Nenhuma causa associada registrada</div>'
        );
    }
    // Fun√ß√£o para carregar dados de anamnese e conduta
    function carregarDadosAnamneseConduta() {
        const atendimentoId = $('#atendimento_id').val();
        if (!atendimentoId) return;

        $('#anamnese-conduta-loading').show();
        
        fetch(`/api/internacao/${atendimentoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.internacao) {
                    dadosAnamneseCondutaCache = data.internacao;
                    atualizarVisualizacaoAnamneseConduta(data.internacao);
                } else {
                    console.error('Erro ao carregar dados de anamnese e conduta:', data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ß√£o de anamnese e conduta:', error);
            })
            .finally(() => {
                $('#anamnese-conduta-loading').hide();
            });
    }

    // Fun√ß√£o para atualizar visualiza√ß√£o de anamnese e conduta
    function atualizarVisualizacaoAnamneseConduta(dados) {
        $('#anamnese-display').html(dados.anamnese_exame_fisico || 'N√£o informado');
        $('#conduta-display').html(dados.conduta || 'N√£o informado');
    }

    // Inicializar editores Quill quando necess√°rio
    function inicializarEditoresQuill() {
        if (!anamneseQuillEditor) {
            anamneseQuillEditor = new Quill('#anamnese-editor-container', {
                theme: 'snow',
                placeholder: 'Digite a anamnese e exame f√≠sico...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
        }

        if (!condutaQuillEditor) {
            condutaQuillEditor = new Quill('#conduta-editor-container', {
                theme: 'snow',
                placeholder: 'Digite a conduta m√©dica...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
        }
    }

    // Event handlers
    $(document).ready(function() {
        // Carregar dados iniciais se necess√°rio
        if ($('#anamnese-tab').hasClass('active')) {
            carregarDadosAnamneseConduta();
        }

        // Handler para edi√ß√£o
        $('#btnEditarAnamneseConduta').on('click', function() {
            inicializarEditoresQuill();
            
            if (dadosAnamneseCondutaCache) {
                anamneseQuillEditor.root.innerHTML = dadosAnamneseCondutaCache.anamnese_exame_fisico || '';
                condutaQuillEditor.root.innerHTML = dadosAnamneseCondutaCache.conduta || '';
            }
            
            $('#anamnese-conduta-visualizacao').hide();
            $('#anamnese-conduta-edicao').show();
        });

        // Handler para cancelar edi√ß√£o
        $('#btnCancelarAnamneseConduta').on('click', function() {
            $('#anamnese-conduta-edicao').hide();
            $('#anamnese-conduta-visualizacao').show();
        });
    });

    // Bot√£o Limpar Formul√°rio
    $(document).on('click', '#btnLimparFormulario', function() {
        if (confirm('Tem certeza que deseja limpar todos os campos?')) {
            $('#formDiagnostico')[0].reset();
        }
    });

    // Submiss√£o do formul√°rio de anamnese e conduta
    $('#formAnamneseConduta').on('submit', function(e) {
        e.preventDefault();
        
        const atendimentoId = $('#atendimento_id').val();
        const dados = {
            anamnese_exame_fisico: anamneseQuillEditor ? anamneseQuillEditor.root.innerHTML : '',
            conduta: condutaQuillEditor ? condutaQuillEditor.root.innerHTML : ''
        };
        
        fetch(`/api/internacao/${atendimentoId}/anamnese-conduta`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Anamnese e conduta atualizadas com sucesso!');
                dadosAnamneseCondutaCache = { ...dadosAnamneseCondutaCache, ...dados };
                atualizarVisualizacaoAnamneseConduta(dadosAnamneseCondutaCache);
                $('#anamnese-conduta-edicao').hide();
                $('#anamnese-conduta-visualizacao').show();
            } else {
                alert('Erro ao salvar: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro ao salvar anamnese e conduta:', error);
            alert('Erro ao salvar anamnese e conduta');
        });
    });

    // Carregar dados quando as abas forem clicadas
    $(document).on('click', '#diagnostico-tab', function() {
        if (!dadosDiagnosticoCache) {
            carregarDadosDiagnostico();
        }
    });

    $(document).on('click', '#anamnese-tab', function() {
        if (!dadosAnamneseCondutaCache) {
            carregarDadosAnamneseConduta();
        }
    });

    $(document).on('click', '#justificativas-tab', function() {
        if (!dadosJustificativasCache) {
            carregarDadosJustificativas();
        }
    });

    // Evento para gerar AIH padr√£o
    $('#btnGerarAIHPadrao').on('click', function() {
        if (confirm('Deseja gerar automaticamente as justificativas padr√£o para AIH?\n\nIsso ir√° preencher os campos com:\n‚Ä¢ Sinais e Sintomas: HDA + Anamnese\n‚Ä¢ Condi√ß√µes: RISCO DE COMPLICA√á√ÉO\n‚Ä¢ Resultados: ANAMNESE + EXAME F√çSICO')) {
            gerarAIHPadrao();
        }
    });

    // Eventos para edi√ß√£o de justificativas
    $('#btnEditarJustificativas').on('click', function() {
        if (!dadosJustificativasCache) {
            alert('Carregue os dados primeiro');
            return;
        }
        
        // Preencher campos de edi√ß√£o
        $('#sinais-sintomas-edit').val(dadosJustificativasCache.justificativa_internacao_sinais_e_sintomas || '');
        $('#condicoes-edit').val(dadosJustificativasCache.justificativa_internacao_condicoes || '');
        $('#resultados-diagnosticos-edit').val(dadosJustificativasCache.justificativa_internacao_principais_resultados_diagnostico || '');
        
        // Alternar visualiza√ß√£o
        $('#justificativas-visualizacao').hide();
        $('#justificativas-edicao').show();
    });

    // Cancelar edi√ß√£o de justificativas
    $('#btnCancelarJustificativas').on('click', function() {
        $('#justificativas-edicao').hide();
        $('#justificativas-visualizacao').show();
    });

    // Submiss√£o do formul√°rio de justificativas
    $('#formJustificativas').on('submit', function(e) {
        e.preventDefault();
        
        const atendimentoId = $('#atendimento_id').val();
        const dados = {
            justificativa_internacao_sinais_e_sintomas: $('#sinais-sintomas-edit').val(),
            justificativa_internacao_condicoes: $('#condicoes-edit').val(),
            justificativa_internacao_principais_resultados_diagnostico: $('#resultados-diagnosticos-edit').val()
        };
        
        fetch(`/api/internacao/${atendimentoId}/diagnostico`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Justificativas atualizadas com sucesso!');
                dadosJustificativasCache = { ...dadosJustificativasCache, ...dados };
                atualizarVisualizacaoJustificativas(dadosJustificativasCache);
                $('#justificativas-edicao').hide();
                $('#justificativas-visualizacao').show();
            } else {
                alert('Erro ao salvar: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro ao salvar justificativas:', error);
            alert('Erro ao salvar justificativas');
        });
    });
    
    // ==== FIM FUNCIONALIDADES DIAGN√ìSTICO E ANAMNESE ====

    // Fun√ß√£o para carregar dados de justificativas
    function carregarDadosJustificativas() {
        const atendimentoId = $('#atendimento_id').val();
        if (!atendimentoId) return;

        $('#justificativas-loading').show();
        
        fetch(`/api/internacao/${atendimentoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.internacao) {
                    dadosJustificativasCache = data.internacao;
                    atualizarVisualizacaoJustificativas(data.internacao);
                } else {
                    console.error('Erro ao carregar dados de justificativas:', data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisi√ß√£o de justificativas:', error);
            })
            .finally(() => {
                $('#justificativas-loading').hide();
            });
    }

    // Fun√ß√£o para atualizar visualiza√ß√£o de justificativas
    function atualizarVisualizacaoJustificativas(dados) {
        $('#sinais-sintomas-display').html(
            dados.justificativa_internacao_sinais_e_sintomas ? 
            `<div class="text-dark">${dados.justificativa_internacao_sinais_e_sintomas.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        $('#condicoes-display').html(
            dados.justificativa_internacao_condicoes ? 
            `<div class="text-dark">${dados.justificativa_internacao_condicoes.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
        $('#resultados-diagnosticos-display').html(
            dados.justificativa_internacao_principais_resultados_diagnostico ? 
            `<div class="text-dark">${dados.justificativa_internacao_principais_resultados_diagnostico.replace(/\n/g, '<br>')}</div>` : 
            '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
        );
    }
    
    // Fun√ß√£o para gerar AIH padr√£o
    function gerarAIHPadrao() {
        console.log('üè• Gerando AIH Padr√£o...');
        
        const atendimentoId = $('#atendimento_id').val();
        if (!atendimentoId) {
            alert('Erro: ID do atendimento n√£o encontrado.');
            return;
        }
        
        // Mostrar loading
        const btnGerar = $('#btnGerarAIHPadrao');
        const textoOriginal = btnGerar.html();
        btnGerar.html('<i class="fas fa-spinner fa-spin me-1"></i> Gerando...').prop('disabled', true);
        
        // Buscar dados da interna√ß√£o
        $.ajax({
            url: `/api/internacao/${atendimentoId}`,
            method: 'GET',
            success: function(response) {
                console.log('Dados da interna√ß√£o recebidos:', response);
                
                const dados = response.success ? response.internacao : response;
                
                // Montar o texto de Sinais e Sintomas (HDA + Anamnese e Exame F√≠sico)
                let sinaisSintomas = '';
                
                if (dados.hda) {
                    sinaisSintomas += dados.hda.trim();
                }
                
                if (dados.anamnese_exame_fisico) {
                    if (sinaisSintomas) {
                        sinaisSintomas += '\n\n';
                    }
                    sinaisSintomas += dados.anamnese_exame_fisico.trim();
                }
                
                // Se n√£o houver nenhum dos dois, usar mensagem padr√£o
                if (!sinaisSintomas) {
                    alert('‚ö†Ô∏è Aten√ß√£o: N√£o h√° HDA ou Anamnese cadastrada. Por favor, preencha esses dados primeiro nas abas "Evolu√ß√µes" e "Anamnese & Conduta".');
                    btnGerar.html(textoOriginal).prop('disabled', false);
                    return;
                }
                
                // Preparar dados para salvar
                const dadosJustificativas = {
                    justificativa_internacao_sinais_e_sintomas: sinaisSintomas,
                    justificativa_internacao_condicoes: 'RISCO DE COMPLICA√á√ÉO',
                    justificativa_internacao_principais_resultados_diagnostico: 'ANMNESE + EXAME FISICO'
                };
                
                console.log('Salvando justificativas AIH padr√£o:', dadosJustificativas);
                
                // Salvar os dados
                $.ajax({
                    url: `/api/internacao/${atendimentoId}/diagnostico`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(dadosJustificativas),
                    success: function(saveResponse) {
                        console.log('Resposta do salvamento:', saveResponse);
                        
                        if (saveResponse.success) {
                            // Atualizar cache
                            dadosJustificativasCache = { ...dadosJustificativasCache, ...dadosJustificativas };
                            
                            // Atualizar visualiza√ß√£o
                            atualizarVisualizacaoJustificativas(dadosJustificativas);
                            
                            // Mostrar mensagem de sucesso
                            const alertHtml = `
                                <div class="alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3" role="alert" style="z-index: 1060">
                                    <i class="fas fa-check-circle me-2"></i>
                                    AIH Padr√£o gerada com sucesso!
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            `;
                            $('body').append(alertHtml);
                            
                            // Remover o alerta ap√≥s 3 segundos
                            setTimeout(function() {
                                $('.alert-success').alert('close');
                            }, 3000);
                        } else {
                            alert('Erro ao salvar AIH padr√£o: ' + (saveResponse.message || 'Erro desconhecido'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Erro ao salvar AIH padr√£o:', xhr.responseText);
                        alert('Erro ao salvar AIH padr√£o: ' + (xhr.responseJSON?.message || error));
                    },
                    complete: function() {
                        btnGerar.html(textoOriginal).prop('disabled', false);
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('Erro ao buscar dados da interna√ß√£o:', xhr.responseText);
                alert('Erro ao buscar dados da interna√ß√£o. Tente novamente.');
                btnGerar.html(textoOriginal).prop('disabled', false);
            }
        });
    }

    // Fun√ß√£o para carregar dados de diagn√≥stico (vers√£o final otimizada)
    function carregarDiagnostico() {
        const atendimentoId = $('#atendimento_id').val() || window.ATENDIMENTO_ID;
        // console.log('Carregando diagn√≥stico para atendimento:', atendimentoId); // Debug removido para produ√ß√£o
        
        if (!atendimentoId) {
            console.error('ID do atendimento n√£o encontrado'); // Manter apenas erros cr√≠ticos
            return;
        }

        // Mostrar loading
        $('#diagnostico-loading').show();
        
        $.ajax({
            url: `/api/internacao/${atendimentoId}`,
            method: 'GET',
            timeout: 10000,
            success: function(data) {
                // console.log('Dados da interna√ß√£o recebidos:', data); // Debug removido para produ√ß√£o
                
                // Atualizar campos de visualiza√ß√£o com verifica√ß√£o de conte√∫do
                $('#diagnostico-inicial-display').html(
                    data.diagnostico_inicial ? 
                    `<div class="text-dark">${data.diagnostico_inicial}</div>` : 
                    '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
                );
                
                $('#cid-principal-display').html(
                    data.cid_principal ? 
                    `<div class="text-dark fw-bold">${data.cid_principal}</div>` : 
                    '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
                );
                
                $('#diagnostico-atual-display').html(
                    data.diagnostico ? 
                    `<div class="text-dark">${data.diagnostico}</div>` : 
                    '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>N√£o informado</div>'
                );
                
                $('#cid-secundario-display').html(
                    data.cid_10_secundario ? 
                    `<div class="text-dark">${data.cid_10_secundario.replace(/\n/g, '<br>')}</div>` : 
                    '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>Nenhum CID secund√°rio registrado</div>'
                );
                
                $('#causas-associadas-display').html(
                    data.cid_10_causas_associadas ? 
                    `<div class="text-dark">${data.cid_10_causas_associadas.replace(/\n/g, '<br>')}</div>` : 
                    '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>Nenhuma causa associada registrada</div>'
                );
                
                // Atualizar cache global
                dadosDiagnosticoCache = {
                    diagnostico_inicial: data.diagnostico_inicial || '',
                    cid_principal: data.cid_principal || '',
                    diagnostico: data.diagnostico || '',
                    cid_10_secundario: data.cid_10_secundario || '',
                    cid_10_causas_associadas: data.cid_10_causas_associadas || ''
                };
                
                // console.log('Dados armazenados no cache:', dadosDiagnosticoCache); // Debug removido para produ√ß√£o
            },
            error: function(xhr, status, error) {
                console.error('Erro ao carregar diagn√≥stico:', error); // Manter erros cr√≠ticos
                console.error('Status:', status);
                // console.error('Response:', xhr.responseText); // Remover response completa por seguran√ßa
                
                // Mostrar erro nos campos de visualiza√ß√£o
                const errorMsg = '<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Erro ao carregar dados</div>';
                $('#diagnostico-inicial-display').html(errorMsg);
                $('#cid-principal-display').html(errorMsg);
                $('#diagnostico-atual-display').html(errorMsg);
                $('#cid-secundario-display').html(errorMsg);
                $('#causas-associadas-display').html(errorMsg);
                
                // Mostrar alerta na p√°gina
                const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro ao carregar dados!</strong> N√£o foi poss√≠vel carregar as informa√ß√µes do diagn√≥stico.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $('#diagnostico-pane').prepend(alertHtml);
            },
            complete: function() {
                // Esconder loading
                $('#diagnostico-loading').hide();
            }
        });
    }

    // Remover event handlers duplicados - manter apenas estas vers√µes unificadas

    // Gerenciar cliques nas abas de evolu√ß√£o (vers√£o unificada e otimizada)
    $(document).on('click', '#evolucaoTabs .nav-link', function(e) {
        const targetId = $(this).attr('data-bs-target');
        
        // Carregar dados espec√≠ficos conforme a aba clicada
        if (targetId === '#diagnostico-pane') {
            // console.log('Aba de diagn√≥stico clicada - carregando dados...'); // Debug removido para produ√ß√£o
            if (!dadosDiagnosticoCache) {
                carregarDadosDiagnostico();
            }
        } else if (targetId === '#anamnese-pane') {
            // console.log('Aba de anamnese clicada - carregando dados...'); // Debug removido para produ√ß√£o
            if (!dadosAnamneseCondutaCache) {
                carregarDadosAnamneseConduta();
            }
        } else if (targetId === '#justificativas-pane') {
            // console.log('Aba de justificativas clicada - carregando dados...'); // Debug removido para produ√ß√£o
            if (!dadosJustificativasCache) {
                carregarDadosJustificativas();
            }
        }
    });

    // Carregar dados de diagn√≥stico automaticamente ao carregar a p√°gina se a aba estiver ativa
    $(document).ready(function() {
        // Se a aba de diagn√≥stico estiver ativa por padr√£o, carregar dados
        if ($('#diagnostico-tab').hasClass('active')) {
            carregarDadosDiagnostico();
        }
    });


    // Corre√ß√£o espec√≠fica para o modal HDA
    $(document).ready(function() {
        // Remover event listeners problem√°ticos
        $('#modalEditarHDA').off('show.bs.modal shown.bs.modal');
        
        // Handler customizado para o bot√£o de editar HDA
        $(document).on('click', '[data-bs-target="#modalEditarHDA"]', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            try {
                // Pegar valor atual do HDA
                const hdaAtual = $('#hdaTexto').val() || '';
                $('#textoHDA').val(hdaAtual);
                
                // Verificar se o modal existe
                const modalElement = document.getElementById('modalEditarHDA');
                if (!modalElement) {
                    console.error('Modal HDA n√£o encontrado');
                    return false;
                }
                
                // Tentar abrir com Bootstrap 5
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    // Remover inst√¢ncia existente se houver
                    const existingInstance = bootstrap.Modal.getInstance(modalElement);
                    if (existingInstance) {
                        existingInstance.dispose();
                    }
                    
                    // Criar nova inst√¢ncia
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: 'static',
                        keyboard: true,
                        focus: true
                    });
                    
                    modal.show();
                    
                } else {
                    // Fallback para jQuery
                    $('#modalEditarHDA').modal('show');
                }
                
            } catch (error) {
                console.error('Erro ao abrir modal HDA:', error);
                // √öltimo recurso - mostrar modal manualmente
                $('#modalEditarHDA')
                    .removeClass('fade')
                    .addClass('show')
                    .css({
                        'display': 'block',
                        'padding-right': '17px'
                    });
                
                $('body').addClass('modal-open');
                
                // Adicionar backdrop
                if ($('.modal-backdrop').length === 0) {
                    $('body').append('<div class="modal-backdrop fade show"></div>');
                }
            }
            
            return false;
        });
        
        // Script de verifica√ß√£o dos modais m√©dicos
        console.log('üîç Verificando elementos dos modais m√©dicos...');
        
        const elementos = {
            'Bot√£o Anamnese': '#btnEditarAnamneseConduta',
            'Bot√£o Diagn√≥stico': '#btnEditarDiagnostico', 
            'Bot√£o Justificativas': '#btnEditarJustificativas',
            'ID Atendimento': '#atendimento_id'
        };
        
        let todosOk = true;
        Object.entries(elementos).forEach(([nome, selector]) => {
            const elemento = $(selector);
            if (elemento.length > 0) {
                console.log(`‚úÖ ${nome}: OK`);
            } else {
                console.log(`‚ùå ${nome}: FALTANDO`);
                todosOk = false;
            }
        });
        
        if (todosOk) {
            console.log('üéâ Todos os elementos dos modais est√£o presentes!');
        } else {
            console.log('‚ö†Ô∏è Alguns elementos est√£o faltando.');
        }
        
        const atendimentoId = $('#atendimento_id').val();
        if (atendimentoId) {
            console.log(`üìã ID do Atendimento: ${atendimentoId}`);
        } else {
            console.error('‚ùå ID do atendimento n√£o encontrado!');
        }
        
        // === DEBUG FICHAS DE REFER√äNCIA ===
        console.log('üîç === VERIFICA√á√ÉO FICHAS DE REFER√äNCIA ===');
        
        const elementosFichas = {
            'Bot√£o Nova Ficha': '#btn_nova_ficha_referencia',
            'Bot√£o Salvar Ficha': '#btn_salvar_ficha_referencia',
            'Modal Ficha': '#modalNovaFichaReferencia',
            'Form Ficha': '#formFichaReferencia',
            'Campo Texto Refer√™ncia': '#texto_referencia',
            'Campo Encaminhamento': '#encaminhamento_atendimento',
            'Campo Procedimento': '#procedimento',
            'Campo Unidade Refer√™ncia': '#unidade_referencia',
            'Lista Fichas Hoje': '#listaFichasDoDia',
            'Lista Fichas Antigas': '#listaFichasAntigas'
        };
        
        let fichasOk = true;
        Object.entries(elementosFichas).forEach(([nome, selector]) => {
            const elemento = $(selector);
            if (elemento.length > 0) {
                console.log(`‚úÖ ${nome}: OK (${elemento.length} encontrado)`);
            } else {
                console.log(`‚ùå ${nome}: FALTANDO`);
                fichasOk = false;
            }
        });
        
        if (fichasOk) {
            console.log('üéâ Todos os elementos de fichas de refer√™ncia est√£o presentes!');
        } else {
            console.log('‚ö†Ô∏è Alguns elementos de fichas de refer√™ncia est√£o faltando.');
        }
        
        // Verificar se a fun√ß√£o de inicializa√ß√£o foi chamada
        if (typeof inicializarModuloFichasReferencia === 'function') {
            console.log('‚úÖ Fun√ß√£o inicializarModuloFichasReferencia est√° dispon√≠vel');
            try {
                console.log('üîÑ Chamando inicializarModuloFichasReferencia()...');
                inicializarModuloFichasReferencia();
                console.log('‚úÖ inicializarModuloFichasReferencia() executada com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao executar inicializarModuloFichasReferencia():', error);
            }
        } else {
            console.error('‚ùå Fun√ß√£o inicializarModuloFichasReferencia n√£o est√° dispon√≠vel');
        }
        
        // === TESTE ADICIONAL PARA FICHAS DE REFER√äNCIA ===
        setTimeout(function() {
            console.log('üß™ === TESTE ADICIONAL FICHAS DE REFER√äNCIA ===');
            
            // Teste direto com jQuery no bot√£o salvar
            $('#btn_salvar_ficha_referencia').off('click.teste').on('click.teste', function(e) {
                console.log('üéØ TESTE: Clique detectado no bot√£o salvar ficha!');
                console.log('üéØ Event object:', e);
                console.log('üéØ This element:', this);
                
                // Prevenir m√∫ltiplos eventos
                e.stopImmediatePropagation();
                
                if (typeof salvarFichaReferencia === 'function') {
                    console.log('üéØ Fun√ß√£o salvarFichaReferencia dispon√≠vel, chamando...');
                    salvarFichaReferencia();
                } else {
                    console.error('üéØ Fun√ß√£o salvarFichaReferencia n√£o est√° dispon√≠vel!');
                    alert('Erro: Fun√ß√£o de salvamento n√£o encontrada. Verifique o console para mais detalhes.');
                }
            });
            
            // Teste do bot√£o "Nova Ficha"
            $('#btn_nova_ficha_referencia').off('click.teste').on('click.teste', function(e) {
                console.log('üéØ TESTE: Clique detectado no bot√£o nova ficha!');
                console.log('üéØ Abrindo modal...');
                
                // Limpar formul√°rio
                const form = document.getElementById('formFichaReferencia');
                if (form) {
                    form.reset();
                    console.log('üéØ Formul√°rio resetado');
                }
                
                // Tentar abrir modal
                try {
                    $('#modalNovaFichaReferencia').modal('show');
                    console.log('üéØ Modal aberto com sucesso');
                } catch (error) {
                    console.error('üéØ Erro ao abrir modal:', error);
                }
            });
            
            console.log('üß™ Eventos de teste configurados com sucesso!');
        }, 1000);
    });
    
    // ==== FUN√á√ïES DE IMPRESS√ÉO ====
    
    // Fun√ß√£o para imprimir AIH
    function imprimirAIH(atendimentoId) {
        console.log('Imprimindo AIH para atendimento:', atendimentoId);
        
        // Fechar o modal
        $('#modalOpcoesImpressao').modal('hide');
        
        // Abrir janela de impress√£o da AIH (URL correta do backend)
        const urlAIH = `/imprimir/aih/${atendimentoId}`;
        const janelaImpressao = window.open(urlAIH, '_blank', 'width=800,height=600');
        
        if (janelaImpressao) {
            janelaImpressao.focus();
            // Aguardar o carregamento e imprimir automaticamente
            janelaImpressao.onload = function() {
                setTimeout(function() {
                    janelaImpressao.print();
                }, 500);
            };
        } else {
            alert('Por favor, permita pop-ups para imprimir documentos.');
        }
    }
    
    // Fun√ß√£o para imprimir Ficha de Admiss√£o
    function imprimirFichaAdmissao(atendimentoId) {
        console.log('Imprimindo Ficha de Admiss√£o para atendimento:', atendimentoId);
        
        // Fechar o modal
        $('#modalOpcoesImpressao').modal('hide');
        
        // Abrir janela de impress√£o da Ficha de Admiss√£o (URL correta do backend)
        const urlFicha = `/imprimir/ficha_admissao/${atendimentoId}`;
        const janelaImpressao = window.open(urlFicha, '_blank', 'width=800,height=600');
        
        if (janelaImpressao) {
            janelaImpressao.focus();
            // Aguardar o carregamento e imprimir automaticamente
            janelaImpressao.onload = function() {
                setTimeout(function() {
                    janelaImpressao.print();
                }, 500);
            };
        } else {
            alert('Por favor, permita pop-ups para imprimir documentos.');
        }
    }
    
    // Fun√ß√£o para imprimir √∫ltima prescri√ß√£o
    function imprimirUltimaPrescricao() {
        const internacaoIdValue = parseInt("{{ internacao.id }}", 10);
        console.log('Buscando √∫ltima prescri√ß√£o para interna√ß√£o ID:', internacaoIdValue);
        
        // Buscar prescri√ß√µes usando o ID da interna√ß√£o
        $.ajax({
            url: `/api/prescricoes/${internacaoIdValue}`,
            method: 'GET',
            success: function(response) {
                console.log('Resposta da API de prescri√ß√µes:', response);
                
                if (response.success && response.prescricoes && response.prescricoes.length > 0) {
                    // Ordenar por data decrescente e pegar a primeira
                    const prescricoes = response.prescricoes.sort((a, b) => {
                        return new Date(b.data_prescricao) - new Date(a.data_prescricao);
                    });
                    
                    const ultimaPrescricao = prescricoes[0];
                    const prescricaoId = ultimaPrescricao.id;
                    
                    console.log('ID da √∫ltima prescri√ß√£o encontrada:', prescricaoId);
                    
                    // Fechar o modal
                    $('#modalOpcoesImpressao').modal('hide');
                    
                    // Usar a mesma fun√ß√£o que o bot√£o de impress√£o usa
                    imprimirPrescricao(prescricaoId);
                } else {
                    alert('Nenhuma prescri√ß√£o encontrada para este atendimento.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao buscar prescri√ß√µes:', error);
                console.error('Response:', xhr.responseText);
                alert('Erro ao buscar prescri√ß√µes. Tente novamente.');
            }
        });
    }
    
    // Fun√ß√£o para imprimir √∫ltima evolu√ß√£o
    function imprimirUltimaEvolucao() {
        const atendimentoId = $('#atendimento_id').val();
        console.log('Buscando √∫ltima evolu√ß√£o para atendimento:', atendimentoId);
        
        // Usar a API espec√≠fica que busca o ID da √∫ltima evolu√ß√£o
        $.ajax({
            url: `/api/ultima-evolucao-id/${atendimentoId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.evolucao_id) {
                    const evolucaoId = response.evolucao_id;
                    
                    console.log('ID da √∫ltima evolu√ß√£o:', evolucaoId);
                    
                    // Fechar o modal
                    $('#modalOpcoesImpressao').modal('hide');
                    
                    // Abrir janela de impress√£o
                    const urlEvolucao = `/api/imprimir-evolucao-html/${evolucaoId}`;
                    const janelaImpressao = window.open(urlEvolucao, '_blank', 'width=800,height=600');
                    
                    if (janelaImpressao) {
                        janelaImpressao.focus();
                        janelaImpressao.onload = function() {
                            setTimeout(function() {
                                janelaImpressao.print();
                            }, 500);
                        };
                    }
                } else {
                    alert('Nenhuma evolu√ß√£o encontrada para este atendimento.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao buscar evolu√ß√£o:', error);
                alert('Erro ao buscar evolu√ß√£o. Tente novamente.');
            }
        });
    }
    
    // ==== FIM FUN√á√ïES DE IMPRESS√ÉO ====

</script>

<!-- Modal Editar HDA -->
<!-- Modal de Informa√ß√µes de Internamento -->
<div class="modal fade" id="modalInformacoesInternamento" tabindex="-1" aria-labelledby="modalInformacoesInternamentoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="modalInformacoesInternamentoLabel">Informa√ß√µes de Internamento</h5>
        <button type="button" class="btn btn-outline-primary btn-sm ms-2" id="btnEditarInternamentoInfo">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="internamento-info-loading" class="text-center my-3">
          <div class="spinner-border text-warning" role="status"><span class="visually-hidden">Carregando...</span></div>
        </div>
        <div id="internamento-info-content" style="display:none"></div>
      </div>
      <div class="modal-footer" id="internamento-info-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal para Adicionar RN -->
<div class="modal fade" id="modalAdicionarRN" tabindex="-1" aria-labelledby="modalAdicionarRNLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalAdicionarRNLabel">
                    <i class="fas fa-baby me-2"></i>Adicionar Rec√©m-Nascido
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Informa√ß√£o sobre atalhos -->
                <div class="alert alert-light border-0 mb-3" style="font-size: 0.85em;">
                    <i class="fas fa-keyboard mr-1"></i>
                    <strong>Atalhos:</strong> 
                    <span class="badge badge-secondary mr-1">Ctrl+Enter</span> Avan√ßar/Salvar
                    <span class="badge badge-secondary mr-1">Alt+1/2</span> Trocar abas
                    <span class="badge badge-secondary">Esc</span> Fechar
                </div>
                
                <!-- Abas para as etapas do processo -->
                <ul class="nav nav-tabs" id="adicionarRNTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="dados-rn-tab" data-bs-toggle="tab" href="#dados-rn" role="tab" aria-controls="dados-rn" aria-selected="true">
                            1. Dados do RN
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="internacao-rn-tab" data-bs-toggle="tab" href="#internacao-rn" role="tab" aria-controls="internacao-rn" aria-selected="false">
                            2. Dados da Interna√ß√£o
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content mt-4" id="adicionarRNTabsContent">
                    <!-- Etapa 1: Dados do RN -->
                    <div class="tab-pane fade show active" id="dados-rn" role="tabpanel" aria-labelledby="dados-rn-tab">
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Paciente M√£e:</strong> {{ paciente.nome }}
                            <br>
                            <small>Os dados de endere√ßo, telefone e munic√≠pio ser√£o automaticamente copiados da m√£e.</small>
                        </div>
                        
                        <form id="dadosRNForm">
                            <div class="row">
                                <div class="form-group col-md-8">
                                    <label for="nomeRN" class="form-label">Nome Completo do RN*</label>
                                    <input type="text" class="form-control" id="nomeRN" name="nomeRN" placeholder="RN DE {{ paciente.nome|upper }}" required>
                                    <small class="text-muted">Sugest√£o: RN DE [NOME DA M√ÉE]</small>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="sexoRN" class="form-label">Sexo*</label>
                                    <select class="form-control" id="sexoRN" name="sexoRN" required>
                                        <option value="">Selecione...</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Feminino</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-4">
                                    <label for="dataNascimentoRN" class="form-label">Data de Nascimento*</label>
                                    <input type="date" class="form-control" id="dataNascimentoRN" name="dataNascimentoRN" required>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="horaNascimentoRN" class="form-label">Hora de Nascimento</label>
                                    <input type="time" class="form-control" id="horaNascimentoRN" name="horaNascimentoRN">
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="corRN" class="form-label">Ra√ßa/Cor*</label>
                                    <select class="form-control" id="corRN" name="corRN" required>
                                        <option value="">Selecione...</option>
                                        <option value="Branca">Branca</option>
                                        <option value="Parda">Parda</option>
                                        <option value="Preta">Preta</option>
                                        <option value="Amarela">Amarela</option>
                                        <option value="Ind√≠gena">Ind√≠gena</option>
                                        <option value="N√£o informada">N√£o informada</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="pesoRN" class="form-label">
                                        Peso ao Nascer (gramas)
                                        <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Peso normal: 2500g - 4000g. Baixo peso: < 2500g"></i>
                                    </label>
                                    <input type="number" class="form-control" id="pesoRN" name="pesoRN" placeholder="Ex: 3200" min="500" max="8000">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="alturaRN" class="form-label">
                                        Altura (cm)
                                        <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Altura normal para RN a termo: 48-52cm"></i>
                                    </label>
                                    <input type="number" class="form-control" id="alturaRN" name="alturaRN" placeholder="Ex: 50" min="30" max="70" step="0.1">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="apgarRN" class="form-label">
                                        √çndice de Apgar
                                        <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Formato: 1¬∫ min/5¬∫ min (Ex: 8/9). Pontua√ß√£o de 0-10"></i>
                                    </label>
                                    <input type="text" class="form-control" id="apgarRN" name="apgarRN" placeholder="Ex: 8/9">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="observacoesRN" class="form-label">Observa√ß√µes</label>
                                    <textarea class="form-control" id="observacoesRN" name="observacoesRN" rows="2" placeholder="Observa√ß√µes gerais sobre o RN"></textarea>
                                </div>
                            </div>
                            
                            <!-- Dados herdados da m√£e (somente leitura) -->
                            <hr class="my-4">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-copy mr-2"></i>Dados Herdados da M√£e
                            </h6>
                            
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="filiacaoRN" class="form-label">Filia√ß√£o (Nome da M√£e)</label>
                                    <input type="text" class="form-control" id="filiacaoRN" name="filiacaoRN" value="{{ paciente.nome }}" readonly>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="telefoneRN" class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="telefoneRN" name="telefoneRN" value="{{ paciente.telefone }}" readonly>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-8">
                                    <label for="enderecoRN" class="form-label">Endere√ßo</label>
                                    <input type="text" class="form-control" id="enderecoRN" name="enderecoRN" value="{{ paciente.endereco }}" readonly>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="bairroRN" class="form-label">Bairro</label>
                                    <input type="text" class="form-control" id="bairroRN" name="bairroRN" value="{{ paciente.bairro }}" readonly>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="municipioRN" class="form-label">Munic√≠pio</label>
                                    <input type="text" class="form-control" id="municipioRN" name="municipioRN" value="{{ paciente.municipio }}" readonly>
                                </div>
                            </div>
                            
                            <p class="text-muted mt-3">
                                <small>* Campos obrigat√≥rios</small>
                            </p>
                            
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" id="proximoRN" class="btn btn-success proximo-btn">
                                    Pr√≥ximo <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Etapa 2: Dados da Interna√ß√£o -->
                    <div class="tab-pane fade" id="internacao-rn" role="tabpanel" aria-labelledby="internacao-rn-tab">
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o:</strong> Preencha cuidadosamente os dados da interna√ß√£o do rec√©m-nascido.
                        </div>
                        
                        <form id="internacaoRNForm">
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="leitoRN" class="form-label">Leito*</label>
                                    <select class="form-control" id="leitoRN" name="leitoRN" required>
                                        <option value="">Carregando leitos...</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="caraterInternacaoRN" class="form-label">Car√°ter da Interna√ß√£o*</label>
                                    <select class="form-control" id="caraterInternacaoRN" name="caraterInternacaoRN" required>
                                        <option value="">Selecione...</option>
                                        <option value="Urg√™ncia">Urg√™ncia</option>
                                        <option value="Eletiva">Eletiva</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <label for="hdaRN" class="form-label">Hist√≥ria da Doen√ßa Atual (HDA)*</label>
                                    <textarea class="form-control" id="hdaRN" name="hdaRN" rows="3" required placeholder="Descreva as condi√ß√µes do nascimento e estado atual do RN"></textarea>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <label for="diagnosticoInicialRN" class="form-label">Diagn√≥stico Inicial*</label>
                                    <textarea class="form-control" id="diagnosticoInicialRN" name="diagnosticoInicialRN" rows="3" required placeholder="Ex: Rec√©m-nascido a termo, parto normal, sem intercorr√™ncias"></textarea>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <label for="anamneseExameFisicoRN" class="form-label">Anamnese e Exame F√≠sico*</label>
                                    <textarea class="form-control" id="anamneseExameFisicoRN" name="anamneseExameFisicoRN" rows="4" required placeholder="Descreva o exame f√≠sico do RN, condi√ß√µes gerais, reflexos, etc."></textarea>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <label for="condutaInicialRN" class="form-label">Conduta Inicial*</label>
                                    <textarea class="form-control" id="condutaInicialRN" name="condutaInicialRN" rows="3" required placeholder="Plano terap√™utico inicial, cuidados, medica√ß√µes, etc."></textarea>
                                </div>
                            </div>
                            
                            <!-- Primeira Evolu√ß√£o -->
                            <div class="row">
                                <div class="form-group col-md-12">
                                    <label for="primeiraEvolucaoRN" class="form-label">Primeira Evolu√ß√£o*</label>
                                    <textarea class="form-control" id="primeiraEvolucaoRN" name="primeiraEvolucaoRN" rows="4" required placeholder="Registre a primeira evolu√ß√£o m√©dica do rec√©m-nascido, incluindo estado geral, sinais vitais, amamenta√ß√£o, reflexos, condi√ß√µes gerais, resposta ao ambiente extrauterino, etc."></textarea>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="cidPrincipalRN" class="form-label">
                                        CID Principal*
                                        <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Z38.0 - Nascido √∫nico em hospital | Z38.1 - Nascido √∫nico fora do hospital | P00-P96 - Afec√ß√µes originadas no per√≠odo perinatal"></i>
                                    </label>
                                    <input type="text" class="form-control" id="cidPrincipalRN" name="cidPrincipalRN" placeholder="Ex.: Z38.0" required>
                                    <small class="text-muted">Z38.0 - Nascido √∫nico em hospital</small>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="cid10SecundarioRN" class="form-label">CID 10 Secund√°rio</label>
                                    <input type="text" class="form-control" id="cid10SecundarioRN" name="cid10SecundarioRN" placeholder="Ex.: P22.0">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="cid10CausasAssociadasRN" class="form-label">CID 10 Causas Associadas</label>
                                    <input type="text" class="form-control" id="cid10CausasAssociadasRN" name="cid10CausasAssociadasRN" placeholder="Se aplic√°vel">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="examesRealizadosRN" class="form-label">Exames Realizados</label>
                                    <textarea class="form-control" id="examesRealizadosRN" name="examesRealizadosRN" rows="2" placeholder="Exames j√° realizados ou solicitados"></textarea>
                                </div>
                            </div>
                            
                            <p class="text-muted mt-3">
                                <small>* Campos obrigat√≥rios</small>
                            </p>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" id="btnVoltarDadosRN">
                                    <i class="fas fa-arrow-left me-1"></i> Voltar
                                </button>
                                <button type="button" id="finalizarRN" class="btn btn-success">
                                    <i class="fas fa-check me-1"></i> Finalizar Cadastro do RN
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Campos ocultos para IDs necess√°rios -->
<input type="hidden" id="user_id" value="{{ session.get('user_id', 0) }}">
<input type="hidden" id="paciente_id" value="{{ paciente.id }}">

<!-- Modal Hist√≥rico de Internamentos -->
<div class="modal fade" id="modalHistoricoInternamentos" tabindex="-1" aria-labelledby="modalHistoricoInternamentosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalHistoricoInternamentosLabel">
                    <i class="fas fa-history me-2"></i>Hist√≥rico de Internamentos - {{ paciente.nome }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="loading-historico" class="text-center my-4">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Carregando hist√≥rico...</span>
                    </div>
                    <p class="mt-2 text-muted">Buscando internamentos anteriores...</p>
                </div>
                
                <!-- Painel de Debug -->
                <div class="alert alert-light border mb-3" id="debug-panel" style="display: none;">
                    <h6 class="alert-heading"><i class="fas fa-bug me-1"></i>Informa√ß√µes de Debug</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>ID do Paciente:</strong></small>
                            <div id="debug-paciente-id" class="font-monospace">-</div>
                        </div>
                        <div class="col-md-6">
                            <small><strong>ID do Atendimento:</strong></small>
                            <div id="debug-atendimento-id" class="font-monospace">-</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small><strong>URL da API:</strong></small>
                        <div id="debug-url-api" class="font-monospace text-break">-</div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-debug-reload">
                            <i class="fas fa-redo me-1"></i>Tentar Novamente
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-toggle-debug">
                            <i class="fas fa-eye-slash me-1"></i>Ocultar Debug
                        </button>
                    </div>
                </div>
                
                <div id="conteudo-historico" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Este hist√≥rico inclui todas as interna√ß√µes anteriores do paciente no sistema.
                        <button type="button" class="btn btn-sm btn-outline-info float-end" id="btn-show-debug">
                            <i class="fas fa-bug me-1"></i>Debug
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-info">
                                <tr>
                                    <th><i class="fas fa-calendar-alt me-1"></i>Data Interna√ß√£o</th>
                                    <th><i class="fas fa-stethoscope me-1"></i>Diagn√≥stico</th>
                                    <th><i class="fas fa-calendar-check me-1"></i>Data Alta</th>
                                    <th><i class="fas fa-user-md me-1"></i>M√©dico</th>
                                    <th><i class="fas fa-bed me-1"></i>Leito</th>
                                    <th><i class="fas fa-eye me-1"></i>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaHistoricoInternamentos">
                                <!-- Preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="sem-historico" class="text-center py-4" style="display: none;">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum internamento anterior encontrado</h5>
                        <p class="text-muted">Este √© o primeiro internamento registrado para este paciente.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Informa√ß√µes de Alta -->
<div class="modal fade" id="modalInformacoesAlta" tabindex="-1" aria-labelledby="modalInformacoesAltaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalInformacoesAltaLabel">
                    <i class="fas fa-user-check me-2"></i>Informa√ß√µes de Alta do Paciente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-user me-2"></i>Dados do Paciente
                        </h6>
                        <div class="d-flex gap-4">
                            <strong>Nome:</strong> <span id="altaNomePaciente"></span>
                            <strong>CPF:</strong> <span id="altaCpfPaciente"></span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <h6 class="text-success mb-2">
                            <i class="fas fa-calendar-check me-2"></i>Data de Alta
                        </h6>
                        <strong id="altaDataAlta" class="text-success fs-5"></strong>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-12">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light border-0">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-stethoscope me-2"></i>Diagn√≥stico Final
                                </h6>
                            </div>
                            <div class="card-body">
                                <p id="altaDiagnosticoAlta" class="mb-0 text-justify" style="min-height: 60px; white-space: pre-wrap;"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-12">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light border-0">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-history me-2"></i>Hist√≥rico da Interna√ß√£o
                                </h6>
                            </div>
                            <div class="card-body">
                                <p id="altaHistoricoInternacao" class="mb-0 text-justify" style="min-height: 100px; white-space: pre-wrap;"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light border-0">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-heart me-2"></i>Cuidados Gerais
                                </h6>
                            </div>
                            <div class="card-body">
                                <p id="altaCuidadosGerais" class="mb-0 text-justify" style="min-height: 60px; white-space: pre-wrap;"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="imprimirInformacoesAlta()">
                    <i class="fas fa-print me-2"></i>Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Modal para Nova Ficha de Refer√™ncia -->
    <div class="modal fade" id="modalNovaFichaReferencia" tabindex="-1" aria-labelledby="modalNovaFichaReferenciaLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content shadow-lg border-0 rounded-lg">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title fw-bold" id="modalNovaFichaReferenciaLabel">
                        <i class="fas fa-file-export me-2"></i>Nova Ficha de Refer√™ncia
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-info d-flex align-items-center mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Orienta√ß√£o:</strong> Preencha as informa√ß√µes necess√°rias para o encaminhamento do paciente. O texto de refer√™ncia √© o campo principal para detalhar a situa√ß√£o cl√≠nica.
                        </div>
                    </div>
                    
                    <form id="formFichaReferencia">
                        <!-- Primeira linha: Unidade de Refer√™ncia e Tipo de Encaminhamento -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control form-control-lg" id="unidade_referencia" name="unidade_referencia" placeholder="Ex: Hospital Regional, UPA Central...">
                                    <label for="unidade_referencia">
                                        <i class="fas fa-hospital me-1 text-primary"></i>Unidade de Refer√™ncia
                                    </label>
                                </div>
                                <div class="form-text">Ex: Hospital de Refer√™ncia, Centro da Vida, etc..</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold mb-3">
                                    <i class="fas fa-share me-1 text-success"></i>Tipo de Encaminhamento
                                </label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check form-check-lg p-3 border rounded bg-light">
                                        <input class="form-check-input form-check-input-lg" type="checkbox" id="encaminhamento_ambulatorial" name="encaminhamento_ambulatorial" value="Ambulatorial">
                                        <label class="form-check-label fw-semibold" for="encaminhamento_ambulatorial">
                                            <i class="fas fa-clinic-medical me-2 text-info"></i>Ambulatorial
                                            <small class="d-block text-muted">Consultas e procedimentos ambulatoriais</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-lg p-3 border rounded bg-light">
                                        <input class="form-check-input form-check-input-lg" type="checkbox" id="encaminhamento_hospitalar" name="encaminhamento_hospitalar" value="Hospitalar">
                                        <label class="form-check-label fw-semibold" for="encaminhamento_hospitalar">
                                            <i class="fas fa-hospital me-2 text-danger"></i>Hospitalar
                                            <small class="d-block text-muted">Interna√ß√£o e cuidados hospitalares</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-lg p-3 border rounded bg-light">
                                        <input class="form-check-input form-check-input-lg" type="checkbox" id="encaminhamento_auxilio_diagnostico" name="encaminhamento_auxilio_diagnostico" value="Auxilio Diagnostico">
                                        <label class="form-check-label fw-semibold" for="encaminhamento_auxilio_diagnostico">
                                            <i class="fas fa-x-ray me-2 text-warning"></i>Aux√≠lio Diagn√≥stico
                                            <small class="d-block text-muted">Exames e procedimentos diagn√≥sticos</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Segunda linha: Procedimento -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="procedimento" name="procedimento" rows="3" style="height: 100px;" placeholder="Descreva o procedimento solicitado..."></textarea>
                                    <label for="procedimento">
                                        <i class="fas fa-cogs me-1 text-warning"></i>Procedimento Solicitado
                                    </label>
                                </div>
                                <div class="form-text">Descreva procedimentos espec√≠ficos, cirurgias ou tratamentos recomendados</div>
                            </div>
                        </div>

                        <!-- Terceira linha: Texto de Refer√™ncia (Campo Principal) -->
                        <div class="row">
                            <div class="col-12">
                                <label for="texto_referencia" class="form-label fw-bold text-primary mb-3">
                                    <i class="fas fa-file-text me-2"></i>Texto de Refer√™ncia (Campo Principal)
                                </label>
                                <div class="border border-primary border-2 rounded p-2">
                                    <textarea class="form-control form-control-lg border-0" 
                                              id="texto_referencia" 
                                              name="texto_referencia" 
                                              rows="10" 
                                              style="resize: vertical; min-height: 280px; font-size: 14px; line-height: 1.6;"
                                              placeholder="Digite aqui os detalhes da refer√™ncia:&#10;&#10;‚Ä¢ Hist√≥ria cl√≠nica resumida&#10;‚Ä¢ Motivo do encaminhamento&#10;‚Ä¢ Exames realizados&#10;‚Ä¢ Tratamentos j√° tentados&#10;‚Ä¢ Observa√ß√µes importantes&#10;&#10;Seja detalhado para facilitar o atendimento na unidade de destino."></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light border-0 p-4" style="position: relative; z-index: 1060;">
                    <button type="button" class="btn btn-outline-secondary btn-lg me-2" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" 
                            class="btn btn-success btn-lg px-4" 
                            id="btn_salvar_ficha_referencia"
                            style="position: relative; z-index: 1070; pointer-events: auto; cursor: pointer;">
                        <i class="fas fa-save me-2"></i>Salvar Ficha de Refer√™ncia
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Ficha de Refer√™ncia -->
    <div class="modal fade" id="modalVisualizarFichaReferencia" tabindex="-1" aria-labelledby="modalVisualizarFichaReferenciaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalVisualizarFichaReferenciaLabel">
                        <i class="fas fa-eye me-2"></i>Visualizar Ficha de Refer√™ncia
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <!-- Conte√∫do ser√° inserido dinamicamente pelo JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Op√ß√µes de Impress√£o -->
    <div class="modal fade" id="modalOpcoesImpressao" tabindex="-1" aria-labelledby="modalOpcoesImpressaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-white border-bottom">
                    <h5 class="modal-title text-dark fw-bold" id="modalOpcoesImpressaoLabel">
                        <i class="fas fa-print me-2"></i>Op√ß√µes de Impress√£o
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-dark mb-4">Selecione o documento que deseja imprimir:</p>
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-dark btn-lg text-start d-flex align-items-center" onclick="imprimirAIH('{{ internacao.atendimento_id }}')">
                            <div class="me-3">
                                <i class="fas fa-file-medical fa-2x"></i>
                            </div>
                            <div>
                                <div class="fw-bold">AIH - Autoriza√ß√£o de Interna√ß√£o Hospitalar</div>
                                <small class="text-muted">Documento oficial de interna√ß√£o</small>
                            </div>
                        </button>
                        
                        <button type="button" class="btn btn-outline-dark btn-lg text-start d-flex align-items-center" onclick="imprimirFichaAdmissao('{{ internacao.atendimento_id }}')">
                            <div class="me-3">
                                <i class="fas fa-clipboard-list fa-2x"></i>
                            </div>
                            <div>
                                <div class="fw-bold">Ficha de Admiss√£o</div>
                                <small class="text-muted">Dados do paciente e anamnese</small>
                            </div>
                        </button>
                        
                        <button type="button" class="btn btn-outline-dark btn-lg text-start d-flex align-items-center" onclick="imprimirUltimaPrescricao()" id="btnModalImprimirPrescricao">
                            <div class="me-3">
                                <i class="fas fa-pills fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">√öltima Prescri√ß√£o</div>
                                <small class="text-muted d-block" id="infoPrescricaoModal">
                                    <span class="spinner-border spinner-border-sm me-1" style="width: 0.8rem; height: 0.8rem;"></span>
                                    Carregando...
                                </small>
                            </div>
                        </button>
                        
                        <button type="button" class="btn btn-outline-dark btn-lg text-start d-flex align-items-center" onclick="imprimirUltimaEvolucao()" id="btnModalImprimirEvolucao">
                            <div class="me-3">
                                <i class="fas fa-notes-medical fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">√öltima Evolu√ß√£o M√©dica</div>
                                <small class="text-muted d-block" id="infoEvolucaoModal">
                                    <span class="spinner-border spinner-border-sm me-1" style="width: 0.8rem; height: 0.8rem;"></span>
                                    Carregando...
                                </small>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
