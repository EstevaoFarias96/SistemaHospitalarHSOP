<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Leitos · HSOP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --azul-principal: #4A90E2;
            --azul-claro: #E8F4FF;
            --azul-medio: #7AB8F5;
            --branco-gelo: #F8FCFF;
            --cinza-texto: #4A5568;
            --cinza-claro: #E2E8F0;
            --verde-sucesso: #10B981;
            --amarelo-alerta: #F59E0B;
            --vermelho-perigo: #EF4444;
            --sombra-suave: 0 2px 12px rgba(74, 144, 226, 0.08);
            --sombra-media: 0 4px 20px rgba(74, 144, 226, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--branco-gelo) 0%, var(--azul-claro) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .page-header {
            background: white;
            border-radius: 16px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: var(--sombra-suave);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--azul-principal);
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .page-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-custom {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--azul-principal), var(--azul-medio));
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(74, 144, 226, 0.35);
        }

        .btn-outline-custom {
            background: white;
            border: 2px solid var(--azul-principal);
            color: var(--azul-principal);
        }

        .btn-outline-custom:hover {
            background: var(--azul-principal);
            color: white;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--sombra-media);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--azul-principal), var(--azul-medio));
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 22px;
        }

        .stat-icon.blue { background: var(--azul-claro); color: var(--azul-principal); }
        .stat-icon.green { background: #D1FAE5; color: var(--verde-sucesso); }
        .stat-icon.yellow { background: #FEF3C7; color: var(--amarelo-alerta); }
        .stat-icon.red { background: #FEE2E2; color: var(--vermelho-perigo); }

        .stat-label {
            font-size: 13px;
            color: var(--cinza-texto);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--cinza-texto);
            margin: 0;
        }

        /* Filtros e Tabs */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--sombra-suave);
        }

        .filter-tabs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 10px 20px;
            border-radius: 8px;
            background: var(--cinza-claro);
            border: none;
            color: var(--cinza-texto);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            background: var(--azul-claro);
        }

        .filter-tab.active {
            background: var(--azul-principal);
            color: white;
        }

        /* Setor Container */
        .setor-container {
            margin-bottom: 32px;
        }

        .setor-header {
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 16px 24px;
            box-shadow: var(--sombra-suave);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--azul-principal);
        }

        .setor-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--azul-principal);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setor-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--cinza-texto);
        }

        .setor-leitos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: var(--sombra-suave);
        }

        /* Leito Card */
        .leito-card {
            background: #FAFBFC;
            border: 2px solid var(--cinza-claro);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            position: relative;
        }

        .leito-card:hover {
            border-color: var(--azul-medio);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15);
        }

        .leito-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .leito-nome {
            font-size: 16px;
            font-weight: 600;
            color: var(--cinza-texto);
            margin: 0;
        }

        .leito-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-disponivel { background: #D1FAE5; color: #065F46; }
        .badge-ocupado { background: #FEE2E2; color: #991B1B; }
        .badge-parcial { background: #FEF3C7; color: #92400E; }

        .leito-tipo {
            font-size: 12px;
            color: var(--cinza-texto);
            margin-bottom: 12px;
        }

        .leito-ocupacao {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--cinza-texto);
            margin-bottom: 8px;
        }

        .progress-custom {
            height: 8px;
            background: var(--cinza-claro);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-bar-custom {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .progress-bar-custom.success { background: var(--verde-sucesso); }
        .progress-bar-custom.warning { background: var(--amarelo-alerta); }
        .progress-bar-custom.danger { background: var(--vermelho-perigo); }

        /* Drop Zone para Pacientes */
        .pacientes-drop-zone {
            min-height: 80px;
            border: 2px dashed var(--cinza-claro);
            border-radius: 8px;
            padding: 8px;
            transition: all 0.3s ease;
            background: white;
        }

        .pacientes-drop-zone.drag-over {
            border-color: var(--azul-principal);
            background: var(--azul-claro);
            border-style: solid;
        }

        .pacientes-drop-zone.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--cinza-texto);
            font-size: 12px;
            opacity: 0.6;
        }

        /* Paciente Card (draggable) */
        .paciente-item {
            background: white;
            border: 2px solid var(--cinza-claro);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            position: relative;
        }

        .paciente-item:last-child {
            margin-bottom: 0;
        }

        .paciente-item:hover {
            border-color: var(--azul-principal);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
            transform: translateY(-2px);
        }

        .paciente-item:active {
            cursor: grabbing;
        }

        .paciente-item.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .paciente-nome-drag {
            font-size: 13px;
            font-weight: 600;
            color: var(--cinza-texto);
            margin-bottom: 4px;
        }

        .paciente-info-drag {
            font-size: 11px;
            color: var(--cinza-texto);
            opacity: 0.8;
        }

        .paciente-grip {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--cinza-claro);
            font-size: 14px;
        }

        /* Toast de Feedback */
        .toast-container-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast-custom {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-icon.success { background: #D1FAE5; color: var(--verde-sucesso); }
        .toast-icon.error { background: #FEE2E2; color: var(--vermelho-perigo); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 12px;
            color: var(--cinza-texto);
        }

        /* Loading State */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--cinza-claro) 25%, #F5F6FA 50%, var(--cinza-claro) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
            height: 60px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .page-header {
                padding: 16px 20px;
            }

            .page-title {
                font-size: 20px;
            }

            .stats-overview {
                grid-template-columns: 1fr;
            }

            .setor-leitos {
                grid-template-columns: 1fr;
            }

            .filter-tabs {
                width: 100%;
            }

            .filter-tab {
                flex: 1;
                text-align: center;
            }
        }

        /* Animações de números */
        .numero-atualizado {
            animation: pulseNumber 0.6s ease-out;
        }

        @keyframes pulseNumber {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); color: var(--azul-principal); }
            100% { transform: scale(1); }
        }

        /* Último update timestamp */
        .timestamp {
            font-size: 12px;
            color: var(--cinza-texto);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container-custom" id="toastContainer"></div>

    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-bed"></i>
                Gestão de Leitos
            </h1>
            <p class="timestamp">Última atualização: <span id="lastUpdate">--:--:--</span></p>
        </div>
        <div class="page-actions">
            <button class="btn-custom btn-outline-custom" onclick="window.location.href='/clinica'">
                <i class="fas fa-arrow-left"></i>
                Voltar
            </button>
            <button class="btn-custom btn-primary-custom" onclick="forcarAtualizacao()">
                <i class="fas fa-sync-alt"></i>
                Atualizar
            </button>
            <button class="btn-custom btn-primary-custom" onclick="abrirModalPesquisaPacientes()">
                <i class="fas fa-search"></i>
                Buscar Paciente
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    {% set total_ocupados = leitos|sum(attribute='ocupacao_atual') if leitos else 0 %}
    {% set total_capacidade = leitos|sum(attribute='capacidade_maxima') if leitos else 0 %}
    {% set ocupacao_percentual = (total_ocupados / total_capacidade * 100) if total_capacidade else 0 %}
    
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-bed"></i>
            </div>
            <div class="stat-label">Total de Leitos</div>
            <h2 class="stat-value" id="totalLeitos">{{ total_capacidade }}</h2>
        </div>
        <div class="stat-card">
            <div class="stat-icon red">
                <i class="fas fa-user-injured"></i>
            </div>
            <div class="stat-label">Leitos Ocupados</div>
            <h2 class="stat-value" id="leitosOcupados">{{ total_ocupados }}</h2>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-label">Leitos Disponíveis</div>
            <h2 class="stat-value" id="leitosDisponiveis">{{ total_capacidade - total_ocupados }}</h2>
        </div>
        <div class="stat-card">
            <div class="stat-icon yellow">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-label">Taxa de Ocupação</div>
            <h2 class="stat-value" id="taxaOcupacao">{{ '%.0f' % ocupacao_percentual }}%</h2>
        </div>
    </div>

    <!-- Filtros por Setor -->
    <div class="filters-section">
        <div class="filter-tabs">
            <button class="filter-tab active" data-setor="todos" onclick="filtrarPorSetor('todos')">
                <i class="fas fa-th"></i> Todos os Setores
            </button>
            {% if leitos %}
                {% for setor in leitos|map(attribute='setor')|unique|list %}
                <button class="filter-tab" data-setor="{{ setor }}" onclick="filtrarPorSetor('{{ setor }}')">
                    {{ setor }}
                </button>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Leitos por Setor -->
    <div id="leitosContainer">
        {% if leitos %}
            {% set setores = leitos|map(attribute='setor')|unique|list %}
            {% for setor in setores %}
            {% set leitos_setor = leitos|selectattr('setor', 'equalto', setor)|list %}
            {% set total_capacidade_setor = leitos_setor|sum(attribute='capacidade_maxima') %}
            {% set total_ocupados_setor = leitos_setor|sum(attribute='ocupacao_atual') %}
        
        <div class="setor-container" data-setor="{{ setor }}">
            <div class="setor-header">
                <h3 class="setor-title">
                    <i class="fas fa-hospital"></i>
                    {{ setor }}
                </h3>
                <div class="setor-stats">
                    <span><i class="fas fa-bed"></i> {{ leitos_setor|length }} leitos</span>
                    <span><i class="fas fa-users"></i> {{ total_ocupados_setor }}/{{ total_capacidade_setor }} ocupados</span>
                </div>
            </div>
            <div class="setor-leitos">
                {% for leito in leitos_setor %}
                {% set ocupacao_leito_percentual = (leito.ocupacao_atual / leito.capacidade_maxima * 100) if leito.capacidade_maxima else 0 %}
                <div class="leito-card" data-leito="{{ leito.nome }}">
                    <div class="leito-header">
                        <div>
                            <h4 class="leito-nome">{{ leito.nome }}</h4>
                            <p class="leito-tipo">{{ leito.tipo }}</p>
                        </div>
                        <span class="leito-badge {% if leito.ocupacao_atual == 0 %}badge-disponivel{% elif leito.ocupacao_atual >= leito.capacidade_maxima %}badge-ocupado{% else %}badge-parcial{% endif %}">
                            {% if leito.ocupacao_atual == 0 %}Disponível{% elif leito.ocupacao_atual >= leito.capacidade_maxima %}Ocupado{% else %}Parcial{% endif %}
                        </span>
                    </div>
                    <div class="leito-ocupacao">
                        <span>Ocupação</span>
                        <span class="ocupacao-numeros"><strong class="numero-atual">{{ leito.ocupacao_atual }}</strong> / {{ leito.capacidade_maxima }}</span>
                    </div>
                    <div class="progress-custom">
                        <div class="progress-bar-custom {% if ocupacao_leito_percentual < 50 %}success{% elif ocupacao_leito_percentual < 85 %}warning{% else %}danger{% endif %}" 
                             style="width: {{ ocupacao_leito_percentual }}%"
                             data-capacidade="{{ leito.capacidade_maxima }}"></div>
                    </div>
                    <div class="pacientes-drop-zone" data-leito="{{ leito.nome }}" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                        <div class="loading-skeleton"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle"></i> Nenhum leito cadastrado no momento.
        </div>
        {% endif %}
    </div>

    <!-- Modal de Pesquisa de Pacientes -->
    <div class="modal fade" id="pesquisarPacientesModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search"></i> Pacientes Internados
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="searchInputPaciente" class="form-control mb-3" placeholder="Buscar paciente pelo nome...">
                    <div id="listaPacientesModal">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Carregando pacientes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let draggedElement = null;
        let todosPacientes = [];

        // Calcular idade
        function calcularIdade(dataNascimento) {
            if (!dataNascimento) return 'N/A';
            const hoje = new Date();
            const nascimento = new Date(dataNascimento);
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const mes = hoje.getMonth() - nascimento.getMonth();
            if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                idade--;
            }
            return idade + ' anos';
        }

        // Mostrar toast de feedback
        function mostrarToast(tipo, titulo, mensagem) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast-custom';
            toast.innerHTML = `
                <div class="toast-icon ${tipo}">
                    <i class="fas fa-${tipo === 'success' ? 'check' : 'exclamation-circle'}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${titulo}</div>
                    <div class="toast-message">${mensagem}</div>
                </div>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Carregar pacientes de um leito
        function carregarPacientesLeito(leitoNome, dropZone) {
            fetch(`/api/internacoes/leito/${encodeURIComponent(leitoNome)}`)
                .then(response => response.json())
                .then(data => {
                    console.log(`Leito: ${leitoNome}, Pacientes:`, data);
                    
                    // Limpar conteúdo anterior
                    dropZone.innerHTML = '';
                    
                    if (!Array.isArray(data) || data.length === 0) {
                        dropZone.classList.add('empty');
                        dropZone.innerHTML = '<span>Nenhum paciente</span>';
                        return;
                    }
                    
                    dropZone.classList.remove('empty');
                    
                    data.forEach(p => {
                        const idade = calcularIdade(p.data_nascimento);
                        const pacienteDiv = document.createElement('div');
                        pacienteDiv.className = 'paciente-item';
                        pacienteDiv.draggable = true;
                        pacienteDiv.setAttribute('data-paciente-id', p.id || p.paciente_id);
                        pacienteDiv.setAttribute('data-atendimento-id', p.atendimento_id);
                        pacienteDiv.setAttribute('data-paciente-nome', p.nome);
                        pacienteDiv.setAttribute('data-leito-origem', leitoNome);
                        pacienteDiv.innerHTML = `
                            <div class="paciente-nome-drag">${p.nome}</div>
                            <div class="paciente-info-drag">${p.diagnostico || 'Sem diagnóstico'} • ${idade}</div>
                            <div class="paciente-grip">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                        `;
                        pacienteDiv.addEventListener('dragstart', drag);
                        dropZone.appendChild(pacienteDiv);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar pacientes do leito ' + leitoNome + ':', error);
                    dropZone.innerHTML = '<div class="text-danger small p-2">Erro ao carregar pacientes</div>';
                });
        }

        // Carregar todos os leitos
        function carregarTodosLeitos() {
            document.querySelectorAll('.pacientes-drop-zone').forEach(zone => {
                const leito = zone.getAttribute('data-leito');
                carregarPacientesLeito(leito, zone);
            });
            atualizarTimestamp();
        }

        // Atualizar timestamp
        function atualizarTimestamp() {
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            document.getElementById('lastUpdate').textContent = 
                `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        }

        // Forçar atualização
        function forcarAtualizacao() {
            mostrarToast('success', 'Atualizando', 'Carregando dados dos leitos...');
            carregarTodosLeitos();
        }

        // Filtrar por setor
        function filtrarPorSetor(setor) {
            // Atualizar tabs ativos
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-setor="${setor}"]`).classList.add('active');
            
            // Mostrar/ocultar setores
            document.querySelectorAll('.setor-container').forEach(container => {
                if (setor === 'todos' || container.getAttribute('data-setor') === setor) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
        }

        // Drag and Drop
        function drag(ev) {
            draggedElement = ev.target;
            ev.target.classList.add('dragging');
            ev.dataTransfer.effectAllowed = 'move';
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.target.closest('.pacientes-drop-zone').classList.add('drag-over');
        }

        function dragLeave(ev) {
            ev.target.closest('.pacientes-drop-zone').classList.remove('drag-over');
        }

        function drop(ev) {
            ev.preventDefault();
            const dropZone = ev.target.closest('.pacientes-drop-zone');
            dropZone.classList.remove('drag-over');
            
            if (!draggedElement) return;
            
            const leitoDestino = dropZone.getAttribute('data-leito');
            const leitoOrigem = draggedElement.getAttribute('data-leito-origem');
            const atendimentoId = draggedElement.getAttribute('data-atendimento-id');
            const pacienteNome = draggedElement.getAttribute('data-paciente-nome');
            
            draggedElement.classList.remove('dragging');
            
            if (leitoDestino === leitoOrigem) {
                return;
            }
            
            if (confirm(`Confirma a realocação de ${pacienteNome}\nDe: ${leitoOrigem}\nPara: ${leitoDestino}?`)) {
                realocarPaciente(atendimentoId, leitoDestino, leitoOrigem, pacienteNome);
            }
        }

        // Realocar paciente
        function realocarPaciente(atendimentoId, leitoDestino, leitoOrigem, pacienteNome) {
            fetch('/api/realocar-paciente', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    atendimento_id: atendimentoId,
                    leito_destino: leitoDestino
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarToast('success', 'Realocação bem-sucedida', 
                        `${pacienteNome} foi movido para ${leitoDestino}`);
                    
                    // Remover elemento visualmente
                    draggedElement.remove();
                    
                    // Atualizar números
                    atualizarOcupacaoVisual(leitoOrigem, leitoDestino);
                    
                    draggedElement = null;
                } else {
                    mostrarToast('error', 'Erro na realocação', data.message || 'Tente novamente');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarToast('error', 'Erro na realocação', 'Falha na comunicação com o servidor');
            });
        }

        // Atualizar ocupação visual
        function atualizarOcupacaoVisual(leitoOrigem, leitoDestino) {
            const cardOrigem = document.querySelector(`[data-leito="${leitoOrigem}"]`);
            const cardDestino = document.querySelector(`[data-leito="${leitoDestino}"]`);
            
            if (cardOrigem) {
                const numeroElement = cardOrigem.querySelector('.numero-atual');
                const capacidade = parseInt(cardOrigem.querySelector('[data-capacidade]').getAttribute('data-capacidade'));
                const atual = parseInt(numeroElement.textContent);
                const nova = Math.max(0, atual - 1);
                
                numeroElement.classList.add('numero-atualizado');
                setTimeout(() => {
                    numeroElement.textContent = nova;
                    numeroElement.classList.remove('numero-atualizado');
                    
                    // Atualizar barra de progresso
                    const progressBar = cardOrigem.querySelector('.progress-bar-custom');
                    const percentual = (nova / capacidade * 100);
                    progressBar.style.width = percentual + '%';
                    progressBar.className = 'progress-bar-custom ' + 
                        (percentual < 50 ? 'success' : (percentual < 85 ? 'warning' : 'danger'));
                    
                    // Atualizar badge
                    const badge = cardOrigem.querySelector('.leito-badge');
                    if (nova === 0) {
                        badge.textContent = 'Disponível';
                        badge.className = 'leito-badge badge-disponivel';
                    } else if (nova < capacidade) {
                        badge.textContent = 'Parcial';
                        badge.className = 'leito-badge badge-parcial';
                    }
                }, 300);
            }
            
            if (cardDestino) {
                const numeroElement = cardDestino.querySelector('.numero-atual');
                const capacidade = parseInt(cardDestino.querySelector('[data-capacidade]').getAttribute('data-capacidade'));
                const atual = parseInt(numeroElement.textContent);
                const nova = atual + 1;
                
                numeroElement.classList.add('numero-atualizado');
                setTimeout(() => {
                    numeroElement.textContent = nova;
                    numeroElement.classList.remove('numero-atualizado');
                    
                    // Atualizar barra de progresso
                    const progressBar = cardDestino.querySelector('.progress-bar-custom');
                    const percentual = (nova / capacidade * 100);
                    progressBar.style.width = percentual + '%';
                    progressBar.className = 'progress-bar-custom ' + 
                        (percentual < 50 ? 'success' : (percentual < 85 ? 'warning' : 'danger'));
                    
                    // Atualizar badge
                    const badge = cardDestino.querySelector('.leito-badge');
                    if (nova >= capacidade) {
                        badge.textContent = 'Ocupado';
                        badge.className = 'leito-badge badge-ocupado';
                    } else {
                        badge.textContent = 'Parcial';
                        badge.className = 'leito-badge badge-parcial';
                    }
                }, 300);
            }
        }

        // Modal de pesquisa
        function abrirModalPesquisaPacientes() {
            const modal = new bootstrap.Modal(document.getElementById('pesquisarPacientesModal'));
            modal.show();
            
            fetch('/api/pacientes/internados')
                .then(response => response.json())
                .then(data => {
                    if (data && data.success && data.pacientes) {
                        todosPacientes = data.pacientes;
                        renderizarPacientesModal(todosPacientes);
                    } else {
                        document.getElementById('listaPacientesModal').innerHTML = 
                            '<p class="text-center text-muted">Nenhum paciente internado</p>';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    document.getElementById('listaPacientesModal').innerHTML = 
                        '<p class="text-center text-danger">Erro ao carregar pacientes</p>';
                });
        }

        function renderizarPacientesModal(pacientes) {
            const container = document.getElementById('listaPacientesModal');
            
            if (pacientes.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhum paciente encontrado</p>';
                return;
            }
            
            const html = pacientes.map(p => {
                const idade = calcularIdade(p.data_nascimento);
                const cargoUsuario = "{{ session.get('cargo', '').lower() }}";
                let urlEvoluir = `/clinica/evolucao-paciente-${cargoUsuario}/${p.atendimento_id}`;
                
                return `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${p.nome}</h6>
                                    <p class="mb-1 small text-muted">${p.diagnostico || 'Sem diagnóstico'}</p>
                                    <p class="mb-0 small text-muted">${idade} • Leito: ${p.leito || 'N/A'}</p>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-info mb-2">#${p.atendimento_id}</span>
                                    <a href="${urlEvoluir}" class="btn btn-sm btn-primary d-block">
                                        <i class="fas fa-notes-medical"></i> Evoluir
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // Filtro de busca no modal
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInputPaciente');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    const termo = this.value.toLowerCase();
                    const filtrados = todosPacientes.filter(p => 
                        p.nome.toLowerCase().includes(termo)
                    );
                    renderizarPacientesModal(filtrados);
                });
            }
            
            // Carregar leitos inicialmente
            carregarTodosLeitos();
            
            // Auto-refresh a cada 60 segundos
            setInterval(carregarTodosLeitos, 60000);
        });
    </script>
</body>
</html>
