<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Leitos Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts (Roboto) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            padding-top: 58px; /* Adjusted for fixed navbar height */
            font-family: 'Roboto', sans-serif;
            background-color: #f4f6f8; /* Light grey background */
        }
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            /* fixed-top class will be added directly to the navbar element */
        }

        #sidebar {
            position: fixed;
            top: 58px; /* Should match body padding-top */
            left: 0;
            width: 230px; /* Sidebar width */
            height: calc(100vh - 58px); /* Full height below navbar */
            background-color: #343a40; /* Dark sidebar background */
            padding-top: 20px;
            z-index: 1020; /* Below navbar (default 1030 for fixed-top) */
            overflow-y: auto; /* For scrollable sidebar if content exceeds height */
        }

        #sidebar .nav-link {
            color: #c2c7d0; /* Light grey text color */
            padding: 10px 15px;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        #sidebar .nav-link:hover {
            color: #ffffff; /* White text on hover */
            background-color: #495057; /* Slightly lighter dark background on hover */
            border-left-color: #007bff; /* Accent color for hover */
        }
        
        #sidebar .nav-link.active { /* Example active link styling */
            color: #ffffff;
            background-color: #007bff;
            border-left-color: #ffffff;
        }

        /* Wrapper for main content to apply margin for sidebar */
        .main-content-wrapper {
            margin-left: 230px; /* Same as sidebar width */
        }

        /* Ensure existing main-content padding is respected for content spacing */
        .main-content {
            /* existing padding-top: 20px; and padding-bottom: 40px; will provide internal spacing */
        }
        .card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.07);
            margin-bottom: 1.5rem;
        }
        .stat-card .card-title {
            font-weight: 500;
            color: #333;
        }
        .stat-card p.text-muted {
            font-size: 0.9rem;
        }
        .stat-card h5.display-6 {
            font-weight: 700;
            color: #007bff; /* Primary color for stats */
        }
        .progress {
            height: 12px;
            border-radius: 6px;
        }
        .leito-card .card-title {
            font-weight: 500;
            color: #343a40;
        }
        .leito-card .badge {
            font-size: 0.75em;
            padding: 0.5em 0.8em;
        }
        .btn-outline-primary {
            border-radius: 20px;
            font-weight: 500;
            padding: 0.375rem 1rem;
        }
        .section-title {
            font-weight: 500;
            color: #495057;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
        }
        .pacientes-list .list-group-item {
            border-left: 0;
            border-right: 0;
        }
        .pacientes-list .list-group-item:first-child {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        .pacientes-list .list-group-item:last-child {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        /* Estilos para o modal de pesquisa de pacientes */
        #pesquisarPacientesModal .modal-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        #pesquisarPacientesModal .modal-title {
            color: #495057;
            font-weight: 500;
        }
        #searchInputPacienteInternado {
            width: 350px;
        }
        #modalPacientesInternadosBody .list-group-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        #modalPacientesInternadosBody .list-group-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        #modalPacientesInternadosBody .badge {
            font-size: 0.75rem;
        }
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        /* Estilos para o botão Evoluir no modal */
        #modalPacientesInternadosBody .btn-evoluir {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            white-space: nowrap;
        }
        #modalPacientesInternadosBody .paciente-actions {
            min-width: 120px;
        }
        
        /* Estilos para drag and drop */
        .paciente-draggable {
            cursor: move;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background-color: #fff;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
        }
        
        .paciente-draggable:hover {
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }
        
        .paciente-draggable.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .leito-drop-zone {
            min-height: 50px;
            border: 2px dashed transparent;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 4px;
        }
        
        .leito-drop-zone.drag-over {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        
        .paciente-info {
            font-size: 0.85rem;
        }
        
        .paciente-nome {
            font-weight: 600;
            color: #343a40;
        }
        
        .paciente-diagnostico {
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .paciente-idade {
            color: #495057;
            font-size: 0.8rem;
        }
        
        @media (max-width: 576px) {
            #modalPacientesInternadosBody .list-group-item {
                padding: 0.75rem;
            }
            #modalPacientesInternadosBody .btn-evoluir {
                font-size: 0.75rem;
                padding: 0.2rem 0.4rem;
            }
        }
        
        /* Estilos para animações de realocação */
        .leito-card h6 {
            transition: all 0.3s ease;
        }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        .badge {
            transition: all 0.3s ease;
        }
        
        /* Feedback visual para realocação bem-sucedida */
        .realocacao-feedback {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Animação para números que mudam */
        .numero-atualizado {
            animation: pulseNumber 0.6s ease-out;
        }
        
        @keyframes pulseNumber {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #007bff; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                HSOP - Gestão de Leitos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Relatórios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Configurações</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div id="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/clinica">
                    <!-- Add icon here if desired, e.g., <i class="bi bi-arrow-left"></i> -->
                    Voltar
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirModalPesquisaPacientes(event)">
                    <!-- <i class="bi bi-search"></i> -->
                    Pesquisar
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content Area Wrapper -->
    <div class="main-content-wrapper">
        <!-- Original Main Content Area -->
        <div class="container-fluid main-content">
            {% set total_ocupados = leitos|sum(attribute='ocupacao_atual') %}
            {% set total_capacidade = leitos|sum(attribute='capacidade_maxima') %}
            {% set ocupacao_percentual = (total_ocupados / total_capacidade * 100) if total_capacidade else 0 %}

            <div class="row mb-4">
                <div class="col-12">
                    <h2 class="section-title">Visão Geral da Ocupação</h2>
                </div>
            </div>

            <!-- Resumo Geral Section -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card stat-card">
                        <div class="card-body p-4">
                            <h4 class="card-title mb-4">Resumo Geral dos Leitos</h4>
                            <div class="row text-center">
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <p class="mb-1 text-muted">Total de Leitos</p>
                                    <h5 class="display-6">{{ total_capacidade }}</h5>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <p class="mb-1 text-muted">Leitos Ocupados</p>
                                    <h5 class="display-6">{{ total_ocupados }}</h5>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <p class="mb-1 text-muted">Leitos Disponíveis</p>
                                    <h5 class="display-6" style="color: #28a745;">{{ total_capacidade - total_ocupados }}</h5>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <p class="mb-1 text-muted">Taxa de Ocupação Geral</p>
                                    <h5 class="display-6">{{ '%.1f' % ocupacao_percentual }}%</h5>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar" role="progressbar"
                                     style="width: {{ ('%.1f' % ocupacao_percentual) ~ '%' }};"
                                     aria-valuenow="{{ ocupacao_percentual }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12">
                     <h3 class="section-title">Detalhes por Leito</h3>
                </div>
            </div>
            <div class="row">
                {% if leitos %}
                    {% for leito in leitos %}
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                        <div class="card leito-card h-100">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">{{ leito.nome }}</h5>
                                    <span class="badge rounded-pill bg-{{ 'success' if leito.status == 'Disponível' else 'danger' }}">
                                        {{ leito.status }}
                                    </span>
                                </div>
                                <p class="card-text text-muted small mb-1"><strong>Tipo:</strong> {{ leito.tipo }}</p>
                                <p class="card-text text-muted small mb-2"><strong>Setor:</strong> {{ leito.setor }}</p>
                                
                                <div class="row mb-1">
                                    <div class="col-6">
                                        <p class="card-text text-muted small mb-0">Capacidade:</p>
                                        <h6 class="fw-semibold">{{ leito.capacidade_maxima }}</h6>
                                    </div>
                                    <div class="col-6">
                                        <p class="card-text text-muted small mb-0">Ocupados:</p>
                                        <h6 class="fw-semibold">{{ leito.ocupacao_atual }}</h6>
                                    </div>
                                </div>
                                
                                {% set ocupacao_leito_percentual = (leito.ocupacao_atual / leito.capacidade_maxima * 100) if leito.capacidade_maxima else 0 %}
                                <div class="progress mb-1" style="height: 8px;">
                                    <div class="progress-bar bg-{{ 'success' if ocupacao_leito_percentual < 50 else ('warning' if ocupacao_leito_percentual < 85 else 'danger') }}"
                                         role="progressbar" style="width: {{ (ocupacao_leito_percentual | string) ~ '%' }};"
                                         aria-valuenow="{{ ocupacao_leito_percentual }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p class="card-text text-muted small mb-3">
                                    Ocupação: {{ '%.0f' % ocupacao_leito_percentual }}%
                                </p>
                                
                                <div class="mt-auto">
                                    <button class="btn btn-outline-primary btn-sm w-100"
                                            onclick="mostrarPacientes('{{ leito.nome }}', this)">
                                        Ver Pacientes
                                    </button>
                                    <div id="pacientes-{{ leito.nome|replace(' ', '-') }}" class="mt-2 pacientes-list" style="display:none;">
                                        <!-- Patient list will be injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info" role="alert">
                            Nenhum leito cadastrado no momento.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal para Pesquisar Pacientes Internados -->
    <div class="modal fade" id="pesquisarPacientesModal" tabindex="-1" aria-labelledby="pesquisarPacientesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pesquisarPacientesModalLabel">Pacientes Internados</h5>
                    <input type="text" id="searchInputPacienteInternado" class="form-control ms-3" placeholder="Buscar paciente pelo nome...">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalPacientesInternadosBody">
                    <!-- Content will be loaded here by JavaScript -->
                    <p>Carregando pacientes...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Função auxiliar para calcular idade
    function calcularIdade(dataNascimento) {
        if (!dataNascimento) return 'N/A';
        const hoje = new Date();
        const nascimento = new Date(dataNascimento);
        let idade = hoje.getFullYear() - nascimento.getFullYear();
        const mes = hoje.getMonth() - nascimento.getMonth();
        if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
            idade--;
        }
        return idade + ' anos';
    }

    function mostrarPacientes(leitoNome, buttonElement) {
      const leitoNomeId = leitoNome.replaceAll(' ', '-');
      const containerId = `pacientes-${leitoNomeId}`;
      const container = document.getElementById(containerId);

      const originalButtonText = "Ver Pacientes";
      const hideButtonText = "Ocultar Pacientes";

      if (container.style.display === 'none') {
        buttonElement.disabled = true;
        buttonElement.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Carregando...
        `;

        fetch(`/api/internacoes/leito/${encodeURIComponent(leitoNome)}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.length === 0) {
              container.innerHTML = '<div class="leito-drop-zone" data-leito="' + leitoNome + '"><p class="text-muted small m-0 p-2 text-center">Nenhum paciente internado.</p></div>';
            } else {
              const listItems = data.map(p => {
                const idade = calcularIdade(p.data_nascimento);
                return `<div class="paciente-draggable" 
                            draggable="true" 
                            data-paciente-id="${p.id || p.paciente_id}" 
                            data-atendimento-id="${p.atendimento_id}"
                            data-paciente-nome="${p.nome}"
                            data-leito-origem="${leitoNome}">
                   <div class="paciente-info">
                       <div class="paciente-nome">${p.nome}</div>
                       <div class="paciente-diagnostico">${p.diagnostico || 'Sem diagnóstico'}</div>
                       <div class="paciente-idade">Idade: ${idade}</div>
                   </div>
                 </div>`;
              }).join('');
              container.innerHTML = `<div class="leito-drop-zone" data-leito="${leitoNome}">${listItems}</div>`;
            }
            
            // Configurar eventos de drag and drop
            configurarDragAndDrop();
            
            container.style.display = 'block';
            buttonElement.innerHTML = hideButtonText;
          })
          .catch(err => {
            console.error("Erro ao buscar pacientes do leito:", err);
            container.innerHTML = '<p class="text-danger small m-0 p-2 text-center">Erro ao buscar pacientes.</p>';
            container.style.display = 'block';
            buttonElement.innerHTML = 'Erro ao Carregar';
            setTimeout(() => {
                if (container.style.display === 'block' && buttonElement.innerHTML === 'Erro ao Carregar') {
                     buttonElement.innerHTML = originalButtonText;
                }
            }, 3000);
          })
          .finally(() => {
            buttonElement.disabled = false;
            if (container.style.display === 'none' || buttonElement.textContent.includes('Carregando')) {
                 buttonElement.innerHTML = originalButtonText;
            }
          });
      } else {
        container.style.display = 'none';
        container.innerHTML = ''; 
        buttonElement.innerHTML = originalButtonText;
      }
    }

    // Função para configurar drag and drop
    function configurarDragAndDrop() {
        const draggables = document.querySelectorAll('.paciente-draggable');
        const dropZones = document.querySelectorAll('.leito-drop-zone');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', handleDragStart);
            draggable.addEventListener('dragend', handleDragEnd);
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('drop', handleDrop);
            zone.addEventListener('dragleave', handleDragLeave);
        });
    }

    let draggedElement = null;

    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        
        // Remover classe drag-over de todas as zonas
        document.querySelectorAll('.leito-drop-zone').forEach(zone => {
            zone.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
        return false;
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        e.preventDefault();

        this.classList.remove('drag-over');

        const leitoDestino = this.getAttribute('data-leito');
        const leitoOrigem = draggedElement.getAttribute('data-leito-origem');
        const pacienteId = draggedElement.getAttribute('data-paciente-id');
        const atendimentoId = draggedElement.getAttribute('data-atendimento-id');
        const pacienteNome = draggedElement.getAttribute('data-paciente-nome');

        if (leitoDestino !== leitoOrigem) {
            // Confirmar a realocação
            if (confirm(`Confirma a realocação de ${pacienteNome} do leito ${leitoOrigem} para o leito ${leitoDestino}?`)) {
                realocarPaciente(atendimentoId, leitoDestino, leitoOrigem);
            }
        }

        return false;
    }

    function realocarPaciente(atendimentoId, leitoDestino, leitoOrigem) {
        fetch('/api/realocar-paciente', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                atendimento_id: atendimentoId,
                leito_destino: leitoDestino
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Paciente realocado com sucesso!');
                
                // Atualizar visualmente os números de ocupação
                atualizarOcupacaoVisual(leitoOrigem, leitoDestino);
                
                // Remover o paciente da lista visual do leito de origem
                if (draggedElement) {
                    draggedElement.remove();
                }
                
                // Opcional: recarregar após um delay apenas se necessário para sincronização completa
                // Comentado para melhor experiência do usuário
                // setTimeout(() => {
                //     location.reload();
                // }, 5000);
                
            } else {
                alert('Erro ao realocar paciente: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro ao realocar paciente:', error);
            alert('Erro ao realocar paciente. Tente novamente.');
        });
    }

    // Nova função para atualizar a ocupação visual em tempo real
    function atualizarOcupacaoVisual(leitoOrigem, leitoDestino) {
        // Encontrar e atualizar os cards dos leitos
        const cards = document.querySelectorAll('.leito-card');
        
        cards.forEach(card => {
            const tituloLeito = card.querySelector('.card-title').textContent.trim();
            
            if (tituloLeito === leitoOrigem) {
                // Diminuir ocupação do leito de origem
                const ocupadosElement = card.querySelector('.row .col-6:nth-child(2) h6');
                const ocupadosAtual = parseInt(ocupadosElement.textContent);
                const novaOcupacao = Math.max(0, ocupadosAtual - 1);
                
                // Animação suave para mudança de número
                ocupadosElement.classList.add('numero-atualizado');
                setTimeout(() => {
                    ocupadosElement.textContent = novaOcupacao;
                    ocupadosElement.classList.remove('numero-atualizado');
                }, 300);
                
                // Atualizar barra de progresso do leito de origem
                const capacidadeElement = card.querySelector('.row .col-6:nth-child(1) h6');
                const capacidade = parseInt(capacidadeElement.textContent);
                const novoPercentual = capacidade > 0 ? (novaOcupacao / capacidade * 100) : 0;
                
                const progressBar = card.querySelector('.progress .progress-bar');
                progressBar.style.transition = 'width 0.5s ease';
                setTimeout(() => {
                    progressBar.style.width = novoPercentual + '%';
                    progressBar.setAttribute('aria-valuenow', novoPercentual);
                    
                    // Atualizar classe da barra de progresso
                    progressBar.className = 'progress-bar bg-' + 
                        (novoPercentual < 50 ? 'success' : (novoPercentual < 85 ? 'warning' : 'danger'));
                }, 100);
                
                // Atualizar texto de ocupação
                const ocupacaoTexto = card.querySelector('p.card-text.text-muted.small.mb-3');
                setTimeout(() => {
                    ocupacaoTexto.textContent = `Ocupação: ${Math.round(novoPercentual)}%`;
                }, 200);
                
                // Atualizar status do leito se necessário
                const badge = card.querySelector('.badge');
                setTimeout(() => {
                    if (novaOcupacao === 0) {
                        badge.textContent = 'Disponível';
                        badge.className = 'badge rounded-pill bg-success';
                    } else if (novaOcupacao < capacidade) {
                        badge.textContent = 'Parcialmente Ocupado';
                        badge.className = 'badge rounded-pill bg-warning';
                    }
                }, 300);
            }
            
            if (tituloLeito === leitoDestino) {
                // Aumentar ocupação do leito de destino
                const ocupadosElement = card.querySelector('.row .col-6:nth-child(2) h6');
                const ocupadosAtual = parseInt(ocupadosElement.textContent);
                const novaOcupacao = ocupadosAtual + 1;
                
                // Animação suave para mudança de número
                ocupadosElement.classList.add('numero-atualizado');
                setTimeout(() => {
                    ocupadosElement.textContent = novaOcupacao;
                    ocupadosElement.classList.remove('numero-atualizado');
                }, 300);
                
                // Atualizar barra de progresso do leito de destino
                const capacidadeElement = card.querySelector('.row .col-6:nth-child(1) h6');
                const capacidade = parseInt(capacidadeElement.textContent);
                const novoPercentual = capacidade > 0 ? (novaOcupacao / capacidade * 100) : 0;
                
                const progressBar = card.querySelector('.progress .progress-bar');
                progressBar.style.transition = 'width 0.5s ease';
                setTimeout(() => {
                    progressBar.style.width = novoPercentual + '%';
                    progressBar.setAttribute('aria-valuenow', novoPercentual);
                    
                    // Atualizar classe da barra de progresso
                    progressBar.className = 'progress-bar bg-' + 
                        (novoPercentual < 50 ? 'success' : (novoPercentual < 85 ? 'warning' : 'danger'));
                }, 100);
                
                // Atualizar texto de ocupação
                const ocupacaoTexto = card.querySelector('p.card-text.text-muted.small.mb-3');
                setTimeout(() => {
                    ocupacaoTexto.textContent = `Ocupação: ${Math.round(novoPercentual)}%`;
                }, 200);
                
                // Atualizar status do leito se necessário
                const badge = card.querySelector('.badge');
                setTimeout(() => {
                    if (novaOcupacao >= capacidade) {
                        badge.textContent = 'Ocupado';
                        badge.className = 'badge rounded-pill bg-danger';
                    } else {
                        badge.textContent = 'Parcialmente Ocupado';
                        badge.className = 'badge rounded-pill bg-warning';
                    }
                }, 300);
            }
        });
        
        // Adicionar feedback visual de sucesso
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show realocacao-feedback';
        alertDiv.innerHTML = `
            <strong>✅ Sucesso!</strong> Paciente realocado. Dados atualizados visualmente.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Remover o alerta após 4 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 4000);
    }

    let pesquisarPacientesModalInstance = null;
    let todosPacientesInternados = []; // To store all fetched interned patients

    function getPesquisarPacientesModalInstance() {
        if (!pesquisarPacientesModalInstance) {
            pesquisarPacientesModalInstance = new bootstrap.Modal(document.getElementById('pesquisarPacientesModal'));
        }
        return pesquisarPacientesModalInstance;
    }

    function renderPacientesInternados(pacientes) {
        const modalBody = document.getElementById('modalPacientesInternadosBody');
        if (pacientes && pacientes.length > 0) {
            const listHtml = pacientes.map(paciente => {
                // Calcular idade
                const idade = calcularIdade(paciente.data_nascimento);
                
                // Verificar o cargo do usuário para mostrar ou não o botão Evoluir
                const cargoUsuario = "{{ session.get('cargo', '').lower() }}";
                let botaoEvoluir = '';
                
                if (cargoUsuario === 'medico' || cargoUsuario === 'enfermeiro') {
                    const urlEvoluir = cargoUsuario === 'medico' 
                        ? `/clinica/evolucao-paciente-medico/${paciente.atendimento_id}`
                        : `/clinica/evolucao-paciente-enfermeiro/${paciente.atendimento_id}`;
                    
                    botaoEvoluir = `
                        <a href="${urlEvoluir}" class="btn btn-sm btn-primary btn-evoluir">
                            <i class="fas fa-notes-medical"></i> Evoluir
                        </a>
                    `;
                }
                
                return `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 paciente-nome">${paciente.nome}</h6>
                                <p class="mb-1 text-muted paciente-diagnostico">
                                    <strong>Diagnóstico:</strong> ${paciente.diagnostico || 'Sem diagnóstico'}
                                </p>
                                <p class="mb-1 text-muted paciente-idade">
                                    <strong>Idade:</strong> ${idade} | <strong>Leito:</strong> ${paciente.leito || 'N/A'}
                                </p>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2 paciente-actions">
                                <span class="badge bg-info">ID: ${paciente.atendimento_id}</span>
                                ${botaoEvoluir}
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
            modalBody.innerHTML = `<ul class="list-group list-group-flush">${listHtml}</ul>`;
        } else {
            modalBody.innerHTML = '<p class="text-center text-muted">Nenhum paciente encontrado com os critérios da busca.</p>';
        }
    }

    function filtrarPacientesInternados() {
        const searchTerm = document.getElementById('searchInputPacienteInternado').value.toLowerCase();
        const filteredPacientes = todosPacientesInternados.filter(paciente => {
            return paciente.nome.toLowerCase().includes(searchTerm);
        });
        renderPacientesInternados(filteredPacientes);
    }

    function abrirModalPesquisaPacientes(event) {
        if(event) event.preventDefault(); 

        const modal = getPesquisarPacientesModalInstance();
        const modalBody = document.getElementById('modalPacientesInternadosBody');
        const searchInput = document.getElementById('searchInputPacienteInternado');
        
        // Clear previous search and results
        searchInput.value = '';
        modalBody.innerHTML = '<div class="spinner-container"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';
        
        // Remove existing event listener to prevent duplicates if modal is reopened
        searchInput.removeEventListener('keyup', filtrarPacientesInternados); 
        // Add event listener for live search
        searchInput.addEventListener('keyup', filtrarPacientesInternados);

        modal.show();

        fetch('/api/pacientes/internados')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // A API retorna {success: true, pacientes: [...]}
                if (data && data.success && data.pacientes) {
                    todosPacientesInternados = data.pacientes; // Acessar o array de pacientes correto
                    if (data.pacientes.length > 0) {
                        renderPacientesInternados(todosPacientesInternados);
                    } else {
                        modalBody.innerHTML = '<p class="text-center text-muted">Nenhum paciente internado encontrado.</p>';
                        todosPacientesInternados = [];
                    }
                } else {
                    modalBody.innerHTML = '<p class="text-center text-muted">Nenhum paciente internado encontrado.</p>';
                    todosPacientesInternados = [];
                }
            })
            .catch(error => {
                console.error('Erro ao buscar pacientes internados:', error);
                modalBody.innerHTML = '<p class="text-center text-danger">Erro ao carregar pacientes. Tente novamente mais tarde.</p>';
                todosPacientesInternados = [];
            });
    }
    </script>
</body>
</html>
